var zx=Object.create;var X0=Object.defineProperty;var wx=Object.getOwnPropertyDescriptor;var Ax=Object.getOwnPropertyNames;var Hx=Object.getPrototypeOf,jx=Object.prototype.hasOwnProperty;var YV=(x,g)=>()=>(x&&(g=x(x=0)),g);var Bi=(x,g)=>()=>(g||x((g={exports:{}}).exports,g),g.exports),JV=(x,g)=>{for(var J in g)X0(x,J,{get:g[J],enumerable:!0})},XV=(x,g,J,E)=>{if(g&&typeof g=="object"||typeof g=="function")for(let O of Ax(g))!jx.call(x,O)&&O!==J&&X0(x,O,{get:()=>g[O],enumerable:!(E=wx(g,O))||E.enumerable});return x};var yV=(x,g,J)=>(J=x!=null?zx(Hx(x)):{},XV(g||!x||!x.__esModule?X0(J,"default",{value:x,enumerable:!0}):J,x)),Ox=x=>XV(X0({},"__esModule",{value:!0}),x);var qR=Bi((w1,A1)=>{(function(x,g){typeof w1=="object"&&typeof A1<"u"?A1.exports=g():typeof define=="function"&&define.amd?define(g):(x=typeof globalThis<"u"?globalThis:x||self,x.mapboxgl=g())})(w1,function(){"use strict";var x,g,J;function E(l,lt){if(!x)x=lt;else if(!g)g=lt;else{var It="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+x+")(sharedChunk); ("+g+")(sharedChunk); self.onerror = null;",Gt={};x(Gt),J=lt(Gt),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(J.workerUrl=window.URL.createObjectURL(new Blob([It],{type:"text/javascript"})))}}E(["exports"],function(l){function lt(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var It,Gt={},$t={};function Kt(){if(It)return $t;It=1,Object.defineProperty($t,"__esModule",{value:!0}),$t.setMatrixArrayType=function(c){$t.ARRAY_TYPE=t=c},$t.toRadian=function(c){return c*o},$t.equals=function(c,s){return Math.abs(c-s)<=n*Math.max(1,Math.abs(c),Math.abs(s))},$t.RANDOM=$t.ARRAY_TYPE=$t.EPSILON=void 0;var n=1e-6;$t.EPSILON=n;var t=typeof Float32Array<"u"?Float32Array:Array;$t.ARRAY_TYPE=t;var i=Math.random;$t.RANDOM=i;var o=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var c=0,s=arguments.length;s--;)c+=arguments[s]*arguments[s];return Math.sqrt(c)}),$t}var Ve,re={};function le(){if(Ve)return re;function n(s){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(b){return typeof b}:function(b){return b&&typeof Symbol=="function"&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b},n(s)}Ve=1,Object.defineProperty(re,"__esModule",{value:!0}),re.create=function(){var s=new t.ARRAY_TYPE(4);return t.ARRAY_TYPE!=Float32Array&&(s[1]=0,s[2]=0),s[0]=1,s[3]=1,s},re.clone=function(s){var b=new t.ARRAY_TYPE(4);return b[0]=s[0],b[1]=s[1],b[2]=s[2],b[3]=s[3],b},re.copy=function(s,b){return s[0]=b[0],s[1]=b[1],s[2]=b[2],s[3]=b[3],s},re.identity=function(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=1,s},re.fromValues=function(s,b,W,R){var I=new t.ARRAY_TYPE(4);return I[0]=s,I[1]=b,I[2]=W,I[3]=R,I},re.set=function(s,b,W,R,I){return s[0]=b,s[1]=W,s[2]=R,s[3]=I,s},re.transpose=function(s,b){if(s===b){var W=b[1];s[1]=b[2],s[2]=W}else s[0]=b[0],s[1]=b[2],s[2]=b[1],s[3]=b[3];return s},re.invert=function(s,b){var W=b[0],R=b[1],I=b[2],h=b[3],Z=W*h-I*R;return Z?(s[0]=h*(Z=1/Z),s[1]=-R*Z,s[2]=-I*Z,s[3]=W*Z,s):null},re.adjoint=function(s,b){var W=b[0];return s[0]=b[3],s[1]=-b[1],s[2]=-b[2],s[3]=W,s},re.determinant=function(s){return s[0]*s[3]-s[2]*s[1]},re.multiply=o,re.rotate=function(s,b,W){var R=b[0],I=b[1],h=b[2],Z=b[3],F=Math.sin(W),V=Math.cos(W);return s[0]=R*V+h*F,s[1]=I*V+Z*F,s[2]=R*-F+h*V,s[3]=I*-F+Z*V,s},re.scale=function(s,b,W){var R=b[1],I=b[2],h=b[3],Z=W[0],F=W[1];return s[0]=b[0]*Z,s[1]=R*Z,s[2]=I*F,s[3]=h*F,s},re.fromRotation=function(s,b){var W=Math.sin(b),R=Math.cos(b);return s[0]=R,s[1]=W,s[2]=-W,s[3]=R,s},re.fromScaling=function(s,b){return s[0]=b[0],s[1]=0,s[2]=0,s[3]=b[1],s},re.str=function(s){return"mat2("+s[0]+", "+s[1]+", "+s[2]+", "+s[3]+")"},re.frob=function(s){return Math.hypot(s[0],s[1],s[2],s[3])},re.LDU=function(s,b,W,R){return s[2]=R[2]/R[0],W[0]=R[0],W[1]=R[1],W[3]=R[3]-s[2]*W[1],[s,b,W]},re.add=function(s,b,W){return s[0]=b[0]+W[0],s[1]=b[1]+W[1],s[2]=b[2]+W[2],s[3]=b[3]+W[3],s},re.subtract=c,re.exactEquals=function(s,b){return s[0]===b[0]&&s[1]===b[1]&&s[2]===b[2]&&s[3]===b[3]},re.equals=function(s,b){var W=s[0],R=s[1],I=s[2],h=s[3],Z=b[0],F=b[1],V=b[2],G=b[3];return Math.abs(W-Z)<=t.EPSILON*Math.max(1,Math.abs(W),Math.abs(Z))&&Math.abs(R-F)<=t.EPSILON*Math.max(1,Math.abs(R),Math.abs(F))&&Math.abs(I-V)<=t.EPSILON*Math.max(1,Math.abs(I),Math.abs(V))&&Math.abs(h-G)<=t.EPSILON*Math.max(1,Math.abs(h),Math.abs(G))},re.multiplyScalar=function(s,b,W){return s[0]=b[0]*W,s[1]=b[1]*W,s[2]=b[2]*W,s[3]=b[3]*W,s},re.multiplyScalarAndAdd=function(s,b,W,R){return s[0]=b[0]+W[0]*R,s[1]=b[1]+W[1]*R,s[2]=b[2]+W[2]*R,s[3]=b[3]+W[3]*R,s},re.sub=re.mul=void 0;var t=function(s,b){if(s&&s.__esModule)return s;if(s===null||n(s)!=="object"&&typeof s!="function")return{default:s};var W=i(void 0);if(W&&W.has(s))return W.get(s);var R={},I=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in s)if(h!=="default"&&Object.prototype.hasOwnProperty.call(s,h)){var Z=I?Object.getOwnPropertyDescriptor(s,h):null;Z&&(Z.get||Z.set)?Object.defineProperty(R,h,Z):R[h]=s[h]}return R.default=s,W&&W.set(s,R),R}(Kt());function i(s){if(typeof WeakMap!="function")return null;var b=new WeakMap,W=new WeakMap;return(i=function(R){return R?W:b})(s)}function o(s,b,W){var R=b[0],I=b[1],h=b[2],Z=b[3],F=W[0],V=W[1],G=W[2],N=W[3];return s[0]=R*F+h*V,s[1]=I*F+Z*V,s[2]=R*G+h*N,s[3]=I*G+Z*N,s}function c(s,b,W){return s[0]=b[0]-W[0],s[1]=b[1]-W[1],s[2]=b[2]-W[2],s[3]=b[3]-W[3],s}return re.mul=o,re.sub=c,re}var je,Ze={};function ii(){if(je)return Ze;function n(s){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(b){return typeof b}:function(b){return b&&typeof Symbol=="function"&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b},n(s)}je=1,Object.defineProperty(Ze,"__esModule",{value:!0}),Ze.create=function(){var s=new t.ARRAY_TYPE(6);return t.ARRAY_TYPE!=Float32Array&&(s[1]=0,s[2]=0,s[4]=0,s[5]=0),s[0]=1,s[3]=1,s},Ze.clone=function(s){var b=new t.ARRAY_TYPE(6);return b[0]=s[0],b[1]=s[1],b[2]=s[2],b[3]=s[3],b[4]=s[4],b[5]=s[5],b},Ze.copy=function(s,b){return s[0]=b[0],s[1]=b[1],s[2]=b[2],s[3]=b[3],s[4]=b[4],s[5]=b[5],s},Ze.identity=function(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=1,s[4]=0,s[5]=0,s},Ze.fromValues=function(s,b,W,R,I,h){var Z=new t.ARRAY_TYPE(6);return Z[0]=s,Z[1]=b,Z[2]=W,Z[3]=R,Z[4]=I,Z[5]=h,Z},Ze.set=function(s,b,W,R,I,h,Z){return s[0]=b,s[1]=W,s[2]=R,s[3]=I,s[4]=h,s[5]=Z,s},Ze.invert=function(s,b){var W=b[0],R=b[1],I=b[2],h=b[3],Z=b[4],F=b[5],V=W*h-R*I;return V?(s[0]=h*(V=1/V),s[1]=-R*V,s[2]=-I*V,s[3]=W*V,s[4]=(I*F-h*Z)*V,s[5]=(R*Z-W*F)*V,s):null},Ze.determinant=function(s){return s[0]*s[3]-s[1]*s[2]},Ze.multiply=o,Ze.rotate=function(s,b,W){var R=b[0],I=b[1],h=b[2],Z=b[3],F=b[4],V=b[5],G=Math.sin(W),N=Math.cos(W);return s[0]=R*N+h*G,s[1]=I*N+Z*G,s[2]=R*-G+h*N,s[3]=I*-G+Z*N,s[4]=F,s[5]=V,s},Ze.scale=function(s,b,W){var R=b[1],I=b[2],h=b[3],Z=b[4],F=b[5],V=W[0],G=W[1];return s[0]=b[0]*V,s[1]=R*V,s[2]=I*G,s[3]=h*G,s[4]=Z,s[5]=F,s},Ze.translate=function(s,b,W){var R=b[0],I=b[1],h=b[2],Z=b[3],F=b[4],V=b[5],G=W[0],N=W[1];return s[0]=R,s[1]=I,s[2]=h,s[3]=Z,s[4]=R*G+h*N+F,s[5]=I*G+Z*N+V,s},Ze.fromRotation=function(s,b){var W=Math.sin(b),R=Math.cos(b);return s[0]=R,s[1]=W,s[2]=-W,s[3]=R,s[4]=0,s[5]=0,s},Ze.fromScaling=function(s,b){return s[0]=b[0],s[1]=0,s[2]=0,s[3]=b[1],s[4]=0,s[5]=0,s},Ze.fromTranslation=function(s,b){return s[0]=1,s[1]=0,s[2]=0,s[3]=1,s[4]=b[0],s[5]=b[1],s},Ze.str=function(s){return"mat2d("+s[0]+", "+s[1]+", "+s[2]+", "+s[3]+", "+s[4]+", "+s[5]+")"},Ze.frob=function(s){return Math.hypot(s[0],s[1],s[2],s[3],s[4],s[5],1)},Ze.add=function(s,b,W){return s[0]=b[0]+W[0],s[1]=b[1]+W[1],s[2]=b[2]+W[2],s[3]=b[3]+W[3],s[4]=b[4]+W[4],s[5]=b[5]+W[5],s},Ze.subtract=c,Ze.multiplyScalar=function(s,b,W){return s[0]=b[0]*W,s[1]=b[1]*W,s[2]=b[2]*W,s[3]=b[3]*W,s[4]=b[4]*W,s[5]=b[5]*W,s},Ze.multiplyScalarAndAdd=function(s,b,W,R){return s[0]=b[0]+W[0]*R,s[1]=b[1]+W[1]*R,s[2]=b[2]+W[2]*R,s[3]=b[3]+W[3]*R,s[4]=b[4]+W[4]*R,s[5]=b[5]+W[5]*R,s},Ze.exactEquals=function(s,b){return s[0]===b[0]&&s[1]===b[1]&&s[2]===b[2]&&s[3]===b[3]&&s[4]===b[4]&&s[5]===b[5]},Ze.equals=function(s,b){var W=s[0],R=s[1],I=s[2],h=s[3],Z=s[4],F=s[5],V=b[0],G=b[1],N=b[2],X=b[3],M=b[4],S=b[5];return Math.abs(W-V)<=t.EPSILON*Math.max(1,Math.abs(W),Math.abs(V))&&Math.abs(R-G)<=t.EPSILON*Math.max(1,Math.abs(R),Math.abs(G))&&Math.abs(I-N)<=t.EPSILON*Math.max(1,Math.abs(I),Math.abs(N))&&Math.abs(h-X)<=t.EPSILON*Math.max(1,Math.abs(h),Math.abs(X))&&Math.abs(Z-M)<=t.EPSILON*Math.max(1,Math.abs(Z),Math.abs(M))&&Math.abs(F-S)<=t.EPSILON*Math.max(1,Math.abs(F),Math.abs(S))},Ze.sub=Ze.mul=void 0;var t=function(s,b){if(s&&s.__esModule)return s;if(s===null||n(s)!=="object"&&typeof s!="function")return{default:s};var W=i(void 0);if(W&&W.has(s))return W.get(s);var R={},I=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in s)if(h!=="default"&&Object.prototype.hasOwnProperty.call(s,h)){var Z=I?Object.getOwnPropertyDescriptor(s,h):null;Z&&(Z.get||Z.set)?Object.defineProperty(R,h,Z):R[h]=s[h]}return R.default=s,W&&W.set(s,R),R}(Kt());function i(s){if(typeof WeakMap!="function")return null;var b=new WeakMap,W=new WeakMap;return(i=function(R){return R?W:b})(s)}function o(s,b,W){var R=b[0],I=b[1],h=b[2],Z=b[3],F=b[4],V=b[5],G=W[0],N=W[1],X=W[2],M=W[3],S=W[4],f=W[5];return s[0]=R*G+h*N,s[1]=I*G+Z*N,s[2]=R*X+h*M,s[3]=I*X+Z*M,s[4]=R*S+h*f+F,s[5]=I*S+Z*f+V,s}function c(s,b,W){return s[0]=b[0]-W[0],s[1]=b[1]-W[1],s[2]=b[2]-W[2],s[3]=b[3]-W[3],s[4]=b[4]-W[4],s[5]=b[5]-W[5],s}return Ze.mul=o,Ze.sub=c,Ze}var bi,Xe={};function vi(){if(bi)return Xe;function n(s){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(b){return typeof b}:function(b){return b&&typeof Symbol=="function"&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b},n(s)}bi=1,Object.defineProperty(Xe,"__esModule",{value:!0}),Xe.create=function(){var s=new t.ARRAY_TYPE(9);return t.ARRAY_TYPE!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s},Xe.fromMat4=function(s,b){return s[0]=b[0],s[1]=b[1],s[2]=b[2],s[3]=b[4],s[4]=b[5],s[5]=b[6],s[6]=b[8],s[7]=b[9],s[8]=b[10],s},Xe.clone=function(s){var b=new t.ARRAY_TYPE(9);return b[0]=s[0],b[1]=s[1],b[2]=s[2],b[3]=s[3],b[4]=s[4],b[5]=s[5],b[6]=s[6],b[7]=s[7],b[8]=s[8],b},Xe.copy=function(s,b){return s[0]=b[0],s[1]=b[1],s[2]=b[2],s[3]=b[3],s[4]=b[4],s[5]=b[5],s[6]=b[6],s[7]=b[7],s[8]=b[8],s},Xe.fromValues=function(s,b,W,R,I,h,Z,F,V){var G=new t.ARRAY_TYPE(9);return G[0]=s,G[1]=b,G[2]=W,G[3]=R,G[4]=I,G[5]=h,G[6]=Z,G[7]=F,G[8]=V,G},Xe.set=function(s,b,W,R,I,h,Z,F,V,G){return s[0]=b,s[1]=W,s[2]=R,s[3]=I,s[4]=h,s[5]=Z,s[6]=F,s[7]=V,s[8]=G,s},Xe.identity=function(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=0,s[7]=0,s[8]=1,s},Xe.transpose=function(s,b){if(s===b){var W=b[1],R=b[2],I=b[5];s[1]=b[3],s[2]=b[6],s[3]=W,s[5]=b[7],s[6]=R,s[7]=I}else s[0]=b[0],s[1]=b[3],s[2]=b[6],s[3]=b[1],s[4]=b[4],s[5]=b[7],s[6]=b[2],s[7]=b[5],s[8]=b[8];return s},Xe.invert=function(s,b){var W=b[0],R=b[1],I=b[2],h=b[3],Z=b[4],F=b[5],V=b[6],G=b[7],N=b[8],X=N*Z-F*G,M=-N*h+F*V,S=G*h-Z*V,f=W*X+R*M+I*S;return f?(s[0]=X*(f=1/f),s[1]=(-N*R+I*G)*f,s[2]=(F*R-I*Z)*f,s[3]=M*f,s[4]=(N*W-I*V)*f,s[5]=(-F*W+I*h)*f,s[6]=S*f,s[7]=(-G*W+R*V)*f,s[8]=(Z*W-R*h)*f,s):null},Xe.adjoint=function(s,b){var W=b[0],R=b[1],I=b[2],h=b[3],Z=b[4],F=b[5],V=b[6],G=b[7],N=b[8];return s[0]=Z*N-F*G,s[1]=I*G-R*N,s[2]=R*F-I*Z,s[3]=F*V-h*N,s[4]=W*N-I*V,s[5]=I*h-W*F,s[6]=h*G-Z*V,s[7]=R*V-W*G,s[8]=W*Z-R*h,s},Xe.determinant=function(s){var b=s[3],W=s[4],R=s[5],I=s[6],h=s[7],Z=s[8];return s[0]*(Z*W-R*h)+s[1]*(-Z*b+R*I)+s[2]*(h*b-W*I)},Xe.multiply=o,Xe.translate=function(s,b,W){var R=b[0],I=b[1],h=b[2],Z=b[3],F=b[4],V=b[5],G=b[6],N=b[7],X=b[8],M=W[0],S=W[1];return s[0]=R,s[1]=I,s[2]=h,s[3]=Z,s[4]=F,s[5]=V,s[6]=M*R+S*Z+G,s[7]=M*I+S*F+N,s[8]=M*h+S*V+X,s},Xe.rotate=function(s,b,W){var R=b[0],I=b[1],h=b[2],Z=b[3],F=b[4],V=b[5],G=b[6],N=b[7],X=b[8],M=Math.sin(W),S=Math.cos(W);return s[0]=S*R+M*Z,s[1]=S*I+M*F,s[2]=S*h+M*V,s[3]=S*Z-M*R,s[4]=S*F-M*I,s[5]=S*V-M*h,s[6]=G,s[7]=N,s[8]=X,s},Xe.scale=function(s,b,W){var R=W[0],I=W[1];return s[0]=R*b[0],s[1]=R*b[1],s[2]=R*b[2],s[3]=I*b[3],s[4]=I*b[4],s[5]=I*b[5],s[6]=b[6],s[7]=b[7],s[8]=b[8],s},Xe.fromTranslation=function(s,b){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=b[0],s[7]=b[1],s[8]=1,s},Xe.fromRotation=function(s,b){var W=Math.sin(b),R=Math.cos(b);return s[0]=R,s[1]=W,s[2]=0,s[3]=-W,s[4]=R,s[5]=0,s[6]=0,s[7]=0,s[8]=1,s},Xe.fromScaling=function(s,b){return s[0]=b[0],s[1]=0,s[2]=0,s[3]=0,s[4]=b[1],s[5]=0,s[6]=0,s[7]=0,s[8]=1,s},Xe.fromMat2d=function(s,b){return s[0]=b[0],s[1]=b[1],s[2]=0,s[3]=b[2],s[4]=b[3],s[5]=0,s[6]=b[4],s[7]=b[5],s[8]=1,s},Xe.fromQuat=function(s,b){var W=b[0],R=b[1],I=b[2],h=b[3],Z=W+W,F=R+R,V=I+I,G=W*Z,N=R*Z,X=R*F,M=I*Z,S=I*F,f=I*V,T=h*Z,v=h*F,L=h*V;return s[0]=1-X-f,s[3]=N-L,s[6]=M+v,s[1]=N+L,s[4]=1-G-f,s[7]=S-T,s[2]=M-v,s[5]=S+T,s[8]=1-G-X,s},Xe.normalFromMat4=function(s,b){var W=b[0],R=b[1],I=b[2],h=b[3],Z=b[4],F=b[5],V=b[6],G=b[7],N=b[8],X=b[9],M=b[10],S=b[11],f=b[12],T=b[13],v=b[14],L=b[15],D=W*F-R*Z,q=W*V-I*Z,tt=W*G-h*Z,P=R*V-I*F,st=R*G-h*F,it=I*G-h*V,dt=N*T-X*f,Zt=N*v-M*f,Vt=N*L-S*f,Rt=X*v-M*T,Ft=X*L-S*T,yt=M*L-S*v,xt=D*yt-q*Ft+tt*Rt+P*Vt-st*Zt+it*dt;return xt?(s[0]=(F*yt-V*Ft+G*Rt)*(xt=1/xt),s[1]=(V*Vt-Z*yt-G*Zt)*xt,s[2]=(Z*Ft-F*Vt+G*dt)*xt,s[3]=(I*Ft-R*yt-h*Rt)*xt,s[4]=(W*yt-I*Vt+h*Zt)*xt,s[5]=(R*Vt-W*Ft-h*dt)*xt,s[6]=(T*it-v*st+L*P)*xt,s[7]=(v*tt-f*it-L*q)*xt,s[8]=(f*st-T*tt+L*D)*xt,s):null},Xe.projection=function(s,b,W){return s[0]=2/b,s[1]=0,s[2]=0,s[3]=0,s[4]=-2/W,s[5]=0,s[6]=-1,s[7]=1,s[8]=1,s},Xe.str=function(s){return"mat3("+s[0]+", "+s[1]+", "+s[2]+", "+s[3]+", "+s[4]+", "+s[5]+", "+s[6]+", "+s[7]+", "+s[8]+")"},Xe.frob=function(s){return Math.hypot(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8])},Xe.add=function(s,b,W){return s[0]=b[0]+W[0],s[1]=b[1]+W[1],s[2]=b[2]+W[2],s[3]=b[3]+W[3],s[4]=b[4]+W[4],s[5]=b[5]+W[5],s[6]=b[6]+W[6],s[7]=b[7]+W[7],s[8]=b[8]+W[8],s},Xe.subtract=c,Xe.multiplyScalar=function(s,b,W){return s[0]=b[0]*W,s[1]=b[1]*W,s[2]=b[2]*W,s[3]=b[3]*W,s[4]=b[4]*W,s[5]=b[5]*W,s[6]=b[6]*W,s[7]=b[7]*W,s[8]=b[8]*W,s},Xe.multiplyScalarAndAdd=function(s,b,W,R){return s[0]=b[0]+W[0]*R,s[1]=b[1]+W[1]*R,s[2]=b[2]+W[2]*R,s[3]=b[3]+W[3]*R,s[4]=b[4]+W[4]*R,s[5]=b[5]+W[5]*R,s[6]=b[6]+W[6]*R,s[7]=b[7]+W[7]*R,s[8]=b[8]+W[8]*R,s},Xe.exactEquals=function(s,b){return s[0]===b[0]&&s[1]===b[1]&&s[2]===b[2]&&s[3]===b[3]&&s[4]===b[4]&&s[5]===b[5]&&s[6]===b[6]&&s[7]===b[7]&&s[8]===b[8]},Xe.equals=function(s,b){var W=s[0],R=s[1],I=s[2],h=s[3],Z=s[4],F=s[5],V=s[6],G=s[7],N=s[8],X=b[0],M=b[1],S=b[2],f=b[3],T=b[4],v=b[5],L=b[6],D=b[7],q=b[8];return Math.abs(W-X)<=t.EPSILON*Math.max(1,Math.abs(W),Math.abs(X))&&Math.abs(R-M)<=t.EPSILON*Math.max(1,Math.abs(R),Math.abs(M))&&Math.abs(I-S)<=t.EPSILON*Math.max(1,Math.abs(I),Math.abs(S))&&Math.abs(h-f)<=t.EPSILON*Math.max(1,Math.abs(h),Math.abs(f))&&Math.abs(Z-T)<=t.EPSILON*Math.max(1,Math.abs(Z),Math.abs(T))&&Math.abs(F-v)<=t.EPSILON*Math.max(1,Math.abs(F),Math.abs(v))&&Math.abs(V-L)<=t.EPSILON*Math.max(1,Math.abs(V),Math.abs(L))&&Math.abs(G-D)<=t.EPSILON*Math.max(1,Math.abs(G),Math.abs(D))&&Math.abs(N-q)<=t.EPSILON*Math.max(1,Math.abs(N),Math.abs(q))},Xe.sub=Xe.mul=void 0;var t=function(s,b){if(s&&s.__esModule)return s;if(s===null||n(s)!=="object"&&typeof s!="function")return{default:s};var W=i(void 0);if(W&&W.has(s))return W.get(s);var R={},I=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in s)if(h!=="default"&&Object.prototype.hasOwnProperty.call(s,h)){var Z=I?Object.getOwnPropertyDescriptor(s,h):null;Z&&(Z.get||Z.set)?Object.defineProperty(R,h,Z):R[h]=s[h]}return R.default=s,W&&W.set(s,R),R}(Kt());function i(s){if(typeof WeakMap!="function")return null;var b=new WeakMap,W=new WeakMap;return(i=function(R){return R?W:b})(s)}function o(s,b,W){var R=b[0],I=b[1],h=b[2],Z=b[3],F=b[4],V=b[5],G=b[6],N=b[7],X=b[8],M=W[0],S=W[1],f=W[2],T=W[3],v=W[4],L=W[5],D=W[6],q=W[7],tt=W[8];return s[0]=M*R+S*Z+f*G,s[1]=M*I+S*F+f*N,s[2]=M*h+S*V+f*X,s[3]=T*R+v*Z+L*G,s[4]=T*I+v*F+L*N,s[5]=T*h+v*V+L*X,s[6]=D*R+q*Z+tt*G,s[7]=D*I+q*F+tt*N,s[8]=D*h+q*V+tt*X,s}function c(s,b,W){return s[0]=b[0]-W[0],s[1]=b[1]-W[1],s[2]=b[2]-W[2],s[3]=b[3]-W[3],s[4]=b[4]-W[4],s[5]=b[5]-W[5],s[6]=b[6]-W[6],s[7]=b[7]-W[7],s[8]=b[8]-W[8],s}return Xe.mul=o,Xe.sub=c,Xe}var we,We={};function _e(){if(we)return We;function n(h){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(Z){return typeof Z}:function(Z){return Z&&typeof Symbol=="function"&&Z.constructor===Symbol&&Z!==Symbol.prototype?"symbol":typeof Z},n(h)}we=1,Object.defineProperty(We,"__esModule",{value:!0}),We.create=function(){var h=new t.ARRAY_TYPE(16);return t.ARRAY_TYPE!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=0,h[12]=0,h[13]=0,h[14]=0),h[0]=1,h[5]=1,h[10]=1,h[15]=1,h},We.clone=function(h){var Z=new t.ARRAY_TYPE(16);return Z[0]=h[0],Z[1]=h[1],Z[2]=h[2],Z[3]=h[3],Z[4]=h[4],Z[5]=h[5],Z[6]=h[6],Z[7]=h[7],Z[8]=h[8],Z[9]=h[9],Z[10]=h[10],Z[11]=h[11],Z[12]=h[12],Z[13]=h[13],Z[14]=h[14],Z[15]=h[15],Z},We.copy=function(h,Z){return h[0]=Z[0],h[1]=Z[1],h[2]=Z[2],h[3]=Z[3],h[4]=Z[4],h[5]=Z[5],h[6]=Z[6],h[7]=Z[7],h[8]=Z[8],h[9]=Z[9],h[10]=Z[10],h[11]=Z[11],h[12]=Z[12],h[13]=Z[13],h[14]=Z[14],h[15]=Z[15],h},We.fromValues=function(h,Z,F,V,G,N,X,M,S,f,T,v,L,D,q,tt){var P=new t.ARRAY_TYPE(16);return P[0]=h,P[1]=Z,P[2]=F,P[3]=V,P[4]=G,P[5]=N,P[6]=X,P[7]=M,P[8]=S,P[9]=f,P[10]=T,P[11]=v,P[12]=L,P[13]=D,P[14]=q,P[15]=tt,P},We.set=function(h,Z,F,V,G,N,X,M,S,f,T,v,L,D,q,tt,P){return h[0]=Z,h[1]=F,h[2]=V,h[3]=G,h[4]=N,h[5]=X,h[6]=M,h[7]=S,h[8]=f,h[9]=T,h[10]=v,h[11]=L,h[12]=D,h[13]=q,h[14]=tt,h[15]=P,h},We.identity=o,We.transpose=function(h,Z){if(h===Z){var F=Z[1],V=Z[2],G=Z[3],N=Z[6],X=Z[7],M=Z[11];h[1]=Z[4],h[2]=Z[8],h[3]=Z[12],h[4]=F,h[6]=Z[9],h[7]=Z[13],h[8]=V,h[9]=N,h[11]=Z[14],h[12]=G,h[13]=X,h[14]=M}else h[0]=Z[0],h[1]=Z[4],h[2]=Z[8],h[3]=Z[12],h[4]=Z[1],h[5]=Z[5],h[6]=Z[9],h[7]=Z[13],h[8]=Z[2],h[9]=Z[6],h[10]=Z[10],h[11]=Z[14],h[12]=Z[3],h[13]=Z[7],h[14]=Z[11],h[15]=Z[15];return h},We.invert=function(h,Z){var F=Z[0],V=Z[1],G=Z[2],N=Z[3],X=Z[4],M=Z[5],S=Z[6],f=Z[7],T=Z[8],v=Z[9],L=Z[10],D=Z[11],q=Z[12],tt=Z[13],P=Z[14],st=Z[15],it=F*M-V*X,dt=F*S-G*X,Zt=F*f-N*X,Vt=V*S-G*M,Rt=V*f-N*M,Ft=G*f-N*S,yt=T*tt-v*q,xt=T*P-L*q,ft=T*st-D*q,At=v*P-L*tt,Ct=v*st-D*tt,se=L*st-D*P,ae=it*se-dt*Ct+Zt*At+Vt*ft-Rt*xt+Ft*yt;return ae?(h[0]=(M*se-S*Ct+f*At)*(ae=1/ae),h[1]=(G*Ct-V*se-N*At)*ae,h[2]=(tt*Ft-P*Rt+st*Vt)*ae,h[3]=(L*Rt-v*Ft-D*Vt)*ae,h[4]=(S*ft-X*se-f*xt)*ae,h[5]=(F*se-G*ft+N*xt)*ae,h[6]=(P*Zt-q*Ft-st*dt)*ae,h[7]=(T*Ft-L*Zt+D*dt)*ae,h[8]=(X*Ct-M*ft+f*yt)*ae,h[9]=(V*ft-F*Ct-N*yt)*ae,h[10]=(q*Rt-tt*Zt+st*it)*ae,h[11]=(v*Zt-T*Rt-D*it)*ae,h[12]=(M*xt-X*At-S*yt)*ae,h[13]=(F*At-V*xt+G*yt)*ae,h[14]=(tt*dt-q*Vt-P*it)*ae,h[15]=(T*Vt-v*dt+L*it)*ae,h):null},We.adjoint=function(h,Z){var F=Z[0],V=Z[1],G=Z[2],N=Z[3],X=Z[4],M=Z[5],S=Z[6],f=Z[7],T=Z[8],v=Z[9],L=Z[10],D=Z[11],q=Z[12],tt=Z[13],P=Z[14],st=Z[15];return h[0]=M*(L*st-D*P)-v*(S*st-f*P)+tt*(S*D-f*L),h[1]=-(V*(L*st-D*P)-v*(G*st-N*P)+tt*(G*D-N*L)),h[2]=V*(S*st-f*P)-M*(G*st-N*P)+tt*(G*f-N*S),h[3]=-(V*(S*D-f*L)-M*(G*D-N*L)+v*(G*f-N*S)),h[4]=-(X*(L*st-D*P)-T*(S*st-f*P)+q*(S*D-f*L)),h[5]=F*(L*st-D*P)-T*(G*st-N*P)+q*(G*D-N*L),h[6]=-(F*(S*st-f*P)-X*(G*st-N*P)+q*(G*f-N*S)),h[7]=F*(S*D-f*L)-X*(G*D-N*L)+T*(G*f-N*S),h[8]=X*(v*st-D*tt)-T*(M*st-f*tt)+q*(M*D-f*v),h[9]=-(F*(v*st-D*tt)-T*(V*st-N*tt)+q*(V*D-N*v)),h[10]=F*(M*st-f*tt)-X*(V*st-N*tt)+q*(V*f-N*M),h[11]=-(F*(M*D-f*v)-X*(V*D-N*v)+T*(V*f-N*M)),h[12]=-(X*(v*P-L*tt)-T*(M*P-S*tt)+q*(M*L-S*v)),h[13]=F*(v*P-L*tt)-T*(V*P-G*tt)+q*(V*L-G*v),h[14]=-(F*(M*P-S*tt)-X*(V*P-G*tt)+q*(V*S-G*M)),h[15]=F*(M*L-S*v)-X*(V*L-G*v)+T*(V*S-G*M),h},We.determinant=function(h){var Z=h[0],F=h[1],V=h[2],G=h[3],N=h[4],X=h[5],M=h[6],S=h[7],f=h[8],T=h[9],v=h[10],L=h[11],D=h[12],q=h[13],tt=h[14],P=h[15];return(Z*X-F*N)*(v*P-L*tt)-(Z*M-V*N)*(T*P-L*q)+(Z*S-G*N)*(T*tt-v*q)+(F*M-V*X)*(f*P-L*D)-(F*S-G*X)*(f*tt-v*D)+(V*S-G*M)*(f*q-T*D)},We.multiply=c,We.translate=function(h,Z,F){var V,G,N,X,M,S,f,T,v,L,D,q,tt=F[0],P=F[1],st=F[2];return Z===h?(h[12]=Z[0]*tt+Z[4]*P+Z[8]*st+Z[12],h[13]=Z[1]*tt+Z[5]*P+Z[9]*st+Z[13],h[14]=Z[2]*tt+Z[6]*P+Z[10]*st+Z[14],h[15]=Z[3]*tt+Z[7]*P+Z[11]*st+Z[15]):(G=Z[1],N=Z[2],X=Z[3],M=Z[4],S=Z[5],f=Z[6],T=Z[7],v=Z[8],L=Z[9],D=Z[10],q=Z[11],h[0]=V=Z[0],h[1]=G,h[2]=N,h[3]=X,h[4]=M,h[5]=S,h[6]=f,h[7]=T,h[8]=v,h[9]=L,h[10]=D,h[11]=q,h[12]=V*tt+M*P+v*st+Z[12],h[13]=G*tt+S*P+L*st+Z[13],h[14]=N*tt+f*P+D*st+Z[14],h[15]=X*tt+T*P+q*st+Z[15]),h},We.scale=function(h,Z,F){var V=F[0],G=F[1],N=F[2];return h[0]=Z[0]*V,h[1]=Z[1]*V,h[2]=Z[2]*V,h[3]=Z[3]*V,h[4]=Z[4]*G,h[5]=Z[5]*G,h[6]=Z[6]*G,h[7]=Z[7]*G,h[8]=Z[8]*N,h[9]=Z[9]*N,h[10]=Z[10]*N,h[11]=Z[11]*N,h[12]=Z[12],h[13]=Z[13],h[14]=Z[14],h[15]=Z[15],h},We.rotate=function(h,Z,F,V){var G,N,X,M,S,f,T,v,L,D,q,tt,P,st,it,dt,Zt,Vt,Rt,Ft,yt,xt,ft,At,Ct=V[0],se=V[1],ae=V[2],Pt=Math.hypot(Ct,se,ae);return Pt<t.EPSILON?null:(Ct*=Pt=1/Pt,se*=Pt,ae*=Pt,G=Math.sin(F),N=Math.cos(F),S=Z[1],f=Z[2],T=Z[3],L=Z[5],D=Z[6],q=Z[7],P=Z[9],st=Z[10],it=Z[11],dt=Ct*Ct*(X=1-N)+N,Rt=Ct*se*X-ae*G,Ft=se*se*X+N,yt=ae*se*X+Ct*G,xt=Ct*ae*X+se*G,ft=se*ae*X-Ct*G,At=ae*ae*X+N,h[0]=(M=Z[0])*dt+(v=Z[4])*(Zt=se*Ct*X+ae*G)+(tt=Z[8])*(Vt=ae*Ct*X-se*G),h[1]=S*dt+L*Zt+P*Vt,h[2]=f*dt+D*Zt+st*Vt,h[3]=T*dt+q*Zt+it*Vt,h[4]=M*Rt+v*Ft+tt*yt,h[5]=S*Rt+L*Ft+P*yt,h[6]=f*Rt+D*Ft+st*yt,h[7]=T*Rt+q*Ft+it*yt,h[8]=M*xt+v*ft+tt*At,h[9]=S*xt+L*ft+P*At,h[10]=f*xt+D*ft+st*At,h[11]=T*xt+q*ft+it*At,Z!==h&&(h[12]=Z[12],h[13]=Z[13],h[14]=Z[14],h[15]=Z[15]),h)},We.rotateX=function(h,Z,F){var V=Math.sin(F),G=Math.cos(F),N=Z[4],X=Z[5],M=Z[6],S=Z[7],f=Z[8],T=Z[9],v=Z[10],L=Z[11];return Z!==h&&(h[0]=Z[0],h[1]=Z[1],h[2]=Z[2],h[3]=Z[3],h[12]=Z[12],h[13]=Z[13],h[14]=Z[14],h[15]=Z[15]),h[4]=N*G+f*V,h[5]=X*G+T*V,h[6]=M*G+v*V,h[7]=S*G+L*V,h[8]=f*G-N*V,h[9]=T*G-X*V,h[10]=v*G-M*V,h[11]=L*G-S*V,h},We.rotateY=function(h,Z,F){var V=Math.sin(F),G=Math.cos(F),N=Z[0],X=Z[1],M=Z[2],S=Z[3],f=Z[8],T=Z[9],v=Z[10],L=Z[11];return Z!==h&&(h[4]=Z[4],h[5]=Z[5],h[6]=Z[6],h[7]=Z[7],h[12]=Z[12],h[13]=Z[13],h[14]=Z[14],h[15]=Z[15]),h[0]=N*G-f*V,h[1]=X*G-T*V,h[2]=M*G-v*V,h[3]=S*G-L*V,h[8]=N*V+f*G,h[9]=X*V+T*G,h[10]=M*V+v*G,h[11]=S*V+L*G,h},We.rotateZ=function(h,Z,F){var V=Math.sin(F),G=Math.cos(F),N=Z[0],X=Z[1],M=Z[2],S=Z[3],f=Z[4],T=Z[5],v=Z[6],L=Z[7];return Z!==h&&(h[8]=Z[8],h[9]=Z[9],h[10]=Z[10],h[11]=Z[11],h[12]=Z[12],h[13]=Z[13],h[14]=Z[14],h[15]=Z[15]),h[0]=N*G+f*V,h[1]=X*G+T*V,h[2]=M*G+v*V,h[3]=S*G+L*V,h[4]=f*G-N*V,h[5]=T*G-X*V,h[6]=v*G-M*V,h[7]=L*G-S*V,h},We.fromTranslation=function(h,Z){return h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=Z[0],h[13]=Z[1],h[14]=Z[2],h[15]=1,h},We.fromScaling=function(h,Z){return h[0]=Z[0],h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=Z[1],h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=Z[2],h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h},We.fromRotation=function(h,Z,F){var V,G,N,X=F[0],M=F[1],S=F[2],f=Math.hypot(X,M,S);return f<t.EPSILON?null:(X*=f=1/f,M*=f,S*=f,V=Math.sin(Z),G=Math.cos(Z),h[0]=X*X*(N=1-G)+G,h[1]=M*X*N+S*V,h[2]=S*X*N-M*V,h[3]=0,h[4]=X*M*N-S*V,h[5]=M*M*N+G,h[6]=S*M*N+X*V,h[7]=0,h[8]=X*S*N+M*V,h[9]=M*S*N-X*V,h[10]=S*S*N+G,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h)},We.fromXRotation=function(h,Z){var F=Math.sin(Z),V=Math.cos(Z);return h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=V,h[6]=F,h[7]=0,h[8]=0,h[9]=-F,h[10]=V,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h},We.fromYRotation=function(h,Z){var F=Math.sin(Z),V=Math.cos(Z);return h[0]=V,h[1]=0,h[2]=-F,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=F,h[9]=0,h[10]=V,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h},We.fromZRotation=function(h,Z){var F=Math.sin(Z),V=Math.cos(Z);return h[0]=V,h[1]=F,h[2]=0,h[3]=0,h[4]=-F,h[5]=V,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h},We.fromRotationTranslation=s,We.fromQuat2=function(h,Z){var F=new t.ARRAY_TYPE(3),V=-Z[0],G=-Z[1],N=-Z[2],X=Z[3],M=Z[4],S=Z[5],f=Z[6],T=Z[7],v=V*V+G*G+N*N+X*X;return v>0?(F[0]=2*(M*X+T*V+S*N-f*G)/v,F[1]=2*(S*X+T*G+f*V-M*N)/v,F[2]=2*(f*X+T*N+M*G-S*V)/v):(F[0]=2*(M*X+T*V+S*N-f*G),F[1]=2*(S*X+T*G+f*V-M*N),F[2]=2*(f*X+T*N+M*G-S*V)),s(h,Z,F),h},We.getTranslation=function(h,Z){return h[0]=Z[12],h[1]=Z[13],h[2]=Z[14],h},We.getScaling=b,We.getRotation=function(h,Z){var F=new t.ARRAY_TYPE(3);b(F,Z);var V=1/F[0],G=1/F[1],N=1/F[2],X=Z[0]*V,M=Z[1]*G,S=Z[2]*N,f=Z[4]*V,T=Z[5]*G,v=Z[6]*N,L=Z[8]*V,D=Z[9]*G,q=Z[10]*N,tt=X+T+q,P=0;return tt>0?(P=2*Math.sqrt(tt+1),h[3]=.25*P,h[0]=(v-D)/P,h[1]=(L-S)/P,h[2]=(M-f)/P):X>T&&X>q?(P=2*Math.sqrt(1+X-T-q),h[3]=(v-D)/P,h[0]=.25*P,h[1]=(M+f)/P,h[2]=(L+S)/P):T>q?(P=2*Math.sqrt(1+T-X-q),h[3]=(L-S)/P,h[0]=(M+f)/P,h[1]=.25*P,h[2]=(v+D)/P):(P=2*Math.sqrt(1+q-X-T),h[3]=(M-f)/P,h[0]=(L+S)/P,h[1]=(v+D)/P,h[2]=.25*P),h},We.fromRotationTranslationScale=function(h,Z,F,V){var G=Z[0],N=Z[1],X=Z[2],M=Z[3],S=G+G,f=N+N,T=X+X,v=G*S,L=G*f,D=G*T,q=N*f,tt=N*T,P=X*T,st=M*S,it=M*f,dt=M*T,Zt=V[0],Vt=V[1],Rt=V[2];return h[0]=(1-(q+P))*Zt,h[1]=(L+dt)*Zt,h[2]=(D-it)*Zt,h[3]=0,h[4]=(L-dt)*Vt,h[5]=(1-(v+P))*Vt,h[6]=(tt+st)*Vt,h[7]=0,h[8]=(D+it)*Rt,h[9]=(tt-st)*Rt,h[10]=(1-(v+q))*Rt,h[11]=0,h[12]=F[0],h[13]=F[1],h[14]=F[2],h[15]=1,h},We.fromRotationTranslationScaleOrigin=function(h,Z,F,V,G){var N=Z[0],X=Z[1],M=Z[2],S=Z[3],f=N+N,T=X+X,v=M+M,L=N*f,D=N*T,q=N*v,tt=X*T,P=X*v,st=M*v,it=S*f,dt=S*T,Zt=S*v,Vt=V[0],Rt=V[1],Ft=V[2],yt=G[0],xt=G[1],ft=G[2],At=(1-(tt+st))*Vt,Ct=(D+Zt)*Vt,se=(q-dt)*Vt,ae=(D-Zt)*Rt,Pt=(1-(L+st))*Rt,jt=(P+it)*Rt,xe=(q+dt)*Ft,oe=(P-it)*Ft,me=(1-(L+tt))*Ft;return h[0]=At,h[1]=Ct,h[2]=se,h[3]=0,h[4]=ae,h[5]=Pt,h[6]=jt,h[7]=0,h[8]=xe,h[9]=oe,h[10]=me,h[11]=0,h[12]=F[0]+yt-(At*yt+ae*xt+xe*ft),h[13]=F[1]+xt-(Ct*yt+Pt*xt+oe*ft),h[14]=F[2]+ft-(se*yt+jt*xt+me*ft),h[15]=1,h},We.fromQuat=function(h,Z){var F=Z[0],V=Z[1],G=Z[2],N=Z[3],X=F+F,M=V+V,S=G+G,f=F*X,T=V*X,v=V*M,L=G*X,D=G*M,q=G*S,tt=N*X,P=N*M,st=N*S;return h[0]=1-v-q,h[1]=T+st,h[2]=L-P,h[3]=0,h[4]=T-st,h[5]=1-f-q,h[6]=D+tt,h[7]=0,h[8]=L+P,h[9]=D-tt,h[10]=1-f-v,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h},We.frustum=function(h,Z,F,V,G,N,X){var M=1/(F-Z),S=1/(G-V),f=1/(N-X);return h[0]=2*N*M,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2*N*S,h[6]=0,h[7]=0,h[8]=(F+Z)*M,h[9]=(G+V)*S,h[10]=(X+N)*f,h[11]=-1,h[12]=0,h[13]=0,h[14]=X*N*2*f,h[15]=0,h},We.perspectiveNO=W,We.perspectiveZO=function(h,Z,F,V,G){var N,X=1/Math.tan(Z/2);return h[0]=X/F,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=X,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,G!=null&&G!==1/0?(h[10]=G*(N=1/(V-G)),h[14]=G*V*N):(h[10]=-1,h[14]=-V),h},We.perspectiveFromFieldOfView=function(h,Z,F,V){var G=Math.tan(Z.upDegrees*Math.PI/180),N=Math.tan(Z.downDegrees*Math.PI/180),X=Math.tan(Z.leftDegrees*Math.PI/180),M=Math.tan(Z.rightDegrees*Math.PI/180),S=2/(X+M),f=2/(G+N);return h[0]=S,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=f,h[6]=0,h[7]=0,h[8]=-(X-M)*S*.5,h[9]=(G-N)*f*.5,h[10]=V/(F-V),h[11]=-1,h[12]=0,h[13]=0,h[14]=V*F/(F-V),h[15]=0,h},We.orthoNO=R,We.orthoZO=function(h,Z,F,V,G,N,X){var M=1/(Z-F),S=1/(V-G),f=1/(N-X);return h[0]=-2*M,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=-2*S,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=f,h[11]=0,h[12]=(Z+F)*M,h[13]=(G+V)*S,h[14]=N*f,h[15]=1,h},We.lookAt=function(h,Z,F,V){var G,N,X,M,S,f,T,v,L,D,q=Z[0],tt=Z[1],P=Z[2],st=V[0],it=V[1],dt=V[2],Zt=F[0],Vt=F[1],Rt=F[2];return Math.abs(q-Zt)<t.EPSILON&&Math.abs(tt-Vt)<t.EPSILON&&Math.abs(P-Rt)<t.EPSILON?o(h):(T=q-Zt,v=tt-Vt,L=P-Rt,G=it*(L*=D=1/Math.hypot(T,v,L))-dt*(v*=D),N=dt*(T*=D)-st*L,X=st*v-it*T,(D=Math.hypot(G,N,X))?(G*=D=1/D,N*=D,X*=D):(G=0,N=0,X=0),M=v*X-L*N,S=L*G-T*X,f=T*N-v*G,(D=Math.hypot(M,S,f))?(M*=D=1/D,S*=D,f*=D):(M=0,S=0,f=0),h[0]=G,h[1]=M,h[2]=T,h[3]=0,h[4]=N,h[5]=S,h[6]=v,h[7]=0,h[8]=X,h[9]=f,h[10]=L,h[11]=0,h[12]=-(G*q+N*tt+X*P),h[13]=-(M*q+S*tt+f*P),h[14]=-(T*q+v*tt+L*P),h[15]=1,h)},We.targetTo=function(h,Z,F,V){var G=Z[0],N=Z[1],X=Z[2],M=V[0],S=V[1],f=V[2],T=G-F[0],v=N-F[1],L=X-F[2],D=T*T+v*v+L*L;D>0&&(T*=D=1/Math.sqrt(D),v*=D,L*=D);var q=S*L-f*v,tt=f*T-M*L,P=M*v-S*T;return(D=q*q+tt*tt+P*P)>0&&(q*=D=1/Math.sqrt(D),tt*=D,P*=D),h[0]=q,h[1]=tt,h[2]=P,h[3]=0,h[4]=v*P-L*tt,h[5]=L*q-T*P,h[6]=T*tt-v*q,h[7]=0,h[8]=T,h[9]=v,h[10]=L,h[11]=0,h[12]=G,h[13]=N,h[14]=X,h[15]=1,h},We.str=function(h){return"mat4("+h[0]+", "+h[1]+", "+h[2]+", "+h[3]+", "+h[4]+", "+h[5]+", "+h[6]+", "+h[7]+", "+h[8]+", "+h[9]+", "+h[10]+", "+h[11]+", "+h[12]+", "+h[13]+", "+h[14]+", "+h[15]+")"},We.frob=function(h){return Math.hypot(h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15])},We.add=function(h,Z,F){return h[0]=Z[0]+F[0],h[1]=Z[1]+F[1],h[2]=Z[2]+F[2],h[3]=Z[3]+F[3],h[4]=Z[4]+F[4],h[5]=Z[5]+F[5],h[6]=Z[6]+F[6],h[7]=Z[7]+F[7],h[8]=Z[8]+F[8],h[9]=Z[9]+F[9],h[10]=Z[10]+F[10],h[11]=Z[11]+F[11],h[12]=Z[12]+F[12],h[13]=Z[13]+F[13],h[14]=Z[14]+F[14],h[15]=Z[15]+F[15],h},We.subtract=I,We.multiplyScalar=function(h,Z,F){return h[0]=Z[0]*F,h[1]=Z[1]*F,h[2]=Z[2]*F,h[3]=Z[3]*F,h[4]=Z[4]*F,h[5]=Z[5]*F,h[6]=Z[6]*F,h[7]=Z[7]*F,h[8]=Z[8]*F,h[9]=Z[9]*F,h[10]=Z[10]*F,h[11]=Z[11]*F,h[12]=Z[12]*F,h[13]=Z[13]*F,h[14]=Z[14]*F,h[15]=Z[15]*F,h},We.multiplyScalarAndAdd=function(h,Z,F,V){return h[0]=Z[0]+F[0]*V,h[1]=Z[1]+F[1]*V,h[2]=Z[2]+F[2]*V,h[3]=Z[3]+F[3]*V,h[4]=Z[4]+F[4]*V,h[5]=Z[5]+F[5]*V,h[6]=Z[6]+F[6]*V,h[7]=Z[7]+F[7]*V,h[8]=Z[8]+F[8]*V,h[9]=Z[9]+F[9]*V,h[10]=Z[10]+F[10]*V,h[11]=Z[11]+F[11]*V,h[12]=Z[12]+F[12]*V,h[13]=Z[13]+F[13]*V,h[14]=Z[14]+F[14]*V,h[15]=Z[15]+F[15]*V,h},We.exactEquals=function(h,Z){return h[0]===Z[0]&&h[1]===Z[1]&&h[2]===Z[2]&&h[3]===Z[3]&&h[4]===Z[4]&&h[5]===Z[5]&&h[6]===Z[6]&&h[7]===Z[7]&&h[8]===Z[8]&&h[9]===Z[9]&&h[10]===Z[10]&&h[11]===Z[11]&&h[12]===Z[12]&&h[13]===Z[13]&&h[14]===Z[14]&&h[15]===Z[15]},We.equals=function(h,Z){var F=h[0],V=h[1],G=h[2],N=h[3],X=h[4],M=h[5],S=h[6],f=h[7],T=h[8],v=h[9],L=h[10],D=h[11],q=h[12],tt=h[13],P=h[14],st=h[15],it=Z[0],dt=Z[1],Zt=Z[2],Vt=Z[3],Rt=Z[4],Ft=Z[5],yt=Z[6],xt=Z[7],ft=Z[8],At=Z[9],Ct=Z[10],se=Z[11],ae=Z[12],Pt=Z[13],jt=Z[14],xe=Z[15];return Math.abs(F-it)<=t.EPSILON*Math.max(1,Math.abs(F),Math.abs(it))&&Math.abs(V-dt)<=t.EPSILON*Math.max(1,Math.abs(V),Math.abs(dt))&&Math.abs(G-Zt)<=t.EPSILON*Math.max(1,Math.abs(G),Math.abs(Zt))&&Math.abs(N-Vt)<=t.EPSILON*Math.max(1,Math.abs(N),Math.abs(Vt))&&Math.abs(X-Rt)<=t.EPSILON*Math.max(1,Math.abs(X),Math.abs(Rt))&&Math.abs(M-Ft)<=t.EPSILON*Math.max(1,Math.abs(M),Math.abs(Ft))&&Math.abs(S-yt)<=t.EPSILON*Math.max(1,Math.abs(S),Math.abs(yt))&&Math.abs(f-xt)<=t.EPSILON*Math.max(1,Math.abs(f),Math.abs(xt))&&Math.abs(T-ft)<=t.EPSILON*Math.max(1,Math.abs(T),Math.abs(ft))&&Math.abs(v-At)<=t.EPSILON*Math.max(1,Math.abs(v),Math.abs(At))&&Math.abs(L-Ct)<=t.EPSILON*Math.max(1,Math.abs(L),Math.abs(Ct))&&Math.abs(D-se)<=t.EPSILON*Math.max(1,Math.abs(D),Math.abs(se))&&Math.abs(q-ae)<=t.EPSILON*Math.max(1,Math.abs(q),Math.abs(ae))&&Math.abs(tt-Pt)<=t.EPSILON*Math.max(1,Math.abs(tt),Math.abs(Pt))&&Math.abs(P-jt)<=t.EPSILON*Math.max(1,Math.abs(P),Math.abs(jt))&&Math.abs(st-xe)<=t.EPSILON*Math.max(1,Math.abs(st),Math.abs(xe))},We.sub=We.mul=We.ortho=We.perspective=void 0;var t=function(h,Z){if(h&&h.__esModule)return h;if(h===null||n(h)!=="object"&&typeof h!="function")return{default:h};var F=i(void 0);if(F&&F.has(h))return F.get(h);var V={},G=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var N in h)if(N!=="default"&&Object.prototype.hasOwnProperty.call(h,N)){var X=G?Object.getOwnPropertyDescriptor(h,N):null;X&&(X.get||X.set)?Object.defineProperty(V,N,X):V[N]=h[N]}return V.default=h,F&&F.set(h,V),V}(Kt());function i(h){if(typeof WeakMap!="function")return null;var Z=new WeakMap,F=new WeakMap;return(i=function(V){return V?F:Z})(h)}function o(h){return h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h}function c(h,Z,F){var V=Z[0],G=Z[1],N=Z[2],X=Z[3],M=Z[4],S=Z[5],f=Z[6],T=Z[7],v=Z[8],L=Z[9],D=Z[10],q=Z[11],tt=Z[12],P=Z[13],st=Z[14],it=Z[15],dt=F[0],Zt=F[1],Vt=F[2],Rt=F[3];return h[0]=dt*V+Zt*M+Vt*v+Rt*tt,h[1]=dt*G+Zt*S+Vt*L+Rt*P,h[2]=dt*N+Zt*f+Vt*D+Rt*st,h[3]=dt*X+Zt*T+Vt*q+Rt*it,h[4]=(dt=F[4])*V+(Zt=F[5])*M+(Vt=F[6])*v+(Rt=F[7])*tt,h[5]=dt*G+Zt*S+Vt*L+Rt*P,h[6]=dt*N+Zt*f+Vt*D+Rt*st,h[7]=dt*X+Zt*T+Vt*q+Rt*it,h[8]=(dt=F[8])*V+(Zt=F[9])*M+(Vt=F[10])*v+(Rt=F[11])*tt,h[9]=dt*G+Zt*S+Vt*L+Rt*P,h[10]=dt*N+Zt*f+Vt*D+Rt*st,h[11]=dt*X+Zt*T+Vt*q+Rt*it,h[12]=(dt=F[12])*V+(Zt=F[13])*M+(Vt=F[14])*v+(Rt=F[15])*tt,h[13]=dt*G+Zt*S+Vt*L+Rt*P,h[14]=dt*N+Zt*f+Vt*D+Rt*st,h[15]=dt*X+Zt*T+Vt*q+Rt*it,h}function s(h,Z,F){var V=Z[0],G=Z[1],N=Z[2],X=Z[3],M=V+V,S=G+G,f=N+N,T=V*M,v=V*S,L=V*f,D=G*S,q=G*f,tt=N*f,P=X*M,st=X*S,it=X*f;return h[0]=1-(D+tt),h[1]=v+it,h[2]=L-st,h[3]=0,h[4]=v-it,h[5]=1-(T+tt),h[6]=q+P,h[7]=0,h[8]=L+st,h[9]=q-P,h[10]=1-(T+D),h[11]=0,h[12]=F[0],h[13]=F[1],h[14]=F[2],h[15]=1,h}function b(h,Z){var F=Z[4],V=Z[5],G=Z[6],N=Z[8],X=Z[9],M=Z[10];return h[0]=Math.hypot(Z[0],Z[1],Z[2]),h[1]=Math.hypot(F,V,G),h[2]=Math.hypot(N,X,M),h}function W(h,Z,F,V,G){var N,X=1/Math.tan(Z/2);return h[0]=X/F,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=X,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,G!=null&&G!==1/0?(h[10]=(G+V)*(N=1/(V-G)),h[14]=2*G*V*N):(h[10]=-1,h[14]=-2*V),h}function R(h,Z,F,V,G,N,X){var M=1/(Z-F),S=1/(V-G),f=1/(N-X);return h[0]=-2*M,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=-2*S,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=2*f,h[11]=0,h[12]=(Z+F)*M,h[13]=(G+V)*S,h[14]=(X+N)*f,h[15]=1,h}function I(h,Z,F){return h[0]=Z[0]-F[0],h[1]=Z[1]-F[1],h[2]=Z[2]-F[2],h[3]=Z[3]-F[3],h[4]=Z[4]-F[4],h[5]=Z[5]-F[5],h[6]=Z[6]-F[6],h[7]=Z[7]-F[7],h[8]=Z[8]-F[8],h[9]=Z[9]-F[9],h[10]=Z[10]-F[10],h[11]=Z[11]-F[11],h[12]=Z[12]-F[12],h[13]=Z[13]-F[13],h[14]=Z[14]-F[14],h[15]=Z[15]-F[15],h}return We.perspective=W,We.ortho=R,We.mul=c,We.sub=I,We}var Zi,Re={},Fe={};function wi(){if(Zi)return Fe;function n(G){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(N){return typeof N}:function(N){return N&&typeof Symbol=="function"&&N.constructor===Symbol&&N!==Symbol.prototype?"symbol":typeof N},n(G)}Zi=1,Object.defineProperty(Fe,"__esModule",{value:!0}),Fe.create=o,Fe.clone=function(G){var N=new t.ARRAY_TYPE(3);return N[0]=G[0],N[1]=G[1],N[2]=G[2],N},Fe.length=c,Fe.fromValues=function(G,N,X){var M=new t.ARRAY_TYPE(3);return M[0]=G,M[1]=N,M[2]=X,M},Fe.copy=function(G,N){return G[0]=N[0],G[1]=N[1],G[2]=N[2],G},Fe.set=function(G,N,X,M){return G[0]=N,G[1]=X,G[2]=M,G},Fe.add=function(G,N,X){return G[0]=N[0]+X[0],G[1]=N[1]+X[1],G[2]=N[2]+X[2],G},Fe.subtract=s,Fe.multiply=b,Fe.divide=W,Fe.ceil=function(G,N){return G[0]=Math.ceil(N[0]),G[1]=Math.ceil(N[1]),G[2]=Math.ceil(N[2]),G},Fe.floor=function(G,N){return G[0]=Math.floor(N[0]),G[1]=Math.floor(N[1]),G[2]=Math.floor(N[2]),G},Fe.min=function(G,N,X){return G[0]=Math.min(N[0],X[0]),G[1]=Math.min(N[1],X[1]),G[2]=Math.min(N[2],X[2]),G},Fe.max=function(G,N,X){return G[0]=Math.max(N[0],X[0]),G[1]=Math.max(N[1],X[1]),G[2]=Math.max(N[2],X[2]),G},Fe.round=function(G,N){return G[0]=Math.round(N[0]),G[1]=Math.round(N[1]),G[2]=Math.round(N[2]),G},Fe.scale=function(G,N,X){return G[0]=N[0]*X,G[1]=N[1]*X,G[2]=N[2]*X,G},Fe.scaleAndAdd=function(G,N,X,M){return G[0]=N[0]+X[0]*M,G[1]=N[1]+X[1]*M,G[2]=N[2]+X[2]*M,G},Fe.distance=R,Fe.squaredDistance=I,Fe.squaredLength=h,Fe.negate=function(G,N){return G[0]=-N[0],G[1]=-N[1],G[2]=-N[2],G},Fe.inverse=function(G,N){return G[0]=1/N[0],G[1]=1/N[1],G[2]=1/N[2],G},Fe.normalize=function(G,N){var X=N[0],M=N[1],S=N[2],f=X*X+M*M+S*S;return f>0&&(f=1/Math.sqrt(f)),G[0]=N[0]*f,G[1]=N[1]*f,G[2]=N[2]*f,G},Fe.dot=Z,Fe.cross=function(G,N,X){var M=N[0],S=N[1],f=N[2],T=X[0],v=X[1],L=X[2];return G[0]=S*L-f*v,G[1]=f*T-M*L,G[2]=M*v-S*T,G},Fe.lerp=function(G,N,X,M){var S=N[0],f=N[1],T=N[2];return G[0]=S+M*(X[0]-S),G[1]=f+M*(X[1]-f),G[2]=T+M*(X[2]-T),G},Fe.hermite=function(G,N,X,M,S,f){var T=f*f,v=T*(2*f-3)+1,L=T*(f-2)+f,D=T*(f-1),q=T*(3-2*f);return G[0]=N[0]*v+X[0]*L+M[0]*D+S[0]*q,G[1]=N[1]*v+X[1]*L+M[1]*D+S[1]*q,G[2]=N[2]*v+X[2]*L+M[2]*D+S[2]*q,G},Fe.bezier=function(G,N,X,M,S,f){var T=1-f,v=T*T,L=f*f,D=v*T,q=3*f*v,tt=3*L*T,P=L*f;return G[0]=N[0]*D+X[0]*q+M[0]*tt+S[0]*P,G[1]=N[1]*D+X[1]*q+M[1]*tt+S[1]*P,G[2]=N[2]*D+X[2]*q+M[2]*tt+S[2]*P,G},Fe.random=function(G,N){N=N||1;var X=2*t.RANDOM()*Math.PI,M=2*t.RANDOM()-1,S=Math.sqrt(1-M*M)*N;return G[0]=Math.cos(X)*S,G[1]=Math.sin(X)*S,G[2]=M*N,G},Fe.transformMat4=function(G,N,X){var M=N[0],S=N[1],f=N[2],T=X[3]*M+X[7]*S+X[11]*f+X[15];return G[0]=(X[0]*M+X[4]*S+X[8]*f+X[12])/(T=T||1),G[1]=(X[1]*M+X[5]*S+X[9]*f+X[13])/T,G[2]=(X[2]*M+X[6]*S+X[10]*f+X[14])/T,G},Fe.transformMat3=function(G,N,X){var M=N[0],S=N[1],f=N[2];return G[0]=M*X[0]+S*X[3]+f*X[6],G[1]=M*X[1]+S*X[4]+f*X[7],G[2]=M*X[2]+S*X[5]+f*X[8],G},Fe.transformQuat=function(G,N,X){var M=X[0],S=X[1],f=X[2],T=N[0],v=N[1],L=N[2],D=S*L-f*v,q=f*T-M*L,tt=M*v-S*T,P=S*tt-f*q,st=f*D-M*tt,it=M*q-S*D,dt=2*X[3];return q*=dt,tt*=dt,st*=2,it*=2,G[0]=T+(D*=dt)+(P*=2),G[1]=v+q+st,G[2]=L+tt+it,G},Fe.rotateX=function(G,N,X,M){var S=[],f=[];return S[0]=N[0]-X[0],S[1]=N[1]-X[1],S[2]=N[2]-X[2],f[0]=S[0],f[1]=S[1]*Math.cos(M)-S[2]*Math.sin(M),f[2]=S[1]*Math.sin(M)+S[2]*Math.cos(M),G[0]=f[0]+X[0],G[1]=f[1]+X[1],G[2]=f[2]+X[2],G},Fe.rotateY=function(G,N,X,M){var S=[],f=[];return S[0]=N[0]-X[0],S[1]=N[1]-X[1],S[2]=N[2]-X[2],f[0]=S[2]*Math.sin(M)+S[0]*Math.cos(M),f[1]=S[1],f[2]=S[2]*Math.cos(M)-S[0]*Math.sin(M),G[0]=f[0]+X[0],G[1]=f[1]+X[1],G[2]=f[2]+X[2],G},Fe.rotateZ=function(G,N,X,M){var S=[],f=[];return S[0]=N[0]-X[0],S[1]=N[1]-X[1],S[2]=N[2]-X[2],f[0]=S[0]*Math.cos(M)-S[1]*Math.sin(M),f[1]=S[0]*Math.sin(M)+S[1]*Math.cos(M),f[2]=S[2],G[0]=f[0]+X[0],G[1]=f[1]+X[1],G[2]=f[2]+X[2],G},Fe.angle=function(G,N){var X=G[0],M=G[1],S=G[2],f=N[0],T=N[1],v=N[2],L=Math.sqrt(X*X+M*M+S*S)*Math.sqrt(f*f+T*T+v*v),D=L&&Z(G,N)/L;return Math.acos(Math.min(Math.max(D,-1),1))},Fe.zero=function(G){return G[0]=0,G[1]=0,G[2]=0,G},Fe.str=function(G){return"vec3("+G[0]+", "+G[1]+", "+G[2]+")"},Fe.exactEquals=function(G,N){return G[0]===N[0]&&G[1]===N[1]&&G[2]===N[2]},Fe.equals=function(G,N){var X=G[0],M=G[1],S=G[2],f=N[0],T=N[1],v=N[2];return Math.abs(X-f)<=t.EPSILON*Math.max(1,Math.abs(X),Math.abs(f))&&Math.abs(M-T)<=t.EPSILON*Math.max(1,Math.abs(M),Math.abs(T))&&Math.abs(S-v)<=t.EPSILON*Math.max(1,Math.abs(S),Math.abs(v))},Fe.forEach=Fe.sqrLen=Fe.len=Fe.sqrDist=Fe.dist=Fe.div=Fe.mul=Fe.sub=void 0;var t=function(G,N){if(G&&G.__esModule)return G;if(G===null||n(G)!=="object"&&typeof G!="function")return{default:G};var X=i(void 0);if(X&&X.has(G))return X.get(G);var M={},S=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in G)if(f!=="default"&&Object.prototype.hasOwnProperty.call(G,f)){var T=S?Object.getOwnPropertyDescriptor(G,f):null;T&&(T.get||T.set)?Object.defineProperty(M,f,T):M[f]=G[f]}return M.default=G,X&&X.set(G,M),M}(Kt());function i(G){if(typeof WeakMap!="function")return null;var N=new WeakMap,X=new WeakMap;return(i=function(M){return M?X:N})(G)}function o(){var G=new t.ARRAY_TYPE(3);return t.ARRAY_TYPE!=Float32Array&&(G[0]=0,G[1]=0,G[2]=0),G}function c(G){return Math.hypot(G[0],G[1],G[2])}function s(G,N,X){return G[0]=N[0]-X[0],G[1]=N[1]-X[1],G[2]=N[2]-X[2],G}function b(G,N,X){return G[0]=N[0]*X[0],G[1]=N[1]*X[1],G[2]=N[2]*X[2],G}function W(G,N,X){return G[0]=N[0]/X[0],G[1]=N[1]/X[1],G[2]=N[2]/X[2],G}function R(G,N){return Math.hypot(N[0]-G[0],N[1]-G[1],N[2]-G[2])}function I(G,N){var X=N[0]-G[0],M=N[1]-G[1],S=N[2]-G[2];return X*X+M*M+S*S}function h(G){var N=G[0],X=G[1],M=G[2];return N*N+X*X+M*M}function Z(G,N){return G[0]*N[0]+G[1]*N[1]+G[2]*N[2]}Fe.sub=s,Fe.mul=b,Fe.div=W,Fe.dist=R,Fe.sqrDist=I,Fe.len=c,Fe.sqrLen=h;var F,V=(F=o(),function(G,N,X,M,S,f){var T,v;for(N||(N=3),X||(X=0),v=M?Math.min(M*N+X,G.length):G.length,T=X;T<v;T+=N)F[0]=G[T],F[1]=G[T+1],F[2]=G[T+2],S(F,F,f),G[T]=F[0],G[T+1]=F[1],G[T+2]=F[2];return G});return Fe.forEach=V,Fe}var Pi,Sa,ye={};function aa(){if(Pi)return ye;function n(V){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(G){return typeof G}:function(G){return G&&typeof Symbol=="function"&&G.constructor===Symbol&&G!==Symbol.prototype?"symbol":typeof G},n(V)}Pi=1,Object.defineProperty(ye,"__esModule",{value:!0}),ye.create=o,ye.clone=function(V){var G=new t.ARRAY_TYPE(4);return G[0]=V[0],G[1]=V[1],G[2]=V[2],G[3]=V[3],G},ye.fromValues=function(V,G,N,X){var M=new t.ARRAY_TYPE(4);return M[0]=V,M[1]=G,M[2]=N,M[3]=X,M},ye.copy=function(V,G){return V[0]=G[0],V[1]=G[1],V[2]=G[2],V[3]=G[3],V},ye.set=function(V,G,N,X,M){return V[0]=G,V[1]=N,V[2]=X,V[3]=M,V},ye.add=function(V,G,N){return V[0]=G[0]+N[0],V[1]=G[1]+N[1],V[2]=G[2]+N[2],V[3]=G[3]+N[3],V},ye.subtract=c,ye.multiply=s,ye.divide=b,ye.ceil=function(V,G){return V[0]=Math.ceil(G[0]),V[1]=Math.ceil(G[1]),V[2]=Math.ceil(G[2]),V[3]=Math.ceil(G[3]),V},ye.floor=function(V,G){return V[0]=Math.floor(G[0]),V[1]=Math.floor(G[1]),V[2]=Math.floor(G[2]),V[3]=Math.floor(G[3]),V},ye.min=function(V,G,N){return V[0]=Math.min(G[0],N[0]),V[1]=Math.min(G[1],N[1]),V[2]=Math.min(G[2],N[2]),V[3]=Math.min(G[3],N[3]),V},ye.max=function(V,G,N){return V[0]=Math.max(G[0],N[0]),V[1]=Math.max(G[1],N[1]),V[2]=Math.max(G[2],N[2]),V[3]=Math.max(G[3],N[3]),V},ye.round=function(V,G){return V[0]=Math.round(G[0]),V[1]=Math.round(G[1]),V[2]=Math.round(G[2]),V[3]=Math.round(G[3]),V},ye.scale=function(V,G,N){return V[0]=G[0]*N,V[1]=G[1]*N,V[2]=G[2]*N,V[3]=G[3]*N,V},ye.scaleAndAdd=function(V,G,N,X){return V[0]=G[0]+N[0]*X,V[1]=G[1]+N[1]*X,V[2]=G[2]+N[2]*X,V[3]=G[3]+N[3]*X,V},ye.distance=W,ye.squaredDistance=R,ye.length=I,ye.squaredLength=h,ye.negate=function(V,G){return V[0]=-G[0],V[1]=-G[1],V[2]=-G[2],V[3]=-G[3],V},ye.inverse=function(V,G){return V[0]=1/G[0],V[1]=1/G[1],V[2]=1/G[2],V[3]=1/G[3],V},ye.normalize=function(V,G){var N=G[0],X=G[1],M=G[2],S=G[3],f=N*N+X*X+M*M+S*S;return f>0&&(f=1/Math.sqrt(f)),V[0]=N*f,V[1]=X*f,V[2]=M*f,V[3]=S*f,V},ye.dot=function(V,G){return V[0]*G[0]+V[1]*G[1]+V[2]*G[2]+V[3]*G[3]},ye.cross=function(V,G,N,X){var M=N[0]*X[1]-N[1]*X[0],S=N[0]*X[2]-N[2]*X[0],f=N[0]*X[3]-N[3]*X[0],T=N[1]*X[2]-N[2]*X[1],v=N[1]*X[3]-N[3]*X[1],L=N[2]*X[3]-N[3]*X[2],D=G[0],q=G[1],tt=G[2],P=G[3];return V[0]=q*L-tt*v+P*T,V[1]=-D*L+tt*f-P*S,V[2]=D*v-q*f+P*M,V[3]=-D*T+q*S-tt*M,V},ye.lerp=function(V,G,N,X){var M=G[0],S=G[1],f=G[2],T=G[3];return V[0]=M+X*(N[0]-M),V[1]=S+X*(N[1]-S),V[2]=f+X*(N[2]-f),V[3]=T+X*(N[3]-T),V},ye.random=function(V,G){var N,X,M,S,f,T;G=G||1;do f=(N=2*t.RANDOM()-1)*N+(X=2*t.RANDOM()-1)*X;while(f>=1);do T=(M=2*t.RANDOM()-1)*M+(S=2*t.RANDOM()-1)*S;while(T>=1);var v=Math.sqrt((1-f)/T);return V[0]=G*N,V[1]=G*X,V[2]=G*M*v,V[3]=G*S*v,V},ye.transformMat4=function(V,G,N){var X=G[0],M=G[1],S=G[2],f=G[3];return V[0]=N[0]*X+N[4]*M+N[8]*S+N[12]*f,V[1]=N[1]*X+N[5]*M+N[9]*S+N[13]*f,V[2]=N[2]*X+N[6]*M+N[10]*S+N[14]*f,V[3]=N[3]*X+N[7]*M+N[11]*S+N[15]*f,V},ye.transformQuat=function(V,G,N){var X=G[0],M=G[1],S=G[2],f=N[0],T=N[1],v=N[2],L=N[3],D=L*X+T*S-v*M,q=L*M+v*X-f*S,tt=L*S+f*M-T*X,P=-f*X-T*M-v*S;return V[0]=D*L+P*-f+q*-v-tt*-T,V[1]=q*L+P*-T+tt*-f-D*-v,V[2]=tt*L+P*-v+D*-T-q*-f,V[3]=G[3],V},ye.zero=function(V){return V[0]=0,V[1]=0,V[2]=0,V[3]=0,V},ye.str=function(V){return"vec4("+V[0]+", "+V[1]+", "+V[2]+", "+V[3]+")"},ye.exactEquals=function(V,G){return V[0]===G[0]&&V[1]===G[1]&&V[2]===G[2]&&V[3]===G[3]},ye.equals=function(V,G){var N=V[0],X=V[1],M=V[2],S=V[3],f=G[0],T=G[1],v=G[2],L=G[3];return Math.abs(N-f)<=t.EPSILON*Math.max(1,Math.abs(N),Math.abs(f))&&Math.abs(X-T)<=t.EPSILON*Math.max(1,Math.abs(X),Math.abs(T))&&Math.abs(M-v)<=t.EPSILON*Math.max(1,Math.abs(M),Math.abs(v))&&Math.abs(S-L)<=t.EPSILON*Math.max(1,Math.abs(S),Math.abs(L))},ye.forEach=ye.sqrLen=ye.len=ye.sqrDist=ye.dist=ye.div=ye.mul=ye.sub=void 0;var t=function(V,G){if(V&&V.__esModule)return V;if(V===null||n(V)!=="object"&&typeof V!="function")return{default:V};var N=i(void 0);if(N&&N.has(V))return N.get(V);var X={},M=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var S in V)if(S!=="default"&&Object.prototype.hasOwnProperty.call(V,S)){var f=M?Object.getOwnPropertyDescriptor(V,S):null;f&&(f.get||f.set)?Object.defineProperty(X,S,f):X[S]=V[S]}return X.default=V,N&&N.set(V,X),X}(Kt());function i(V){if(typeof WeakMap!="function")return null;var G=new WeakMap,N=new WeakMap;return(i=function(X){return X?N:G})(V)}function o(){var V=new t.ARRAY_TYPE(4);return t.ARRAY_TYPE!=Float32Array&&(V[0]=0,V[1]=0,V[2]=0,V[3]=0),V}function c(V,G,N){return V[0]=G[0]-N[0],V[1]=G[1]-N[1],V[2]=G[2]-N[2],V[3]=G[3]-N[3],V}function s(V,G,N){return V[0]=G[0]*N[0],V[1]=G[1]*N[1],V[2]=G[2]*N[2],V[3]=G[3]*N[3],V}function b(V,G,N){return V[0]=G[0]/N[0],V[1]=G[1]/N[1],V[2]=G[2]/N[2],V[3]=G[3]/N[3],V}function W(V,G){return Math.hypot(G[0]-V[0],G[1]-V[1],G[2]-V[2],G[3]-V[3])}function R(V,G){var N=G[0]-V[0],X=G[1]-V[1],M=G[2]-V[2],S=G[3]-V[3];return N*N+X*X+M*M+S*S}function I(V){return Math.hypot(V[0],V[1],V[2],V[3])}function h(V){var G=V[0],N=V[1],X=V[2],M=V[3];return G*G+N*N+X*X+M*M}ye.sub=c,ye.mul=s,ye.div=b,ye.dist=W,ye.sqrDist=R,ye.len=I,ye.sqrLen=h;var Z,F=(Z=o(),function(V,G,N,X,M,S){var f,T;for(G||(G=4),N||(N=0),T=X?Math.min(X*G+N,V.length):V.length,f=N;f<T;f+=G)Z[0]=V[f],Z[1]=V[f+1],Z[2]=V[f+2],Z[3]=V[f+3],M(Z,Z,S),V[f]=Z[0],V[f+1]=Z[1],V[f+2]=Z[2],V[f+3]=Z[3];return V});return ye.forEach=F,ye}function ya(){if(Sa)return Re;function n(it){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(dt){return typeof dt}:function(dt){return dt&&typeof Symbol=="function"&&dt.constructor===Symbol&&dt!==Symbol.prototype?"symbol":typeof dt},n(it)}Sa=1,Object.defineProperty(Re,"__esModule",{value:!0}),Re.create=W,Re.identity=function(it){return it[0]=0,it[1]=0,it[2]=0,it[3]=1,it},Re.setAxisAngle=R,Re.getAxisAngle=function(it,dt){var Zt=2*Math.acos(dt[3]),Vt=Math.sin(Zt/2);return Vt>t.EPSILON?(it[0]=dt[0]/Vt,it[1]=dt[1]/Vt,it[2]=dt[2]/Vt):(it[0]=1,it[1]=0,it[2]=0),Zt},Re.getAngle=function(it,dt){var Zt=N(it,dt);return Math.acos(2*Zt*Zt-1)},Re.multiply=I,Re.rotateX=function(it,dt,Zt){Zt*=.5;var Vt=dt[0],Rt=dt[1],Ft=dt[2],yt=dt[3],xt=Math.sin(Zt),ft=Math.cos(Zt);return it[0]=Vt*ft+yt*xt,it[1]=Rt*ft+Ft*xt,it[2]=Ft*ft-Rt*xt,it[3]=yt*ft-Vt*xt,it},Re.rotateY=function(it,dt,Zt){Zt*=.5;var Vt=dt[0],Rt=dt[1],Ft=dt[2],yt=dt[3],xt=Math.sin(Zt),ft=Math.cos(Zt);return it[0]=Vt*ft-Ft*xt,it[1]=Rt*ft+yt*xt,it[2]=Ft*ft+Vt*xt,it[3]=yt*ft-Rt*xt,it},Re.rotateZ=function(it,dt,Zt){Zt*=.5;var Vt=dt[0],Rt=dt[1],Ft=dt[2],yt=dt[3],xt=Math.sin(Zt),ft=Math.cos(Zt);return it[0]=Vt*ft+Rt*xt,it[1]=Rt*ft-Vt*xt,it[2]=Ft*ft+yt*xt,it[3]=yt*ft-Ft*xt,it},Re.calculateW=function(it,dt){var Zt=dt[0],Vt=dt[1],Rt=dt[2];return it[0]=Zt,it[1]=Vt,it[2]=Rt,it[3]=Math.sqrt(Math.abs(1-Zt*Zt-Vt*Vt-Rt*Rt)),it},Re.exp=h,Re.ln=Z,Re.pow=function(it,dt,Zt){return Z(it,dt),G(it,it,Zt),h(it,it),it},Re.slerp=F,Re.random=function(it){var dt=t.RANDOM(),Zt=t.RANDOM(),Vt=t.RANDOM(),Rt=Math.sqrt(1-dt),Ft=Math.sqrt(dt);return it[0]=Rt*Math.sin(2*Math.PI*Zt),it[1]=Rt*Math.cos(2*Math.PI*Zt),it[2]=Ft*Math.sin(2*Math.PI*Vt),it[3]=Ft*Math.cos(2*Math.PI*Vt),it},Re.invert=function(it,dt){var Zt=dt[0],Vt=dt[1],Rt=dt[2],Ft=dt[3],yt=Zt*Zt+Vt*Vt+Rt*Rt+Ft*Ft,xt=yt?1/yt:0;return it[0]=-Zt*xt,it[1]=-Vt*xt,it[2]=-Rt*xt,it[3]=Ft*xt,it},Re.conjugate=function(it,dt){return it[0]=-dt[0],it[1]=-dt[1],it[2]=-dt[2],it[3]=dt[3],it},Re.fromMat3=V,Re.fromEuler=function(it,dt,Zt,Vt){var Rt=.5*Math.PI/180;dt*=Rt,Zt*=Rt,Vt*=Rt;var Ft=Math.sin(dt),yt=Math.cos(dt),xt=Math.sin(Zt),ft=Math.cos(Zt),At=Math.sin(Vt),Ct=Math.cos(Vt);return it[0]=Ft*ft*Ct-yt*xt*At,it[1]=yt*xt*Ct+Ft*ft*At,it[2]=yt*ft*At-Ft*xt*Ct,it[3]=yt*ft*Ct+Ft*xt*At,it},Re.str=function(it){return"quat("+it[0]+", "+it[1]+", "+it[2]+", "+it[3]+")"},Re.setAxes=Re.sqlerp=Re.rotationTo=Re.equals=Re.exactEquals=Re.normalize=Re.sqrLen=Re.squaredLength=Re.len=Re.length=Re.lerp=Re.dot=Re.scale=Re.mul=Re.add=Re.set=Re.copy=Re.fromValues=Re.clone=void 0;var t=b(Kt()),i=b(vi()),o=b(wi()),c=b(aa());function s(it){if(typeof WeakMap!="function")return null;var dt=new WeakMap,Zt=new WeakMap;return(s=function(Vt){return Vt?Zt:dt})(it)}function b(it,dt){if(it&&it.__esModule)return it;if(it===null||n(it)!=="object"&&typeof it!="function")return{default:it};var Zt=s(dt);if(Zt&&Zt.has(it))return Zt.get(it);var Vt={},Rt=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ft in it)if(Ft!=="default"&&Object.prototype.hasOwnProperty.call(it,Ft)){var yt=Rt?Object.getOwnPropertyDescriptor(it,Ft):null;yt&&(yt.get||yt.set)?Object.defineProperty(Vt,Ft,yt):Vt[Ft]=it[Ft]}return Vt.default=it,Zt&&Zt.set(it,Vt),Vt}function W(){var it=new t.ARRAY_TYPE(4);return t.ARRAY_TYPE!=Float32Array&&(it[0]=0,it[1]=0,it[2]=0),it[3]=1,it}function R(it,dt,Zt){Zt*=.5;var Vt=Math.sin(Zt);return it[0]=Vt*dt[0],it[1]=Vt*dt[1],it[2]=Vt*dt[2],it[3]=Math.cos(Zt),it}function I(it,dt,Zt){var Vt=dt[0],Rt=dt[1],Ft=dt[2],yt=dt[3],xt=Zt[0],ft=Zt[1],At=Zt[2],Ct=Zt[3];return it[0]=Vt*Ct+yt*xt+Rt*At-Ft*ft,it[1]=Rt*Ct+yt*ft+Ft*xt-Vt*At,it[2]=Ft*Ct+yt*At+Vt*ft-Rt*xt,it[3]=yt*Ct-Vt*xt-Rt*ft-Ft*At,it}function h(it,dt){var Zt=dt[0],Vt=dt[1],Rt=dt[2],Ft=dt[3],yt=Math.sqrt(Zt*Zt+Vt*Vt+Rt*Rt),xt=Math.exp(Ft),ft=yt>0?xt*Math.sin(yt)/yt:0;return it[0]=Zt*ft,it[1]=Vt*ft,it[2]=Rt*ft,it[3]=xt*Math.cos(yt),it}function Z(it,dt){var Zt=dt[0],Vt=dt[1],Rt=dt[2],Ft=dt[3],yt=Math.sqrt(Zt*Zt+Vt*Vt+Rt*Rt),xt=yt>0?Math.atan2(yt,Ft)/yt:0;return it[0]=Zt*xt,it[1]=Vt*xt,it[2]=Rt*xt,it[3]=.5*Math.log(Zt*Zt+Vt*Vt+Rt*Rt+Ft*Ft),it}function F(it,dt,Zt,Vt){var Rt,Ft,yt,xt,ft,At=dt[0],Ct=dt[1],se=dt[2],ae=dt[3],Pt=Zt[0],jt=Zt[1],xe=Zt[2],oe=Zt[3];return(Ft=At*Pt+Ct*jt+se*xe+ae*oe)<0&&(Ft=-Ft,Pt=-Pt,jt=-jt,xe=-xe,oe=-oe),1-Ft>t.EPSILON?(Rt=Math.acos(Ft),yt=Math.sin(Rt),xt=Math.sin((1-Vt)*Rt)/yt,ft=Math.sin(Vt*Rt)/yt):(xt=1-Vt,ft=Vt),it[0]=xt*At+ft*Pt,it[1]=xt*Ct+ft*jt,it[2]=xt*se+ft*xe,it[3]=xt*ae+ft*oe,it}function V(it,dt){var Zt,Vt=dt[0]+dt[4]+dt[8];if(Vt>0)Zt=Math.sqrt(Vt+1),it[3]=.5*Zt,it[0]=(dt[5]-dt[7])*(Zt=.5/Zt),it[1]=(dt[6]-dt[2])*Zt,it[2]=(dt[1]-dt[3])*Zt;else{var Rt=0;dt[4]>dt[0]&&(Rt=1),dt[8]>dt[3*Rt+Rt]&&(Rt=2);var Ft=(Rt+1)%3,yt=(Rt+2)%3;Zt=Math.sqrt(dt[3*Rt+Rt]-dt[3*Ft+Ft]-dt[3*yt+yt]+1),it[Rt]=.5*Zt,it[3]=(dt[3*Ft+yt]-dt[3*yt+Ft])*(Zt=.5/Zt),it[Ft]=(dt[3*Ft+Rt]+dt[3*Rt+Ft])*Zt,it[yt]=(dt[3*yt+Rt]+dt[3*Rt+yt])*Zt}return it}Re.clone=c.clone,Re.fromValues=c.fromValues,Re.copy=c.copy,Re.set=c.set,Re.add=c.add,Re.mul=I;var G=c.scale;Re.scale=G;var N=c.dot;Re.dot=N,Re.lerp=c.lerp;var X=c.length;Re.length=X,Re.len=X;var M=c.squaredLength;Re.squaredLength=M,Re.sqrLen=M;var S=c.normalize;Re.normalize=S,Re.exactEquals=c.exactEquals,Re.equals=c.equals;var f,T,v,L=(f=o.create(),T=o.fromValues(1,0,0),v=o.fromValues(0,1,0),function(it,dt,Zt){var Vt=o.dot(dt,Zt);return Vt<-.999999?(o.cross(f,T,dt),o.len(f)<1e-6&&o.cross(f,v,dt),o.normalize(f,f),R(it,f,Math.PI),it):Vt>.999999?(it[0]=0,it[1]=0,it[2]=0,it[3]=1,it):(o.cross(f,dt,Zt),it[0]=f[0],it[1]=f[1],it[2]=f[2],it[3]=1+Vt,S(it,it))});Re.rotationTo=L;var D,q,tt=(D=W(),q=W(),function(it,dt,Zt,Vt,Rt,Ft){return F(D,dt,Rt,Ft),F(q,Zt,Vt,Ft),F(it,D,q,2*Ft*(1-Ft)),it});Re.sqlerp=tt;var P,st=(P=i.create(),function(it,dt,Zt,Vt){return P[0]=Zt[0],P[3]=Zt[1],P[6]=Zt[2],P[1]=Vt[0],P[4]=Vt[1],P[7]=Vt[2],P[2]=-dt[0],P[5]=-dt[1],P[8]=-dt[2],S(it,V(it,P))});return Re.setAxes=st,Re}var ua,Be={};function Yn(){if(ua)return Be;function n(F){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(V){return typeof V}:function(V){return V&&typeof Symbol=="function"&&V.constructor===Symbol&&V!==Symbol.prototype?"symbol":typeof V},n(F)}ua=1,Object.defineProperty(Be,"__esModule",{value:!0}),Be.create=function(){var F=new t.ARRAY_TYPE(8);return t.ARRAY_TYPE!=Float32Array&&(F[0]=0,F[1]=0,F[2]=0,F[4]=0,F[5]=0,F[6]=0,F[7]=0),F[3]=1,F},Be.clone=function(F){var V=new t.ARRAY_TYPE(8);return V[0]=F[0],V[1]=F[1],V[2]=F[2],V[3]=F[3],V[4]=F[4],V[5]=F[5],V[6]=F[6],V[7]=F[7],V},Be.fromValues=function(F,V,G,N,X,M,S,f){var T=new t.ARRAY_TYPE(8);return T[0]=F,T[1]=V,T[2]=G,T[3]=N,T[4]=X,T[5]=M,T[6]=S,T[7]=f,T},Be.fromRotationTranslationValues=function(F,V,G,N,X,M,S){var f=new t.ARRAY_TYPE(8);f[0]=F,f[1]=V,f[2]=G,f[3]=N;var T=.5*X,v=.5*M,L=.5*S;return f[4]=T*N+v*G-L*V,f[5]=v*N+L*F-T*G,f[6]=L*N+T*V-v*F,f[7]=-T*F-v*V-L*G,f},Be.fromRotationTranslation=b,Be.fromTranslation=function(F,V){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=.5*V[0],F[5]=.5*V[1],F[6]=.5*V[2],F[7]=0,F},Be.fromRotation=function(F,V){return F[0]=V[0],F[1]=V[1],F[2]=V[2],F[3]=V[3],F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},Be.fromMat4=function(F,V){var G=i.create();o.getRotation(G,V);var N=new t.ARRAY_TYPE(3);return o.getTranslation(N,V),b(F,G,N),F},Be.copy=W,Be.identity=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},Be.set=function(F,V,G,N,X,M,S,f,T){return F[0]=V,F[1]=G,F[2]=N,F[3]=X,F[4]=M,F[5]=S,F[6]=f,F[7]=T,F},Be.getDual=function(F,V){return F[0]=V[4],F[1]=V[5],F[2]=V[6],F[3]=V[7],F},Be.setDual=function(F,V){return F[4]=V[0],F[5]=V[1],F[6]=V[2],F[7]=V[3],F},Be.getTranslation=function(F,V){var G=V[4],N=V[5],X=V[6],M=V[7],S=-V[0],f=-V[1],T=-V[2],v=V[3];return F[0]=2*(G*v+M*S+N*T-X*f),F[1]=2*(N*v+M*f+X*S-G*T),F[2]=2*(X*v+M*T+G*f-N*S),F},Be.translate=function(F,V,G){var N=V[0],X=V[1],M=V[2],S=V[3],f=.5*G[0],T=.5*G[1],v=.5*G[2],L=V[4],D=V[5],q=V[6],tt=V[7];return F[0]=N,F[1]=X,F[2]=M,F[3]=S,F[4]=S*f+X*v-M*T+L,F[5]=S*T+M*f-N*v+D,F[6]=S*v+N*T-X*f+q,F[7]=-N*f-X*T-M*v+tt,F},Be.rotateX=function(F,V,G){var N=-V[0],X=-V[1],M=-V[2],S=V[3],f=V[4],T=V[5],v=V[6],L=V[7],D=f*S+L*N+T*M-v*X,q=T*S+L*X+v*N-f*M,tt=v*S+L*M+f*X-T*N,P=L*S-f*N-T*X-v*M;return i.rotateX(F,V,G),F[4]=D*(S=F[3])+P*(N=F[0])+q*(M=F[2])-tt*(X=F[1]),F[5]=q*S+P*X+tt*N-D*M,F[6]=tt*S+P*M+D*X-q*N,F[7]=P*S-D*N-q*X-tt*M,F},Be.rotateY=function(F,V,G){var N=-V[0],X=-V[1],M=-V[2],S=V[3],f=V[4],T=V[5],v=V[6],L=V[7],D=f*S+L*N+T*M-v*X,q=T*S+L*X+v*N-f*M,tt=v*S+L*M+f*X-T*N,P=L*S-f*N-T*X-v*M;return i.rotateY(F,V,G),F[4]=D*(S=F[3])+P*(N=F[0])+q*(M=F[2])-tt*(X=F[1]),F[5]=q*S+P*X+tt*N-D*M,F[6]=tt*S+P*M+D*X-q*N,F[7]=P*S-D*N-q*X-tt*M,F},Be.rotateZ=function(F,V,G){var N=-V[0],X=-V[1],M=-V[2],S=V[3],f=V[4],T=V[5],v=V[6],L=V[7],D=f*S+L*N+T*M-v*X,q=T*S+L*X+v*N-f*M,tt=v*S+L*M+f*X-T*N,P=L*S-f*N-T*X-v*M;return i.rotateZ(F,V,G),F[4]=D*(S=F[3])+P*(N=F[0])+q*(M=F[2])-tt*(X=F[1]),F[5]=q*S+P*X+tt*N-D*M,F[6]=tt*S+P*M+D*X-q*N,F[7]=P*S-D*N-q*X-tt*M,F},Be.rotateByQuatAppend=function(F,V,G){var N=G[0],X=G[1],M=G[2],S=G[3],f=V[0],T=V[1],v=V[2],L=V[3];return F[0]=f*S+L*N+T*M-v*X,F[1]=T*S+L*X+v*N-f*M,F[2]=v*S+L*M+f*X-T*N,F[3]=L*S-f*N-T*X-v*M,F[4]=(f=V[4])*S+(L=V[7])*N+(T=V[5])*M-(v=V[6])*X,F[5]=T*S+L*X+v*N-f*M,F[6]=v*S+L*M+f*X-T*N,F[7]=L*S-f*N-T*X-v*M,F},Be.rotateByQuatPrepend=function(F,V,G){var N=V[0],X=V[1],M=V[2],S=V[3],f=G[0],T=G[1],v=G[2],L=G[3];return F[0]=N*L+S*f+X*v-M*T,F[1]=X*L+S*T+M*f-N*v,F[2]=M*L+S*v+N*T-X*f,F[3]=S*L-N*f-X*T-M*v,F[4]=N*(L=G[7])+S*(f=G[4])+X*(v=G[6])-M*(T=G[5]),F[5]=X*L+S*T+M*f-N*v,F[6]=M*L+S*v+N*T-X*f,F[7]=S*L-N*f-X*T-M*v,F},Be.rotateAroundAxis=function(F,V,G,N){if(Math.abs(N)<t.EPSILON)return W(F,V);var X=Math.hypot(G[0],G[1],G[2]);N*=.5;var M=Math.sin(N),S=M*G[0]/X,f=M*G[1]/X,T=M*G[2]/X,v=Math.cos(N),L=V[0],D=V[1],q=V[2],tt=V[3];F[0]=L*v+tt*S+D*T-q*f,F[1]=D*v+tt*f+q*S-L*T,F[2]=q*v+tt*T+L*f-D*S,F[3]=tt*v-L*S-D*f-q*T;var P=V[4],st=V[5],it=V[6],dt=V[7];return F[4]=P*v+dt*S+st*T-it*f,F[5]=st*v+dt*f+it*S-P*T,F[6]=it*v+dt*T+P*f-st*S,F[7]=dt*v-P*S-st*f-it*T,F},Be.add=function(F,V,G){return F[0]=V[0]+G[0],F[1]=V[1]+G[1],F[2]=V[2]+G[2],F[3]=V[3]+G[3],F[4]=V[4]+G[4],F[5]=V[5]+G[5],F[6]=V[6]+G[6],F[7]=V[7]+G[7],F},Be.multiply=R,Be.scale=function(F,V,G){return F[0]=V[0]*G,F[1]=V[1]*G,F[2]=V[2]*G,F[3]=V[3]*G,F[4]=V[4]*G,F[5]=V[5]*G,F[6]=V[6]*G,F[7]=V[7]*G,F},Be.lerp=function(F,V,G,N){var X=1-N;return I(V,G)<0&&(N=-N),F[0]=V[0]*X+G[0]*N,F[1]=V[1]*X+G[1]*N,F[2]=V[2]*X+G[2]*N,F[3]=V[3]*X+G[3]*N,F[4]=V[4]*X+G[4]*N,F[5]=V[5]*X+G[5]*N,F[6]=V[6]*X+G[6]*N,F[7]=V[7]*X+G[7]*N,F},Be.invert=function(F,V){var G=Z(V);return F[0]=-V[0]/G,F[1]=-V[1]/G,F[2]=-V[2]/G,F[3]=V[3]/G,F[4]=-V[4]/G,F[5]=-V[5]/G,F[6]=-V[6]/G,F[7]=V[7]/G,F},Be.conjugate=function(F,V){return F[0]=-V[0],F[1]=-V[1],F[2]=-V[2],F[3]=V[3],F[4]=-V[4],F[5]=-V[5],F[6]=-V[6],F[7]=V[7],F},Be.normalize=function(F,V){var G=Z(V);if(G>0){G=Math.sqrt(G);var N=V[0]/G,X=V[1]/G,M=V[2]/G,S=V[3]/G,f=V[4],T=V[5],v=V[6],L=V[7],D=N*f+X*T+M*v+S*L;F[0]=N,F[1]=X,F[2]=M,F[3]=S,F[4]=(f-N*D)/G,F[5]=(T-X*D)/G,F[6]=(v-M*D)/G,F[7]=(L-S*D)/G}return F},Be.str=function(F){return"quat2("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+")"},Be.exactEquals=function(F,V){return F[0]===V[0]&&F[1]===V[1]&&F[2]===V[2]&&F[3]===V[3]&&F[4]===V[4]&&F[5]===V[5]&&F[6]===V[6]&&F[7]===V[7]},Be.equals=function(F,V){var G=F[0],N=F[1],X=F[2],M=F[3],S=F[4],f=F[5],T=F[6],v=F[7],L=V[0],D=V[1],q=V[2],tt=V[3],P=V[4],st=V[5],it=V[6],dt=V[7];return Math.abs(G-L)<=t.EPSILON*Math.max(1,Math.abs(G),Math.abs(L))&&Math.abs(N-D)<=t.EPSILON*Math.max(1,Math.abs(N),Math.abs(D))&&Math.abs(X-q)<=t.EPSILON*Math.max(1,Math.abs(X),Math.abs(q))&&Math.abs(M-tt)<=t.EPSILON*Math.max(1,Math.abs(M),Math.abs(tt))&&Math.abs(S-P)<=t.EPSILON*Math.max(1,Math.abs(S),Math.abs(P))&&Math.abs(f-st)<=t.EPSILON*Math.max(1,Math.abs(f),Math.abs(st))&&Math.abs(T-it)<=t.EPSILON*Math.max(1,Math.abs(T),Math.abs(it))&&Math.abs(v-dt)<=t.EPSILON*Math.max(1,Math.abs(v),Math.abs(dt))},Be.sqrLen=Be.squaredLength=Be.len=Be.length=Be.dot=Be.mul=Be.setReal=Be.getReal=void 0;var t=s(Kt()),i=s(ya()),o=s(_e());function c(F){if(typeof WeakMap!="function")return null;var V=new WeakMap,G=new WeakMap;return(c=function(N){return N?G:V})(F)}function s(F,V){if(F&&F.__esModule)return F;if(F===null||n(F)!=="object"&&typeof F!="function")return{default:F};var G=c(V);if(G&&G.has(F))return G.get(F);var N={},X=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var M in F)if(M!=="default"&&Object.prototype.hasOwnProperty.call(F,M)){var S=X?Object.getOwnPropertyDescriptor(F,M):null;S&&(S.get||S.set)?Object.defineProperty(N,M,S):N[M]=F[M]}return N.default=F,G&&G.set(F,N),N}function b(F,V,G){var N=.5*G[0],X=.5*G[1],M=.5*G[2],S=V[0],f=V[1],T=V[2],v=V[3];return F[0]=S,F[1]=f,F[2]=T,F[3]=v,F[4]=N*v+X*T-M*f,F[5]=X*v+M*S-N*T,F[6]=M*v+N*f-X*S,F[7]=-N*S-X*f-M*T,F}function W(F,V){return F[0]=V[0],F[1]=V[1],F[2]=V[2],F[3]=V[3],F[4]=V[4],F[5]=V[5],F[6]=V[6],F[7]=V[7],F}function R(F,V,G){var N=V[0],X=V[1],M=V[2],S=V[3],f=G[4],T=G[5],v=G[6],L=G[7],D=V[4],q=V[5],tt=V[6],P=V[7],st=G[0],it=G[1],dt=G[2],Zt=G[3];return F[0]=N*Zt+S*st+X*dt-M*it,F[1]=X*Zt+S*it+M*st-N*dt,F[2]=M*Zt+S*dt+N*it-X*st,F[3]=S*Zt-N*st-X*it-M*dt,F[4]=N*L+S*f+X*v-M*T+D*Zt+P*st+q*dt-tt*it,F[5]=X*L+S*T+M*f-N*v+q*Zt+P*it+tt*st-D*dt,F[6]=M*L+S*v+N*T-X*f+tt*Zt+P*dt+D*it-q*st,F[7]=S*L-N*f-X*T-M*v+P*Zt-D*st-q*it-tt*dt,F}Be.getReal=i.copy,Be.setReal=i.copy,Be.mul=R;var I=i.dot;Be.dot=I;var h=i.length;Be.length=h,Be.len=h;var Z=i.squaredLength;return Be.squaredLength=Z,Be.sqrLen=Z,Be}var bn,fn,Qe={};function vn(){if(bn)return Qe;function n(V){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(G){return typeof G}:function(G){return G&&typeof Symbol=="function"&&G.constructor===Symbol&&G!==Symbol.prototype?"symbol":typeof G},n(V)}bn=1,Object.defineProperty(Qe,"__esModule",{value:!0}),Qe.create=o,Qe.clone=function(V){var G=new t.ARRAY_TYPE(2);return G[0]=V[0],G[1]=V[1],G},Qe.fromValues=function(V,G){var N=new t.ARRAY_TYPE(2);return N[0]=V,N[1]=G,N},Qe.copy=function(V,G){return V[0]=G[0],V[1]=G[1],V},Qe.set=function(V,G,N){return V[0]=G,V[1]=N,V},Qe.add=function(V,G,N){return V[0]=G[0]+N[0],V[1]=G[1]+N[1],V},Qe.subtract=c,Qe.multiply=s,Qe.divide=b,Qe.ceil=function(V,G){return V[0]=Math.ceil(G[0]),V[1]=Math.ceil(G[1]),V},Qe.floor=function(V,G){return V[0]=Math.floor(G[0]),V[1]=Math.floor(G[1]),V},Qe.min=function(V,G,N){return V[0]=Math.min(G[0],N[0]),V[1]=Math.min(G[1],N[1]),V},Qe.max=function(V,G,N){return V[0]=Math.max(G[0],N[0]),V[1]=Math.max(G[1],N[1]),V},Qe.round=function(V,G){return V[0]=Math.round(G[0]),V[1]=Math.round(G[1]),V},Qe.scale=function(V,G,N){return V[0]=G[0]*N,V[1]=G[1]*N,V},Qe.scaleAndAdd=function(V,G,N,X){return V[0]=G[0]+N[0]*X,V[1]=G[1]+N[1]*X,V},Qe.distance=W,Qe.squaredDistance=R,Qe.length=I,Qe.squaredLength=h,Qe.negate=function(V,G){return V[0]=-G[0],V[1]=-G[1],V},Qe.inverse=function(V,G){return V[0]=1/G[0],V[1]=1/G[1],V},Qe.normalize=function(V,G){var N=G[0],X=G[1],M=N*N+X*X;return M>0&&(M=1/Math.sqrt(M)),V[0]=G[0]*M,V[1]=G[1]*M,V},Qe.dot=function(V,G){return V[0]*G[0]+V[1]*G[1]},Qe.cross=function(V,G,N){var X=G[0]*N[1]-G[1]*N[0];return V[0]=V[1]=0,V[2]=X,V},Qe.lerp=function(V,G,N,X){var M=G[0],S=G[1];return V[0]=M+X*(N[0]-M),V[1]=S+X*(N[1]-S),V},Qe.random=function(V,G){G=G||1;var N=2*t.RANDOM()*Math.PI;return V[0]=Math.cos(N)*G,V[1]=Math.sin(N)*G,V},Qe.transformMat2=function(V,G,N){var X=G[0],M=G[1];return V[0]=N[0]*X+N[2]*M,V[1]=N[1]*X+N[3]*M,V},Qe.transformMat2d=function(V,G,N){var X=G[0],M=G[1];return V[0]=N[0]*X+N[2]*M+N[4],V[1]=N[1]*X+N[3]*M+N[5],V},Qe.transformMat3=function(V,G,N){var X=G[0],M=G[1];return V[0]=N[0]*X+N[3]*M+N[6],V[1]=N[1]*X+N[4]*M+N[7],V},Qe.transformMat4=function(V,G,N){var X=G[0],M=G[1];return V[0]=N[0]*X+N[4]*M+N[12],V[1]=N[1]*X+N[5]*M+N[13],V},Qe.rotate=function(V,G,N,X){var M=G[0]-N[0],S=G[1]-N[1],f=Math.sin(X),T=Math.cos(X);return V[0]=M*T-S*f+N[0],V[1]=M*f+S*T+N[1],V},Qe.angle=function(V,G){var N=V[0],X=V[1],M=G[0],S=G[1],f=Math.sqrt(N*N+X*X)*Math.sqrt(M*M+S*S);return Math.acos(Math.min(Math.max(f&&(N*M+X*S)/f,-1),1))},Qe.zero=function(V){return V[0]=0,V[1]=0,V},Qe.str=function(V){return"vec2("+V[0]+", "+V[1]+")"},Qe.exactEquals=function(V,G){return V[0]===G[0]&&V[1]===G[1]},Qe.equals=function(V,G){var N=V[0],X=V[1],M=G[0],S=G[1];return Math.abs(N-M)<=t.EPSILON*Math.max(1,Math.abs(N),Math.abs(M))&&Math.abs(X-S)<=t.EPSILON*Math.max(1,Math.abs(X),Math.abs(S))},Qe.forEach=Qe.sqrLen=Qe.sqrDist=Qe.dist=Qe.div=Qe.mul=Qe.sub=Qe.len=void 0;var t=function(V,G){if(V&&V.__esModule)return V;if(V===null||n(V)!=="object"&&typeof V!="function")return{default:V};var N=i(void 0);if(N&&N.has(V))return N.get(V);var X={},M=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var S in V)if(S!=="default"&&Object.prototype.hasOwnProperty.call(V,S)){var f=M?Object.getOwnPropertyDescriptor(V,S):null;f&&(f.get||f.set)?Object.defineProperty(X,S,f):X[S]=V[S]}return X.default=V,N&&N.set(V,X),X}(Kt());function i(V){if(typeof WeakMap!="function")return null;var G=new WeakMap,N=new WeakMap;return(i=function(X){return X?N:G})(V)}function o(){var V=new t.ARRAY_TYPE(2);return t.ARRAY_TYPE!=Float32Array&&(V[0]=0,V[1]=0),V}function c(V,G,N){return V[0]=G[0]-N[0],V[1]=G[1]-N[1],V}function s(V,G,N){return V[0]=G[0]*N[0],V[1]=G[1]*N[1],V}function b(V,G,N){return V[0]=G[0]/N[0],V[1]=G[1]/N[1],V}function W(V,G){return Math.hypot(G[0]-V[0],G[1]-V[1])}function R(V,G){var N=G[0]-V[0],X=G[1]-V[1];return N*N+X*X}function I(V){return Math.hypot(V[0],V[1])}function h(V){var G=V[0],N=V[1];return G*G+N*N}Qe.len=I,Qe.sub=c,Qe.mul=s,Qe.div=b,Qe.dist=W,Qe.sqrDist=R,Qe.sqrLen=h;var Z,F=(Z=o(),function(V,G,N,X,M,S){var f,T;for(G||(G=2),N||(N=0),T=X?Math.min(X*G+N,V.length):V.length,f=N;f<T;f+=G)Z[0]=V[f],Z[1]=V[f+1],M(Z,Z,S),V[f]=Z[0],V[f+1]=Z[1];return V});return Qe.forEach=F,Qe}function Qa(){if(fn)return Gt;function n(V){return n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(G){return typeof G}:function(G){return G&&typeof Symbol=="function"&&G.constructor===Symbol&&G!==Symbol.prototype?"symbol":typeof G},n(V)}fn=1,Object.defineProperty(Gt,"__esModule",{value:!0}),Gt.vec4=Gt.vec3=Gt.vec2=Gt.quat2=Gt.quat=Gt.mat4=Gt.mat3=Gt.mat2d=Gt.mat2=Gt.glMatrix=void 0;var t=F(Kt());Gt.glMatrix=t;var i=F(le());Gt.mat2=i;var o=F(ii());Gt.mat2d=o;var c=F(vi());Gt.mat3=c;var s=F(_e());Gt.mat4=s;var b=F(ya());Gt.quat=b;var W=F(Yn());Gt.quat2=W;var R=F(vn());Gt.vec2=R;var I=F(wi());Gt.vec3=I;var h=F(aa());function Z(V){if(typeof WeakMap!="function")return null;var G=new WeakMap,N=new WeakMap;return(Z=function(X){return X?N:G})(V)}function F(V,G){if(V&&V.__esModule)return V;if(V===null||n(V)!=="object"&&typeof V!="function")return{default:V};var N=Z(G);if(N&&N.has(V))return N.get(V);var X={},M=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var S in V)if(S!=="default"&&Object.prototype.hasOwnProperty.call(V,S)){var f=M?Object.getOwnPropertyDescriptor(V,S):null;f&&(f.get||f.set)?Object.defineProperty(X,S,f):X[S]=V[S]}return X.default=V,N&&N.set(V,X),X}return Gt.vec4=h,Gt}var Ga,ja,En,Jn,ut=Qa(),mn=function(){if(ja)return Ga;function n(t,i,o,c){this.cx=3*t,this.bx=3*(o-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(c-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=i,this.p2x=o,this.p2y=c}return ja=1,Ga=n,n.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,i){if(i===void 0&&(i=1e-6),t<0)return 0;if(t>1)return 1;for(var o=t,c=0;c<8;c++){var s=this.sampleCurveX(o)-t;if(Math.abs(s)<i)return o;var b=this.sampleCurveDerivativeX(o);if(Math.abs(b)<1e-6)break;o-=s/b}var W=0,R=1;for(o=t,c=0;c<20&&(s=this.sampleCurveX(o),!(Math.abs(s-t)<i));c++)t>s?W=o:R=o,o=.5*(R-W)+W;return o},solve:function(t,i){return this.sampleCurveY(this.solveCurveX(t,i))}},Ga}(),el=lt(mn);function Il(){if(Jn)return En;function n(t,i){this.x=t,this.y=i}return Jn=1,En=n,n.prototype={clone:function(){return new n(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,i){return this.clone()._rotateAround(t,i)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var i=t.x-this.x,o=t.y-this.y;return i*i+o*o},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,i){return Math.atan2(this.x*i-this.y*t,this.x*t+this.y*i)},_matMult:function(t){var i=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=i,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var i=Math.cos(t),o=Math.sin(t),c=o*this.x+i*this.y;return this.x=i*this.x-o*this.y,this.y=c,this},_rotateAround:function(t,i){var o=Math.cos(t),c=Math.sin(t),s=i.y+c*(this.x-i.x)+o*(this.y-i.y);return this.x=i.x+o*(this.x-i.x)-c*(this.y-i.y),this.y=s,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},n.convert=function(t){return t instanceof n?t:Array.isArray(t)?new n(t[0],t[1]):t},En}var ee=lt(Il());function il(n,t){if(Array.isArray(n)){if(!Array.isArray(t)||n.length!==t.length)return!1;for(let i=0;i<n.length;i++)if(!il(n[i],t[i]))return!1;return!0}if(typeof n=="object"&&n!==null&&t!==null){if(typeof t!="object"||Object.keys(n).length!==Object.keys(t).length)return!1;for(let i in n)if(!il(n[i],t[i]))return!1;return!0}return n===t}let Za=Math.PI/180,Ln=180/Math.PI;function ti(n){return n*Za}function sa(n){return n*Ln}let hn=[[0,0],[1,0],[1,1],[0,1]];function Ul(n){if(n<=0)return 0;if(n>=1)return 1;let t=n*n,i=t*n;return 4*(n<.5?i:3*(n-t)+i-.75)}function fa(n,t,i,o){let c=new el(n,t,i,o);return function(s){return c.solve(s)}}let zn=fa(.25,.1,.25,1);function ze(n,t,i){return Math.min(i,Math.max(t,n))}function xl(n,t,i){return(i=ze((i-n)/(t-n),0,1))*i*(3-2*i)}function pn(n,t,i){let o=i-t,c=((n-t)%o+o)%o+t;return c===t?i:c}function al(n,t,i){if(!n.length)return i(null,[]);let o=n.length,c=new Array(n.length),s=null;n.forEach((b,W)=>{t(b,(R,I)=>{R&&(s=R),c[W]=I,--o==0&&i(s,c)})})}function Fa(n,...t){for(let i of t)for(let o in i)n[o]=i[o];return n}let va=1;function Al(){return va++}function As(n){return n<=1?1:Math.pow(2,Math.ceil(Math.log(n)/Math.LN2))}function ko(n,t){n.forEach(i=>{t[i]&&(t[i]=t[i].bind(t))})}function Nl(n,t){return n.indexOf(t,n.length-t.length)!==-1}function co(n,t,i){let o={};for(let c in n)o[c]=t.call(this,n[c],c,n);return o}function So(n,t,i){let o={};for(let c in n)t.call(this,n[c],c,n)&&(o[c]=n[c]);return o}function Xn(n){return Array.isArray(n)?n.map(Xn):typeof n=="object"&&n?co(n,Xn):n}let Hs={};function mi(n){Hs[n]||(typeof console<"u"&&console.warn(n),Hs[n]=!0)}function nl(n,t,i){return(i.y-n.y)*(t.x-n.x)>(t.y-n.y)*(i.x-n.x)}function $r(n){let t=0;for(let i,o,c=0,s=n.length,b=s-1;c<s;b=c++)i=n[c],o=n[b],t+=(o.x-i.x)*(i.y+o.y);return t}function Wn([n,t,i]){let o=ti(t+90),c=ti(i);return{x:n*Math.cos(o)*Math.sin(c),y:n*Math.sin(o)*Math.sin(c),z:n*Math.cos(c),azimuthal:t,polar:i}}function bo(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function js(n){let t={};if(n.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,o,c,s)=>{let b=c||s;return t[o]=!b||b.toLowerCase(),""}),t["max-age"]){let i=parseInt(t["max-age"],10);isNaN(i)?delete t["max-age"]:t["max-age"]=i}return t}let Qo,Os=null;function mo(n,t){return[n[4*t],n[4*t+1],n[4*t+2],n[4*t+3]]}function Tt(n,t,i,o){for(;t<i;){let c=t+i>>1;n[c]<o?t=c+1:i=c}return t}function j(n,t,i,o){for(;t<i;){let c=t+i>>1;n[c]<=o?t=c+1:i=c}return t}function _(n){return n>0?1/(1.001-n):1+n}function ot(n){return n>0?1-1/(1.001-n):-n}let pt={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(Qo==null){let n=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{Qo=process.env.API_URL_REGEX!=null?new RegExp(process.env.API_URL_REGEX):n}catch{Qo=n}}return Qo},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!pt.API_URL)return null;try{let n=new URL(pt.API_URL);return n.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":n.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function mt(n){return pt.API_URL_REGEX.test(n)}function Ut(n){return pt.API_SPRITE_REGEX.test(n)}let Bt,Jt,Mt,Et,Qt,Dt;function de(){return Bt==null&&(Bt=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Bt}let ce={now:()=>Et!==void 0?Et:performance.now(),setNow(n){Et=n},restoreNow(){Et=void 0},frame(n){let t=requestAnimationFrame(n);return{cancel:()=>cancelAnimationFrame(t)}},getImageData(n,t=0){let{width:i,height:o}=n;Qt||(Qt=document.createElement("canvas"));let c=Qt.getContext("2d",{willReadFrequently:!0});if(!c)throw new Error("failed to create canvas 2d context");return(i>Qt.width||o>Qt.height)&&(Qt.width=i,Qt.height=o),c.clearRect(-t,-t,i+2*t,o+2*t),c.drawImage(n,0,0,i,o),c.getImageData(-t,-t,i+2*t,o+2*t)},resolveURL:n=>(Jt||(Jt=document.createElement("a")),Jt.href=n,Jt.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Mt==null&&(Mt=window.matchMedia("(prefers-reduced-motion: reduce)")),Mt.matches)},hasCanvasFingerprintNoise(){if(Dt!==void 0)return Dt;if(!de())return Dt=!1,!1;let n=new OffscreenCanvas(85,1),t=n.getContext("2d",{willReadFrequently:!0}),i=0;for(let c=0;c<n.width;++c)t.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,t.fillRect(c,0,1,1);let o=t.getImageData(0,0,n.width,n.height);i=0;for(let c=0;c<o.data.length;++c)if(c%4!=3&&i++!==o.data[c])return Dt=!0,!0;return Dt=!1,!1}};function ke(n,t){let i=n.indexOf("?");if(i<0)return`${n}?${new URLSearchParams(t).toString()}`;let o=new URLSearchParams(n.slice(i));for(let c in t)o.set(c,t[c]);return`${n.slice(0,i)}?${o.toString()}`}function fe(n,t={persistentParams:[]}){let i=n.indexOf("?");if(i<0)return n;let o=new URLSearchParams,c=new URLSearchParams(n.slice(i));for(let b of t.persistentParams){let W=c.get(b);W&&o.set(b,W)}let s=o.toString();return`${n.slice(0,i)}${s.length>0?`?${s}`:""}`}let Ee="mapbox-tiles",ve=500,Vi=50,xi=["language","worldview","jobid"],Oe,Ii;function zi(){try{return caches}catch{}}function ra(){let n=zi();n&&Oe==null&&(Oe=n.open(Ee))}let ba=1/0,Ya={supported:!1,testSupport:function(n){!td&&Yl&&(Ds?ed(n):wn=n)}},wn,Yl,td=!1,Ds=!1,fo=typeof self<"u"?self:{};function ed(n){let t=n.createTexture();n.bindTexture(n.TEXTURE_2D,t);try{if(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,Yl),n.isContextLost())return;Ya.supported=!0}catch{}n.deleteTexture(t),td=!0}fo.document&&(Yl=fo.document.createElement("img"),Yl.onload=function(){wn&&ed(wn),wn=null,Ds=!0},Yl.onerror=function(){td=!0,wn=null},Yl.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");let vo={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(vo);class Cc extends Error{constructor(t,i,o){i===401&&mt(o)&&(t+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(t),this.status=i,this.url=o}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}let kc=bo()?()=>self.worker&&self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,_s=function(n,t){if(!(/^file:/.test(i=n.url)||/^file:/.test(kc())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(o,c){let s=new AbortController,b=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,referrer:kc(),referrerPolicy:o.referrerPolicy,signal:s.signal}),W=!1,R=!1,I=(h=b.url).indexOf("sku=")>0&&mt(h);var h;o.type==="json"&&b.headers.set("Accept","application/json");let Z=(V,G,N)=>{if(R)return;if(V&&V.message!=="SecurityError"&&mi(V.toString()),G&&N)return F(G);let X=Date.now();fetch(b).then(M=>{if(M.ok){let S=I?M.clone():null;return F(M,S,X)}return c(new Cc(M.statusText,M.status,o.url))}).catch(M=>{M.name!=="AbortError"&&c(new Error(`${M.message} ${o.url}`))})},F=(V,G,N)=>{(o.type==="arrayBuffer"?V.arrayBuffer():o.type==="json"?V.json():V.text()).then(X=>{R||(G&&N&&function(M,S,f){if(ra(),Oe==null)return;let T=js(S.headers.get("Cache-Control")||"");if(T["no-store"])return;let v={status:S.status,statusText:S.statusText,headers:new Headers};S.headers.forEach((q,tt)=>v.headers.set(tt,q)),T["max-age"]&&v.headers.set("Expires",new Date(f+1e3*T["max-age"]).toUTCString());let L=v.headers.get("Expires");if(!L||new Date(L).getTime()-f<42e4)return;let D=fe(M.url,{persistentParams:xi});if(S.status===206){let q=M.headers.get("Range");if(!q)return;v.status=200,D=ke(D,{range:q})}(function(q,tt){if(Ii===void 0)try{new Response(new ReadableStream),Ii=!0}catch{Ii=!1}Ii?tt(q.body):q.blob().then(tt)})(S,q=>{let tt=new Response((P=S.status)!==200&&P!==404&&[101,103,204,205,304].includes(P)?null:q,v);var P;ra(),Oe?.then(st=>st.put(D,tt)).catch(st=>mi(st.message))})}(b,G,N),W=!0,c(null,X,V.headers.get("Cache-Control"),V.headers.get("Expires")))}).catch(X=>{R||c(new Error(X.message))})};return I?function(V,G){if(ra(),Oe==null)return G(null);Oe.then(N=>{let X=fe(V.url,{persistentParams:xi}),M=V.headers.get("Range");M&&(X=ke(X,{range:M})),N.match(X).then(S=>{let f=function(T){if(!T)return!1;let v=new Date(T.headers.get("Expires")||0),L=js(T.headers.get("Cache-Control")||"");return v>Date.now()&&!L["no-cache"]}(S);N.delete(X),f&&N.put(X,S.clone()),G(null,S,f)}).catch(G)}).catch(G)}(b,Z):Z(null,null),{cancel:()=>{R=!0,W||s.abort()}}}(n,t);if(bo()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",n,t,void 0,!0)}var i;return function(o,c){let s=new XMLHttpRequest;s.open(o.method||"GET",o.url,!0),o.type==="arrayBuffer"&&(s.responseType="arraybuffer");for(let b in o.headers)s.setRequestHeader(b,o.headers[b]);return o.type==="json"&&(s.responseType="text",s.setRequestHeader("Accept","application/json")),s.withCredentials=o.credentials==="include",s.onerror=()=>{c(new Error(s.statusText))},s.onload=()=>{if((s.status>=200&&s.status<300||s.status===0)&&s.response!==null){let b=s.response;if(o.type==="json")try{b=JSON.parse(s.response)}catch(W){return c(W)}c(null,b,s.getResponseHeader("Cache-Control"),s.getResponseHeader("Expires"))}else c(new Cc(s.statusText,s.status,o.url))},s.send(o.body),{cancel:()=>s.abort()}}(n,t)},Eo=function(n,t){return _s(Fa(n,{type:"arrayBuffer"}),t)};function yn(n){let t=document.createElement("a");return t.href=n,t.protocol===location.protocol&&t.host===location.host}let An="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",Hn,en;Hn=[],en=0;let ll=function(n,t){if(Ya.supported&&(n.headers||(n.headers={}),n.headers.accept="image/webp,*/*"),en>=pt.MAX_PARALLEL_IMAGE_REQUESTS){let s={requestParameters:n,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return Hn.push(s),s}en++;let i=!1,o=()=>{if(!i)for(i=!0,en--;Hn.length&&en<pt.MAX_PARALLEL_IMAGE_REQUESTS;){let s=Hn.shift(),{requestParameters:b,callback:W,cancelled:R}=s;R||(s.cancel=ll(b,W).cancel)}},c=Eo(n,(s,b,W,R)=>{o(),s?t(s):b&&(self.createImageBitmap?function(I,h){let Z=new Blob([new Uint8Array(I)],{type:"image/png"});createImageBitmap(Z).then(F=>{h(null,F)}).catch(F=>{h(new Error(`Could not load image because of ${F.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(b,(I,h)=>t(I,h,W,R)):function(I,h){let Z=new Image;Z.onload=()=>{h(null,Z),URL.revokeObjectURL(Z.src),Z.onload=null,requestAnimationFrame(()=>{Z.src=An})},Z.onerror=()=>h(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let F=new Blob([new Uint8Array(I)],{type:"image/png"});Z.src=I.byteLength?URL.createObjectURL(F):An}(b,(I,h)=>t(I,h,W,R)))});return{cancel:()=>{c.cancel(),o()}}};var Ps,Sc,Qc,ol={exports:{}},id={exports:{}},Em={exports:{}},Wp=function(){if(Qc)return ol.exports;Qc=1;var n=(Ps||(Ps=1,id.exports=function(i,o){var c,s,b,W,R,I,h,Z;for(s=i.length-(c=3&i.length),b=o,R=3432918353,I=461845907,Z=0;Z<s;)h=255&i.charCodeAt(Z)|(255&i.charCodeAt(++Z))<<8|(255&i.charCodeAt(++Z))<<16|(255&i.charCodeAt(++Z))<<24,++Z,b=27492+(65535&(W=5*(65535&(b=(b^=h=(65535&(h=(h=(65535&h)*R+(((h>>>16)*R&65535)<<16)&4294967295)<<15|h>>>17))*I+(((h>>>16)*I&65535)<<16)&4294967295)<<13|b>>>19))+((5*(b>>>16)&65535)<<16)&4294967295))+((58964+(W>>>16)&65535)<<16);switch(h=0,c){case 3:h^=(255&i.charCodeAt(Z+2))<<16;case 2:h^=(255&i.charCodeAt(Z+1))<<8;case 1:b^=h=(65535&(h=(h=(65535&(h^=255&i.charCodeAt(Z)))*R+(((h>>>16)*R&65535)<<16)&4294967295)<<15|h>>>17))*I+(((h>>>16)*I&65535)<<16)&4294967295}return b^=i.length,b=2246822507*(65535&(b^=b>>>16))+((2246822507*(b>>>16)&65535)<<16)&4294967295,b=3266489909*(65535&(b^=b>>>13))+((3266489909*(b>>>16)&65535)<<16)&4294967295,(b^=b>>>16)>>>0}),id.exports),t=(Sc||(Sc=1,Em.exports=function(i,o){for(var c,s=i.length,b=o^s,W=0;s>=4;)c=1540483477*(65535&(c=255&i.charCodeAt(W)|(255&i.charCodeAt(++W))<<8|(255&i.charCodeAt(++W))<<16|(255&i.charCodeAt(++W))<<24))+((1540483477*(c>>>16)&65535)<<16),b=1540483477*(65535&b)+((1540483477*(b>>>16)&65535)<<16)^(c=1540483477*(65535&(c^=c>>>24))+((1540483477*(c>>>16)&65535)<<16)),s-=4,++W;switch(s){case 3:b^=(255&i.charCodeAt(W+2))<<16;case 2:b^=(255&i.charCodeAt(W+1))<<8;case 1:b=1540483477*(65535&(b^=255&i.charCodeAt(W)))+((1540483477*(b>>>16)&65535)<<16)}return b=1540483477*(65535&(b^=b>>>13))+((1540483477*(b>>>16)&65535)<<16),(b^=b>>>15)>>>0}),Em.exports);return ol.exports=n,ol.exports.murmur3=n,ol.exports.murmur2=t,ol.exports}(),an=lt(Wp);class Hl{constructor(t,...i){Fa(this,i[0]||{}),this.type=t}}class Ks extends Hl{constructor(t,i={}){super("error",Fa({error:t},i))}}function Lo(n,t,i){i[n]&&i[n].indexOf(t)!==-1||(i[n]=i[n]||[],i[n].push(t))}function fc(n,t,i){if(i&&i[n]){let o=i[n].indexOf(t);o!==-1&&i[n].splice(o,1)}}class zo{on(t,i){return this._listeners=this._listeners||{},Lo(t,i,this._listeners),this}off(t,i){return fc(t,i,this._listeners),fc(t,i,this._oneTimeListeners),this}once(t,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},Lo(t,i,this._oneTimeListeners),this):new Promise(o=>this.once(t,o))}fire(t,i){let o=typeof t=="string"?new Hl(t,i):t,c=o.type;if(this.listens(c)){o.target=this;let s=this._listeners&&this._listeners[c]?this._listeners[c].slice():[];for(let R of s)R.call(this,o);let b=this._oneTimeListeners&&this._oneTimeListeners[c]?this._oneTimeListeners[c].slice():[];for(let R of b)fc(c,R,this._oneTimeListeners),R.call(this,o);let W=this._eventedParent;W&&(Fa(o,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),W.fire(o))}else o instanceof Ks&&console.error(o.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,i){return this._eventedParent=t,this._eventedParentData=i,this}}var vc,hi={},Ec=function(){if(vc)return hi;vc=1;var n={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function t(s){return(s=Math.round(s))<0?0:s>255?255:s}function i(s){return t(s[s.length-1]==="%"?parseFloat(s)/100*255:parseInt(s))}function o(s){return(b=s[s.length-1]==="%"?parseFloat(s)/100:parseFloat(s))<0?0:b>1?1:b;var b}function c(s,b,W){return W<0?W+=1:W>1&&(W-=1),6*W<1?s+(b-s)*W*6:2*W<1?b:3*W<2?s+(b-s)*(2/3-W)*6:s}try{hi.parseCSSColor=function(s){var b,W=s.replace(/ /g,"").toLowerCase();if(W in n)return n[W].slice();if(W[0]==="#")return W.length===4?(b=parseInt(W.substr(1),16))>=0&&b<=4095?[(3840&b)>>4|(3840&b)>>8,240&b|(240&b)>>4,15&b|(15&b)<<4,1]:null:W.length===7&&(b=parseInt(W.substr(1),16))>=0&&b<=16777215?[(16711680&b)>>16,(65280&b)>>8,255&b,1]:null;var R=W.indexOf("("),I=W.indexOf(")");if(R!==-1&&I+1===W.length){var h=W.substr(0,R),Z=W.substr(R+1,I-(R+1)).split(","),F=1;switch(h){case"rgba":if(Z.length!==4)return null;F=o(Z.pop());case"rgb":return Z.length!==3?null:[i(Z[0]),i(Z[1]),i(Z[2]),F];case"hsla":if(Z.length!==4)return null;F=o(Z.pop());case"hsl":if(Z.length!==3)return null;var V=(parseFloat(Z[0])%360+360)%360/360,G=o(Z[1]),N=o(Z[2]),X=N<=.5?N*(G+1):N+G-N*G,M=2*N-X;return[t(255*c(M,X,V+1/3)),t(255*c(M,X,V)),t(255*c(M,X,V-1/3)),F];default:return null}}return null}}catch{}return hi}();class Ri{constructor(t,i,o,c=1){this.r=t,this.g=i,this.b=o,this.a=c}static parse(t){if(!t)return;if(t instanceof Ri)return t;if(typeof t!="string")return;let i=Ec.parseCSSColor(t);return i?new Ri(i[0]/255*i[3],i[1]/255*i[3],i[2]/255*i[3],i[3]):void 0}toString(){let[t,i,o,c]=this.a===0?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(t)},${Math.round(i)},${Math.round(o)},${c})`}toRenderColor(t){let{r:i,g:o,b:c,a:s}=this;return new up(t,i,o,c,s)}}class up{constructor(t,i,o,c,s){if(t){let b=t.image.height,W=b*b;i=s===0?0:i/s*(b-1),o=s===0?0:o/s*(b-1),c=s===0?0:c/s*(b-1);let R=Math.floor(i),I=Math.floor(o),h=Math.floor(c),Z=Math.ceil(i),F=Math.ceil(o),V=Math.ceil(c),G=i-R,N=o-I,X=c-h,M=t.image.data,S=4*(R+I*W+h*b),f=4*(R+I*W+V*b),T=4*(R+F*W+h*b),v=4*(R+F*W+V*b),L=4*(Z+I*W+h*b),D=4*(Z+I*W+V*b),q=4*(Z+F*W+h*b),tt=4*(Z+F*W+V*b);if(S<0||tt>=M.length)throw new Error("out of range");this.r=Je(Je(Je(M[S],M[f],X),Je(M[T],M[v],X),N),Je(Je(M[L],M[D],X),Je(M[q],M[tt],X),N),G)/255*s,this.g=Je(Je(Je(M[S+1],M[f+1],X),Je(M[T+1],M[v+1],X),N),Je(Je(M[L+1],M[D+1],X),Je(M[q+1],M[tt+1],X),N),G)/255*s,this.b=Je(Je(Je(M[S+2],M[f+2],X),Je(M[T+2],M[v+2],X),N),Je(Je(M[L+2],M[D+2],X),Je(M[q+2],M[tt+2],X),N),G)/255*s,this.a=s}else this.r=i,this.g=o,this.b=c,this.a=s}toArray(){let{r:t,g:i,b:o,a:c}=this;return c===0?[0,0,0,0]:[255*t/c,255*i/c,255*o/c,c]}toArray01(){let{r:t,g:i,b:o,a:c}=this;return c===0?[0,0,0,0]:[t/c,i/c,o/c,c]}toArray01Scaled(t){let{r:i,g:o,b:c,a:s}=this;return s===0?[0,0,0]:[i/s*t,o/s*t,c/s*t]}toArray01PremultipliedAlpha(){let{r:t,g:i,b:o,a:c}=this;return[t,i,o,c]}toArray01Linear(){let{r:t,g:i,b:o,a:c}=this;return c===0?[0,0,0,0]:[Math.pow(t/c,2.2),Math.pow(i/c,2.2),Math.pow(o/c,2.2),c]}}function Je(n,t,i){return n*(1-i)+t*i}function qs(n,t,i){return n.map((o,c)=>Je(o,t[c],i))}Ri.black=new Ri(0,0,0,1),Ri.white=new Ri(1,1,1,1),Ri.transparent=new Ri(0,0,0,0),Ri.red=new Ri(1,0,0,1),Ri.blue=new Ri(0,0,1,1);var ho=Object.freeze({__proto__:null,array:qs,color:function(n,t,i){return new Ri(Je(n.r,t.r,i),Je(n.g,t.g,i),Je(n.b,t.b,i),Je(n.a,t.a,i))},number:Je});function wo(n,...t){for(let i of t)for(let o in i)n[o]=i[o];return n}class sl extends Error{constructor(t,i){super(i),this.message=i,this.key=t}}class ad{constructor(t,i=[]){this.parent=t,this.bindings={};for(let[o,c]of i)this.bindings[o]=c}concat(t){return new ad(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}let jn={kind:"null"},pe={kind:"number"},oi={kind:"string"},si={kind:"boolean"},nn={kind:"color"},Ea={kind:"object"},ci={kind:"value"},nd={kind:"collator"},Ao={kind:"formatted"},Ho={kind:"resolvedImage"};function Oa(n,t){return{kind:"array",itemType:n,N:t}}function Ki(n){if(n.kind==="array"){let t=Ki(n.itemType);return typeof n.N=="number"?`array<${t}, ${n.N}>`:n.itemType.kind==="value"?"array":`array<${t}>`}return n.kind}let Lm=[jn,pe,oi,si,nn,Ao,Ea,Oa(ci),Ho];function jo(n,t){if(t.kind==="error")return null;if(n.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!jo(n.itemType,t.itemType))&&(typeof n.N!="number"||n.N===t.N))return null}else{if(n.kind===t.kind)return null;if(n.kind==="value"){for(let i of Lm)if(!jo(i,t))return null}}return`Expected ${Ki(n)} but found ${Ki(t)} instead.`}function Oo(n,t){return t.some(i=>i.kind===n.kind)}function rl(n,t){return t.some(i=>i==="null"?n===null:i==="array"?Array.isArray(n):i==="object"?n&&!Array.isArray(n)&&typeof n=="object":i===typeof n)}class ld{constructor(t,i,o){this.sensitivity=t?i?"variant":"case":i?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,i){return this.collator.compare(t,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class un{constructor(t,i,o,c,s){this.text=t.normalize?t.normalize():t,this.image=i,this.scale=o,this.fontStack=c,this.textColor=s}}class La{constructor(t){this.sections=t}static fromString(t){return new La([new un(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||t.image&&t.image.namePrimary.length!==0)}static factory(t){return t instanceof La?t:La.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}serialize(){let t=["format"];for(let i of this.sections){if(i.image){t.push(["image",i.image.namePrimary]);continue}t.push(i.text);let o={};i.fontStack&&(o["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(o["font-scale"]=i.scale),i.textColor&&(o["text-color"]=["rgba"].concat(i.textColor.toRenderColor(null).toArray())),t.push(o)}return t}}class Da{constructor(t){this.namePrimary=t.namePrimary,t.nameSecondary&&(this.nameSecondary=t.nameSecondary),this.available=t.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(t,i){return t?new Da({namePrimary:t,nameSecondary:i,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function zm(n,t,i,o){return typeof n=="number"&&n>=0&&n<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof i=="number"&&i>=0&&i<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[n,t,i,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[n,t,i,o]:[n,t,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function jl(n){if(n===null||typeof n=="string"||typeof n=="boolean"||typeof n=="number"||n instanceof Ri||n instanceof ld||n instanceof La||n instanceof Da)return!0;if(Array.isArray(n)){for(let t of n)if(!jl(t))return!1;return!0}if(typeof n=="object"){for(let t in n)if(!jl(n[t]))return!1;return!0}return!1}function na(n){if(n===null)return jn;if(typeof n=="string")return oi;if(typeof n=="boolean")return si;if(typeof n=="number")return pe;if(n instanceof Ri)return nn;if(n instanceof ld)return nd;if(n instanceof La)return Ao;if(n instanceof Da)return Ho;if(Array.isArray(n)){let t=n.length,i;for(let o of n){let c=na(o);if(i){if(i===c)continue;i=ci;break}i=c}return Oa(i||ci,t)}return Ea}function _a(n){let t=typeof n;return n===null?"":t==="string"||t==="number"||t==="boolean"?String(n):n instanceof Ri||n instanceof La||n instanceof Da?n.toString():JSON.stringify(n)}class On{constructor(t,i){this.type=t,this.value=i}static parse(t,i){if(t.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!jl(t[1]))return i.error("invalid value");let o=t[1],c=na(o),s=i.expectedType;return c.kind!=="array"||c.N!==0||!s||s.kind!=="array"||typeof s.N=="number"&&s.N!==0||(c=s),new On(c,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Ri?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof La?this.value.serialize():this.value}}class ga{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}}let Lc={string:oi,number:pe,boolean:si,object:Ea};class Dn{constructor(t,i){this.type=t,this.args=i}static parse(t,i){if(t.length<2)return i.error("Expected at least one argument.");let o,c=1,s=t[0];if(s==="array"){let W,R;if(t.length>2){let I=t[1];if(typeof I!="string"||!(I in Lc)||I==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);W=Lc[I],c++}else W=ci;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return i.error('The length argument to "array" must be a positive integer literal',2);R=t[2],c++}o=Oa(W,R)}else o=Lc[s];let b=[];for(;c<t.length;c++){let W=i.parse(t[c],c,ci);if(!W)return null;b.push(W)}return new Dn(o,b)}evaluate(t){for(let i=0;i<this.args.length;i++){let o=this.args[i].evaluate(t);if(!jo(this.type,na(o)))return o;if(i===this.args.length-1)throw new ga(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${Ki(na(o))} but was expected to be of type ${Ki(this.type)}.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){let t=this.type,i=[t.kind];if(t.kind==="array"){let o=t.itemType;if(o.kind==="string"||o.kind==="number"||o.kind==="boolean"){i.push(o.kind);let c=t.N;(typeof c=="number"||this.args.length>1)&&i.push(c)}}return i.concat(this.args.map(o=>o.serialize()))}}class Do{constructor(t){this.type=Ao,this.sections=t}static parse(t,i){if(t.length<2)return i.error("Expected at least one argument.");let o=t[1];if(!Array.isArray(o)&&typeof o=="object")return i.error("First argument must be an image or text section.");let c=[],s=!1;for(let b=1;b<=t.length-1;++b){let W=t[b];if(s&&typeof W=="object"&&!Array.isArray(W)){s=!1;let R=null;if(W["font-scale"]&&(R=i.parseObjectValue(W["font-scale"],b,"font-scale",pe),!R))return null;let I=null;if(W["text-font"]&&(I=i.parseObjectValue(W["text-font"],b,"text-font",Oa(oi)),!I))return null;let h=null;if(W["text-color"]&&(h=i.parseObjectValue(W["text-color"],b,"text-color",nn),!h))return null;let Z=c[c.length-1];Z.scale=R,Z.font=I,Z.textColor=h}else{let R=i.parse(t[b],b,ci);if(!R)return null;let I=R.type.kind;if(I!=="string"&&I!=="value"&&I!=="null"&&I!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");s=!0,c.push({content:R,scale:null,font:null,textColor:null})}}return new Do(c)}evaluate(t){return new La(this.sections.map(i=>{let o=i.content.evaluate(t);return na(o)===Ho?new un("",o,null,null,null):new un(_a(o),null,i.scale?i.scale.evaluate(t):null,i.font?i.font.evaluate(t).join(","):null,i.textColor?i.textColor.evaluate(t):null)}))}eachChild(t){for(let i of this.sections)t(i.content),i.scale&&t(i.scale),i.font&&t(i.font),i.textColor&&t(i.textColor)}outputDefined(){return!1}serialize(){let t=["format"];for(let i of this.sections){t.push(i.content.serialize());let o={};i.scale&&(o["font-scale"]=i.scale.serialize()),i.font&&(o["text-font"]=i.font.serialize()),i.textColor&&(o["text-color"]=i.textColor.serialize()),t.push(o)}return t}}class po{constructor(t,i){this.type=Ho,this.inputPrimary=t,this.inputSecondary=i}static parse(t,i){if(t.length<2)return i.error("Expected two or more arguments.");let o=i.parse(t[1],1,oi);if(!o)return i.error("No image name provided.");if(t.length===2)return new po(o);let c=i.parse(t[2],1,oi);return c?new po(o,c):i.error("Secondary image variant is not a string.")}evaluate(t){let i=Da.fromString(this.inputPrimary.evaluate(t),this.inputSecondary?this.inputSecondary.evaluate(t):void 0);return i&&t.availableImages&&(i.available=t.availableImages.indexOf(i.namePrimary)>-1,i.nameSecondary&&i.available&&t.availableImages&&(i.available=t.availableImages.indexOf(i.nameSecondary)>-1)),i}eachChild(t){t(this.inputPrimary),this.inputSecondary&&t(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function Wo(n){return n instanceof Number?"number":n instanceof String?"string":n instanceof Boolean?"boolean":Array.isArray(n)?"array":n===null?"null":typeof n}let od={"to-boolean":si,"to-color":nn,"to-number":pe,"to-string":oi};class Jl{constructor(t,i){this.type=t,this.args=i}static parse(t,i){if(t.length<2)return i.error("Expected at least one argument.");let o=t[0],c=[],s=jn;if(o==="to-array"){if(!Array.isArray(t[1]))return null;let b=t[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);s=Oa(i.expectedType.itemType,b)}else{if(!(b>0&&jl(t[1][0])))return null;s=Oa(na(t[1][0]),b)}for(let W=0;W<b;W++){let R=t[1][W],I;if(Wo(R)==="array")I=i.parse(R,void 0,s.itemType);else{let h=Wo(R);if(h!==s.itemType.kind)return i.error(`Expected ${s.itemType.kind} but found ${h}.`);I=i.registry.literal.parse(["literal",R===void 0?null:R],i)}if(!I)return null;c.push(I)}}else{if((o==="to-boolean"||o==="to-string")&&t.length!==2)return i.error("Expected one argument.");s=od[o];for(let b=1;b<t.length;b++){let W=i.parse(t[b],b,ci);if(!W)return null;c.push(W)}}return new Jl(s,c)}evaluate(t){if(this.type.kind==="boolean")return!!this.args[0].evaluate(t);if(this.type.kind==="color"){let i,o;for(let c of this.args){if(i=c.evaluate(t),o=null,i instanceof Ri)return i;if(typeof i=="string"){let s=t.parseColor(i);if(s)return s}else if(Array.isArray(i)&&(o=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:zm(i[0],i[1],i[2],i[3]),!o))return new Ri(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new ga(o||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(let o of this.args){if(i=o.evaluate(t),i===null)return 0;let c=Number(i);if(!isNaN(c))return c}throw new ga(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?La.fromString(_a(this.args[0].evaluate(t))):this.type.kind==="resolvedImage"?Da.fromString(_a(this.args[0].evaluate(t))):this.type.kind==="array"?this.args.map(i=>i.evaluate(t)):_a(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Do([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new po(this.args[0]).serialize();let t=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{t.push(i.serialize())}),t}}let Zp=["Unknown","Point","LineString","Polygon"];class wm{constructor(t,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=t,this.options=i}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Zp[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(t){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let t=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:o,y:c}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(o*i-t[0])+this.featureDistanceData.bearing[1]*(c*i-t[1])}return 0}parseColor(t){let i=this._parseColorCache[t];return i||(i=this._parseColorCache[t]=Ri.parse(t)),i}getConfig(t){return this.options?this.options.get(t):null}}class ln{constructor(t,i,o,c,s){this.name=t,this.type=i,this._evaluate=o,this.args=c,this._overloadIndex=s}evaluate(t){if(!this._evaluate){let i=ln.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,i){let o=t[0],c=ln.definitions[o];if(!c)return i.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);let s=Array.isArray(c)?c[0]:c.type,b=Array.isArray(c)?[[c[1],c[2]]]:c.overloads,W=[],R=null,I=-1;for(let[h,Z]of b){if(Array.isArray(h)&&h.length!==t.length-1)continue;W.push(h),I++,R=new eh(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);let F=[],V=!1;for(let G=1;G<t.length;G++){let N=t[G],X=Array.isArray(h)?h[G-1]:h.type,M=R.parse(N,1+F.length,X);if(!M){V=!0;break}F.push(M)}if(!V)if(Array.isArray(h)&&h.length!==F.length)R.error(`Expected ${h.length} arguments, but found ${F.length} instead.`);else{for(let G=0;G<F.length;G++){let N=Array.isArray(h)?h[G]:h.type,X=F[G];R.concat(G+1).checkSubtype(N,X.type)}if(R.errors.length===0)return new ln(o,s,Z,F,I)}}if(W.length===1)i.errors.push(...R.errors);else{let h=(W.length?W:b.map(([F])=>F)).map(gp).join(" | "),Z=[];for(let F=1;F<t.length;F++){let V=i.parse(t[F],1+Z.length);if(!V)return null;Z.push(Ki(V.type))}i.error(`Expected arguments of type ${h}, but found (${Z.join(", ")}) instead.`)}return null}static register(t,i){ln.definitions=i;for(let o in i)t[o]=ln}}function gp(n){return Array.isArray(n)?`(${n.map(Ki).join(", ")})`:`(${Ki(n.type)}...)`}class sd{constructor(t,i,o){this.type=nd,this.locale=o,this.caseSensitive=t,this.diacriticSensitive=i}static parse(t,i){if(t.length!==2)return i.error("Expected one argument.");let o=t[1];if(typeof o!="object"||Array.isArray(o))return i.error("Collator options argument must be an object.");let c=o["case-sensitive"]===void 0?i.parse(!1,1,si):i.parseObjectValue(o["case-sensitive"],1,"case-sensitive",si);if(!c)return null;let s=o["diacritic-sensitive"]===void 0?i.parse(!1,1,si):i.parseObjectValue(o["diacritic-sensitive"],1,"diacritic-sensitive",si);if(!s)return null;let b=null;return o.locale&&(b=i.parseObjectValue(o.locale,1,"locale",oi),!b)?null:new sd(c,s,b)}evaluate(t){return new ld(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){let t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}function Am(n,t,i=0,o=n.length-1,c=Po){for(;o>i;){if(o-i>600){let R=o-i+1,I=t-i+1,h=Math.log(R),Z=.5*Math.exp(2*h/3),F=.5*Math.sqrt(h*Z*(R-Z)/R)*(I-R/2<0?-1:1);Am(n,t,Math.max(i,Math.floor(t-I*Z/R+F)),Math.min(o,Math.floor(t+(R-I)*Z/R+F)),c)}let s=n[t],b=i,W=o;for(_o(n,i,t),c(n[o],s)>0&&_o(n,i,o);b<W;){for(_o(n,b,W),b++,W--;c(n[b],s)<0;)b++;for(;c(n[W],s)>0;)W--}c(n[i],s)===0?_o(n,i,W):(W++,_o(n,W,o)),W<=t&&(i=W+1),t<=W&&(o=W-1)}}function _o(n,t,i){let o=n[t];n[t]=n[i],n[i]=o}function Po(n,t){return n<t?-1:n>t?1:0}function Vp(n){let t=0;for(let i,o,c=0,s=n.length,b=s-1;c<s;b=c++)i=n[c],o=n[b],t+=(o.x-i.x)*(i.y+o.y);return t}function $s(n,t){n[0]=Math.min(n[0],t[0]),n[1]=Math.min(n[1],t[1]),n[2]=Math.max(n[2],t[0]),n[3]=Math.max(n[3],t[1])}function uo(n,t){return!(n[0]<=t[0]||n[2]>=t[2]||n[1]<=t[1]||n[3]>=t[3])}function Rp(n,t,i){let o=n[0]-t[0],c=n[1]-t[1],s=n[0]-i[0],b=n[1]-i[1];return o*b-s*c==0&&o*s<=0&&c*b<=0}function Ko(n,t,i=!1){let o=!1;for(let W=0,R=t.length;W<R;W++){let I=t[W];for(let h=0,Z=I.length,F=Z-1;h<Z;F=h++){let V=I[F],G=I[h];if(Rp(n,V,G))return i;(s=V)[1]>(c=n)[1]!=(b=G)[1]>c[1]&&c[0]<(b[0]-s[0])*(c[1]-s[1])/(b[1]-s[1])+s[0]&&(o=!o)}}var c,s,b;return o}function Hm(n,t,i,o){let c=o[0]-i[0],s=o[1]-i[1],b=(n[0]-i[0])*s-c*(n[1]-i[1]),W=(t[0]-i[0])*s-c*(t[1]-i[1]);return b>0&&W<0||b<0&&W>0}function rd(n,t,i,o){return(c=[o[0]-i[0],o[1]-i[1]])[0]*(s=[t[0]-n[0],t[1]-n[1]])[1]-c[1]*s[0]!=0&&!(!Hm(n,t,i,o)||!Hm(i,o,n,t));var c,s}let Zn=8192;function ai(n,t){let i=(180+n[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n[1]*Math.PI/360)))/360,c=Math.pow(2,t.z);return[Math.round(i*c*Zn),Math.round(o*c*Zn)]}function Ne(n,t){for(let i=0;i<t.length;i++)if(Ko(n,t[i]))return!0;return!1}function zc(n,t,i){for(let o of i)for(let c=0,s=o.length,b=s-1;c<s;b=c++)if(rd(n,t,o[b],o[c]))return!0;return!1}function Le(n,t){for(let i=0;i<n.length;++i)if(!Ko(n[i],t))return!1;for(let i=0;i<n.length-1;++i)if(zc(n[i],n[i+1],t))return!1;return!0}function wc(n,t){for(let i=0;i<t.length;i++)if(Le(n,t[i]))return!0;return!1}function tr(n,t,i){let o=[];for(let c=0;c<n.length;c++){let s=[];for(let b=0;b<n[c].length;b++){let W=ai(n[c][b],i);$s(t,W),s.push(W)}o.push(s)}return o}function Te(n,t,i){let o=[];for(let c=0;c<n.length;c++){let s=tr(n[c],t,i);o.push(s)}return o}function Ac(n,t,i,o){if(n[0]<i[0]||n[0]>i[2]){let c=.5*o,s=n[0]-i[0]>c?-o:i[0]-n[0]>c?o:0;s===0&&(s=n[0]-i[2]>c?-o:i[2]-n[0]>c?o:0),n[0]+=s}$s(t,n)}function dd(n,t,i,o){let c=Math.pow(2,o.z)*Zn,s=[o.x*Zn,o.y*Zn],b=[];if(!n)return b;for(let W of n)for(let R of W){let I=[R.x+s[0],R.y+s[1]];Ac(I,t,i,c),b.push(I)}return b}function Hc(n,t,i,o){let c=Math.pow(2,o.z)*Zn,s=[o.x*Zn,o.y*Zn],b=[];if(!n)return b;for(let R of n){let I=[];for(let h of R){let Z=[h.x+s[0],h.y+s[1]];$s(t,Z),I.push(Z)}b.push(I)}if(t[2]-t[0]<=c/2){(W=t)[0]=W[1]=1/0,W[2]=W[3]=-1/0;for(let R of b)for(let I of R)Ac(I,t,i,c)}var W;return b}class Ol{constructor(t,i){this.type=si,this.geojson=t,this.geometries=i}static parse(t,i){if(t.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(jl(t[1])){let o=t[1];if(o.type==="FeatureCollection")for(let c=0;c<o.features.length;++c){let s=o.features[c].geometry.type;if(s==="Polygon"||s==="MultiPolygon")return new Ol(o,o.features[c].geometry)}else if(o.type==="Feature"){let c=o.geometry.type;if(c==="Polygon"||c==="MultiPolygon")return new Ol(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new Ol(o,o)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(i,o){let c=[1/0,1/0,-1/0,-1/0],s=[1/0,1/0,-1/0,-1/0],b=i.canonicalID();if(!b)return!1;if(o.type==="Polygon"){let W=tr(o.coordinates,s,b),R=dd(i.geometry(),c,s,b);if(!uo(c,s))return!1;for(let I of R)if(!Ko(I,W))return!1}if(o.type==="MultiPolygon"){let W=Te(o.coordinates,s,b),R=dd(i.geometry(),c,s,b);if(!uo(c,s))return!1;for(let I of R)if(!Ne(I,W))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(i,o){let c=[1/0,1/0,-1/0,-1/0],s=[1/0,1/0,-1/0,-1/0],b=i.canonicalID();if(!b)return!1;if(o.type==="Polygon"){let W=tr(o.coordinates,s,b),R=Hc(i.geometry(),c,s,b);if(!uo(c,s))return!1;for(let I of R)if(!Le(I,W))return!1}if(o.type==="MultiPolygon"){let W=Te(o.coordinates,s,b),R=Hc(i.geometry(),c,s,b);if(!uo(c,s))return!1;for(let I of R)if(!wc(I,W))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}let Zo={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Ba=1/298.257223563,cd=Ba*(2-Ba),qo=Math.PI/180;class $o{static fromTile(t,i,o){let c=Math.PI*(1-2*(t+.5)/Math.pow(2,i)),s=Math.atan(.5*(Math.exp(c)-Math.exp(-c)))/qo;return new $o(s,o)}static get units(){return Zo}constructor(t,i){if(t===void 0)throw new Error("No latitude given.");if(i&&!Zo[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(Zo).join(", ")}`);let o=6378.137*qo*(i?Zo[i]:1),c=Math.cos(t*qo),s=1/(1-cd*(1-c*c)),b=Math.sqrt(s);this.kx=o*b*c,this.ky=o*b*s*(1-cd)}distance(t,i){let o=Ai(t[0]-i[0])*this.kx,c=(t[1]-i[1])*this.ky;return Math.sqrt(o*o+c*c)}bearing(t,i){let o=Ai(i[0]-t[0])*this.kx;return Math.atan2(o,(i[1]-t[1])*this.ky)/qo}destination(t,i,o){let c=o*qo;return this.offset(t,Math.sin(c)*i,Math.cos(c)*i)}offset(t,i,o){return[t[0]+i/this.kx,t[1]+o/this.ky]}lineDistance(t){let i=0;for(let o=0;o<t.length-1;o++)i+=this.distance(t[o],t[o+1]);return i}area(t){let i=0;for(let o=0;o<t.length;o++){let c=t[o];for(let s=0,b=c.length,W=b-1;s<b;W=s++)i+=Ai(c[s][0]-c[W][0])*(c[s][1]+c[W][1])*(o?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(t,i){let o=0;if(i<=0)return t[0];for(let c=0;c<t.length-1;c++){let s=t[c],b=t[c+1],W=this.distance(s,b);if(o+=W,o>i)return Xl(s,b,(i-(o-W))/W)}return t[t.length-1]}pointToSegmentDistance(t,i,o){let[c,s]=i,b=Ai(o[0]-c)*this.kx,W=(o[1]-s)*this.ky;if(b!==0||W!==0){let R=(Ai(t[0]-c)*this.kx*b+(t[1]-s)*this.ky*W)/(b*b+W*W);R>1?(c=o[0],s=o[1]):R>0&&(c+=b/this.kx*R,s+=W/this.ky*R)}return b=Ai(t[0]-c)*this.kx,W=(t[1]-s)*this.ky,Math.sqrt(b*b+W*W)}pointOnLine(t,i){let o=1/0,c=t[0][0],s=t[0][1],b=0,W=0;for(let R=0;R<t.length-1;R++){let I=t[R][0],h=t[R][1],Z=Ai(t[R+1][0]-I)*this.kx,F=(t[R+1][1]-h)*this.ky,V=0;Z===0&&F===0||(V=(Ai(i[0]-I)*this.kx*Z+(i[1]-h)*this.ky*F)/(Z*Z+F*F),V>1?(I=t[R+1][0],h=t[R+1][1]):V>0&&(I+=Z/this.kx*V,h+=F/this.ky*V)),Z=Ai(i[0]-I)*this.kx,F=(i[1]-h)*this.ky;let G=Z*Z+F*F;G<o&&(o=G,c=I,s=h,b=R,W=V)}return{point:[c,s],index:b,t:Math.max(0,Math.min(1,W))}}lineSlice(t,i,o){let c=this.pointOnLine(o,t),s=this.pointOnLine(o,i);if(c.index>s.index||c.index===s.index&&c.t>s.t){let I=c;c=s,s=I}let b=[c.point],W=c.index+1,R=s.index;!bd(o[W],b[0])&&W<=R&&b.push(o[W]);for(let I=W+1;I<=R;I++)b.push(o[I]);return bd(o[R],s.point)||b.push(s.point),b}lineSliceAlong(t,i,o){let c=0,s=[];for(let b=0;b<o.length-1;b++){let W=o[b],R=o[b+1],I=this.distance(W,R);if(c+=I,c>t&&s.length===0&&s.push(Xl(W,R,(t-(c-I))/I)),c>=i)return s.push(Xl(W,R,(i-(c-I))/I)),s;c>t&&s.push(R)}return s}bufferPoint(t,i){let o=i/this.ky,c=i/this.kx;return[t[0]-c,t[1]-o,t[0]+c,t[1]+o]}bufferBBox(t,i){let o=i/this.ky,c=i/this.kx;return[t[0]-c,t[1]-o,t[2]+c,t[3]+o]}insideBBox(t,i){return Ai(t[0]-i[0])>=0&&Ai(t[0]-i[2])<=0&&t[1]>=i[1]&&t[1]<=i[3]}}function bd(n,t){return n[0]===t[0]&&n[1]===t[1]}function Xl(n,t,i){let o=Ai(t[0]-n[0]);return[n[0]+o*i,n[1]+(t[1]-n[1])*i]}function Ai(n){for(;n<-180;)n+=360;for(;n>180;)n-=360;return n}class jc{constructor(t=[],i=(o,c)=>o<c?-1:o>c?1:0){if(this.data=t,this.length=this.data.length,this.compare=i,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(t){this.data.push(t),this._up(this.length++)}pop(){if(this.length===0)return;let t=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),t}peek(){return this.data[0]}_up(t){let{data:i,compare:o}=this,c=i[t];for(;t>0;){let s=t-1>>1,b=i[s];if(o(c,b)>=0)break;i[t]=b,t=s}i[t]=c}_down(t){let{data:i,compare:o}=this,c=this.length>>1,s=i[t];for(;t<c;){let b=1+(t<<1),W=b+1;if(W<this.length&&o(i[W],i[b])<0&&(b=W),o(i[b],s)>=0)break;i[t]=i[b],t=b}i[t]=s}}var ne=8192;function jm(n,t){return t.dist-n.dist}let ts=100,md=50;function hd(n){let t=[1/0,1/0,-1/0,-1/0];if(t.length!==n.length)return!1;for(let i=0;i<t.length;i++)if(t[i]!==n[i])return!1;return!0}function pd(n){return n[1]-n[0]+1}function yl(n,t){let i=n[1]>=n[0]&&n[1]<t;return i||console.warn("Distance Expression: Index is out of range"),i}function Oc(n,t){if(n[0]>n[1])return[null,null];let i=pd(n);if(t){if(i===2)return[n,null];let o=Math.floor(i/2);return[[n[0],n[0]+o],[n[0]+o,n[1]]]}{if(i===1)return[n,null];let o=Math.floor(i/2)-1;return[[n[0],n[0]+o],[n[0]+o+1,n[1]]]}}function gn(n,t){let i=[1/0,1/0,-1/0,-1/0];if(!yl(t,n.length))return i;for(let o=t[0];o<=t[1];++o)$s(i,n[o]);return i}function Wd(n){let t=[1/0,1/0,-1/0,-1/0];for(let i=0;i<n.length;++i)for(let o=0;o<n[i].length;++o)$s(t,n[i][o]);return t}function es(n,t,i){if(hd(n)||hd(t))return NaN;let o=0,c=0;return n[2]<t[0]&&(o=t[0]-n[2]),n[0]>t[2]&&(o=n[0]-t[2]),n[1]>t[3]&&(c=n[1]-t[3]),n[3]<t[1]&&(c=t[1]-n[3]),i.distance([0,0],[o,c])}function Om(n){return 360*n-180}function Dm(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function Vn(n,t){let i=Math.pow(2,t.z),o=(n.y/ne+t.y)/i;return[Om((n.x/ne+t.x)/i),Dm(o)]}function _m(n,t){let i=[];for(let o=0;o<n.length;++o)i.push(Vn(n[o],t));return i}function Dc(n,t,i){let o=i.pointOnLine(t,n).point;return i.distance(n,o)}function _c(n,t,i,o,c){let s=i.slice(o[0],o[1]+1),b=1/0;for(let W=t[0];W<=t[1];++W)if((b=Math.min(b,Dc(n[W],s,c)))===0)return 0;return b}function ud(n,t,i,o,c){let s=Math.min(c.pointToSegmentDistance(n,i,o),c.pointToSegmentDistance(t,i,o)),b=Math.min(c.pointToSegmentDistance(i,n,t),c.pointToSegmentDistance(o,n,t));return Math.min(s,b)}function Pm(n,t,i,o,c){if(!yl(t,n.length)||!yl(o,i.length))return NaN;let s=1/0;for(let b=t[0];b<t[1];++b)for(let W=o[0];W<o[1];++W){if(rd(n[b],n[b+1],i[W],i[W+1]))return 0;s=Math.min(s,ud(n[b],n[b+1],i[W],i[W+1],c))}return s}function Km(n,t,i,o,c){if(!yl(t,n.length)||!yl(o,i.length))return NaN;let s=1/0;for(let b=t[0];b<=t[1];++b)for(let W=o[0];W<=o[1];++W)if((s=Math.min(s,c.distance(n[b],i[W])))===0)return s;return s}function qm(n,t,i){if(Ko(n,t,!0))return 0;let o=1/0;for(let c of t){let s=c.length;if(s<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(c[0]!==c[s-1]&&(o=Math.min(o,i.pointToSegmentDistance(n,c[s-1],c[0])))===0||(o=Math.min(o,Dc(n,c,i)))===0)return o}return o}function $m(n,t,i,o){if(!yl(t,n.length))return NaN;for(let s=t[0];s<=t[1];++s)if(Ko(n[s],i,!0))return 0;let c=1/0;for(let s=t[0];s<t[1];++s)for(let b of i)for(let W=0,R=b.length,I=R-1;W<R;I=W++){if(rd(n[s],n[s+1],b[I],b[W]))return 0;c=Math.min(c,ud(n[s],n[s+1],b[I],b[W],o))}return c}function Pc(n,t){for(let i of n)for(let o=0;o<=i.length-1;++o)if(Ko(i[o],t,!0))return!0;return!1}function th(n,t,i,o=1/0){let c=Wd(n),s=Wd(t);if(o!==1/0&&es(c,s,i)>=o)return o;if(uo(c,s)){if(Pc(n,t))return 0}else if(Pc(t,n))return 0;let b=o;for(let W of n)for(let R=0,I=W.length,h=I-1;R<I;h=R++)for(let Z of t)for(let F=0,V=Z.length,G=V-1;F<V;G=F++){if(rd(W[h],W[R],Z[G],Z[F]))return 0;b=Math.min(b,ud(W[h],W[R],Z[G],Z[F],i))}return b}function er(n,t,i,o,c,s,b){if(s===null||b===null)return;let W=es(gn(o,s),gn(c,b),i);W<t&&n.push({dist:W,range1:s,range2:b})}function Zd(n,t,i,o,c=1/0){let s=Math.min(o.distance(n[0],i[0][0]),c);if(s===0)return s;let b=new jc([{dist:0,range1:[0,n.length-1],range2:[0,0]}],jm),W=t?md:ts,R=Wd(i);for(;b.length;){let I=b.pop();if(I.dist>=s)continue;let h=I.range1;if(pd(h)<=W){if(!yl(h,n.length))return NaN;if(t){let Z=$m(n,h,i,o);if((s=Math.min(s,Z))===0)return s}else for(let Z=h[0];Z<=h[1];++Z){let F=qm(n[Z],i,o);if((s=Math.min(s,F))===0)return s}}else{let Z=Oc(h,t);if(Z[0]!==null){let F=es(gn(n,Z[0]),R,o);F<s&&b.push({dist:F,range1:Z[0],range2:[0,0]})}if(Z[1]!==null){let F=es(gn(n,Z[1]),R,o);F<s&&b.push({dist:F,range1:Z[1],range2:[0,0]})}}}return s}function ir(n,t,i,o,c,s=1/0){let b=Math.min(s,c.distance(n[0],i[0]));if(b===0)return b;let W=new jc([{dist:0,range1:[0,n.length-1],range2:[0,i.length-1]}],jm),R=t?md:ts,I=o?md:ts;for(;W.length;){let h=W.pop();if(h.dist>=b)continue;let Z=h.range1,F=h.range2;if(pd(Z)<=R&&pd(F)<=I){if(!yl(Z,n.length)||!yl(F,i.length))return NaN;if(t&&o?b=Math.min(b,Pm(n,Z,i,F,c)):t||o?t&&!o?b=Math.min(b,_c(i,F,n,Z,c)):!t&&o&&(b=Math.min(b,_c(n,Z,i,F,c))):b=Math.min(b,Km(n,Z,i,F,c)),b===0)return b}else{let V=Oc(Z,t),G=Oc(F,o);er(W,b,c,n,i,V[0],G[0]),er(W,b,c,n,i,V[0],G[1]),er(W,b,c,n,i,V[1],G[0]),er(W,b,c,n,i,V[1],G[1])}}return b}function is(n,t,i,o,c=1/0){let s=c,b=gn(n,[0,n.length-1]);for(let W of i)if(!(s!==1/0&&es(b,gn(W,[0,W.length-1]),o)>=s)&&(s=Math.min(s,ir(n,t,W,!0,o,s)),s===0))return s;return s}function ar(n,t,i,o,c=1/0){let s=c,b=gn(n,[0,n.length-1]);for(let W of i){if(s!==1/0&&es(b,Wd(W),o)>=s)continue;let R=Zd(n,t,W,o,s);if(isNaN(R))return R;if((s=Math.min(s,R))===0)return s}return s}function gd(n){return n==="Point"||n==="MultiPoint"||n==="LineString"||n==="MultiLineString"||n==="Polygon"||n==="MultiPolygon"}class Dl{constructor(t,i){this.type=pe,this.geojson=t,this.geometries=i}static parse(t,i){if(t.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${t.length-1} instead.`);if(jl(t[1])){let o=t[1];if(o.type==="FeatureCollection"){for(let c=0;c<o.features.length;++c)if(gd(o.features[c].geometry.type))return new Dl(o,o.features[c].geometry)}else if(o.type==="Feature"){if(gd(o.geometry.type))return new Dl(o,o.geometry)}else if(gd(o.type))return new Dl(o,o)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(t){let i=t.geometry(),o=t.canonicalID();if(i!=null&&o!=null){if(t.geometryType()==="Point")return function(c,s,b){let W=[];for(let I of c)for(let h of I)W.push(Vn(h,s));let R=new $o(W[0][1],"meters");return b.type==="Point"||b.type==="MultiPoint"||b.type==="LineString"?ir(W,!1,b.type==="Point"?[b.coordinates]:b.coordinates,b.type==="LineString",R):b.type==="MultiLineString"?is(W,!1,b.coordinates,R):b.type==="Polygon"||b.type==="MultiPolygon"?ar(W,!1,b.type==="Polygon"?[b.coordinates]:b.coordinates,R):null}(i,o,this.geometries);if(t.geometryType()==="LineString")return function(c,s,b){let W=[];for(let I of c){let h=[];for(let Z of I)h.push(Vn(Z,s));W.push(h)}let R=new $o(W[0][0][1],"meters");if(b.type==="Point"||b.type==="MultiPoint"||b.type==="LineString")return is(b.type==="Point"?[b.coordinates]:b.coordinates,b.type==="LineString",W,R);if(b.type==="MultiLineString"){let I=1/0;for(let h=0;h<b.coordinates.length;h++){let Z=is(b.coordinates[h],!0,W,R,I);if(isNaN(Z))return Z;if((I=Math.min(I,Z))===0)return I}return I}if(b.type==="Polygon"||b.type==="MultiPolygon"){let I=1/0;for(let h=0;h<W.length;h++){let Z=ar(W[h],!0,b.type==="Polygon"?[b.coordinates]:b.coordinates,R,I);if(isNaN(Z))return Z;if((I=Math.min(I,Z))===0)return I}return I}return null}(i,o,this.geometries);if(t.geometryType()==="Polygon")return function(c,s,b){let W=[];for(let I of function(h,Z){let F=h.length;if(F<=1)return[h];let V=[],G,N;for(let X=0;X<F;X++){let M=Vp(h[X]);M!==0&&(h[X].area=Math.abs(M),N===void 0&&(N=M<0),N===M<0?(G&&V.push(G),G=[h[X]]):G.push(h[X]))}return G&&V.push(G),V}(c)){let h=[];for(let Z=0;Z<I.length;++Z)h.push(_m(I[Z],s));W.push(h)}let R=new $o(W[0][0][0][1],"meters");if(b.type==="Point"||b.type==="MultiPoint"||b.type==="LineString")return ar(b.type==="Point"?[b.coordinates]:b.coordinates,b.type==="LineString",W,R);if(b.type==="MultiLineString"){let I=1/0;for(let h=0;h<b.coordinates.length;h++){let Z=ar(b.coordinates[h],!0,W,R,I);if(isNaN(Z))return Z;if((I=Math.min(I,Z))===0)return I}return I}return b.type==="Polygon"||b.type==="MultiPolygon"?function(I,h,Z){let F=1/0;for(let V of I)for(let G of h){let N=th(V,G,Z,F);if(isNaN(N))return N;if((F=Math.min(F,N))===0)return F}return F}(b.type==="Polygon"?[b.coordinates]:b.coordinates,W,R):null}(i,o,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function _l(n,t){switch(n){case"string":return _a(t);case"number":return+t;case"boolean":return!!t;case"color":return Ri.parse(t);case"formatted":return La.fromString(_a(t));case"resolvedImage":return Da.fromString(_a(t))}return t}function ri(n,t,i,o){return o!==void 0&&(n=o*Math.round(n/o)),t!==void 0&&n<t&&(n=t),i!==void 0&&n>i&&(n=i),n}class as{constructor(t,i,o){this.type=t,this.key=i,this.scope=o}static parse(t,i){let o=i.expectedType;if(o==null&&(o=ci),t.length<2||t.length>3)return i.error("Invalid number of arguments for 'config' expression.");let c=i.parse(t[1],1);if(!(c instanceof On))return i.error("Key name of 'config' expression must be a string literal.");if(t.length>=3){let s=i.parse(t[2],2);return s instanceof On?new as(o,_a(c.value),_a(s.value)):i.error("Scope of 'config' expression must be a string literal.")}return new as(o,_a(c.value))}evaluate(t){let i=[this.key,this.scope,t.scope].filter(Boolean).join(""),o=t.getConfig(i);if(!o)return null;let{type:c,value:s,values:b,minValue:W,maxValue:R,stepValue:I}=o,h=o.default.evaluate(t),Z=h;if(s){let F=t.scope;t.scope=(F||"").split("").slice(1).join(""),Z=s.evaluate(t),t.scope=F}return c&&(Z=_l(c,Z)),Z===void 0||W===void 0&&R===void 0&&I===void 0||(typeof Z=="number"?Z=ri(Z,W,R,I):Array.isArray(Z)&&(Z=Z.map(F=>typeof F=="number"?ri(F,W,R,I):F))),s!==void 0&&Z!==void 0&&b&&!b.includes(Z)&&(Z=h,c&&(Z=_l(c,Z))),(c&&c!==this.type||Z!==void 0&&na(Z)!==this.type)&&(Z=_l(this.type.kind,Z)),Z}eachChild(){}outputDefined(){return!1}serialize(){let t=["config",this.key];return this.scope&&t.concat(this.key),t}}function nr(n){if(n instanceof ln&&(n.name==="get"&&n.args.length===1||n.name==="feature-state"||n.name==="has"&&n.args.length===1||n.name==="properties"||n.name==="geometry-type"||n.name==="id"||/^filter-/.test(n.name))||n instanceof Ol||n instanceof Dl)return!1;let t=!0;return n.eachChild(i=>{t&&!nr(i)&&(t=!1)}),t}function Vd(n){if(n instanceof ln&&n.name==="feature-state")return!1;let t=!0;return n.eachChild(i=>{t&&!Vd(i)&&(t=!1)}),t}function Rd(n){if(n instanceof as)return new Set([n.key]);let t=new Set;return n.eachChild(i=>{t=new Set([...t,...Rd(i)])}),t}function lr(n,t){if(n instanceof ln&&t.indexOf(n.name)>=0)return!1;let i=!0;return n.eachChild(o=>{i&&!lr(o,t)&&(i=!1)}),i}class Ji{constructor(t,i){this.type=i.type,this.name=t,this.boundExpression=i}static parse(t,i){if(t.length!==2||typeof t[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");let o=t[1];return i.scope.has(o)?new Ji(o,i.scope.get(o)):i.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Kc{constructor(t,i=[],o,c=new ad,s=[],b,W){this.registry=t,this.path=i,this.key=i.map(R=>typeof R=="string"?`['${R}']`:`[${R}]`).join(""),this.scope=c,this.errors=s,this.expectedType=o,this._scope=b,this.options=W}parse(t,i,o,c,s={}){return i||o?this.concat(i,null,o,c)._parse(t,s):this._parse(t,s)}parseObjectValue(t,i,o,c,s,b={}){return this.concat(i,o,c,s)._parse(t,b)}_parse(t,i){function o(c,s,b){return b==="assert"?new Dn(s,[c]):b==="coerce"?new Jl(s,[c]):c}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let c=typeof t[0]=="string"?this.registry[t[0]]:void 0;if(c){let s=c.parse(t,this);if(!s)return null;if(this.expectedType){let b=this.expectedType,W=s.type;if(b.kind!=="string"&&b.kind!=="number"&&b.kind!=="boolean"&&b.kind!=="object"&&b.kind!=="array"||W.kind!=="value")if(b.kind!=="color"&&b.kind!=="formatted"&&b.kind!=="resolvedImage"||W.kind!=="value"&&W.kind!=="string"){if(this.checkSubtype(b,W))return null}else s=o(s,b,i.typeAnnotation||"coerce");else s=o(s,b,i.typeAnnotation||"assert")}if(!(s instanceof On)&&s.type.kind!=="resolvedImage"&&qc(s)){let b=new wm(this._scope,this.options);try{s=new On(s.type,s.evaluate(b))}catch(W){return this.error(W.message),null}}return s}return Jl.parse(["to-array",t],this)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,i,o,c){let s=typeof t=="number"?this.path.concat(t):this.path;s=typeof i=="string"?s.concat(i):s;let b=c?this.scope.concat(c):this.scope;return new Kc(this.registry,s,o||null,b,this.errors,this._scope,this.options)}error(t,...i){let o=`${this.key}${i.map(c=>`[${c}]`).join("")}`;this.errors.push(new sl(o,t))}checkSubtype(t,i){let o=jo(t,i);return o&&this.error(o),o}}var eh=Kc;function qc(n){if(n instanceof Ji)return qc(n.boundExpression);if(n instanceof ln&&n.name==="error"||n instanceof sd||n instanceof Ol||n instanceof Dl||n instanceof as)return!1;let t=n instanceof Jl||n instanceof Dn,i=!0;return n.eachChild(o=>{i=t?i&&qc(o):i&&o instanceof On}),!!i&&nr(n)&&lr(n,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Gd(n,t){let i=n.length-1,o,c,s=0,b=i,W=0;for(;s<=b;)if(W=Math.floor((s+b)/2),o=n[W],c=n[W+1],o<=t){if(W===i||t<c)return W;s=W+1}else{if(!(o>t))throw new ga("Input is not a number.");b=W-1}return 0}class or{constructor(t,i,o){this.type=t,this.input=i,this.labels=[],this.outputs=[];for(let[c,s]of o)this.labels.push(c),this.outputs.push(s)}static parse(t,i){if(t.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return i.error("Expected an even number of arguments.");let o=i.parse(t[1],1,pe);if(!o)return null;let c=[],s=null;i.expectedType&&i.expectedType.kind!=="value"&&(s=i.expectedType);for(let b=1;b<t.length;b+=2){let W=b===1?-1/0:t[b],R=t[b+1],I=b,h=b+1;if(typeof W!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',I);if(c.length&&c[c.length-1][0]>=W)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',I);let Z=i.parse(R,h,s);if(!Z)return null;s=s||Z.type,c.push([W,Z])}return new or(s,o,c)}evaluate(t){let i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(t);let c=this.input.evaluate(t);if(c<=i[0])return o[0].evaluate(t);let s=i.length;return c>=i[s-1]?o[s-1].evaluate(t):o[Gd(i,c)].evaluate(t)}eachChild(t){t(this.input);for(let i of this.outputs)t(i)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&t.push(this.labels[i]),t.push(this.outputs[i].serialize());return t}}let ih=.95047,ah=1.08883,nh=4/29,ns=6/29,lh=3*ns*ns,Gp=ns*ns*ns,Fp=Math.PI/180,Ip=180/Math.PI;function $c(n){return n>Gp?Math.pow(n,1/3):n/lh+nh}function tb(n){return n>ns?n*n*n:lh*(n-nh)}function eb(n){return 255*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055)}function ib(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function oh(n){let t=ib(n.r),i=ib(n.g),o=ib(n.b),c=$c((.4124564*t+.3575761*i+.1804375*o)/ih),s=$c((.2126729*t+.7151522*i+.072175*o)/1);return{l:116*s-16,a:500*(c-s),b:200*(s-$c((.0193339*t+.119192*i+.9503041*o)/ah)),alpha:n.a}}function sh(n){let t=(n.l+16)/116,i=isNaN(n.a)?t:t+n.a/500,o=isNaN(n.b)?t:t-n.b/200;return t=1*tb(t),i=ih*tb(i),o=ah*tb(o),new Ri(eb(3.2404542*i-1.5371385*t-.4985314*o),eb(-.969266*i+1.8760108*t+.041556*o),eb(.0556434*i-.2040259*t+1.0572252*o),n.alpha)}function Up(n,t,i){let o=t-n;return n+i*(o>180||o<-180?o-360*Math.round(o/360):o)}let sr={forward:oh,reverse:sh,interpolate:function(n,t,i){return{l:Je(n.l,t.l,i),a:Je(n.a,t.a,i),b:Je(n.b,t.b,i),alpha:Je(n.alpha,t.alpha,i)}}},rr={forward:function(n){let{l:t,a:i,b:o}=oh(n),c=Math.atan2(o,i)*Ip;return{h:c<0?c+360:c,c:Math.sqrt(i*i+o*o),l:t,alpha:n.a}},reverse:function(n){let t=n.h*Fp,i=n.c;return sh({l:n.l,a:Math.cos(t)*i,b:Math.sin(t)*i,alpha:n.alpha})},interpolate:function(n,t,i){return{h:Up(n.h,t.h,i),c:Je(n.c,t.c,i),l:Je(n.l,t.l,i),alpha:Je(n.alpha,t.alpha,i)}}};var rh=Object.freeze({__proto__:null,hcl:rr,lab:sr});class Rn{constructor(t,i,o,c,s){this.type=t,this.operator=i,this.interpolation=o,this.input=c,this.labels=[],this.outputs=[];for(let[b,W]of s)this.labels.push(b),this.outputs.push(W)}static interpolationFactor(t,i,o,c){let s=0;if(t.name==="exponential")s=ab(i,t.base,o,c);else if(t.name==="linear")s=ab(i,1,o,c);else if(t.name==="cubic-bezier"){let b=t.controlPoints;s=new el(b[0],b[1],b[2],b[3]).solve(ab(i,1,o,c))}return s}static parse(t,i){let[o,c,s,...b]=t;if(!Array.isArray(c)||c.length===0)return i.error("Expected an interpolation type expression.",1);if(c[0]==="linear")c={name:"linear"};else if(c[0]==="exponential"){let I=c[1];if(typeof I!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);c={name:"exponential",base:I}}else{if(c[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(c[0])}`,1,0);{let I=c.slice(1);if(I.length!==4||I.some(h=>typeof h!="number"||h<0||h>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);c={name:"cubic-bezier",controlPoints:I}}}if(t.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(s=i.parse(s,2,pe),!s)return null;let W=[],R=null;o==="interpolate-hcl"||o==="interpolate-lab"?R=nn:i.expectedType&&i.expectedType.kind!=="value"&&(R=i.expectedType);for(let I=0;I<b.length;I+=2){let h=b[I],Z=b[I+1],F=I+3,V=I+4;if(typeof h!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',F);if(W.length&&W[W.length-1][0]>=h)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',F);let G=i.parse(Z,V,R);if(!G)return null;R=R||G.type,W.push([h,G])}return R.kind==="number"||R.kind==="color"||R.kind==="array"&&R.itemType.kind==="number"&&typeof R.N=="number"?new Rn(R,o,c,s,W):i.error(`Type ${Ki(R)} is not interpolatable.`)}evaluate(t){let i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(t);let c=this.input.evaluate(t);if(c<=i[0])return o[0].evaluate(t);let s=i.length;if(c>=i[s-1])return o[s-1].evaluate(t);let b=Gd(i,c),W=Rn.interpolationFactor(this.interpolation,c,i[b],i[b+1]),R=o[b].evaluate(t),I=o[b+1].evaluate(t);return this.operator==="interpolate"?ho[this.type.kind.toLowerCase()](R,I,W):this.operator==="interpolate-hcl"?rr.reverse(rr.interpolate(rr.forward(R),rr.forward(I),W)):sr.reverse(sr.interpolate(sr.forward(R),sr.forward(I),W))}eachChild(t){t(this.input);for(let i of this.outputs)t(i)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);let i=[this.operator,t,this.input.serialize()];for(let o=0;o<this.labels.length;o++)i.push(this.labels[o],this.outputs[o].serialize());return i}}function ab(n,t,i,o){let c=o-i,s=n-i;return c===0?0:t===1?s/c:(Math.pow(t,s)-1)/(Math.pow(t,c)-1)}class Fd{constructor(t,i){this.type=t,this.args=i}static parse(t,i){if(t.length<2)return i.error("Expectected at least one argument.");let o=null,c=i.expectedType;c&&c.kind!=="value"&&(o=c);let s=[];for(let W of t.slice(1)){let R=i.parse(W,1+s.length,o,void 0,{typeAnnotation:"omit"});if(!R)return null;o=o||R.type,s.push(R)}let b=c&&s.some(W=>jo(c,W.type));return new Fd(b?ci:o,s)}evaluate(t){let i,o=null,c=0;for(let s of this.args){if(c++,o=s.evaluate(t),o&&o instanceof Da&&!o.available&&(i||(i=o),o=null,c===this.args.length))return i;if(o!==null)break}return o}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){let t=["coalesce"];return this.eachChild(i=>{t.push(i.serialize())}),t}}class Id{constructor(t,i){this.type=i.type,this.bindings=[].concat(t),this.result=i}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(let i of this.bindings)t(i[1]);t(this.result)}static parse(t,i){if(t.length<4)return i.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);let o=[];for(let s=1;s<t.length-1;s+=2){let b=t[s];if(typeof b!="string")return i.error(`Expected string, but found ${typeof b} instead.`,s);if(/[^a-zA-Z0-9_]/.test(b))return i.error("Variable names must contain only alphanumeric characters or '_'.",s);let W=i.parse(t[s+1],s+1);if(!W)return null;o.push([b,W])}let c=i.parse(t[t.length-1],t.length-1,i.expectedType,o);return c?new Id(o,c):null}outputDefined(){return this.result.outputDefined()}serialize(){let t=["let"];for(let[i,o]of this.bindings)t.push(i,o.serialize());return t.push(this.result.serialize()),t}}class nb{constructor(t,i,o){this.type=t,this.index=i,this.input=o}static parse(t,i){if(t.length!==3)return i.error(`Expected 2 arguments, but found ${t.length-1} instead.`);let o=i.parse(t[1],1,pe),c=i.parse(t[2],2,Oa(i.expectedType||ci));return o&&c?new nb(c.type.itemType,o,c):null}evaluate(t){let i=this.index.evaluate(t),o=this.input.evaluate(t);if(i<0)throw new ga(`Array index out of bounds: ${i} < 0.`);if(i>=o.length)throw new ga(`Array index out of bounds: ${i} > ${o.length-1}.`);if(i!==Math.floor(i))throw new ga(`Array index must be an integer, but found ${i} instead.`);return o[i]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class lb{constructor(t,i){this.type=si,this.needle=t,this.haystack=i}static parse(t,i){if(t.length!==3)return i.error(`Expected 2 arguments, but found ${t.length-1} instead.`);let o=i.parse(t[1],1,ci),c=i.parse(t[2],2,ci);return o&&c?Oo(o.type,[si,oi,pe,jn,ci])?new lb(o,c):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ki(o.type)} instead`):null}evaluate(t){let i=this.needle.evaluate(t),o=this.haystack.evaluate(t);if(o==null)return!1;if(!rl(i,["boolean","string","number","null"]))throw new ga(`Expected first argument to be of type boolean, string, number or null, but found ${Ki(na(i))} instead.`);if(!rl(o,["string","array"]))throw new ga(`Expected second argument to be of type array or string, but found ${Ki(na(o))} instead.`);return o.indexOf(i)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Ud{constructor(t,i,o){this.type=pe,this.needle=t,this.haystack=i,this.fromIndex=o}static parse(t,i){if(t.length<=2||t.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);let o=i.parse(t[1],1,ci),c=i.parse(t[2],2,ci);if(!o||!c)return null;if(!Oo(o.type,[si,oi,pe,jn,ci]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ki(o.type)} instead`);if(t.length===4){let s=i.parse(t[3],3,pe);return s?new Ud(o,c,s):null}return new Ud(o,c)}evaluate(t){let i=this.needle.evaluate(t),o=this.haystack.evaluate(t);if(!rl(i,["boolean","string","number","null"]))throw new ga(`Expected first argument to be of type boolean, string, number or null, but found ${Ki(na(i))} instead.`);if(!rl(o,["string","array"]))throw new ga(`Expected second argument to be of type array or string, but found ${Ki(na(o))} instead.`);if(this.fromIndex){let c=this.fromIndex.evaluate(t);return o.indexOf(i,c)}return o.indexOf(i)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){let t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class ob{constructor(t,i,o,c,s,b){this.inputType=t,this.type=i,this.input=o,this.cases=c,this.outputs=s,this.otherwise=b}static parse(t,i){if(t.length<5)return i.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return i.error("Expected an even number of arguments.");let o,c;i.expectedType&&i.expectedType.kind!=="value"&&(c=i.expectedType);let s={},b=[];for(let I=2;I<t.length-1;I+=2){let h=t[I],Z=t[I+1];Array.isArray(h)||(h=[h]);let F=i.concat(I);if(h.length===0)return F.error("Expected at least one branch label.");for(let G of h){if(typeof G!="number"&&typeof G!="string")return F.error("Branch labels must be numbers or strings.");if(typeof G=="number"&&Math.abs(G)>Number.MAX_SAFE_INTEGER)return F.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof G=="number"&&Math.floor(G)!==G)return F.error("Numeric branch labels must be integer values.");if(o){if(F.checkSubtype(o,na(G)))return null}else o=na(G);if(s[String(G)]!==void 0)return F.error("Branch labels must be unique.");s[String(G)]=b.length}let V=i.parse(Z,I,c);if(!V)return null;c=c||V.type,b.push(V)}let W=i.parse(t[1],1,ci);if(!W)return null;let R=i.parse(t[t.length-1],t.length-1,c);return R?W.type.kind!=="value"&&i.concat(1).checkSubtype(o,W.type)?null:new ob(o,c,W,s,b,R):null}evaluate(t){let i=this.input.evaluate(t);return(na(i)===this.inputType&&this.outputs[this.cases[i]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){let t=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),o=[],c={};for(let b of i){let W=c[this.cases[b]];W===void 0?(c[this.cases[b]]=o.length,o.push([this.cases[b],[b]])):o[W][1].push(b)}let s=b=>this.inputType.kind==="number"?Number(b):b;for(let[b,W]of o)t.push(W.length===1?s(W[0]):W.map(s)),t.push(this.outputs[b].serialize());return t.push(this.otherwise.serialize()),t}}class dr{constructor(t,i,o){this.type=t,this.branches=i,this.otherwise=o}static parse(t,i){if(t.length<4)return i.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return i.error("Expected an odd number of arguments.");let o;i.expectedType&&i.expectedType.kind!=="value"&&(o=i.expectedType);let c=[];for(let b=1;b<t.length-1;b+=2){let W=i.parse(t[b],b,si);if(!W)return null;let R=i.parse(t[b+1],b+1,o);if(!R)return null;c.push([W,R]),o=o||R.type}let s=i.parse(t[t.length-1],t.length-1,o);return s?new dr(o,c,s):null}evaluate(t){for(let[i,o]of this.branches)if(i.evaluate(t))return o.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(let[i,o]of this.branches)t(i),t(o);t(this.otherwise)}outputDefined(){return this.branches.every(([t,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){let t=["case"];return this.eachChild(i=>{t.push(i.serialize())}),t}}class xd{constructor(t,i,o,c){this.type=t,this.input=i,this.beginIndex=o,this.endIndex=c}static parse(t,i){if(t.length<=2||t.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);let o=i.parse(t[1],1,ci),c=i.parse(t[2],2,pe);if(!o||!c)return null;if(!Oo(o.type,[Oa(ci),oi,ci]))return i.error(`Expected first argument to be of type array or string, but found ${Ki(o.type)} instead`);if(t.length===4){let s=i.parse(t[3],3,pe);return s?new xd(o.type,o,c,s):null}return new xd(o.type,o,c)}evaluate(t){let i=this.input.evaluate(t),o=this.beginIndex.evaluate(t);if(!rl(i,["string","array"]))throw new ga(`Expected first argument to be of type array or string, but found ${Ki(na(i))} instead.`);if(this.endIndex){let c=this.endIndex.evaluate(t);return i.slice(o,c)}return i.slice(o)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){let t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function sb(n,t){return n==="=="||n==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function dh(n,t,i,o){return o.compare(t,i)===0}function ls(n,t,i){let o=n!=="=="&&n!=="!=";return class KR{constructor(s,b,W){this.type=si,this.lhs=s,this.rhs=b,this.collator=W,this.hasUntypedArgument=s.type.kind==="value"||b.type.kind==="value"}static parse(s,b){if(s.length!==3&&s.length!==4)return b.error("Expected two or three arguments.");let W=s[0],R=b.parse(s[1],1,ci);if(!R)return null;if(!sb(W,R.type))return b.concat(1).error(`"${W}" comparisons are not supported for type '${Ki(R.type)}'.`);let I=b.parse(s[2],2,ci);if(!I)return null;if(!sb(W,I.type))return b.concat(2).error(`"${W}" comparisons are not supported for type '${Ki(I.type)}'.`);if(R.type.kind!==I.type.kind&&R.type.kind!=="value"&&I.type.kind!=="value")return b.error(`Cannot compare types '${Ki(R.type)}' and '${Ki(I.type)}'.`);o&&(R.type.kind==="value"&&I.type.kind!=="value"?R=new Dn(I.type,[R]):R.type.kind!=="value"&&I.type.kind==="value"&&(I=new Dn(R.type,[I])));let h=null;if(s.length===4){if(R.type.kind!=="string"&&I.type.kind!=="string"&&R.type.kind!=="value"&&I.type.kind!=="value")return b.error("Cannot use collator to compare non-string types.");if(h=b.parse(s[3],3,nd),!h)return null}return new KR(R,I,h)}evaluate(s){let b=this.lhs.evaluate(s),W=this.rhs.evaluate(s);if(o&&this.hasUntypedArgument){let R=na(b),I=na(W);if(R.kind!==I.kind||R.kind!=="string"&&R.kind!=="number")throw new ga(`Expected arguments for "${n}" to be (string, string) or (number, number), but found (${R.kind}, ${I.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){let R=na(b),I=na(W);if(R.kind!=="string"||I.kind!=="string")return t(s,b,W)}return this.collator?i(s,b,W,this.collator.evaluate(s)):t(s,b,W)}eachChild(s){s(this.lhs),s(this.rhs),this.collator&&s(this.collator)}outputDefined(){return!0}serialize(){let s=[n];return this.eachChild(b=>{s.push(b.serialize())}),s}}}let xp=ls("==",function(n,t,i){return t===i},dh),ch=ls("!=",function(n,t,i){return t!==i},function(n,t,i,o){return!dh(0,t,i,o)}),bh=ls("<",function(n,t,i){return t<i},function(n,t,i,o){return o.compare(t,i)<0}),os=ls(">",function(n,t,i){return t>i},function(n,t,i,o){return o.compare(t,i)>0}),mh=ls("<=",function(n,t,i){return t<=i},function(n,t,i,o){return o.compare(t,i)<=0}),hh=ls(">=",function(n,t,i){return t>=i},function(n,t,i,o){return o.compare(t,i)>=0});class rb{constructor(t,i,o,c,s,b){this.type=oi,this.number=t,this.locale=i,this.currency=o,this.unit=c,this.minFractionDigits=s,this.maxFractionDigits=b}static parse(t,i){if(t.length!==3)return i.error("Expected two arguments.");let o=i.parse(t[1],1,pe);if(!o)return null;let c=t[2];if(typeof c!="object"||Array.isArray(c))return i.error("NumberFormat options argument must be an object.");let s=null;if(c.locale&&(s=i.parseObjectValue(c.locale,2,"locale",oi),!s))return null;let b=null;if(c.currency&&(b=i.parseObjectValue(c.currency,2,"currency",oi),!b))return null;let W=null;if(c.unit&&(W=i.parseObjectValue(c.unit,2,"unit",oi),!W))return null;let R=null;if(c["min-fraction-digits"]&&(R=i.parseObjectValue(c["min-fraction-digits"],2,"min-fraction-digits",pe),!R))return null;let I=null;return c["max-fraction-digits"]&&(I=i.parseObjectValue(c["max-fraction-digits"],2,"max-fraction-digits",pe),!I)?null:new rb(o,s,b,W,R,I)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class cr{constructor(t){this.type=pe,this.input=t}static parse(t,i){if(t.length!==2)return i.error(`Expected 1 argument, but found ${t.length-1} instead.`);let o=i.parse(t[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${Ki(o.type)} instead.`):new cr(o):null}evaluate(t){let i=this.input.evaluate(t);if(typeof i=="string"||Array.isArray(i))return i.length;throw new ga(`Expected value to be of type string or array, but found ${Ki(na(i))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){let t=["length"];return this.eachChild(i=>{t.push(i.serialize())}),t}}function Nd(n){return function(){n=1831565813+(n|=0)|0;let t=Math.imul(n^n>>>15,1|n);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}let ss={"==":xp,"!=":ch,">":os,"<":bh,">=":hh,"<=":mh,array:Dn,at:nb,boolean:Dn,case:dr,coalesce:Fd,collator:sd,format:Do,image:po,in:lb,"index-of":Ud,interpolate:Rn,"interpolate-hcl":Rn,"interpolate-lab":Rn,length:cr,let:Id,literal:On,match:ob,number:Dn,"number-format":rb,object:Dn,slice:xd,step:or,string:Dn,"to-boolean":Jl,"to-color":Jl,"to-number":Jl,"to-string":Jl,var:Ji,within:Ol,distance:Dl,config:as};function ph(n,[t,i,o,c]){t=t.evaluate(n),i=i.evaluate(n),o=o.evaluate(n);let s=c?c.evaluate(n):1,b=zm(t,i,o,s);if(b)throw new ga(b);return new Ri(t/255*s,i/255*s,o/255*s,s)}function db(n,[t,i,o,c]){t=t.evaluate(n),i=i.evaluate(n),o=o.evaluate(n);let s=c?c.evaluate(n):1,b=function(I,h,Z,F){return typeof I=="number"&&I>=0&&I<=360?typeof h=="number"&&h>=0&&h<=100&&typeof Z=="number"&&Z>=0&&Z<=100?F===void 0||typeof F=="number"&&F>=0&&F<=1?null:`Invalid hsla value [${[I,h,Z,F].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof F=="number"?[I,h,Z,F]:[I,h,Z]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof F=="number"?[I,h,Z,F]:[I,h,Z]).join(", ")}]: 'h' must be between 0 and 360.`}(t,i,o,s);if(b)throw new ga(b);let W=`hsla(${t}, ${i}%, ${o}%, ${s})`,R=Ri.parse(W);if(!R)throw new ga(`Failed to parse HSLA color: ${W}`);return R}function cb(n,t){return n in t}function bb(n,t){let i=t[n];return i===void 0?null:i}function go(n){return{type:n}}function Wh(n){return{result:"success",value:n}}function Pl(n){return{result:"error",value:n}}function mb(n,t){return!!n&&!!n.parameters&&n.parameters.indexOf(t)>-1}function Yd(n){return n["property-type"]==="data-driven"}function hb(n){return mb(n.expression,"measure-light")}function uh(n){return mb(n.expression,"zoom")}function pb(n){return!!n.expression&&n.expression.interpolated}function Jd(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function Zh(n){return n}function gh(n,t){let i=t.type==="color",o=n.stops&&typeof n.stops[0][0]=="object",c=o||!(o||n.property!==void 0),s=n.type||(pb(t)?"exponential":"interval");if(i&&((n=wo({},n)).stops&&(n.stops=n.stops.map(I=>[I[0],Ri.parse(I[1])])),n.default=Ri.parse(n.default?n.default:t.default)),n.colorSpace&&n.colorSpace!=="rgb"&&!rh[n.colorSpace])throw new Error(`Unknown color space: ${n.colorSpace}`);let b,W,R;if(s==="exponential")b=Rh;else if(s==="interval")b=Vh;else if(s==="categorical"){b=Np,W=Object.create(null);for(let I of n.stops)W[I[0]]=I[1];R=typeof n.stops[0][0]}else{if(s!=="identity")throw new Error(`Unknown function type "${s}"`);b=Yp}if(o){let I={},h=[];for(let V=0;V<n.stops.length;V++){let G=n.stops[V],N=G[0].zoom;I[N]===void 0&&(I[N]={zoom:N,type:n.type,property:n.property,default:n.default,stops:[]},h.push(N)),I[N].stops.push([G[0].value,G[1]])}let Z=[];for(let V of h)Z.push([I[V].zoom,gh(I[V],t)]);let F={name:"linear"};return{kind:"composite",interpolationType:F,interpolationFactor:Rn.interpolationFactor.bind(void 0,F),zoomStops:Z.map(V=>V[0]),evaluate:({zoom:V},G)=>Rh({stops:Z,base:n.base},t,V).evaluate(V,G)}}if(c){let I=s==="exponential"?{name:"exponential",base:n.base!==void 0?n.base:1}:null;return{kind:"camera",interpolationType:I,interpolationFactor:Rn.interpolationFactor.bind(void 0,I),zoomStops:n.stops.map(h=>h[0]),evaluate:({zoom:h})=>b(n,t,h,W,R)}}return{kind:"source",evaluate(I,h){let Z=h&&h.properties?h.properties[n.property]:void 0;return Z===void 0?br(n.default,t.default):b(n,t,Z,W,R)}}}function br(n,t,i){return n!==void 0?n:t!==void 0?t:i!==void 0?i:void 0}function Np(n,t,i,o,c){return br(typeof i===c?o[i]:void 0,n.default,t.default)}function Vh(n,t,i){if(Wo(i)!=="number")return br(n.default,t.default);let o=n.stops.length;if(o===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[o-1][0])return n.stops[o-1][1];let c=Gd(n.stops.map(s=>s[0]),i);return n.stops[c][1]}function Rh(n,t,i){let o=n.base!==void 0?n.base:1;if(Wo(i)!=="number")return br(n.default,t.default);let c=n.stops.length;if(c===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[c-1][0])return n.stops[c-1][1];let s=Gd(n.stops.map(h=>h[0]),i),b=function(h,Z,F,V){let G=V-F,N=h-F;return G===0?0:Z===1?N/G:(Math.pow(Z,N)-1)/(Math.pow(Z,G)-1)}(i,o,n.stops[s][0],n.stops[s+1][0]),W=n.stops[s][1],R=n.stops[s+1][1],I=ho[t.type]||Zh;if(n.colorSpace&&n.colorSpace!=="rgb"){let h=rh[n.colorSpace];I=(Z,F)=>h.reverse(h.interpolate(h.forward(Z),h.forward(F),b))}return typeof W.evaluate=="function"?{evaluate(...h){let Z=W.evaluate.apply(void 0,h),F=R.evaluate.apply(void 0,h);if(Z!==void 0&&F!==void 0)return I(Z,F,b)}}:I(W,R,b)}function Yp(n,t,i){return t.type==="color"?i=Ri.parse(i):t.type==="formatted"?i=La.fromString(i.toString()):t.type==="resolvedImage"?i=Da.fromString(i.toString()):Wo(i)===t.type||t.type==="enum"&&t.values[i]||(i=void 0),br(i,n.default,t.default)}ln.register(ss,{error:[{kind:"error"},[oi],(n,[t])=>{throw new ga(t.evaluate(n))}],typeof:[oi,[ci],(n,[t])=>Ki(na(t.evaluate(n)))],"to-rgba":[Oa(pe,4),[nn],(n,[t])=>t.evaluate(n).toRenderColor(null).toArray()],rgb:[nn,[pe,pe,pe],ph],rgba:[nn,[pe,pe,pe,pe],ph],hsl:[nn,[pe,pe,pe],db],hsla:[nn,[pe,pe,pe,pe],db],has:{type:si,overloads:[[[oi],(n,[t])=>cb(t.evaluate(n),n.properties())],[[oi,Ea],(n,[t,i])=>cb(t.evaluate(n),i.evaluate(n))]]},get:{type:ci,overloads:[[[oi],(n,[t])=>bb(t.evaluate(n),n.properties())],[[oi,Ea],(n,[t,i])=>bb(t.evaluate(n),i.evaluate(n))]]},"feature-state":[ci,[oi],(n,[t])=>bb(t.evaluate(n),n.featureState||{})],properties:[Ea,[],n=>n.properties()],"geometry-type":[oi,[],n=>n.geometryType()],id:[ci,[],n=>n.id()],zoom:[pe,[],n=>n.globals.zoom],pitch:[pe,[],n=>n.globals.pitch||0],"distance-from-center":[pe,[],n=>n.distanceFromCenter()],"measure-light":[pe,[oi],(n,[t])=>n.measureLight(t.evaluate(n))],"heatmap-density":[pe,[],n=>n.globals.heatmapDensity||0],"line-progress":[pe,[],n=>n.globals.lineProgress||0],"raster-value":[pe,[],n=>n.globals.rasterValue||0],"raster-particle-speed":[pe,[],n=>n.globals.rasterParticleSpeed||0],"sky-radial-progress":[pe,[],n=>n.globals.skyRadialProgress||0],accumulated:[ci,[],n=>n.globals.accumulated===void 0?null:n.globals.accumulated],"+":[pe,go(pe),(n,t)=>{let i=0;for(let o of t)i+=o.evaluate(n);return i}],"*":[pe,go(pe),(n,t)=>{let i=1;for(let o of t)i*=o.evaluate(n);return i}],"-":{type:pe,overloads:[[[pe,pe],(n,[t,i])=>t.evaluate(n)-i.evaluate(n)],[[pe],(n,[t])=>-t.evaluate(n)]]},"/":[pe,[pe,pe],(n,[t,i])=>t.evaluate(n)/i.evaluate(n)],"%":[pe,[pe,pe],(n,[t,i])=>t.evaluate(n)%i.evaluate(n)],ln2:[pe,[],()=>Math.LN2],pi:[pe,[],()=>Math.PI],e:[pe,[],()=>Math.E],"^":[pe,[pe,pe],(n,[t,i])=>Math.pow(t.evaluate(n),i.evaluate(n))],sqrt:[pe,[pe],(n,[t])=>Math.sqrt(t.evaluate(n))],log10:[pe,[pe],(n,[t])=>Math.log(t.evaluate(n))/Math.LN10],ln:[pe,[pe],(n,[t])=>Math.log(t.evaluate(n))],log2:[pe,[pe],(n,[t])=>Math.log(t.evaluate(n))/Math.LN2],sin:[pe,[pe],(n,[t])=>Math.sin(t.evaluate(n))],cos:[pe,[pe],(n,[t])=>Math.cos(t.evaluate(n))],tan:[pe,[pe],(n,[t])=>Math.tan(t.evaluate(n))],asin:[pe,[pe],(n,[t])=>Math.asin(t.evaluate(n))],acos:[pe,[pe],(n,[t])=>Math.acos(t.evaluate(n))],atan:[pe,[pe],(n,[t])=>Math.atan(t.evaluate(n))],min:[pe,go(pe),(n,t)=>Math.min(...t.map(i=>i.evaluate(n)))],max:[pe,go(pe),(n,t)=>Math.max(...t.map(i=>i.evaluate(n)))],abs:[pe,[pe],(n,[t])=>Math.abs(t.evaluate(n))],round:[pe,[pe],(n,[t])=>{let i=t.evaluate(n);return i<0?-Math.round(-i):Math.round(i)}],floor:[pe,[pe],(n,[t])=>Math.floor(t.evaluate(n))],ceil:[pe,[pe],(n,[t])=>Math.ceil(t.evaluate(n))],"filter-==":[si,[oi,ci],(n,[t,i])=>n.properties()[t.value]===i.value],"filter-id-==":[si,[ci],(n,[t])=>n.id()===t.value],"filter-type-==":[si,[oi],(n,[t])=>n.geometryType()===t.value],"filter-<":[si,[oi,ci],(n,[t,i])=>{let o=n.properties()[t.value],c=i.value;return typeof o==typeof c&&o<c}],"filter-id-<":[si,[ci],(n,[t])=>{let i=n.id(),o=t.value;return typeof i==typeof o&&i<o}],"filter->":[si,[oi,ci],(n,[t,i])=>{let o=n.properties()[t.value],c=i.value;return typeof o==typeof c&&o>c}],"filter-id->":[si,[ci],(n,[t])=>{let i=n.id(),o=t.value;return typeof i==typeof o&&i>o}],"filter-<=":[si,[oi,ci],(n,[t,i])=>{let o=n.properties()[t.value],c=i.value;return typeof o==typeof c&&o<=c}],"filter-id-<=":[si,[ci],(n,[t])=>{let i=n.id(),o=t.value;return typeof i==typeof o&&i<=o}],"filter->=":[si,[oi,ci],(n,[t,i])=>{let o=n.properties()[t.value],c=i.value;return typeof o==typeof c&&o>=c}],"filter-id->=":[si,[ci],(n,[t])=>{let i=n.id(),o=t.value;return typeof i==typeof o&&i>=o}],"filter-has":[si,[ci],(n,[t])=>t.value in n.properties()],"filter-has-id":[si,[],n=>n.id()!==null&&n.id()!==void 0],"filter-type-in":[si,[Oa(oi)],(n,[t])=>t.value.indexOf(n.geometryType())>=0],"filter-id-in":[si,[Oa(ci)],(n,[t])=>t.value.indexOf(n.id())>=0],"filter-in-small":[si,[oi,Oa(ci)],(n,[t,i])=>i.value.indexOf(n.properties()[t.value])>=0],"filter-in-large":[si,[oi,Oa(ci)],(n,[t,i])=>function(o,c,s,b){for(;s<=b;){let W=s+b>>1;if(c[W]===o)return!0;c[W]>o?b=W-1:s=W+1}return!1}(n.properties()[t.value],i.value,0,i.value.length-1)],all:{type:si,overloads:[[[si,si],(n,[t,i])=>t.evaluate(n)&&i.evaluate(n)],[go(si),(n,t)=>{for(let i of t)if(!i.evaluate(n))return!1;return!0}]]},any:{type:si,overloads:[[[si,si],(n,[t,i])=>t.evaluate(n)||i.evaluate(n)],[go(si),(n,t)=>{for(let i of t)if(i.evaluate(n))return!0;return!1}]]},"!":[si,[si],(n,[t])=>!t.evaluate(n)],"is-supported-script":[si,[oi],(n,[t])=>{let i=n.globals&&n.globals.isSupportedScript;return!i||i(t.evaluate(n))}],upcase:[oi,[oi],(n,[t])=>t.evaluate(n).toUpperCase()],downcase:[oi,[oi],(n,[t])=>t.evaluate(n).toLowerCase()],concat:[oi,go(ci),(n,t)=>t.map(i=>_a(i.evaluate(n))).join("")],"resolved-locale":[oi,[nd],(n,[t])=>t.evaluate(n).resolvedLocale()],random:[pe,[pe,pe,ci],(n,t)=>{let[i,o,c]=t.map(b=>b.evaluate(n));if(i>o||i===o)return i;let s;if(typeof c=="string")s=function(b){let W=0;if(b.length===0)return W;for(let R=0;R<b.length;R++)W=(W<<5)-W+b.charCodeAt(R),W|=0;return W}(c);else{if(typeof c!="number")throw new ga(`Invalid seed input: ${c}`);s=c}return i+Nd(s)()*(o-i)}]});class Xd{constructor(t,i,o,c){this.expression=t,this._warningHistory={},this._evaluator=new wm(o,c),this._defaultValue=i?function(s){return s.type==="color"&&(Jd(s.default)||Array.isArray(s.default))?new Ri(0,0,0,0):s.type==="color"?Ri.parse(s.default)||null:s.default===void 0?null:s.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null}evaluateWithoutErrorHandling(t,i,o,c,s,b,W,R){return this._evaluator.globals=t,this._evaluator.feature=i,this._evaluator.featureState=o,this._evaluator.canonical=c||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=b,this._evaluator.featureTileCoord=W||null,this._evaluator.featureDistanceData=R||null,this.expression.evaluate(this._evaluator)}evaluate(t,i,o,c,s,b,W,R){this._evaluator.globals=t,this._evaluator.feature=i||null,this._evaluator.featureState=o||null,this._evaluator.canonical=c||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=b||null,this._evaluator.featureTileCoord=W||null,this._evaluator.featureDistanceData=R||null;try{let I=this.expression.evaluate(this._evaluator);if(I==null||typeof I=="number"&&I!=I)return this._defaultValue;if(this._enumValues&&!(I in this._enumValues))throw new ga(`Expected value to be one of ${Object.keys(this._enumValues).map(h=>JSON.stringify(h)).join(", ")}, but found ${JSON.stringify(I)} instead.`);return I}catch(I){return this._warningHistory[I.message]||(this._warningHistory[I.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${I.message}`)),this._defaultValue}}}function yd(n){return Array.isArray(n)&&n.length>0&&typeof n[0]=="string"&&n[0]in ss}function mr(n,t,i,o){let c=new eh(ss,[],t?function(b){let W={color:nn,string:oi,number:pe,enum:oi,boolean:si,formatted:Ao,resolvedImage:Ho};return b.type==="array"?Oa(W[b.value]||ci,b.length):W[b.type]}(t):void 0,void 0,void 0,i,o),s=c.parse(n,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return s?Wh(new Xd(s,t,i,o)):Pl(c.errors)}class Wb{constructor(t,i,o){this.kind=t,this._styleExpression=i,this.isLightConstant=o,this.isStateDependent=t!=="constant"&&!Vd(i.expression),this.configDependencies=Rd(i.expression)}evaluateWithoutErrorHandling(t,i,o,c,s,b){return this._styleExpression.evaluateWithoutErrorHandling(t,i,o,c,s,b)}evaluate(t,i,o,c,s,b){return this._styleExpression.evaluate(t,i,o,c,s,b)}}class dl{constructor(t,i,o,c,s){this.kind=t,this.zoomStops=o,this._styleExpression=i,this.isStateDependent=t!=="camera"&&!Vd(i.expression),this.isLightConstant=s,this.configDependencies=Rd(i.expression),this.interpolationType=c}evaluateWithoutErrorHandling(t,i,o,c,s,b){return this._styleExpression.evaluateWithoutErrorHandling(t,i,o,c,s,b)}evaluate(t,i,o,c,s,b){return this._styleExpression.evaluate(t,i,o,c,s,b)}interpolationFactor(t,i,o){return this.interpolationType?Rn.interpolationFactor(this.interpolationType,t,i,o):0}}function Gh(n,t,i,o){if((n=mr(n,t,i,o)).result==="error")return n;let c=n.value.expression,s=nr(c);if(!s&&!Yd(t))return Pl([new sl("","data expressions not supported")]);let b=lr(c,["zoom","pitch","distance-from-center"]);if(!b&&!uh(t))return Pl([new sl("","zoom expressions not supported")]);let W=lr(c,["measure-light"]);if(!W&&!hb(t))return Pl([new sl("","measure-light expression not supported")]);let R=t.expression&&t.expression.relaxZoomRestriction,I=Md(c);return I||b||R?I instanceof sl?Pl([I]):I instanceof Rn&&!pb(t)?Pl([new sl("",'"interpolate" expressions cannot be used with this property')]):Wh(I?new dl(s?"camera":"composite",n.value,I.labels,I instanceof Rn?I.interpolation:void 0,W):new Wb(s?"constant":"source",n.value,W)):Pl([new sl("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Bd{constructor(t,i){this._parameters=t,this._specification=i,wo(this,gh(this._parameters,this._specification))}static deserialize(t){return new Bd(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function Md(n){let t=null;if(n instanceof Id)t=Md(n.result);else if(n instanceof Fd){for(let i of n.args)if(t=Md(i),t)break}else(n instanceof or||n instanceof Rn)&&n.input instanceof ln&&n.input.name==="zoom"&&(t=n);return t instanceof sl||n.eachChild(i=>{let o=Md(i);o instanceof sl?t=o:t&&o&&t!==o&&(t=new sl("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}var Td,ub,Fh=function(){if(ub)return Td;ub=1,Td=t;var n=3;function t(i,o,c){var s=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var b=new Int32Array(this.arrayBuffer);i=b[0],this.d=(o=b[1])+2*(c=b[2]);for(var W=0;W<this.d*this.d;W++){var R=b[n+W],I=b[n+W+1];s.push(R===I?null:b.subarray(R,I))}var h=b[n+s.length+1];this.keys=b.subarray(b[n+s.length],h),this.bboxes=b.subarray(h),this.insert=this._insertReadonly}else{this.d=o+2*c;for(var Z=0;Z<this.d*this.d;Z++)s.push([]);this.keys=[],this.bboxes=[]}this.n=o,this.extent=i,this.padding=c,this.scale=o/i,this.uid=0;var F=c/o*i;this.min=-F,this.max=i+F}return t.prototype.insert=function(i,o,c,s,b){this._forEachCell(o,c,s,b,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(o),this.bboxes.push(c),this.bboxes.push(s),this.bboxes.push(b)},t.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},t.prototype._insertCell=function(i,o,c,s,b,W){this.cells[b].push(W)},t.prototype.query=function(i,o,c,s,b){var W=this.min,R=this.max;if(i<=W&&o<=W&&R<=c&&R<=s&&!b)return Array.prototype.slice.call(this.keys);var I=[];return this._forEachCell(i,o,c,s,this._queryCell,I,{},b),I},t.prototype._queryCell=function(i,o,c,s,b,W,R,I){var h=this.cells[b];if(h!==null)for(var Z=this.keys,F=this.bboxes,V=0;V<h.length;V++){var G=h[V];if(R[G]===void 0){var N=4*G;(I?I(F[N+0],F[N+1],F[N+2],F[N+3]):i<=F[N+2]&&o<=F[N+3]&&c>=F[N+0]&&s>=F[N+1])?(R[G]=!0,W.push(Z[G])):R[G]=!1}}},t.prototype._forEachCell=function(i,o,c,s,b,W,R,I){for(var h=this._convertToCellCoord(i),Z=this._convertToCellCoord(o),F=this._convertToCellCoord(c),V=this._convertToCellCoord(s),G=h;G<=F;G++)for(var N=Z;N<=V;N++){var X=this.d*N+G;if((!I||I(this._convertFromCellCoord(G),this._convertFromCellCoord(N),this._convertFromCellCoord(G+1),this._convertFromCellCoord(N+1)))&&b.call(this,i,o,c,s,X,W,R,I))return}},t.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},t.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},t.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,o=n+this.cells.length+1+1,c=0,s=0;s<this.cells.length;s++)c+=this.cells[s].length;var b=new Int32Array(o+c+this.keys.length+this.bboxes.length);b[0]=this.extent,b[1]=this.n,b[2]=this.padding;for(var W=o,R=0;R<i.length;R++){var I=i[R];b[n+R]=W,b.set(I,W),W+=I.length}return b[n+i.length]=W,b.set(this.keys,W),b[n+i.length+1]=W+=this.keys.length,b.set(this.bboxes,W),W+=this.bboxes.length,b.buffer},Td}(),Vo=lt(Fh);let rs={};function he(n,t,i={}){Object.defineProperty(n,"_classRegistryKey",{value:t,writable:!1}),rs[t]={klass:n,omit:i.omit||[]}}he(Object,"Object"),Vo.serialize=function(n,t){let i=n.toArrayBuffer();return t&&t.add(i),{buffer:i}},Vo.deserialize=function(n){return new Vo(n.buffer)},Object.defineProperty(Vo,"name",{value:"Grid"}),he(Vo,"Grid"),he(Ri,"Color"),he(Error,"Error"),he(La,"Formatted"),he(un,"FormattedSection"),he(Cc,"AJAXError"),he(Da,"ResolvedImage"),he(Bd,"StylePropertyFunction"),he(Xd,"StyleExpression",{omit:["_evaluator"]}),he(dl,"ZoomDependentExpression"),he(Wb,"ZoomConstantExpression"),he(ln,"CompoundExpression",{omit:["_evaluate"]});for(let n in ss)rs[ss[n]._classRegistryKey]||he(ss[n],`Expression${n}`);function Zb(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function Ih(n){return self.ImageBitmap&&n instanceof ImageBitmap}function on(n,t){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp)return n;if(Zb(n)||Ih(n))return t&&t.add(n),n;if(ArrayBuffer.isView(n)){let i=n;return t&&t.add(i.buffer),i}if(n instanceof ImageData)return t&&t.add(n.data.buffer),n;if(Array.isArray(n)){let i=[];for(let o of n)i.push(on(o,t));return i}if(n instanceof Map){let i={$name:"Map"};for(let[o,c]of n.entries())i[o]=on(c);return i}if(n instanceof Set){let i={$name:"Set"},o=0;for(let c of n.values())i[++o]=on(c);return i}if(typeof n=="object"){let i=n.constructor,o=i._classRegistryKey;if(!o)throw new Error(`can't serialize object of unregistered class ${o}`);let c=i.serialize?i.serialize(n,t):{};if(!i.serialize){for(let s in n)n.hasOwnProperty(s)&&(rs[o].omit.indexOf(s)>=0||(c[s]=on(n[s],t)));n instanceof Error&&(c.message=n.message)}if(c.$name)throw new Error("$name property is reserved for worker serialization logic.");return o!=="Object"&&(c.$name=o),c}throw new Error("can't serialize object of type "+typeof n)}function Ro(n){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp||Zb(n)||Ih(n)||ArrayBuffer.isView(n)||n instanceof ImageData)return n;if(Array.isArray(n))return n.map(Ro);if(typeof n=="object"){let t=n.$name||"Object";if(t==="Map"){let c=new Map;for(let s of Object.keys(n))s!=="$name"&&c.set(s,Ro(n[s]));return c}if(t==="Set"){let c=new Set;for(let s of Object.keys(n))s!=="$name"&&c.add(Ro(n[s]));return c}let{klass:i}=rs[t];if(!i)throw new Error(`can't deserialize unregistered class ${t}`);if(i.deserialize)return i.deserialize(n);let o=Object.create(i.prototype);for(let c of Object.keys(n))c!=="$name"&&(o[c]=Ro(n[c]));return o}throw new Error("can't deserialize object of type "+typeof n)}let Ge={"Latin-1 Supplement":n=>n>=128&&n<=255,Arabic:n=>n>=1536&&n<=1791,"Arabic Supplement":n=>n>=1872&&n<=1919,"Arabic Extended-A":n=>n>=2208&&n<=2303,"Hangul Jamo":n=>n>=4352&&n<=4607,"Unified Canadian Aboriginal Syllabics":n=>n>=5120&&n<=5759,Khmer:n=>n>=6016&&n<=6143,"Unified Canadian Aboriginal Syllabics Extended":n=>n>=6320&&n<=6399,"General Punctuation":n=>n>=8192&&n<=8303,"Letterlike Symbols":n=>n>=8448&&n<=8527,"Number Forms":n=>n>=8528&&n<=8591,"Miscellaneous Technical":n=>n>=8960&&n<=9215,"Control Pictures":n=>n>=9216&&n<=9279,"Optical Character Recognition":n=>n>=9280&&n<=9311,"Enclosed Alphanumerics":n=>n>=9312&&n<=9471,"Geometric Shapes":n=>n>=9632&&n<=9727,"Miscellaneous Symbols":n=>n>=9728&&n<=9983,"Miscellaneous Symbols and Arrows":n=>n>=11008&&n<=11263,"CJK Radicals Supplement":n=>n>=11904&&n<=12031,"Kangxi Radicals":n=>n>=12032&&n<=12255,"Ideographic Description Characters":n=>n>=12272&&n<=12287,"CJK Symbols and Punctuation":n=>n>=12288&&n<=12351,Hiragana:n=>n>=12352&&n<=12447,Katakana:n=>n>=12448&&n<=12543,Bopomofo:n=>n>=12544&&n<=12591,"Hangul Compatibility Jamo":n=>n>=12592&&n<=12687,Kanbun:n=>n>=12688&&n<=12703,"Bopomofo Extended":n=>n>=12704&&n<=12735,"CJK Strokes":n=>n>=12736&&n<=12783,"Katakana Phonetic Extensions":n=>n>=12784&&n<=12799,"Enclosed CJK Letters and Months":n=>n>=12800&&n<=13055,"CJK Compatibility":n=>n>=13056&&n<=13311,"CJK Unified Ideographs Extension A":n=>n>=13312&&n<=19903,"Yijing Hexagram Symbols":n=>n>=19904&&n<=19967,"CJK Unified Ideographs":n=>n>=19968&&n<=40959,"Yi Syllables":n=>n>=40960&&n<=42127,"Yi Radicals":n=>n>=42128&&n<=42191,"Hangul Jamo Extended-A":n=>n>=43360&&n<=43391,"Hangul Syllables":n=>n>=44032&&n<=55215,"Hangul Jamo Extended-B":n=>n>=55216&&n<=55295,"Private Use Area":n=>n>=57344&&n<=63743,"CJK Compatibility Ideographs":n=>n>=63744&&n<=64255,"Arabic Presentation Forms-A":n=>n>=64336&&n<=65023,"Vertical Forms":n=>n>=65040&&n<=65055,"CJK Compatibility Forms":n=>n>=65072&&n<=65103,"Small Form Variants":n=>n>=65104&&n<=65135,"Arabic Presentation Forms-B":n=>n>=65136&&n<=65279,"Halfwidth and Fullwidth Forms":n=>n>=65280&&n<=65519,"CJK Unified Ideographs Extension B":n=>n>=131072&&n<=173791};function Cd(n){for(let t of n)if(Sd(t.charCodeAt(0)))return!0;return!1}function Jp(n){for(let t of n)if(!kd(t.charCodeAt(0)))return!1;return!0}function kd(n){return!(Ge.Arabic(n)||Ge["Arabic Supplement"](n)||Ge["Arabic Extended-A"](n)||Ge["Arabic Presentation Forms-A"](n)||Ge["Arabic Presentation Forms-B"](n))}function Sd(n){return!(n!==746&&n!==747&&(n<4352||!(Ge["Bopomofo Extended"](n)||Ge.Bopomofo(n)||Ge["CJK Compatibility Forms"](n)&&!(n>=65097&&n<=65103)||Ge["CJK Compatibility Ideographs"](n)||Ge["CJK Compatibility"](n)||Ge["CJK Radicals Supplement"](n)||Ge["CJK Strokes"](n)||!(!Ge["CJK Symbols and Punctuation"](n)||n>=12296&&n<=12305||n>=12308&&n<=12319||n===12336)||Ge["CJK Unified Ideographs Extension A"](n)||Ge["CJK Unified Ideographs"](n)||Ge["Enclosed CJK Letters and Months"](n)||Ge["Hangul Compatibility Jamo"](n)||Ge["Hangul Jamo Extended-A"](n)||Ge["Hangul Jamo Extended-B"](n)||Ge["Hangul Jamo"](n)||Ge["Hangul Syllables"](n)||Ge.Hiragana(n)||Ge["Ideographic Description Characters"](n)||Ge.Kanbun(n)||Ge["Kangxi Radicals"](n)||Ge["Katakana Phonetic Extensions"](n)||Ge.Katakana(n)&&n!==12540||!(!Ge["Halfwidth and Fullwidth Forms"](n)||n===65288||n===65289||n===65293||n>=65306&&n<=65310||n===65339||n===65341||n===65343||n>=65371&&n<=65503||n===65507||n>=65512&&n<=65519)||!(!Ge["Small Form Variants"](n)||n>=65112&&n<=65118||n>=65123&&n<=65126)||Ge["Unified Canadian Aboriginal Syllabics"](n)||Ge["Unified Canadian Aboriginal Syllabics Extended"](n)||Ge["Vertical Forms"](n)||Ge["Yijing Hexagram Symbols"](n)||Ge["Yi Syllables"](n)||Ge["Yi Radicals"](n))))}function hr(n){return!(Sd(n)||function(t){return!!(Ge["Latin-1 Supplement"](t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||Ge["General Punctuation"](t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||Ge["Letterlike Symbols"](t)||Ge["Number Forms"](t)||Ge["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||Ge["Control Pictures"](t)&&t!==9251||Ge["Optical Character Recognition"](t)||Ge["Enclosed Alphanumerics"](t)||Ge["Geometric Shapes"](t)||Ge["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||Ge["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||Ge["CJK Symbols and Punctuation"](t)||Ge.Katakana(t)||Ge["Private Use Area"](t)||Ge["CJK Compatibility Forms"](t)||Ge["Small Form Variants"](t)||Ge["Halfwidth and Fullwidth Forms"](t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(n))}function gb(n){return n>=1424&&n<=2303||Ge["Arabic Presentation Forms-A"](n)||Ge["Arabic Presentation Forms-B"](n)}function Xp(n,t){return!(!t&&gb(n)||n>=2304&&n<=3583||n>=3840&&n<=4255||Ge.Khmer(n))}function yp(n){for(let t of n)if(gb(t.charCodeAt(0)))return!0;return!1}let pr="deferred",Wr="loading",Qd="loaded",ds=null,Ia="unavailable",Kl=null,Uh=function(n){n&&typeof n=="string"&&n.indexOf("NetworkError")>-1&&(Ia="error"),ds&&ds(n)};function Vb(){Rb.fire(new Hl("pluginStateChange",{pluginStatus:Ia,pluginURL:Kl}))}let Rb=new zo,Gb=function(){return Ia},Fb=function(){if(Ia!==pr||!Kl)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Ia=Wr,Vb(),Kl&&Eo({url:Kl},n=>{n?Uh(n):(Ia=Qd,Vb())})},sn={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Ia===Qd||sn.applyArabicShaping!=null,isLoading:()=>Ia===Wr,setState(n){Ia=n.pluginStatus,Kl=n.pluginURL},isParsed:()=>sn.applyArabicShaping!=null&&sn.processBidirectionalText!=null&&sn.processStyledBidirectionalText!=null,getPluginURL:()=>Kl};class ji{constructor(t,i){this.zoom=t,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(t){return function(i,o){for(let c of i)if(!Xp(c.charCodeAt(0),o))return!1;return!0}(t,sn.isLoaded())}}class fd{constructor(t,i,o,c){this.property=t,this.value=i,this.expression=function(s,b,W,R){if(Jd(s))return new Bd(s,b);if(yd(s)||Array.isArray(s)&&s.length>0){let I=Gh(s,b,W,R);if(I.result==="error")throw new Error(I.value.map(h=>`${h.key}: ${h.message}`).join(", "));return I.value}{let I=s;return typeof s=="string"&&b.type==="color"&&(I=Ri.parse(s)),{kind:"constant",configDependencies:new Set,evaluate:()=>I}}}(i===void 0?t.specification.default:i,t.specification,o,c)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,i,o){return this.property.possiblyEvaluate(this,t,i,o)}}class Ib{constructor(t,i,o){this.property=t,this.value=new fd(t,void 0,i,o)}transitioned(t,i){return new Nh(this.property,this.value,i,Fa({},t.transition,this.transition),t.now)}untransitioned(){return new Nh(this.property,this.value,null,{},0)}}class xh{constructor(t,i,o){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues),this._scope=i,this._options=o,this.configDependencies=new Set}getValue(t){return Xn(this._values[t].value.value)}setValue(t,i){this._values.hasOwnProperty(t)||(this._values[t]=new Ib(this._values[t].property,this._scope,this._options)),this._values[t].value=new fd(this._values[t].property,i===null?void 0:Xn(i),this._scope,this._options),this._values[t].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[t].value.expression.configDependencies]))}setTransitionOrValue(t,i){i&&(this._options=i);let o=this._properties.properties;if(t)for(let c in t){let s=t[c];if(Nl(c,"-transition")){let b=c.slice(0,-11);o[b]&&this.setTransition(b,s)}else o.hasOwnProperty(c)&&this.setValue(c,s)}}getTransition(t){return Xn(this._values[t].transition)}setTransition(t,i){this._values.hasOwnProperty(t)||(this._values[t]=new Ib(this._values[t].property)),this._values[t].transition=Xn(i)||void 0}serialize(){let t={};for(let i of Object.keys(this._values)){let o=this.getValue(i);o!==void 0&&(t[i]=o);let c=this.getTransition(i);c!==void 0&&(t[`${i}-transition`]=c)}return t}transitioned(t,i){let o=new Yh(this._properties);for(let c of Object.keys(this._values))o._values[c]=this._values[c].transitioned(t,i._values[c]);return o}untransitioned(){let t=new Yh(this._properties);for(let i of Object.keys(this._values))t._values[i]=this._values[i].untransitioned();return t}}class Nh{constructor(t,i,o,c,s){let b=c.delay||0,W=c.duration||0;s=s||0,this.property=t,this.value=i,this.begin=s+b,this.end=this.begin+W,t.specification.transition&&(c.delay||c.duration)&&(this.prior=o)}possiblyEvaluate(t,i,o){let c=t.now||0,s=this.value.possiblyEvaluate(t,i,o),b=this.prior;if(b){if(c>this.end)return this.prior=null,s;if(this.value.isDataDriven())return this.prior=null,s;if(c<this.begin)return b.possiblyEvaluate(t,i,o);{let W=(c-this.begin)/(this.end-this.begin);return this.property.interpolate(b.possiblyEvaluate(t,i,o),s,Ul(W))}}return s}}class Yh{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,i,o){let c=new bs(this._properties);for(let s of Object.keys(this._values))c._values[s]=this._values[s].possiblyEvaluate(t,i,o);return c}hasTransition(){for(let t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class Bp{constructor(t,i,o){this._properties=t,this._values=Object.create(t.defaultPropertyValues),this._scope=i,this._options=o,this.configDependencies=new Set}getValue(t){return Xn(this._values[t].value)}setValue(t,i){this._values[t]=new fd(this._values[t].property,i===null?void 0:Xn(i),this._scope,this._options),this._values[t].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[t].expression.configDependencies]))}serialize(){let t={};for(let i of Object.keys(this._values)){let o=this.getValue(i);o!==void 0&&(t[i]=o)}return t}possiblyEvaluate(t,i,o){let c=new bs(this._properties);for(let s of Object.keys(this._values))c._values[s]=this._values[s].possiblyEvaluate(t,i,o);return c}}class cs{constructor(t,i,o){this.property=t,this.value=i,this.parameters=o}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,i,o,c){return this.property.evaluate(this.value,this.parameters,t,i,o,c)}}class bs{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class te{constructor(t){this.specification=t}possiblyEvaluate(t,i){return t.expression.evaluate(i)}interpolate(t,i,o){let c=ho[this.specification.type];return c?c(t,i,o):t}}class Ie{constructor(t,i){this.specification=t,this.overrides=i}possiblyEvaluate(t,i,o,c){return new cs(this,t.expression.kind==="constant"||t.expression.kind==="camera"?{kind:"constant",value:t.expression.evaluate(i,null,{},o,c)}:t.expression,i)}interpolate(t,i,o){if(t.value.kind!=="constant"||i.value.kind!=="constant")return t;if(t.value.value===void 0||i.value.value===void 0)return new cs(this,{kind:"constant",value:void 0},t.parameters);let c=ho[this.specification.type];return c?new cs(this,{kind:"constant",value:c(t.value.value,i.value.value,o)},t.parameters):t}evaluate(t,i,o,c,s,b){return t.kind==="constant"?t.value:t.evaluate(i,o,c,s,b)}}class _n{constructor(t){this.specification=t}possiblyEvaluate(t,i,o,c){return!!t.expression.evaluate(i,null,{},o,c)}interpolate(){return!1}}class Ei{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let i=new ji(0,{});for(let o in t){let c=t[o];c.specification.overridable&&this.overridableProperties.push(o);let s=this.defaultPropertyValues[o]=new fd(c,void 0),b=this.defaultTransitionablePropertyValues[o]=new Ib(c);this.defaultTransitioningPropertyValues[o]=b.untransitioned(),this.defaultPossiblyEvaluatedValues[o]=s.possiblyEvaluate(i)}}}he(Ie,"DataDrivenProperty"),he(te,"DataConstantProperty"),he(_n,"ColorRampProperty");var Xt=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"selectors":{"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"type":"string","required":true},"properties":{"type":"selectorProperty","required":false},"featureNamespace":{"type":"string","required":false}},"selectorProperty":{"experimental":true,"*":{"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{"experimental":true}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant","experimental":true},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant","experimental":true}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function ur(n){return n instanceof Number||n instanceof String||n instanceof Boolean?n.valueOf():n}function vd(n){if(Array.isArray(n))return n.map(vd);if(n instanceof Object&&!(n instanceof Number||n instanceof String||n instanceof Boolean)){let t={};for(let i in n)t[i]=vd(n[i]);return t}return ur(n)}function Ub(n){if(n===!0||n===!1)return!0;if(!Array.isArray(n)||n.length===0)return!1;switch(n[0]){case"has":return n.length>=2&&n[1]!=="$id"&&n[1]!=="$type";case"in":return n.length>=3&&(typeof n[1]!="string"||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return n.length!==3||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(let t of n.slice(1))if(!Ub(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}function Pn(n,t="",i=null,o="fill"){if(n==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Ub(n)||(n=Ed(n));let c=n,s=!0;try{s=function(Z){if(!ms(Z))return Z;let F=vd(Z);return Go(F),F=xb(F),F}(c)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(c,null,2)}
        `)}let b=Xt[`filter_${o}`],W=mr(s,b,t,i),R=null;if(W.result==="error")throw new Error(W.value.map(Z=>`${Z.key}: ${Z.message}`).join(", "));R=(Z,F,V)=>W.value.evaluate(Z,F,{},V);let I=null,h=null;if(s!==c){let Z=mr(c,b,t,i);if(Z.result==="error")throw new Error(Z.value.map(F=>`${F.key}: ${F.message}`).join(", "));I=(F,V,G,N,X)=>Z.value.evaluate(F,V,{},G,void 0,void 0,N,X),h=!nr(Z.value.expression)}return{filter:R,dynamicFilter:I||void 0,needGeometry:Jh(s),needFeature:!!h}}function xb(n){if(!Array.isArray(n))return n;let t=function(i){if(Mp.has(i[0])){for(let o=1;o<i.length;o++)if(ms(i[o]))return!0}return i}(n);return t===!0?t:t.map(i=>xb(i))}function Go(n){let t=!1,i=[];if(n[0]==="case"){for(let o=1;o<n.length-1;o+=2)t=t||ms(n[o]),i.push(n[o+1]);i.push(n[n.length-1])}else if(n[0]==="match"){t=t||ms(n[1]);for(let o=2;o<n.length-1;o+=2)i.push(n[o+1]);i.push(n[n.length-1])}else if(n[0]==="step"){t=t||ms(n[1]);for(let o=1;o<n.length-1;o+=2)i.push(n[o+1])}t&&(n.length=0,n.push("any",...i));for(let o=1;o<n.length;o++)Go(n[o])}function ms(n){if(!Array.isArray(n))return!1;if((t=n[0])==="pitch"||t==="distance-from-center")return!0;var t;for(let i=1;i<n.length;i++)if(ms(n[i]))return!0;return!1}let Mp=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Tp(n,t){return n<t?-1:n>t?1:0}function Jh(n){if(!Array.isArray(n))return!1;if(n[0]==="within"||n[0]==="distance")return!0;for(let t=1;t<n.length;t++)if(Jh(n[t]))return!0;return!1}function Ed(n){if(!n)return!0;let t=n[0];return n.length<=1?t!=="any":t==="=="?Ld(n[1],n[2],"=="):t==="!="?gr(Ld(n[1],n[2],"==")):t==="<"||t===">"||t==="<="||t===">="?Ld(n[1],n[2],t):t==="any"?(i=n.slice(1),["any"].concat(i.map(Ed))):t==="all"?["all"].concat(n.slice(1).map(Ed)):t==="none"?["all"].concat(n.slice(1).map(Ed).map(gr)):t==="in"?zd(n[1],n.slice(2)):t==="!in"?gr(zd(n[1],n.slice(2))):t==="has"?Zr(n[1]):t!=="!has"||gr(Zr(n[1]));var i}function Ld(n,t,i){switch(n){case"$type":return[`filter-type-${i}`,t];case"$id":return[`filter-id-${i}`,t];default:return[`filter-${i}`,n,t]}}function zd(n,t){if(t.length===0)return!1;switch(n){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(i=>typeof i!=typeof t[0])?["filter-in-large",n,["literal",t.sort(Tp)]]:["filter-in-small",n,["literal",t]]}}function Zr(n){switch(n){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",n]}}function gr(n){return["!",n]}let hs="";function Xh(n,t){return t?`${n}${hs}${t}`:n}let Kn="-transition",Cp=new Set(["fill","line","background","hillshade","raster"]);class za extends zo{constructor(t,i,o,c,s){if(super(),this.id=t.id,this.fqid=Xh(this.id,o),this.type=t.type,this.scope=o,this.lut=c,this.options=s,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,t.type!=="custom"&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type!=="background"&&t.type!=="sky"&&t.type!=="slot"&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),t.slot&&(this.slot=t.slot),i.layout&&(this._unevaluatedLayout=new Bp(i.layout,this.scope,s),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint)){this._transitionablePaint=new xh(i.paint,this.scope,s);for(let b in t.paint)this.setPaintProperty(b,t.paint[b]);for(let b in t.layout)this.setLayoutProperty(b,t.layout[b]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new bs(i.paint)}}onAdd(t){}onRemove(t){}isDraped(t){return!this.is3D()&&Cp.has(this.type)}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,i){if(this.type==="custom"&&t==="visibility")return void(this.visibility=i);let o=this._unevaluatedLayout;o._properties.properties[t]&&(o.setValue(t,i),this.configDependencies=new Set([...this.configDependencies,...o.configDependencies]),t==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(t){return Nl(t,Kn)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}setPaintProperty(t,i){let o=this._transitionablePaint,c=o._properties.properties;if(Nl(t,Kn)){let Z=t.slice(0,-11);return c[Z]&&o.setTransition(Z,i||void 0),!1}if(!c[t])return!1;let s=o._values[t],b=s.value.isDataDriven(),W=s.value;o.setValue(t,i),this.configDependencies=new Set([...this.configDependencies,...o.configDependencies]),this._handleSpecialPaintPropertyUpdate(t);let R=o._values[t].value,I=R.isDataDriven(),h=Nl(t,"pattern")||t==="line-dasharray";return I||b||h||this._handleOverridablePaintPropertyUpdate(t,W,R)}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getDefaultProgramParams(t,i,o){return null}_handleOverridablePaintPropertyUpdate(t,i,o){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,i)}serialize(){return So({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(t,i)=>!(t===void 0||i==="layout"&&!Object.keys(t).length||i==="paint"&&!Object.keys(t).length))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(let t in this.paint._values){let i=this.paint.get(t);if(i instanceof cs&&Yd(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(t){this._filterCompiled||(this._featureFilter=Pn(this.filter,this.scope,t),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(t){this._stats&&(t.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(t){}queryIntersectsFeature(t,i,o,c,s,b,W,R,I){}queryIntersectsMatchingFeature(t,i,o,c){}}let kp={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Vr{constructor(t,i){this._structArray=t,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class fi{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,i){return t._trim(),i&&(t.isTransferred=!0,i.add(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){let i=Object.create(this.prototype);return i.arrayBuffer=t.arrayBuffer,i.length=t.length,i.capacity=t.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...t){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...t){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function pi(n,t=1){let i=0,o=0;return{members:n.map(c=>{let s=kp[c.type].BYTES_PER_ELEMENT,b=i=yh(i,Math.max(t,s)),W=c.components||1;return o=Math.max(o,s),i+=s*W,{name:c.name,type:c.type,components:W,offset:b}}),size:yh(i,Math.max(o,t)),alignment:t}}function yh(n,t){return Math.ceil(n/t)*t}class ql extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i){let o=this.length;return this.resize(o+1),this.emplace(o,t,i)}emplace(t,i,o){let c=2*t;return this.int16[c+0]=i,this.int16[c+1]=o,t}}ql.prototype.bytesPerElement=4,he(ql,"StructArrayLayout2i4");class wd extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,o){let c=this.length;return this.resize(c+1),this.emplace(c,t,i,o)}emplace(t,i,o,c){let s=3*t;return this.int16[s+0]=i,this.int16[s+1]=o,this.int16[s+2]=c,t}}wd.prototype.bytesPerElement=6,he(wd,"StructArrayLayout3i6");class $l extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,o,c){let s=this.length;return this.resize(s+1),this.emplace(s,t,i,o,c)}emplace(t,i,o,c,s){let b=4*t;return this.int16[b+0]=i,this.int16[b+1]=o,this.int16[b+2]=c,this.int16[b+3]=s,t}}$l.prototype.bytesPerElement=8,he($l,"StructArrayLayout4i8");class Ad extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s){let b=this.length;return this.resize(b+1),this.emplace(b,t,i,o,c,s)}emplace(t,i,o,c,s,b){let W=5*t;return this.int16[W+0]=i,this.int16[W+1]=o,this.int16[W+2]=c,this.int16[W+3]=s,this.int16[W+4]=b,t}}Ad.prototype.bytesPerElement=10,he(Ad,"StructArrayLayout5i10");class Nb extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b,W){let R=this.length;return this.resize(R+1),this.emplace(R,t,i,o,c,s,b,W)}emplace(t,i,o,c,s,b,W,R){let I=6*t,h=12*t,Z=3*t;return this.int16[I+0]=i,this.int16[I+1]=o,this.uint8[h+4]=c,this.uint8[h+5]=s,this.uint8[h+6]=b,this.uint8[h+7]=W,this.float32[Z+2]=R,t}}Nb.prototype.bytesPerElement=12,he(Nb,"StructArrayLayout2i4ub1f12");class Bl extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o,c){let s=this.length;return this.resize(s+1),this.emplace(s,t,i,o,c)}emplace(t,i,o,c,s){let b=4*t;return this.float32[b+0]=i,this.float32[b+1]=o,this.float32[b+2]=c,this.float32[b+3]=s,t}}Bl.prototype.bytesPerElement=16,he(Bl,"StructArrayLayout4f16");class to extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o){let c=this.length;return this.resize(c+1),this.emplace(c,t,i,o)}emplace(t,i,o,c){let s=3*t;return this.float32[s+0]=i,this.float32[s+1]=o,this.float32[s+2]=c,t}}to.prototype.bytesPerElement=12,he(to,"StructArrayLayout3f12");class Ml extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s){let b=this.length;return this.resize(b+1),this.emplace(b,t,i,o,c,s)}emplace(t,i,o,c,s,b){let W=6*t,R=3*t;return this.uint16[W+0]=i,this.uint16[W+1]=o,this.uint16[W+2]=c,this.uint16[W+3]=s,this.float32[R+2]=b,t}}Ml.prototype.bytesPerElement=12,he(Ml,"StructArrayLayout4ui1f12");class Fo extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,o,c){let s=this.length;return this.resize(s+1),this.emplace(s,t,i,o,c)}emplace(t,i,o,c,s){let b=4*t;return this.uint16[b+0]=i,this.uint16[b+1]=o,this.uint16[b+2]=c,this.uint16[b+3]=s,t}}Fo.prototype.bytesPerElement=8,he(Fo,"StructArrayLayout4ui8");class Hd extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b){let W=this.length;return this.resize(W+1),this.emplace(W,t,i,o,c,s,b)}emplace(t,i,o,c,s,b,W){let R=6*t;return this.int16[R+0]=i,this.int16[R+1]=o,this.int16[R+2]=c,this.int16[R+3]=s,this.int16[R+4]=b,this.int16[R+5]=W,t}}Hd.prototype.bytesPerElement=12,he(Hd,"StructArrayLayout6i12");class Yb extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b,W,R,I,h,Z,F){let V=this.length;return this.resize(V+1),this.emplace(V,t,i,o,c,s,b,W,R,I,h,Z,F)}emplace(t,i,o,c,s,b,W,R,I,h,Z,F,V){let G=12*t;return this.int16[G+0]=i,this.int16[G+1]=o,this.int16[G+2]=c,this.int16[G+3]=s,this.uint16[G+4]=b,this.uint16[G+5]=W,this.uint16[G+6]=R,this.uint16[G+7]=I,this.int16[G+8]=h,this.int16[G+9]=Z,this.int16[G+10]=F,this.int16[G+11]=V,t}}Yb.prototype.bytesPerElement=24,he(Yb,"StructArrayLayout4i4ui4i24");class Jb extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b){let W=this.length;return this.resize(W+1),this.emplace(W,t,i,o,c,s,b)}emplace(t,i,o,c,s,b,W){let R=10*t,I=5*t;return this.int16[R+0]=i,this.int16[R+1]=o,this.int16[R+2]=c,this.float32[I+2]=s,this.float32[I+3]=b,this.float32[I+4]=W,t}}Jb.prototype.bytesPerElement=20,he(Jb,"StructArrayLayout3i3f20");class Xb extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){let i=this.length;return this.resize(i+1),this.emplace(i,t)}emplace(t,i){return this.uint32[1*t+0]=i,t}}Xb.prototype.bytesPerElement=4,he(Xb,"StructArrayLayout1ul4");class eo extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i){let o=this.length;return this.resize(o+1),this.emplace(o,t,i)}emplace(t,i,o){let c=2*t;return this.uint16[c+0]=i,this.uint16[c+1]=o,t}}eo.prototype.bytesPerElement=4,he(eo,"StructArrayLayout2ui4");class ps extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b,W,R,I,h,Z,F,V){let G=this.length;return this.resize(G+1),this.emplace(G,t,i,o,c,s,b,W,R,I,h,Z,F,V)}emplace(t,i,o,c,s,b,W,R,I,h,Z,F,V,G){let N=20*t,X=10*t;return this.int16[N+0]=i,this.int16[N+1]=o,this.int16[N+2]=c,this.int16[N+3]=s,this.int16[N+4]=b,this.float32[X+3]=W,this.float32[X+4]=R,this.float32[X+5]=I,this.float32[X+6]=h,this.int16[N+14]=Z,this.uint32[X+8]=F,this.uint16[N+18]=V,this.uint16[N+19]=G,t}}ps.prototype.bytesPerElement=40,he(ps,"StructArrayLayout5i4f1i1ul2ui40");class Io extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b,W){let R=this.length;return this.resize(R+1),this.emplace(R,t,i,o,c,s,b,W)}emplace(t,i,o,c,s,b,W,R){let I=8*t;return this.int16[I+0]=i,this.int16[I+1]=o,this.int16[I+2]=c,this.int16[I+4]=s,this.int16[I+5]=b,this.int16[I+6]=W,this.int16[I+7]=R,t}}Io.prototype.bytesPerElement=16,he(Io,"StructArrayLayout3i2i2i16");class Pa extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s){let b=this.length;return this.resize(b+1),this.emplace(b,t,i,o,c,s)}emplace(t,i,o,c,s,b){let W=4*t,R=8*t;return this.float32[W+0]=i,this.float32[W+1]=o,this.float32[W+2]=c,this.int16[R+6]=s,this.int16[R+7]=b,t}}Pa.prototype.bytesPerElement=16,he(Pa,"StructArrayLayout2f1f2i16");class Ws extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b){let W=this.length;return this.resize(W+1),this.emplace(W,t,i,o,c,s,b)}emplace(t,i,o,c,s,b,W){let R=20*t,I=5*t;return this.uint8[R+0]=i,this.uint8[R+1]=o,this.float32[I+1]=c,this.float32[I+2]=s,this.float32[I+3]=b,this.float32[I+4]=W,t}}Ws.prototype.bytesPerElement=20,he(Ws,"StructArrayLayout2ub4f20");class Ja extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,o){let c=this.length;return this.resize(c+1),this.emplace(c,t,i,o)}emplace(t,i,o,c){let s=3*t;return this.uint16[s+0]=i,this.uint16[s+1]=o,this.uint16[s+2]=c,t}}Ja.prototype.bytesPerElement=6,he(Ja,"StructArrayLayout3ui6");class yb extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X,M,S,f,T,v){let L=this.length;return this.resize(L+1),this.emplace(L,t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X,M,S,f,T,v)}emplace(t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X,M,S,f,T,v,L){let D=30*t,q=15*t,tt=60*t;return this.int16[D+0]=i,this.int16[D+1]=o,this.int16[D+2]=c,this.float32[q+2]=s,this.float32[q+3]=b,this.uint16[D+8]=W,this.uint16[D+9]=R,this.uint32[q+5]=I,this.uint32[q+6]=h,this.uint32[q+7]=Z,this.uint16[D+16]=F,this.uint16[D+17]=V,this.uint16[D+18]=G,this.float32[q+10]=N,this.float32[q+11]=X,this.uint8[tt+48]=M,this.uint8[tt+49]=S,this.uint8[tt+50]=f,this.uint32[q+13]=T,this.int16[D+28]=v,this.uint8[tt+58]=L,t}}yb.prototype.bytesPerElement=60,he(yb,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Bb extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X,M,S,f,T,v,L,D,q,tt,P,st,it,dt,Zt,Vt,Rt){let Ft=this.length;return this.resize(Ft+1),this.emplace(Ft,t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X,M,S,f,T,v,L,D,q,tt,P,st,it,dt,Zt,Vt,Rt)}emplace(t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X,M,S,f,T,v,L,D,q,tt,P,st,it,dt,Zt,Vt,Rt,Ft){let yt=20*t,xt=40*t,ft=80*t;return this.float32[yt+0]=i,this.float32[yt+1]=o,this.int16[xt+4]=c,this.int16[xt+5]=s,this.int16[xt+6]=b,this.int16[xt+7]=W,this.int16[xt+8]=R,this.int16[xt+9]=I,this.int16[xt+10]=h,this.int16[xt+11]=Z,this.int16[xt+12]=F,this.uint16[xt+13]=V,this.uint16[xt+14]=G,this.uint16[xt+15]=N,this.uint16[xt+16]=X,this.uint16[xt+17]=M,this.uint16[xt+18]=S,this.uint16[xt+19]=f,this.uint16[xt+20]=T,this.uint16[xt+21]=v,this.uint16[xt+22]=L,this.uint16[xt+23]=D,this.uint16[xt+24]=q,this.uint16[xt+25]=tt,this.uint16[xt+26]=P,this.uint16[xt+27]=st,this.uint32[yt+14]=it,this.float32[yt+15]=dt,this.float32[yt+16]=Zt,this.float32[yt+17]=Vt,this.float32[yt+18]=Rt,this.uint8[ft+76]=Ft,t}}Bb.prototype.bytesPerElement=80,he(Bb,"StructArrayLayout2f9i15ui1ul4f1ub80");class us extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){let i=this.length;return this.resize(i+1),this.emplace(i,t)}emplace(t,i){return this.float32[1*t+0]=i,t}}us.prototype.bytesPerElement=4,he(us,"StructArrayLayout1f4");class Tl extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s){let b=this.length;return this.resize(b+1),this.emplace(b,t,i,o,c,s)}emplace(t,i,o,c,s,b){let W=5*t;return this.float32[W+0]=i,this.float32[W+1]=o,this.float32[W+2]=c,this.float32[W+3]=s,this.float32[W+4]=b,t}}Tl.prototype.bytesPerElement=20,he(Tl,"StructArrayLayout5f20");class Mb extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b,W){let R=this.length;return this.resize(R+1),this.emplace(R,t,i,o,c,s,b,W)}emplace(t,i,o,c,s,b,W,R){let I=7*t;return this.float32[I+0]=i,this.float32[I+1]=o,this.float32[I+2]=c,this.float32[I+3]=s,this.float32[I+4]=b,this.float32[I+5]=W,this.float32[I+6]=R,t}}Mb.prototype.bytesPerElement=28,he(Mb,"StructArrayLayout7f28");class Rr extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,o,c){let s=this.length;return this.resize(s+1),this.emplace(s,t,i,o,c)}emplace(t,i,o,c,s){let b=6*t;return this.uint32[3*t+0]=i,this.uint16[b+2]=o,this.uint16[b+3]=c,this.uint16[b+4]=s,t}}Rr.prototype.bytesPerElement=12,he(Rr,"StructArrayLayout1ul3ui12");class Tb extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){let i=this.length;return this.resize(i+1),this.emplace(i,t)}emplace(t,i){return this.uint16[1*t+0]=i,t}}Tb.prototype.bytesPerElement=2,he(Tb,"StructArrayLayout1ui2");class Gr extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i){let o=this.length;return this.resize(o+1),this.emplace(o,t,i)}emplace(t,i,o){let c=2*t;return this.float32[c+0]=i,this.float32[c+1]=o,t}}Gr.prototype.bytesPerElement=8,he(Gr,"StructArrayLayout2f8");class Fr extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X){let M=this.length;return this.resize(M+1),this.emplace(M,t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X)}emplace(t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X,M){let S=16*t;return this.float32[S+0]=i,this.float32[S+1]=o,this.float32[S+2]=c,this.float32[S+3]=s,this.float32[S+4]=b,this.float32[S+5]=W,this.float32[S+6]=R,this.float32[S+7]=I,this.float32[S+8]=h,this.float32[S+9]=Z,this.float32[S+10]=F,this.float32[S+11]=V,this.float32[S+12]=G,this.float32[S+13]=N,this.float32[S+14]=X,this.float32[S+15]=M,t}}Fr.prototype.bytesPerElement=64,he(Fr,"StructArrayLayout16f64");class jd extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,o,c,s,b,W){let R=this.length;return this.resize(R+1),this.emplace(R,t,i,o,c,s,b,W)}emplace(t,i,o,c,s,b,W,R){let I=10*t,h=5*t;return this.uint16[I+0]=i,this.uint16[I+1]=o,this.uint16[I+2]=c,this.uint16[I+3]=s,this.float32[h+2]=b,this.float32[h+3]=W,this.float32[h+4]=R,t}}jd.prototype.bytesPerElement=20,he(jd,"StructArrayLayout4ui3f20");class Od extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t){let i=this.length;return this.resize(i+1),this.emplace(i,t)}emplace(t,i){return this.int16[1*t+0]=i,t}}Od.prototype.bytesPerElement=2,he(Od,"StructArrayLayout1i2");class Dd extends fi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(t){let i=this.length;return this.resize(i+1),this.emplace(i,t)}emplace(t,i){return this.uint8[1*t+0]=i,t}}Dd.prototype.bytesPerElement=1,he(Dd,"StructArrayLayout1ub1");class Bh extends Vr{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Bh.prototype.size=40;class _d extends ps{get(t){return new Bh(this,t)}}he(_d,"CollisionBoxArray");class Ir extends Vr{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}Ir.prototype.size=60;class Cb extends yb{get(t){return new Ir(this,t)}}he(Cb,"PlacedSymbolArray");class Mh extends Vr{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(t){this._structArray.uint32[this._pos4+14]=t}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(t){this._structArray.float32[this._pos4+18]=t}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}Mh.prototype.size=80;class kb extends Bb{get(t){return new Mh(this,t)}}he(kb,"SymbolInstanceArray");class Th extends us{getoffsetX(t){return this.float32[1*t+0]}}he(Th,"GlyphOffsetArray");class Pd extends ql{getx(t){return this.int16[2*t+0]}gety(t){return this.int16[2*t+1]}}he(Pd,"SymbolLineVertexArray");class Ch extends Vr{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Ch.prototype.size=12;class kh extends Rr{get(t){return new Ch(this,t)}}he(kh,"FeatureIndexArray");class Sh extends eo{geta_centroid_pos0(t){return this.uint16[2*t+0]}geta_centroid_pos1(t){return this.uint16[2*t+1]}}he(Sh,"FillExtrusionCentroidArray");class Qh extends Vr{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Qh.prototype.size=6;class Sb extends wd{get(t){return new Qh(this,t)}}he(Sb,"FillExtrusionWallArray");let Sp=pi([{name:"a_pos",components:2,type:"Int16"}],4),Qp=pi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Oi{constructor(t=[]){this.segments=t}_prepareSegment(t,i,o,c){let s=this.segments[this.segments.length-1];return t>Oi.MAX_VERTEX_ARRAY_LENGTH&&mi(`Max vertices per segment is ${Oi.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!s||s.vertexLength+t>Oi.MAX_VERTEX_ARRAY_LENGTH||s.sortKey!==c)&&(s={vertexOffset:i,primitiveOffset:o,vertexLength:0,primitiveLength:0},c!==void 0&&(s.sortKey=c),this.segments.push(s)),s}prepareSegment(t,i,o,c){return this._prepareSegment(t,i.length,o.length,c)}get(){return this.segments}destroy(){for(let t of this.segments)for(let i in t.vaos)t.vaos[i].destroy()}static simpleSegment(t,i,o,c){return new Oi([{vertexOffset:t,primitiveOffset:i,vertexLength:o,primitiveLength:c,vaos:{},sortKey:0}])}}function fh(n,t){return 256*(n=ze(Math.floor(n),0,255))+ze(Math.floor(t),0,255)}Oi.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,he(Oi,"SegmentVector");let fp=pi([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),vp=pi([{name:"a_dash",components:4,type:"Uint16"}]);class Ur{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(t,i,o,c){this.ids.push(vh(t)),this.positions.push(i,o,c)}eachPosition(t,i){let o=vh(t),c=0,s=this.ids.length-1;for(;c<s;){let b=c+s>>1;this.ids[b]>=o?s=b:c=b+1}for(;this.ids[c]===o;)i(this.positions[3*c],this.positions[3*c+1],this.positions[3*c+2]),c++}static serialize(t,i){let o=new Float64Array(t.ids),c=new Uint32Array(t.positions);return Zs(o,c,0,o.length-1),i&&(i.add(o.buffer),i.add(c.buffer)),{ids:o,positions:c}}static deserialize(t){let i=new Ur,o;i.ids=t.ids,i.positions=t.positions;for(let c of i.ids)c!==o&&i.uniqueIds.push(c),o=c;return i.indexed=!0,i}}function vh(n){let t=+n;return!isNaN(t)&&Number.MIN_SAFE_INTEGER<=t&&t<=Number.MAX_SAFE_INTEGER?t:an(String(n))}function Zs(n,t,i,o){for(;i<o;){let c=n[i+o>>1],s=i-1,b=o+1;for(;;){do s++;while(n[s]<c);do b--;while(n[b]>c);if(s>=b)break;Kd(n,s,b),Kd(t,3*s,3*b),Kd(t,3*s+1,3*b+1),Kd(t,3*s+2,3*b+2)}b-i<o-b?(Zs(n,t,i,b),i=b+1):(Zs(n,t,b+1,o),o=b)}}function Kd(n,t,i){let o=n[t];n[t]=n[i],n[i]=o}he(Ur,"FeaturePositionMap");class Cl{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,i),this.initialized=!0),!!this.location}set(t,i,o){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Uo extends Cl{constructor(t){super(t),this.current=0}set(t,i,o){this.fetchUniformLocation(t,i)&&this.current!==o&&(this.current=o,this.gl.uniform1i(this.location,o))}}class wa extends Cl{constructor(t){super(t),this.current=0}set(t,i,o){this.fetchUniformLocation(t,i)&&this.current!==o&&(this.current=o,this.gl.uniform1f(this.location,o))}}class cl extends Cl{constructor(t){super(t),this.current=[0,0]}set(t,i,o){this.fetchUniformLocation(t,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]||(this.current=o,this.gl.uniform2f(this.location,o[0],o[1])))}}class Qb extends Cl{constructor(t){super(t),this.current=[0,0,0]}set(t,i,o){this.fetchUniformLocation(t,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]||(this.current=o,this.gl.uniform3f(this.location,o[0],o[1],o[2])))}}class qd extends Cl{constructor(t){super(t),this.current=[0,0,0,0]}set(t,i,o){this.fetchUniformLocation(t,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]&&o[3]===this.current[3]||(this.current=o,this.gl.uniform4f(this.location,o[0],o[1],o[2],o[3])))}}class fb extends Cl{constructor(t){super(t),this.current=Ri.transparent.toRenderColor(null)}set(t,i,o){this.fetchUniformLocation(t,i)&&(o.r===this.current.r&&o.g===this.current.g&&o.b===this.current.b&&o.a===this.current.a||(this.current=o,this.gl.uniform4f(this.location,o.r,o.g,o.b,o.a)))}}let Eh=new Float32Array(16);class xr extends Cl{constructor(t){super(t),this.current=Eh}set(t,i,o){if(this.fetchUniformLocation(t,i)){if(o[12]!==this.current[12]||o[0]!==this.current[0])return this.current=o,void this.gl.uniformMatrix4fv(this.location,!1,o);for(let c=1;c<16;c++)if(o[c]!==this.current[c]){this.current=o,this.gl.uniformMatrix4fv(this.location,!1,o);break}}}}let Ep=new Float32Array(9),Lp=new Float32Array(4);class vb extends Cl{constructor(t){super(t),this.current=Lp}set(t,i,o){if(this.fetchUniformLocation(t,i)){for(let c=0;c<4;c++)if(o[c]!==this.current[c]){this.current=o,this.gl.uniformMatrix2fv(this.location,!1,o);break}}}}function Eb(n){return[fh(255*n.r,255*n.g),fh(255*n.b,255*n.a)]}class Nr{constructor(t,i,o,c){this.value=t,this.uniformNames=i.map(s=>`u_${s}`),this.type=o,this.context=c}setUniform(t,i,o,c,s){let b=c.constantOr(this.value);i.set(t,s,b instanceof Ri?b.toRenderColor(this.context.lut):b)}getBinding(t,i){return this.type==="color"?new fb(t):new wa(t)}}class gs{constructor(t,i){this.uniformNames=i.map(o=>`u_${o}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(t){this.pixelRatio=t.pixelRatio||1,this.pattern=t.tl.concat(t.br)}setUniform(t,i,o,c,s){let b=s==="u_pattern"||s==="u_dash"?this.pattern:s==="u_pixel_ratio"?this.pixelRatio:null;b&&i.set(t,s,b)}getBinding(t,i){return i==="u_pattern"||i==="u_dash"?new qd(t):new wa(t)}}class bl{constructor(t,i,o,c){this.expression=t,this.type=o,this.maxValue=0,this.paintVertexAttributes=i.map(s=>({name:`a_${s}`,type:"Float32",components:o==="color"?2:1,offset:0})),this.paintVertexArray=new c}populatePaintArray(t,i,o,c,s,b,W){let R=this.paintVertexArray.length,I=this.expression.evaluate(new ji(0,{brightness:b}),i,{},s,c,W);this.paintVertexArray.resize(t),this._setPaintValue(R,t,I,this.context)}updatePaintArray(t,i,o,c,s,b,W){let R=this.expression.evaluate({zoom:0,brightness:W},o,c,void 0,s);this._setPaintValue(t,i,R,this.context)}_setPaintValue(t,i,o,c){if(this.type==="color"){let s=Eb(o.toRenderColor(c.lut));for(let b=t;b<i;b++)this.paintVertexArray.emplace(b,s[0],s[1])}else{for(let s=t;s<i;s++)this.paintVertexArray.emplace(s,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Gn{constructor(t,i,o,c,s,b){this.expression=t,this.uniformNames=i.map(W=>`u_${W}_t`),this.type=o,this.useIntegerZoom=c,this.context=s,this.maxValue=0,this.paintVertexAttributes=i.map(W=>({name:`a_${W}`,type:"Float32",components:o==="color"?4:2,offset:0})),this.paintVertexArray=new b}populatePaintArray(t,i,o,c,s,b,W){let R=this.expression.evaluate(new ji(this.context.zoom,{brightness:b}),i,{},s,c,W),I=this.expression.evaluate(new ji(this.context.zoom+1,{brightness:b}),i,{},s,c,W),h=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(h,t,R,I,this.context)}updatePaintArray(t,i,o,c,s,b,W){let R=this.expression.evaluate({zoom:this.context.zoom,brightness:W},o,c,void 0,s),I=this.expression.evaluate({zoom:this.context.zoom+1,brightness:W},o,c,void 0,s);this._setPaintValue(t,i,R,I,this.context)}_setPaintValue(t,i,o,c,s){if(this.type==="color"){let b=Eb(o.toRenderColor(s.lut)),W=Eb(o.toRenderColor(s.lut));for(let R=t;R<i;R++)this.paintVertexArray.emplace(R,b[0],b[1],W[0],W[1])}else{for(let b=t;b<i;b++)this.paintVertexArray.emplace(b,o,c);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(c))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,i,o,c,s){let b=this.useIntegerZoom?Math.floor(o.zoom):o.zoom,W=ze(this.expression.interpolationFactor(b,this.context.zoom,this.context.zoom+1),0,1);i.set(t,s,W)}getBinding(t,i){return new wa(t)}}class ml{constructor(t,i,o,c,s){this.expression=t,this.layerId=s,this.paintVertexAttributes=(o==="array"?vp:fp).members;for(let b=0;b<i.length;++b);this.paintVertexArray=new c}populatePaintArray(t,i,o,c){let s=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValues(s,t,i.patterns&&i.patterns[this.layerId],o)}updatePaintArray(t,i,o,c,s,b,W){this._setPaintValues(t,i,o.patterns&&o.patterns[this.layerId],b)}_setPaintValues(t,i,o,c){if(!c||!o)return;let s=c[o];if(!s)return;let{tl:b,br:W,pixelRatio:R}=s;for(let I=t;I<i;I++)this.paintVertexArray.emplace(I,b[0],b[1],W[0],W[1],R)}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class xo{constructor(t,i,o=()=>!0){this.binders={},this._buffers=[],this.context=i;let c=[];for(let s in t.paint._values){let b=t.paint.get(s);if(!o(s)||!(b instanceof cs&&Yd(b.property.specification)))continue;let W=wp(s,t.type),R=b.value,I=b.property.specification.type,h=!!b.property.useIntegerZoom,Z=s==="line-dasharray"||s.endsWith("pattern"),F=s==="line-dasharray"&&t.layout.get("line-cap").value.kind!=="constant";if(R.kind!=="constant"||F)if(R.kind==="source"||F||Z){let V=r(s,I,"source");this.binders[s]=Z?new ml(R,W,I,V,t.id):new bl(R,W,I,V),c.push(`/a_${s}`)}else{let V=r(s,I,"composite");this.binders[s]=new Gn(R,W,I,h,i,V),c.push(`/z_${s}`)}else this.binders[s]=Z?new gs(R.value,W):new Nr(R.value,W,I,i),c.push(`/u_${s}`)}this.cacheKey=c.sort().join("")}getMaxValue(t){let i=this.binders[t];return i instanceof bl||i instanceof Gn?i.maxValue:0}populatePaintArrays(t,i,o,c,s,b,W){for(let R in this.binders){let I=this.binders[R];I.context=this.context,(I instanceof bl||I instanceof Gn||I instanceof ml)&&I.populatePaintArray(t,i,o,c,s,b,W)}}setConstantPatternPositions(t){for(let i in this.binders){let o=this.binders[i];o instanceof gs&&o.setConstantPatternPositions(t)}}updatePaintArrays(t,i,o,c,s,b,W,R){let I=!1,h=Object.keys(t),Z=h.length!==0,F=Z?h:i.uniqueIds;this.context.lut=s.lut;for(let V in this.binders){let G=this.binders[V];if(G.context=this.context,(G instanceof bl||G instanceof Gn||G instanceof ml)&&(G.expression.isStateDependent===!0||G.expression.isLightConstant===!1)){let N=s.paint.get(V);G.expression=N.value;for(let X of F){let M=t[X.toString()];i.eachPosition(X,(S,f,T)=>{let v=c.feature(S);G.updatePaintArray(f,T,v,M,b,W,R)})}if(!Z)for(let X of o.uniqueIds){let M=t[X.toString()];o.eachPosition(X,(S,f,T)=>{let v=c.feature(S);G.updatePaintArray(f,T,v,M,b,W,R)})}I=!0}}return I}defines(){let t=[];for(let i in this.binders){let o=this.binders[i];(o instanceof Nr||o instanceof gs)&&t.push(...o.uniformNames.map(c=>`#define HAS_UNIFORM_${c}`))}return t}getBinderAttributes(){let t=[];for(let i in this.binders){let o=this.binders[i];if(o instanceof bl||o instanceof Gn||o instanceof ml)for(let c=0;c<o.paintVertexAttributes.length;c++)t.push(o.paintVertexAttributes[c].name)}return t}getBinderUniforms(){let t=[];for(let i in this.binders){let o=this.binders[i];if(o instanceof Nr||o instanceof gs||o instanceof Gn)for(let c of o.uniformNames)t.push(c)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){let i=[];for(let o in this.binders){let c=this.binders[o];if(c instanceof Nr||c instanceof gs||c instanceof Gn)for(let s of c.uniformNames)i.push({name:s,property:o,binding:c.getBinding(t,s)})}return i}setUniforms(t,i,o,c,s){for(let{name:b,property:W,binding:R}of o)this.binders[W].setUniform(t,R,s,c.get(W),b)}updatePaintBuffers(){this._buffers=[];for(let t in this.binders){let i=this.binders[t];(i instanceof bl||i instanceof Gn||i instanceof ml)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer)}}upload(t){for(let i in this.binders){let o=this.binders[i];(o instanceof bl||o instanceof Gn||o instanceof ml)&&o.upload(t)}this.updatePaintBuffers()}destroy(){for(let t in this.binders){let i=this.binders[t];(i instanceof bl||i instanceof Gn||i instanceof ml)&&i.destroy()}}}class io{constructor(t,i,o=()=>!0){this.programConfigurations={};for(let c of t)this.programConfigurations[c.id]=new xo(c,i,o);this.needsUpload=!1,this._featureMap=new Ur,this._featureMapWithoutIds=new Ur,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(t,i,o,c,s,b,W,R){for(let I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(t,i,c,s,b,W,R);i.id!==void 0?this._featureMap.add(i.id,o,this._bufferOffset,t):(this._featureMapWithoutIds.add(this._idlessCounter,o,this._bufferOffset,t),this._idlessCounter+=1),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,i,o,c,s,b){for(let W of o)this.needsUpload=this.programConfigurations[W.id].updatePaintArrays(t,this._featureMap,this._featureMapWithoutIds,i,W,c,s,b||0)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(let i in this.programConfigurations)this.programConfigurations[i].upload(t);this.needsUpload=!1}}destroy(){for(let t in this.programConfigurations)this.programConfigurations[t].destroy()}}let zp={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function wp(n,t){return zp[n]||[n.replace(`${t}-`,"").replace(/-/g,"_")]}let Ap={"line-pattern":{source:Ml,composite:Ml},"fill-pattern":{source:Ml,composite:Ml},"fill-extrusion-pattern":{source:Ml,composite:Ml},"line-dasharray":{source:Fo,composite:Fo}},Lh={color:{source:Gr,composite:Bl},number:{source:us,composite:Gr}};function r(n,t,i){let o=Ap[n];return o&&o[i]||Lh[t][i]}he(Nr,"ConstantBinder"),he(gs,"PatternConstantBinder"),he(bl,"SourceExpressionBinder"),he(ml,"PatternCompositeBinder"),he(Gn,"CompositeExpressionBinder"),he(xo,"ProgramConfiguration",{omit:["_buffers"]}),he(io,"ProgramConfigurationSet");let e=ne/Math.PI/2,a=5,d=6,m=16383,p=64,u=[p,32,16],U=-e,Y=e;function y(n,t,i,o=e){return i=ti(i),[n*Math.sin(i)*o,-t*o,n*Math.cos(i)*o]}function B(n,t,i){return y(Math.cos(ti(n)),Math.sin(ti(n)),t,i)}let C=63710088e-1,k=2*Math.PI*C;class Q{constructor(t,i){if(isNaN(t)||isNaN(i))throw new Error(`Invalid LngLat object: (${t}, ${i})`);if(this.lng=+t,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Q(pn(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){let i=Math.PI/180,o=this.lat*i,c=t.lat*i,s=Math.sin(o)*Math.sin(c)+Math.cos(o)*Math.cos(c)*Math.cos((t.lng-this.lng)*i);return C*Math.acos(Math.min(s,1))}toBounds(t=0){let i=360*t/40075017,o=i/Math.cos(Math.PI/180*this.lat);return new z({lng:this.lng-o,lat:this.lat-i},{lng:this.lng+o,lat:this.lat+i})}toEcef(t){return B(this.lat,this.lng,e+t*e/C)}static convert(t){if(t instanceof Q)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new Q(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new Q(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class z{constructor(t,i){if(t)if(i)this.setSouthWest(t).setNorthEast(i);else if(t.length===4){let o=t;this.setSouthWest([o[0],o[1]]).setNorthEast([o[2],o[3]])}else{let o=t;this.setSouthWest(o[0]).setNorthEast(o[1])}}setNorthEast(t){return this._ne=t instanceof Q?new Q(t.lng,t.lat):Q.convert(t),this}setSouthWest(t){return this._sw=t instanceof Q?new Q(t.lng,t.lat):Q.convert(t),this}extend(t){let i=this._sw,o=this._ne,c,s;if(t instanceof Q)c=t,s=t;else{if(!(t instanceof z))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(z.convert(t)):this.extend(Q.convert(t)):typeof t=="object"&&t!==null&&t.hasOwnProperty("lat")&&(t.hasOwnProperty("lon")||t.hasOwnProperty("lng"))?this.extend(Q.convert(t)):this;if(c=t._sw,s=t._ne,!c||!s)return this}return i||o?(i.lng=Math.min(c.lng,i.lng),i.lat=Math.min(c.lat,i.lat),o.lng=Math.max(s.lng,o.lng),o.lat=Math.max(s.lat,o.lat)):(this._sw=new Q(c.lng,c.lat),this._ne=new Q(s.lng,s.lat)),this}getCenter(){return new Q((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Q(this.getWest(),this.getNorth())}getSouthEast(){return new Q(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){let{lng:i,lat:o}=Q.convert(t),c=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(c=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=o&&o<=this._ne.lat&&c}static convert(t){if(t)return t instanceof z?t:new z(t)}}let w=0,A=25.5;function H(n){return k*Math.cos(n*Math.PI/180)}function $(n){return(180+n)/360}function et(n){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360}function K(n,t){return n/H(t)}function nt(n){return 360*n-180}function at(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function ct(n,t){return n*H(at(t))}let rt=85.051129;function bt(n){return Math.cos(ti(ze(n,-rt,rt)))}function gt(n,t){let i=ze(t,w,A),o=Math.pow(2,i);return bt(n)*k/(512*o)}function Wt(n){return 1/Math.cos(n*Math.PI/180)}function ht(n,t=0){let i=Math.exp(Math.PI*(1-(n.y+t/ne)/(1<<n.z)*2));return 80150034*i/(i*i+1)/ne/(1<<n.z)}class Nt{constructor(t,i,o=0){this.x=+t,this.y=+i,this.z=+o}static fromLngLat(t,i=0){let o=Q.convert(t);return new Nt($(o.lng),et(o.lat),K(i,o.lat))}toLngLat(){return new Q(nt(this.x),at(this.y))}toAltitude(){return ct(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/k*Wt(at(this.y))}}function St(n,t,i,o,c,s,b,W,R){let I=(t+o)/2,h=(i+c)/2,Z=new ee(I,h);W(Z),function(F,V,G,N,X,M){let S=G-X,f=N-M;return Math.abs((N-V)*S-(G-F)*f)/Math.hypot(S,f)}(Z.x,Z.y,s.x,s.y,b.x,b.y)>=R?(St(n,t,i,I,h,s,Z,W,R),St(n,I,h,o,c,Z,b,W,R)):n.push(b)}function wt(n,t,i){let o=n[0],c=o.x,s=o.y;t(o);let b=[o];for(let W=1;W<n.length;W++){let R=n[W],{x:I,y:h}=R;t(R),St(b,c,s,I,h,o,R,t,i),c=I,s=h,o=R}return b}function kt(n,t,i,o){if(o(t,i)){let c=t.add(i)._mult(.5);kt(n,t,c,o),kt(n,c,i,o)}else n.push(i)}function Ot(n,t){let i=n[0],o=[i];for(let c=1;c<n.length;c++){let s=n[c];kt(o,i,s,t),i=s}return o}let Yt=Math.pow(2,14)-1,Lt=-Yt-1;function vt(n,t){let i=Math.round(n.x*t),o=Math.round(n.y*t);return n.x=ze(i,Lt,Yt),n.y=ze(o,Lt,Yt),(i<n.x||i>n.x+1||o<n.y||o>n.y+1)&&mi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),n}function _t(n,t,i){let o=n.loadGeometry(),c=n.extent,s=ne/c;if(t&&i&&i.projection.isReprojectedInTileSpace){let b=1<<t.z,{scale:W,x:R,y:I,projection:h}=i,Z=F=>{let V=nt((t.x+F.x/c)/b),G=at((t.y+F.y/c)/b),N=h.project(V,G);F.x=(N.x*W-R)*c,F.y=(N.y*W-I)*c};for(let F=0;F<o.length;F++)if(n.type!==1)o[F]=wt(o[F],Z,1);else{let V=[];for(let G of o[F])G.x<0||G.x>=c||G.y<0||G.y>=c||(Z(G),V.push(G));o[F]=V}}for(let b of o)for(let W of b)vt(W,s);return o}function qt(n,t){return{type:n.type,id:n.id,properties:n.properties,geometry:t?_t(n):[]}}function zt(n,t,i,o,c){n.emplaceBack(2*t+(o+1)/2,2*i+(c+1)/2)}function Ht(n,t,i){n.emplaceBack(t.x,t.y,t.z,i[0]*16384,i[1]*16384,i[2]*16384)}class Ue{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new ql,this.indexArray=new Ja,this.segments=new Oi,this.programConfigurations=new io(t.layers,{zoom:t.zoom,lut:t.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id)}updateFootprints(t,i){}populate(t,i,o,c){let s=this.layers[0],b=[],W=null;s.type==="circle"&&(W=s.layout.get("circle-sort-key"));for(let{feature:I,id:h,index:Z,sourceLayerIndex:F}of t){let V=this.layers[0]._featureFilter.needGeometry,G=qt(I,V);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),G,o))continue;let N=W?W.evaluate(G,{},o):void 0,X={id:h,properties:I.properties,type:I.type,sourceLayerIndex:F,index:Z,geometry:V?G.geometry:_t(I,o,c),patterns:{},sortKey:N};b.push(X)}W&&b.sort((I,h)=>I.sortKey-h.sortKey);let R=null;c.projection.name==="globe"&&(this.globeExtVertexArray=new Hd,R=c.projection);for(let I of b){let{geometry:h,index:Z,sourceLayerIndex:F}=I,V=t[Z].feature;this.addFeature(I,h,Z,i.availableImages,o,R,i.brightness),i.featureIndex.insert(V,h,Z,F,this.index)}}update(t,i,o,c,s){let b=Object.keys(t).length!==0;b&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,i,b?this.stateDependentLayers:this.layers,o,c,s)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Sp.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,Qp.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(t,i,o,c,s,b,W){for(let R of i)for(let I of R){let h=I.x,Z=I.y;if(h<0||h>=ne||Z<0||Z>=ne)continue;if(b){let G=b.projectTilePoint(h,Z,s),N=b.upVector(s,h,Z),X=this.globeExtVertexArray;Ht(X,G,N),Ht(X,G,N),Ht(X,G,N),Ht(X,G,N)}let F=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),V=F.vertexLength;zt(this.layoutVertexArray,h,Z,-1,-1),zt(this.layoutVertexArray,h,Z,1,-1),zt(this.layoutVertexArray,h,Z,1,1),zt(this.layoutVertexArray,h,Z,-1,1),this.indexArray.emplaceBack(V,V+1,V+2),this.indexArray.emplaceBack(V,V+2,V+3),F.vertexLength+=4,F.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,{},c,s,W)}}function ie(n,t){for(let i=0;i<n.length;i++)if(Si(t,n[i]))return!0;for(let i=0;i<t.length;i++)if(Si(n,t[i]))return!0;return!!Ye(n,t)}function be(n,t,i){return!!Si(n,t)||!!De(t,n,i)}function Me(n,t){if(n.length===1)return Xi(t,n[0]);for(let i=0;i<t.length;i++){let o=t[i];for(let c=0;c<o.length;c++)if(Si(n,o[c]))return!0}for(let i=0;i<n.length;i++)if(Xi(t,n[i]))return!0;for(let i=0;i<t.length;i++)if(Ye(n,t[i]))return!0;return!1}function ge(n,t,i){if(n.length>1){if(Ye(n,t))return!0;for(let o=0;o<t.length;o++)if(De(t[o],n,i))return!0}for(let o=0;o<n.length;o++)if(De(n[o],t,i))return!0;return!1}function Ye(n,t){if(n.length===0||t.length===0)return!1;for(let i=0;i<n.length-1;i++){let o=n[i],c=n[i+1];for(let s=0;s<t.length-1;s++)if(qe(o,c,t[s],t[s+1]))return!0}return!1}function qe(n,t,i,o){return nl(n,i,o)!==nl(t,i,o)&&nl(n,t,i)!==nl(n,t,o)}function De(n,t,i){let o=i*i;if(t.length===1)return n.distSqr(t[0])<o;for(let c=1;c<t.length;c++)if(Ui(n,t[c-1],t[c])<o)return!0;return!1}function Ui(n,t,i){let o=t.distSqr(i);if(o===0)return n.distSqr(t);let c=((n.x-t.x)*(i.x-t.x)+(n.y-t.y)*(i.y-t.y))/o;return n.distSqr(c<0?t:c>1?i:i.sub(t)._mult(c)._add(t))}function Xi(n,t){let i,o,c,s=!1;for(let b=0;b<n.length;b++){i=n[b];for(let W=0,R=i.length-1;W<i.length;R=W++)o=i[W],c=i[R],o.y>t.y!=c.y>t.y&&t.x<(c.x-o.x)*(t.y-o.y)/(c.y-o.y)+o.x&&(s=!s)}return s}function Si(n,t){let i=!1;for(let o=0,c=n.length-1;o<n.length;c=o++){let s=n[o],b=n[c];s.y>t.y!=b.y>t.y&&t.x<(b.x-s.x)*(t.y-s.y)/(b.y-s.y)+s.x&&(i=!i)}return i}function Bn(n,t,i,o,c){for(let b of n)if(t<=b.x&&i<=b.y&&o>=b.x&&c>=b.y)return!0;let s=[new ee(t,i),new ee(t,c),new ee(o,c),new ee(o,i)];if(n.length>2){for(let b of s)if(Si(n,b))return!0}for(let b=0;b<n.length-1;b++)if(ta(n[b],n[b+1],s))return!0;return!1}function ta(n,t,i){let o=i[0],c=i[2];if(n.x<o.x&&t.x<o.x||n.x>c.x&&t.x>c.x||n.y<o.y&&t.y<o.y||n.y>c.y&&t.y>c.y)return!1;let s=nl(n,t,i[0]);return s!==nl(n,t,i[1])||s!==nl(n,t,i[2])||s!==nl(n,t,i[3])}function ni(n,t,i,o,c,s){let b=t.y-n.y,W=n.x-t.x;if(s=s||0){let R=b*b+W*W;if(R===0)return!0;let I=Math.sqrt(R);b/=I,W/=I}return!((i.x-n.x)*b+(i.y-n.y)*W-s<0||(o.x-n.x)*b+(o.y-n.y)*W-s<0||(c.x-n.x)*b+(c.y-n.y)*W-s<0)}function Yi(n,t,i,o,c,s,b){return!(ni(n,t,o,c,s,b)||ni(t,i,o,c,s,b)||ni(i,n,o,c,s,b)||ni(o,c,n,t,i,b)||ni(c,s,n,t,i,b)||ni(s,o,n,t,i,b))}function Li(n,t,i){let o=t.paint.get(n).value;return o.kind==="constant"?o.value:i.programConfigurations.get(t.id).getMaxValue(n)}function Ni(n){return Math.sqrt(n[0]*n[0]+n[1]*n[1])}function Pe(n,t,i,o,c){if(!t[0]&&!t[1])return n;let s=ee.convert(t)._mult(c);i==="viewport"&&s._rotate(-o);let b=[];for(let W=0;W<n.length;W++)b.push(n[W].sub(s));return b}function Wi(n,t,i,o){let c=ee.convert(n)._mult(o);return t==="viewport"&&c._rotate(-i),c}let Gi,Di;he(Ue,"CircleBucket",{omit:["layers"]});var ea,di={exports:{}},ma=(ea||(ea=1,function(n,t){(function(i){function o(s,b,W){var R=c(256*s,256*(b=Math.pow(2,W)-b-1),W),I=c(256*(s+1),256*(b+1),W);return R[0]+","+R[1]+","+I[0]+","+I[1]}function c(s,b,W){var R=2*Math.PI*6378137/256/Math.pow(2,W);return[s*R-2*Math.PI*6378137/2,b*R-2*Math.PI*6378137/2]}i.getURL=function(s,b,W,R,I,h){return h=h||{},s+"?"+["bbox="+o(W,R,I),"format="+(h.format||"image/png"),"service="+(h.service||"WMS"),"version="+(h.version||"1.1.1"),"request="+(h.request||"GetMap"),"srs="+(h.srs||"EPSG:3857"),"width="+(h.width||256),"height="+(h.height||256),"layers="+b].join("&")},i.getTileBBox=o,i.getMercCoords=c,Object.defineProperty(i,"__esModule",{value:!0})})(t)}(0,di.exports)),di.exports);class Va{constructor(t,i,o){this.z=t,this.x=i,this.y=o,this.key=Ka(0,t,t,i,o)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,i){let o=ma.getTileBBox(this.x,this.y,this.z),c=function(s,b,W){let R,I="";for(let h=s;h>0;h--)R=1<<h-1,I+=(b&R?1:0)+(W&R?2:0);return I}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",c).replace("{bbox-epsg-3857}",o)}toString(){return`${this.z}/${this.x}/${this.y}`}}class ha{constructor(t,i){this.wrap=t,this.canonical=i,this.key=Ka(t,i.z,i.z,i.x,i.y)}}class Ti{constructor(t,i,o,c,s){this.overscaledZ=t,this.wrap=i,this.canonical=new Va(o,+c,+s),this.key=i===0&&t===o?this.canonical.key:Ka(i,t,o,c,s)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){let i=this.canonical.z-t;return t>this.canonical.z?new Ti(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Ti(t,this.wrap,t,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(t,i=!0){if(this.overscaledZ===t&&i)return this.key;if(t>this.canonical.z)return Ka(this.wrap*+i,t,this.canonical.z,this.canonical.x,this.canonical.y);{let o=this.canonical.z-t;return Ka(this.wrap*+i,t,t,this.canonical.x>>o,this.canonical.y>>o)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;let i=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.z<this.canonical.z&&t.canonical.x===this.canonical.x>>i&&t.canonical.y===this.canonical.y>>i}children(t){if(this.overscaledZ>=t)return[new Ti(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let i=this.canonical.z+1,o=2*this.canonical.x,c=2*this.canonical.y;return[new Ti(i,this.wrap,i,o,c),new Ti(i,this.wrap,i,o+1,c),new Ti(i,this.wrap,i,o,c+1),new Ti(i,this.wrap,i,o+1,c+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new Ti(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new Ti(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new ha(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Ka(n,t,i,o,c){let s=1<<Math.min(i,22),b=s*(c%s)+o%s;return n&&i<22&&(b+=s*s*((n<0?-2*n-1:2*n)%(1<<2*(22-i)))),16*(32*b+i)+(t-i)}let qa=[n=>{let t=n.canonical.x-1,i=n.wrap;return t<0&&(t=(1<<n.canonical.z)-1,i--),new Ti(n.overscaledZ,i,n.canonical.z,t,n.canonical.y)},n=>{let t=n.canonical.x+1,i=n.wrap;return t===1<<n.canonical.z&&(t=0,i++),new Ti(n.overscaledZ,i,n.canonical.z,t,n.canonical.y)},n=>new Ti(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,(n.canonical.y===0?1<<n.canonical.z:n.canonical.y)-1),n=>new Ti(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,n.canonical.y===(1<<n.canonical.z)-1?0:n.canonical.y+1)];he(Va,"CanonicalTileID"),he(Ti,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let Mn=pi([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Fn}=Mn,rn=pi([{name:"a_pos_3",components:3,type:"Int16"}]);var Tn=pi([{name:"a_pos",type:"Int16",components:2}]);class kl{constructor(t,i){this.pos=t,this.dir=i}intersectsPlane(t,i,o){let c=ut.vec3.dot(i,this.dir);if(Math.abs(c)<1e-6)return!1;let s=((t[0]-this.pos[0])*i[0]+(t[1]-this.pos[1])*i[1]+(t[2]-this.pos[2])*i[2])/c;return o[0]=this.pos[0]+this.dir[0]*s,o[1]=this.pos[1]+this.dir[1]*s,o[2]=this.pos[2]+this.dir[2]*s,!0}closestPointOnSphere(t,i,o){if(ut.vec3.equals(this.pos,t)||i===0)return o[0]=o[1]=o[2]=0,!1;let[c,s,b]=this.dir,W=this.pos[0]-t[0],R=this.pos[1]-t[1],I=this.pos[2]-t[2],h=c*c+s*s+b*b,Z=2*(W*c+R*s+I*b),F=Z*Z-4*h*(W*W+R*R+I*I-i*i);if(F<0){let V=Math.max(-Z/2,0),G=W+c*V,N=R+s*V,X=I+b*V,M=Math.hypot(G,N,X);return o[0]=G*i/M,o[1]=N*i/M,o[2]=X*i/M,!1}{let V=(-Z-Math.sqrt(F))/(2*h);if(V<0){let G=Math.hypot(W,R,I);return o[0]=W*i/G,o[1]=R*i/G,o[2]=I*i/G,!1}return o[0]=W+c*V,o[1]=R+s*V,o[2]=I+b*V,!0}}}class ao{constructor(t,i,o,c,s){this.TL=t,this.TR=i,this.BR=o,this.BL=c,this.horizon=s}static fromInvProjectionMatrix(t,i,o){let c=[-1,1,1],s=[1,1,1],b=[1,-1,1],W=[-1,-1,1],R=ut.vec3.transformMat4(c,c,t),I=ut.vec3.transformMat4(s,s,t),h=ut.vec3.transformMat4(b,b,t),Z=ut.vec3.transformMat4(W,W,t);return new ao(R,I,h,Z,i/o)}}function hl(n,t,i){let o=1/0,c=-1/0,s=[];for(let b of n){ut.vec3.sub(s,b,t);let W=ut.vec3.dot(s,i);o=Math.min(o,W),c=Math.max(c,W)}return[o,c]}function Vs(n,t){let i=!0;for(let o=0;o<n.planes.length;o++){let c=n.planes[o],s=0;for(let b=0;b<t.length;b++)s+=ut.vec3.dot(c,t[b])+c[3]>=0;if(s===0)return 0;s!==t.length&&(i=!1)}return i?2:1}function Rs(n,t){for(let i of n.projections){let o=hl(t,n.points[0],i.axis);if(i.projection[1]<o[0]||i.projection[0]>o[1])return 0}return 1}function $d(n,t){let i=0,o=[0,0,0,0];for(let c=0;c<n.length;c++)o[0]=n[c][0],o[1]=n[c][1],o[2]=n[c][2],o[3]=1,ut.vec4.dot(o,t)>=0&&i++;return i}class Gs{constructor(t,i){this.points=t||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=Ci.fromPoints(this.points),this.projections=[],this.frustumEdges=[ut.vec3.sub([],this.points[2],this.points[3]),ut.vec3.sub([],this.points[0],this.points[3]),ut.vec3.sub([],this.points[4],this.points[0]),ut.vec3.sub([],this.points[5],this.points[1]),ut.vec3.sub([],this.points[6],this.points[2]),ut.vec3.sub([],this.points[7],this.points[3])];for(let o of this.frustumEdges){let c=[0,-o[2],o[1]],s=[o[2],0,-o[0]];this.projections.push({axis:c,projection:hl(this.points,this.points[0],c)}),this.projections.push({axis:s,projection:hl(this.points,this.points[0],s)})}}static fromInvProjectionMatrix(t,i,o,c){let s=Math.pow(2,o),b=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(I=>{let h=ut.vec4.transformMat4([],I,t),Z=1/h[3]/i*s;return ut.vec4.mul(h,h,[Z,Z,c?1/h[3]:Z,Z])}),W=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(I=>{let h=ut.vec3.sub([],b[I[0]],b[I[1]]),Z=ut.vec3.sub([],b[I[2]],b[I[1]]),F=ut.vec3.normalize([],ut.vec3.cross([],h,Z)),V=-ut.vec3.dot(F,b[I[1]]);return F.concat(V)}),R=[];for(let I=0;I<b.length;I++)R.push([b[I][0],b[I][1],b[I][2]]);return new Gs(R,W)}intersectsPrecise(t,i,o){for(let c=0;c<i.length;c++)if(!$d(t,i[c]))return 0;for(let c=0;c<this.planes.length;c++)if(!$d(t,this.planes[c]))return 0;for(let c of o)for(let s of this.frustumEdges){let b=ut.vec3.cross([],c,s),W=ut.vec3.length(b);if(W===0)continue;ut.vec3.scale(b,b,1/W);let R=hl(this.points,this.points[0],b),I=hl(t,this.points[0],b);if(R[0]>I[1]||I[0]>R[1])return 0}return 1}containsPoint(t){for(let i of this.planes){let o=i[3];if(ut.vec3.dot([i[0],i[1],i[2]],t)+o<0)return!1}return!0}}class Ci{static fromPoints(t){let i=[1/0,1/0,1/0],o=[-1/0,-1/0,-1/0];for(let c of t)ut.vec3.min(i,i,c),ut.vec3.max(o,o,c);return new Ci(i,o)}static fromTileIdAndHeight(t,i,o){let c=1<<t.canonical.z,s=t.canonical.x,b=t.canonical.y;return new Ci([s/c,b/c,i],[(s+1)/c,(b+1)/c,o])}static applyTransform(t,i){let o=t.getCorners();for(let c=0;c<o.length;++c)ut.vec3.transformMat4(o[c],o[c],i);return Ci.fromPoints(o)}static applyTransformFast(t,i){let o=[i[12],i[13],i[14]],c=[...o];for(let s=0;s<3;s++)for(let b=0;b<3;b++){let W=i[4*b+s],R=W*t.min[b],I=W*t.max[b];o[s]+=Math.min(R,I),c[s]+=Math.max(R,I)}return new Ci(o,c)}static projectAabbCorners(t,i){let o=t.getCorners();for(let c=0;c<o.length;++c)ut.vec3.transformMat4(o[c],o[c],i);return o}constructor(t,i){this.min=t,this.max=i,this.center=ut.vec3.scale([],ut.vec3.add([],this.min,this.max),.5)}quadrant(t){let i=[t%2==0,t<2],o=ut.vec3.clone(this.min),c=ut.vec3.clone(this.max);for(let s=0;s<i.length;s++)o[s]=i[s]?this.min[s]:this.center[s],c[s]=i[s]?this.center[s]:this.max[s];return c[2]=this.max[2],new Ci(o,c)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){let t=this.min,i=this.max;return[[t[0],t[1],t[2]],[i[0],t[1],t[2]],[i[0],i[1],t[2]],[t[0],i[1],t[2]],[t[0],t[1],i[2]],[i[0],t[1],i[2]],[i[0],i[1],i[2]],[t[0],i[1],i[2]]]}intersects(t){return this.intersectsAabb(t.bounds)?Vs(t,this.getCorners()):0}intersectsFlat(t){return this.intersectsAabb(t.bounds)?Vs(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(t,i){return i||this.intersects(t)?Rs(t,this.getCorners()):0}intersectsPreciseFlat(t,i){return i||this.intersectsFlat(t)?Rs(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(t){for(let i=0;i<3;++i)if(this.min[i]>t.max[i]||t.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(t){return!(this.min[0]>t.max[0]||t.min[0]>this.max[0]||this.min[1]>t.max[1]||t.min[1]>this.max[1])}encapsulate(t){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],t.min[i]),this.max[i]=Math.max(this.max[i],t.max[i])}encapsulatePoint(t){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],t[i]),this.max[i]=Math.max(this.max[i],t[i])}closestPoint(t){return[Math.max(Math.min(this.max[0],t[0]),this.min[0]),Math.max(Math.min(this.max[1],t[1]),this.min[1]),Math.max(Math.min(this.max[2],t[2]),this.min[2])]}}function No(n){return n*e/C}he(Ci,"Aabb");let Hp=[new Ci([U,U,U],[Y,Y,Y]),new Ci([U,U,U],[0,0,Y]),new Ci([0,U,U],[Y,0,Y]),new Ci([U,0,U],[0,Y,Y]),new Ci([0,0,U],[Y,Y,Y])];function zh(n,t,i,o=!0){let c=ut.vec3.scale([],n._camera.position,n.worldSize),s=[t,i,1,1];ut.vec4.transformMat4(s,s,n.pixelMatrixInverse),ut.vec4.scale(s,s,1/s[3]);let b=ut.vec3.sub([],s,c),W=ut.vec3.normalize([],b),R=n.globeMatrix,I=[R[12],R[13],R[14]],h=ut.vec3.sub([],I,c),Z=ut.vec3.length(h),F=ut.vec3.normalize([],h),V=n.worldSize/(2*Math.PI),G=ut.vec3.dot(F,W),N=Math.asin(V/Z);if(N<Math.acos(G)){if(!o)return null;let st=[],it=[];ut.vec3.scale(st,W,Z/G),ut.vec3.normalize(it,ut.vec3.sub(it,st,h)),ut.vec3.normalize(W,ut.vec3.add(W,h,ut.vec3.scale(W,it,Math.tan(N)*Z)))}let X=[];new kl(c,W).closestPointOnSphere(I,V,X);let M=ut.vec3.normalize([],mo(R,0)),S=ut.vec3.normalize([],mo(R,1)),f=ut.vec3.normalize([],mo(R,2)),T=ut.vec3.dot(M,X),v=ut.vec3.dot(S,X),L=ut.vec3.dot(f,X),D=sa(Math.asin(-v/V)),q=sa(Math.atan2(T,L));q=n.center.lng+function(st,it){let dt=(it-st+180)%360-180;return dt<-180?dt+360:dt}(n.center.lng,q);let tt=$(q),P=ze(et(D),0,1);return new Nt(tt,P)}class dI{constructor(t,i,o){this.a=ut.vec3.sub([],t,o),this.b=ut.vec3.sub([],i,o),this.center=o;let c=ut.vec3.normalize([],this.a),s=ut.vec3.normalize([],this.b);this.angle=Math.acos(ut.vec3.dot(c,s))}}function jp(n,t){if(n.angle===0)return null;let i;return i=n.a[t]===0?1/n.angle*.5*Math.PI:1/n.angle*Math.atan(n.b[t]/n.a[t]/Math.sin(n.angle)-1/Math.tan(n.angle)),i<0||i>1?null:function(o,c,s,b){let W=Math.sin(s);return o*(Math.sin((1-b)*s)/W)+c*(Math.sin(b*s)/W)}(n.a[t],n.b[t],n.angle,ze(i,0,1))+n.center[t]}function no(n){if(n.z<=1)return Hp[n.z+2*n.y+n.x];let t=Op(wh(n));return Ci.fromPoints(t)}function Yo(n,t,i){return ut.vec3.scale(n,n,1-i),ut.vec3.scaleAndAdd(n,n,t,i)}function ru(n,t,i){for(let o of n)ut.vec3.transformMat4(o,o,t),ut.vec3.scale(o,o,i)}function du(n,t,i,o){let c=t/n.worldSize,s=n.globeMatrix;if(i.z<=1){let tt=no(i).getCorners();return ru(tt,s,c),Ci.fromPoints(tt)}let b=wh(i,o),W=Op(b,e+No(n._tileCoverLift));ru(W,s,c);let R=Number.MAX_VALUE,I=[-R,-R,-R],h=[R,R,R];if(b.contains(n.center)){for(let st of W)ut.vec3.min(h,h,st),ut.vec3.max(I,I,st);I[2]=0;let tt=n.point,P=[tt.x*c,tt.y*c,0];return ut.vec3.min(h,h,P),ut.vec3.max(I,I,P),new Ci(h,I)}if(n._tileCoverLift>0){for(let tt of W)ut.vec3.min(h,h,tt),ut.vec3.max(I,I,tt);return new Ci(h,I)}let Z=[s[12]*c,s[13]*c,s[14]*c],F=b.getCenter(),V=ze(n.center.lat,-rt,rt),G=ze(F.lat,-rt,rt),N=$(n.center.lng),X=et(V),M=N-$(F.lng),S=X-et(G);M>.5?M-=1:M<-.5&&(M+=1);let f=0;if(Math.abs(M)>Math.abs(S))f=M>=0?1:3;else{f=S>=0?0:2;let tt=[s[4]*c,s[5]*c,s[6]*c],P=-Math.sin(ti(S>=0?b.getSouth():b.getNorth()))*e;ut.vec3.scaleAndAdd(Z,Z,tt,P)}let T=W[f],v=W[(f+1)%4],L=new dI(T,v,Z),D=[jp(L,0)||T[0],jp(L,1)||T[1],jp(L,2)||T[2]],q=Fs(n.zoom);if(q>0){let tt=function({x:st,y:it,z:dt},Zt,Vt,Rt,Ft){let yt=1/(1<<dt),xt=st*yt,ft=xt+yt,At=it*yt,Ct=At+yt,se=0,ae=(xt+ft)/2-Rt;return ae>.5?se=-1:ae<-.5&&(se=1),xt=((xt+se)*Zt-(Rt*=Zt))*Vt+Rt,ft=((ft+se)*Zt-Rt)*Vt+Rt,At=(At*Zt-(Ft*=Zt))*Vt+Ft,Ct=(Ct*Zt-Ft)*Vt+Ft,[[xt,Ct,0],[ft,Ct,0],[ft,At,0],[xt,At,0]]}(i,t,n._pixelsPerMercatorPixel,N,X);for(let st=0;st<W.length;st++)Yo(W[st],tt[st],q);let P=ut.vec3.add([],tt[f],tt[(f+1)%4]);ut.vec3.scale(P,P,.5),Yo(D,P,q)}for(let tt of W)ut.vec3.min(h,h,tt),ut.vec3.max(I,I,tt);return h[2]=Math.min(T[2],v[2]),ut.vec3.min(h,h,D),ut.vec3.max(I,I,D),new Ci(h,I)}function wh({x:n,y:t,z:i},o=!1){let c=1/(1<<i),s=new Q(nt(n*c),t===(1<<i)-1&&o?-90:at((t+1)*c)),b=new Q(nt((n+1)*c),t===0&&o?90:at(t*c));return new z(s,b)}function Op(n,t=e){let i=ti(n.getNorth()),o=ti(n.getSouth()),c=Math.cos(i),s=Math.cos(o),b=Math.sin(i),W=Math.sin(o),R=n.getWest(),I=n.getEast();return[y(s,W,R,t),y(s,W,I,t),y(c,b,I,t),y(c,b,R,t)]}function Lb(n,t,i,o){let c=1<<i.z,s=(n/ne+i.x)/c;return B(at((t/ne+i.y)/c),nt(s),o)}function Ah({min:n,max:t}){return m/Math.max(t[0]-n[0],t[1]-n[1],t[2]-n[2])}let cu=new Float64Array(16);function Hh(n){let t=Ah(n),i=ut.mat4.fromScaling(cu,[t,t,t]);return ut.mat4.translate(i,i,ut.vec3.negate([],n.min))}function Dp(n){let t=ut.mat4.fromTranslation(cu,n.min),i=1/Ah(n);return ut.mat4.scale(t,t,[i,i,i])}function _p(n){let t=ne/(2*Math.PI);return n/(2*Math.PI)/t}function bu(n,t){return ne/(512*Math.pow(2,n))*Ah(no(t))}function mu(n,t,i,o,c){let s=_p(i),b=[n,t,-i/(2*Math.PI)],W=ut.mat4.identity(new Float64Array(16));return ut.mat4.translate(W,W,b),ut.mat4.scale(W,W,[s,s,s]),ut.mat4.rotateX(W,W,ti(-c)),ut.mat4.rotateY(W,W,ti(-o)),W}function Fs(n){return xl(a,d,n)}function hu(n,t){let i=B(t.lat,t.lng),o=function(s){let b=B(s._center.lat,s._center.lng),W=ut.vec3.fromValues(0,1,0),R=ut.vec3.cross([],W,b),I=ut.mat4.fromRotation([],-s.angle,b);R=ut.vec3.transformMat4(R,R,I),ut.mat4.fromRotation(I,-s._pitch,R);let h=ut.vec3.normalize([],b);return ut.vec3.scale(h,h,No(s.cameraToCenterDistance/s.pixelsPerMeter)),ut.vec3.transformMat4(h,h,I),ut.vec3.add([],b,h)}(n),c=ut.vec3.subtract([],o,i);return ut.vec3.angle(c,i)}function Pp(n,t){return hu(n,t)>Math.PI/2*1.01}let pu=ti(85),cI=Math.cos(pu),bI=Math.sin(pu),mI=ut.mat4.create(),Wu=n=>{let t=[];return n.paint.get("circle-pitch-alignment")==="map"&&t.push("PITCH_WITH_MAP"),n.paint.get("circle-pitch-scale")==="map"&&t.push("SCALE_WITH_MAP"),t};function uu(n,t,i,o,c,s,b,W,R){if(s&&n.queryGeometry.isAboveHorizon)return!1;s&&(R*=n.pixelToTileUnitsFactor);let I=n.tileID.canonical,h=i.projection.upVectorScale(I,i.center.lat,i.worldSize).metersToTile;for(let Z of t)for(let F of Z){let V=F.add(W),G=c&&i.elevation?i.elevation.exaggeration()*c.getElevationAt(V.x,V.y,!0):0,N=i.projection.projectTilePoint(V.x,V.y,I);if(G>0){let f=i.projection.upVector(I,V.x,V.y);N.x+=f[0]*h*G,N.y+=f[1]*h*G,N.z+=f[2]*h*G}let X=s?V:hI(N.x,N.y,N.z,o),M=s?n.tilespaceRays.map(f=>WI(f,G)):n.queryGeometry.screenGeometry,S=ut.vec4.transformMat4([],[N.x,N.y,N.z,1],o);if(!b&&s?R*=S[3]/i.cameraToCenterDistance:b&&!s&&(R*=i.cameraToCenterDistance/S[3]),s){let f=at((F.y/ne+I.y)/(1<<I.z));R/=i.projection.pixelsPerMeter(f,1)/K(1,f)}if(be(M,X,R))return!0}return!1}function hI(n,t,i,o){let c=ut.vec4.transformMat4([],[n,t,i,1],o);return new ee(c[0]/c[3],c[1]/c[3])}let Zu=ut.vec3.fromValues(0,0,0),pI=ut.vec3.fromValues(0,0,1);function WI(n,t){let i=ut.vec3.create();return Zu[2]=t,n.intersectsPlane(Zu,pI,i),new ee(i[0],i[1])}class gu extends Ue{}let Vu,Ru,Gu,Fu;function Iu(n,{width:t,height:i},o,c){if(c){if(c instanceof Uint8ClampedArray)c=new Uint8Array(c.buffer);else if(c.length!==t*i*o)throw new RangeError("mismatched image size")}else c=new Uint8Array(t*i*o);return n.width=t,n.height=i,n.data=c,n}function Uu(n,t,i){let{width:o,height:c}=t;o===n.width&&c===n.height||(Kp(n,t,{x:0,y:0},{x:0,y:0},{width:Math.min(n.width,o),height:Math.min(n.height,c)},i,null),n.width=o,n.height=c,n.data=t.data)}function Kp(n,t,i,o,c,s,b,W){if(c.width===0||c.height===0)return t;if(c.width>n.width||c.height>n.height||i.x>n.width-c.width||i.y>n.height-c.height)throw new RangeError("out of range source coordinates for image copy");if(c.width>t.width||c.height>t.height||o.x>t.width-c.width||o.y>t.height-c.height)throw new RangeError("out of range destination coordinates for image copy");let R=n.data,I=t.data,h=s===4&&W;for(let Z=0;Z<c.height;Z++){let F=((i.y+Z)*n.width+i.x)*s,V=((o.y+Z)*t.width+o.x)*s;if(h)for(let G=0;G<c.width;G++){let N=F+G*s+3,X=V+G*s;I[X+0]=255,I[X+1]=255,I[X+2]=255,I[X+3]=R[N]}else if(b)for(let G=0;G<c.width;G++){let N=F+G*s,X=V+G*s,M=R[N+3],S=new Ri(R[N+0]/255*M,R[N+1]/255*M,R[N+2]/255*M,M).toRenderColor(b).toArray();I[X+0]=S[0],I[X+1]=S[1],I[X+2]=S[2],I[X+3]=S[3]}else for(let G=0;G<c.width*s;G++)I[V+G]=R[F+G]}return t}he(gu,"HeatmapBucket",{omit:["layers"]});class Is{constructor(t,i){Iu(this,t,1,i)}resize(t){Uu(this,new Is(t),1)}clone(){return new Is({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,i,o,c,s){Kp(t,i,o,c,s,1,null)}}class $a{constructor(t,i){Iu(this,t,4,i)}resize(t){Uu(this,new $a(t),4)}replace(t,i){i?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new $a({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,i,o,c,s,b,W){Kp(t,i,o,c,s,4,b,W)}}class xu{constructor(t,i){this.width=t.width,this.height=t.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function zb(n){let t={},i=n.resolution||256,o=n.clips?n.clips.length:1,c=n.image||new $a({width:i,height:o}),s=(b,W,R)=>{t[n.evaluationKey]=R;let I=n.expression.evaluate(t);I&&(c.data[b+W+0]=Math.floor(255*I.r/I.a),c.data[b+W+1]=Math.floor(255*I.g/I.a),c.data[b+W+2]=Math.floor(255*I.b/I.a),c.data[b+W+3]=Math.floor(255*I.a))};if(n.clips)for(let b=0,W=0;b<o;++b,W+=4*i)for(let R=0,I=0;R<i;R++,I+=4){let h=R/(i-1),{start:Z,end:F}=n.clips[b];s(W,I,Z*(1-h)+F*h)}else for(let b=0,W=0;b<i;b++,W+=4)s(0,W,b/(i-1));return c}he(Is,"AlphaImage"),he($a,"RGBAImage");let uI=pi([{name:"a_pos",components:2,type:"Int16"}],4),{members:ZI}=uI;function wb(n,t,i=2){let o=t&&t.length,c=o?t[0]*i:n.length,s=Nu(n,0,c,i,!0),b=[];if(!s||s.next===s.prev)return b;let W,R,I;if(o&&(s=function(h,Z,F,V){let G=[];for(let N=0,X=Z.length;N<X;N++){let M=Nu(h,Z[N]*V,N<X-1?Z[N+1]*V:h.length,V,!1);M===M.next&&(M.steiner=!0),G.push(xI(M))}G.sort(FI);for(let N=0;N<G.length;N++)F=II(G[N],F);return F}(n,t,s,i)),n.length>80*i){W=1/0,R=1/0;let h=-1/0,Z=-1/0;for(let F=i;F<c;F+=i){let V=n[F],G=n[F+1];V<W&&(W=V),G<R&&(R=G),V>h&&(h=V),G>Z&&(Z=G)}I=Math.max(h-W,Z-R),I=I!==0?32767/I:0}return Ab(s,b,i,W,R,I,0),b}function Nu(n,t,i,o,c){let s;if(c===function(b,W,R,I){let h=0;for(let Z=W,F=R-I;Z<R;Z+=I)h+=(b[F]-b[Z])*(b[Z+1]+b[F+1]),F=Z;return h}(n,t,i,o)>0)for(let b=t;b<i;b+=o)s=Xu(b/o|0,n[b],n[b+1],s);else for(let b=i-o;b>=t;b-=o)s=Xu(b/o|0,n[b],n[b+1],s);return s&&jh(s,s.next)&&(jb(s),s=s.next),s}function Yr(n,t){if(!n)return n;t||(t=n);let i,o=n;do if(i=!1,o.steiner||!jh(o,o.next)&&pa(o.prev,o,o.next)!==0)o=o.next;else{if(jb(o),o=t=o.prev,o===o.next)break;i=!0}while(i||o!==t);return t}function Ab(n,t,i,o,c,s,b){if(!n)return;!b&&s&&function(R,I,h,Z){let F=R;do F.z===0&&(F.z=qp(F.x,F.y,I,h,Z)),F.prevZ=F.prev,F.nextZ=F.next,F=F.next;while(F!==R);F.prevZ.nextZ=null,F.prevZ=null,function(V){let G,N=1;do{let X,M=V;V=null;let S=null;for(G=0;M;){G++;let f=M,T=0;for(let L=0;L<N&&(T++,f=f.nextZ,f);L++);let v=N;for(;T>0||v>0&&f;)T!==0&&(v===0||!f||M.z<=f.z)?(X=M,M=M.nextZ,T--):(X=f,f=f.nextZ,v--),S?S.nextZ=X:V=X,X.prevZ=S,S=X;M=f}S.nextZ=null,N*=2}while(G>1)}(F)}(n,o,c,s);let W=n;for(;n.prev!==n.next;){let R=n.prev,I=n.next;if(s?VI(n,o,c,s):gI(n))t.push(R.i,n.i,I.i),jb(n),n=I.next,W=I.next;else if((n=I)===W){b?b===1?Ab(n=RI(Yr(n),t),t,i,o,c,s,2):b===2&&GI(n,t,i,o,c,s):Ab(Yr(n),t,i,o,c,s,1);break}}}function gI(n){let t=n.prev,i=n,o=n.next;if(pa(t,i,o)>=0)return!1;let c=t.x,s=i.x,b=o.x,W=t.y,R=i.y,I=o.y,h=c<s?c<b?c:b:s<b?s:b,Z=W<R?W<I?W:I:R<I?R:I,F=c>s?c>b?c:b:s>b?s:b,V=W>R?W>I?W:I:R>I?R:I,G=o.next;for(;G!==t;){if(G.x>=h&&G.x<=F&&G.y>=Z&&G.y<=V&&tc(c,W,s,R,b,I,G.x,G.y)&&pa(G.prev,G,G.next)>=0)return!1;G=G.next}return!0}function VI(n,t,i,o){let c=n.prev,s=n,b=n.next;if(pa(c,s,b)>=0)return!1;let W=c.x,R=s.x,I=b.x,h=c.y,Z=s.y,F=b.y,V=W<R?W<I?W:I:R<I?R:I,G=h<Z?h<F?h:F:Z<F?Z:F,N=W>R?W>I?W:I:R>I?R:I,X=h>Z?h>F?h:F:Z>F?Z:F,M=qp(V,G,t,i,o),S=qp(N,X,t,i,o),f=n.prevZ,T=n.nextZ;for(;f&&f.z>=M&&T&&T.z<=S;){if(f.x>=V&&f.x<=N&&f.y>=G&&f.y<=X&&f!==c&&f!==b&&tc(W,h,R,Z,I,F,f.x,f.y)&&pa(f.prev,f,f.next)>=0||(f=f.prevZ,T.x>=V&&T.x<=N&&T.y>=G&&T.y<=X&&T!==c&&T!==b&&tc(W,h,R,Z,I,F,T.x,T.y)&&pa(T.prev,T,T.next)>=0))return!1;T=T.nextZ}for(;f&&f.z>=M;){if(f.x>=V&&f.x<=N&&f.y>=G&&f.y<=X&&f!==c&&f!==b&&tc(W,h,R,Z,I,F,f.x,f.y)&&pa(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;T&&T.z<=S;){if(T.x>=V&&T.x<=N&&T.y>=G&&T.y<=X&&T!==c&&T!==b&&tc(W,h,R,Z,I,F,T.x,T.y)&&pa(T.prev,T,T.next)>=0)return!1;T=T.nextZ}return!0}function RI(n,t){let i=n;do{let o=i.prev,c=i.next.next;!jh(o,c)&&Yu(o,i,i.next,c)&&Hb(o,c)&&Hb(c,o)&&(t.push(o.i,i.i,c.i),jb(i),jb(i.next),i=n=c),i=i.next}while(i!==n);return Yr(i)}function GI(n,t,i,o,c,s){let b=n;do{let W=b.next.next;for(;W!==b.prev;){if(b.i!==W.i&&NI(b,W)){let R=Ju(b,W);return b=Yr(b,b.next),R=Yr(R,R.next),Ab(b,t,i,o,c,s,0),void Ab(R,t,i,o,c,s,0)}W=W.next}b=b.next}while(b!==n)}function FI(n,t){return n.x-t.x}function II(n,t){let i=function(c,s){let b=s,W=c.x,R=c.y,I,h=-1/0;do{if(R<=b.y&&R>=b.next.y&&b.next.y!==b.y){let N=b.x+(R-b.y)*(b.next.x-b.x)/(b.next.y-b.y);if(N<=W&&N>h&&(h=N,I=b.x<b.next.x?b:b.next,N===W))return I}b=b.next}while(b!==s);if(!I)return null;let Z=I,F=I.x,V=I.y,G=1/0;b=I;do{if(W>=b.x&&b.x>=F&&W!==b.x&&tc(R<V?W:h,R,F,V,R<V?h:W,R,b.x,b.y)){let N=Math.abs(R-b.y)/(W-b.x);Hb(b,c)&&(N<G||N===G&&(b.x>I.x||b.x===I.x&&UI(I,b)))&&(I=b,G=N)}b=b.next}while(b!==Z);return I}(n,t);if(!i)return t;let o=Ju(i,n);return Yr(o,o.next),Yr(i,i.next)}function UI(n,t){return pa(n.prev,n,t.prev)<0&&pa(t.next,n,n.next)<0}function qp(n,t,i,o,c){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-i)*c|0)|n<<8))|n<<4))|n<<2))|n<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-o)*c|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function xI(n){let t=n,i=n;do(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next;while(t!==n);return i}function tc(n,t,i,o,c,s,b,W){return(c-b)*(t-W)>=(n-b)*(s-W)&&(n-b)*(o-W)>=(i-b)*(t-W)&&(i-b)*(s-W)>=(c-b)*(o-W)}function NI(n,t){return n.next.i!==t.i&&n.prev.i!==t.i&&!function(i,o){let c=i;do{if(c.i!==i.i&&c.next.i!==i.i&&c.i!==o.i&&c.next.i!==o.i&&Yu(c,c.next,i,o))return!0;c=c.next}while(c!==i);return!1}(n,t)&&(Hb(n,t)&&Hb(t,n)&&function(i,o){let c=i,s=!1,b=(i.x+o.x)/2,W=(i.y+o.y)/2;do c.y>W!=c.next.y>W&&c.next.y!==c.y&&b<(c.next.x-c.x)*(W-c.y)/(c.next.y-c.y)+c.x&&(s=!s),c=c.next;while(c!==i);return s}(n,t)&&(pa(n.prev,n,t.prev)||pa(n,t.prev,t))||jh(n,t)&&pa(n.prev,n,n.next)>0&&pa(t.prev,t,t.next)>0)}function pa(n,t,i){return(t.y-n.y)*(i.x-t.x)-(t.x-n.x)*(i.y-t.y)}function jh(n,t){return n.x===t.x&&n.y===t.y}function Yu(n,t,i,o){let c=Dh(pa(n,t,i)),s=Dh(pa(n,t,o)),b=Dh(pa(i,o,n)),W=Dh(pa(i,o,t));return c!==s&&b!==W||!(c!==0||!Oh(n,i,t))||!(s!==0||!Oh(n,o,t))||!(b!==0||!Oh(i,n,o))||!(W!==0||!Oh(i,t,o))}function Oh(n,t,i){return t.x<=Math.max(n.x,i.x)&&t.x>=Math.min(n.x,i.x)&&t.y<=Math.max(n.y,i.y)&&t.y>=Math.min(n.y,i.y)}function Dh(n){return n>0?1:n<0?-1:0}function Hb(n,t){return pa(n.prev,n,n.next)<0?pa(n,t,n.next)>=0&&pa(n,n.prev,t)>=0:pa(n,t,n.prev)<0||pa(n,n.next,t)<0}function Ju(n,t){let i=$p(n.i,n.x,n.y),o=$p(t.i,t.x,t.y),c=n.next,s=t.prev;return n.next=t,t.prev=n,i.next=c,c.prev=i,o.next=i,i.prev=o,s.next=o,o.prev=s,o}function Xu(n,t,i,o){let c=$p(n,t,i);return o?(c.next=o.next,c.prev=o,o.next.prev=c,o.next=c):(c.prev=c,c.next=c),c}function jb(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function $p(n,t,i){return{i:n,x:t,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function _h(n,t){let i=n.length;if(i<=1)return[n];let o=[],c,s;for(let b=0;b<i;b++){let W=$r(n[b]);W!==0&&(n[b].area=Math.abs(W),s===void 0&&(s=W<0),s===W<0?(c&&o.push(c),c=[n[b]]):c.push(n[b]))}if(c&&o.push(c),t>1)for(let b=0;b<o.length;b++)o[b].length<=t||(Am(o[b],t,1,o[b].length-1,YI),o[b]=o[b].slice(0,t));return o}function YI(n,t){return t.area-n.area}function tW(n,t,i){let o=i.patternDependencies,c=!1;for(let s of t){let b=s.paint.get(`${n}-pattern`);b.isConstant()||(c=!0);let W=b.constantOr(null);W&&(c=!0,o[W]=!0)}return c}function eW(n,t,i,o,c){let s=c.patternDependencies;for(let b of t){let W=b.paint.get(`${n}-pattern`).value;if(W.kind!=="constant"){let R=W.evaluate({zoom:o},i,{},c.availableImages);R=R&&R.name?R.name:R,s[R]=!0,i.patterns[b.id]=R}}return i}class iW{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new ql,this.indexArray=new Ja,this.indexArray2=new eo,this.programConfigurations=new io(t.layers,{zoom:t.zoom,lut:t.lut}),this.segments=new Oi,this.segments2=new Oi,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=t.projection}updateFootprints(t,i){}populate(t,i,o,c){this.hasPattern=tW("fill",this.layers,i);let s=this.layers[0].layout.get("fill-sort-key"),b=[];for(let{feature:W,id:R,index:I,sourceLayerIndex:h}of t){let Z=this.layers[0]._featureFilter.needGeometry,F=qt(W,Z);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),F,o))continue;let V=s?s.evaluate(F,{},o,i.availableImages):void 0,G={id:R,properties:W.properties,type:W.type,sourceLayerIndex:h,index:I,geometry:Z?F.geometry:_t(W,o,c),patterns:{},sortKey:V};b.push(G)}s&&b.sort((W,R)=>W.sortKey-R.sortKey);for(let W of b){let{geometry:R,index:I,sourceLayerIndex:h}=W;if(this.hasPattern){let Z=eW("fill",this.layers,W,this.zoom,i);this.patternFeatures.push(Z)}else this.addFeature(W,R,I,o,{},i.availableImages,i.brightness);i.featureIndex.insert(t[I].feature,R,I,h,this.index)}}update(t,i,o,c,s){let b=Object.keys(t).length!==0;b&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,i,b?this.stateDependentLayers:this.layers,o,c,s)}addFeatures(t,i,o,c,s,b){for(let W of this.patternFeatures)this.addFeature(W,W.geometry,W.index,i,o,c,b)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,ZI),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,i,o,c,s,b=[],W){for(let R of _h(i,500)){let I=0;for(let N of R)I+=N.length;let h=this.segments.prepareSegment(I,this.layoutVertexArray,this.indexArray),Z=h.vertexLength,F=[],V=[];for(let N of R){if(N.length===0)continue;N!==R[0]&&V.push(F.length/2);let X=this.segments2.prepareSegment(N.length,this.layoutVertexArray,this.indexArray2),M=X.vertexLength;this.layoutVertexArray.emplaceBack(N[0].x,N[0].y),this.indexArray2.emplaceBack(M+N.length-1,M),F.push(N[0].x),F.push(N[0].y);for(let S=1;S<N.length;S++)this.layoutVertexArray.emplaceBack(N[S].x,N[S].y),this.indexArray2.emplaceBack(M+S-1,M+S),F.push(N[S].x),F.push(N[S].y);X.vertexLength+=N.length,X.primitiveLength+=N.length}let G=wb(F,V);for(let N=0;N<G.length;N+=3)this.indexArray.emplaceBack(Z+G[N],Z+G[N+1],Z+G[N+2]);h.vertexLength+=I,h.primitiveLength+=G.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,s,b,c,W)}}let yu,Bu,Mu,Tu;he(iW,"FillBucket",{omit:["layers","patternFeatures"]});class aW{constructor(t,i,o,c){if(this.triangleCount=i.length/3,this.min=new ee(0,0),this.max=new ee(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||t.length===0)return;let[s,b]=[t[0].clone(),t[0].clone()];for(let Z=1;Z<t.length;++Z){let F=t[Z];s.x=Math.min(s.x,F.x),s.y=Math.min(s.y,F.y),b.x=Math.max(b.x,F.x),b.y=Math.max(b.y,F.y)}if(c){let Z=Math.ceil(Math.max(b.x-s.x,b.y-s.y)/c);o=Math.max(o,Z)}if(o===0)return;this.min=s,this.max=b;let W=this.max.sub(this.min);W.x=Math.max(W.x,1),W.y=Math.max(W.y,1);let R=Math.max(W.x,W.y)/o;this.cellsX=Math.max(1,Math.ceil(W.x/R)),this.cellsY=Math.max(1,Math.ceil(W.y/R)),this.xScale=1/R,this.yScale=1/R;let I=[];for(let Z=0;Z<this.triangleCount;Z++){let F=t[i[3*Z+0]].sub(this.min),V=t[i[3*Z+1]].sub(this.min),G=t[i[3*Z+2]].sub(this.min),N=lo(Math.floor(Math.min(F.x,V.x,G.x)),this.xScale,this.cellsX),X=lo(Math.floor(Math.max(F.x,V.x,G.x)),this.xScale,this.cellsX),M=lo(Math.floor(Math.min(F.y,V.y,G.y)),this.yScale,this.cellsY),S=lo(Math.floor(Math.max(F.y,V.y,G.y)),this.yScale,this.cellsY),f=new ee(0,0),T=new ee(0,0),v=new ee(0,0),L=new ee(0,0);for(let D=M;D<=S;++D){f.y=T.y=D*R,v.y=L.y=(D+1)*R;for(let q=N;q<=X;++q)f.x=v.x=q*R,T.x=L.x=(q+1)*R,(Yi(F,V,G,f,T,L)||Yi(F,V,G,f,L,v))&&I.push({cellIdx:D*this.cellsX+q,triIdx:Z})}}if(I.length===0)return;I.sort((Z,F)=>Z.cellIdx-F.cellIdx||Z.triIdx-F.triIdx);let h=0;for(;h<I.length;){let Z=I[h].cellIdx,F={start:this.payload.length,len:0};for(;h<I.length&&I[h].cellIdx===Z;)++F.len,this.payload.push(I[h++].triIdx);this.cells[Z]=F}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(t,i){if(this.triangleCount===0||this.cells.length===0||t.x>this.max.x||this.min.x>t.x||t.y>this.max.y||this.min.y>t.y)return;let o=lo(t.x-this.min.x,this.xScale,this.cellsX),c=lo(t.y-this.min.y,this.yScale,this.cellsY),s=this.cells[c*this.cellsX+o];if(s){this._lazyInitLookup();for(let b=0;b<s.len;b++){let W=this.payload[s.start+b],R=Math.floor(W/8),I=1<<W%8;if(!(this.lookup[R]&I)&&(this.lookup[R]|=I,i.push(W),i.length===this.triangleCount))return}}}query(t,i,o){if(this.triangleCount===0||this.cells.length===0||t.x>this.max.x||this.min.x>i.x||t.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();let c=lo(t.x-this.min.x,this.xScale,this.cellsX),s=lo(i.x-this.min.x,this.xScale,this.cellsX),b=lo(t.y-this.min.y,this.yScale,this.cellsY),W=lo(i.y-this.min.y,this.yScale,this.cellsY);for(let R=b;R<=W;R++)for(let I=c;I<=s;I++){let h=this.cells[R*this.cellsX+I];if(h)for(let Z=0;Z<h.len;Z++){let F=this.payload[h.start+Z],V=Math.floor(F/8),G=1<<F%8;if(!(this.lookup[V]&G)&&(this.lookup[V]|=G,o.push(F),o.length===this.triangleCount))return}}}}function lo(n,t,i){return Math.max(0,Math.min(i-1,Math.floor(n*t)))}he(aW,"TriangleGridIndex");class Cu{constructor(t){this.zoom=t.zoom,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=t.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[]}updateFootprints(t,i){for(let o of this.footprints)i.push({footprint:o,id:t})}populate(t,i,o,c){let s=[];for(let{feature:b,id:W,index:R,sourceLayerIndex:I}of t){let h=this.layers[0]._featureFilter.needGeometry,Z=qt(b,h);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),Z,o))continue;let F={id:W,properties:b.properties,type:b.type,sourceLayerIndex:I,index:R,geometry:h?Z.geometry:_t(b,o,c),patterns:{}};s.push(F)}for(let b of s){let{geometry:W,index:R,sourceLayerIndex:I}=b;this.addFeature(b,W,R,o,{},i.availableImages,i.brightness),i.featureIndex.insert(t[R].feature,W,R,I,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(t){}update(t,i,o,c,s){}destroy(){}addFeature(t,i,o,c,s,b=[],W){for(let R of _h(i,2)){let I=[],h=[],Z=[],F=new ee(1/0,1/0),V=new ee(-1/0,-1/0);for(let X of R)if(X.length!==0){X!==R[0]&&Z.push(h.length/2);for(let M=0;M<X.length;M++)h.push(X[M].x),h.push(X[M].y),I.push(X[M]),F.x=Math.min(F.x,X[M].x),F.y=Math.min(F.y,X[M].y),V.x=Math.max(V.x,X[M].x),V.y=Math.max(V.y,X[M].y)}let G=wb(h,Z),N=new aW(I,G,8,256);this.footprints.push({vertices:I,indices:G,grid:N,min:F,max:V})}}}he(Cu,"ClipBucket",{omit:["layers"]});let JI=pi([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),XI=pi([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),yI=pi([{name:"a_centroid_pos",components:2,type:"Uint16"}]),BI=pi([{name:"a_join_normal_inside",components:3,type:"Int16"}]),MI=pi([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),TI=pi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:CI}=JI;var nW,ku,lW,Su,oW,Qu,fu,Ph={};function vu(){if(ku)return nW;ku=1;var n=Il();function t(c,s,b,W,R){this.properties={},this.extent=b,this.type=0,this._pbf=c,this._geometry=-1,this._keys=W,this._values=R,c.readFields(i,this,s)}function i(c,s,b){c==1?s.id=b.readVarint():c==2?function(W,R){for(var I=W.readVarint()+W.pos;W.pos<I;){var h=R._keys[W.readVarint()],Z=R._values[W.readVarint()];R.properties[h]=Z}}(b,s):c==3?s.type=b.readVarint():c==4&&(s._geometry=b.pos)}function o(c){for(var s,b,W=0,R=0,I=c.length,h=I-1;R<I;h=R++)W+=((b=c[h]).x-(s=c[R]).x)*(s.y+b.y);return W}return nW=t,t.types=["Unknown","Point","LineString","Polygon"],t.prototype.loadGeometry=function(){var c=this._pbf;c.pos=this._geometry;for(var s,b=c.readVarint()+c.pos,W=1,R=0,I=0,h=0,Z=[];c.pos<b;){if(R<=0){var F=c.readVarint();W=7&F,R=F>>3}if(R--,W===1||W===2)I+=c.readSVarint(),h+=c.readSVarint(),W===1&&(s&&Z.push(s),s=[]),s.push(new n(I,h));else{if(W!==7)throw new Error("unknown command "+W);s&&s.push(s[0].clone())}}return s&&Z.push(s),Z},t.prototype.bbox=function(){var c=this._pbf;c.pos=this._geometry;for(var s=c.readVarint()+c.pos,b=1,W=0,R=0,I=0,h=1/0,Z=-1/0,F=1/0,V=-1/0;c.pos<s;){if(W<=0){var G=c.readVarint();b=7&G,W=G>>3}if(W--,b===1||b===2)(R+=c.readSVarint())<h&&(h=R),R>Z&&(Z=R),(I+=c.readSVarint())<F&&(F=I),I>V&&(V=I);else if(b!==7)throw new Error("unknown command "+b)}return[h,F,Z,V]},t.prototype.toGeoJSON=function(c,s,b){var W,R,I=this.extent*Math.pow(2,b),h=this.extent*c,Z=this.extent*s,F=this.loadGeometry(),V=t.types[this.type];function G(M){for(var S=0;S<M.length;S++){var f=M[S];M[S]=[360*(f.x+h)/I-180,360/Math.PI*Math.atan(Math.exp((180-360*(f.y+Z)/I)*Math.PI/180))-90]}}switch(this.type){case 1:var N=[];for(W=0;W<F.length;W++)N[W]=F[W][0];G(F=N);break;case 2:for(W=0;W<F.length;W++)G(F[W]);break;case 3:for(F=function(M){var S=M.length;if(S<=1)return[M];for(var f,T,v=[],L=0;L<S;L++){var D=o(M[L]);D!==0&&(T===void 0&&(T=D<0),T===D<0?(f&&v.push(f),f=[M[L]]):f.push(M[L]))}return f&&v.push(f),v}(F),W=0;W<F.length;W++)for(R=0;R<F[W].length;R++)G(F[W][R])}F.length===1?F=F[0]:V="Multi"+V;var X={type:"Feature",geometry:{type:V,coordinates:F},properties:this.properties};return"id"in this&&(X.id=this.id),X},nW}function Eu(){if(Su)return lW;Su=1;var n=vu();function t(o,c){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=o,this._keys=[],this._values=[],this._features=[],o.readFields(i,this,c),this.length=this._features.length}function i(o,c,s){o===15?c.version=s.readVarint():o===1?c.name=s.readString():o===5?c.extent=s.readVarint():o===2?c._features.push(s.pos):o===3?c._keys.push(s.readString()):o===4&&c._values.push(function(b){for(var W=null,R=b.readVarint()+b.pos;b.pos<R;){var I=b.readVarint()>>3;W=I===1?b.readString():I===2?b.readFloat():I===3?b.readDouble():I===4?b.readVarint64():I===5?b.readVarint():I===6?b.readSVarint():I===7?b.readBoolean():null}return W}(s))}return lW=t,t.prototype.feature=function(o){if(o<0||o>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[o];var c=this._pbf.readVarint()+this._pbf.pos;return new n(this._pbf,c,this.extent,this._keys,this._values)},lW}function Lu(){return fu||(fu=1,Ph.VectorTile=function(){if(Qu)return oW;Qu=1;var n=Eu();function t(i,o,c){if(i===3){var s=new n(c,c.readVarint()+c.pos);s.length&&(o[s.name]=s)}}return oW=function(i,o){this.layers=i.readFields(t,{},o)},oW}(),Ph.VectorTileFeature=vu(),Ph.VectorTileLayer=Eu()),Ph}var ec=Lu();class Jr extends ee{constructor(t,i,o){super(t,i),this.z=o}}class zu extends Jr{constructor(t,i,o,c){super(t,i,o),this.w=c}}function Kh(n,t,i,o){let c=[],s=o===0?(b,W,R,I,h,Z)=>{b.push(new ee(Z,R+(Z-W)/(I-W)*(h-R)))}:(b,W,R,I,h,Z)=>{b.push(new ee(W+(Z-R)/(h-R)*(I-W),Z))};for(let b of n){let W=[];for(let R of b){if(R.length<=2)continue;let I=[];for(let F=0;F<R.length-1;F++){let V=R[F].x,G=R[F].y,N=R[F+1].x,X=R[F+1].y,M=o===0?V:G,S=o===0?N:X;M<t?S>t&&s(I,V,G,N,X,t):M>i?S<i&&s(I,V,G,N,X,i):I.push(R[F]),S<t&&M>=t&&s(I,V,G,N,X,t),S>i&&M<=i&&s(I,V,G,N,X,i)}let h=R[R.length-1],Z=o===0?h.x:h.y;Z>=t&&Z<=i&&I.push(h),I.length&&(h=I[I.length-1],I[0].x===h.x&&I[0].y===h.y||I.push(I[0]),W.push(I))}W.length&&c.push(W)}return c}function wu(n,t,i,o){let c=i==="x"?"y":"x",s=(o-n[i])/(t[i]-n[i]);n[c]=n[c]+(t[c]-n[c])*s,n[i]=o,n.hasOwnProperty("z")&&(n.z=Je(n.z,t.z,s)),n.hasOwnProperty("w")&&(n.w=Je(n.w,t.w,s))}function Au(n,t,i,o){let c=i,s=o;for(let b of["x","y"]){let W=n,R=t;W[b]>=R[b]&&(W=t,R=n),W[b]<c&&R[b]>c&&wu(W,R,b,c),W[b]<s&&R[b]>s&&wu(R,W,b,s)}}let qh=Number.MAX_SAFE_INTEGER;function Hu(n,t,i,o){return n.order<t||n.order===qh||!(n.clipMask&i)||function(c,s){return s.length!==0&&s.find(b=>b===c)===void 0}(o,n.clipScope)}function $h(n,t){return n.x-t.x||n.y-t.y}function ju(n,t){return $h(n.min,t.min)===0&&$h(n.max,t.max)===0}function sW(n,t){return!(n.min.x>t.max.x||n.max.x<t.min.x||n.min.y>t.max.y||n.max.y<t.min.y)}function rW(n,t){if(n.length!==t.length)return!1;for(let i=0;i<n.length;i++)if(n[i].sourceId!==t[i].sourceId||!ju(n[i],t[i])||n[i].order!==t[i].order||n[i].clipMask!==t[i].clipMask||!il(n[i].clipScope,t[i].clipScope))return!1;return!0}function Ou(n,t,i){let o=1/ne,c=1/(1<<i.canonical.z),s=(t.x*o+i.canonical.x)*c+i.wrap,b=(t.y*o+i.canonical.y)*c;return{min:new ee((n.x*o+i.canonical.x)*c+i.wrap,(n.y*o+i.canonical.y)*c),max:new ee(s,b)}}function kI(n,t,i){let o=1<<i.canonical.z,c=((t.x-i.wrap)*o-i.canonical.x)*ne,s=(t.y*o-i.canonical.y)*ne;return{min:new ee(((n.x-i.wrap)*o-i.canonical.x)*ne,(n.y*o-i.canonical.y)*ne),max:new ee(c,s)}}function Du(n,t,i,o,c,s,b){let W=n.indices,R=n.vertices,I=[];for(let h=o;h<o+c;h+=3){let Z=t[i[h+0]+s],F=t[i[h+1]+s],V=t[i[h+2]+s],G=Math.min(Z.x,F.x,V.x),N=Math.max(Z.x,F.x,V.x),X=Math.min(Z.y,F.y,V.y),M=Math.max(Z.y,F.y,V.y);I.length=0,n.grid.query(new ee(G,X),new ee(N,M),I);for(let S=0;S<I.length;S++){let f=I[S];if(Yi(R[W[3*f+0]],R[W[3*f+1]],R[W[3*f+2]],Z,F,V,b))return!0}}return!1}function _u(n,t,i,o){if(!n||!i)return!1;let c=n.vertices;if(!t.canonical.equals(o.canonical)||t.wrap!==o.wrap){if(i.vertices.length<n.vertices.length)return _u(i,o,n,t);let s=t.canonical,b=o.canonical,W=Math.pow(2,b.z-s.z);c=n.vertices.map(R=>new ee((R.x+s.x*ne)*W-b.x*ne,(R.y+s.y*ne)*W-b.y*ne))}return Du(i,c,n.indices,0,n.indices.length,0,0)}function Pu(n,t,i,o){let c=Math.pow(2,o.z-i.z);return new ee((n+i.x*ne)*c-o.x*ne,(t+i.y*ne)*c-o.y*ne)}function Ku(n,t){let i=[];t.grid.queryPoint(n,i);let o=t.indices,c=t.vertices;for(let s=0;s<i.length;s++){let b=i[s];if(Si([c[o[3*b+0]],c[o[3*b+1]],c[o[3*b+2]]],n))return!0}return!1}let dW=[new ee(0,0),new ee(ne,0),new ee(ne,ne),new ee(0,ne)];function qu(n,t){let i=[],o=[];if(!t||n.length<2)return[n];if(n.length===2)return ta(n[0],n[1],dW)?[n]:[];for(let c=0;c<n.length+2;c++){let s=n[c%n.length],b=n[(c+1)%n.length],W=ta(c===0?n[n.length-1]:n[(c-1)%n.length],s,dW),R=ta(s,b,dW),I=W||R;I&&o.push(s),I&&R||o.length>0&&(o.length>1&&i.push(o),o=[])}return o.length>1&&i.push(o),i}let cW=ec.VectorTileFeature.types,SI=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],QI=["fill-extrusion-flood-light-ground-radius"],fI=Math.pow(2,13),vI=Math.pow(2,15)-1,$u=new ee(0,1),Us=2147483648;function Ob(n,t,i,o,c,s,b,W){n.emplaceBack((t<<1)+b,(i<<1)+s,(Math.floor(o*fI)<<1)+c,Math.round(W))}function Db(n,t,i){n.emplaceBack(t.x*ne,t.y*ne,i?1:0)}function t0(n,t,i,o,c,s){n.emplaceBack(t.x,t.y,(i.x<<1)+o,(i.y<<1)+c,s)}function _b(n,t,i){n.emplaceBack(t.x,t.y,t.z,i[0]*16384,i[1]*16384,i[2]*16384)}class tZ{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class eZ{constructor(){this.centroidXY=new ee(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new ee(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new ee(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new ee(this.max.x-this.min.x,this.max.y-this.min.y)}}class iZ{constructor(){this.acc=new ee(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(t,i){t.min.x===Number.MAX_VALUE&&(t.min.x=t.max.x=i.x,t.min.y=t.max.y=i.y)}appendEdge(t,i,o){this.accCount++,this.acc._add(i);let c=!!this.borders;i.x<t.min.x?(t.min.x=i.x,c=!0):i.x>t.max.x&&(t.max.x=i.x,c=!0),i.y<t.min.y?(t.min.y=i.y,c=!0):i.y>t.max.y&&(t.max.y=i.y,c=!0),((i.x===0||i.x===ne)&&i.x===o.x)!=((i.y===0||i.y===ne)&&i.y===o.y)&&this.processBorderOverlap(i,o),c&&this.checkBorderIntersection(i,o)}checkBorderIntersection(t,i){i.x<0!=t.x<0&&this.addBorderIntersection(0,Je(i.y,t.y,(0-i.x)/(t.x-i.x))),i.x>ne!=t.x>ne&&this.addBorderIntersection(1,Je(i.y,t.y,(ne-i.x)/(t.x-i.x))),i.y<0!=t.y<0&&this.addBorderIntersection(2,Je(i.x,t.x,(0-i.y)/(t.y-i.y))),i.y>ne!=t.y>ne&&this.addBorderIntersection(3,Je(i.x,t.x,(ne-i.y)/(t.y-i.y)))}addBorderIntersection(t,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let o=this.borders[t];i<o[0]&&(o[0]=i),i>o[1]&&(o[1]=i)}processBorderOverlap(t,i){if(t.x===i.x){if(t.y===i.y)return;let o=t.x===0?0:1;this.addBorderIntersection(o,i.y),this.addBorderIntersection(o,t.y)}else{let o=t.y===0?2:3;this.addBorderIntersection(o,i.x),this.addBorderIntersection(o,t.x)}}centroid(){return this.accCount===0?new ee(0,0):new ee(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((t,i)=>t+ +(i[0]!==Number.MAX_VALUE),0):0}}function aZ(n,t){let i=n.add(t)._unit(),o=ze(n.x*i.x+n.y*i.y,-1,1);var c,s,b;return b=Math.acos(o),Math.min(4,Math.max(-4,Math.tan(b)))/4*vI*((c=n).x*(s=t).y-c.y*s.x<0?-1:1)}let EI=[n=>n.x<0,n=>n.x>ne,n=>n.y<0,n=>n.y>ne];function LI(n,t,i,o){let c=[4];if(o===0)return c;i._mult(o);let s=n.sub(i),b=t.sub(i),W=[n,t,s,b];for(let R=0;R<4;R++)for(let I of W)if(EI[R](I)){c.push(R);break}return c}class nZ{constructor(t){this.vertexArray=new Ad,this.indexArray=new Ja,this.programConfigurations=new io(t.layers,{zoom:t.zoom,lut:t.lut},i=>QI.includes(i)),this._segments=new Oi,this.hiddenByLandmarkVertexArray=new Dd,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Oi}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(t,i,o,c=!1){let s=t.length;if(s>2){let b=Math.max(0,this._segments.get().length-1),W=this._segments._prepareSegment(4*s,this.vertexArray.length,2*this._segmentToGroundQuads[b].length),R;b!==this._segments.get().length-1&&(b++,this._segmentToGroundQuads[b]=[],this._segmentToRegionTriCounts[b]=[0,0,0,0,0]);{let I=t[0],h=t[1];R=aZ(I.sub(t[s-1])._perp()._unit(),h.sub(I)._perp()._unit())}for(let I=0;I<s;I++){let h=I===s-1?0:I+1,Z=t[I],F=t[h],V=t[h===s-1?0:h+1],G=F.sub(Z)._perp()._unit(),N=aZ(G,V.sub(F)._perp()._unit()),X=R,M=N;if(bW(Z,F,i)||c&&sZ(Z,i)&&sZ(F,i)){R=N;continue}let S=W.vertexLength;t0(this.vertexArray,Z,F,1,1,X),t0(this.vertexArray,Z,F,1,0,X),t0(this.vertexArray,Z,F,0,1,M),t0(this.vertexArray,Z,F,0,0,M),W.vertexLength+=4;let f=LI(Z,F,G,o);for(let T of f)this._segmentToGroundQuads[b].push({id:S,region:T}),this._segmentToRegionTriCounts[b][T]+=2,W.primitiveLength+=2;R=N}}}prepareBorderSegments(){if(!this.hasData())return;let t=this._segments.get(),i=t.length;for(let o=0;o<i;o++)this._segmentToGroundQuads[o].sort((c,s)=>c.region-s.region);for(let o=0;o<i;o++){let c=this._segmentToGroundQuads[o],s=t[o],b=this._segmentToRegionTriCounts[o];b.reduce((R,I)=>R+I,0);let W=0;for(let R=0;R<=4;R++){let I=b[R];if(I!==0){let h=this.regionSegments[R];h||(h=this.regionSegments[R]=new Oi);let Z={vertexOffset:s.vertexOffset,primitiveOffset:s.primitiveOffset+W,vertexLength:s.vertexLength,primitiveLength:I};h.get().push(Z)}W+=I}for(let R=0;R<c.length;R++){let I=c[R].id;this.indexArray.emplaceBack(I,I+1,I+3),this.indexArray.emplaceBack(I,I+3,I+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(t,i,o,c,s,b){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,t,i,o,c,s,b)}upload(t){this.hasData()&&(this.vertexBuffer=t.createVertexBuffer(this.vertexArray,XI.members),this.indexBuffer=t.createIndexBuffer(this.indexArray))}uploadPaintProperties(t){this.hasData()&&this.programConfigurations.upload(t)}update(t,i,o,c,s,b){this.hasData()&&this.programConfigurations.updatePaintArrays(t,i,o,c,s,b)}updateHiddenByLandmark(t){if(!this.hasData())return;let i=t.groundVertexCount+t.groundVertexArrayOffset;if(t.groundVertexCount===0)return;let o=t.flags&Us?1:0;for(let c=t.groundVertexArrayOffset;c<i;++c)this.hiddenByLandmarkVertexArray.emplace(c,o);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(t){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=t.createVertexBuffer(this.hiddenByLandmarkVertexArray,MI.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let t=0;t<=4;t++){let i=this.regionSegments[t];i&&i.destroy()}}}}class e0{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Ja,this.footprintVertices=new ql,this.footprintSegments=[],this.layoutVertexArray=new $l,this.centroidVertexArray=new Sh,this.wallVertexArray=new Sb,this.indexArray=new Ja,this.programConfigurations=new io(t.layers,{zoom:t.zoom,lut:t.lut},i=>SI.includes(i)),this.segments=new Oi,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new nZ(t),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(t,i){}populate(t,i,o,c){this.features=[],this.hasPattern=tW("fill-extrusion",this.layers,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=ht(o),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(let{feature:s,id:b,index:W,sourceLayerIndex:R}of t){let I=this.layers[0]._featureFilter.needGeometry,h=qt(s,I);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),h,o))continue;let Z={id:b,sourceLayerIndex:R,index:W,geometry:I?h.geometry:_t(s,o,c),properties:s.properties,type:s.type,patterns:{}},F=this.layoutVertexArray.length,V=cW[Z.type]==="Polygon";if(this.hasPattern)this.features.push(eW("fill-extrusion",this.layers,Z,this.zoom,i));else if(this.wallMode)for(let G of Z.geometry)for(let N of qu(G,V))this.addFeature(Z,[N],W,o,{},i.availableImages,c,i.brightness);else this.addFeature(Z,Z.geometry,W,o,{},i.availableImages,c,i.brightness);i.featureIndex.insert(s,Z.geometry,W,R,this.index,F)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(t,i,o,c,s,b){for(let W of this.features){let R=cW[W.type]==="Polygon",{geometry:I}=W;if(this.wallMode)for(let h of I)for(let Z of qu(h,R))this.addFeature(W,[Z],W.index,i,o,c,s,b);else this.addFeature(W,I,W.index,i,o,c,s,b)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(t,i,o,c,s){let b=Object.keys(t).length!==0;if(b&&!this.stateDependentLayers.length)return;let W=b?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(t,i,W,o,c,s),this.groundEffect.update(t,i,W,o,c,s)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,CI),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.wallVertexBuffer=t.createVertexBuffer(this.wallVertexArray,BI.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,TI.members,!0)),this.groundEffect.upload(t)),this.groundEffect.uploadPaintProperties(t),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){this.groundEffect.uploadHiddenByLandmark(t),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,yI.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,i,o,c,s,b,W,R){let I=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(t,{})/this.tileToMeter,h=[new ee(0,0),new ee(ne,ne)],Z=W.projection,F=Z.name==="globe",V=this.wallMode||cW[t.type]==="Polygon",G=new iZ;G.centroidDataIndex=this.centroidData.length;let N=new eZ,X=this.layers[0].paint.get("fill-extrusion-base").evaluate(t,{},c)<=0,M=this.layers[0].paint.get("fill-extrusion-height").evaluate(t,{},c),S;if(N.height=M,N.vertexArrayOffset=this.layoutVertexArray.length,N.groundVertexArrayOffset=this.groundEffect.vertexArray.length,F&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Hd),this.wallMode){if(F)return void mi("Non zero fill-extrusion-line-width is not yet supported on globe.");if(i.length!==1)return;S=function(P){let st=P[0].x===P[P.length-1].x&&P[0].y===P[P.length-1].y;(function(Pt){let jt=0,xe=Pt.length;for(let oe=0;oe<xe;oe++)jt+=(Pt[(oe+1)%xe].x-Pt[oe].x)*(Pt[(oe+1)%xe].y+Pt[oe].y);return jt>=0})(P)||(P=P.reverse());let dt={geometry:[],joinNormals:[],indices:[]},Zt=[],Vt=[],Rt=[],Ft=P.length;if(Ft<(st?3:2))return dt;for(;Ft>=2&&P[Ft-1].equals(P[Ft-2]);)Ft--;let yt,xt,ft,At,Ct,se=0;for(;se<Ft-1&&P[se].equals(P[se+1]);)se++;st&&(yt=P[Ft-2],Ct=P[se].sub(yt)._unit()._perp());for(let Pt=se;Pt<Ft;Pt++){if(ft=Pt===Ft-1?st?P[se+1]:void 0:P[Pt+1],ft&&P[Pt].equals(ft))continue;Ct&&(At=Ct),yt&&(xt=yt),yt=P[Pt],Ct=ft?ft.sub(yt)._unit()._perp():At,At=At||Ct;let jt=At.add(Ct);jt.x===0&&jt.y===0||jt._unit();let xe=jt.x*Ct.x+jt.y*Ct.y,oe=xe!==0?1/xe:1/0,me=At.x*Ct.y-At.y*Ct.x>0,Ce="miter",Ke=2;Ce==="miter"&&oe>Ke&&(Ce="bevel"),Ce==="bevel"&&(oe>100&&(Ce="flipbevel"),oe<Ke&&(Ce="miter"));let Ae=(He,$e,ei,yi)=>{let Fi=new ee(He.x,He.y),Se=new ee(He.x,He.y);Fi.x+=$e.x*yi,Fi.y+=$e.y*yi,Se.x-=$e.x*Math.max(ei,1),Se.y-=$e.y*Math.max(ei,1),Rt.push($e),Zt.push(Fi),Vt.push(Se)};if(Ce==="miter")jt._mult(oe),Ae(yt,jt,0,0);else if(Ce==="flipbevel")jt=Ct.mult(-1),Ae(yt,jt,0,0),Ae(yt,jt.mult(-1),0,0);else{let He=-Math.sqrt(oe*oe-1),$e=me?He:0,ei=me?0:He;xt&&Ae(yt,At,$e,ei),ft&&Ae(yt,Ct,$e,ei)}}dt.geometry=[...Zt,...Vt.reverse(),Zt[0]],dt.joinNormals=[...Rt,...Rt.reverse(),Rt[Rt.length-1]];let ae=dt.geometry.length-1;for(let Pt=0;Pt<ae/2;Pt++)if(Pt+1<ae/2){let jt=Pt,xe=Pt+1,oe=ae-1-Pt,me=ae-2-Pt;jt=jt===0?ae-1:jt-1,xe=xe===0?ae-1:xe-1,oe=oe===0?ae-1:oe-1,me=me===0?ae-1:me-1,dt.indices.push(oe),dt.indices.push(xe),dt.indices.push(jt),dt.indices.push(oe),dt.indices.push(me),dt.indices.push(xe)}return dt}(i[0]),i=[S.geometry]}let f=(P,st)=>P<(st.length-1)/2||P===st.length-1,T=this.wallMode?[i]:_h(i,500);for(let P=T.length-1;P>=0;P--){let st=T[P];(st.length===0||(v=st[0]).every(it=>it.x<=0)||v.every(it=>it.x>=ne)||v.every(it=>it.y<=0)||v.every(it=>it.y>=ne))&&T.splice(P,1)}var v;let L;if(F)L=bZ(T,h,c);else{L=[];for(let P of T)L.push({polygon:P,bounds:h})}let D=V?this.edgeRadius:0,q=D>0&&this.zoom<17,tt=(P,st)=>{if(P.length===0)return!1;let it=P[P.length-1];return st.x===it.x&&st.y===it.y};for(let{polygon:P,bounds:st}of L){let it=0,dt=0;for(let Ft of P)V&&!Ft[0].equals(Ft[Ft.length-1])&&Ft.push(Ft[0]),dt+=V?Ft.length-1:Ft.length;let Zt=this.segments.prepareSegment((V?5:4)*dt,this.layoutVertexArray,this.indexArray);N.footprintSegIdx<0&&(N.footprintSegIdx=this.footprintSegments.length),N.polygonSegIdx<0&&(N.polygonSegIdx=this.polygonSegments.length);let Vt={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Rt=new tZ;if(Rt.vertexOffset=this.footprintVertices.length,Rt.indexOffset=3*this.footprintIndices.length,Rt.ringIndices=[],V){let Ft=[],yt=[];it=Zt.vertexLength;for(let ft=0;ft<P.length;ft++){let At=P[ft];At.length&&ft!==0&&yt.push(Ft.length/2);let Ct=[],se,ae;se=At[1].sub(At[0])._perp()._unit(),Rt.ringIndices.push(At.length-1);for(let Pt=1;Pt<At.length;Pt++){let jt=At[Pt],xe=At[Pt===At.length-1?1:Pt+1],oe=jt.clone();if(D){ae=xe.sub(jt)._perp()._unit();let me=se.add(ae)._unit(),Ce=D*Math.min(4,1/(se.x*me.x+se.y*me.y));oe.x+=Ce*me.x,oe.y+=Ce*me.y,oe.x=Math.round(oe.x),oe.y=Math.round(oe.y),se=ae}if(!X||D!==0&&!q||tt(Ct,oe)||Ct.push(oe),Ob(this.layoutVertexArray,oe.x,oe.y,0,0,1,1,0),this.wallMode){let me=f(Pt,At);Db(this.wallVertexArray,S.joinNormals[Pt],!me)}Zt.vertexLength++,this.footprintVertices.emplaceBack(jt.x,jt.y),Ft.push(jt.x,jt.y),F&&_b(this.layoutVertexExtArray,Z.projectTilePoint(oe.x,oe.y,c),Z.upVector(c,oe.x,oe.y))}X&&(D===0||q)&&(Ct.length!==0&&tt(Ct,Ct[0])&&Ct.pop(),this.groundEffect.addData(Ct,st,I))}let xt=this.wallMode?S.indices:wb(Ft,yt);for(let ft=0;ft<xt.length;ft+=3)this.footprintIndices.emplaceBack(Rt.vertexOffset+xt[ft+0],Rt.vertexOffset+xt[ft+1],Rt.vertexOffset+xt[ft+2]),this.indexArray.emplaceBack(it+xt[ft],it+xt[ft+2],it+xt[ft+1]),Zt.primitiveLength++;Rt.indexCount+=xt.length,Rt.vertexCount+=this.footprintVertices.length-Rt.vertexOffset}for(let Ft=0;Ft<P.length;Ft++){let yt=P[Ft];G.startRing(N,yt[0]);let xt=yt.length>4&&rZ(yt[yt.length-2],yt[0],yt[1]),ft=D?zI(yt[yt.length-2],yt[0],yt[1],D):0,At=[],Ct,se,ae;se=yt[1].sub(yt[0])._perp()._unit();let Pt=!0;for(let jt=1,xe=0;jt<yt.length;jt++){let oe=yt[jt-1],me=yt[jt],Ce=yt[jt===yt.length-1?1:jt+1];if(G.appendEdge(N,me,oe),bW(me,oe,st)){D&&(se=Ce.sub(me)._perp()._unit(),Pt=!Pt);continue}let Ke=me.sub(oe)._perp(),Ae=Ke.x/(Math.abs(Ke.x)+Math.abs(Ke.y)),He=Ke.y>0?1:0,$e=oe.dist(me);if(xe+$e>32768&&(xe=0),D){ae=Ce.sub(me)._perp()._unit();let Se=oZ(oe,me,Ce,lZ(se,ae),D);isNaN(Se)&&(Se=0);let ui=me.sub(oe)._unit();oe=oe.add(ui.mult(ft))._round(),me=me.add(ui.mult(-Se))._round(),ft=Se,se=ae,X&&this.zoom>=17&&(tt(At,oe)||At.push(oe),tt(At,me)||At.push(me))}let ei=Zt.vertexLength,yi=yt.length>4&&rZ(oe,me,Ce),Fi=dZ(xe,xt,Pt);if(Ob(this.layoutVertexArray,oe.x,oe.y,Ae,He,0,0,Fi),Ob(this.layoutVertexArray,oe.x,oe.y,Ae,He,0,1,Fi),this.wallMode){let Se=f(jt-1,yt),ui=S.joinNormals[jt-1];Db(this.wallVertexArray,ui,Se),Db(this.wallVertexArray,ui,Se)}if(xe+=$e,Fi=dZ(xe,yi,!Pt),xt=yi,Ob(this.layoutVertexArray,me.x,me.y,Ae,He,0,0,Fi),Ob(this.layoutVertexArray,me.x,me.y,Ae,He,0,1,Fi),this.wallMode){let Se=f(jt,yt),ui=S.joinNormals[jt];Db(this.wallVertexArray,ui,Se),Db(this.wallVertexArray,ui,Se)}if(Zt.vertexLength+=4,this.indexArray.emplaceBack(ei+0,ei+1,ei+2),this.indexArray.emplaceBack(ei+1,ei+3,ei+2),Zt.primitiveLength+=2,D){let Se=it+(jt===1?yt.length-2:jt-2),ui=jt===1?it:Se+1;if(this.indexArray.emplaceBack(ei+1,Se,ei+3),this.indexArray.emplaceBack(Se,ui,ei+3),Zt.primitiveLength+=2,Ct===void 0&&(Ct=ei),!bW(Ce,yt[jt],st)){let gi=jt===yt.length-1?Ct:Zt.vertexLength;this.indexArray.emplaceBack(ei+2,ei+3,gi),this.indexArray.emplaceBack(ei+3,gi+1,gi),this.indexArray.emplaceBack(ei+3,ui,gi+1),Zt.primitiveLength+=3}Pt=!Pt}if(F){let Se=this.layoutVertexExtArray,ui=Z.projectTilePoint(oe.x,oe.y,c),gi=Z.projectTilePoint(me.x,me.y,c),Qi=Z.upVector(c,oe.x,oe.y),qi=Z.upVector(c,me.x,me.y);_b(Se,ui,Qi),_b(Se,ui,Qi),_b(Se,gi,qi),_b(Se,gi,qi)}}V&&(it+=yt.length-1),X&&D&&this.zoom>=17&&(At.length!==0&&tt(At,At[0])&&At.pop(),this.groundEffect.addData(At,st,I,D>0))}this.footprintSegments.push(Rt),Vt.triangleCount=this.indexArray.length-Vt.triangleArrayOffset,this.polygonSegments.push(Vt),++N.footprintSegLen,++N.polygonSegLen}if(N.vertexCount=this.layoutVertexArray.length-N.vertexArrayOffset,N.groundVertexCount=this.groundEffect.vertexArray.length-N.groundVertexArrayOffset,N.vertexCount!==0){if(N.centroidXY=G.borders?$u:this.encodeCentroid(G,N),this.centroidData.push(N),G.borders){this.featuresOnBorder.push(G);let P=this.featuresOnBorder.length-1;for(let st=0;st<G.borders.length;st++)G.borders[st][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[st].push(P)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,s,b,c,R),this.groundEffect.addPaintPropertiesData(t,o,s,b,c,R),this.maxHeight=Math.max(this.maxHeight,M)}}sortBorders(){for(let t=0;t<this.borderFeatureIndices.length;t++)this.borderFeatureIndices[t].sort((i,o)=>this.featuresOnBorder[i].borders[t][0]-this.featuresOnBorder[o].borders[t][0])}splitToSubtiles(){let t=[];for(let W=0;W<this.centroidData.length;W++){let R=this.centroidData[W],I=+(R.min.y+R.max.y>ne),h=2*I+(+(R.min.x+R.max.x>ne)^I);for(let Z=0;Z<R.polygonSegLen;Z++){let F=R.polygonSegIdx+Z;t.push({centroidIdx:W,subtile:h,polygonSegmentIdx:F,triangleSegmentIdx:this.polygonSegments[F].triangleSegIdx})}}let i=new Ja;t.sort((W,R)=>W.triangleSegmentIdx===R.triangleSegmentIdx?W.subtile-R.subtile:W.triangleSegmentIdx-R.triangleSegmentIdx);let o=0,c=0,s=0;for(let W of t){if(W.triangleSegmentIdx!==o)break;s++}let b=t.length;for(;c!==t.length;){o=t[c].triangleSegmentIdx;let W=0,R=c,I=c;for(let h=R;h<s&&t[h].subtile===W;h++)I++;for(;R!==s;){let h=t[R];W=h.subtile;let Z=this.centroidData[h.centroidIdx].min.clone(),F=this.centroidData[h.centroidIdx].max.clone(),V={vertexOffset:this.segments.segments[o].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[o].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let G=R;G<I;G++){let N=t[G],X=this.polygonSegments[N.polygonSegmentIdx],M=this.centroidData[N.centroidIdx].min,S=this.centroidData[N.centroidIdx].max,f=this.indexArray.uint16;for(let T=X.triangleArrayOffset;T<X.triangleArrayOffset+X.triangleCount;T++)i.emplaceBack(f[3*T],f[3*T+1],f[3*T+2]);V.primitiveLength+=X.triangleCount,Z.x=Math.min(Z.x,M.x),Z.y=Math.min(Z.y,M.y),F.x=Math.max(F.x,S.x),F.y=Math.max(F.y,S.y)}V.primitiveLength>0&&this.triangleSubSegments.push({segment:V,min:Z,max:F}),R=I;for(let G=R;G<s&&t[G].subtile===t[R].subtile;G++)I++}c=s;for(let h=c;h<b&&t[h].triangleSegmentIdx===t[c].triangleSegmentIdx;h++)s++}i._trim(),this.indexArray=i}getVisibleSegments(t,i,o){let c=new Oi;if(this.wallMode){for(let N of this.triangleSubSegments)c.segments.push(N.segment);return c}let s=0,b=0,W=1<<t.canonical.z;if(i){let N=i.getMinMaxForTile(t);N&&(s=N.min,b=N.max)}b+=this.maxHeight;let R=t.toUnwrapped(),I,h=[R.canonical.x/W+R.wrap,R.canonical.y/W],Z=[(R.canonical.x+1)/W+R.wrap,(R.canonical.y+1)/W],F=(N,X,M)=>[N[0]*(1-M[0])+X[0]*M[0],N[1]*(1-M[1])+X[1]*M[1]],V=[],G=[];for(let N of this.triangleSubSegments){V[0]=N.min.x/ne,V[1]=N.min.y/ne,G[0]=N.max.x/ne,G[1]=N.max.y/ne;let X=F(h,Z,V),M=F(h,Z,G);if(new Ci([X[0],X[1],s],[M[0],M[1],b]).intersectsPrecise(o)===0){I&&(c.segments.push(I),I=void 0);continue}let S=N.segment;I&&I.vertexOffset!==S.vertexOffset&&(c.segments.push(I),I=void 0),I?(I.vertexLength+=S.vertexLength,I.primitiveLength+=S.primitiveLength):I={vertexOffset:S.vertexOffset,primitiveLength:S.primitiveLength,vertexLength:S.vertexLength,primitiveOffset:S.primitiveOffset,sortKey:void 0,vaos:{}}}return I&&c.segments.push(I),c}encodeCentroid(t,i){let o=t.centroid(),c=i.span(),s=Math.min(7,Math.round(c.x*this.tileToMeter/10)),b=Math.min(7,Math.round(c.y*this.tileToMeter/10));return new ee(ze(o.x,1,ne-1)<<3|s,ze(o.y,1,ne-1)<<3|b)}encodeBorderCentroid(t){if(!t.borders)return new ee(0,0);let i=t.borders,o=Number.MAX_VALUE;if(i[0][0]!==o||i[1][0]!==o){let c=i[0][0]!==o?0:1;return new ee(6|(i[0][0]!==o?0:65528),(i[c][0]+i[c][1])/2<<3|6)}{let c=i[2][0]!==o?2:3;return new ee((i[c][0]+i[c][1])/2<<3|6,6|(i[2][0]!==o?0:65528))}}showCentroid(t){let i=this.centroidData[t.centroidDataIndex];i.flags&=Us,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(t){this.groundEffect.updateHiddenByLandmark(t);let i=t.vertexArrayOffset,o=t.vertexCount+t.vertexArrayOffset,c=t.flags&Us?$u:t.centroidXY,s=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==c.y||s!==c.x){for(let b=i;b<o;++b)this.centroidVertexArray.emplace(b,c.x,c.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let t of this.centroidData)this.writeCentroidToBuffer(t)}updateReplacement(t,i,o){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;let c=i.getReplacementRegionsForTile(t.toUnwrapped());if(rW(this.activeReplacements,c))return;if(this.activeReplacements=c,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(let b of this.centroidData)b.flags&=2147483647;let s=[];for(let b of this.activeReplacements){if(b.order<o)continue;let W=Math.pow(2,b.footprintTileId.canonical.z-t.canonical.z);for(let R of this.centroidData)if(!(R.flags&Us||b.min.x>R.max.x||R.min.x>b.max.x||b.min.y>R.max.y||R.min.y>b.max.y))for(let I=0;I<R.footprintSegLen;I++){let h=this.footprintSegments[R.footprintSegIdx+I];if(s.length=0,wI(this.footprintVertices,h.vertexOffset,h.vertexCount,b.footprintTileId.canonical,t.canonical,s),Du(b.footprint,s,this.footprintIndices.uint16,h.indexOffset,h.indexCount,-h.vertexOffset,-W)){R.flags|=Us;break}}}for(let b of this.centroidData)this.writeCentroidToBuffer(b);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(t,i,o){let c=!1;for(let s=0;s<o.footprintSegLen;s++){let b=this.footprintSegments[o.footprintSegIdx+s],W=0;for(let R of b.ringIndices){for(let I=W,h=R+W-1;I<R+W;h=I++){let Z=this.footprintVertices.int16[2*(I+b.vertexOffset)+0],F=this.footprintVertices.int16[2*(I+b.vertexOffset)+1],V=this.footprintVertices.int16[2*(h+b.vertexOffset)+1];F>i!=V>i&&t<(this.footprintVertices.int16[2*(h+b.vertexOffset)+0]-Z)*(i-F)/(V-F)+Z&&(c=!c)}W=R}}return c}getHeightAtTileCoord(t,i){let o=Number.NEGATIVE_INFINITY,c=!0,s=4*(t+ne)*ne+(i+ne);if(this.partLookup.hasOwnProperty(s)){let b=this.partLookup[s];return b?{height:b.height,hidden:!!(b.flags&Us)}:void 0}for(let b of this.centroidData)t>b.max.x||b.min.x>t||i>b.max.y||b.min.y>i||this.footprintContainsPoint(t,i,b)&&b&&b.height>o&&(o=b.height,this.partLookup[s]=b,c=!!(b.flags&Us));if(o!==Number.NEGATIVE_INFINITY)return{height:o,hidden:c};this.partLookup[s]=void 0}}function lZ(n,t){let i=n.add(t)._unit();return n.x*i.x+n.y*i.y}function zI(n,t,i,o){let c=t.sub(n)._perp()._unit(),s=i.sub(t)._perp()._unit();return oZ(n,t,i,lZ(c,s),o)}function oZ(n,t,i,o,c){let s=Math.sqrt(1-o*o);return Math.min(n.dist(t)/3,t.dist(i)/3,c*s/o)}function bW(n,t,i){return n.x<i[0].x&&t.x<i[0].x||n.x>i[1].x&&t.x>i[1].x||n.y<i[0].y&&t.y<i[0].y||n.y>i[1].y&&t.y>i[1].y}function sZ(n,t){return n.x<t[0].x||n.x>t[1].x||n.y<t[0].y||n.y>t[1].y}function rZ(n,t,i){if(n.x<0||n.x>=ne||t.x<0||t.x>=ne||i.x<0||i.x>=ne)return!1;let o=i.sub(t),c=o.perp(),s=n.sub(t);return(o.x*s.x+o.y*s.y)/Math.sqrt((o.x*o.x+o.y*o.y)*(s.x*s.x+s.y*s.y))>-.866&&c.x*s.x+c.y*s.y<0}function dZ(n,t,i){let o=t?2|n:-3&n;return i?1|o:-2&o}function cZ(){let n=Math.PI/32,t=Math.tan(n),i=C;return i*Math.sqrt(1+2*t*t)-i}function bZ(n,t,i){let o=1<<i.z,c=nt(i.x/o),s=nt((i.x+1)/o),b=at(i.y/o),W=at((i.y+1)/o);return function(R,I,h,Z,F=0,V){let G=[];if(!R.length||!h||!Z)return G;let N=(L,D)=>{for(let q of L)G.push({polygon:q,bounds:D})},X=Math.ceil(Math.log2(h)),M=Math.ceil(Math.log2(Z)),S=X-M,f=[];for(let L=0;L<Math.abs(S);L++)f.push(S>0?0:1);for(let L=0;L<Math.min(X,M);L++)f.push(0),f.push(1);let T=R;if(T=Kh(T,I[0].y-F,I[1].y+F,1),T=Kh(T,I[0].x-F,I[1].x+F,0),!T.length)return G;let v=[];for(f.length?v.push({polygons:T,bounds:I,depth:0}):N(T,I);v.length;){let L=v.pop(),D=L.depth,q=f[D],tt=L.bounds[0],P=L.bounds[1],st=q===0?tt.x:tt.y,it=q===0?P.x:P.y,dt=V?V(q,st,it):.5*(st+it),Zt=Kh(L.polygons,st-F,dt+F,q),Vt=Kh(L.polygons,dt-F,it+F,q);if(Zt.length){let Rt=[tt,new ee(q===0?dt:P.x,q===1?dt:P.y)];f.length>D+1?v.push({polygons:Zt,bounds:Rt,depth:D+1}):N(Zt,Rt)}if(Vt.length){let Rt=[new ee(q===0?dt:tt.x,q===1?dt:tt.y),P];f.length>D+1?v.push({polygons:Vt,bounds:Rt,depth:D+1}):N(Vt,Rt)}}return G}(n,t,Math.ceil((s-c)/11.25),Math.ceil((b-W)/11.25),1,(R,I,h)=>{if(R===0)return .5*(I+h);{let Z=at((i.y+I/ne)/o);return(et(.5*(at((i.y+h/ne)/o)+Z))*o-i.y)*ne}})}function wI(n,t,i,o,c,s){let b=Math.pow(2,o.z-c.z);for(let W=0;W<i;W++){let R=n.int16[2*(W+t)+0],I=n.int16[2*(W+t)+1];R=(R+c.x*ne)*b-o.x*ne,I=(I+c.y*ne)*b-o.y*ne,s.push(new ee(R,I))}}let mZ,hZ;function Pb(n,t){return n.x*t.x+n.y*t.y}function pZ(n,t){if(n.length===1){let i=0,o=t[i++],c;for(;!c||o.equals(c);)if(c=t[i++],!c)return 1/0;for(;i<t.length;i++){let s=t[i],b=n[0],W=c.sub(o),R=s.sub(o),I=b.sub(o),h=Pb(W,W),Z=Pb(W,R),F=Pb(R,R),V=Pb(I,W),G=Pb(I,R),N=h*F-Z*Z,X=(F*V-Z*G)/N,M=(h*G-Z*V)/N,S=o.z*(1-X-M)+c.z*X+s.z*M;if(isFinite(S))return S}return 1/0}{let i=1/0;for(let o of t)i=Math.min(i,o.z);return i}}function WZ(n,t,i,o,c,s,b,W){let R=b*c.getElevationAt(n,t,!0,!0),I=s[0]!==0,h=I?s[1]===0?b*(s[0]/7-450):b*function(Z,F,V){let G=Math.floor(F[0]/8),N=Math.floor(F[1]/8),X=10*(F[0]-8*G),M=10*(F[1]-8*N),S=Z.getElevationAt(G,N,!0,!0),f=Z.getMeterToDEM(V),T=Math.floor(.5*(X*f-1)),v=Math.floor(.5*(M*f-1)),L=Z.tileCoordToPixel(G,N),D=2*T+1,q=2*v+1,tt=function(Vt,Rt,Ft,yt,xt){return[Vt.getElevationAtPixel(Rt,Ft,!0),Vt.getElevationAtPixel(Rt+xt,Ft,!0),Vt.getElevationAtPixel(Rt,Ft+xt,!0),Vt.getElevationAtPixel(Rt+yt,Ft+xt,!0)]}(Z,L.x-T,L.y-v,D,q),P=Math.abs(tt[0]-tt[1]),st=Math.abs(tt[2]-tt[3]),it=Math.abs(tt[0]-tt[2])+Math.abs(tt[1]-tt[3]),dt=Math.min(.25,.5*f*(P+st)/D),Zt=Math.min(.25,.5*f*it/q);return S+Math.max(dt*X,Zt*M)}(c,s,W):R;return{base:R+(i===0)?-1:i,top:I?Math.max(h+o,R+i+2):R+o}}he(e0,"FillExtrusionBucket",{omit:["layers","features"]}),he(eZ,"PartData"),he(tZ,"FootprintSegment"),he(iZ,"BorderCentroidData"),he(nZ,"GroundEffect");let AI=pi([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),HI=pi([{name:"a_z_offset",components:1,type:"Float32"}],4),{members:jI}=AI,OI=pi([{name:"a_packed",components:4,type:"Float32"}]),{members:DI}=OI,_I=pi([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:PI}=_I;class uZ{constructor(t,i){this.width=t,this.height=i,this.nextRow=0,this.image=new Is({width:t,height:i}),this.positions={},this.uploaded=!1}getDash(t,i){let o=this.getKey(t,i);return this.positions[o]}trim(){let t=this.width,i=this.height=As(this.nextRow);this.image.resize({width:t,height:i})}getKey(t,i){return t.join(",")+i}getDashRanges(t,i,o){let c=[],s=t.length%2==1?-t[t.length-1]*o:0,b=t[0]*o,W=!0;c.push({left:s,right:b,isDash:W,zeroLength:t[0]===0});let R=t[0];for(let I=1;I<t.length;I++){W=!W;let h=t[I];s=R*o,R+=h,b=R*o,c.push({left:s,right:b,isDash:W,zeroLength:h===0})}return c}addRoundDash(t,i,o){let c=i/2;for(let s=-o;s<=o;s++){let b=this.width*(this.nextRow+o+s),W=0,R=t[W];for(let I=0;I<this.width;I++){I/R.right>1&&(R=t[++W]);let h=Math.abs(I-R.left),Z=Math.abs(I-R.right),F=Math.min(h,Z),V,G=s/o*(c+1);if(R.isDash){let N=c-Math.abs(G);V=Math.sqrt(F*F+N*N)}else V=c-Math.sqrt(F*F+G*G);this.image.data[b+I]=Math.max(0,Math.min(255,V+128))}}}addRegularDash(t,i){for(let R=t.length-1;R>=0;--R){let I=t[R],h=t[R+1];I.zeroLength?t.splice(R,1):h&&h.isDash===I.isDash&&(h.left=I.left,t.splice(R,1))}let o=t[0],c=t[t.length-1];o.isDash===c.isDash&&(o.left=c.left-this.width,c.right=o.right+this.width);let s=this.width*this.nextRow,b=0,W=t[b];for(let R=0;R<this.width;R++){R/W.right>1&&(W=t[++b]);let I=Math.abs(R-W.left),h=Math.abs(R-W.right),Z=Math.min(I,h);this.image.data[s+R]=Math.max(0,Math.min(255,(W.isDash?Z:-Z)+i+128))}}addDash(t,i){let o=this.getKey(t,i);if(this.positions[o])return this.positions[o];let c=i==="round",s=c?7:0,b=2*s+1;if(this.nextRow+b>this.height)return mi("LineAtlas out of space"),null;t.length===0&&t.push(1);let W=0;for(let h=0;h<t.length;h++)t[h]<0&&(mi("Negative value is found in line dasharray, replacing values with 0"),t[h]=0),W+=t[h];if(W!==0){let h=this.width/W,Z=this.getDashRanges(t,this.width,h);c?this.addRoundDash(Z,h,s):this.addRegularDash(Z,i==="square"?.5*h:0)}let R=this.nextRow+s;this.nextRow+=b;let I={tl:[R,s],br:[W,0]};return this.positions[o]=I,I}}he(uZ,"LineAtlas");let KI=ec.VectorTileFeature.types,qI=Math.cos(Math.PI/180*37.5),$I=Math.cos(Math.PI/180*5);class mW{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.hasZOffset=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new Nb,this.layoutVertexArray2=new Bl,this.patternVertexArray=new to,this.indexArray=new Ja,this.programConfigurations=new io(t.layers,{zoom:t.zoom,lut:t.lut}),this.segments=new Oi,this.maxLineLength=0,this.zOffsetVertexArray=new us,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=t.tessellationStep?t.tessellationStep:ne/64}updateFootprints(t,i){}populate(t,i,o,c){this.hasPattern=tW("line",this.layers,i);let s=this.layers[0].layout.get("line-sort-key"),b=this.layers[0].layout.get("line-z-offset");this.hasZOffset=!b.isConstant()||!!b.constantOr(0);let W=[];for(let{feature:Z,id:F,index:V,sourceLayerIndex:G}of t){let N=this.layers[0]._featureFilter.needGeometry,X=qt(Z,N);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),X,o))continue;let M=s?s.evaluate(X,{},o):void 0,S={id:F,properties:Z.properties,type:Z.type,sourceLayerIndex:G,index:V,geometry:N?X.geometry:_t(Z,o,c),patterns:{},sortKey:M};W.push(S)}s&&W.sort((Z,F)=>Z.sortKey-F.sortKey);let{lineAtlas:R,featureIndex:I}=i,h=this.addConstantDashes(R);for(let Z of W){let{geometry:F,index:V,sourceLayerIndex:G}=Z;if(h&&this.addFeatureDashes(Z,R),this.hasPattern){let N=eW("line",this.layers,Z,this.zoom,i);this.patternFeatures.push(N)}else this.addFeature(Z,F,V,o,R.positions,i.availableImages,i.brightness);I.insert(t[V].feature,F,V,G,this.index)}}addConstantDashes(t){let i=!1;for(let o of this.layers){let c=o.paint.get("line-dasharray").value,s=o.layout.get("line-cap").value;if(c.kind!=="constant"||s.kind!=="constant")i=!0;else{let b=s.value,W=c.value;if(!W)continue;t.addDash(W,b)}}return i}addFeatureDashes(t,i){let o=this.zoom;for(let c of this.layers){let s=c.paint.get("line-dasharray").value,b=c.layout.get("line-cap").value;if(s.kind==="constant"&&b.kind==="constant")continue;let W,R;if(s.kind==="constant"){if(W=s.value,!W)continue}else W=s.evaluate({zoom:o},t);R=b.kind==="constant"?b.value:b.evaluate({zoom:o},t),i.addDash(W,R),t.patterns[c.id]=i.getKey(W,R)}}update(t,i,o,c,s){let b=Object.keys(t).length!==0;b&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,i,b?this.stateDependentLayers:this.layers,o,c,s)}addFeatures(t,i,o,c,s,b){for(let W of this.patternFeatures)this.addFeature(W,W.geometry,W.index,i,o,c,b)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,DI)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=t.createVertexBuffer(this.patternVertexArray,PI)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=t.createVertexBuffer(this.zOffsetVertexArray,HI.members,!0)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,jI),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&t.properties.hasOwnProperty("mapbox_clip_start")&&t.properties.hasOwnProperty("mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,i,o,c,s,b,W){let R=this.layers[0].layout,I=R.get("line-join").evaluate(t,{}),h=R.get("line-cap").evaluate(t,{}),Z=R.get("line-miter-limit"),F=R.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(let V of i)this.addLine(V,t,c,I,h,Z,F);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,s,b,c,W)}addLine(t,i,o,c,s,b,W){this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.currentVertex=void 0;let R={zoom:this.zoom,lineProgress:void 0},I=this.layers[0].layout,h=c==="none";if(this.patternJoinNone=this.hasPattern&&h,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let L=0;L<t.length-1;L++)this.totalDistance+=t[L].dist(t[L+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}let Z=KI[i.type]==="Polygon",F=t.length;for(;F>=2&&t[F-1].equals(t[F-2]);)F--;let V=0;for(;V<F-1&&t[V].equals(t[V+1]);)V++;if(F<(Z?3:2))return;c==="bevel"&&(b=1.05);let G=this.overscaling<=16?15*ne/(512*this.overscaling):0,N=this.segments.prepareSegment(10*F,this.layoutVertexArray,this.indexArray),X,M,S,f,T,v;this.e1=this.e2=-1,Z&&(X=t[F-2],T=t[V].sub(X)._unit()._perp());for(let L=V;L<F;L++){if(S=L===F-1?Z?t[V+1]:void 0:t[L+1],S&&t[L].equals(S))continue;if(T&&(f=T),X&&(M=X),X=t[L],this.hasZOffset){let Rt=I.get("line-z-offset").value;if(Rt.kind==="constant")v=Rt.value;else{if(this.lineClips){let Ft=this.totalDistance/(this.lineClips.end-this.lineClips.start);R.lineProgress=(Ft*this.lineClips.start+this.distance+(M?M.dist(X):0))/Ft}else mi(`line-z-offset evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`),R.lineProgress=0;v=Rt.evaluate(R,i)}v=v||0}T=S?S.sub(X)._unit()._perp():f,f=f||T;let D=M&&S,q=D?c:Z||h?"butt":s,tt=f.x*T.x+f.y*T.y;if(h){let Rt=function(Ft){if(Ft.patternJoinNone){let yt=Ft.segmentPoints.length/2,xt=Ft.lineSoFar-Ft.segmentStart;for(let ft=0;ft<yt;++ft){let At=Ft.segmentPoints[2*ft+1],Ct=Math.round(Ft.segmentPoints[2*ft])+.5+.25*At;Ft.patternVertexArray.emplaceBack(Ct,xt,Ft.segmentStart),Ft.patternVertexArray.emplaceBack(Ct,xt,Ft.segmentStart)}Ft.segmentPoints.length=0}Ft.e1=Ft.e2=-1};if(D&&tt<$I){this.updateDistance(M,X),this.addCurrentVertex(X,f,1,1,N,v),Rt(this),this.addCurrentVertex(X,T,-1,-1,N,v);continue}if(M){if(!S){this.updateDistance(M,X),this.addCurrentVertex(X,f,1,1,N,v),Rt(this);continue}q="miter"}}let P=f.add(T);P.x===0&&P.y===0||P._unit();let st=P.x*T.x+P.y*T.y,it=st!==0?1/st:1/0,dt=2*Math.sqrt(2-2*st),Zt=st<qI&&M&&S,Vt=f.x*T.y-f.y*T.x>0;if(Zt&&L>V){let Rt=X.dist(M);if(Rt>2*G){let Ft=X.sub(X.sub(M)._mult(G/Rt)._round());this.updateDistance(M,Ft),this.addCurrentVertex(Ft,f,0,0,N,v),M=Ft}}if(D&&q==="round"&&(it<W?q="miter":it<=2&&(q="fakeround")),q==="miter"&&it>b&&(q="bevel"),q==="bevel"&&(it>2&&(q="flipbevel"),it<b&&(q="miter")),M&&this.updateDistance(M,X),q==="miter")P._mult(it),this.addCurrentVertex(X,P,0,0,N,v);else if(q==="flipbevel"){if(it>100)P=T.mult(-1);else{let Rt=it*f.add(T).mag()/f.sub(T).mag();P._perp()._mult(Rt*(Vt?-1:1))}this.addCurrentVertex(X,P,0,0,N,v),this.addCurrentVertex(X,P.mult(-1),0,0,N,v)}else if(q==="bevel"||q==="fakeround"){let Rt=-Math.sqrt(it*it-1),Ft=Vt?Rt:0,yt=Vt?0:Rt;if(M&&this.addCurrentVertex(X,f,Ft,yt,N,v),q==="fakeround"){let xt=Math.round(180*dt/Math.PI/20);for(let ft=1;ft<xt;ft++){let At=ft/xt;if(At!==.5){let se=At-.5;At+=At*se*(At-1)*((1.0904+tt*(tt*(3.55645-1.43519*tt)-3.2452))*se*se+(.848013+tt*(.215638*tt-1.06021)))}let Ct=T.sub(f)._mult(At)._add(f)._unit()._mult(Vt?-1:1);this.addHalfVertex(X,Ct.x,Ct.y,!1,Vt,0,N,v)}}S&&this.addCurrentVertex(X,T,-Ft,-yt,N,v)}else q==="butt"?this.addCurrentVertex(X,P,0,0,N,v):q==="square"?(M||this.addCurrentVertex(X,P,-1,-1,N,v),this.addCurrentVertex(X,P,0,0,N,v),M&&this.addCurrentVertex(X,P,1,1,N,v)):q==="round"&&(M&&(this.addCurrentVertex(X,f,0,0,N,v),this.addCurrentVertex(X,f,1,1,N,v,!0)),S&&(this.addCurrentVertex(X,T,-1,-1,N,v,!0),this.addCurrentVertex(X,T,0,0,N,v)));if(Zt&&L<F-1){let Rt=X.dist(S);if(Rt>2*G){let Ft=X.add(S.sub(X)._mult(G/Rt)._round());this.updateDistance(X,Ft),this.addCurrentVertex(Ft,T,0,0,N,v),X=Ft}}}}addVerticesTo(t,i,o,c,s,b,W,R,I,h){let Z=(i.w-t.w)/this.tessellationStep|0;if(Z>1){this.lineSoFar=t.w;let F=(i.x-t.x)/Z,V=(i.y-t.y)/Z,G=(i.z-t.z)/Z,N=(i.w-t.w)/Z;for(let X=1;X<Z;++X)t.x+=F,t.y+=V,t.z+=G,this.lineSoFar+=N,this.addHalfVertex(t,o,c,h,!1,W,I,t.z),this.addHalfVertex(t,s,b,h,!0,-R,I,t.z)}this.lineSoFar=i.w,this.addHalfVertex(i,o,c,h,!1,W,I,i.z),this.addHalfVertex(i,s,b,h,!0,-R,I,i.z)}addCurrentVertex(t,i,o,c,s,b,W=!1){let R=i.x+i.y*o,I=i.y-i.x*o,h=i.y*c-i.x,Z=-i.y-i.x*c;if(b!=null){let V=ne+10,G=b,N=new zu(t.x,t.y,G,this.lineSoFar),X=ZZ(t,-10,V),M=this.lineSoFar;if(this.currentVertex)if(X){let S=this.currentVertexIsOutside,f=this.currentVertex,T=new zu(t.x,t.y,G,this.lineSoFar);Au(f,T,-10,V),ZZ(T,-10,V)||(S&&(this.e1=this.e2=-1,this.lineSoFar=f.w,this.addHalfVertex(f,R,I,W,!1,o,s,f.z),this.addHalfVertex(f,h,Z,W,!0,-c,s,f.z)),this.addVerticesTo(f,T,R,I,h,Z,o,c,s,W))}else{let S=this.currentVertex;this.currentVertexIsOutside&&(Au(S,N,-10,V),this.e1=this.e2=-1,this.lineSoFar=S.w,this.addHalfVertex(S,R,I,W,!1,o,s,S.z),this.addHalfVertex(S,h,Z,W,!0,-c,s,S.z)),this.addVerticesTo(S,N,R,I,h,Z,o,c,s,W)}else X||(this.addHalfVertex(t,R,I,W,!1,o,s,b),this.addHalfVertex(t,h,Z,W,!0,-c,s,b));this.currentVertex=N,this.currentVertexIsOutside=X,this.lineSoFar=M}else this.addHalfVertex(t,R,I,W,!1,o,s,b),this.addHalfVertex(t,h,Z,W,!0,-c,s,b)}addHalfVertex({x:t,y:i},o,c,s,b,W,R,I){this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),b||this.segmentPoints.push(this.lineSoFar-this.segmentStart,W)),this.layoutVertexArray.emplaceBack((t<<1)+(s?1:0),(i<<1)+(b?1:0),Math.round(63*o)+128,Math.round(63*c)+128,1+(W===0?0:W<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);let h=R.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,h),R.primitiveLength++),b?this.e2=h:this.e1=h,I!=null&&this.zOffsetVertexArray.emplaceBack(I)}updateScaledDistance(){if(this.lineClips){let t=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=t*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(t,i){this.distance+=t.dist(i),this.updateScaledDistance()}}function ZZ(n,t,i){return n.x<t||n.x>i||n.y<t||n.y>i}let gZ,VZ;function RZ(n,t,i){return t*(ne/(n.tileSize*Math.pow(2,i-n.tileID.overscaledZ)))}function GZ(n,t){return 1/RZ(n,1,t.tileZoom)}function FZ(n,t,i,o){return n.translatePosMatrix(o||t.tileID.projMatrix,t,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}he(mW,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});let IZ=n=>{let t=[];UZ(n)&&t.push("RENDER_LINE_DASH"),n.paint.get("line-gradient")&&t.push("RENDER_LINE_GRADIENT");let i=n.paint.get("line-trim-offset");i[0]===0&&i[1]===0||t.push("RENDER_LINE_TRIM_OFFSET"),n.paint.get("line-border-width").constantOr(1)!==0&&t.push("RENDER_LINE_BORDER");let o=n.layout.get("line-join").constantOr("miter")==="none",c=!!n.paint.get("line-pattern").constantOr(1);return o&&c&&t.push("LINE_JOIN_NONE"),t};function UZ(n){let t=n.paint.get("line-dasharray").value;return t.value||t.kind!=="constant"}let hW,xZ=()=>hW||(hW={layout:gZ||(gZ=new Ei({"line-cap":new Ie(Xt.layout_line["line-cap"]),"line-join":new Ie(Xt.layout_line["line-join"]),"line-miter-limit":new te(Xt.layout_line["line-miter-limit"]),"line-round-limit":new te(Xt.layout_line["line-round-limit"]),"line-sort-key":new Ie(Xt.layout_line["line-sort-key"]),"line-z-offset":new Ie(Xt.layout_line["line-z-offset"]),visibility:new te(Xt.layout_line.visibility)})),paint:VZ||(VZ=new Ei({"line-opacity":new Ie(Xt.paint_line["line-opacity"]),"line-color":new Ie(Xt.paint_line["line-color"]),"line-translate":new te(Xt.paint_line["line-translate"]),"line-translate-anchor":new te(Xt.paint_line["line-translate-anchor"]),"line-width":new Ie(Xt.paint_line["line-width"]),"line-gap-width":new Ie(Xt.paint_line["line-gap-width"]),"line-offset":new Ie(Xt.paint_line["line-offset"]),"line-blur":new Ie(Xt.paint_line["line-blur"]),"line-dasharray":new Ie(Xt.paint_line["line-dasharray"]),"line-pattern":new Ie(Xt.paint_line["line-pattern"]),"line-gradient":new _n(Xt.paint_line["line-gradient"]),"line-trim-offset":new te(Xt.paint_line["line-trim-offset"]),"line-trim-fade-range":new te(Xt.paint_line["line-trim-fade-range"]),"line-trim-color":new te(Xt.paint_line["line-trim-color"]),"line-emissive-strength":new te(Xt.paint_line["line-emissive-strength"]),"line-border-width":new Ie(Xt.paint_line["line-border-width"]),"line-border-color":new Ie(Xt.paint_line["line-border-color"]),"line-occlusion-opacity":new te(Xt.paint_line["line-occlusion-opacity"])}))},hW);class tU extends Ie{possiblyEvaluate(t,i){return i=new ji(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition}),super.possiblyEvaluate(t,i)}evaluate(t,i,o,c){return i=Fa({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(t,i,o,c)}}let Kb;function NZ(n,t){return t>0?t+2*n:n}let eU=pi([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),iU=pi([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),aU=pi([{name:"a_projected_pos",components:4,type:"Float32"}],4);pi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let nU=pi([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),lU=pi([{name:"a_texb",components:2,type:"Uint16"}]),oU=pi([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),sU=pi([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);pi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let YZ=pi([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),rU=pi([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);pi([{name:"triangle",components:3,type:"Uint16"}]),pi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),pi([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),pi([{type:"Float32",name:"offsetX"}]),pi([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Ma=24;let Sl=128;function pW(n,t){let{expression:i}=t;if(i.kind==="constant")return{kind:"constant",layoutSize:i.evaluate(new ji(n+1))};if(i.kind==="source")return{kind:"source"};{let{zoomStops:o,interpolationType:c}=i,s=0;for(;s<o.length&&o[s]<=n;)s++;s=Math.max(0,s-1);let b=s;for(;b<o.length&&o[b]<n+1;)b++;b=Math.min(o.length-1,b);let W=o[s],R=o[b];return i.kind==="composite"?{kind:"composite",minZoom:W,maxZoom:R,interpolationType:c}:{kind:"camera",minZoom:W,maxZoom:R,minSize:i.evaluate(new ji(W)),maxSize:i.evaluate(new ji(R)),interpolationType:c}}}function i0(n,{uSize:t,uSizeT:i},{lowerSize:o,upperSize:c}){return n.kind==="source"?o/Sl:n.kind==="composite"?Je(o/Sl,c/Sl,i):t}function ic(n,t){let i=0,o=0;if(n.kind==="constant")o=n.layoutSize;else if(n.kind!=="source"){let{interpolationType:c,minZoom:s,maxZoom:b}=n,W=c?ze(Rn.interpolationFactor(c,t,s,b),0,1):0;n.kind==="camera"?o=Je(n.minSize,n.maxSize,W):i=W}return{uSizeT:i,uSize:o}}var dU=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Sl,evaluateSizeForFeature:i0,evaluateSizeForZoom:ic,getSizeData:pW});function cU(n,t,i){return n.sections.forEach(o=>{o.text=function(c,s,b){let W=s.layout.get("text-transform").evaluate(b,{});return W==="uppercase"?c=c.toLocaleUpperCase():W==="lowercase"&&(c=c.toLocaleLowerCase()),sn.applyArabicShaping&&(c=sn.applyArabicShaping(c)),c}(o.text,t,i)}),n}let qb={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42","\u2190":"\u2191","\u2192":"\u2193"};function bU(n){return n==="\uFE36"||n==="\uFE48"||n==="\uFE38"||n==="\uFE44"||n==="\uFE42"||n==="\uFE3E"||n==="\uFE3C"||n==="\uFE3A"||n==="\uFE18"||n==="\uFE40"||n==="\uFE10"||n==="\uFE13"||n==="\uFE14"||n==="\uFF40"||n==="\uFFE3"||n==="\uFE11"||n==="\uFE12"}function mU(n){return n==="\uFE35"||n==="\uFE47"||n==="\uFE37"||n==="\uFE43"||n==="\uFE41"||n==="\uFE3D"||n==="\uFE3B"||n==="\uFE39"||n==="\uFE17"||n==="\uFE3F"}var JZ,WW,XZ,uW={};function hU(){return JZ||(JZ=1,uW.read=function(n,t,i,o,c){var s,b,W=8*c-o-1,R=(1<<W)-1,I=R>>1,h=-7,Z=i?c-1:0,F=i?-1:1,V=n[t+Z];for(Z+=F,s=V&(1<<-h)-1,V>>=-h,h+=W;h>0;s=256*s+n[t+Z],Z+=F,h-=8);for(b=s&(1<<-h)-1,s>>=-h,h+=o;h>0;b=256*b+n[t+Z],Z+=F,h-=8);if(s===0)s=1-I;else{if(s===R)return b?NaN:1/0*(V?-1:1);b+=Math.pow(2,o),s-=I}return(V?-1:1)*b*Math.pow(2,s-o)},uW.write=function(n,t,i,o,c,s){var b,W,R,I=8*s-c-1,h=(1<<I)-1,Z=h>>1,F=c===23?Math.pow(2,-24)-Math.pow(2,-77):0,V=o?0:s-1,G=o?1:-1,N=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(W=isNaN(t)?1:0,b=h):(b=Math.floor(Math.log(t)/Math.LN2),t*(R=Math.pow(2,-b))<1&&(b--,R*=2),(t+=b+Z>=1?F/R:F*Math.pow(2,1-Z))*R>=2&&(b++,R/=2),b+Z>=h?(W=0,b=h):b+Z>=1?(W=(t*R-1)*Math.pow(2,c),b+=Z):(W=t*Math.pow(2,Z-1)*Math.pow(2,c),b=0));c>=8;n[i+V]=255&W,V+=G,W/=256,c-=8);for(b=b<<c|W,I+=c;I>0;n[i+V]=255&b,V+=G,b/=256,I-=8);n[i+V-G]|=128*N}),uW}function yZ(){if(XZ)return WW;XZ=1,WW=t;var n=hU();function t(T){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(T)?T:new Uint8Array(T||0),this.pos=0,this.type=0,this.length=this.buf.length}t.Varint=0,t.Fixed64=1,t.Bytes=2,t.Fixed32=5;var i=4294967296,o=1/i,c=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function s(T){return T.type===t.Bytes?T.readVarint()+T.pos:T.pos+1}function b(T,v,L){return L?4294967296*v+(T>>>0):4294967296*(v>>>0)+(T>>>0)}function W(T,v,L){var D=v<=16383?1:v<=2097151?2:v<=268435455?3:Math.floor(Math.log(v)/(7*Math.LN2));L.realloc(D);for(var q=L.pos-1;q>=T;q--)L.buf[q+D]=L.buf[q]}function R(T,v){for(var L=0;L<T.length;L++)v.writeVarint(T[L])}function I(T,v){for(var L=0;L<T.length;L++)v.writeSVarint(T[L])}function h(T,v){for(var L=0;L<T.length;L++)v.writeFloat(T[L])}function Z(T,v){for(var L=0;L<T.length;L++)v.writeDouble(T[L])}function F(T,v){for(var L=0;L<T.length;L++)v.writeBoolean(T[L])}function V(T,v){for(var L=0;L<T.length;L++)v.writeFixed32(T[L])}function G(T,v){for(var L=0;L<T.length;L++)v.writeSFixed32(T[L])}function N(T,v){for(var L=0;L<T.length;L++)v.writeFixed64(T[L])}function X(T,v){for(var L=0;L<T.length;L++)v.writeSFixed64(T[L])}function M(T,v){return(T[v]|T[v+1]<<8|T[v+2]<<16)+16777216*T[v+3]}function S(T,v,L){T[L]=v,T[L+1]=v>>>8,T[L+2]=v>>>16,T[L+3]=v>>>24}function f(T,v){return(T[v]|T[v+1]<<8|T[v+2]<<16)+(T[v+3]<<24)}return t.prototype={destroy:function(){this.buf=null},readFields:function(T,v,L){for(L=L||this.length;this.pos<L;){var D=this.readVarint(),q=D>>3,tt=this.pos;this.type=7&D,T(q,v,this),this.pos===tt&&this.skip(D)}return v},readMessage:function(T,v){return this.readFields(T,v,this.readVarint()+this.pos)},readFixed32:function(){var T=M(this.buf,this.pos);return this.pos+=4,T},readSFixed32:function(){var T=f(this.buf,this.pos);return this.pos+=4,T},readFixed64:function(){var T=M(this.buf,this.pos)+M(this.buf,this.pos+4)*i;return this.pos+=8,T},readSFixed64:function(){var T=M(this.buf,this.pos)+f(this.buf,this.pos+4)*i;return this.pos+=8,T},readFloat:function(){var T=n.read(this.buf,this.pos,!0,23,4);return this.pos+=4,T},readDouble:function(){var T=n.read(this.buf,this.pos,!0,52,8);return this.pos+=8,T},readVarint:function(T){var v,L,D=this.buf;return v=127&(L=D[this.pos++]),L<128?v:(v|=(127&(L=D[this.pos++]))<<7,L<128?v:(v|=(127&(L=D[this.pos++]))<<14,L<128?v:(v|=(127&(L=D[this.pos++]))<<21,L<128?v:function(q,tt,P){var st,it,dt=P.buf;if(st=(112&(it=dt[P.pos++]))>>4,it<128||(st|=(127&(it=dt[P.pos++]))<<3,it<128)||(st|=(127&(it=dt[P.pos++]))<<10,it<128)||(st|=(127&(it=dt[P.pos++]))<<17,it<128)||(st|=(127&(it=dt[P.pos++]))<<24,it<128)||(st|=(1&(it=dt[P.pos++]))<<31,it<128))return b(q,st,tt);throw new Error("Expected varint not more than 10 bytes")}(v|=(15&(L=D[this.pos]))<<28,T,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var T=this.readVarint();return T%2==1?(T+1)/-2:T/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var T=this.readVarint()+this.pos,v=this.pos;return this.pos=T,T-v>=12&&c?function(L,D,q){return c.decode(L.subarray(D,q))}(this.buf,v,T):function(L,D,q){for(var tt="",P=D;P<q;){var st,it,dt,Zt=L[P],Vt=null,Rt=Zt>239?4:Zt>223?3:Zt>191?2:1;if(P+Rt>q)break;Rt===1?Zt<128&&(Vt=Zt):Rt===2?(192&(st=L[P+1]))==128&&(Vt=(31&Zt)<<6|63&st)<=127&&(Vt=null):Rt===3?(it=L[P+2],(192&(st=L[P+1]))==128&&(192&it)==128&&((Vt=(15&Zt)<<12|(63&st)<<6|63&it)<=2047||Vt>=55296&&Vt<=57343)&&(Vt=null)):Rt===4&&(it=L[P+2],dt=L[P+3],(192&(st=L[P+1]))==128&&(192&it)==128&&(192&dt)==128&&((Vt=(15&Zt)<<18|(63&st)<<12|(63&it)<<6|63&dt)<=65535||Vt>=1114112)&&(Vt=null)),Vt===null?(Vt=65533,Rt=1):Vt>65535&&(Vt-=65536,tt+=String.fromCharCode(Vt>>>10&1023|55296),Vt=56320|1023&Vt),tt+=String.fromCharCode(Vt),P+=Rt}return tt}(this.buf,v,T)},readBytes:function(){var T=this.readVarint()+this.pos,v=this.buf.subarray(this.pos,T);return this.pos=T,v},readPackedVarint:function(T,v){if(this.type!==t.Bytes)return T.push(this.readVarint(v));var L=s(this);for(T=T||[];this.pos<L;)T.push(this.readVarint(v));return T},readPackedSVarint:function(T){if(this.type!==t.Bytes)return T.push(this.readSVarint());var v=s(this);for(T=T||[];this.pos<v;)T.push(this.readSVarint());return T},readPackedBoolean:function(T){if(this.type!==t.Bytes)return T.push(this.readBoolean());var v=s(this);for(T=T||[];this.pos<v;)T.push(this.readBoolean());return T},readPackedFloat:function(T){if(this.type!==t.Bytes)return T.push(this.readFloat());var v=s(this);for(T=T||[];this.pos<v;)T.push(this.readFloat());return T},readPackedDouble:function(T){if(this.type!==t.Bytes)return T.push(this.readDouble());var v=s(this);for(T=T||[];this.pos<v;)T.push(this.readDouble());return T},readPackedFixed32:function(T){if(this.type!==t.Bytes)return T.push(this.readFixed32());var v=s(this);for(T=T||[];this.pos<v;)T.push(this.readFixed32());return T},readPackedSFixed32:function(T){if(this.type!==t.Bytes)return T.push(this.readSFixed32());var v=s(this);for(T=T||[];this.pos<v;)T.push(this.readSFixed32());return T},readPackedFixed64:function(T){if(this.type!==t.Bytes)return T.push(this.readFixed64());var v=s(this);for(T=T||[];this.pos<v;)T.push(this.readFixed64());return T},readPackedSFixed64:function(T){if(this.type!==t.Bytes)return T.push(this.readSFixed64());var v=s(this);for(T=T||[];this.pos<v;)T.push(this.readSFixed64());return T},skip:function(T){var v=7&T;if(v===t.Varint)for(;this.buf[this.pos++]>127;);else if(v===t.Bytes)this.pos=this.readVarint()+this.pos;else if(v===t.Fixed32)this.pos+=4;else{if(v!==t.Fixed64)throw new Error("Unimplemented type: "+v);this.pos+=8}},writeTag:function(T,v){this.writeVarint(T<<3|v)},realloc:function(T){for(var v=this.length||16;v<this.pos+T;)v*=2;if(v!==this.length){var L=new Uint8Array(v);L.set(this.buf),this.buf=L,this.length=v}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(T){this.realloc(4),S(this.buf,T,this.pos),this.pos+=4},writeSFixed32:function(T){this.realloc(4),S(this.buf,T,this.pos),this.pos+=4},writeFixed64:function(T){this.realloc(8),S(this.buf,-1&T,this.pos),S(this.buf,Math.floor(T*o),this.pos+4),this.pos+=8},writeSFixed64:function(T){this.realloc(8),S(this.buf,-1&T,this.pos),S(this.buf,Math.floor(T*o),this.pos+4),this.pos+=8},writeVarint:function(T){(T=+T||0)>268435455||T<0?function(v,L){var D,q;if(v>=0?(D=v%4294967296|0,q=v/4294967296|0):(q=~(-v/4294967296),4294967295^(D=~(-v%4294967296))?D=D+1|0:(D=0,q=q+1|0)),v>=18446744073709552e3||v<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");L.realloc(10),function(tt,P,st){st.buf[st.pos++]=127&tt|128,tt>>>=7,st.buf[st.pos++]=127&tt|128,tt>>>=7,st.buf[st.pos++]=127&tt|128,tt>>>=7,st.buf[st.pos++]=127&tt|128,st.buf[st.pos]=127&(tt>>>=7)}(D,0,L),function(tt,P){var st=(7&tt)<<4;P.buf[P.pos++]|=st|((tt>>>=3)?128:0),tt&&(P.buf[P.pos++]=127&tt|((tt>>>=7)?128:0),tt&&(P.buf[P.pos++]=127&tt|((tt>>>=7)?128:0),tt&&(P.buf[P.pos++]=127&tt|((tt>>>=7)?128:0),tt&&(P.buf[P.pos++]=127&tt|((tt>>>=7)?128:0),tt&&(P.buf[P.pos++]=127&tt)))))}(q,L)}(T,this):(this.realloc(4),this.buf[this.pos++]=127&T|(T>127?128:0),T<=127||(this.buf[this.pos++]=127&(T>>>=7)|(T>127?128:0),T<=127||(this.buf[this.pos++]=127&(T>>>=7)|(T>127?128:0),T<=127||(this.buf[this.pos++]=T>>>7&127))))},writeSVarint:function(T){this.writeVarint(T<0?2*-T-1:2*T)},writeBoolean:function(T){this.writeVarint(!!T)},writeString:function(T){T=String(T),this.realloc(4*T.length),this.pos++;var v=this.pos;this.pos=function(D,q,tt){for(var P,st,it=0;it<q.length;it++){if((P=q.charCodeAt(it))>55295&&P<57344){if(!st){P>56319||it+1===q.length?(D[tt++]=239,D[tt++]=191,D[tt++]=189):st=P;continue}if(P<56320){D[tt++]=239,D[tt++]=191,D[tt++]=189,st=P;continue}P=st-55296<<10|P-56320|65536,st=null}else st&&(D[tt++]=239,D[tt++]=191,D[tt++]=189,st=null);P<128?D[tt++]=P:(P<2048?D[tt++]=P>>6|192:(P<65536?D[tt++]=P>>12|224:(D[tt++]=P>>18|240,D[tt++]=P>>12&63|128),D[tt++]=P>>6&63|128),D[tt++]=63&P|128)}return tt}(this.buf,T,this.pos);var L=this.pos-v;L>=128&&W(v,L,this),this.pos=v-1,this.writeVarint(L),this.pos+=L},writeFloat:function(T){this.realloc(4),n.write(this.buf,T,this.pos,!0,23,4),this.pos+=4},writeDouble:function(T){this.realloc(8),n.write(this.buf,T,this.pos,!0,52,8),this.pos+=8},writeBytes:function(T){var v=T.length;this.writeVarint(v),this.realloc(v);for(var L=0;L<v;L++)this.buf[this.pos++]=T[L]},writeRawMessage:function(T,v){this.pos++;var L=this.pos;T(v,this);var D=this.pos-L;D>=128&&W(L,D,this),this.pos=L-1,this.writeVarint(D),this.pos+=D},writeMessage:function(T,v,L){this.writeTag(T,t.Bytes),this.writeRawMessage(v,L)},writePackedVarint:function(T,v){v.length&&this.writeMessage(T,R,v)},writePackedSVarint:function(T,v){v.length&&this.writeMessage(T,I,v)},writePackedBoolean:function(T,v){v.length&&this.writeMessage(T,F,v)},writePackedFloat:function(T,v){v.length&&this.writeMessage(T,h,v)},writePackedDouble:function(T,v){v.length&&this.writeMessage(T,Z,v)},writePackedFixed32:function(T,v){v.length&&this.writeMessage(T,V,v)},writePackedSFixed32:function(T,v){v.length&&this.writeMessage(T,G,v)},writePackedFixed64:function(T,v){v.length&&this.writeMessage(T,N,v)},writePackedSFixed64:function(T,v){v.length&&this.writeMessage(T,X,v)},writeBytesField:function(T,v){this.writeTag(T,t.Bytes),this.writeBytes(v)},writeFixed32Field:function(T,v){this.writeTag(T,t.Fixed32),this.writeFixed32(v)},writeSFixed32Field:function(T,v){this.writeTag(T,t.Fixed32),this.writeSFixed32(v)},writeFixed64Field:function(T,v){this.writeTag(T,t.Fixed64),this.writeFixed64(v)},writeSFixed64Field:function(T,v){this.writeTag(T,t.Fixed64),this.writeSFixed64(v)},writeVarintField:function(T,v){this.writeTag(T,t.Varint),this.writeVarint(v)},writeSVarintField:function(T,v){this.writeTag(T,t.Varint),this.writeSVarint(v)},writeStringField:function(T,v){this.writeTag(T,t.Bytes),this.writeString(v)},writeFloatField:function(T,v){this.writeTag(T,t.Fixed32),this.writeFloat(v)},writeDoubleField:function(T,v){this.writeTag(T,t.Fixed64),this.writeDouble(v)},writeBooleanField:function(T,v){this.writeVarintField(T,!!v)}},WW}var a0=lt(yZ());let ZW=3;function pU(n,t,i){t.glyphs=[],n===1&&i.readMessage(WU,t)}function WU(n,t,i){if(n===3){let{id:o,bitmap:c,width:s,height:b,left:W,top:R,advance:I}=i.readMessage(uU,{});t.glyphs.push({id:o,bitmap:new Is({width:s+2*ZW,height:b+2*ZW},c),metrics:{width:s,height:b,left:W,top:R,advance:I}})}else n===4?t.ascender=i.readSVarint():n===5&&(t.descender=i.readSVarint())}function uU(n,t,i){n===1?t.id=i.readVarint():n===2?t.bitmap=i.readBytes():n===3?t.width=i.readVarint():n===4?t.height=i.readVarint():n===5?t.left=i.readSVarint():n===6?t.top=i.readSVarint():n===7&&(t.advance=i.readVarint())}let BZ=ZW,qn={horizontal:1,vertical:2,horizontalOnly:3};class $b{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,i){let o=new $b;return o.scale=t||1,o.fontStack=i,o}static forImage(t){let i=new $b;return i.imageName=t,i}}class ac{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,i){let o=new ac;for(let c=0;c<t.sections.length;c++){let s=t.sections[c];s.image?o.addImageSection(s):o.addTextSection(s,i)}return o}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCodePoint(t){return this.text.codePointAt(t)}verticalizePunctuation(t){this.text=function(i,o){let c="";for(let s=0;s<i.length;s++){let b=i.charCodeAt(s+1)||null,W=i.charCodeAt(s-1)||null;c+=!o&&(b&&hr(b)&&!qb[i[s+1]]||W&&hr(W)&&!qb[i[s-1]])||!qb[i[s]]?i[s]:qb[i[s]]}return c}(this.text,t)}trim(){let t=0;for(let o=0;o<this.text.length&&n0[this.text.charCodeAt(o)];o++)t++;let i=this.text.length;for(let o=this.text.length-1;o>=0&&o>=t&&n0[this.text.charCodeAt(o)];o--)i--;this.text=this.text.substring(t,i),this.sectionIndex=this.sectionIndex.slice(t,i)}substring(t,i){let o=new ac;return o.text=this.text.substring(t,i),o.sectionIndex=this.sectionIndex.slice(t,i),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,i)=>Math.max(t,this.sections[i].scale),0)}addTextSection(t,i){this.text+=t.text,this.sections.push($b.forText(t.scale,t.fontStack||i));let o=this.sections.length-1;for(let c=0;c<t.text.length;++c)this.sectionIndex.push(o)}addImageSection(t){let i=t.image?t.image.namePrimary:"";if(i.length===0)return void mi("Can't add FormattedSection with an empty image.");let o=this.getNextImageSectionCharCode();o?(this.text+=String.fromCodePoint(o),this.sections.push($b.forImage(i)),this.sectionIndex.push(this.sections.length-1)):mi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function gW(n,t,i,o,c,s,b,W,R,I,h,Z,F,V,G){let N=ac.fromFeature(n,c);Z===qn.vertical&&N.verticalizePunctuation(F);let X=[],M=function(L,D,q,tt,P,st){if(!L)return[];let it=[],dt=function(Ft,yt,xt,ft,At,Ct){let se=0;for(let ae=0;ae<Ft.length();ae++){let Pt=Ft.getSection(ae);se+=MZ(Ft.getCodePoint(ae),Pt,ft,At,yt,Ct)}return se/Math.max(1,Math.ceil(se/xt))}(L,D,q,tt,P,st),Zt=L.text.indexOf("\u200B")>=0,Vt=0;for(let Ft=0;Ft<L.length();Ft++){let yt=L.getSection(Ft),xt=L.getCodePoint(Ft);if(n0[xt]||(Vt+=MZ(xt,yt,tt,P,D,st)),Ft<L.length()-1){let ft=!((Rt=xt)<11904||!(Ge["Bopomofo Extended"](Rt)||Ge.Bopomofo(Rt)||Ge["CJK Compatibility Forms"](Rt)||Ge["CJK Compatibility Ideographs"](Rt)||Ge["CJK Compatibility"](Rt)||Ge["CJK Radicals Supplement"](Rt)||Ge["CJK Strokes"](Rt)||Ge["CJK Symbols and Punctuation"](Rt)||Ge["CJK Unified Ideographs Extension A"](Rt)||Ge["CJK Unified Ideographs"](Rt)||Ge["Enclosed CJK Letters and Months"](Rt)||Ge["Halfwidth and Fullwidth Forms"](Rt)||Ge.Hiragana(Rt)||Ge["Ideographic Description Characters"](Rt)||Ge["Kangxi Radicals"](Rt)||Ge["Katakana Phonetic Extensions"](Rt)||Ge.Katakana(Rt)||Ge["Vertical Forms"](Rt)||Ge["Yi Radicals"](Rt)||Ge["Yi Syllables"](Rt)));(ZU[xt]||ft||yt.imageName)&&it.push(CZ(Ft+1,Vt,dt,it,gU(xt,L.getCodePoint(Ft+1),ft&&Zt),!1))}}var Rt;return kZ(CZ(L.length(),Vt,dt,it,0,!0))}(N,I,s,t,o,V),{processBidirectionalText:S,processStyledBidirectionalText:f}=sn;if(S&&N.sections.length===1){let L=S(N.toString(),M);for(let D of L){let q=new ac;q.text=D,q.sections=N.sections;for(let tt=0;tt<D.length;tt++)q.sectionIndex.push(0);X.push(q)}}else if(f){let L=f(N.text,N.sectionIndex,M);for(let D of L){let q=new ac;q.text=D[0],q.sectionIndex=D[1],q.sections=N.sections,X.push(q)}}else X=function(L,D){let q=[],tt=L.text,P=0;for(let st of D)q.push(L.substring(P,st)),P=st;return P<tt.length&&q.push(L.substring(P,tt.length)),q}(N,M);let T=[],v={positionedLines:T,text:N.toString(),top:h[1],bottom:h[1],left:h[0],right:h[0],writingMode:Z,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(L,D,q,tt,P,st,it,dt,Zt,Vt,Rt,Ft){let yt=0,xt=0,ft=0,At=dt==="right"?1:dt==="left"?0:.5,Ct=!1;for(let oe of P){let me=oe.getSections();for(let Ce of me){if(Ce.imageName)continue;let Ke=D[Ce.fontStack];if(Ke&&(Ct=Ke.ascender!==void 0&&Ke.descender!==void 0,!Ct))break}if(!Ct)break}let se=0;for(let oe of P){oe.trim();let me=oe.getMaxScale(),Ce=(me-1)*Ma,Ke={positionedGlyphs:[],lineOffset:0};L.positionedLines[se]=Ke;let Ae=Ke.positionedGlyphs,He=0;if(!oe.length()){xt+=st,++se;continue}let $e=0,ei=0;for(let Fi=0;Fi<oe.length();Fi++){let Se=oe.getSection(Fi),ui=oe.getSectionIndex(Fi),gi=oe.getCodePoint(Fi),Qi=Se.scale,qi=null,oa=null,$i=null,Hi=Ma,Ua=0,da=!(Zt===qn.horizontal||!Rt&&!Sd(gi)||Rt&&(n0[gi]||(ae=gi,Ge.Arabic(ae)||Ge["Arabic Supplement"](ae)||Ge["Arabic Extended-A"](ae)||Ge["Arabic Presentation Forms-A"](ae)||Ge["Arabic Presentation Forms-B"](ae))));if(Se.imageName){let Ta=tt[Se.imageName];if(!Ta)continue;$i=Se.imageName,L.iconsInText=L.iconsInText||!0,oa=Ta.paddedRect;let ki=Ta.displaySize;Qi=Qi*Ma/Ft,qi={width:ki[0],height:ki[1],left:0,top:-BZ,advance:da?ki[1]:ki[0],localGlyph:!1},Ua=Ct?-qi.height*Qi:me*Ma-17-ki[1]*Qi,Hi=qi.advance;let In=(da?ki[0]:ki[1])*Qi-Ma*me;In>0&&In>He&&(He=In)}else{let Ta=q[Se.fontStack];if(!Ta)continue;Ta[gi]&&(oa=Ta[gi]);let ki=D[Se.fontStack];if(!ki)continue;let In=ki.glyphs[gi];if(!In)continue;if(qi=In.metrics,Hi=gi!==8203?Ma:0,Ct){let Ll=ki.ascender!==void 0?Math.abs(ki.ascender):0,Wl=ki.descender!==void 0?Math.abs(ki.descender):0,ul=(Ll+Wl)*Qi;$e<ul&&($e=ul,ei=(Ll-Wl)/2*Qi),Ua=-Ll*Qi}else Ua=(me-Qi)*Ma-17}da?(L.verticalizable=!0,Ae.push({glyph:gi,imageName:$i,x:yt,y:xt+Ua,vertical:da,scale:Qi,localGlyph:qi.localGlyph,fontStack:Se.fontStack,sectionIndex:ui,metrics:qi,rect:oa}),yt+=Hi*Qi+Vt):(Ae.push({glyph:gi,imageName:$i,x:yt,y:xt+Ua,vertical:da,scale:Qi,localGlyph:qi.localGlyph,fontStack:Se.fontStack,sectionIndex:ui,metrics:qi,rect:oa}),yt+=qi.advance*Qi+Vt)}Ae.length!==0&&(ft=Math.max(yt-Vt,ft),Ct?SZ(Ae,At,He,ei,st*me/2):SZ(Ae,At,He,0,st/2)),yt=0;let yi=st*me+He;Ke.lineOffset=Math.max(He,Ce),xt+=yi,++se}var ae;let Pt=xt,{horizontalAlign:jt,verticalAlign:xe}=VW(it);(function(oe,me,Ce,Ke,Ae,He){let $e=(me-Ce)*Ae,ei=-He*Ke;for(let yi of oe)for(let Fi of yi.positionedGlyphs)Fi.x+=$e,Fi.y+=ei})(L.positionedLines,At,jt,xe,ft,Pt),L.top+=-xe*Pt,L.bottom=L.top+Pt,L.left+=-jt*ft,L.right=L.left+ft,L.hasBaseline=Ct}(v,t,i,o,X,b,W,R,Z,I,F,G),!function(L){for(let D of L)if(D.positionedGlyphs.length!==0)return!1;return!0}(T)&&v}let n0={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},ZU={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function MZ(n,t,i,o,c,s){if(t.imageName){let b=o[t.imageName];return b?b.displaySize[0]*t.scale*Ma/s+c:0}{let b=i[t.fontStack],W=b&&b.glyphs[n];return W?W.metrics.advance*t.scale+c:0}}function TZ(n,t,i,o){let c=Math.pow(n-t,2);return o?n<t?c/2:2*c:c+Math.abs(i)*i}function gU(n,t,i){let o=0;return n===10&&(o-=1e4),i&&(o+=150),n!==40&&n!==65288||(o+=50),t!==41&&t!==65289||(o+=50),o}function CZ(n,t,i,o,c,s){let b=null,W=TZ(t,i,c,s);for(let R of o){let I=TZ(t-R.x,i,c,s)+R.badness;I<=W&&(b=R,W=I)}return{index:n,x:t,priorBreak:b,badness:W}}function kZ(n){return n?kZ(n.priorBreak).concat(n.index):[]}function VW(n){let t=.5,i=.5;switch(n){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(n){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:t,verticalAlign:i}}function SZ(n,t,i,o,c){if(!(t||i||o||c))return;let s=n.length-1,b=n[s],W=(b.x+b.metrics.advance*b.scale)*t;for(let R=0;R<=s;R++)n[R].x-=W,n[R].y+=i+o+c}function VU(n,t,i,o){let{horizontalAlign:c,verticalAlign:s}=VW(o),b=i[0]-n.displaySize[0]*c,W=i[1]-n.displaySize[1]*s;return{imagePrimary:n,imageSecondary:t,top:W,bottom:W+n.displaySize[1],left:b,right:b+n.displaySize[0]}}function QZ(n,t,i,o,c,s){let b=n.imagePrimary,W;if(b.content){let X=b.content,M=b.pixelRatio||1;W=[X[0]/M,X[1]/M,b.displaySize[0]-X[2]/M,b.displaySize[1]-X[3]/M]}let R=t.left*s,I=t.right*s,h,Z,F,V;i==="width"||i==="both"?(V=c[0]+R-o[3],Z=c[0]+I+o[1]):(V=c[0]+(R+I-b.displaySize[0])/2,Z=V+b.displaySize[0]);let G=t.top*s,N=t.bottom*s;return i==="height"||i==="both"?(h=c[1]+G-o[0],F=c[1]+N+o[2]):(h=c[1]+(G+N-b.displaySize[1])/2,F=h+b.displaySize[1]),{imagePrimary:b,imageSecondary:void 0,top:h,right:Z,bottom:F,left:V,collisionPadding:W}}class Jo extends ee{constructor(t,i,o,c,s){super(t,i),this.angle=c,this.z=o,s!==void 0&&(this.segment=s)}clone(){return new Jo(this.x,this.y,this.z,this.angle,this.segment)}}function fZ(n,t,i,o,c){if(t.segment===void 0)return!0;let s=t,b=t.segment+1,W=0;for(;W>-i/2;){if(b--,b<0)return!1;W-=n[b].dist(s),s=n[b]}W+=n[b].dist(n[b+1]),b++;let R=[],I=0;for(;W<i/2;){let h=n[b],Z=n[b+1];if(!Z)return!1;let F=n[b-1].angleTo(h)-h.angleTo(Z);for(F=Math.abs((F+3*Math.PI)%(2*Math.PI)-Math.PI),R.push({distance:W,angleDelta:F}),I+=F;W-R[0].distance>o;)I-=R.shift().angleDelta;if(I>c)return!1;b++,W+=h.dist(Z)}return!0}function vZ(n){let t=0;for(let i=0;i<n.length-1;i++)t+=n[i].dist(n[i+1]);return t}function EZ(n,t,i){return n?.6*t*i:0}function LZ(n,t){return Math.max(n?n.right-n.left:0,t?t.right-t.left:0)}function RU(n,t,i,o,c,s){let b=EZ(i,c,s),W=LZ(i,o)*s,R=0,I=vZ(n)/2;for(let h=0;h<n.length-1;h++){let Z=n[h],F=n[h+1],V=Z.dist(F);if(R+V>I){let G=(I-R)/V,N=Je(Z.x,F.x,G),X=Je(Z.y,F.y,G),M=new Jo(N,X,0,F.angleTo(Z),h);return!b||fZ(n,M,W,b,t)?M:void 0}R+=V}}function GU(n,t,i,o,c,s,b,W,R){let I=EZ(o,s,b),h=LZ(o,c),Z=h*b,F=n[0].x===0||n[0].x===R||n[0].y===0||n[0].y===R;return t-Z<t/4&&(t=Z+t/4),zZ(n,F?t/2*W%t:(h/2+2*s)*b*W%t,t,I,i,Z,F,!1,R)}function zZ(n,t,i,o,c,s,b,W,R){let I=s/2,h=vZ(n),Z=0,F=t-i,V=[];for(let G=0;G<n.length-1;G++){let N=n[G],X=n[G+1],M=N.dist(X),S=X.angleTo(N);for(;F+i<Z+M;){F+=i;let f=(F-Z)/M,T=Je(N.x,X.x,f),v=Je(N.y,X.y,f);if(T>=0&&T<R&&v>=0&&v<R&&F-I>=0&&F+I<=h){let L=new Jo(T,v,0,S,G);o&&!fZ(n,L,s,o,c)||V.push(L)}}Z+=M}return W||V.length||b||(V=zZ(n,Z/2,i,o,c,s,b,!0,R)),V}function wZ(n,t,i,o,c){let s=[];for(let b=0;b<n.length;b++){let W=n[b],R;for(let I=0;I<W.length-1;I++){let h=W[I],Z=W[I+1];h.x<t&&Z.x<t||(h.x<t?h=new ee(t,h.y+(t-h.x)/(Z.x-h.x)*(Z.y-h.y))._round():Z.x<t&&(Z=new ee(t,h.y+(t-h.x)/(Z.x-h.x)*(Z.y-h.y))._round()),h.y<i&&Z.y<i||(h.y<i?h=new ee(h.x+(i-h.y)/(Z.y-h.y)*(Z.x-h.x),i)._round():Z.y<i&&(Z=new ee(h.x+(i-h.y)/(Z.y-h.y)*(Z.x-h.x),i)._round()),h.x>=o&&Z.x>=o||(h.x>=o?h=new ee(o,h.y+(o-h.x)/(Z.x-h.x)*(Z.y-h.y))._round():Z.x>=o&&(Z=new ee(o,h.y+(o-h.x)/(Z.x-h.x)*(Z.y-h.y))._round()),h.y>=c&&Z.y>=c||(h.y>=c?h=new ee(h.x+(c-h.y)/(Z.y-h.y)*(Z.x-h.x),c)._round():Z.y>=c&&(Z=new ee(h.x+(c-h.y)/(Z.y-h.y)*(Z.x-h.x),c)._round()),R&&h.equals(R[R.length-1])||(R=[h],s.push(R)),R.push(Z)))))}}return s}function AZ(n){let t=0,i=0;for(let b of n)t+=b.w*b.h,i=Math.max(i,b.w);n.sort((b,W)=>W.h-b.h);let o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),i),h:1/0}],c=0,s=0;for(let b of n)for(let W=o.length-1;W>=0;W--){let R=o[W];if(!(b.w>R.w||b.h>R.h)){if(b.x=R.x,b.y=R.y,s=Math.max(s,b.y+b.h),c=Math.max(c,b.x+b.w),b.w===R.w&&b.h===R.h){let I=o.pop();W<o.length&&(o[W]=I)}else b.h===R.h?(R.x+=b.w,R.w-=b.w):b.w===R.w?(R.y+=b.h,R.h-=b.h):(o.push({x:R.x+b.w,y:R.y,w:R.w-b.w,h:b.h}),R.y+=b.h,R.h-=b.h);break}}return{w:c,h:s,fill:t/(c*s)||0}}he(Jo,"Anchor");let tm=1;class RW{constructor(t,{pixelRatio:i,version:o,stretchX:c,stretchY:s,content:b},W){this.paddedRect=t,this.pixelRatio=i,this.stretchX=c,this.stretchY=s,this.content=b,this.version=o,this.padding=W}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}}class HZ{constructor(t,i,o){let c={},s={};this.haveRenderCallbacks=[];let b=[];this.addImages(t,c,tm,b),this.addImages(i,s,2,b);let{w:W,h:R}=AZ(b),I=new $a({width:W||1,height:R||1});for(let h in t){let Z=t[h],F=c[h].paddedRect;$a.copy(Z.data,I,{x:0,y:0},{x:F.x+tm,y:F.y+tm},Z.data,o,Z.sdf)}for(let h in i){let Z=i[h],F=s[h].paddedRect,V=s[h].padding,G=F.x+V,N=F.y+V,X=Z.data.width,M=Z.data.height;V=V>1?V-1:V,$a.copy(Z.data,I,{x:0,y:0},{x:G,y:N},Z.data,o),$a.copy(Z.data,I,{x:0,y:M-V},{x:G,y:N-V},{width:X,height:V},o),$a.copy(Z.data,I,{x:0,y:0},{x:G,y:N+M},{width:X,height:V},o),$a.copy(Z.data,I,{x:X-V,y:0},{x:G-V,y:N},{width:V,height:M},o),$a.copy(Z.data,I,{x:0,y:0},{x:G+X,y:N},{width:V,height:M},o),$a.copy(Z.data,I,{x:X-V,y:M-V},{x:G-V,y:N-V},{width:V,height:V},o),$a.copy(Z.data,I,{x:0,y:M-V},{x:G+X,y:N-V},{width:V,height:V},o),$a.copy(Z.data,I,{x:0,y:0},{x:G+X,y:N+M},{width:V,height:V},o),$a.copy(Z.data,I,{x:X-V,y:0},{x:G-V,y:N+M},{width:V,height:V},o)}this.image=I,this.iconPositions=c,this.patternPositions=s}addImages(t,i,o,c){for(let s in t){let b=t[s],W={x:0,y:0,w:b.data.width+2*o,h:b.data.height+2*o};c.push(W),i[s]=new RW(W,b,o),b.hasRenderCallback&&this.haveRenderCallbacks.push(s)}}patchUpdatedImages(t,i,o){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(c=>t.hasImage(c,o)),t.dispatchRenderCallbacks(this.haveRenderCallbacks,o);for(let c in t.getUpdatedImages(o))this.patchUpdatedImage(this.iconPositions[c],t.getImage(c,o),i),this.patchUpdatedImage(this.patternPositions[c],t.getImage(c,o),i)}patchUpdatedImage(t,i,o){if(!t||!i||t.version===i.version)return;t.version=i.version;let[c,s]=t.tl;o.update(i.data,{position:{x:c,y:s}})}}he(RW,"ImagePosition"),he(HZ,"ImageAtlas");let em=1e20;function jZ(n,t,i,o,c,s,b,W,R){for(let I=t;I<t+o;I++)OZ(n,i*s+I,s,c,b,W,R);for(let I=i;I<i+c;I++)OZ(n,I*s+t,1,o,b,W,R)}function OZ(n,t,i,o,c,s,b){s[0]=0,b[0]=-em,b[1]=em,c[0]=n[t];for(let W=1,R=0,I=0;W<o;W++){c[W]=n[t+W*i];let h=W*W;do{let Z=s[R];I=(c[W]-c[Z]+h-Z*Z)/(W-Z)/2}while(I<=b[R]&&--R>-1);R++,s[R]=W,b[R]=I,b[R+1]=em}for(let W=0,R=0;W<o;W++){for(;b[R+1]<W;)R++;let I=s[R],h=W-I;n[t+W*i]=c[I]+h*h}}let Ql=2,GW={none:0,ideographs:1,all:2};class nc{constructor(t,i,o){this.requestManager=t,this.localGlyphMode=i,this.localFontFamily=o,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t,i){this.urls[i]=t}getGlyphs(t,i,o){let c=[],s=this.urls[i]||pt.GLYPHS_URL;for(let b in t)for(let W of t[b])c.push({stack:b,id:W});al(c,({stack:b,id:W},R)=>{let I=this.entries[b];I||(I=this.entries[b]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let h=I.glyphs[W];if(h!==void 0)return void R(null,{stack:b,id:W,glyph:h});if(h=this._tinySDF(I,b,W),h)return I.glyphs[W]=h,void R(null,{stack:b,id:W,glyph:h});let Z=Math.floor(W/256);if(256*Z>65535)return void R(new Error("glyphs > 65535 not supported"));if(I.ranges[Z])return void R(null,{stack:b,id:W,glyph:h});let F=I.requests[Z];F||(F=I.requests[Z]=[],nc.loadGlyphRange(b,Z,s,this.requestManager,(V,G)=>{if(G){I.ascender=G.ascender,I.descender=G.descender;for(let N in G.glyphs)this._doesCharSupportLocalGlyph(+N)||(I.glyphs[+N]=G.glyphs[+N]);I.ranges[Z]=!0}for(let N of F)N(V,G);delete I.requests[Z]})),F.push((V,G)=>{V?R(V):G&&R(null,{stack:b,id:W,glyph:G.glyphs[W]||null})})},(b,W)=>{if(b)o(b);else if(W){let R={};for(let{stack:I,id:h,glyph:Z}of W)R[I]===void 0&&(R[I]={}),R[I].glyphs===void 0&&(R[I].glyphs={}),R[I].glyphs[h]=Z&&{id:Z.id,bitmap:Z.bitmap.clone(),metrics:Z.metrics},R[I].ascender=this.entries[I].ascender,R[I].descender=this.entries[I].descender;o(null,R)}})}_doesCharSupportLocalGlyph(t){return this.localGlyphMode!==GW.none&&(this.localGlyphMode===GW.all?!!this.localFontFamily:!!this.localFontFamily&&(Ge["CJK Unified Ideographs"](t)||Ge["Hangul Syllables"](t)||Ge.Hiragana(t)||Ge.Katakana(t)||Ge["CJK Symbols and Punctuation"](t)||Ge["CJK Unified Ideographs Extension A"](t)||Ge["CJK Unified Ideographs Extension B"](t)))}_tinySDF(t,i,o){let c=this.localFontFamily;if(!c||!this._doesCharSupportLocalGlyph(o))return;let s=t.tinySDF;if(!s){let N="400";/bold/i.test(i)?N="900":/medium/i.test(i)?N="500":/light/i.test(i)&&(N="200"),s=t.tinySDF=new nc.TinySDF({fontFamily:c,fontWeight:N,fontSize:24*Ql,buffer:3*Ql,radius:8*Ql}),s.fontWeight=N}if(this.localGlyphs[s.fontWeight][o])return this.localGlyphs[s.fontWeight][o];let b=String.fromCodePoint(o),{data:W,width:R,height:I,glyphWidth:h,glyphHeight:Z,glyphLeft:F,glyphTop:V,glyphAdvance:G}=s.draw(b);return this.localGlyphs[s.fontWeight][o]={id:o,bitmap:new Is({width:R,height:I},W),metrics:{width:h/Ql,height:Z/Ql,left:F/Ql,top:V/Ql-27,advance:G/Ql,localGlyph:!0}}}}nc.loadGlyphRange=function(n,t,i,o,c){let s=256*t,b=s+255,W=o.transformRequest(o.normalizeGlyphsURL(i).replace("{fontstack}",n).replace("{range}",`${s}-${b}`),vo.Glyphs);Eo(W,(R,I)=>{if(R)c(R);else if(I){let h={},Z=function(F){return new a0(F).readFields(pU,{})}(I);for(let F of Z.glyphs)h[F.id]=F;c(null,{glyphs:h,ascender:Z.ascender,descender:Z.descender})}})},nc.TinySDF=class{constructor({fontSize:n=24,buffer:t=3,radius:i=8,cutoff:o=.25,fontFamily:c="sans-serif",fontWeight:s="normal",fontStyle:b="normal"}={}){this.buffer=t,this.cutoff=o,this.radius=i;let W=this.size=n+4*t,R=this._createCanvas(W),I=this.ctx=R.getContext("2d",{willReadFrequently:!0});I.font=`${b} ${s} ${n}px ${c}`,I.textBaseline="alphabetic",I.textAlign="left",I.fillStyle="black",this.gridOuter=new Float64Array(W*W),this.gridInner=new Float64Array(W*W),this.f=new Float64Array(W),this.z=new Float64Array(W+1),this.v=new Uint16Array(W)}_createCanvas(n){let t=document.createElement("canvas");return t.width=t.height=n,t}draw(n){let{width:t,actualBoundingBoxAscent:i,actualBoundingBoxDescent:o,actualBoundingBoxLeft:c,actualBoundingBoxRight:s}=this.ctx.measureText(n),b=Math.ceil(i),W=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(s-c))),R=Math.min(this.size-this.buffer,b+Math.ceil(o)),I=W+2*this.buffer,h=R+2*this.buffer,Z=Math.max(I*h,0),F=new Uint8ClampedArray(Z),V={data:F,width:I,height:h,glyphWidth:W,glyphHeight:R,glyphTop:b,glyphLeft:0,glyphAdvance:t};if(W===0||R===0)return V;let{ctx:G,buffer:N,gridInner:X,gridOuter:M}=this;G.clearRect(N,N,W,R),G.fillText(n,N,N+b);let S=G.getImageData(N,N,W,R);M.fill(em,0,Z),X.fill(0,0,Z);for(let f=0;f<R;f++)for(let T=0;T<W;T++){let v=S.data[4*(f*W+T)+3]/255;if(v===0)continue;let L=(f+N)*I+T+N;if(v===1)M[L]=0,X[L]=em;else{let D=.5-v;M[L]=D>0?D*D:0,X[L]=D<0?D*D:0}}jZ(M,0,0,I,h,I,this.f,this.v,this.z),jZ(X,N,N,W,R,I,this.f,this.v,this.z);for(let f=0;f<Z;f++){let T=Math.sqrt(M[f])-Math.sqrt(X[f]);F[f]=Math.round(255-255*(T/this.radius+this.cutoff))}return V}};let xs=tm;function DZ(n,t,i,o){let c=[],s=n.imagePrimary,b=s.pixelRatio,W=s.paddedRect.w-2*xs,R=s.paddedRect.h-2*xs,I=n.right-n.left,h=n.bottom-n.top,Z=s.stretchX||[[0,W]],F=s.stretchY||[[0,R]],V=(st,it)=>st+it[1]-it[0],G=Z.reduce(V,0),N=F.reduce(V,0),X=W-G,M=R-N,S=0,f=G,T=0,v=N,L=0,D=X,q=0,tt=M;if(s.content&&o){let st=s.content;S=l0(Z,0,st[0]),T=l0(F,0,st[1]),f=l0(Z,st[0],st[2]),v=l0(F,st[1],st[3]),L=st[0]-S,q=st[1]-T,D=st[2]-st[0]-f,tt=st[3]-st[1]-v}let P=(st,it,dt,Zt)=>{let Vt=o0(st.stretch-S,f,I,n.left),Rt=s0(st.fixed-L,D,st.stretch,G),Ft=o0(it.stretch-T,v,h,n.top),yt=s0(it.fixed-q,tt,it.stretch,N),xt=o0(dt.stretch-S,f,I,n.left),ft=s0(dt.fixed-L,D,dt.stretch,G),At=o0(Zt.stretch-T,v,h,n.top),Ct=s0(Zt.fixed-q,tt,Zt.stretch,N),se=new ee(Vt,Ft),ae=new ee(xt,Ft),Pt=new ee(xt,At),jt=new ee(Vt,At),xe=new ee(Rt/b,yt/b),oe=new ee(ft/b,Ct/b),me=t*Math.PI/180;if(me){let ei=Math.sin(me),yi=Math.cos(me),Fi=[yi,-ei,ei,yi];se._matMult(Fi),ae._matMult(Fi),jt._matMult(Fi),Pt._matMult(Fi)}let Ce=st.stretch+st.fixed,Ke=dt.stretch+dt.fixed,Ae=it.stretch+it.fixed,He=Zt.stretch+Zt.fixed,$e=n.imageSecondary;return{tl:se,tr:ae,bl:jt,br:Pt,texPrimary:{x:s.paddedRect.x+xs+Ce,y:s.paddedRect.y+xs+Ae,w:Ke-Ce,h:He-Ae},texSecondary:$e?{x:$e.paddedRect.x+xs+Ce,y:$e.paddedRect.y+xs+Ae,w:Ke-Ce,h:He-Ae}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:xe,pixelOffsetBR:oe,minFontScaleX:D/b/I,minFontScaleY:tt/b/h,isSDF:i}};if(o&&(s.stretchX||s.stretchY)){let st=_Z(Z,X,G),it=_Z(F,M,N);for(let dt=0;dt<st.length-1;dt++){let Zt=st[dt],Vt=st[dt+1];for(let Rt=0;Rt<it.length-1;Rt++)c.push(P(Zt,it[Rt],Vt,it[Rt+1]))}}else c.push(P({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:W+1},{fixed:0,stretch:R+1}));return c}function l0(n,t,i){let o=0;for(let c of n)o+=Math.max(t,Math.min(i,c[1]))-Math.max(t,Math.min(i,c[0]));return o}function _Z(n,t,i){let o=[{fixed:-xs,stretch:0}];for(let[c,s]of n){let b=o[o.length-1];o.push({fixed:c-b.stretch,stretch:b.stretch}),o.push({fixed:c-b.stretch,stretch:b.stretch+(s-c)})}return o.push({fixed:t+xs,stretch:i}),o}function o0(n,t,i,o){return n/t*i+o}function s0(n,t,i,o){return n-t*i/o}function FU(n,t,i,o){let c=t+n.positionedLines[o].lineOffset;return o===0?i+c/2:i+(c+(t+n.positionedLines[o-1].lineOffset))/2}function IU(n,t=1,i=!1){let o=1/0,c=1/0,s=-1/0,b=-1/0,W=n[0];for(let V=0;V<W.length;V++){let G=W[V];(!V||G.x<o)&&(o=G.x),(!V||G.y<c)&&(c=G.y),(!V||G.x>s)&&(s=G.x),(!V||G.y>b)&&(b=G.y)}let R=Math.min(s-o,b-c),I=R/2,h=new jc([],UU);if(R===0)return new ee(o,c);for(let V=o;V<s;V+=R)for(let G=c;G<b;G+=R)h.push(new lc(V+I,G+I,I,n));let Z=function(V){let G=0,N=0,X=0,M=V[0];for(let S=0,f=M.length,T=f-1;S<f;T=S++){let v=M[S],L=M[T],D=v.x*L.y-L.x*v.y;N+=(v.x+L.x)*D,X+=(v.y+L.y)*D,G+=3*D}return new lc(N/G,X/G,0,V)}(n),F=h.length;for(;h.length;){let V=h.pop();(V.d>Z.d||!Z.d)&&(Z=V,i&&console.log("found best %d after %d probes",Math.round(1e4*V.d)/1e4,F)),V.max-Z.d<=t||(I=V.h/2,h.push(new lc(V.p.x-I,V.p.y-I,I,n)),h.push(new lc(V.p.x+I,V.p.y-I,I,n)),h.push(new lc(V.p.x-I,V.p.y+I,I,n)),h.push(new lc(V.p.x+I,V.p.y+I,I,n)),F+=4)}return i&&(console.log(`num probes: ${F}`),console.log(`best distance: ${Z.d}`)),Z.p}function UU(n,t){return t.max-n.max}class lc{constructor(t,i,o,c){this.p=new ee(t,i),this.h=o,this.d=function(s,b){let W=!1,R=1/0;for(let I=0;I<b.length;I++){let h=b[I];for(let Z=0,F=h.length,V=F-1;Z<F;V=Z++){let G=h[Z],N=h[V];G.y>s.y!=N.y>s.y&&s.x<(N.x-G.x)*(s.y-G.y)/(N.y-G.y)+G.x&&(W=!W),R=Math.min(R,Ui(s,G,N))}}return(W?1:-1)*Math.sqrt(R)}(this.p,c),this.max=this.d+this.h*Math.SQRT2}}let FW=Number.POSITIVE_INFINITY,xU=Math.sqrt(2);function PZ(n,[t,i]){let o=0,c=0;if(i===FW){t<0&&(t=0);let s=t/xU;switch(n){case"top-right":case"top-left":c=s-7;break;case"bottom-right":case"bottom-left":c=7-s;break;case"bottom":c=7-t;break;case"top":c=t-7}switch(n){case"top-right":case"bottom-right":o=-s;break;case"top-left":case"bottom-left":o=s;break;case"left":o=t;break;case"right":o=-t}}else{switch(t=Math.abs(t),i=Math.abs(i),n){case"top-right":case"top-left":case"top":c=i-7;break;case"bottom-right":case"bottom-left":case"bottom":c=7-i}switch(n){case"top-right":case"bottom-right":case"right":o=-t;break;case"top-left":case"bottom-left":case"left":o=t}}return[o,c]}function IW(n){switch(n){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function NU(n,t,i,o,c,s,b,W,R,I,h,Z,F,V,G){let N=s.textMaxSize.evaluate(t,{},Z);N===void 0&&(N=b);let X=n.layers[0].layout,M=X.get("icon-offset").evaluate(t,{},Z),S=qZ(i.horizontal)||i.vertical,f=F.name==="globe",T=Ma,v=b/T,L=n.tilePixelRatio*N/T,D=(Vt=n.overscaling,n.zoom>18&&Vt>2&&(Vt>>=1),Math.max(ne/(512*Vt),1)*X.get("symbol-spacing")),q=X.get("text-padding")*n.tilePixelRatio,tt=X.get("icon-padding")*n.tilePixelRatio,P=ti(X.get("text-max-angle")),st=X.get("text-rotation-alignment")==="map"&&X.get("symbol-placement")!=="point",it=X.get("icon-rotation-alignment")==="map"&&X.get("symbol-placement")!=="point",dt=X.get("symbol-placement"),Zt=D/2;var Vt;let Rt=X.get("icon-text-fit").evaluate(t,{},Z),Ft=X.get("icon-text-fit-padding").evaluate(t,{},Z),yt=Rt!=="none",xt;n.hasAnyIconTextFit===!1&&yt&&(n.hasAnyIconTextFit=!0),o&&yt&&(n.allowVerticalPlacement&&i.vertical&&(xt=QZ(o,i.vertical,Rt,Ft,M,v)),S&&(o=QZ(o,S,Rt,Ft,M,v)));let ft=(At,Ct,se)=>{if(Ct.x<0||Ct.x>=ne||Ct.y<0||Ct.y>=ne)return;let ae=null;if(f){let{x:Pt,y:jt,z:xe}=F.projectTilePoint(Ct.x,Ct.y,se);ae={anchor:new Jo(Pt,jt,xe,0,void 0),up:F.upVector(se,Ct.x,Ct.y)}}(function(Pt,jt,xe,oe,me,Ce,Ke,Ae,He,$e,ei,yi,Fi,Se,ui,gi,Qi,qi,oa,$i,Hi,Ua,da,Ta,ki,In,Ll){let Wl=Pt.addToLineVertexArray(jt,oe),ul,Mr,ys,Tr,Vm,VV,RV,GV=0,FV=0,IV=0,UV=0,qW=-1,$W=-1,oo={},xV=an(""),Cr=xe?xe.anchor:jt,t1=He.layout.get("icon-text-fit").evaluate(Hi,{},ki)!=="none",e1=0,i1=0;if(He._unevaluatedLayout.getValue("text-radial-offset")===void 0?[e1,i1]=He.layout.get("text-offset").evaluate(Hi,{},ki).map(Cn=>Cn*Ma):(e1=He.layout.get("text-radial-offset").evaluate(Hi,{},ki)*Ma,i1=FW),Pt.allowVerticalPlacement&&me.vertical){let Cn=me.vertical;if(ui)VV=UW(Cn),Ae&&(RV=UW(Ae));else{let kn=He.layout.get("text-rotate").evaluate(Hi,{},ki)+90;ys=r0($e,Cr,jt,ei,yi,Fi,Cn,Se,kn,gi),Ae&&(Tr=r0($e,Cr,jt,ei,yi,Fi,Ae,qi,kn))}}if(Ce){let Cn=He.layout.get("icon-rotate").evaluate(Hi,{},ki),kn=DZ(Ce,Cn,da,t1),hc=Ae?DZ(Ae,Cn,da,t1):void 0;Mr=r0($e,Cr,jt,ei,yi,Fi,Ce,qi,Cn),GV=4*kn.length;let NV=Pt.iconSizeData,kr=null;NV.kind==="source"?(kr=[Sl*He.layout.get("icon-size").evaluate(Hi,{},ki)],kr[0]>Ns&&mi(`${Pt.layerIds[0]}: Value for "icon-size" is >= ${im}. Reduce your "icon-size".`)):NV.kind==="composite"&&(kr=[Sl*Ua.compositeIconSizes[0].evaluate(Hi,{},ki),Sl*Ua.compositeIconSizes[1].evaluate(Hi,{},ki)],(kr[0]>Ns||kr[1]>Ns)&&mi(`${Pt.layerIds[0]}: Value for "icon-size" is >= ${im}. Reduce your "icon-size".`)),Pt.addSymbols(Pt.icon,kn,kr,$i,oa,Hi,!1,xe,jt,Wl.lineStartIndex,Wl.lineLength,-1,Ta,ki,In,Ll),qW=Pt.icon.placedSymbolArray.length-1,hc&&(FV=4*hc.length,Pt.addSymbols(Pt.icon,hc,kr,$i,oa,Hi,qn.vertical,xe,jt,Wl.lineStartIndex,Wl.lineLength,-1,Ta,ki,In,Ll),$W=Pt.icon.placedSymbolArray.length-1)}for(let Cn in me.horizontal){let kn=me.horizontal[Cn];ul||(xV=an(kn.text),ui?Vm=UW(kn):ul=r0($e,Cr,jt,ei,yi,Fi,kn,Se,He.layout.get("text-rotate").evaluate(Hi,{},ki),gi));let hc=kn.positionedLines.length===1;if(IV+=KZ(Pt,xe,jt,kn,Ke,He,ui,Hi,gi,Wl,me.vertical?qn.horizontal:qn.horizontalOnly,hc?Object.keys(me.horizontal):[Cn],oo,qW,Ua,Ta,ki,In),hc)break}me.vertical&&(UV+=KZ(Pt,xe,jt,me.vertical,Ke,He,ui,Hi,gi,Wl,qn.vertical,["vertical"],oo,$W,Ua,Ta,ki,In));let Bs=-1,a1=(Cn,kn)=>Cn?Math.max(Cn,kn):kn;Bs=a1(Vm,Bs),Bs=a1(VV,Bs),Bs=a1(RV,Bs);let Lx=Bs>-1?1:0;Pt.glyphOffsetArray.length>=65535&&mi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Hi.sortKey!==void 0&&Pt.addToSortKeyRanges(Pt.symbolInstances.length,Hi.sortKey),Pt.symbolInstances.emplaceBack(jt.x,jt.y,Cr.x,Cr.y,Cr.z,oo.right>=0?oo.right:-1,oo.center>=0?oo.center:-1,oo.left>=0?oo.left:-1,oo.vertical>=0?oo.vertical:-1,qW,$W,xV,ul!==void 0?ul:Pt.collisionBoxArray.length,ul!==void 0?ul+1:Pt.collisionBoxArray.length,ys!==void 0?ys:Pt.collisionBoxArray.length,ys!==void 0?ys+1:Pt.collisionBoxArray.length,Mr!==void 0?Mr:Pt.collisionBoxArray.length,Mr!==void 0?Mr+1:Pt.collisionBoxArray.length,Tr||Pt.collisionBoxArray.length,Tr?Tr+1:Pt.collisionBoxArray.length,ei,IV,UV,GV,FV,Lx,0,e1,i1,Bs,0,t1?1:0)})(n,Ct,ae,At,i,o,c,xt,n.layers[0],n.collisionBoxArray,t.index,t.sourceLayerIndex,n.index,q,st,R,0,tt,it,M,t,s,I,h,Z,V,G)};if(dt==="line")for(let At of wZ(t.geometry,0,0,ne,ne)){let Ct=GU(At,D,P,i.vertical||S,o,T,L,n.overscaling,ne);for(let se of Ct)S&&YU(n,S.text,Zt,se)||ft(At,se,Z)}else if(dt==="line-center"){for(let At of t.geometry)if(At.length>1){let Ct=RU(At,P,i.vertical||S,o,T,L);Ct&&ft(At,Ct,Z)}}else if(t.type==="Polygon")for(let At of _h(t.geometry,0)){let Ct=IU(At,16);ft(At[0],new Jo(Ct.x,Ct.y,0,0,void 0),Z)}else if(t.type==="LineString")for(let At of t.geometry)ft(At,new Jo(At[0].x,At[0].y,0,0,void 0),Z);else if(t.type==="Point")for(let At of t.geometry)for(let Ct of At)ft([Ct],new Jo(Ct.x,Ct.y,0,0,void 0),Z)}let im=255,Ns=im*Sl;function KZ(n,t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X,M){let S=function(v,L,D,q,tt,P,st,it){let dt=[];if(L.positionedLines.length===0)return dt;let Zt=q.layout.get("text-rotate").evaluate(P,{})*Math.PI/180,Vt=function(ft){let At=ft[0],Ct=ft[1],se=At*Ct;return se>0?[At,-Ct]:se<0?[-At,Ct]:At===0?[Ct,At]:[Ct,-At]}(D),Rt=Math.abs(L.top-L.bottom);for(let ft of L.positionedLines)Rt-=ft.lineOffset;let Ft=L.positionedLines.length,yt=Rt/Ft,xt=L.top-D[1];for(let ft=0;ft<Ft;++ft){let At=L.positionedLines[ft];xt=FU(L,yt,xt,ft);for(let Ct of At.positionedGlyphs){if(!Ct.rect)continue;let se=Ct.rect||{},ae=BZ+1,Pt=!0,jt=1,xe=0;if(Ct.imageName){let $i=st[Ct.imageName];if(!$i)continue;if($i.sdf){mi("SDF images are not supported in formatted text and will be ignored.");continue}Pt=!1,jt=$i.pixelRatio,ae=tm/jt}let oe=(tt||it)&&Ct.vertical,me=Ct.metrics.advance*Ct.scale/2,Ce=Ct.metrics,Ke=Ct.rect;if(Ke===null)continue;it&&L.verticalizable&&(xe=Ct.imageName?me-Ct.metrics.width*Ct.scale/2:0);let Ae=tt?[Ct.x+me,Ct.y]:[0,0],He=[0,0],$e=[0,0],ei=!1;tt||(oe?($e=[Ct.x+me+Vt[0],Ct.y+Vt[1]-xe],ei=!0):He=[Ct.x+me+D[0],Ct.y+D[1]-xe]);let yi=Ke.w*Ct.scale/(jt*(Ct.localGlyph?Ql:1)),Fi=Ke.h*Ct.scale/(jt*(Ct.localGlyph?Ql:1)),Se,ui,gi,Qi;if(oe){let $i=Ct.y-xt,Hi=new ee(-me,me-$i),Ua=-Math.PI/2,da=new ee(...$e);Se=new ee(-me+He[0],He[1]),Se._rotateAround(Ua,Hi)._add(da),Se.x+=-$i+me,Se.y-=(Ce.left-ae)*Ct.scale;let Ta=Ct.imageName?Ce.advance*Ct.scale:Ma*Ct.scale,ki=String.fromCodePoint(Ct.glyph);bU(ki)?Se.x+=(1-ae)*Ct.scale:mU(ki)?Se.x+=Ta-Ce.height*Ct.scale+(-ae-1)*Ct.scale:Se.x+=Ct.imageName||Ce.width+2*ae===Ke.w&&Ce.height+2*ae===Ke.h?(Ta-Fi)/2:(Ta-(Ce.height+2*ae)*Ct.scale)/2,ui=new ee(Se.x,Se.y-yi),gi=new ee(Se.x+Fi,Se.y),Qi=new ee(Se.x+Fi,Se.y-yi)}else{let $i=(Ce.left-ae)*Ct.scale-me+He[0],Hi=(-Ce.top-ae)*Ct.scale+He[1],Ua=$i+yi,da=Hi+Fi;Se=new ee($i,Hi),ui=new ee(Ua,Hi),gi=new ee($i,da),Qi=new ee(Ua,da)}if(Zt){let $i;$i=tt?new ee(0,0):ei?new ee(Vt[0],Vt[1]):new ee(D[0],D[1]),Se._rotateAround(Zt,$i),ui._rotateAround(Zt,$i),gi._rotateAround(Zt,$i),Qi._rotateAround(Zt,$i)}let qi=new ee(0,0),oa=new ee(0,0);dt.push({tl:Se,tr:ui,bl:gi,br:Qi,texPrimary:se,texSecondary:void 0,writingMode:L.writingMode,glyphOffset:Ae,sectionIndex:Ct.sectionIndex,isSDF:Pt,pixelOffsetTL:qi,pixelOffsetBR:oa,minFontScaleX:0,minFontScaleY:0})}}return dt}(0,o,R,s,b,W,c,n.allowVerticalPlacement),f=n.textSizeData,T=null;f.kind==="source"?(T=[Sl*s.layout.get("text-size").evaluate(W,{},X)],T[0]>Ns&&mi(`${n.layerIds[0]}: Value for "text-size" is >= ${im}. Reduce your "text-size".`)):f.kind==="composite"&&(T=[Sl*G.compositeTextSizes[0].evaluate(W,{},X),Sl*G.compositeTextSizes[1].evaluate(W,{},X)],(T[0]>Ns||T[1]>Ns)&&mi(`${n.layerIds[0]}: Value for "text-size" is >= ${im}. Reduce your "text-size".`)),n.addSymbols(n.text,S,T,R,b,W,h,t,i,I.lineStartIndex,I.lineLength,V,N,X,M,!1);for(let v of Z)F[v]=n.text.placedSymbolArray.length-1;return 4*S.length}function qZ(n){for(let t in n)return n[t];return null}function r0(n,t,i,o,c,s,b,W,R,I){let h=b.top,Z=b.bottom,F=b.left,V=b.right,G=b.collisionPadding;if(G&&(F-=G[0],h-=G[1],V+=G[2],Z+=G[3]),R){let N=new ee(F,h),X=new ee(V,h),M=new ee(F,Z),S=new ee(V,Z),f=ti(R),T=new ee(0,0);I&&(T=new ee(I[0],I[1])),N._rotateAround(f,T),X._rotateAround(f,T),M._rotateAround(f,T),S._rotateAround(f,T),F=Math.min(N.x,X.x,M.x,S.x),V=Math.max(N.x,X.x,M.x,S.x),h=Math.min(N.y,X.y,M.y,S.y),Z=Math.max(N.y,X.y,M.y,S.y)}return n.emplaceBack(t.x,t.y,t.z,i.x,i.y,F,h,V,Z,W,o,c,s),n.length-1}function UW(n){n.collisionPadding&&(n.top-=n.collisionPadding[1],n.bottom+=n.collisionPadding[3]);let t=n.bottom-n.top;return t>0?Math.max(10,t):null}function YU(n,t,i,o){let c=n.compareText;if(t in c){let s=c[t];for(let b=s.length-1;b>=0;b--)if(o.dist(s[b])<i)return!0}else c[t]=[];return c[t].push(o),!1}function $Z(n,t){let i=n.fovAboveCenter,o=n.elevation?n.elevation.getMinElevationBelowMSL()*t:0,c=(n._camera.position[2]*n.worldSize-o)/Math.cos(n._pitch),s=Math.sin(i)*c/Math.sin(Math.max(Math.PI/2-n._pitch-i,.01)),b=Math.sin(n._pitch)*s+c,W=c*(1/n._horizonShift);return n.elevation&&n.elevation.exaggeration()!==0||(b*=1+Math.max(n.zoom-17,0)),Math.min(1.01*b,W)}function am(n,t){if(!t.isReprojectedInTileSpace)return{scale:1<<n.z,x:n.x,y:n.y,x2:n.x+1,y2:n.y+1,projection:t};let i=Math.pow(2,-n.z),o=n.x*i,c=(n.x+1)*i,s=n.y*i,b=(n.y+1)*i,W=nt(o),R=nt(c),I=at(s),h=at(b),Z=t.project(W,I),F=t.project(R,I),V=t.project(R,h),G=t.project(W,h),N=Math.min(Z.x,F.x,V.x,G.x),X=Math.min(Z.y,F.y,V.y,G.y),M=Math.max(Z.x,F.x,V.x,G.x),S=Math.max(Z.y,F.y,V.y,G.y),f=i/16;function T(L,D,q,tt,P,st){let it=(q+P)/2,dt=(tt+st)/2,Zt=t.project(nt(it),at(dt)),Vt=Math.max(0,N-Zt.x,X-Zt.y,Zt.x-M,Zt.y-S);N=Math.min(N,Zt.x),M=Math.max(M,Zt.x),X=Math.min(X,Zt.y),S=Math.max(S,Zt.y),Vt>f&&(T(L,Zt,q,tt,it,dt),T(Zt,D,it,dt,P,st))}T(Z,F,o,s,c,s),T(F,V,c,s,c,b),T(V,G,c,b,o,b),T(G,Z,o,b,o,s),N-=f,X-=f,M+=f,S+=f;let v=1/Math.max(M-N,S-X);return{scale:v,x:N*v,y:X*v,x2:M*v,y2:S*v,projection:t}}function tg(n,{x:t,y:i},o=0){return new ee(((t-o)*n.scale-n.x)*ne,(i*n.scale-n.y)*ne)}let JU=ut.mat4.identity(new Float32Array(16));class Ys{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,i){return{x:0,y:0,z:0}}unproject(t,i){return new Q(0,0)}projectTilePoint(t,i,o){return{x:t,y:i,z:0}}locationPoint(t,i,o=!0){return t._coordinatePoint(t.locationCoordinate(i),o)}pixelsPerMeter(t,i){return K(1,t)*i}pixelSpaceConversion(t,i,o){return 1}farthestPixelDistance(t){return $Z(t,t.pixelsPerMeter)}pointCoordinate(t,i,o,c){let s=t.horizonLineFromTop(!1),b=new ee(i,Math.max(s,o));return t.rayIntersectionCoordinate(t.pointRayIntersection(b,c))}pointCoordinate3D(t,i,o){let c=new ee(i,o);if(t.elevation)return t.elevation.pointCoordinate(c);{let s=this.pointCoordinate(t,c.x,c.y,0);return[s.x,s.y,s.z]}}isPointAboveHorizon(t,i){if(t.elevation&&t.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(t,i.x,i.y);let o=t.horizonLineFromTop();return i.y<o}createInversionMatrix(t,i){return JU}createTileMatrix(t,i,o){let c,s,b,W=o.canonical,R=ut.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){let I=am(W,this);c=1,s=I.x+o.wrap*I.scale,b=I.y,ut.mat4.scale(R,R,[c/I.scale,c/I.scale,t.pixelsPerMeter/i])}else c=i/t.zoomScale(W.z),s=(W.x+Math.pow(2,W.z)*o.wrap)*c,b=W.y*c;return ut.mat4.translate(R,R,[s,b,0]),ut.mat4.scale(R,R,[c/ne,c/ne,1]),R}upVector(t,i,o){return[0,0,1]}upVectorScale(t,i,o){return{metersToTile:1}}}class XU extends Ys{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];let[i,o]=this.parallels=t.parallels||[29.5,45.5],c=Math.sin(ti(i));this.n=(c+Math.sin(ti(o)))/2,this.c=1+c*(2*this.n-c),this.r0=Math.sqrt(this.c)/this.n}project(t,i){let{n:o,c,r0:s}=this,b=ti(t-this.center[0]),W=ti(i),R=Math.sqrt(c-2*o*Math.sin(W))/o;return{x:R*Math.sin(b*o),y:R*Math.cos(b*o)-s,z:0}}unproject(t,i){let{n:o,c,r0:s}=this,b=s+i,W=Math.atan2(t,Math.abs(b))*Math.sign(b);b*o<0&&(W-=Math.PI*Math.sign(t)*Math.sign(b));let R=ti(this.center[0])*o;W=pn(W,-Math.PI-R,Math.PI-R);let I=ze(sa(W/o)+this.center[0],-180,180),h=Math.asin(ze((c-(t*t+b*b)*o*o)/(2*o),-1,1)),Z=ze(sa(h),-rt,rt);return new Q(I,Z)}}let nm=1.340264,lm=-.081106,om=893e-6,sm=.003796,d0=Math.sqrt(3)/2;class yU extends Ys{project(t,i){i=i/180*Math.PI,t=t/180*Math.PI;let o=Math.asin(d0*Math.sin(i)),c=o*o,s=c*c*c;return{x:.5*(t*Math.cos(o)/(d0*(nm+3*lm*c+s*(7*om+9*sm*c)))/Math.PI+.5),y:1-.5*(o*(nm+lm*c+s*(om+sm*c))/Math.PI+1),z:0}}unproject(t,i){t=(2*t-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,c=o*o,s=c*c*c;for(let h,Z,F,V=0;V<12&&(Z=o*(nm+lm*c+s*(om+sm*c))-i,F=nm+3*lm*c+s*(7*om+9*sm*c),h=Z/F,o=ze(o-h,-Math.PI/3,Math.PI/3),c=o*o,s=c*c*c,!(Math.abs(h)<1e-12));++V);let b=d0*t*(nm+3*lm*c+s*(7*om+9*sm*c))/Math.cos(o),W=Math.asin(Math.sin(o)/d0),R=ze(180*b/Math.PI,-180,180),I=ze(180*W/Math.PI,-rt,rt);return new Q(R,I)}}class BU extends Ys{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,i){return{x:.5+t/360,y:.5-i/360,z:0}}unproject(t,i){let o=360*(t-.5),c=ze(360*(.5-i),-rt,rt);return new Q(o,c)}}let oc=Math.PI/2;function c0(n){return Math.tan((oc+n)/2)}class MU extends Ys{constructor(t){super(t),this.center=t.center||[0,30];let[i,o]=this.parallels=t.parallels||[30,30],c=ti(i),s=ti(o);this.southernCenter=c+s<0,this.southernCenter&&(c=-c,s=-s);let b=Math.cos(c),W=c0(c);this.n=c===s?Math.sin(c):Math.log(b/Math.cos(s))/Math.log(c0(s)/W),this.f=b*Math.pow(c0(c),this.n)/this.n}project(t,i){i=ti(i),this.southernCenter&&(i=-i),t=ti(t-this.center[0]);let o=1e-6,{n:c,f:s}=this;s>0?i<-oc+o&&(i=-oc+o):i>oc-o&&(i=oc-o);let b=s/Math.pow(c0(i),c),W=b*Math.sin(c*t),R=s-b*Math.cos(c*t);return W=.5*(W/Math.PI+.5),R=.5*(R/Math.PI+.5),{x:W,y:this.southernCenter?R:1-R,z:0}}unproject(t,i){t=(2*t-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;let{n:o,f:c}=this,s=c-i,b=Math.sign(s),W=Math.sign(o)*Math.sqrt(t*t+s*s),R=Math.atan2(t,Math.abs(s))*b;s*o<0&&(R-=Math.PI*Math.sign(t)*b);let I=ze(sa(R/o)+this.center[0],-180,180),h=ze(sa(2*Math.atan(Math.pow(c/W,1/o))-oc),-rt,rt);return new Q(I,this.southernCenter?-h:h)}}class eg extends Ys{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,i){return{x:$(t),y:et(i),z:0}}unproject(t,i){let o=nt(t),c=at(i);return new Q(o,c)}}let ig=ti(rt);class TU extends Ys{project(t,i){let o=(i=ti(i))*i,c=o*o;return{x:.5*((t=ti(t))*(.8707-.131979*o+c*(c*(.003971*o-.001529*c)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+o*(.015085+c*(.028874*o-.044475-.005916*c)))/Math.PI+1),z:0}}unproject(t,i){t=(2*t-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,c=25,s=0,b=o*o;do{b=o*o;let I=b*b;s=(o*(1.007226+b*(.015085+I*(.028874*b-.044475-.005916*I)))-i)/(1.007226+b*(.045255+I*(.259866*b-.311325-.005916*11*I))),o=ze(o-s,-ig,ig)}while(Math.abs(s)>1e-6&&--c>0);b=o*o;let W=ze(sa(t/(.8707+b*(b*(b*b*b*(.003971-.001529*b)-.013791)-.131979))),-180,180),R=sa(o);return new Q(W,R)}}let ag=ti(rt);class CU extends Ys{project(t,i){i=ti(i),t=ti(t);let o=Math.cos(i),c=2/Math.PI,s=Math.acos(o*Math.cos(t/2)),b=Math.sin(s)/s,W=.5*(t*c+2*o*Math.sin(t/2)/b)||0,R=.5*(i+Math.sin(i)/b)||0;return{x:.5*(W/Math.PI+.5),y:1-.5*(R/Math.PI+1),z:0}}unproject(t,i){let o=t=(2*t-.5)*Math.PI,c=i=(2*(1-i)-1)*Math.PI,s=25,b=1e-6,W=0,R=0;do{let I=Math.cos(c),h=Math.sin(c),Z=2*h*I,F=h*h,V=I*I,G=Math.cos(o/2),N=Math.sin(o/2),X=2*G*N,M=N*N,S=1-V*G*G,f=S?1/S:0,T=S?Math.acos(I*G)*Math.sqrt(1/S):0,v=.5*(2*T*I*N+2*o/Math.PI)-t,L=.5*(T*h+c)-i,D=.5*f*(V*M+T*I*G*F)+1/Math.PI,q=f*(X*Z/4-T*h*N),tt=.125*f*(Z*N-T*h*V*X),P=.5*f*(F*G+T*M*I)+.5,st=q*tt-P*D;W=(L*q-v*P)/st,R=(v*tt-L*D)/st,o=ze(o-W,-Math.PI,Math.PI),c=ze(c-R,-ag,ag)}while((Math.abs(W)>b||Math.abs(R)>b)&&--s>0);return new Q(sa(o),sa(c))}}class ng extends Ys{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(ti(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,i){let{scale:o,cosPhi:c}=this;return{x:ti(t)*c*o+.5,y:-Math.sin(ti(i))/c*o+.5,z:0}}unproject(t,i){let{scale:o,cosPhi:c}=this,s=-(i-.5)/o,b=ze(sa((t-.5)/o)/c,-180,180),W=Math.asin(ze(s*c,-1,1)),R=ze(sa(W),-rt,rt);return new Q(b,R)}}class kU extends eg{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(t,i,o){let c=Lb(t,i,o),s=Hh(no(o));return ut.vec3.transformMat4(c,c,s),{x:c[0],y:c[1],z:c[2]}}locationPoint(t,i){let o=B(i.lat,i.lng),c=ut.vec3.normalize([],o),s=t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(i),t._centerAltitude):t._centerAltitude,b=K(1,0)*ne*s;ut.vec3.scaleAndAdd(o,o,c,b);let W=ut.mat4.identity(new Float64Array(16));return ut.mat4.multiply(W,t.pixelMatrix,t.globeMatrix),ut.vec3.transformMat4(o,o,W),new ee(o[0],o[1])}pixelsPerMeter(t,i){return K(1,0)*i}pixelSpaceConversion(t,i,o){let c=K(1,t)*i,s=Je(K(1,45)*i,c,o);return this.pixelsPerMeter(t,i)/s}createTileMatrix(t,i,o){let c=Dp(no(o.canonical));return ut.mat4.multiply(new Float64Array(16),t.globeMatrix,c)}createInversionMatrix(t,i){let{center:o}=t,c=Hh(no(i));return ut.mat4.rotateY(c,c,ti(o.lng)),ut.mat4.rotateX(c,c,ti(o.lat)),ut.mat4.scale(c,c,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(c)}pointCoordinate(t,i,o,c){return zh(t,i,o,!0)||new Nt(0,0)}pointCoordinate3D(t,i,o){let c=this.pointCoordinate(t,i,o,0);return[c.x,c.y,c.z]}isPointAboveHorizon(t,i){return!zh(t,i.x,i.y,!1)}farthestPixelDistance(t){let i=function(c,s){let b=c.cameraToCenterDistance,W=c._centerAltitude*s,R=c._camera,I=c._camera.forward(),h=ut.vec3.add([],ut.vec3.scale([],I,-b),[0,0,W]),Z=c.worldSize/(2*Math.PI),F=[0,0,-Z],V=c.width/c.height,G=Math.tan(c.fovAboveCenter),N=ut.vec3.scale([],R.up(),G),X=ut.vec3.scale([],R.right(),G*V),M=ut.vec3.normalize([],ut.vec3.add([],ut.vec3.add([],I,N),X)),S=[],f;if(new kl(h,M).closestPointOnSphere(F,Z,S)){let T=ut.vec3.add([],S,F),v=ut.vec3.sub([],T,h);f=Math.cos(c.fovAboveCenter)*ut.vec3.length(v)}else{let T=ut.vec3.sub([],h,F),v=ut.vec3.sub([],F,h);ut.vec3.normalize(v,v);let L=ut.vec3.length(T)-Z;f=Math.sqrt(L*(L+2*Z));let D=Math.acos(f/(Z+L))-Math.acos(ut.vec3.dot(I,v));f*=Math.cos(D)}return 1.01*f}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),o=Fs(t.zoom);if(o>0){let c=$Z(t,K(1,t.center.lat)*t.worldSize),s=t.worldSize/(2*Math.PI),b=Math.max(t.width,t.height)/t.worldSize*Math.PI;return Je(i,c+s*(1-Math.cos(b)),Math.pow(o,10))}return i}upVector(t,i,o){return Lb(i,o,t,1)}upVectorScale(t){return{metersToTile:No(Ah(no(t)))}}}function lg(n){let t=n.parallels,i=!!t&&Math.abs(t[0]+t[1])<.01;switch(n.name){case"mercator":return new eg(n);case"equirectangular":return new BU(n);case"naturalEarth":return new TU(n);case"equalEarth":return new yU(n);case"winkelTripel":return new CU(n);case"albers":return i?new ng(n):new XU(n);case"lambertConformalConic":return i?new ng(n):new MU(n);case"globe":return new kU(n)}throw new Error(`Invalid projection name: ${n.name}`)}let SU=ec.VectorTileFeature.types,QU=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function b0(n,t,i,o,c,s,b,W,R,I,h,Z,F){let V=W?Math.min(Ns,Math.round(W[0])):0,G=W?Math.min(Ns,Math.round(W[1])):0;n.emplaceBack(t,i,Math.round(32*o),Math.round(32*c),s,b,(V<<1)+(R?1:0),G,16*I,16*h,256*Z,256*F)}function m0(n,t,i){n.emplaceBack(t,i)}function h0(n,t,i,o,c,s,b){n.emplaceBack(t,i,o,c,s,b)}function p0(n,t,i,o,c){n.emplaceBack(t,i,o,c),n.emplaceBack(t,i,o,c),n.emplaceBack(t,i,o,c),n.emplaceBack(t,i,o,c)}function fU(n){for(let t of n.sections)if(yp(t.text))return!0;return!1}class xW{constructor(t){this.layoutVertexArray=new Yb,this.indexArray=new Ja,this.programConfigurations=t,this.segments=new Oi,this.dynamicLayoutVertexArray=new Bl,this.opacityVertexArray=new Xb,this.placedSymbolArray=new Cb,this.iconTransitioningVertexArray=new eo,this.globeExtVertexArray=new Jb,this.zOffsetVertexArray=new us}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(t,i,o,c,s){this.isEmpty()||(o&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,eU.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,aU.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,QU,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=t.createVertexBuffer(this.iconTransitioningVertexArray,lU.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,iU.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||s)&&(this.zOffsetVertexBuffer=t.createVertexBuffer(this.zOffsetVertexArray,nU.members,!0)),this.opacityVertexBuffer.itemSize=1),(o||c)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}he(xW,"SymbolBuffers");class NW{constructor(t,i,o){this.layoutVertexArray=new t,this.layoutAttributes=i,this.indexArray=new o,this.segments=new Oi,this.collisionVertexArray=new Ws,this.collisionVertexArrayExt=new Bl}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,oU.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,sU.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}he(NW,"CollisionBuffers");class W0{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.lut=t.lut,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(b=>b.fqid),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ut.mat4.identity([]),this.placementViewportMatrix=ut.mat4.identity([]);let i=this.layers[0]._unevaluatedLayout._values;this.textSizeData=pW(this.zoom,i["text-size"]),this.iconSizeData=pW(this.zoom,i["icon-size"]);let o=this.layers[0].layout,c=o.get("symbol-sort-key"),s=o.get("symbol-z-order");this.canOverlap=o.get("text-allow-overlap")||o.get("icon-allow-overlap")||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=s!=="viewport-y"&&c.constantOr(1)!==void 0,this.sortFeaturesByY=(s==="viewport-y"||s==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=o.get("text-writing-mode").map(b=>qn[b]),this.stateDependentLayerIds=this.layers.filter(b=>b.isStateDependent()).map(b=>b.id),this.sourceID=t.sourceID,this.projection=t.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=o.get("symbol-z-elevate"),this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new xW(new io(this.layers,{zoom:this.zoom,lut:this.lut},t=>t.startsWith("text")||t.startsWith("symbol"))),this.icon=new xW(new io(this.layers,{zoom:this.zoom,lut:this.lut},t=>t.startsWith("icon")||t.startsWith("symbol"))),this.glyphOffsetArray=new Th,this.lineVertexArray=new Pd,this.symbolInstances=new kb}calculateGlyphDependencies(t,i,o,c,s){for(let b=0;b<t.length;b++){let W=t.codePointAt(b);if(W===void 0)break;if(i[W]=!0,c&&s&&W<=65535){let R=qb[t.charAt(b)];R&&(i[R.charCodeAt(0)]=!0)}}}updateFootprints(t,i){}updateReplacement(t,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;let o=i.getReplacementRegionsForTile(t.toUnwrapped(),!0);return!rW(this.activeReplacements,o)&&(this.activeReplacements=o,!0)}populate(t,i,o,c){let s=this.layers[0],b=s.layout,W=this.projection.name==="globe",R=b.get("text-font"),I=b.get("text-field"),h=b.get("icon-image"),Z=(I.value.kind!=="constant"||I.value.value instanceof La&&!I.value.value.isEmpty()||I.value.value.toString().length>0)&&(R.value.kind!=="constant"||R.value.value.length>0),F=h.value.kind!=="constant"||!!h.value.value||Object.keys(h.parameters).length>0,V=b.get("symbol-sort-key");if(this.features=[],!Z&&!F)return;let G=i.iconDependencies,N=i.glyphDependencies,X=i.availableImages,M=new ji(this.zoom);for(let{feature:S,id:f,index:T,sourceLayerIndex:v}of t){let L=s._featureFilter.needGeometry,D=qt(S,L);if(!s._featureFilter.filter(M,D,o))continue;if(L||(D.geometry=_t(S,o,c)),W&&S.type!==1&&o.z<=5){let st=D.geometry,it=.98078528056,dt=(Zt,Vt)=>{let Rt=Lb(Zt.x,Zt.y,o,1),Ft=Lb(Vt.x,Vt.y,o,1);return ut.vec3.dot(Rt,Ft)<it};for(let Zt=0;Zt<st.length;Zt++)st[Zt]=Ot(st[Zt],dt)}let q,tt;if(Z){let st=s.getValueAndResolveTokens("text-field",D,o,X),it=La.factory(st);fU(it)&&(this.hasRTLText=!0),(!this.hasRTLText||Gb()==="unavailable"||this.hasRTLText&&sn.isParsed())&&(q=cU(it,s,D))}if(F){let st=s.getValueAndResolveTokens("icon-image",D,o,X);tt=st instanceof Da?st:Da.fromString(st)}if(!q&&!tt)continue;let P=this.sortFeaturesByKey?V.evaluate(D,{},o):void 0;if(this.features.push({id:f,text:q,icon:tt,index:T,sourceLayerIndex:v,geometry:D.geometry,properties:S.properties,type:SU[S.type],sortKey:P}),tt&&(G[tt.namePrimary]=!0,tt.nameSecondary&&(G[tt.nameSecondary]=!0)),q){let st=R.evaluate(D,{},o).join(","),it=b.get("text-rotation-alignment")==="map"&&b.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(qn.vertical)>=0;for(let dt of q.sections)if(dt.image)G[dt.image.namePrimary]=!0;else{let Zt=Cd(q.toString()),Vt=dt.fontStack||st,Rt=N[Vt]=N[Vt]||{};this.calculateGlyphDependencies(dt.text,Rt,it,this.allowVerticalPlacement,Zt)}}}b.get("symbol-placement")==="line"&&(this.features=function(S){let f={},T={},v=[],L=0;function D(st){v.push(S[st]),L++}function q(st,it,dt){let Zt=T[st];return delete T[st],T[it]=Zt,v[Zt].geometry[0].pop(),v[Zt].geometry[0]=v[Zt].geometry[0].concat(dt[0]),Zt}function tt(st,it,dt){let Zt=f[it];return delete f[it],f[st]=Zt,v[Zt].geometry[0].shift(),v[Zt].geometry[0]=dt[0].concat(v[Zt].geometry[0]),Zt}function P(st,it,dt){let Zt=dt?it[0][it[0].length-1]:it[0][0];return`${st}:${Zt.x}:${Zt.y}`}for(let st=0;st<S.length;st++){let it=S[st],dt=it.geometry,Zt=it.text?it.text.toString():null;if(!Zt){D(st);continue}let Vt=P(Zt,dt),Rt=P(Zt,dt,!0);if(Vt in T&&Rt in f&&T[Vt]!==f[Rt]){let Ft=tt(Vt,Rt,dt),yt=q(Vt,Rt,v[Ft].geometry);delete f[Vt],delete T[Rt],T[P(Zt,v[yt].geometry,!0)]=yt,v[Ft].geometry=null}else Vt in T?q(Vt,Rt,dt):Rt in f?tt(Vt,Rt,dt):(D(st),f[Vt]=L-1,T[Rt]=L-1)}return v.filter(st=>st.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((S,f)=>S.sortKey-f.sortKey)}update(t,i,o,c,s){let b=Object.keys(t).length!==0;if(b&&!this.stateDependentLayers.length)return;let W=b?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(t,i,W,o,c,s),this.icon.programConfigurations.updatePaintArrays(t,i,W,o,c,s)}updateZOffset(){let t=(s,b,W)=>{o+=b,o>s.length&&s.resize(o);for(let R=-b;R<0;R++)s.emplace(R+o,W)},i=(s,b,W)=>{c+=b,c>s.length&&s.resize(c);for(let R=-b;R<0;R++)s.emplace(R+c,W)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let o=0,c=0;for(let s=0;s<this.symbolInstances.length;s++){let b=this.symbolInstances.get(s),{numHorizontalGlyphVertices:W,numVerticalGlyphVertices:R,numIconVertices:I}=b,h=b.zOffset,Z=I>0;if((W>0||R>0)&&(t(this.text.zOffsetVertexArray,W,h),t(this.text.zOffsetVertexArray,R,h)),Z){let{placedIconSymbolIndex:F,verticalPlacedIconSymbolIndex:V}=b;F>=0&&i(this.icon.zOffsetVertexArray,I,h),V>=0&&i(this.icon.zOffsetVertexArray,b.numVerticalIconVertices,h)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=lg(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,i){let o=this.lineVertexArray.length;if(t.segment!==void 0)for(let{x:c,y:s}of i)this.lineVertexArray.emplaceBack(c,s);return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(t,i,o,c,s,b,W,R,I,h,Z,F,V,G,N,X){let M=t.indexArray,S=t.layoutVertexArray,f=t.globeExtVertexArray,T=t.segments.prepareSegment(4*i.length,S,M,this.canOverlap?b.sortKey:void 0),v=this.glyphOffsetArray.length,L=T.vertexLength,D=this.allowVerticalPlacement&&W===qn.vertical?Math.PI/2:0,q=b.text&&b.text.sections;for(let P=0;P<i.length;P++){let{tl:st,tr:it,bl:dt,br:Zt,texPrimary:Vt,texSecondary:Rt,pixelOffsetTL:Ft,pixelOffsetBR:yt,minFontScaleX:xt,minFontScaleY:ft,glyphOffset:At,isSDF:Ct,sectionIndex:se}=i[P],ae=T.vertexLength,Pt=At[1];if(b0(S,I.x,I.y,st.x,Pt+st.y,Vt.x,Vt.y,o,Ct,Ft.x,Ft.y,xt,ft),b0(S,I.x,I.y,it.x,Pt+it.y,Vt.x+Vt.w,Vt.y,o,Ct,yt.x,Ft.y,xt,ft),b0(S,I.x,I.y,dt.x,Pt+dt.y,Vt.x,Vt.y+Vt.h,o,Ct,Ft.x,yt.y,xt,ft),b0(S,I.x,I.y,Zt.x,Pt+Zt.y,Vt.x+Vt.w,Vt.y+Vt.h,o,Ct,yt.x,yt.y,xt,ft),R){let{x:jt,y:xe,z:oe}=R.anchor,[me,Ce,Ke]=R.up;h0(f,jt,xe,oe,me,Ce,Ke),h0(f,jt,xe,oe,me,Ce,Ke),h0(f,jt,xe,oe,me,Ce,Ke),h0(f,jt,xe,oe,me,Ce,Ke),p0(t.dynamicLayoutVertexArray,jt,xe,oe,D)}else p0(t.dynamicLayoutVertexArray,I.x,I.y,I.z,D);if(X){let jt=Rt||Vt;m0(t.iconTransitioningVertexArray,jt.x,jt.y),m0(t.iconTransitioningVertexArray,jt.x+jt.w,jt.y),m0(t.iconTransitioningVertexArray,jt.x,jt.y+jt.h),m0(t.iconTransitioningVertexArray,jt.x+jt.w,jt.y+jt.h)}M.emplaceBack(ae,ae+1,ae+2),M.emplaceBack(ae+1,ae+2,ae+3),T.vertexLength+=4,T.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(At[0]),P!==i.length-1&&se===i[P+1].sectionIndex||t.programConfigurations.populatePaintArrays(S.length,b,b.index,{},V,G,N,q&&q[se])}let tt=R?R.anchor:I;t.placedSymbolArray.emplaceBack(tt.x,tt.y,tt.z,I.x,I.y,v,this.glyphOffsetArray.length-v,L,h,Z,I.segment,o?o[0]:0,o?o[1]:0,c[0],c[1],W,0,!1,0,F,0)}_commitLayoutVertex(t,i,o,c,s,b,W){t.emplaceBack(i,o,c,s,b,Math.round(W.x),Math.round(W.y))}_addCollisionDebugVertices(t,i,o,c,s,b,W){let R=o.segments.prepareSegment(4,o.layoutVertexArray,o.indexArray),I=R.vertexLength,h=W.tileAnchorX,Z=W.tileAnchorY;for(let V=0;V<4;V++)o.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(o.collisionVertexArrayExt,i,t.padding,W.zOffset),this._commitLayoutVertex(o.layoutVertexArray,c,s,b,h,Z,new ee(t.x1,t.y1)),this._commitLayoutVertex(o.layoutVertexArray,c,s,b,h,Z,new ee(t.x2,t.y1)),this._commitLayoutVertex(o.layoutVertexArray,c,s,b,h,Z,new ee(t.x2,t.y2)),this._commitLayoutVertex(o.layoutVertexArray,c,s,b,h,Z,new ee(t.x1,t.y2)),R.vertexLength+=4;let F=o.indexArray;F.emplaceBack(I,I+1),F.emplaceBack(I+1,I+2),F.emplaceBack(I+2,I+3),F.emplaceBack(I+3,I),R.primitiveLength+=4}_addTextDebugCollisionBoxes(t,i,o,c,s,b){for(let W=c;W<s;W++){let R=o.get(W),I=this.getSymbolInstanceTextSize(t,b,i,W);this._addCollisionDebugVertices(R,I,this.textCollisionBox,R.projectedAnchorX,R.projectedAnchorY,R.projectedAnchorZ,b)}}_addIconDebugCollisionBoxes(t,i,o,c,s,b){for(let W=c;W<s;W++){let R=o.get(W),I=this.getSymbolInstanceIconSize(t,i,b.placedIconSymbolIndex);this._addCollisionDebugVertices(R,I,this.iconCollisionBox,R.projectedAnchorX,R.projectedAnchorY,R.projectedAnchorZ,b)}}generateCollisionDebugBuffers(t,i){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new NW(Io,YZ.members,eo),this.iconCollisionBox=new NW(Io,YZ.members,eo);let o=ic(this.iconSizeData,t),c=ic(this.textSizeData,t);for(let s=0;s<this.symbolInstances.length;s++){let b=this.symbolInstances.get(s);this._addTextDebugCollisionBoxes(c,t,i,b.textBoxStartIndex,b.textBoxEndIndex,b),this._addTextDebugCollisionBoxes(c,t,i,b.verticalTextBoxStartIndex,b.verticalTextBoxEndIndex,b),this._addIconDebugCollisionBoxes(o,t,i,b.iconBoxStartIndex,b.iconBoxEndIndex,b),this._addIconDebugCollisionBoxes(o,t,i,b.verticalIconBoxStartIndex,b.verticalIconBoxEndIndex,b)}}getSymbolInstanceTextSize(t,i,o,c){let s=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:c),b=i0(this.textSizeData,t,s)/Ma;return this.tilePixelRatio*b}getSymbolInstanceIconSize(t,i,o){let c=this.icon.placedSymbolArray.get(o),s=i0(this.iconSizeData,t,c);return this.tilePixelRatio*s}_commitDebugCollisionVertexUpdate(t,i,o,c){t.emplaceBack(i,-o,-o,c),t.emplaceBack(i,o,-o,c),t.emplaceBack(i,o,o,c),t.emplaceBack(i,-o,o,c)}_updateTextDebugCollisionBoxes(t,i,o,c,s,b){for(let W=c;W<s;W++){let R=o.get(W),I=this.getSymbolInstanceTextSize(t,b,i,W);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,I,R.padding,b.zOffset)}}_updateIconDebugCollisionBoxes(t,i,o,c,s,b){for(let W=c;W<s;W++){let R=o.get(W),I=this.getSymbolInstanceIconSize(t,i,b.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,I,R.padding,b.zOffset)}}updateCollisionDebugBuffers(t,i){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let o=ic(this.iconSizeData,t),c=ic(this.textSizeData,t);for(let s=0;s<this.symbolInstances.length;s++){let b=this.symbolInstances.get(s);this._updateTextDebugCollisionBoxes(c,t,i,b.textBoxStartIndex,b.textBoxEndIndex,b),this._updateTextDebugCollisionBoxes(c,t,i,b.verticalTextBoxStartIndex,b.verticalTextBoxEndIndex,b),this._updateIconDebugCollisionBoxes(o,t,i,b.iconBoxStartIndex,b.iconBoxEndIndex,b),this._updateIconDebugCollisionBoxes(o,t,i,b.verticalIconBoxStartIndex,b.verticalIconBoxEndIndex,b)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,i,o,c,s,b,W,R,I){let h={};if(i<o){let{x1:Z,y1:F,x2:V,y2:G,padding:N,projectedAnchorX:X,projectedAnchorY:M,projectedAnchorZ:S,tileAnchorX:f,tileAnchorY:T,featureIndex:v}=t.get(i);h.textBox={x1:Z,y1:F,x2:V,y2:G,padding:N,projectedAnchorX:X,projectedAnchorY:M,projectedAnchorZ:S,tileAnchorX:f,tileAnchorY:T},h.textFeatureIndex=v}if(c<s){let{x1:Z,y1:F,x2:V,y2:G,padding:N,projectedAnchorX:X,projectedAnchorY:M,projectedAnchorZ:S,tileAnchorX:f,tileAnchorY:T,featureIndex:v}=t.get(c);h.verticalTextBox={x1:Z,y1:F,x2:V,y2:G,padding:N,projectedAnchorX:X,projectedAnchorY:M,projectedAnchorZ:S,tileAnchorX:f,tileAnchorY:T},h.verticalTextFeatureIndex=v}if(b<W){let{x1:Z,y1:F,x2:V,y2:G,padding:N,projectedAnchorX:X,projectedAnchorY:M,projectedAnchorZ:S,tileAnchorX:f,tileAnchorY:T,featureIndex:v}=t.get(b);h.iconBox={x1:Z,y1:F,x2:V,y2:G,padding:N,projectedAnchorX:X,projectedAnchorY:M,projectedAnchorZ:S,tileAnchorX:f,tileAnchorY:T},h.iconFeatureIndex=v}if(R<I){let{x1:Z,y1:F,x2:V,y2:G,padding:N,projectedAnchorX:X,projectedAnchorY:M,projectedAnchorZ:S,tileAnchorX:f,tileAnchorY:T,featureIndex:v}=t.get(R);h.verticalIconBox={x1:Z,y1:F,x2:V,y2:G,padding:N,projectedAnchorX:X,projectedAnchorY:M,projectedAnchorZ:S,tileAnchorX:f,tileAnchorY:T},h.verticalIconFeatureIndex=v}return h}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){let o=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(t,i){let o=t.placedSymbolArray.get(i),c=o.vertexStartIndex+4*o.numGlyphs;for(let s=o.vertexStartIndex;s<c;s+=4)t.indexArray.emplaceBack(s,s+1,s+2),t.indexArray.emplaceBack(s+1,s+2,s+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;let i=Math.sin(t),o=Math.cos(t),c=[],s=[],b=[];for(let W=0;W<this.symbolInstances.length;++W){b.push(W);let R=this.symbolInstances.get(W);c.push(0|Math.round(i*R.tileAnchorX+o*R.tileAnchorY)),s.push(R.featureIndex)}return b.sort((W,R)=>c[W]-c[R]||s[R]-s[W]),b}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let t=0;t<this.symbolInstances.length;++t)this.symbolInstanceIndexesSortedZOffset.push(t)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((t,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(t).zOffset)}addToSortKeyRanges(t,i){let o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===i?o.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(let i of this.symbolInstanceIndexes){let o=this.symbolInstances.get(i);this.featureSortOrder.push(o.featureIndex);let{rightJustifiedTextSymbolIndex:c,centerJustifiedTextSymbolIndex:s,leftJustifiedTextSymbolIndex:b,verticalPlacedTextSymbolIndex:W,placedIconSymbolIndex:R,verticalPlacedIconSymbolIndex:I}=o;c>=0&&this.addIndicesForPlacedSymbol(this.text,c),s>=0&&s!==c&&this.addIndicesForPlacedSymbol(this.text,s),b>=0&&b!==s&&b!==c&&this.addIndicesForPlacedSymbol(this.text,b),W>=0&&this.addIndicesForPlacedSymbol(this.text,W),R>=0&&this.addIndicesForPlacedSymbol(this.icon,R),I>=0&&this.addIndicesForPlacedSymbol(this.icon,I)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let og,sg,YW;he(W0,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),W0.addDynamicAttributes=p0;class rg{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:jn,this.defaultValue=t}evaluate(t){if(t.formattedSection){let i=this.defaultValue.property.overrides;if(i&&i.hasOverride(t.formattedSection))return i.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}he(rg,"FormatSectionOverride",{omit:["defaultValue"]});let JW=()=>YW||(YW={layout:og||(og=new Ei({"symbol-placement":new te(Xt.layout_symbol["symbol-placement"]),"symbol-spacing":new te(Xt.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new te(Xt.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ie(Xt.layout_symbol["symbol-sort-key"]),"symbol-z-order":new te(Xt.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new te(Xt.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new te(Xt.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new te(Xt.layout_symbol["icon-ignore-placement"]),"icon-optional":new te(Xt.layout_symbol["icon-optional"]),"icon-rotation-alignment":new te(Xt.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ie(Xt.layout_symbol["icon-size"]),"icon-text-fit":new Ie(Xt.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ie(Xt.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ie(Xt.layout_symbol["icon-image"]),"icon-rotate":new Ie(Xt.layout_symbol["icon-rotate"]),"icon-padding":new te(Xt.layout_symbol["icon-padding"]),"icon-keep-upright":new te(Xt.layout_symbol["icon-keep-upright"]),"icon-offset":new Ie(Xt.layout_symbol["icon-offset"]),"icon-anchor":new Ie(Xt.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new te(Xt.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new te(Xt.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new te(Xt.layout_symbol["text-rotation-alignment"]),"text-field":new Ie(Xt.layout_symbol["text-field"]),"text-font":new Ie(Xt.layout_symbol["text-font"]),"text-size":new Ie(Xt.layout_symbol["text-size"]),"text-max-width":new Ie(Xt.layout_symbol["text-max-width"]),"text-line-height":new Ie(Xt.layout_symbol["text-line-height"]),"text-letter-spacing":new Ie(Xt.layout_symbol["text-letter-spacing"]),"text-justify":new Ie(Xt.layout_symbol["text-justify"]),"text-radial-offset":new Ie(Xt.layout_symbol["text-radial-offset"]),"text-variable-anchor":new te(Xt.layout_symbol["text-variable-anchor"]),"text-anchor":new Ie(Xt.layout_symbol["text-anchor"]),"text-max-angle":new te(Xt.layout_symbol["text-max-angle"]),"text-writing-mode":new te(Xt.layout_symbol["text-writing-mode"]),"text-rotate":new Ie(Xt.layout_symbol["text-rotate"]),"text-padding":new te(Xt.layout_symbol["text-padding"]),"text-keep-upright":new te(Xt.layout_symbol["text-keep-upright"]),"text-transform":new Ie(Xt.layout_symbol["text-transform"]),"text-offset":new Ie(Xt.layout_symbol["text-offset"]),"text-allow-overlap":new te(Xt.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new te(Xt.layout_symbol["text-ignore-placement"]),"text-optional":new te(Xt.layout_symbol["text-optional"]),visibility:new te(Xt.layout_symbol.visibility)})),paint:sg||(sg=new Ei({"icon-opacity":new Ie(Xt.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Ie(Xt.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Ie(Xt.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Ie(Xt.paint_symbol["text-emissive-strength"]),"icon-color":new Ie(Xt.paint_symbol["icon-color"]),"icon-halo-color":new Ie(Xt.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ie(Xt.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ie(Xt.paint_symbol["icon-halo-blur"]),"icon-translate":new te(Xt.paint_symbol["icon-translate"]),"icon-translate-anchor":new te(Xt.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Ie(Xt.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Ie(Xt.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Ie(Xt.paint_symbol["text-occlusion-opacity"]),"text-color":new Ie(Xt.paint_symbol["text-color"],{runtimeType:nn,getOverride:n=>n.textColor,hasOverride:n=>!!n.textColor}),"text-halo-color":new Ie(Xt.paint_symbol["text-halo-color"]),"text-halo-width":new Ie(Xt.paint_symbol["text-halo-width"]),"text-halo-blur":new Ie(Xt.paint_symbol["text-halo-blur"]),"text-translate":new te(Xt.paint_symbol["text-translate"]),"text-translate-anchor":new te(Xt.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new te(Xt.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new te(Xt.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new te(Xt.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new te(Xt.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Ie(Xt.paint_symbol["symbol-z-offset"]),"symbol-elevation-reference":new te(Xt.paint_symbol["symbol-elevation-reference"])}))},YW);class u0 extends za{constructor(t,i,o,c){super(t,JW(),i,o,c),this._colorAdjustmentMatrix=ut.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=t.paint!==void 0&&("icon-occlusion-opacity"in t.paint||"text-occlusion-opacity"in t.paint)}recalculate(t,i){super.recalculate(t,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let o=this.layout.get("text-writing-mode");if(o){let c=[];for(let s of o)c.indexOf(s)<0&&c.push(s);this.layout._values["text-writing-mode"]=c}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(t,i,o,c){return this._saturation===t&&this._contrast===i&&this._brightnessMin===o&&this._brightnessMax===c||(this._colorAdjustmentMatrix=function(s,b,W,R){s=ot(s),b=_(b);let I=ut.mat4.create(),h=s/3,Z=1-2*h,F=[Z,h,h,0,h,Z,h,0,h,h,Z,0,0,0,0,1],V=.5-.5*b,G=R-W;return ut.mat4.multiply(I,[G,0,0,0,0,G,0,0,0,0,G,0,W,W,W,1],[b,0,0,0,0,b,0,0,0,0,b,0,V,V,V,1]),ut.mat4.multiply(I,I,F),I}(t,i,o,c),this._saturation=t,this._contrast=i,this._brightnessMin=o,this._brightnessMax=c),this._colorAdjustmentMatrix}getValueAndResolveTokens(t,i,o,c){let s=this.layout.get(t).evaluate(i,{},o,c),b=this._unevaluatedLayout._values[t];return b.isDataDriven()||yd(b.value)||!s?s:function(W,R){return R.replace(/{([^{}]+)}/g,(I,h)=>h in W?String(W[h]):"")}(i.properties,s)}createBucket(t){return new W0(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let t of JW().paint.overridableProperties){if(!u0.hasPaintOverride(this.layout,t))continue;let i=this.paint.get(t),o=new rg(i),c=new Xd(o,i.property.specification,this.scope,this.options),s=null;s=i.value.kind==="constant"||i.value.kind==="source"?new Wb("source",c):new dl("composite",c,i.value.zoomStops,i.value._interpolationType),this.paint._values[t]=new cs(i.property,s,i.parameters)}}_handleOverridablePaintPropertyUpdate(t,i,o){return!(!this.layout||i.isDataDriven()||o.isDataDriven())&&u0.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,i){let o=t.get("text-field"),c=JW().paint.properties[i],s=!1,b=W=>{for(let R of W)if(c.overrides&&c.overrides.hasOverride(R))return void(s=!0)};if(o.value.kind==="constant"&&o.value.value instanceof La)b(o.value.value.sections);else if(o.value.kind==="source"){let W=I=>{s||(I instanceof On&&na(I.value)===Ao?b(I.value.sections):I instanceof Do?b(I.sections):I.eachChild(W))},R=o.value;R._styleExpression&&W(R._styleExpression.expression)}return s}getProgramIds(){return["symbol"]}getDefaultProgramParams(t,i,o){return{config:new xo(this,{zoom:i,lut:o}),overrideFog:!1}}}let dg,cg,bg,mg;var XW=pi([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function yW(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function BW(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class MW{constructor(t,i,o,c){this.context=t,this.format=o,this.useMipmap=c&&c.useMipmap,this.texture=t.gl.createTexture(),this.update(i,{premultiply:c&&c.premultiply})}update(t,i){let o=t&&t instanceof HTMLVideoElement&&t.width===0?t.videoWidth:t.width,c=t&&t instanceof HTMLVideoElement&&t.height===0?t.videoHeight:t.height,{context:s}=this,{gl:b}=s,{x:W,y:R}=i&&i.position?i.position:{x:0,y:0},I=Math.max(W+o,this.size?this.size[0]:0),h=Math.max(R+c,this.size?this.size[1]:0);!this.size||this.size[0]===I&&this.size[1]===h||(b.bindTexture(b.TEXTURE_2D,null),b.deleteTexture(this.texture),this.texture=b.createTexture(),this.size=null),b.bindTexture(b.TEXTURE_2D,this.texture),s.pixelStoreUnpackFlipY.set(!1),s.pixelStoreUnpack.set(1),s.pixelStoreUnpackPremultiplyAlpha.set(this.format===b.RGBA8&&(!i||i.premultiply!==!1));let Z=t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||ImageBitmap&&t instanceof ImageBitmap;if(!this.size&&I>0&&h>0){let F=this.useMipmap?Math.floor(Math.log2(Math.max(I,h)))+1:1;b.texStorage2D(b.TEXTURE_2D,F,this.format,I,h),this.size=[I,h]}if(this.size)if(Z)b.texSubImage2D(b.TEXTURE_2D,0,W,R,yW(this.format),BW(this.format),t);else{let F=t.data;F&&b.texSubImage2D(b.TEXTURE_2D,0,W,R,o,c,yW(this.format),BW(this.format),F)}this.useMipmap&&b.generateMipmap(b.TEXTURE_2D)}bind(t,i,o=!1){let{context:c}=this,{gl:s}=c;s.bindTexture(s.TEXTURE_2D,this.texture),t!==this.minFilter&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,this.useMipmap&&!o?t===s.NEAREST?s.NEAREST_MIPMAP_NEAREST:s.LINEAR_MIPMAP_LINEAR:t),this.minFilter=t),i!==this.wrapS&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(t,i,o,c){let{context:s}=this,{gl:b}=s;b.bindTexture(b.TEXTURE_2D,this.texture),i!==this.magFilter&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,i),this.magFilter=i),t!==this.minFilter&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,this.useMipmap?t===b.NEAREST?b.NEAREST_MIPMAP_NEAREST:b.LINEAR_MIPMAP_LINEAR:t),this.minFilter=t),o!==this.wrapS&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,o),this.wrapS=o),c!==this.wrapT&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,c),this.wrapT=c)}destroy(){let{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class Z0{constructor(t,i){this.context=t,this.texture=i}bind(t,i){let{context:o}=this,{gl:c}=o;c.bindTexture(c.TEXTURE_2D,this.texture),t!==this.minFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,t),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,t),this.minFilter=t),i!==this.wrapS&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,i),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,i),this.wrapS=i)}}function g0(n,t,i,o,c,s,b,W){let R=[n,t,1,i,o,1,c,s,1],I=[b,W,1],h=ut.mat3.adjoint([],R),[Z,F,V]=ut.vec3.transformMat3(I,I,h);return ut.mat3.multiply(R,R,[Z,0,0,0,F,0,0,0,V])}function hg(n,t,i,o,c,s,b,W){let R=function(I,h,Z,F,V,G,N,X){let M=g0(0,0,1,0,1,1,0,1),S=g0(I,h,Z,F,V,G,N,X),f=ut.mat3.adjoint([],M);return ut.mat3.multiply(S,S,f)}(n,t,i,o,c,s,b,W);return[R[2]/R[8]/ne,R[5]/R[8]/ne]}function V0(n){return[n[0],Math.min(Math.max(n[1],-rt),rt)]}class pg extends zo{constructor(t,i,o,c){super(),this.id=t,this.dispatcher=o,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(c),this.options=i,this._dirty=!1}load(t,i){if(this._loaded=i||!1,this.fire(new Hl("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return t&&(this.coordinates=t),this._loaded=!0,void this._finishLoading();this._imageRequest=ll(this.map._requestManager.transformRequest(this.url,vo.Image),(o,c)=>{this._imageRequest=null,this._loaded=!0,o?this.fire(new Ks(o)):c&&(this.image=c instanceof HTMLImageElement?ce.getImageData(c):c,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,t&&(this.coordinates=t),this._finishLoading())})}loaded(){return this._loaded}updateImage(t){return t.url?(this._imageRequest&&t.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=t.url,this.load(t.coordinates,this._loaded),this):this}setTexture(t){if(!(t.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Z0(this.map.painter.context,t.handle),this.width=t.dimensions[0],this.height=t.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Hl("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(t){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Z0||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(t){if(this.coordinates=t,this._boundsArray=void 0,this._unsupportedCoords=!1,!t.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=t[0][1],o=t[0][1];for(let s of t)s[1]>o&&(o=s[1]),s[1]<i&&(i=s[1]);let c=(o+i)/2;if(c>rt?this.onNorthPole=!0:c<-rt&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let s=t.map(Nt.fromLngLat);this.tileID=function(b){let W=1/0,R=1/0,I=-1/0,h=-1/0;for(let N of b)W=Math.min(W,N.x),R=Math.min(R,N.y),I=Math.max(I,N.x),h=Math.max(h,N.y);let Z=Math.max(I-W,h-R),F=Math.max(0,Math.floor(-Math.log(Z)/Math.LN2)),V=Math.pow(2,F),G=Math.floor((W+I)/2*V);return G>1&&(G-=1),new Va(F,G,Math.floor((R+h)/2*V))}(s),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Hl("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(t){for(let M in this.tiles){let S=this.tiles[M];S.state!=="loaded"&&(S.state="loaded",S.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let i=am(new Va(0,0,0),this.map.transform.projection),o=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(M){let S=M[1].x-M[0].x,f=M[1].y-M[0].y,T=M[2].x-M[1].x,v=M[2].y-M[1].y,L=M[3].x-M[2].x,D=M[3].y-M[2].y,q=M[0].x-M[3].x,tt=M[0].y-M[3].y,P=S*v-T*f,st=T*D-L*v,it=L*tt-q*D,dt=q*f-S*tt;return P>0&&st>0&&it>0&&dt>0||P<0&&st<0&&it<0&&dt<0}(o))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let c=am(this.tileID,this.map.transform.projection),[s,b,W,R]=this.coordinates.map(M=>{let S=c.projection.project(M[0],M[1]);return tg(c,S)._round()});this.perspectiveTransform=hg(s.x,s.y,b.x,b.y,W.x,W.y,R.x,R.y);let I=this._boundsArray=new $l;I.emplaceBack(s.x,s.y,0,0),I.emplaceBack(b.x,b.y,ne,0),I.emplaceBack(R.x,R.y,0,ne),I.emplaceBack(W.x,W.y,ne,ne),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=t.createVertexBuffer(I,XW.members),this.boundsSegments=Oi.simpleSegment(0,0,4,2);let h=[],Z=[V0((F=this.coordinates)[0]),V0(F[1]),V0(F[2]),V0(F[3])];var F;let[V,G,N,X]=function(M){let S=M[0][0],f=S,T=M[0][1],v=T;for(let L=1;L<M.length;L++)M[L][0]<S?S=M[L][0]:M[L][0]>f&&(f=M[L][0]),M[L][1]<T?T=M[L][1]:M[L][1]>v&&(v=M[L][1]);return[S,T,f-S,v-T]}(Z);{let M=new $l,[S,f,T,v]=function(Ft){let yt=Ft[0].x,xt=yt,ft=Ft[0].y,At=ft;for(let Ct=1;Ct<Ft.length;Ct++)Ft[Ct].x<yt?yt=Ft[Ct].x:Ft[Ct].x>xt&&(xt=Ft[Ct].x),Ft[Ct].y<ft?ft=Ft[Ct].y:Ft[Ct].y>At&&(At=Ft[Ct].y);return[yt,ft,xt-yt,At-ft]}(o),L=Ft=>[(Ft.x-S)/T,(Ft.y-f)/v],[D,q,tt,P]=o.map(L),st=function(Ft,yt,xt,ft,At,Ct,se,ae){let Pt=g0(0,0,1,0,1,1,0,1),jt=g0(Ft,yt,xt,ft,At,Ct,se,ae),xe=ut.mat3.adjoint([],jt);return ut.mat3.multiply(Pt,Pt,xe)}(D[0],D[1],q[0],q[1],tt[0],tt[1],P[0],P[1]);this.elevatedGlobePerspectiveTransform=hg(D[0],D[1],q[0],q[1],tt[0],tt[1],P[0],P[1]);let it=(Ft,yt)=>{h.push(Ft.lng);let xt=Math.round((Ft.lng-V)/N*ne),ft=Math.round((Ft.lat-G)/X*ne),At=L(yt),Ct=ut.vec3.transformMat3([],[At[0],At[1],1],st),se=Math.round(Ct[0]/Ct[2]*ne),ae=Math.round(Ct[1]/Ct[2]*ne);M.emplaceBack(xt,ft,se,ae)},dt=o[3].x-o[0].x,Zt=o[3].y-o[0].y,Vt=o[2].x-o[1].x,Rt=o[2].y-o[1].y;for(let Ft=0;Ft<65;Ft++){let yt=Ft/64,xt=[o[0].x+yt*dt,o[0].y+yt*Zt],ft=[o[1].x+yt*Vt,o[1].y+yt*Rt],At=ft[0]-xt[0],Ct=ft[1]-xt[1];for(let se=0;se<65;se++){let ae=se/64,Pt={x:xt[0]+At*ae,y:xt[1]+Ct*ae,z:0};it(i.projection.unproject(Pt.x,Pt.y),Pt)}}this.elevatedGlobeVertexBuffer=t.createVertexBuffer(M,XW.members)}{this.maxLongitudeTriangleSize=0;let M=[],S=new Ja,f=(T,v,L)=>{S.emplaceBack(T,v,L);let D=h[T],q=h[v],tt=h[L],P=Math.min(Math.min(D,q),tt),st=Math.max(Math.max(D,q),tt)-P;st>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=st),M.push(P+st/2)};for(let T=0;T<64;T++)for(let v=0;v<64;v++){let L=65*T+v,D=L+1,q=L+65,tt=q+1;f(L,q,D),f(D,q,tt)}[M,S]=function(T,v){let L=Array.from({length:T.length},(tt,P)=>P);L.sort((tt,P)=>T[tt]-T[P]);let D=[],q=new Ja;for(let tt=0;tt<L.length;tt++){let P=L[tt];D.push(T[P]);let st=3*P,it=st+1;q.emplaceBack(v.uint16[st],v.uint16[it],v.uint16[it+1])}return[D,q]}(M,S),this.elevatedGlobeTrianglesCenterLongitudes=M,this.elevatedGlobeIndexBuffer=t.createIndexBuffer(S)}this.elevatedGlobeSegments=Oi.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,N/ne,0,X/ne,0,0,G,V,0])}prepare(){let t=Object.keys(this.tiles).length!==0;if(this.tileID&&!t)return;let i=this.map.painter.context,o=i.gl;!this._dirty||this.texture instanceof Z0||(this.texture?this.texture.update(this.image):(this.texture=new MW(i,this.image,o.RGBA8),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE)),this._dirty=!1),t&&this._prepareData(i)}loadTile(t,i){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},i(null)):(t.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(t){let i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;let o=this.elevatedGlobeTrianglesCenterLongitudes,c=(s=t+180)+360*Math.round((o[0]-s)/360);var s;let b=new Oi,W=(Z,F)=>{b.segments.push({vertexOffset:0,primitiveOffset:Z,vertexLength:i.segments[0].vertexLength,primitiveLength:F,sortKey:void 0,vaos:{}})},R=.51*this.maxLongitudeTriangleSize;if(Math.abs(o[0]-c)<=R){let Z=j(o,0,o.length,c+R);return Z===o.length||W(Z,Tt(o,Z+1,o.length,c+360-R)-Z),b}c<o[0]&&(c+=360);let I=Tt(o,0,o.length,c-R);if(I===o.length)return W(0,o.length),b;W(0,I-0);let h=j(o,I+1,o.length,c+R);return h!==o.length&&W(h,o.length-h),b}}let vU=(Math.pow(256,2)-1)/16907520;class Wg extends za{constructor(t,i,o,c){super(t,{layout:bg||(bg=new Ei({visibility:new te(Xt.layout_raster.visibility)})),paint:mg||(mg=new Ei({"raster-opacity":new te(Xt.paint_raster["raster-opacity"]),"raster-color":new _n(Xt.paint_raster["raster-color"]),"raster-color-mix":new te(Xt.paint_raster["raster-color-mix"]),"raster-color-range":new te(Xt.paint_raster["raster-color-range"]),"raster-hue-rotate":new te(Xt.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new te(Xt.paint_raster["raster-brightness-min"]),"raster-brightness-max":new te(Xt.paint_raster["raster-brightness-max"]),"raster-saturation":new te(Xt.paint_raster["raster-saturation"]),"raster-contrast":new te(Xt.paint_raster["raster-contrast"]),"raster-resampling":new te(Xt.paint_raster["raster-resampling"]),"raster-fade-duration":new te(Xt.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new te(Xt.paint_raster["raster-emissive-strength"]),"raster-array-band":new te(Xt.paint_raster["raster-array-band"]),"raster-elevation":new te(Xt.paint_raster["raster-elevation"])}))},i,o,c),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(t){return!(t&&t._source instanceof pg&&(t._source.onNorthPole||t._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(t){t!=="raster-color"&&t!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(t){if(!this.hasColorMap()||!this._curRampRange)return;let i=this._transitionablePaint._values["raster-color"].value.expression,[o,c]=t||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(o)&&isNaN(c)||o===this._curRampRange[0]&&c===this._curRampRange[1]||(this.colorRamp=zb({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:o,end:c}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[o,c])}}let ug,Zg,gg,Vg,Rg;class Gg extends za{constructor(t,i,o,c){super(t,{layout:ug||(ug=new Ei({visibility:new te(Xt["layout_raster-particle"].visibility)})),paint:Zg||(Zg=new Ei({"raster-particle-array-band":new te(Xt["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new te(Xt["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new _n(Xt["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new te(Xt["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new te(Xt["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new te(Xt["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new te(Xt["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new te(Xt["paint_raster-particle"]["raster-particle-elevation"])}))},i,o,c),this._updateColorRamp(),this.lastInvalidatedAt=ce.now()}onRemove(t){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(t){return!1}_handleSpecialPaintPropertyUpdate(t){t!=="raster-particle-color"&&t!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),t==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;let t=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=zb({expression:t,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=ce.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class EU extends za{constructor(t,i){super(t,{},i,null),this.implementation=t,t.slot&&(this.slot=t.slot)}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(t){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}function TW(n,t,i){let o=[0,0,1],c=ut.quat.identity([]);return ut.quat.rotateY(c,c,i?-ti(n)+Math.PI:ti(n)),ut.quat.rotateX(c,c,-ti(t)),ut.vec3.transformQuat(o,o,c),ut.vec3.normalize(o,o)}function Fg(n,t){let i=R0(n.projection,n.zoom,n.width,n.height),o=function(s,b,W,R,I){let h=new Q(W.lng-180*Js,W.lat),Z=new Q(W.lng+180*Js,W.lat),F=s.project(h.lng,h.lat),V=s.project(Z.lng,Z.lat),G=-Math.atan2(V.y-F.y,V.x-F.x),N=Nt.fromLngLat(W);N.y=ze(N.y,-1+Js,1-Js);let X=N.toLngLat(),M=s.project(X.lng,X.lat),S=Nt.fromLngLat(X);S.x+=Js;let f=S.toLngLat(),T=s.project(f.lng,f.lat),v=Ug(T.x-M.x,T.y-M.y,G),L=Nt.fromLngLat(X);L.y+=Js;let D=L.toLngLat(),q=s.project(D.lng,D.lat),tt=Ug(q.x-M.x,q.y-M.y,G),P=Math.abs(v.x)/Math.abs(tt.y),st=ut.mat4.identity([]);ut.mat4.rotateZ(st,st,-G*(1-(I?0:R)));let it=ut.mat4.identity([]);return ut.mat4.scale(it,it,[1,1-(1-P)*R,1]),it[4]=-tt.x/tt.y*R,ut.mat4.rotateZ(it,it,G),ut.mat4.multiply(it,st,it),it}(n.projection,0,n.center,i,t),c=Ig(n);return ut.mat4.scale(o,o,[c,c,1]),o}function Ig(n){let t=n.projection,i=R0(n.projection,n.zoom,n.width,n.height),o=CW(t,n.center),c=CW(t,Q.convert(t.center));return Math.pow(2,o*i+(1-i)*c)}function R0(n,t,i,o,c=1/0){let s=n.range;if(!s)return 0;let b=Math.min(c,Math.max(i,o)),W=Math.log(b/1024)/Math.LN2;return xl(s[0]+W,s[1]+W,t)}let Js=1/4e4;function CW(n,t){let i=ze(t.lat,-rt,rt),o=new Q(t.lng-180*Js,i),c=new Q(t.lng+180*Js,i),s=n.project(o.lng,i),b=n.project(c.lng,i),W=Nt.fromLngLat(o),R=Nt.fromLngLat(c),I=b.x-s.x,h=b.y-s.y,Z=R.x-W.x,F=R.y-W.y,V=Math.sqrt((Z*Z+F*F)/(I*I+h*h));return Math.log(V)/Math.LN2}function Ug(n,t,i){let o=Math.cos(i),c=Math.sin(i);return{x:n*o-t*c,y:n*c+t*o}}function xg(n,t,i){ut.mat4.identity(n),ut.mat4.rotateZ(n,n,ti(t[2])),ut.mat4.rotateX(n,n,ti(t[0])),ut.mat4.rotateY(n,n,ti(t[1])),ut.mat4.scale(n,n,i),ut.mat4.multiply(n,n,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function G0(n,t,i,o,c,s,b,W){let R=[i[0]-t[0],i[1]-t[1],0],I=[o[0]-t[0],o[1]-t[1],0];if(ut.vec3.length(R)<1e-12||ut.vec3.length(I)<1e-12)return ut.quat.identity(n);let h=ut.vec3.cross([],R,I);ut.vec3.normalize(h,h),ut.vec3.subtract(I,o,t),R[2]=(s-c)*W,I[2]=(b-c)*W;let Z=R;return ut.vec3.cross(Z,R,I),ut.vec3.normalize(Z,Z),ut.quat.rotationTo(n,h,Z)}function kW(n,t,i=!1){let o=Fs(t.zoom),c=function(s,b,W){let R=b.worldSize,I=[s[12],s[13],s[14]],h=at(I[1]/R),Z=nt(I[0]/R),F=ut.mat4.identity([]),V=K(1,h)*R,G=K(1,0)*R*gt(h,b.zoom),N=1/_p(R),X=G*N;if(W){let T=R0(b.projection,b.zoom,b.width,b.height,1024);X=N*b.projection.pixelSpaceConversion(b.center.lat,R,T)}let M=B(h,Z);ut.vec3.add(M,M,ut.vec3.scale([],ut.vec3.normalize([],M),V*X*I[2]));let S=function(T){let v=[T[0],T[1],T[2]],L=[0,1,0],D=ut.vec3.cross([],L,v);return ut.vec3.cross(L,v,D),ut.vec3.squaredLength(L)===0&&(L=[0,1,0],ut.vec3.cross(D,v,L)),ut.vec3.normalize(D,D),ut.vec3.normalize(L,L),ut.vec3.normalize(v,v),[D[0],D[1],D[2],0,L[0],L[1],L[2],0,v[0],v[1],v[2],0,T[0],T[1],T[2],1]}(M);ut.mat4.scale(F,F,[X,X,X*V]),ut.mat4.translate(F,F,[-I[0],-I[1],-I[2]]);let f=ut.mat4.multiply([],b.globeMatrix,S);return ut.mat4.multiply(f,f,F),ut.mat4.multiply(f,f,s),f}(n,t,i);if(o>0){let s=function(b,W){let R=W.worldSize,I=K(1,0)*R*gt(W.center.lat,W.zoom)/_p(R),h=K(1,W.center.lat)*R,Z=ut.mat4.identity([]);return ut.mat4.rotateY(Z,Z,ti(W.center.lng)),ut.mat4.rotateX(Z,Z,ti(W.center.lat)),ut.mat4.translate(Z,Z,[0,0,e]),ut.mat4.scale(Z,Z,[I,I,I*h]),ut.mat4.translate(Z,Z,[W.point.x-.5*R,W.point.y-.5*R,0]),ut.mat4.multiply(Z,Z,b),ut.mat4.multiply(Z,W.globeMatrix,Z)}(n,t);return function(b,W,R){let I=(G,N,X)=>{let M=ut.vec3.length(G),S=ut.vec3.length(N),f=Yo(G,N,X);return ut.vec3.scale(f,f,1/ut.vec3.length(f)*Je(M,S,X))},h=I([b[0],b[1],b[2]],[W[0],W[1],W[2]],R),Z=I([b[4],b[5],b[6]],[W[4],W[5],W[6]],R),F=I([b[8],b[9],b[10]],[W[8],W[9],W[10]],R),V=Yo([b[12],b[13],b[14]],[W[12],W[13],W[14]],R);return[h[0],h[1],h[2],0,Z[0],Z[1],Z[2],0,F[0],F[1],F[2],0,V[0],V[1],V[2],1]}(c,s,o)}return c}function Ng(n,t,i,o){let c=Ci.projectAabbCorners(o,i),s=Number.MAX_VALUE,b=-1;for(let I=0;I<c.length;++I){let h=c[I];h[0]=(.5*h[0]+.5)*t.width,h[1]=(.5-.5*h[1])*t.height,h[2]<s&&(b=I,s=h[2])}let W=I=>new ee(c[I][0],c[I][1]),R;switch(b){case 0:case 6:R=[W(1),W(5),W(4),W(7),W(3),W(2),W(1)];break;case 1:case 7:R=[W(0),W(4),W(5),W(6),W(2),W(3),W(0)];break;case 3:case 5:R=[W(1),W(0),W(4),W(7),W(6),W(2),W(1)];break;default:R=[W(1),W(5),W(6),W(7),W(3),W(0),W(1)]}if(ie(n,R))return s}let LU=pi([{name:"a_pos_3f",components:3,type:"Float32"}]),zU=pi([{name:"a_color_3f",components:3,type:"Float32"}]),wU=pi([{name:"a_color_4f",components:4,type:"Float32"}]),AU=pi([{name:"a_uv_2f",components:2,type:"Float32"}]),HU=pi([{name:"a_normal_3f",components:3,type:"Float32"}]),jU=pi([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),OU=pi([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),Yg={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class F0{constructor(t,i,o,c){this.message=(t?`${t}: `:"")+o,c&&(this.identifier=c),i!=null&&i.__line__&&(this.line=i.__line__)}}function Jg(n,t){let i=n.indexOf("://")===-1;try{return new URL(n,i&&t?"http://example.com":void 0),!0}catch{return!1}}class Xg{constructor(t,i){this.feature=t,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class yg{constructor(){this.instancedDataArray=new Fr,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class SW{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=t.projection,this.index=t.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(t,i){}populate(t,i,o,c){this.tileToMeter=ht(o);let s=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(let{feature:b,id:W,index:R,sourceLayerIndex:I}of t){let h=W??(b.properties&&b.properties.hasOwnProperty("id")?b.properties.id:void 0),Z=qt(b,s);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),Z,o))continue;let F={id:h,sourceLayerIndex:I,index:R,geometry:s?Z.geometry:_t(b,o,c),properties:b.properties,type:b.type,patterns:{}},V=this.addFeature(F,F.geometry,Z);V&&i.featureIndex.insert(b,F.geometry,R,I,this.index,this.instancesPerModel[V].instancedDataArray.length,ne/32)}this.lookup=null}update(t,i,o,c){for(let s in this.instancesPerModel){let b=this.instancesPerModel[s];for(let W in t)b.idToFeaturesIndex.hasOwnProperty(W)&&(this.evaluate(b.features[b.idToFeaturesIndex[W]],t[W],b,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let t=!1;for(let i in this.instancesPerModel){let o=this.instancesPerModel[i];for(let c of o.features){let s=this.layers[0],b=c.feature,W=this.canonical,R=s.paint.get("model-rotation").evaluate(b,{},W),I=s.paint.get("model-scale").evaluate(b,{},W),h=s.paint.get("model-translation").evaluate(b,{},W);ut.vec3.exactEquals(c.rotation,R)&&ut.vec3.exactEquals(c.scale,I)&&ut.vec3.exactEquals(c.translation,h)||(this.evaluate(c,c.featureStates,o,!0),t=!0)}}return t}updateReplacement(t,i,o,c){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;let s=i.getReplacementRegionsForTile(t.toUnwrapped(),!0);if(rW(this.activeReplacements,s))return!1;this.activeReplacements=s;let b=!1;for(let W in this.instancesPerModel){let R=this.instancesPerModel[W],I=R.instancedDataArray;for(let h of R.features){let Z=h.instancedDataOffset,F=h.instancedDataCount;for(let V=0;V<F;V++){let G=16*(V+Z),N=I.float32[G+0],X=N>ne;N=X?N-ne:N;let M=Math.floor(N),S=I.float32[G+1],f=!1;for(let T of this.activeReplacements)if(!Hu(T,o,Yg.Model,c)&&!(T.min.x>M||M>T.max.x||T.min.y>S||S>T.max.y)&&(f=Ku(Pu(M,S,t.canonical,T.footprintTileId.canonical),T.footprint),f))break;I.float32[G]=f?N+ne:N,b=b||f!==X}}}return b}isEmpty(){for(let t in this.instancesPerModel)if(this.instancesPerModel[t].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(t){if(!this.uploaded)for(let i in this.instancesPerModel){let o=this.instancesPerModel[i];o.instancedDataArray.length<0||o.instancedDataArray.length===0||(o.instancedDataBuffer?o.instancedDataBuffer.updateData(o.instancedDataArray):o.instancedDataBuffer=t.createVertexBuffer(o.instancedDataArray,jU.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let i in this.instancesPerModel){let o=this.instancesPerModel[i];o.instancedDataArray.length!==0&&o.instancedDataBuffer&&o.instancedDataBuffer.destroy()}let t=this.layers[0].modelManager;if(t&&this.modelUris)for(let i of this.modelUris)t.removeModel(i,"")}addFeature(t,i,o){let c=this.layers[0],s=c.layout.get("model-id").evaluate(o,{},this.canonical);if(!s)return mi(`modelId is not evaluated for layer ${c.id} and it is not going to get rendered.`),s;Jg(s,!1)&&(this.modelUris.includes(s)||this.modelUris.push(s)),this.instancesPerModel[s]||(this.instancesPerModel[s]=new yg);let b=this.instancesPerModel[s],W=b.instancedDataArray,R=new Xg(o,W.length);for(let I of i)for(let h of I){if(h.x<0||h.x>=ne||h.y<0||h.y>=ne)continue;let Z=(this.lookupDim-1)/ne,F=this.lookupDim*(h.y*Z|0)+h.x*Z|0;if(this.lookup){if(this.lookup[F]!==0)continue;this.lookup[F]=1}this.instanceCount++;let V=W.length;W.resize(V+1),b.instancesEvaluatedElevation.push(0),W.float32[16*V]=h.x,W.float32[16*V+1]=h.y}return R.instancedDataCount=b.instancedDataArray.length-R.instancedDataOffset,R.instancedDataCount>0&&(t.id&&(b.idToFeaturesIndex[t.id]=b.features.length),b.features.push(R),this.evaluate(R,{},b,!1)),s}getModelUris(){return this.modelUris}evaluate(t,i,o,c){let s=this.layers[0],b=t.feature,W=this.canonical,R=t.rotation=s.paint.get("model-rotation").evaluate(b,i,W),I=t.scale=s.paint.get("model-scale").evaluate(b,i,W),h=t.translation=s.paint.get("model-translation").evaluate(b,i,W),Z=s.paint.get("model-color").evaluate(b,i,W);Z.a=s.paint.get("model-color-mix-intensity").evaluate(b,i,W);let F=[];this.maxVerticalOffset<h[2]&&(this.maxVerticalOffset=h[2]),this.maxScale=Math.max(Math.max(this.maxScale,I[0]),Math.max(I[1],I[2])),xg(F,R,I);let V=Math.round(100*Z.a)+Z.b/1.05;for(let G=0;G<t.instancedDataCount;++G){let N=t.instancedDataOffset+G,X=16*N,M=o.instancedDataArray.float32,S=0;c&&(S=M[X+6]-o.instancesEvaluatedElevation[N]);let f=0|M[X+1];M[X]=(0|M[X])+Z.r/1.05,M[X+1]=f+Z.g/1.05,M[X+2]=V,M[X+3]=1/(W.z>10?this.tileToMeter:ht(W,f)),M[X+4]=h[0],M[X+5]=h[1],M[X+6]=h[2]+S,M[X+7]=F[0],M[X+8]=F[1],M[X+9]=F[2],M[X+10]=F[4],M[X+11]=F[5],M[X+12]=F[6],M[X+13]=F[8],M[X+14]=F[9],M[X+15]=F[10],o.instancesEvaluatedElevation[N]=h[2]}}}let Bg,Mg;he(SW,"ModelBucket",{omit:["layers"]}),he(yg,"PerModelAttributes"),he(Xg,"ModelFeature");let Xr=64,sc={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Tg(n,t,i,o,c,s,b,W,R,I=!1){let h=i.zoom,Z=i.project(o),F=gt(o.lat,h),V=1/F;ut.mat4.identity(n),ut.mat4.translate(n,n,[Z.x+b[0]*V,Z.y+b[1]*V,b[2]]);let G=1,N=1,X=i.worldSize;if(I){if(i.projection.name==="mercator"){let T=0;i.elevation&&(T=i.elevation.getAtPointOrZero(new Nt(Z.x/X,Z.y/X),0));let v=ut.vec4.transformMat4([],[Z.x,Z.y,T,1],i.projMatrix)[3]/i.cameraToCenterDistance;G=v,N=v*gt(i.center.lat,h)}else if(i.projection.name==="globe"){let T=kW(n,i),v=ut.mat4.multiply([],i.projMatrix,T),L=[0,0,0,1];ut.vec4.transformMat4(L,L,v);let D=L[3]/i.cameraToCenterDistance,q=Fs(h),tt=i.projection.pixelsPerMeter(o.lat,X)*gt(o.lat,h),P=i.projection.pixelsPerMeter(i.center.lat,X)*gt(i.center.lat,h);G=D/Je(tt,bt(i.center.lat),q),N=D*F/tt,G*=P,N*=P}}else G=V;ut.mat4.scale(n,n,[G,G,N]);let M=[...n],S=t.orientation,f=[];if(xg(f,[S[0]+c[0],S[1]+c[1],S[2]+c[2]],s),ut.mat4.multiply(n,M,f),W&&i.elevation){let T=0,v=[];if(R&&i.elevation){T=function(q,tt,P,st,it){let dt=tt.elevation;if(!dt)return 0;let Zt=Ci.projectAabbCorners(P,st),Vt=K(1,it.lat)*tt.worldSize,Rt=function(xe,oe){let me=[0,0,1],Ce=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let Ke of Ce){let Ae=xe[Ke.corners[0]],He=xe[Ke.corners[1]],$e=xe[Ke.corners[2]],ei=[He[0]-Ae[0],He[1]-Ae[1],oe*(He[2]-Ae[2])],yi=ut.vec3.cross(ei,ei,[$e[0]-Ae[0],$e[1]-Ae[1],oe*($e[2]-Ae[2])]);ut.vec3.normalize(yi,yi),Ke.dotProductWithUp=ut.vec3.dot(yi,me)}return Ce.sort((Ke,Ae)=>Ke.dotProductWithUp-Ae.dotProductWithUp),Ce[0].corners}(Zt,Vt),Ft=Zt[Rt[0]],yt=Zt[Rt[1]],xt=Zt[Rt[2]],ft=Zt[Rt[3]],At=dt.getAtPointOrZero(new Nt(Ft[0]/tt.worldSize,Ft[1]/tt.worldSize),0),Ct=dt.getAtPointOrZero(new Nt(yt[0]/tt.worldSize,yt[1]/tt.worldSize),0),se=dt.getAtPointOrZero(new Nt(xt[0]/tt.worldSize,xt[1]/tt.worldSize),0),ae=dt.getAtPointOrZero(new Nt(ft[0]/tt.worldSize,ft[1]/tt.worldSize),0),Pt=(At+ae)/2,jt=(Ct+se)/2;return Pt>jt?Ct<se?G0(q,yt,ft,Ft,Ct,ae,At,Vt):G0(q,xt,Ft,ft,se,At,ae,Vt):At<ae?G0(q,Ft,yt,xt,At,Ct,se,Vt):G0(q,ft,xt,yt,ae,se,Ct,Vt),Math.max(Pt,jt)}(v,i,t.aabb,n,o);let L=ut.mat4.fromQuat([],v),D=ut.mat4.multiply([],L,f);ut.mat4.multiply(n,M,D)}else T=i.elevation.getAtPointOrZero(new Nt(Z.x/X,Z.y/X),0);T!==0&&(n[14]+=T)}}function rm(n,t,i=!1){n.uploaded||(n.gfxTexture=new MW(t,n.image,i?t.gl.R8:t.gl.RGBA8,{useMipmap:n.sampler.minFilter>=t.gl.NEAREST_MIPMAP_NEAREST}),n.uploaded=!0,n.image=null)}function DU(n,t,i){n.indexBuffer=t.createIndexBuffer(n.indexArray,!1,!0),n.vertexBuffer=t.createVertexBuffer(n.vertexArray,LU.members,!1,!0),n.normalArray&&(n.normalBuffer=t.createVertexBuffer(n.normalArray,HU.members,!1,!0)),n.texcoordArray&&(n.texcoordBuffer=t.createVertexBuffer(n.texcoordArray,AU.members,!1,!0)),n.colorArray&&(n.colorBuffer=t.createVertexBuffer(n.colorArray,(n.colorArray.bytesPerElement===12?zU:wU).members,!1,!0)),n.featureArray&&(n.pbrBuffer=t.createVertexBuffer(n.featureArray,OU.members,!0)),n.segments=Oi.simpleSegment(0,0,n.vertexArray.length,n.indexArray.length);let o=n.material;o.pbrMetallicRoughness.baseColorTexture&&rm(o.pbrMetallicRoughness.baseColorTexture,t),o.pbrMetallicRoughness.metallicRoughnessTexture&&rm(o.pbrMetallicRoughness.metallicRoughnessTexture,t),o.normalTexture&&rm(o.normalTexture,t),o.occlusionTexture&&rm(o.occlusionTexture,t,i),o.emissionTexture&&rm(o.emissionTexture,t)}function QW(n,t,i){if(n.meshes)for(let o of n.meshes)DU(o,t,i);if(n.children)for(let o of n.children)QW(o,t,i)}function I0(n){if(n.meshes)for(let t of n.meshes)t.indexArray.destroy(),t.vertexArray.destroy(),t.colorArray&&t.colorArray.destroy(),t.normalArray&&t.normalArray.destroy(),t.texcoordArray&&t.texcoordArray.destroy(),t.featureArray&&t.featureArray.destroy();if(n.children)for(let t of n.children)I0(t)}function fW(n){if(n.meshes)for(let i of n.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((t=i.material).pbrMetallicRoughness.baseColorTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),t.pbrMetallicRoughness.metallicRoughnessTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),t.normalTexture&&t.normalTexture.gfxTexture&&t.normalTexture.gfxTexture.destroy(),t.emissionTexture&&t.emissionTexture.gfxTexture&&t.emissionTexture.gfxTexture.destroy(),t.occlusionTexture&&t.occlusionTexture.gfxTexture&&t.occlusionTexture.gfxTexture.destroy()));var t;if(n.children)for(let i of n.children)fW(i)}class rc{constructor(t,i,o){this._demTile=t,this._dem=this._demTile.dem,this._scale=i,this._offset=o}static create(t,i,o){let c=o||t.findDEMTileFor(i);if(!c||!c.dem)return;let s=c.dem,b=c.tileID,W=1<<i.canonical.z-b.canonical.z;return new rc(c,s.dim/ne/W,[(i.canonical.x/W-b.canonical.x)*s.dim,(i.canonical.y/W-b.canonical.y)*s.dim])}tileCoordToPixel(t,i){let o=i*this._scale+this._offset[1],c=Math.floor(t*this._scale+this._offset[0]),s=Math.floor(o);return new ee(c,s)}getElevationAt(t,i,o,c){let s=t*this._scale+this._offset[0],b=i*this._scale+this._offset[1],W=Math.floor(s),R=Math.floor(b),I=this._dem;return c=!!c,o?Je(Je(I.get(W,R,c),I.get(W,R+1,c),b-R),Je(I.get(W+1,R,c),I.get(W+1,R+1,c),b-R),s-W):I.get(W,R,c)}getElevationAtPixel(t,i,o){return this._dem.get(t,i,!!o)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*K(1,t)*this._dem.stride}}let vW=new Float32Array(262144),yr=new Uint8Array(262144);function Cg(n){let t=0;if(n.meshes)for(let i of n.meshes)t=Math.max(t,i.aabb.max[2]);if(n.children)for(let i of n.children)t=Math.max(t,Cg(i));return t}function kg(n,t,i){if(n.meshes)for(let o of n.meshes)o.aabb.min[0]!==1/0&&i.insert(t,o.aabb.min[0],o.aabb.min[1],o.aabb.max[0],o.aabb.max[1]);if(n.children)for(let o of n.children)kg(o,t,i)}let Sg=["","wall","door","roof","window","lamp","logo"];class Qg{constructor(t){this.node=t,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:t.id,geometry:[],properties:{height:Cg(t)}},this.aabb=this._getLocalBounds()}_getLocalBounds(){if(!this.node.meshes)return new Ci([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let t=0,i=new Ci([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let o of this.node.meshes)this.node.lightMeshIndex!==t&&(o.transformedAabb=Ci.applyTransformFast(o.aabb,this.node.matrix),i.encapsulate(o.transformedAabb)),t++;this.aabb=i}return this.aabb}}class U0{constructor(t,i,o,c,s,b){this.id=i,this.modelTraits|=sc.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,o&&(this.modelTraits|=sc.HasMapboxMeshFeatures),c&&(this.modelTraits|=sc.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=s,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(let W of t)this.nodesInfo.push(new Qg(W)),kg(W,b.featureIndexArray.length,b.grid),b.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,b.bucketLayerIDs.length-1,0)}updateFootprints(t,i){for(let o of this.getNodesInfo()){let c=o.node;c.footprint&&i.push({footprint:c.footprint,id:t})}}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(t){if(!this.needsUpload)return;let i=this.getNodesInfo();for(let o of i){let c=o.node;this.uploaded?this.updatePbrBuffer(c):QW(c,t,!0)}for(let o of i)I0(o.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(t){let i=!1;if(!t.meshes)return i;for(let o of t.meshes)o.pbrBuffer&&(o.pbrBuffer.updateData(o.featureArray),i=!0);return i}needsReEvaluation(t,i,o){let c=t.transform.projectionOptions,s=t.style.getBrightness(),b=this.brightness!==s;return!!(!this.uploaded||this.dirty||c.name!==this.projection.name||dm(o.paint.get("model-color").value,b)||dm(o.paint.get("model-color-mix-intensity").value,b)||dm(o.paint.get("model-roughness").value,b)||dm(o.paint.get("model-emissive-strength").value,b)||dm(o.paint.get("model-height-based-emissive-strength-multiplier").value,b))&&(this.projection=c,this.brightness=s,!0)}evaluateScale(t,i){if(t.transform.zoom===this.zoom)return;this.zoom=t.transform.zoom;let o=this.getNodesInfo(),c=this.id.canonical;for(let s of o){let b=s.feature;s.evaluatedScale=i.paint.get("model-scale").evaluate(b,{},c)}}evaluate(t){let i=this.getNodesInfo();for(let o of i){if(!o.node.meshes)continue;let c=o.feature,s=o.node.meshes&&o.node.meshes[0].featureData,b=o.evaluatedColor[2],W=o.evaluatedRMEA[2],R=this.id.canonical;if(o.hasTranslucentParts=!1,s){for(let I=0;I<Sg.length;I++){let h=Sg[I];h.length&&(c.properties.part=h);let Z=t.paint.get("model-color").evaluate(c,{},R).toRenderColor(null),F=t.paint.get("model-color-mix-intensity").evaluate(c,{},R);o.evaluatedColor[I]=[Z.r,Z.g,Z.b,F],o.evaluatedRMEA[I][0]=t.paint.get("model-roughness").evaluate(c,{},R),o.evaluatedRMEA[I][2]=t.paint.get("model-emissive-strength").evaluate(c,{},R),o.evaluatedRMEA[I][3]=Z.a,o.emissionHeightBasedParams[I]=t.paint.get("model-height-based-emissive-strength-multiplier").evaluate(c,{},R),!o.hasTranslucentParts&&Z.a<1&&(o.hasTranslucentParts=!0)}delete c.properties.part,PU(o,b!==o.evaluatedColor[2]||W!==o.evaluatedRMEA[2],this.modelTraits)}else o.evaluatedRMEA[0][2]=t.paint.get("model-emissive-strength").evaluate(c,{},R);o.evaluatedScale=t.paint.get("model-scale").evaluate(c,{},R),this.updatePbrBuffer(o.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(t,i,o,c){let s=t.findDEMTileFor(o);if(s&&(s.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(s.dem&&s.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=s.tileID.overscaledZ;let b=rc.create(t,o,s);if(!b)return;this.modelTraits&sc.HasMapboxMeshFeatures&&this.updateDEM(t,b,o,c);for(let W of this.getNodesInfo()){let R=W.node;if(!R.footprint||!R.footprint.vertices||!R.footprint.vertices.length)continue;let I=R.footprint.vertices,h=b.getElevationAt(I[0].x,I[0].y,!0,!0);for(let Z=1;Z<I.length;Z++)h=Math.min(h,b.getElevationAt(I[Z].x,I[Z].y,!0,!0));R.elevation=h}}this.terrainTile=s.tileID.canonical,this.terrainExaggeration=i}}updateDEM(t,i,o,c){let s=i._dem._modifiedForSources[c];if(s===void 0&&(i._dem._modifiedForSources[c]=[],s=i._dem._modifiedForSources[c]),s.includes(o.canonical))return;let b=i._dem.dim;s.push(o.canonical);let W=!1;for(let R of this.getNodesInfo()){let I=R.node;if(!I.footprint||!I.footprint.grid)continue;let h=I.footprint.grid,Z=i.tileCoordToPixel(h.min.x,h.min.y),F=i.tileCoordToPixel(h.max.x,h.max.y),V=Math.min(Math.min(b-F.y,Z.x),Math.min(Z.y,b-F.x));if(V<0)continue;let G=ze(V,2,5),N=Math.max(0,Z.x-G),X=Math.max(0,Z.y-G),M=Math.min(F.x+G,b-1),S=Math.min(F.y+G,b-1);for(let L=X;L<=S;++L)for(let D=N;D<=M;++D)yr[L*b+D]=255;let f=0,T=0;for(let L=0;L<h.cellsY;++L)for(let D=0;D<h.cellsX;++D){if(!h.cells[L*h.cellsX+D])continue;let q=i.tileCoordToPixel(h.min.x+D/h.xScale,h.min.y+L/h.yScale),tt=i.tileCoordToPixel(h.min.x+(D+1)/h.xScale,h.min.y+(L+1)/h.yScale);for(let P=q.y;P<=Math.min(tt.y+1,b-1);++P)for(let st=q.x;st<=Math.min(tt.x+1,b-1);++st)yr[P*b+st]===255&&(yr[P*b+st]=0,f+=i.getElevationAtPixel(st,P),T++)}let v=f/T;N=Math.max(1,Z.x-G),X=Math.max(1,Z.y-G),M=Math.min(F.x+G,b-2),S=Math.min(F.y+G,b-2),W=!0;for(let L=X;L<=S;++L)for(let D=N;D<=M;++D)yr[L*b+D]===0&&(vW[L*b+D]=i._dem.set(D,L,v));for(let L=1;L<G;++L){N=Math.max(1,Z.x-L),X=Math.max(1,Z.y-L),M=Math.min(F.x+L,b-2),S=Math.min(F.y+L,b-2);for(let D=X;D<=S;++D)for(let q=N;q<=M;++q){let tt=D*b+q;if(yr[tt]===255){let P=0,st=0,it=-1,dt=-1;for(let Zt=-1;Zt<=1;++Zt)for(let Vt=-1;Vt<=1;++Vt){let Rt=(D+Zt)*b+q+Vt;if(yr[Rt]>=L)continue;let Ft=vW[Rt],yt=Math.abs(Ft);yt>st&&(P=Ft,st=yt,it=Vt,dt=Zt)}if(st>.1){let Zt=1-(L+.5*Math.abs(it*dt))/G,Vt=i._dem.get(q,D)+P*Zt,Rt=i._dem.get(q+it,D+dt),Ft=i._dem.get(q-it,D-dt,!0);(Vt-Rt)*(Vt-Ft)>0&&(Vt=(Rt+Ft)/2),vW[tt]=i._dem.set(q,D,Vt),yr[tt]=L}}}}}W&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=ce.now())}getNodesInfo(){return this.nodesInfo}destroy(){let t=this.getNodesInfo();for(let i of t)I0(i.node),fW(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(t,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;let o=i.getReplacementRegionsForTile(t.toUnwrapped()),c=this.getNodesInfo();for(let s=0;s<this.nodesInfo.length;s++){let b=c[s].node;c[s].hiddenByReplacement=!!b.footprint&&!o.find(W=>W.footprint===b.footprint)}}getHeightAtTileCoord(t,i){let o=this.getNodesInfo(),c=[],s=[0,0,0],b=ut.mat4.identity([]);for(let W=0;W<this.nodesInfo.length;W++){let R=o[W],I=R.node.meshes[0],h=I.transformedAabb;if(t<h.min[0]||i<h.min[1]||t>h.max[0]||i>h.max[1])continue;if(R.node.hidden===!0)return{height:1/0,maxHeight:R.feature.properties.height,hidden:!1,verticalScale:R.evaluatedScale[2]};ut.mat4.invert(b,R.node.matrix),s[0]=t,s[1]=i,ut.vec3.transformMat4(s,s,b);let Z=(s[0]-I.aabb.min[0])/(I.aabb.max[0]-I.aabb.min[0])*Xr|0,F=Math.min(63,(s[1]-I.aabb.min[1])/(I.aabb.max[1]-I.aabb.min[1])*Xr|0)*Xr+Math.min(63,Z),V=I.heightmap[F];if(!(V<0&&R.node.footprint))return R.hiddenByReplacement?void 0:{height:V,maxHeight:R.feature.properties.height,hidden:!1,verticalScale:R.evaluatedScale[2]};if(R.node.footprint.grid.query(new ee(t,i),new ee(t,i),c),c.length>0)return{height:void 0,maxHeight:R.feature.properties.height,hidden:R.hiddenByReplacement,verticalScale:R.evaluatedScale[2]}}}}function dm(n,t){return!n.isLightConstant&&t}function _U(n,t,i,o,c,s,b,W){let R=(61440&t|(61440&t)>>4)>>8,I=(3840&t|(3840&t)>>4)>>4,h=240&t|(240&t)>>4;i[3]>0&&(R=Je(R,255*i[0],i[3]),I=Je(I,255*i[1],i[3]),h=Je(h,255*i[2],i[3]));let Z=R<<8|I,F=h<<8|Math.floor(255*o[3]),V=function(L){let D=ze(L,0,2);return Math.min(Math.round(.5*D*255),255)}(o[2])<<8|15*o[0]<<4|15*o[1],G=ze(c[0],0,1),N=ze(c[1],0,1),X=ze(c[2],0,1),M=ze(c[3],0,1),S,f,T,v;if(G!==N&&b!==s&&N!==G){let L=b-s;f=1/(L*(N-G)),T=-(s+L*G)/(L*(N-G));let D=ze(c[4],-1,1);v=Math.pow(10,D),S=255*X<<8|255*M}else S=65535,f=0,T=1,v=1;if(n.emplaceBack(Z,F,V,S,f,T,v),W){let L=W.length;W.clear();for(let D=0;D<L;D++)W.emplaceBack(Z,F,V,S,f,T,v)}}function PU(n,t,i){let o=n.node,c=0,s=i&sc.HasMeshoptCompression;for(let b of o.meshes){if(o.lights&&o.lightMeshIndex===c||!b.featureData)continue;b.featureArray=new jd,b.featureArray.reserve(b.featureData.length);let W=t;for(let R of b.featureData){let I=s?65535&R:R>>16&65535,h=s?R>>16&65535:65535&R,Z=(15&h)<8?15&h:0,F=n.evaluatedRMEA[Z],V=n.evaluatedColor[Z],G=n.emissionHeightBasedParams[Z],N;if(W&&Z===2&&o.lights&&(N=new jd,N.resize(10*o.lights.length)),_U(b.featureArray,I,V,F,G,b.aabb.min[2],b.aabb.max[2],N),N&&W){W=!1;let X=o.meshes[o.lightMeshIndex];X.featureArray=N,X.featureArray._trim()}}b.featureArray._trim(),c++}}function fg(n,t,i,o){let c=1<<n.z;t.lat=at((o/ne+n.y)/c),t.lng=nt((i/ne+n.x)/c)}he(U0,"Tiled3dModelBucket",{omit:["layers"]}),he(Qg,"Tiled3dModelFeature");let KU={circle:class extends za{constructor(n,t,i,o){super(n,{layout:Gi||(Gi=new Ei({"circle-sort-key":new Ie(Xt.layout_circle["circle-sort-key"]),visibility:new te(Xt.layout_circle.visibility)})),paint:Di||(Di=new Ei({"circle-radius":new Ie(Xt.paint_circle["circle-radius"]),"circle-color":new Ie(Xt.paint_circle["circle-color"]),"circle-blur":new Ie(Xt.paint_circle["circle-blur"]),"circle-opacity":new Ie(Xt.paint_circle["circle-opacity"]),"circle-translate":new te(Xt.paint_circle["circle-translate"]),"circle-translate-anchor":new te(Xt.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new te(Xt.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new te(Xt.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ie(Xt.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ie(Xt.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ie(Xt.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new te(Xt.paint_circle["circle-emissive-strength"])}))},t,i,o)}createBucket(n){return new Ue(n)}queryRadius(n){let t=n;return Li("circle-radius",this,t)+Li("circle-stroke-width",this,t)+Ni(this.paint.get("circle-translate"))}queryIntersectsFeature(n,t,i,o,c,s,b,W){let R=Wi(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),s.angle,n.pixelToTileUnitsFactor),I=this.paint.get("circle-radius").evaluate(t,i)+this.paint.get("circle-stroke-width").evaluate(t,i);return uu(n,o,s,b,W,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",R,I)}getProgramIds(){return["circle"]}getDefaultProgramParams(n,t,i){let o=Wu(this);return{config:new xo(this,{zoom:t,lut:i}),defines:o,overrideFog:!1}}},heatmap:class extends za{createBucket(n){return new gu(n)}constructor(n,t,i,o){super(n,{layout:Vu||(Vu=new Ei({visibility:new te(Xt.layout_heatmap.visibility)})),paint:Ru||(Ru=new Ei({"heatmap-radius":new Ie(Xt.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ie(Xt.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new te(Xt.paint_heatmap["heatmap-intensity"]),"heatmap-color":new _n(Xt.paint_heatmap["heatmap-color"]),"heatmap-opacity":new te(Xt.paint_heatmap["heatmap-opacity"])}))},t,i,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=zb({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(n){return Li("heatmap-radius",this,n)}queryIntersectsFeature(n,t,i,o,c,s,b,W){let R=this.paint.get("heatmap-radius").evaluate(t,i);return uu(n,o,s,b,W,!0,!0,new ee(0,0),R)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(n,t,i){return n==="heatmap"?{config:new xo(this,{zoom:t,lut:i}),overrideFog:!1}:{}}},hillshade:class extends za{constructor(n,t,i,o){super(n,{layout:Gu||(Gu=new Ei({visibility:new te(Xt.layout_hillshade.visibility)})),paint:Fu||(Fu=new Ei({"hillshade-illumination-direction":new te(Xt.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new te(Xt.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new te(Xt.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new te(Xt.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new te(Xt.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new te(Xt.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new te(Xt.paint_hillshade["hillshade-emissive-strength"])}))},t,i,o)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(n,t,i){return{overrideFog:!1}}},fill:class extends za{constructor(n,t,i,o){super(n,{layout:yu||(yu=new Ei({"fill-sort-key":new Ie(Xt.layout_fill["fill-sort-key"]),visibility:new te(Xt.layout_fill.visibility)})),paint:Bu||(Bu=new Ei({"fill-antialias":new te(Xt.paint_fill["fill-antialias"]),"fill-opacity":new Ie(Xt.paint_fill["fill-opacity"]),"fill-color":new Ie(Xt.paint_fill["fill-color"]),"fill-outline-color":new Ie(Xt.paint_fill["fill-outline-color"]),"fill-translate":new te(Xt.paint_fill["fill-translate"]),"fill-translate-anchor":new te(Xt.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ie(Xt.paint_fill["fill-pattern"]),"fill-emissive-strength":new te(Xt.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Ie(Xt.paint_fill["fill-z-offset"])}))},t,i,o)}getProgramIds(){let n=this.paint.get("fill-pattern"),t=n&&n.constantOr(1),i=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(n,t,i){return{config:new xo(this,{zoom:t,lut:i}),overrideFog:!1}}recalculate(n,t){super.recalculate(n,t);let i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(n){return new iW(n)}queryRadius(){return Ni(this.paint.get("fill-translate"))}queryIntersectsFeature(n,t,i,o,c,s){return!n.queryGeometry.isAboveHorizon&&Me(Pe(n.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),s.angle,n.pixelToTileUnitsFactor),o)}isTileClipped(){return!0}is3D(){return this.paint.get("fill-z-offset").constantOr(1)!==0}},"fill-extrusion":class extends za{constructor(n,t,i,o){super(n,{layout:mZ||(mZ=new Ei({visibility:new te(Xt["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new te(Xt["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:hZ||(hZ=new Ei({"fill-extrusion-opacity":new te(Xt["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ie(Xt["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new te(Xt["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new te(Xt["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ie(Xt["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ie(Xt["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ie(Xt["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new te(Xt["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new te(Xt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new te(Xt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new te(Xt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new te(Xt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new te(Xt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new te(Xt["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new te(Xt["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Ie(Xt["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Ie(Xt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new te(Xt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new te(Xt["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new te(Xt["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new te(Xt["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Ie(Xt["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Ie(Xt["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new te(Xt["paint_fill-extrusion"]["fill-extrusion-cast-shadows"])}))},t,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new e0(n)}queryRadius(){return Ni(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(n,t,i,o,c,s,b,W,R){let I=Wi(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),s.angle,n.pixelToTileUnitsFactor),h=this.paint.get("fill-extrusion-height").evaluate(t,i),Z=this.paint.get("fill-extrusion-base").evaluate(t,i),F=[0,0],V=W&&s.elevation,G=s.elevation?s.elevation.exaggeration():1,N=n.tile.getBucket(this);if(V&&N instanceof e0){let T=N.centroidVertexArray,v=R+1;v<T.length&&(F[0]=T.geta_centroid_pos0(v),F[1]=T.geta_centroid_pos1(v))}if(F[0]===0&&F[1]===1)return!1;s.projection.name==="globe"&&(o=bZ([o],[new ee(0,0),new ee(ne,ne)],n.tileID.canonical).map(T=>T.polygon).flat());let X=V?W:null,[M,S]=function(T,v,L,D,q,tt,P,st,it,dt,Zt){return T.projection.name==="globe"?function(Vt,Rt,Ft,yt,xt,ft,At,Ct,se,ae,Pt){let jt=[],xe=[],oe=Vt.projection.upVectorScale(Pt,Vt.center.lat,Vt.worldSize).metersToTile,me=[0,0,0,1],Ce=[0,0,0,1],Ke=(He,$e,ei,yi)=>{He[0]=$e,He[1]=ei,He[2]=yi,He[3]=1},Ae=cZ();Ft>0&&(Ft+=Ae),yt+=Ae;for(let He of Rt){let $e=[],ei=[];for(let yi of He){let Fi=yi.x+xt.x,Se=yi.y+xt.y,ui=Vt.projection.projectTilePoint(Fi,Se,Pt),gi=Vt.projection.upVector(Pt,yi.x,yi.y),Qi=Ft,qi=yt;if(At){let oa=WZ(Fi,Se,Ft,yt,At,Ct,se,ae);Qi+=oa.base,qi+=oa.top}Ft!==0?Ke(me,ui.x+gi[0]*oe*Qi,ui.y+gi[1]*oe*Qi,ui.z+gi[2]*oe*Qi):Ke(me,ui.x,ui.y,ui.z),Ke(Ce,ui.x+gi[0]*oe*qi,ui.y+gi[1]*oe*qi,ui.z+gi[2]*oe*qi),ut.vec3.transformMat4(me,me,ft),ut.vec3.transformMat4(Ce,Ce,ft),$e.push(new Jr(me[0],me[1],me[2])),ei.push(new Jr(Ce[0],Ce[1],Ce[2]))}jt.push($e),xe.push(ei)}return[jt,xe]}(T,v,L,D,q,tt,P,st,it,dt,Zt):P?function(Vt,Rt,Ft,yt,xt,ft,At,Ct,se){let ae=[],Pt=[],jt=[0,0,0,1];for(let xe of Vt){let oe=[],me=[];for(let Ce of xe){let Ke=Ce.x+yt.x,Ae=Ce.y+yt.y,He=WZ(Ke,Ae,Rt,Ft,ft,At,Ct,se);jt[0]=Ke,jt[1]=Ae,jt[2]=He.base,jt[3]=1,ut.vec4.transformMat4(jt,jt,xt),jt[3]=Math.max(jt[3],1e-5);let $e=new Jr(jt[0]/jt[3],jt[1]/jt[3],jt[2]/jt[3]);jt[0]=Ke,jt[1]=Ae,jt[2]=He.top,jt[3]=1,ut.vec4.transformMat4(jt,jt,xt),jt[3]=Math.max(jt[3],1e-5);let ei=new Jr(jt[0]/jt[3],jt[1]/jt[3],jt[2]/jt[3]);oe.push($e),me.push(ei)}ae.push(oe),Pt.push(me)}return[ae,Pt]}(v,L,D,q,tt,P,st,it,dt):function(Vt,Rt,Ft,yt,xt){let ft=[],At=[],Ct=xt[8]*Rt,se=xt[9]*Rt,ae=xt[10]*Rt,Pt=xt[11]*Rt,jt=xt[8]*Ft,xe=xt[9]*Ft,oe=xt[10]*Ft,me=xt[11]*Ft;for(let Ce of Vt){let Ke=[],Ae=[];for(let He of Ce){let $e=He.x+yt.x,ei=He.y+yt.y,yi=xt[0]*$e+xt[4]*ei+xt[12],Fi=xt[1]*$e+xt[5]*ei+xt[13],Se=xt[2]*$e+xt[6]*ei+xt[14],ui=xt[3]*$e+xt[7]*ei+xt[15],gi=yi+Ct,Qi=Fi+se,qi=Se+ae,oa=Math.max(ui+Pt,1e-5),$i=yi+jt,Hi=Fi+xe,Ua=Se+oe,da=Math.max(ui+me,1e-5);Ke.push(new Jr(gi/oa,Qi/oa,qi/oa)),Ae.push(new Jr($i/da,Hi/da,Ua/da))}ft.push(Ke),At.push(Ae)}return[ft,At]}(v,L,D,q,tt)}(s,o,Z,h,I,b,X,F,G,s.center.lat,n.tileID.canonical),f=n.queryGeometry;return function(T,v,L){let D=1/0;Me(L,v)&&(D=pZ(L,v[0]));for(let q=0;q<v.length;q++){let tt=v[q],P=T[q];for(let st=0;st<tt.length-1;st++){let it=tt[st],dt=[it,tt[st+1],P[st+1],P[st],it];ie(L,dt)&&(D=Math.min(D,pZ(L,dt)))}}return D!==1/0&&D}(M,S,f.isPointQuery()?f.screenBounds:f.screenGeometry)}},line:class extends za{constructor(n,t,i,o){let c=xZ();super(n,c,t,i,o),c.layout&&(this.layout=new bs(c.layout)),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(n){if(n==="line-gradient"){let t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof or,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(n,t){super.recalculate(n,t),this.paint._values["line-floorwidth"]=(()=>{if(Kb)return Kb;let i=xZ();return Kb=new tU(i.paint.properties["line-width"].specification),Kb.useIntegerZoom=!0,Kb})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,n)}createBucket(n){return new mW(n)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(n,t,i){let o=IZ(this);return{config:new xo(this,{zoom:t,lut:i}),defines:o,overrideFog:!1}}queryRadius(n){let t=n,i=NZ(Li("line-width",this,t),Li("line-gap-width",this,t)),o=Li("line-offset",this,t);return i/2+Math.abs(o)+Ni(this.paint.get("line-translate"))}queryIntersectsFeature(n,t,i,o,c,s){if(n.queryGeometry.isAboveHorizon)return!1;let b=Pe(n.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),s.angle,n.pixelToTileUnitsFactor),W=n.pixelToTileUnitsFactor/2*NZ(this.paint.get("line-width").evaluate(t,i),this.paint.get("line-gap-width").evaluate(t,i)),R=this.paint.get("line-offset").evaluate(t,i);return R&&(o=function(I,h){let Z=[],F=new ee(0,0);for(let V=0;V<I.length;V++){let G=I[V],N=[];for(let X=0;X<G.length;X++){let M=G[X],S=G[X+1],f=X===0?F:M.sub(G[X-1])._unit()._perp(),T=X===G.length-1?F:S.sub(M)._unit()._perp(),v=f._add(T)._unit();v._mult(1/(v.x*T.x+v.y*T.y)),N.push(v._mult(h)._add(M))}Z.push(N)}return Z}(o,R*n.pixelToTileUnitsFactor)),function(I,h,Z){for(let F=0;F<h.length;F++){let V=h[F];if(I.length>=3){for(let G=0;G<V.length;G++)if(Si(I,V[G]))return!0}if(ge(I,V,Z))return!0}return!1}(b,o,W)}isTileClipped(){return!0}isDraped(n){let t=this.layout.get("line-z-offset");return t.isConstant()&&!t.constantOr(0)}},symbol:u0,background:class extends za{constructor(n,t,i,o){super(n,{layout:dg||(dg=new Ei({visibility:new te(Xt.layout_background.visibility)})),paint:cg||(cg=new Ei({"background-pitch-alignment":new te(Xt.paint_background["background-pitch-alignment"]),"background-color":new te(Xt.paint_background["background-color"]),"background-pattern":new te(Xt.paint_background["background-pattern"]),"background-opacity":new te(Xt.paint_background["background-opacity"]),"background-emissive-strength":new te(Xt.paint_background["background-emissive-strength"])}))},t,i,o)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(n,t,i){return{overrideFog:!1}}is3D(){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:Wg,"raster-particle":Gg,sky:class extends za{constructor(n,t,i,o){super(n,{layout:gg||(gg=new Ei({visibility:new te(Xt.layout_sky.visibility)})),paint:Vg||(Vg=new Ei({"sky-type":new te(Xt.paint_sky["sky-type"]),"sky-atmosphere-sun":new te(Xt.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new te(Xt.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new te(Xt.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new te(Xt.paint_sky["sky-gradient-radius"]),"sky-gradient":new _n(Xt.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new te(Xt.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new te(Xt.paint_sky["sky-atmosphere-color"]),"sky-opacity":new te(Xt.paint_sky["sky-opacity"])}))},t,i,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="sky-gradient"?this._updateColorRamp():n!=="sky-atmosphere-sun"&&n!=="sky-atmosphere-halo-color"&&n!=="sky-atmosphere-color"&&n!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=zb({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(n){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let t=n.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(n,t){if(this.paint.get("sky-type")==="atmosphere"){let o=this.paint.get("sky-atmosphere-sun"),c=!o,s=n.style.light,b=s.properties.get("position");return c&&s.properties.get("anchor")==="viewport"&&mi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),c?TW(b.azimuthal,90-b.polar,t):TW(o[0],90-o[1],t)}let i=this.paint.get("sky-gradient-center");return TW(i[0],90-i[1],t)}isSky(){return!0}markSkyboxValid(n){this._skyboxInvalidated=!1,this._lightPosition=n.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let n=this.paint.get("sky-type");return n==="atmosphere"?["skyboxCapture","skybox"]:n==="gradient"?["skyboxGradient"]:null}},slot:class extends za{constructor(n,t,i,o){super(n,{paint:Rg||(Rg=new Ei({}))},t,null)}},model:class extends za{constructor(n,t,i,o){super(n,{layout:Bg||(Bg=new Ei({visibility:new te(Xt.layout_model.visibility),"model-id":new Ie(Xt.layout_model["model-id"])})),paint:Mg||(Mg=new Ei({"model-opacity":new te(Xt.paint_model["model-opacity"]),"model-rotation":new Ie(Xt.paint_model["model-rotation"]),"model-scale":new Ie(Xt.paint_model["model-scale"]),"model-translation":new Ie(Xt.paint_model["model-translation"]),"model-color":new Ie(Xt.paint_model["model-color"]),"model-color-mix-intensity":new Ie(Xt.paint_model["model-color-mix-intensity"]),"model-type":new te(Xt.paint_model["model-type"]),"model-cast-shadows":new te(Xt.paint_model["model-cast-shadows"]),"model-receive-shadows":new te(Xt.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new te(Xt.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Ie(Xt.paint_model["model-emissive-strength"]),"model-roughness":new Ie(Xt.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Ie(Xt.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new te(Xt.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new te(Xt.paint_model["model-front-cutoff"])}))},t,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new SW(n)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(n){return n instanceof U0?ne-1:0}queryIntersectsFeature(n,t,i,o,c,s){if(!this.modelManager)return!1;let b=this.modelManager,W=n.tile.getBucket(this);if(!(W&&W instanceof SW))return!1;let R=W;for(let I in R.instancesPerModel){let h=R.instancesPerModel[I],Z=t.id!==void 0?t.id:t.properties&&t.properties.hasOwnProperty("id")?t.properties.id:void 0;if(h.idToFeaturesIndex.hasOwnProperty(Z)){let F=h.features[h.idToFeaturesIndex[Z]],V=b.getModel(I,this.scope);if(!V)return!1;let G=ut.mat4.create(),N=new Q(0,0),X=R.canonical,M=Number.MAX_VALUE;for(let S=0;S<F.instancedDataCount;++S){let f=16*(F.instancedDataOffset+S),T=h.instancedDataArray.float32,v=[T[f+4],T[f+5],T[f+6]];fg(X,N,T[f],0|T[f+1]),Tg(G,V,s,N,F.rotation,F.scale,v,!1,!1,!1),s.projection.name==="globe"&&(G=kW(G,s));let L=ut.mat4.multiply([],s.projMatrix,G),D=n.queryGeometry,q=Ng(D.isPointQuery()?D.screenBounds:D.screenGeometry,s,L,V.aabb);q!=null&&(M=Math.min(q,M))}return M!==Number.MAX_VALUE&&M}}return!1}_handleOverridablePaintPropertyUpdate(n,t,i){return!(!this.layout||t.isDataDriven()||i.isDataDriven()||n!=="model-color"&&n!=="model-color-mix-intensity"&&n!=="model-rotation"&&n!=="model-scale"&&n!=="model-translation"&&n!=="model-emissive-strength")}_isPropertyZoomDependent(n){let t=this._transitionablePaint._values[n];return t!=null&&t.value!=null&&t.value.expression!=null&&t.value.expression instanceof dl}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}queryIntersectsMatchingFeature(n,t,i,o){let c=n.tile,s=c.getBucket(this),b=null,W=Number.MAX_VALUE;if(!(s&&s instanceof U0))return{queryFeature:b,intersectionZ:W};let R=s.getNodesInfo()[t];if(R.hiddenByReplacement||!R.node.meshes||!i.filter(new ji(c.tileID.overscaledZ),R.feature,c.tileID.canonical))return{queryFeature:b,intersectionZ:W};let I=R.node,h=o.calculatePosMatrix(c.tileID.toUnwrapped(),o.worldSize),Z=R.evaluatedScale,F=0;o.elevation&&I.elevation&&(F=I.elevation*o.elevation.exaggeration()),ut.mat4.translate(h,h,[(I.anchor?I.anchor[0]:0)*(Z[0]-1),(I.anchor?I.anchor[1]:0)*(Z[1]-1),F]),ut.mat4.scale(h,h,Z),ut.mat4.multiply(h,h,I.matrix);let V=n.queryGeometry,G=V.isPointQuery()?V.screenBounds:V.screenGeometry,N=function(M){let S=ut.mat4.multiply([],h,M.matrix),f=ut.mat4.multiply(S,o.expandedFarZProjMatrix,S);for(let T=0;T<M.meshes.length;++T){let v=M.meshes[T];if(T===M.lightMeshIndex)continue;let L=Ng(G,o,f,v.aabb);L!=null&&(W=Math.min(L,W))}if(M.children)for(let T of M.children)N(T)};if(N(I),W===Number.MAX_VALUE)return{queryFeature:b,intersectionZ:W};let X=new Q(0,0);return fg(c.tileID.canonical,X,R.node.anchor[0],R.node.anchor[1]),b={type:"Feature",geometry:{type:"Point",coordinates:[X.lng,X.lat]},properties:R.feature.properties,id:R.feature.id,state:{},layer:this.serialize()},{queryFeature:b,intersectionZ:W}}},clip:class extends za{constructor(n,t,i,o){super(n,{layout:Mu||(Mu=new Ei({"clip-layer-types":new te(Xt.layout_clip["clip-layer-types"]),"clip-layer-scope":new te(Xt.layout_clip["clip-layer-scope"])})),paint:Tu||(Tu=new Ei({}))},t,i,o)}recalculate(n,t){super.recalculate(n,t)}createBucket(n){return new Cu(n)}isTileClipped(){return!0}is3D(){return!0}}};class qU{constructor(t){this._callback=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class $U{constructor(){this.tasks={},this.taskQueue=[],ko(["process"],this),this.invoker=new qU(this.process),this.nextId=0}add(t,i){let o=this.nextId++,c=function({type:s,isSymbolTile:b,zoom:W}){return W=W||0,s==="message"?0:s!=="maybePrepare"||b?s!=="parseTile"||b?s==="parseTile"&&b?300-W:s==="maybePrepare"&&b?400-W:500:200-W:100-W}(i);if(c===0){try{t()}finally{}return null}return this.tasks[o]={fn:t,metadata:i,priority:c,id:o},this.taskQueue.push(o),this.invoker.trigger(),{cancel:()=>{delete this.tasks[o]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(o=>!!this.tasks[o]),!this.taskQueue.length)return;let t=this.pick();if(t===null)return;let i=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let t=null,i=1/0;for(let c=0;c<this.taskQueue.length;c++){let s=this.tasks[this.taskQueue[c]];s.priority<i&&(i=s.priority,t=c)}if(t===null)return null;let o=this.taskQueue[t];return this.taskQueue.splice(t,1),o}remove(){this.invoker.remove()}}class vg{constructor(t,i,o){this.target=t,this.parent=i,this.mapId=o,this.callbacks={},this.cancelCallbacks={},ko(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new $U}send(t,i,o,c,s=!1,b){let W=Math.round(1e18*Math.random()).toString(36).substring(0,10);o&&(o.metadata=b,this.callbacks[W]=o);let R=new Set;return this.target.postMessage({id:W,type:t,hasCallback:!!o,targetMapId:c,mustQueue:s,sourceMapId:this.mapId,data:on(i,R)},R),{cancel:()=>{o&&delete this.callbacks[W],this.target.postMessage({id:W,type:"<cancel>",targetMapId:c,sourceMapId:this.mapId})}}}receive(t){let i=t.data,o=i.id;if(o&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){let c=this.cancelCallbacks[o];delete this.cancelCallbacks[o],c&&c.cancel()}else if(i.mustQueue||bo()){let c=this.callbacks[o],s=this.scheduler.add(()=>this.processTask(o,i),c&&c.metadata||{type:"message"});s&&(this.cancelCallbacks[o]=s)}else this.processTask(o,i)}processTask(t,i){if(delete this.cancelCallbacks[t],i.type==="<response>"){let o=this.callbacks[t];delete this.callbacks[t],o&&(i.error?o(Ro(i.error)):o(null,Ro(i.data)))}else{let o=new Set,c=i.hasCallback?(b,W)=>{this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:b?on(b):null,data:on(W,o)},o)}:b=>{},s=Ro(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,s,c);else if(this.parent.getWorkerSource){let b=i.type.split(".");this.parent.getWorkerSource(i.sourceMapId,b[0],s.source,s.scope)[b[1]](s,c)}else c(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class dc{constructor(t,i){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=Al();let o=this.workerPool.acquire(this.id);for(let c=0;c<o.length;c++){let s=new dc.Actor(o[c],i,this.id);s.name=`Worker ${c}`,this.actors.push(s)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(t,i,o){al(this.actors,(c,s)=>{c.send(t,i,s)},o=o||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(t=>{t.remove()}),this.actors=[],this.workerPool.release(this.id)}}dc.Actor=vg;class Eg{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,i){let o=this.toIdx(t,i);return{min:this.minimums[o],max:this.maximums[o]}}isLeaf(t,i){return this.leaves[this.toIdx(t,i)]}toIdx(t,i){return i*this.size+t}}function Lg(n,t,i,o){let c=0,s=Number.MAX_VALUE;for(let b=0;b<3;b++)if(Math.abs(o[b])<1e-15){if(i[b]<n[b]||i[b]>t[b])return null}else{let W=1/o[b],R=(n[b]-i[b])*W,I=(t[b]-i[b])*W;if(R>I){let h=R;R=I,I=h}if(R>c&&(c=R),I<s&&(s=I),c>s)return null}return c}function zg(n,t,i,o,c,s,b,W,R,I,h){let Z=o-n,F=c-t,V=s-i,G=b-n,N=W-t,X=R-i,M=h[1]*X-h[2]*N,S=h[2]*G-h[0]*X,f=h[0]*N-h[1]*G,T=Z*M+F*S+V*f;if(Math.abs(T)<1e-15)return null;let v=1/T,L=I[0]-n,D=I[1]-t,q=I[2]-i,tt=(L*M+D*S+q*f)*v;if(tt<0||tt>1)return null;let P=D*V-q*F,st=q*Z-L*V,it=L*F-D*Z,dt=(h[0]*P+h[1]*st+h[2]*it)*v;return dt<0||tt+dt>1?null:(G*P+N*st+X*it)*v}function wg(n,t,i){return(n-t)/(i-t)}function Ag(n,t,i,o,c,s,b,W,R){let I=1<<i,h=s-o,Z=b-c,F=(n+1)/I*h+o,V=(t+0)/I*Z+c,G=(t+1)/I*Z+c;W[0]=(n+0)/I*h+o,W[1]=V,R[0]=F,R[1]=G}class Hg{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let i=function(s){let b=Math.ceil(Math.log2(s.dim/8)),W=[],R=Math.ceil(Math.pow(2,b)),I=1/R,h=(V,G,N,X,M)=>{let S=X?1:0,f=(V+1)*N-S,T=G*N,v=(G+1)*N-S;M[0]=V*N,M[1]=T,M[2]=f,M[3]=v},Z=new Eg(R),F=[];for(let V=0;V<R*R;V++){h(V%R,Math.floor(V/R),I,!1,F);let G=Xs(F[0],F[1],s),N=Xs(F[2],F[1],s),X=Xs(F[2],F[3],s),M=Xs(F[0],F[3],s);Z.minimums.push(Math.min(G,N,X,M)),Z.maximums.push(Math.max(G,N,X,M)),Z.leaves.push(1)}for(W.push(Z),R/=2;R>=1;R/=2){let V=W[W.length-1];Z=new Eg(R);for(let G=0;G<R*R;G++){h(G%R,Math.floor(G/R),2,!0,F);let N=V.getElevation(F[0],F[1]),X=V.getElevation(F[2],F[1]),M=V.getElevation(F[2],F[3]),S=V.getElevation(F[0],F[3]),f=V.isLeaf(F[0],F[1]),T=V.isLeaf(F[2],F[1]),v=V.isLeaf(F[2],F[3]),L=V.isLeaf(F[0],F[3]),D=Math.min(N.min,X.min,M.min,S.min),q=Math.max(N.max,X.max,M.max,S.max),tt=f&&T&&v&&L;Z.maximums.push(q),Z.minimums.push(D),Z.leaves.push(q-D<=5&&tt?1:0)}W.push(Z)}return W}(this.dem),o=i.length-1,c=i[o];this._addNode(c.minimums[0],c.maximums[0],c.leaves[0]),this._construct(i,0,0,o,0)}raycastRoot(t,i,o,c,s,b,W=1){return Lg([t,i,-100],[o,c,this.maximums[0]*W],s,b)}raycast(t,i,o,c,s,b,W=1){if(!this.nodeCount)return null;let R=this.raycastRoot(t,i,o,c,s,b,W);if(R==null)return null;let I=[],h=[],Z=[],F=[],V=[{idx:0,t:R,nodex:0,nodey:0,depth:0}];for(;V.length>0;){let{idx:G,t:N,nodex:X,nodey:M,depth:S}=V.pop();if(this.leaves[G]){Ag(X,M,S,t,i,o,c,Z,F);let T=1<<S,v=(X+0)/T,L=(X+1)/T,D=(M+0)/T,q=(M+1)/T,tt=Xs(v,D,this.dem)*W,P=Xs(L,D,this.dem)*W,st=Xs(L,q,this.dem)*W,it=Xs(v,q,this.dem)*W,dt=zg(Z[0],Z[1],tt,F[0],Z[1],P,F[0],F[1],st,s,b),Zt=zg(F[0],F[1],st,Z[0],F[1],it,Z[0],Z[1],tt,s,b),Vt=Math.min(dt!==null?dt:Number.MAX_VALUE,Zt!==null?Zt:Number.MAX_VALUE);if(Vt!==Number.MAX_VALUE)return Vt;{let Rt=ut.vec3.scaleAndAdd([],s,b,N);if(jg(tt,P,it,st,wg(Rt[0],Z[0],F[0]),wg(Rt[1],Z[1],F[1]))>=Rt[2])return N}continue}let f=0;for(let T=0;T<this._siblingOffset.length;T++){Ag((X<<1)+this._siblingOffset[T][0],(M<<1)+this._siblingOffset[T][1],S+1,t,i,o,c,Z,F),Z[2]=-100,F[2]=this.maximums[this.childOffsets[G]+T]*W;let v=Lg(Z,F,s,b);if(v!=null){let L=v;I[T]=L;let D=!1;for(let q=0;q<f&&!D;q++)L>=I[h[q]]&&(h.splice(q,0,T),D=!0);D||(h[f]=T),f++}}for(let T=0;T<f;T++){let v=h[T];V.push({idx:this.childOffsets[G]+v,t:I[v],nodex:(X<<1)+this._siblingOffset[v][0],nodey:(M<<1)+this._siblingOffset[v][1],depth:S+1})}}return null}_addNode(t,i,o){return this.minimums.push(t),this.maximums.push(i),this.leaves.push(o),this.childOffsets.push(0),this.nodeCount++}_construct(t,i,o,c,s){if(t[c].isLeaf(i,o)===1)return;this.childOffsets[s]||(this.childOffsets[s]=this.nodeCount);let b=c-1,W=t[b],R=0,I=0;for(let h=0;h<this._siblingOffset.length;h++){let Z=2*i+this._siblingOffset[h][0],F=2*o+this._siblingOffset[h][1],V=W.getElevation(Z,F),G=W.isLeaf(Z,F),N=this._addNode(V.min,V.max,G);G&&(R|=1<<h),I||(I=N)}for(let h=0;h<this._siblingOffset.length;h++)R&1<<h||this._construct(t,2*i+this._siblingOffset[h][0],2*o+this._siblingOffset[h][1],b,I+h)}}function jg(n,t,i,o,c,s){return Je(Je(n,i,s),Je(t,o,s),c)}function Xs(n,t,i){let o=i.dim,c=ze(n*o-.5,0,o-1),s=ze(t*o-.5,0,o-1),b=Math.floor(c),W=Math.floor(s),R=Math.min(b+1,o-1),I=Math.min(W+1,o-1);return jg(i.get(b,W),i.get(R,W),i.get(b,I),i.get(R,I),c-b,s-W)}let tx={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function ex(n,t,i){return(256*n*256+256*t+i)/10-1e4}function ix(n,t,i){return 256*n+t+i/256-32768}class x0{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,i,o,c=!1){if(this.uid=t,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(o&&o!=="mapbox"&&o!=="terrarium")return void mi(`"${o}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;let s=this.dim=i.height-2,b=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=c,this._modifiedForSources={},!c){for(let R=0;R<s;R++)b[this._idx(-1,R)]=b[this._idx(0,R)],b[this._idx(s,R)]=b[this._idx(s-1,R)],b[this._idx(R,-1)]=b[this._idx(R,0)],b[this._idx(R,s)]=b[this._idx(R,s-1)];b[this._idx(-1,-1)]=b[this._idx(0,0)],b[this._idx(s,-1)]=b[this._idx(s-1,0)],b[this._idx(-1,s)]=b[this._idx(0,s-1)],b[this._idx(s,s)]=b[this._idx(s-1,s-1)]}let W=o==="terrarium"?ix:ex;for(let R=0;R<b.length;++R){let I=4*R;this.floatView[R]=W(this.pixels[I],this.pixels[I+1],this.pixels[I+2])}this._timestamp=ce.now()}_buildQuadTree(){this._tree=new Hg(this)}get(t,i,o=!1){o&&(t=ze(t,-1,this.dim),i=ze(i,-1,this.dim));let c=this._idx(t,i);return this.floatView[c]}set(t,i,o){let c=this._idx(t,i),s=this.floatView[c];return this.floatView[c]=o,o-s}static getUnpackVector(t){return tx[t]}_idx(t,i){if(t<-1||t>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(t+1)}static pack(t,i){let o=[0,0,0,0],c=x0.getUnpackVector(i),s=Math.floor((t+c[3])/c[2]);return o[2]=s%256,s=Math.floor(s/256),o[1]=s%256,s=Math.floor(s/256),o[0]=s,o}getPixels(){return new xu({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,i,o){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let c=i*this.dim,s=i*this.dim+this.dim,b=o*this.dim,W=o*this.dim+this.dim;switch(i){case-1:c=s-1;break;case 1:s=c+1}switch(o){case-1:b=W-1;break;case 1:W=b+1}let R=-i*this.dim,I=-o*this.dim;for(let h=b;h<W;h++)for(let Z=c;Z<s;Z++){let F=4*this._idx(Z,h),V=4*this._idx(Z+R,h+I);this.pixels[F+0]=t.pixels[V+0],this.pixels[F+1]=t.pixels[V+1],this.pixels[F+2]=t.pixels[V+2],this.pixels[F+3]=t.pixels[V+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function ax(n,t,i){n===1?t.header_length=i.readFixed32():n===2?t.x=i.readVarint():n===3?t.y=i.readVarint():n===4?t.z=i.readVarint():n===5&&t.layers.push(function(o,c){return o.readFields(rx,{version:0,name:"",units:"",tilesize:0,buffer:0,pixel_format:0,data_index:[]},c)}(i,i.readVarint()+i.pos))}function nx(n,t,i){n===1?(t.delta_filter=function(o,c){return o.readFields(lx,{block_size:0},c)}(i,i.readVarint()+i.pos),t.filter="delta_filter"):n===2?(i.readVarint(),t.filter="zigzag_filter"):n===3?(i.readVarint(),t.filter="bitshuffle_filter"):n===4&&(i.readVarint(),t.filter="byteshuffle_filter")}function lx(n,t,i){n===1&&(t.block_size=i.readVarint())}function ox(n,t,i){n===1?(i.readVarint(),t.codec="gzip_data"):n===2?(i.readVarint(),t.codec="jpeg_image"):n===3?(i.readVarint(),t.codec="webp_image"):n===4&&(i.readVarint(),t.codec="png_image")}function sx(n,t,i){n===1?t.first_byte=i.readFixed64():n===2?t.last_byte=i.readFixed64():n===3?t.filters.push(function(o,c){return o.readFields(nx,{},c)}(i,i.readVarint()+i.pos)):n===4?t.codec=function(o,c){return o.readFields(ox,{},c)}(i,i.readVarint()+i.pos):n===5?t.deprecated_offset=i.readFloat():n===6?t.deprecated_scale=i.readFloat():n===7?t.bands.push(i.readString()):n===8?t.offset=i.readDouble():n===9&&(t.scale=i.readDouble())}function rx(n,t,i){n===1?t.version=i.readVarint():n===2?t.name=i.readString():n===3?t.units=i.readString():n===4?t.tilesize=i.readVarint():n===5?t.buffer=i.readVarint():n===6?t.pixel_format=i.readVarint():n===7&&t.data_index.push(function(o,c){return o.readFields(sx,{first_byte:0,last_byte:0,filters:[],codec:null,offset:0,scale:0,deprecated_offset:0,deprecated_scale:0,bands:[]},c)}(i,i.readVarint()+i.pos))}function dx(n,t,i){if(n===2)(function(o,c,s){o.readFields(cx,s,c)})(i,i.readVarint()+i.pos,t);else if(n===3)throw new Error("Not implemented")}function cx(n,t,i){if(n===1){let o=0,c=i.readVarint()+i.pos;for(;i.pos<c;)t[o++]=i.readVarint()}}he(x0,"DEMData"),he(Hg,"DemMinMaxQuadTree",{omit:["dem"]});class bx{constructor(t){this.capacity=t,this.cache=new Map}get(t){if(!this.cache.has(t))return;let i=this.cache.get(t);return this.cache.delete(t),this.cache.set(t,i),i}put(t,i){this.cache.has(t)?this.cache.delete(t):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(t,i)}}function mx(n,t){if(t.length!==4)throw new Error(`Expected data of dimension 4 but got ${t.length}.`);let i=t[3];for(let o=2;o>=1;o--){let c=o===1?1:0,s=o===2?1:0;for(let b=0;b<t[0];b++){let W=t[1]*b;for(let R=c;R<t[1];R++){let I=t[2]*(R+W);for(let h=s;h<t[2];h++){let Z=t[3]*(h+I);for(let F=0;F<t[3];F++){let V=Z+F;n[V]+=n[V-i]}}}}i*=t[o]}return n}function hx(n){for(let t=0,i=n.length;t<i;t++)n[t]=n[t]>>>1^-(1&n[t]);return n}function px(n,t){switch(t){case"uint32":return n;case"uint16":for(let i=0;i<n.length;i+=2){let o=n[i],c=n[i+1];n[i]=(240&o)>>4|(61440&o)>>8|(240&c)<<4|61440&c,n[i+1]=15&o|(3840&o)>>4|(15&c)<<8|(3840&c)<<4}return n;case"uint8":for(let i=0;i<n.length;i+=4){let o=n[i],c=n[i+1],s=n[i+2],b=n[i+3];n[i+0]=(192&o)>>6|(192&c)>>4|(192&s)>>2|192&b,n[i+1]=(48&o)>>4|(48&c)>>2|48&s|(48&b)<<2,n[i+2]=(12&o)>>2|12&c|(12&s)<<2|(12&b)<<4,n[i+3]=3&o|(3&c)<<2|(3&s)<<4|(3&b)<<6}return n;default:throw new Error(`Invalid pixel format, "${t}"`)}}var $n=Uint8Array,cm=Uint16Array,Wx=Int32Array,Og=new $n([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Dg=new $n([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ux=new $n([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),_g=function(n,t){for(var i=new cm(31),o=0;o<31;++o)i[o]=t+=1<<n[o-1];var c=new Wx(i[30]);for(o=1;o<30;++o)for(var s=i[o];s<i[o+1];++s)c[s]=s-i[o]<<5|o;return{b:i,r:c}},Pg=_g(Og,2),Kg=Pg.b,Zx=Pg.r;Kg[28]=258,Zx[258]=28;for(var gx=_g(Dg,0).b,qg=new cm(32768),la=0;la<32768;++la){var cc=(43690&la)>>1|(21845&la)<<1;qg[la]=((65280&(cc=(61680&(cc=(52428&cc)>>2|(13107&cc)<<2))>>4|(3855&cc)<<4))>>8|(255&cc)<<8)>>1}var bm=function(n,t,i){for(var o=n.length,c=0,s=new cm(t);c<o;++c)n[c]&&++s[n[c]-1];var b,W=new cm(t);for(c=1;c<t;++c)W[c]=W[c-1]+s[c-1]<<1;b=new cm(1<<t);var R=15-t;for(c=0;c<o;++c)if(n[c])for(var I=c<<4|n[c],h=t-n[c],Z=W[n[c]-1]++<<h,F=Z|(1<<h)-1;Z<=F;++Z)b[qg[Z]>>R]=I;return b},mm=new $n(288);for(la=0;la<144;++la)mm[la]=8;for(la=144;la<256;++la)mm[la]=9;for(la=256;la<280;++la)mm[la]=7;for(la=280;la<288;++la)mm[la]=8;var $g=new $n(32);for(la=0;la<32;++la)$g[la]=5;var Vx=bm(mm,9),Rx=bm($g,5),EW=function(n){for(var t=n[0],i=1;i<n.length;++i)n[i]>t&&(t=n[i]);return t},fl=function(n,t,i){var o=t/8|0;return(n[o]|n[o+1]<<8)>>(7&t)&i},LW=function(n,t){var i=t/8|0;return(n[i]|n[i+1]<<8|n[i+2]<<16)>>(7&t)},Gx=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],vl=function(n,t,i){var o=new Error(t||Gx[n]);if(o.code=n,Error.captureStackTrace&&Error.captureStackTrace(o,vl),!i)throw o;return o},Fx=new $n(0),Ix=typeof TextDecoder<"u"&&new TextDecoder;try{Ix.decode(Fx,{stream:!0})}catch{}let Ux={gzip_data:"gzip"};class pl extends Error{constructor(t){super(t),this.name="MRTError"}}let xx={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},tV={uint32:1,uint16:2,uint8:4},Nx={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array},zW;class wW{constructor(t=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=t}getLayer(t){let i=this.layers[t];if(!i)throw new pl(`Layer '${t}' not found`);return i}getHeaderLength(t){let i=new Uint8Array(t),o=new DataView(t);if(i[0]!==13)throw new pl("File is not a valid MRT.");return o.getUint32(1,!0)}parseHeader(t){let i=new Uint8Array(t),o=this.getHeaderLength(t);if(i.length<o)throw new pl(`Expected header with length >= ${o} but got buffer of length ${i.length}`);let c=function(s,b){return s.readFields(ax,{header_length:0,x:0,y:0,z:0,layers:[]},void 0)}(new zW(i.subarray(0,o)));if(!isNaN(this.x)&&(this.x!==c.x||this.y!==c.y||this.z!==c.z))throw new pl(`Invalid attempt to parse header ${c.z}/${c.x}/${c.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=c.x,this.y=c.y,this.z=c.z;for(let s of c.layers)this.layers[s.name]=new Yx(s,{cacheSize:this._cacheSize});return this}createDecodingTask(t){let i=[],o=this.getLayer(t.layerName);for(let c of t.blockIndices){let s=o.dataIndex[c],b=s.first_byte-t.firstByte,W=s.last_byte-t.firstByte;if(o._blocksInProgress.has(c))continue;let R={layerName:o.name,firstByte:b,lastByte:W,pixelFormat:o.pixelFormat,blockIndex:c,blockShape:[s.bands.length].concat(o.bandShape),buffer:o.buffer,codec:s.codec.codec,filters:s.filters.map(I=>I.filter)};o._blocksInProgress.add(c),i.push(R)}return new eV(i,()=>{i.forEach(c=>o._blocksInProgress.delete(c.blockIndex))},(c,s)=>{if(i.forEach(b=>o._blocksInProgress.delete(b.blockIndex)),c)throw c;s.forEach(b=>{this.getLayer(b.layerName).processDecodedData(b)})})}}class Yx{constructor({version:t,name:i,units:o,tilesize:c,pixel_format:s,buffer:b,data_index:W},R){if(this.version=t,this.version!==1)throw new pl(`Cannot parse raster layer encoded with MRT version ${t}`);this.name=i,this.units=o,this.tileSize=c,this.buffer=b,this.pixelFormat=xx[s],this.dataIndex=W,this.bandShape=[c+2*b,c+2*b,tV[this.pixelFormat]],this._decodedBlocks=new bx(R?R.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return tV[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:t})=>t).flat()}processDecodedData(t){let i=t.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,t.data)}getBlockForBand(t){let i=0;switch(typeof t){case"string":for(let[o,c]of this.dataIndex.entries()){for(let[s,b]of c.bands.entries())if(b===t)return{bandIndex:i+s,blockIndex:o,blockBandIndex:s};i+=c.bands.length}break;case"number":for(let[o,c]of this.dataIndex.entries()){if(t>=i&&t<i+c.bands.length)return{bandIndex:t,blockIndex:o,blockBandIndex:t-i};i+=c.bands.length}break;default:throw new pl(`Invalid band \`${JSON.stringify(t)}\`. Expected string or integer.`)}throw new pl(`Band not found: ${JSON.stringify(t)}`)}getDataRange(t){let i=1/0,o=-1/0,c=[],s=new Set;for(let b of t){let{blockIndex:W}=this.getBlockForBand(b);if(W<0)throw new pl(`Invalid band: ${JSON.stringify(b)}`);let R=this.dataIndex[W];c.includes(W)||c.push(W),s.add(W),i=Math.min(i,R.first_byte),o=Math.max(o,R.last_byte)}if(s.size>this.cacheSize)throw new pl(`Number of blocks to decode (${s.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:o,blockIndices:c}}hasBand(t){let{blockIndex:i}=this.getBlockForBand(t);return i>=0}hasDataForBand(t){let{blockIndex:i}=this.getBlockForBand(t);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(t){let{blockIndex:i,blockBandIndex:o}=this.getBlockForBand(t),c=this._decodedBlocks.get(i.toString());if(!c)throw new pl(`Data for band ${JSON.stringify(t)} of layer "${this.name}" not decoded.`);let s=this.dataIndex[i],b=this.bandShape.reduce((I,h)=>I*h,1),W=o*b,R=c.subarray(W,W+b);return{data:R,bytes:new Uint8Array(R.buffer).subarray(R.byteOffset,R.byteOffset+R.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:s.offset!==0?s.offset:s.deprecated_offset,scale:s.scale!==0?s.scale:s.deprecated_scale}}}wW.setPbf=function(n){zW=n};class eV{constructor(t,i,o){this.tasks=t,this._onCancel=i,this._onComplete=o,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(t,i){this._finalized||(this._onComplete(t,i),this._finalized=!0)}}wW.performDecoding=function(n,t){let i=new Uint8Array(n);return Promise.all(t.tasks.map(o=>{let{layerName:c,firstByte:s,lastByte:b,pixelFormat:W,blockShape:R,blockIndex:I,filters:h,codec:Z}=o,F=i.subarray(s,b+1),V=new Uint32Array(R[0]*R[1]*R[2]),G;if(Z!=="gzip_data")throw new pl(`Unhandled codec: ${Z}`);return G=function(N,X){if(!globalThis.DecompressionStream&&X==="gzip_data")return Promise.resolve(((T=function(D){D[0]==31&&D[1]==139&&D[2]==8||vl(6,"invalid gzip data");var q=D[3],tt=10;4&q&&(tt+=2+(D[10]|D[11]<<8));for(var P=(q>>3&1)+(q>>4&1);P>0;P-=!D[tt++]);return tt+(2&q)}(f=N))+8>f.length&&vl(6,"invalid gzip data"),function(D,q,tt,P){var st=D.length;if(!st||q.f&&!q.l)return tt||new $n(0);var it=!tt,dt=it||q.i!=2,Zt=q.i;it&&(tt=new $n(3*st));var Vt,Rt,Ft=function(ys){var Tr=tt.length;if(ys>Tr){var Vm=new $n(Math.max(2*Tr,ys));Vm.set(tt),tt=Vm}},yt=q.f||0,xt=q.p||0,ft=q.b||0,At=q.l,Ct=q.d,se=q.m,ae=q.n,Pt=8*st;do{if(!At){yt=fl(D,xt,1);var jt=fl(D,xt+1,3);if(xt+=3,!jt){var xe=D[(Se=4+((xt+7)/8|0))-4]|D[Se-3]<<8,oe=Se+xe;if(oe>st){Zt&&vl(0);break}dt&&Ft(ft+xe),tt.set(D.subarray(Se,oe),ft),q.b=ft+=xe,q.p=xt=8*oe,q.f=yt;continue}if(jt==1)At=Vx,Ct=Rx,se=9,ae=5;else if(jt==2){var me=fl(D,xt,31)+257,Ce=fl(D,xt+10,15)+4,Ke=me+fl(D,xt+5,31)+1;xt+=14;for(var Ae=new $n(Ke),He=new $n(19),$e=0;$e<Ce;++$e)He[ux[$e]]=fl(D,xt+3*$e,7);xt+=3*Ce;var ei=EW(He),yi=(1<<ei)-1,Fi=bm(He,ei);for($e=0;$e<Ke;){var Se,ui=Fi[fl(D,xt,yi)];if(xt+=15&ui,(Se=ui>>4)<16)Ae[$e++]=Se;else{var gi=0,Qi=0;for(Se==16?(Qi=3+fl(D,xt,3),xt+=2,gi=Ae[$e-1]):Se==17?(Qi=3+fl(D,xt,7),xt+=3):Se==18&&(Qi=11+fl(D,xt,127),xt+=7);Qi--;)Ae[$e++]=gi}}var qi=Ae.subarray(0,me),oa=Ae.subarray(me);se=EW(qi),ae=EW(oa),At=bm(qi,se),Ct=bm(oa,ae)}else vl(1);if(xt>Pt){Zt&&vl(0);break}}dt&&Ft(ft+131072);for(var $i=(1<<se)-1,Hi=(1<<ae)-1,Ua=xt;;Ua=xt){var da=(gi=At[LW(D,xt)&$i])>>4;if((xt+=15&gi)>Pt){Zt&&vl(0);break}if(gi||vl(2),da<256)tt[ft++]=da;else{if(da==256){Ua=xt,At=null;break}var Ta=da-254;da>264&&(Ta=fl(D,xt,(1<<(Ll=Og[$e=da-257]))-1)+Kg[$e],xt+=Ll);var ki=Ct[LW(D,xt)&Hi],In=ki>>4;if(ki||vl(3),xt+=15&ki,oa=gx[In],In>3){var Ll=Dg[In];oa+=LW(D,xt)&(1<<Ll)-1,xt+=Ll}if(xt>Pt){Zt&&vl(0);break}dt&&Ft(ft+131072);var Wl=ft+Ta;if(ft<oa){var ul=0-oa,Mr=Math.min(oa,Wl);for(ul+ft<0&&vl(3);ft<Mr;++ft)tt[ft]=(void 0)[ul+ft]}for(;ft<Wl;++ft)tt[ft]=tt[ft-oa]}}q.l=At,q.p=Ua,q.b=ft,q.f=yt,At&&(yt=1,q.m=se,q.d=Ct,q.n=ae)}while(!yt);return ft!=tt.length&&it?(Vt=tt,((Rt=ft)==null||Rt>Vt.length)&&(Rt=Vt.length),new $n(Vt.subarray(0,Rt))):tt.subarray(0,ft)}(f.subarray(T,-8),{i:2},new $n(((M=f)[(S=M.length)-4]|M[S-3]<<8|M[S-2]<<16|M[S-1]<<24)>>>0))));var M,S,f,T;let v=Ux[X];if(!v)throw new Error(`Unhandled codec: ${X}`);let L=new globalThis.DecompressionStream(v);return new Response(new Blob([N]).stream().pipeThrough(L)).arrayBuffer().then(D=>new Uint8Array(D))}(F,Z).then(N=>(function(X,M){X.readFields(dx,M)}(new zW(N),V),new Nx[W](V.buffer))),G.then(N=>{for(let X=h.length-1;X>=0;X--)switch(h[X]){case"delta_filter":mx(N,R);break;case"zigzag_filter":hx(N);break;case"bitshuffle_filter":px(N,W);break;default:throw new pl(`Unhandled filter "${h[X]}"`)}return{layerName:c,blockIndex:I,data:N}}).catch(N=>{throw N})}))},he(eV,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});var hm={workerUrl:"",workerClass:null,workerParams:void 0};let AW="mapboxgl_preloaded_worker_pool";class pm{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<pm.workerCount;)this.workers.push(hm.workerClass!=null?new hm.workerClass:new self.Worker(hm.workerUrl,hm.workerParams));return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[AW]}numActive(){return Object.keys(this.active).length}}let Wm;function N0(){return Wm||(Wm=new pm),Wm}pm.workerCount=2;let um,HW,El,bc,jW,mc=null;function iV(){return bo()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:HW||pt.DRACO_URL}function aV(){if(bo()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(bc)return bc;let n=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return bc=WebAssembly.validate(n)?pt.MESHOPT_SIMD_URL:pt.MESHOPT_URL,bc}let Y0={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Jx={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Zm={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function nV(n,t,i){let o=i.json.bufferViews.length,c=i.buffers.length;t.bufferView=o,i.json.bufferViews[o]={buffer:c,byteLength:n.byteLength},i.buffers[c]=n}let OW="KHR_draco_mesh_compression";function Xx(n,t){let i=n.extensions&&n.extensions[OW];if(!i)return;let o=new El.Decoder,c=rV(t,i.bufferView),s=new El.Mesh;if(!o.DecodeArrayToMesh(c,c.byteLength,s))throw new Error("Failed to decode Draco mesh");let b=t.json.accessors[n.indices],W=Y0[b.componentType],R=b.count*W.BYTES_PER_ELEMENT,I=El._malloc(R);W===Uint16Array?o.GetTrianglesUInt16Array(s,R,I):o.GetTrianglesUInt32Array(s,R,I),nV(El.memory.buffer.slice(I,I+R),b,t),El._free(I);for(let h of Object.keys(i.attributes)){let Z=o.GetAttributeByUniqueId(s,i.attributes[h]),F=t.json.accessors[n.attributes[h]],V=Jx[F.componentType],G=F.count*Zm[F.type]*Y0[F.componentType].BYTES_PER_ELEMENT,N=El._malloc(G);o.GetAttributeDataArrayForAllPoints(s,Z,El[V],G,N),nV(El.memory.buffer.slice(N,N+G),F,t),El._free(N)}o.destroy(),s.destroy(),delete n.extensions[OW]}let J0="EXT_meshopt_compression";function yx(n,t){if(!n.extensions||!n.extensions[J0])return;let i=n.extensions[J0],o=new Uint8Array(t.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),c=new Uint8Array(i.count*i.byteStride);jW.decodeGltfBuffer(c,i.count,i.byteStride,o,i.mode,i.filter),n.buffer=t.buffers.length,n.byteOffset=0,t.buffers[n.buffer]=c.buffer,delete n.extensions[J0]}let lV=1179937895,oV=new TextDecoder("utf8");function sV(n,t){return new URL(n,t).href}function Bx(n,t,i,o){return fetch(sV(n.uri,o)).then(c=>c.arrayBuffer()).then(c=>{t.buffers[i]=c})}function rV(n,t){let i=n.json.bufferViews[t];return new Uint8Array(n.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function Mx(n,t,i,o){if(n.uri){let c=sV(n.uri,o);return fetch(c).then(s=>s.blob()).then(s=>createImageBitmap(s)).then(s=>{t.images[i]=s})}if(n.bufferView!==void 0){let c=rV(t,n.bufferView),s=new Blob([c],{type:n.mimeType});return createImageBitmap(s).then(b=>{t.images[i]=b})}}function dV(n,t=0,i){let o={json:null,images:[],buffers:[]};if(new Uint32Array(n,t,1)[0]===lV){let h=new Uint32Array(n,t),Z=2,F=(h[Z++]>>2)-3,V=h[Z++]>>2;if(Z++,o.json=JSON.parse(oV.decode(h.subarray(Z,Z+V))),Z+=V,Z<F){let G=h[Z++];Z++;let N=t+(Z<<2);o.buffers[0]=n.slice(N,N+G)}}else o.json=JSON.parse(oV.decode(new Uint8Array(n,t)));let{buffers:c,images:s,meshes:b,extensionsUsed:W,bufferViews:R}=o.json,I=Promise.resolve();if(c){let h=[];for(let Z=0;Z<c.length;Z++){let F=c[Z];F.uri?h.push(Bx(F,o,Z,i)):o.buffers[Z]||(o.buffers[Z]=null)}I=Promise.all(h)}return I.then(()=>{let h=[],Z=W&&W.includes(OW),F=W&&W.includes(J0);if(Z&&h.push(function(){if(!El)return um??(um=function(V){let G,N=null;function X(){G=new Uint8Array(N.buffer)}function M(){throw new Error("Unexpected Draco error.")}let S={a:{a:M,d:function(f,T,v){return G.copyWithin(f,T,T+v)},c:function(f){let T=G.length,v=Math.max(f>>>0,Math.ceil(1.2*T)),L=Math.ceil((v-T)/65536);try{return N.grow(L),X(),!0}catch{return!1}},b:M}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(V,S):V.then(f=>f.arrayBuffer()).then(f=>WebAssembly.instantiate(f,S))).then(f=>{let{Rb:T,Qb:v,P:L,T:D,X:q,Ja:tt,La:P,Qa:st,Va:it,Wa:dt,eb:Zt,jb:Vt,f:Rt,e:Ft,yb:yt,zb:xt,Ab:ft,Bb:At,Db:Ct,Gb:se}=f.instance.exports;N=Ft;let ae=(()=>{let Pt=0,jt=0,xe=0,oe=0;return me=>{xe&&(T(oe),T(Pt),jt+=xe,xe=Pt=0),Pt||(jt+=128,Pt=v(jt));let Ce=me.length+7&-8,Ke=Pt;Ce>=jt&&(xe=Ce,Ke=oe=v(Ce));for(let Ae=0;Ae<me.length;Ae++)G[Ke+Ae]=me[Ae];return Ke}})();return X(),Rt(),{memory:Ft,_free:T,_malloc:v,Mesh:class{constructor(){this.ptr=L()}destroy(){D(this.ptr)}},Decoder:class{constructor(){this.ptr=tt()}destroy(){Vt(this.ptr)}DecodeArrayToMesh(Pt,jt,xe){let oe=ae(Pt),me=P(this.ptr,oe,jt,xe.ptr);return!!q(me)}GetAttributeByUniqueId(Pt,jt){return{ptr:st(this.ptr,Pt.ptr,jt)}}GetTrianglesUInt16Array(Pt,jt,xe){it(this.ptr,Pt.ptr,jt,xe)}GetTrianglesUInt32Array(Pt,jt,xe){dt(this.ptr,Pt.ptr,jt,xe)}GetAttributeDataArrayForAllPoints(Pt,jt,xe,oe,me){Zt(this.ptr,Pt.ptr,jt.ptr,xe,oe,me)}},DT_INT8:yt(),DT_UINT8:xt(),DT_INT16:ft(),DT_UINT16:At(),DT_UINT32:Ct(),DT_FLOAT32:se()}})}(fetch(iV())),um.then(V=>{El=V,um=void 0}))}()),F&&h.push(function(){if(jW)return;let V=function(G){let N,X=WebAssembly.instantiateStreaming(G,{}).then(f=>{N=f.instance,N.exports.__wasm_call_ctors()}),M={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},S={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:X,supported:!0,decodeGltfBuffer(f,T,v,L,D,q){(function(tt,P,st,it,dt,Zt,Vt){let Rt=tt.exports.sbrk,Ft=it+3&-4,yt=Rt(Ft*dt),xt=Rt(Zt.length),ft=new Uint8Array(tt.exports.memory.buffer);ft.set(Zt,xt);let At=P(yt,it,dt,xt,Zt.length);if(At===0&&Vt&&Vt(yt,Ft,dt),st.set(ft.subarray(yt,yt+it*dt)),Rt(yt-Rt(0)),At!==0)throw new Error(`Malformed buffer data: ${At}`)})(N,N.exports[S[D]],f,T,v,L,N.exports[M[q]])}}}(fetch(aV()));return V.ready.then(()=>{jW=V})}()),s)for(let V=0;V<s.length;V++)h.push(Mx(s[V],o,V,i));return(h.length?Promise.all(h):Promise.resolve()).then(()=>{if(Z&&b)for(let{primitives:V}of b)for(let G of V)Xx(G,o);if(F&&b&&R)for(let V of R)yx(V,o);return o})})}function Br(n,t){let i=n.json.bufferViews[t.bufferView],o=Y0[t.componentType];return new o(n.buffers[i.buffer],(t.byteOffset||0)+(i.byteOffset||0),t.count*(i.byteStride&&i.byteStride!==Zm[t.type]*o.BYTES_PER_ELEMENT?i.byteStride/o.BYTES_PER_ELEMENT:Zm[t.type]))}function DW(n,t,i,o){let c=Y0[t.componentType],s=function(h){switch(h){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(c),b=n.json.bufferViews[t.bufferView],W=b.byteStride?b.byteStride/c.BYTES_PER_ELEMENT:Zm[t.type],R=i.float32,I=R.length/i.capacity;for(let h=0,Z=0;h<t.count*W;h+=W,Z+=I)for(let F=0;F<I;F++)R[Z+F]=o[h+F]*s;i._trim()}function Tx(n,t,i){let o=n.indices,c=n.attributes,s={};s.indexArray=new Ja;let b=t.json.accessors[o],W=b.count/3;s.indexArray.reserve(W);let R=Br(t,b);for(let F=0;F<W;F++)s.indexArray.emplaceBack(R[3*F],R[3*F+1],R[3*F+2]);s.indexArray._trim(),s.vertexArray=new to;let I=t.json.accessors[c.POSITION];s.vertexArray.reserve(I.count);let h=Br(t,I);for(let F=0;F<I.count;F++)s.vertexArray.emplaceBack(h[3*F],h[3*F+1],h[3*F+2]);if(s.vertexArray._trim(),s.aabb=new Ci(I.min,I.max),s.centroid=function(F,V){let G=[0,0,0],N=F.length;if(N>0){for(let X=0;X<N;X++){let M=3*F[X];G[0]+=V[M],G[1]+=V[M+1],G[2]+=V[M+2]}G[0]/=N,G[1]/=N,G[2]/=N}return G}(R,h),c.COLOR_0!==void 0){let F=t.json.accessors[c.COLOR_0],V=Zm[F.type],G=Br(t,F);s.colorArray=V===3?new to:new Bl,s.colorArray.resize(F.count),DW(t,F,s.colorArray,G)}if(c.NORMAL!==void 0){s.normalArray=new to;let F=t.json.accessors[c.NORMAL];s.normalArray.resize(F.count);let V=Br(t,F);DW(t,F,s.normalArray,V)}if(c.TEXCOORD_0!==void 0&&i.length>0){s.texcoordArray=new Gr;let F=t.json.accessors[c.TEXCOORD_0];s.texcoordArray.resize(F.count);let V=Br(t,F);DW(t,F,s.texcoordArray,V)}if(c._FEATURE_ID_RGBA4444!==void 0){let F=t.json.accessors[c._FEATURE_ID_RGBA4444];t.json.extensionsUsed&&t.json.extensionsUsed.includes("EXT_meshopt_compression")&&(s.featureData=Br(t,F))}c._FEATURE_RGBA4444!==void 0&&(s.featureData=new Uint32Array(Br(t,t.json.accessors[c._FEATURE_RGBA4444]).buffer));let Z=n.material;return s.material=function(F,V){let{emissiveFactor:G=[0,0,0],alphaMode:N="OPAQUE",alphaCutoff:X=.5,normalTexture:M,occlusionTexture:S,emissiveTexture:f,doubleSided:T}=F,{baseColorFactor:v=[1,1,1,1],metallicFactor:L=1,roughnessFactor:D=1,baseColorTexture:q,metallicRoughnessTexture:tt}=F.pbrMetallicRoughness||{},P=S?V[S.index]:void 0;if(S&&S.extensions&&S.extensions.KHR_texture_transform&&P){let st=S.extensions.KHR_texture_transform;P.offsetScale=[st.offset[0],st.offset[1],st.scale[0],st.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Ri(...v),metallicFactor:L,roughnessFactor:D,baseColorTexture:q?V[q.index]:void 0,metallicRoughnessTexture:tt?V[tt.index]:void 0},doubleSided:T,emissiveFactor:G,alphaMode:N,alphaCutoff:X,normalTexture:M?V[M.index]:void 0,occlusionTexture:P,emissionTexture:f?V[f.index]:void 0,defined:F.defined===void 0}}(Z!==void 0?t.json.materials[Z]:{defined:!1},i),s}function cV(n,t,i){let{matrix:o,rotation:c,translation:s,scale:b,mesh:W,extras:R,children:I}=n,h={};if(h.matrix=o||ut.mat4.fromRotationTranslationScale([],c||[0,0,0,1],s||[0,0,0],b||[1,1,1]),W!==void 0){h.meshes=i[W];let Z=h.anchor=[0,0];for(let F of h.meshes){let{min:V,max:G}=F.aabb;Z[0]+=V[0]+G[0],Z[1]+=V[1]+G[1]}Z[0]=Math.floor(Z[0]/h.meshes.length/2),Z[1]=Math.floor(Z[1]/h.meshes.length/2)}if(R&&(R.id&&(h.id=R.id),R.lights&&(h.lights=function(Z){if(!Z.length)return[];let F=function(M){let S=atob(M),f=new Uint8Array(S.length);for(let T=0;T<S.length;T++)f[T]=S.codePointAt(T);return f}(Z),V=[],G=F.length/24,N=new Uint16Array(F.buffer),X=new Float32Array(F.buffer);for(let M=0;M<G;M++){let S=N[2*M*6]/30,f=N[2*M*6+1]/30,T=N[2*M*6+10]/100,v=X[6*M+1],L=X[6*M+2],D=X[6*M+3],q=X[6*M+4],tt=D-v,P=q-L,st=Math.hypot(tt,P);V.push({pos:[v+.5*tt,L+.5*P,f],normal:[P/st,-tt/st,0],width:st,height:S,depth:T,points:[v,L,D,q]})}return V}(R.lights))),I){let Z=[];for(let F of I)Z.push(cV(t.json.nodes[F],t,i));h.children=Z}return h}function Cx(n){if(n.vertices.length===0||n.indices.length===0)return null;let t=new aW(n.vertices,n.indices,8,256),[i,o]=[t.min.clone(),t.max.clone()];return{vertices:n.vertices,indices:n.indices,grid:t,min:i,max:o}}function kx(n){if(!n.extras||!n.extras.ground)return null;let t=n.extras.ground;if(!t||!Array.isArray(t)||t.length===0)return null;let i=t[0];if(!i||!Array.isArray(i)||i.length===0)return null;let o=[];for(let b of i){if(!Array.isArray(b)||b.length!==2)continue;let W=b[0],R=b[1];typeof W=="number"&&typeof R=="number"&&o.push(new ee(W,R))}if(o.length<3)return null;o.length>1&&o[o.length-1].equals(o[0])&&o.pop();let c=0;for(let b=0;b<o.length;b++){let W=o[b],R=o[(b+1)%o.length],I=o[(b+2)%o.length];c+=(W.x-R.x)*(I.y-R.y)-(I.x-R.x)*(W.y-R.y)}c>0&&o.reverse();let s=wb(o.flatMap(b=>[b.x,b.y]),[]);return s.length===0?null:{vertices:o,indices:s}}function Sx(n,t){let i=[],o=[],c=0,s=[];for(let b of n){c=i.length;let W=b.vertexArray.float32,R=b.indexArray.uint16;for(let I=0;I<b.vertexArray.length;I++)s[0]=W[3*I+0],s[1]=W[3*I+1],s[2]=W[3*I+2],ut.vec3.transformMat4(s,s,t),i.push(new ee(s[0],s[1]));for(let I=0;I<3*b.indexArray.length;I++)o.push(R[I]+c)}if(o.length%3!=0)return null;for(let b=0;b<o.length;b+=3){let W=i[o[b+0]],R=i[o[b+1]],I=i[o[b+2]];(W.x-R.x)*(I.y-R.y)-(I.x-R.x)*(W.y-R.y)>0&&([o[b+1],o[b+2]]=[o[b+2],o[b+1]])}return{vertices:i,indices:o}}function bV(n){let t=function(R,I){let h=[],Z=WebGL2RenderingContext;if(R.json.textures)for(let F of R.json.textures){let V={magFilter:Z.LINEAR,minFilter:Z.NEAREST,wrapS:Z.REPEAT,wrapT:Z.REPEAT};F.sampler!==void 0&&Object.assign(V,R.json.samplers[F.sampler]),h.push({image:I[F.source],sampler:V,uploaded:!1})}return h}(n,n.images),i=function(R,I){let h=[];for(let Z of R.json.meshes){let F=[];for(let V of Z.primitives)F.push(Tx(V,R,I));h.push(F)}return h}(n,t),{scenes:o,scene:c,nodes:s}=n.json,b=o?o[c||0].nodes:s,W=[];for(let R of b)W.push(cV(s[R],n,i));return function(R,I,h){let Z={},F=new Set;for(let V=0;V<R.length;V++){let G=h[I[V]];if(!G.extras)continue;let N=G.extras["mapbox:footprint:version"],X=G.extras["mapbox:footprint:id"];(N||X)&&F.add(V),N==="1.0.0"&&X&&(Z[X]=V)}for(let V=0;V<R.length;V++){if(F.has(V))continue;let G=R[V],N=h[I[V]];if(!N.extras)continue;let X=null;G.id in Z&&(X=Sx(R[Z[G.id]].meshes,G.matrix)),X||(X=kx(N)),X&&(G.footprint=Cx(X))}if(F.size>0){let V=Array.from(F.values()).sort((G,N)=>G-N);for(let G=V.length-1;G>=0;G--)R.splice(V[G],1)}}(W,b,n.json.nodes),W}function Qx(n){n.heightmap=new Float32Array(4096),n.heightmap.fill(-1);let t=n.vertexArray.float32,i=n.aabb.min[0]-1,o=n.aabb.min[1]-1,c=Xr/(n.aabb.max[0]-i+2),s=Xr/(n.aabb.max[1]-o+2);for(let b=0;b<t.length;b+=3){let W=t[b+2],R=(t[b+0]-i)*c|0,I=(t[b+1]-o)*s|0;W>n.heightmap[I*Xr+R]&&(n.heightmap[I*Xr+R]=W)}}function fx(n,t){let i={};i.indexArray=new Ja,i.indexArray.reserve(4*n.length),i.vertexArray=new to,i.vertexArray.reserve(10*n.length),i.colorArray=new Bl,i.vertexArray.reserve(10*n.length);let o=0;for(let b of n){let W=Math.min(10,Math.max(4,1.3*b.height))*t,R=[-b.normal[1],b.normal[0],0],I=Math.min(.29,.1*b.width/b.depth),h=b.width-2*b.depth*t*(I+.01),Z=ut.vec3.scaleAndAdd([],b.pos,R,h/2),F=ut.vec3.scaleAndAdd([],b.pos,R,-h/2),V=[Z[0],Z[1],Z[2]+b.height],G=[F[0],F[1],F[2]+b.height],N=ut.vec3.scaleAndAdd([],b.normal,R,I);ut.vec3.scale(N,N,W);let X=ut.vec3.scaleAndAdd([],b.normal,R,-I);ut.vec3.scale(X,X,W),ut.vec3.add(N,Z,N),ut.vec3.add(X,F,X),Z[2]+=.1,F[2]+=.1,i.vertexArray.emplaceBack(N[0],N[1],N[2]),i.vertexArray.emplaceBack(X[0],X[1],X[2]),i.vertexArray.emplaceBack(Z[0],Z[1],Z[2]),i.vertexArray.emplaceBack(F[0],F[1],F[2]),i.vertexArray.emplaceBack(V[0],V[1],V[2]),i.vertexArray.emplaceBack(G[0],G[1],G[2]),i.vertexArray.emplaceBack(Z[0],Z[1],Z[2]),i.vertexArray.emplaceBack(F[0],F[1],F[2]),i.vertexArray.emplaceBack(N[0],N[1],N[2]),i.vertexArray.emplaceBack(X[0],X[1],X[2]);let M=h/W/2;i.colorArray.emplaceBack(-M-I,-1,M,.8),i.colorArray.emplaceBack(M+I,-1,M,.8),i.colorArray.emplaceBack(-M,0,M,1.3),i.colorArray.emplaceBack(M,0,M,1.3),i.colorArray.emplaceBack(M+I,-.8,M,.7),i.colorArray.emplaceBack(M+I,-.8,M,.7),i.colorArray.emplaceBack(0,0,M,1.3),i.colorArray.emplaceBack(0,0,M,1.3),i.colorArray.emplaceBack(M+I,-1.2,M,.8),i.colorArray.emplaceBack(M+I,-1.2,M,.8),i.indexArray.emplaceBack(6+o,4+o,8+o),i.indexArray.emplaceBack(7+o,9+o,5+o),i.indexArray.emplaceBack(0+o,1+o,2+o),i.indexArray.emplaceBack(1+o,3+o,2+o),o+=10}let c={defined:!0,emissiveFactor:[0,0,0]},s={};return s.baseColorFactor=Ri.white,c.pbrMetallicRoughness=s,i.material=c,i.aabb=new Ci([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}class mV{constructor(t){this._stringToNumber={},this._numberToString=[];for(let i=0;i<t.length;i++){let o=t[i];this._stringToNumber[o]=i,this._numberToString[i]=o}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}let vx=["id","tile","layer","source","sourceLayer","state"];class hV{constructor(t,i,o,c,s){this.type="Feature",this._vectorTileFeature=t,this._z=i,this._x=o,this._y=c,this.properties=t.properties,this.id=s}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){let t={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let i of vx)this[i]!==void 0&&(t[i]=this[i]);return t}}class pV{constructor(t,i){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new Vo(ne,16,0),this.featureIndexArray=new kh,this.promoteId=i,this.is3DTile=!1}insert(t,i,o,c,s,b=0,W=0){let R=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,c,s,b);let I=this.grid;for(let h=0;h<i.length;h++){let Z=i[h],F=[1/0,1/0,-1/0,-1/0];for(let V=0;V<Z.length;V++){let G=Z[V];F[0]=Math.min(F[0],G.x),F[1]=Math.min(F[1],G.y),F[2]=Math.max(F[2],G.x),F[3]=Math.max(F[3],G.y)}W!==0&&(F[0]-=W,F[1]-=W,F[2]+=W,F[3]+=W),F[0]<ne&&F[1]<ne&&F[2]>=0&&F[3]>=0&&I.insert(R,F[0],F[1],F[2],F[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new ec.VectorTile(new a0(this.rawTileData)).layers,this.sourceLayerCoder=new mV(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(let t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,i,o,c){this.loadVTLayers();let s=t.params||{},b=Pn(s.filter),W=t.tileResult,R=t.transform,I=W.bufferedTilespaceBounds,h=this.grid.query(I.min.x,I.min.y,I.max.x,I.max.y,(G,N,X,M)=>Bn(W.bufferedTilespaceGeometry,G,N,X,M));h.sort(Ex);let Z=null;R.elevation&&h.length>0&&(Z=rc.create(R.elevation,this.tileID));let F={},V;for(let G=0;G<h.length;G++){let N=h[G];if(N===V)continue;V=N;let X=this.featureIndexArray.get(N),M=null;if(this.is3DTile){let S=this.bucketLayerIDs[0][0],f=i[S];if(f.type!=="model")continue;let{queryFeature:T,intersectionZ:v}=f.queryIntersectsMatchingFeature(W,X.featureIndex,b,R);T&&this.appendToResult(F,S,X.featureIndex,T,v)}else this.loadMatchingFeature(F,X,b,s.layers,s.availableImages,i,o,c,(S,f,T,v=0)=>(M||(M=_t(S,this.tileID.canonical,t.tileTransform)),f.queryIntersectsFeature(W,S,T,M,this.z,t.transform,t.pixelPosMatrix,Z,v)))}return F}loadMatchingFeature(t,i,o,c,s,b,W,R,I){let{featureIndex:h,bucketIndex:Z,sourceLayerIndex:F,layoutVertexArrayOffset:V}=i,G=this.bucketLayerIDs[Z];if(c&&!function(S,f){for(let T=0;T<S.length;T++)if(f.indexOf(S[T])>=0)return!0;return!1}(c,G))return;let N=this.sourceLayerCoder.decode(F),X=this.vtLayers[N].feature(h);if(o.needGeometry){let S=qt(X,!0);if(!o.filter(new ji(this.tileID.overscaledZ),S,this.tileID.canonical))return}else if(!o.filter(new ji(this.tileID.overscaledZ),X))return;let M=this.getId(X,N);for(let S=0;S<G.length;S++){let f=G[S];if(c&&c.indexOf(f)<0)continue;let T=b[f];if(!T)continue;let v={};M!==void 0&&R&&(v=R.getState(T.sourceLayer||"_geojsonTileLayer",M));let L=!I||I(X,T,v,V);if(!L)continue;let D=new hV(X,this.z,this.x,this.y,M),q=Fa({},W[f]);q.paint=WV(q.paint,T.paint,X,v,s),q.layout=WV(q.layout,T.layout,X,v,s),D.layer=q,this.appendToResult(t,f,h,D,L)}}appendToResult(t,i,o,c,s){let b=t[i];b===void 0&&(b=t[i]=[]),b.push({featureIndex:o,feature:c,intersectionZ:s})}lookupSymbolFeatures(t,i,o,c,s,b,W,R){let I={};this.loadVTLayers();let h=Pn(s);for(let Z of t)this.loadMatchingFeature(I,{bucketIndex:o,sourceLayerIndex:c,featureIndex:Z,layoutVertexArrayOffset:0},h,b,W,R,i);return I}loadFeature(t){let{featureIndex:i,sourceLayerIndex:o}=t;this.loadVTLayers();let c=this.sourceLayerCoder.decode(o),s=this.vtFeatures[c];if(s[i])return s[i];let b=this.vtLayers[c].feature(i);return s[i]=b,b}hasLayer(t){for(let i of this.bucketLayerIDs)for(let o of i)if(t===o)return!0;return!1}getId(t,i){let o=t.id;if(this.promoteId){let c=typeof this.promoteId=="string"?this.promoteId:this.promoteId[i];c!=null&&(o=t.properties[c]),typeof o=="boolean"&&(o=Number(o))}return o}}function WV(n,t,i,o,c){return co(n,(s,b)=>{let W=t instanceof bs?t.get(b):null;return W&&W.evaluate?W.evaluate(i,o,c):W})}function Ex(n,t){return t-n}he(pV,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let uV=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class _W{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");let[i,o]=new Uint8Array(t,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");let c=o>>4;if(c!==1)throw new Error(`Got v${c} data when expected v1.`);let s=uV[15&o];if(!s)throw new Error("Unrecognized array type.");let[b]=new Uint16Array(t,2,1),[W]=new Uint32Array(t,4,1);return new _W(W,b,s,t)}constructor(t,i=64,o=Float64Array,c){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=o,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;let s=uV.indexOf(this.ArrayType),b=2*t*this.ArrayType.BYTES_PER_ELEMENT,W=t*this.IndexArrayType.BYTES_PER_ELEMENT,R=(8-W%8)%8;if(s<0)throw new Error(`Unexpected typed array class: ${o}.`);c&&c instanceof ArrayBuffer?(this.data=c,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+W+R,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+b+W+R),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+W+R,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+s]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=t)}add(t,i){let o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=t,this.coords[this._pos++]=i,o}finish(){let t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return PW(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,i,o,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:s,coords:b,nodeSize:W}=this,R=[0,s.length-1,0],I=[];for(;R.length;){let h=R.pop()||0,Z=R.pop()||0,F=R.pop()||0;if(Z-F<=W){for(let X=F;X<=Z;X++){let M=b[2*X],S=b[2*X+1];M>=t&&M<=o&&S>=i&&S<=c&&I.push(s[X])}continue}let V=F+Z>>1,G=b[2*V],N=b[2*V+1];G>=t&&G<=o&&N>=i&&N<=c&&I.push(s[V]),(h===0?t<=G:i<=N)&&(R.push(F),R.push(V-1),R.push(1-h)),(h===0?o>=G:c>=N)&&(R.push(V+1),R.push(Z),R.push(1-h))}return I}within(t,i,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:c,coords:s,nodeSize:b}=this,W=[0,c.length-1,0],R=[],I=o*o;for(;W.length;){let h=W.pop()||0,Z=W.pop()||0,F=W.pop()||0;if(Z-F<=b){for(let X=F;X<=Z;X++)gV(s[2*X],s[2*X+1],t,i)<=I&&R.push(c[X]);continue}let V=F+Z>>1,G=s[2*V],N=s[2*V+1];gV(G,N,t,i)<=I&&R.push(c[V]),(h===0?t-o<=G:i-o<=N)&&(W.push(F),W.push(V-1),W.push(1-h)),(h===0?t+o>=G:i+o>=N)&&(W.push(V+1),W.push(Z),W.push(1-h))}return R}}function PW(n,t,i,o,c,s){if(c-o<=i)return;let b=o+c>>1;ZV(n,t,b,o,c,s),PW(n,t,i,o,b-1,1-s),PW(n,t,i,b+1,c,1-s)}function ZV(n,t,i,o,c,s){for(;c>o;){if(c-o>600){let I=c-o+1,h=i-o+1,Z=Math.log(I),F=.5*Math.exp(2*Z/3),V=.5*Math.sqrt(Z*F*(I-F)/I)*(h-I/2<0?-1:1);ZV(n,t,i,Math.max(o,Math.floor(i-h*F/I+V)),Math.min(c,Math.floor(i+(I-h)*F/I+V)),s)}let b=t[2*i+s],W=o,R=c;for(gm(n,t,o,i),t[2*c+s]>b&&gm(n,t,o,c);W<R;){for(gm(n,t,W,R),W++,R--;t[2*W+s]<b;)W++;for(;t[2*R+s]>b;)R--}t[2*o+s]===b?gm(n,t,o,R):(R++,gm(n,t,R,c)),R<=i&&(o=R+1),i<=R&&(c=R-1)}}function gm(n,t,i,o){KW(n,i,o),KW(t,2*i,2*o),KW(t,2*i+1,2*o+1)}function KW(n,t,i){let o=n[t];n[t]=n[i],n[i]=o}function gV(n,t,i,o){let c=n-i,s=t-o;return c*c+s*s}l.$=xh,l.A=class extends F0{},l.B=Wo,l.C=wo,l.D=ur,l.E=zo,l.F=pb,l.G=Yd,l.H=uh,l.I=RW,l.J=yd,l.K=vd,l.L=Gh,l.M=mr,l.N=Vd,l.O=lr,l.P=ee,l.Q=nr,l.R=vo,l.S=ln,l.T=MW,l.U=Ec,l.V=F0,l.W=Ub,l.X=Jd,l.Y=hb,l.Z=function(n){let t=n.value,i=[];if(!t)return i;let o=Wo(t);return o!=="string"?(i=i.concat([new F0(n.key,t,`string expected, "${o}" found`)]),i):(Jg(t,!0)||(i=i.concat([new F0(n.key,t,`invalid url "${t}"`)])),i)},l._=Xt,l.a=function(n){return pt.API_CDN_URL_REGEX.test(n)},l.a$=Tb,l.a0=Ei,l.a1=te,l.a2=class{constructor(n){this.specification=n}possiblyEvaluate(n,t){return Wn(n.expression.evaluate(t))}interpolate(n,t,i){return{x:Je(n.x,t.x,i),y:Je(n.y,t.y,i),z:Je(n.z,t.z,i),azimuthal:Je(n.azimuthal,t.azimuthal,i),polar:Je(n.polar,t.polar,i)}}},l.a3=ji,l.a4=dl,l.a5=Nt,l.a6=ut,l.a7=xl,l.a8=bs,l.a9=Fs,l.aA=Ti,l.aB=Wg,l.aC=Gg,l.aD=pg,l.aE=function(n,t){let i=document.createElement("video");i.muted=!0,i.onloadstart=function(){t(null,i)};for(let o=0;o<n.length;o++){let c=document.createElement("source");yn(n[o])||(i.crossOrigin="Anonymous"),c.src=n[o],i.appendChild(c)}return{cancel:()=>{}}},l.aF=Z0,l.aG=function(n){return fetch(n).then(t=>t.arrayBuffer()).then(t=>dV(t,0,n))},l.aH=bV,l.aI=class{constructor(n,t,i,o){this.id=n,this.position=t!=null?new Q(t[0],t[1]):new Q(0,0),this.orientation=i??[0,0,0],this.nodes=o,this.uploaded=!1,this.aabb=new Ci([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(n,t){if(ut.mat4.multiply(n.matrix,t,n.matrix),n.meshes)for(let i of n.meshes){let o=Ci.applyTransformFast(i.aabb,n.matrix);this.aabb.encapsulate(o)}if(n.children)for(let i of n.children)this._applyTransformations(i,n.matrix)}computeBoundsAndApplyParent(){let n=ut.mat4.identity([]);for(let t of this.nodes)this._applyTransformations(t,n)}computeModelMatrix(n,t,i,o,c,s,b=!1){Tg(this.matrix,this,n.transform,this.position,t,i,o,c,s,b)}upload(n){if(!this.uploaded){for(let t of this.nodes)QW(t,n);for(let t of this.nodes)I0(t);this.uploaded=!0}}destroy(){for(let n of this.nodes)fW(n)}},l.aJ=ko,l.aK=am,l.aL=nt,l.aM=at,l.aN=$l,l.aO=Ja,l.aP=Al,l.aQ=_d,l.aR=W0,l.aS=function(){sn.isLoading()||sn.isLoaded()||Gb()!=="deferred"||Fb()},l.aT=Pn,l.aU=qt,l.aV=hV,l.aW=js,l.aX=mW,l.aY=iW,l.aZ=_t,l.a_=ql,l.aa=Je,l.ab=ne,l.ac=qs,l.ad=class{constructor(n){this.specification=n}possiblyEvaluate(n,t){return function([i,o]){let c=Wn([1,i,o]);return{x:c.x,y:c.y,z:c.z}}(n.expression.evaluate(t))}interpolate(n,t,i){return{x:Je(n.x,t.x,i),y:Je(n.y,t.y,i),z:Je(n.z,t.z,i)}}},l.ae=function(n,t,i=0,o=!0){let c=new ee(i,i),s=n.sub(c),b=t.add(c),W=[s,new ee(b.x,s.y),b,new ee(s.x,b.y)];return o&&W.push(s.clone()),W},l.af=function(n,t){let i=[];for(let o=0;o<n.length;o++){let c=pn(o-1,-1,n.length-1),s=pn(o+1,-1,n.length-1),b=n[o],W=n[s],R=n[c].sub(b).unit(),I=W.sub(b).unit(),h=I.angleWithSep(R.x,R.y),Z=R.add(I).unit().mult(-1*t/Math.sin(h/2));i.push(b.add(Z))}return i},l.ag=tg,l.ah=Bn,l.ai=function(n,t,i=0){return ut.vec3.fromValues(((t.x-i)*n.scale-n.x)*ne,(t.y*n.scale-n.y)*ne,ct(t.z,t.y))},l.aj=kl,l.ak=RZ,l.al=function(n){let t=1/0,i=1/0,o=-1/0,c=-1/0;for(let s of n)t=Math.min(t,s.x),i=Math.min(i,s.y),o=Math.max(o,s.x),c=Math.max(c,s.y);return{min:new ee(t,i),max:new ee(o,c)}},l.am=$,l.an=Si,l.ao=wt,l.ap=ze,l.aq=e,l.ar=function(n,t){let i={};for(let o=0;o<t.length;o++){let c=t[o];c in n&&(i[c]=n[c])}return i},l.as=z,l.at=et,l.au=class{constructor(n){this.entries={},this.scheduler=n}request(n,t,i,o){let c=this.entries[n]=this.entries[n]||{callbacks:[]};if(c.result){let[s,b]=c.result;return this.scheduler?this.scheduler.add(()=>{o(s,b)},t):o(s,b),()=>{}}return c.callbacks.push(o),c.cancel||(c.cancel=i((s,b)=>{c.result=[s,b];for(let W of c.callbacks)this.scheduler?this.scheduler.add(()=>{W(s,b)},t):W(s,b);setTimeout(()=>delete this.entries[n],3e3)})),()=>{c.result||(c.callbacks=c.callbacks.filter(s=>s!==o),c.callbacks.length||(c.cancel(),delete this.entries[n]))}}},l.av=Xh,l.aw=function(n,t,i){let o=JSON.stringify(n.request);return n.data&&(this.deduped.entries[o]={result:[null,n.data]}),this.deduped.request(o,{type:"parseTile",isSymbolTile:n.isSymbolTile,zoom:n.tileZoom},c=>{let s=Eo(n.request,(b,W,R,I)=>{b?c(b):W&&c(null,{vectorTile:i?void 0:new ec.VectorTile(new a0(W)),rawData:W,cacheControl:R,expires:I})});return()=>{s.cancel(),c()}},t)},l.ax=function(n){ba++,ba>Vi&&(n.getActor().send("enforceCacheSizeLimit",ve),ba=0)},l.ay=de,l.az=function(n){return n<=1?1:Math.pow(2,Math.floor(Math.log(n)/Math.LN2))},l.b=function(n){return pt.API_FONTS_REGEX.test(n)},l.b$=function(n){let{x:t,y:i}=n.point,{lng:o,lat:c}=n._center;return mu(t,i,n.worldSize,o,c)},l.b0=Tn,l.b1=Oi,l.b2=wb,l.b3=XW,l.b4=function(n,t){let i=Fs(t.zoom);if(i===0)return no(n);let o=wh(n),c=Op(o),s=$(o.getWest())*t.worldSize,b=$(o.getEast())*t.worldSize,W=et(o.getNorth())*t.worldSize,R=et(o.getSouth())*t.worldSize,I=[s,W,0],h=[b,W,0],Z=[s,R,0],F=[b,R,0],V=ut.mat4.invert([],t.globeMatrix);return ut.vec3.transformMat4(I,I,V),ut.vec3.transformMat4(h,h,V),ut.vec3.transformMat4(Z,Z,V),ut.vec3.transformMat4(F,F,V),c[0]=Yo(c[0],Z,i),c[1]=Yo(c[1],F,i),c[2]=Yo(c[2],h,i),c[3]=Yo(c[3],I,i),Ci.fromPoints(c)},l.b5=Hh,l.b6=Lb,l.b7=Yo,l.b8=wd,l.b9=rn,l.bA=pn,l.bB=ti,l.bC=mo,l.bD=K,l.bE=function(n,t,i){n[4*t+0]=i[0],n[4*t+1]=i[1],n[4*t+2]=i[2],n[4*t+3]=i[3]},l.bF=xr,l.bG=cl,l.bH=Qb,l.bI=wa,l.bJ=Uo,l.bK=Q,l.bL=lg,l.bM=ha,l.bN=Gs,l.bO=Ig,l.bP=Va,l.bQ=du,l.bR=function(n,t,i,o,c,s,b,W,R){if(R.name==="globe")return du(n,t,new Va(i,o,c),!1);let I=am({z:i,x:o,y:c},R);return new Ci([(s+I.x/I.scale)*t,t*(I.y/I.scale),b],[(s+I.x2/I.scale)*t,t*(I.y2/I.scale),W])},l.bS=function(n,t,i){let o=0;for(let c=0;c<2;++c)n[c]>0&&(o+=(n[c]-0)*(n[c]-0)),t[c]<0&&(o+=(0-t[c])*(0-t[c]));return o},l.bT=rt,l.bU=d,l.bV=function(n){let t=ut.mat4.identity(new Float64Array(16));ut.mat4.multiply(t,n.pixelMatrix,n.globeMatrix);let i=[0,U,0],o=[0,Y,0];return ut.vec3.transformMat4(i,i,t),ut.vec3.transformMat4(o,o,t),[i[0]>0&&i[0]<=n.width&&i[1]>0&&i[1]<=n.height&&!Pp(n,new Q(n.center.lat,90)),o[0]>0&&o[0]<=n.width&&o[1]>0&&o[1]<=n.height&&!Pp(n,new Q(n.center.lat,-90))]},l.bW=function(n,t){let{scale:i}=n.tileTransform,o=i*ne/(n.tileSize*Math.pow(2,t.zoom-n.tileID.overscaledZ+n.tileID.canonical.z));return ut.mat2.scale(new Float32Array(4),t.inverseAdjustmentMatrix,[o,o])},l.bX=R0,l.bY=Fg,l.bZ=function(n){let t=Fg(n,!0);return ut.mat2.invert([],[t[0],t[1],t[4],t[5]])},l.b_=ao,l.ba=wW,l.bb=a0,l.bc=Eo,l.bd=function(n){let t=[];for(let i in n)t.push(n[i]);return t},l.be=function(n,t){let i=[];for(let o in n)o in t||i.push(o);return i},l.bf=al,l.bg=["type","source","source-layer","minzoom","maxzoom","filter","layout"],l.bh=il,l.bi=function(n,t){let{x:i,y:o}=n.point,c=mu(i,o,n.worldSize/n._pixelsPerMercatorPixel,0,0);return ut.mat4.multiply(c,c,Dp(no(t)))},l.bj=ic,l.bk=qn,l.bl=i0,l.bm=function(n,t,i,o,c){let s=5*t+2;n.float32[s+0]=i,n.float32[s+1]=o,n.float32[s+2]=c},l.bn=p0,l.bo=wZ,l.bp=ie,l.bq=Ma,l.br=Hu,l.bs=Yg,l.bt=Pu,l.bu=Ku,l.bv=IW,l.bw=PZ,l.bx=VW,l.by=_W,l.bz=Ri,l.c=Ut,l.c$=qa,l.c0=sa,l.c1=Ka,l.c2=a,l.c3=function(n){let t=Math.round((n+45+360)%360/90)%4;return hn[t]},l.c4=45,l.c5=H,l.c6=qd,l.c7=function(n,t,i){let o=Math.sqrt(n*n+t*t+i*i),c=o>0?Math.acos(i/o)*Ln:0,s=n!==0||t!==0?Math.atan2(-t,-n)*Ln+90:0;return s<0&&(s+=360),[o,s,c]},l.c8=ht,l.c9=Ci,l.cA=function(n){let t=rt-5;n=ze(n,-t,t)/t*90;let i=Math.pow(Math.abs(Math.sin(ti(n))),3);return Math.round(i*(u.length-1))},l.cB=function(n,t,i,o){let c=t.getNorth(),s=t.getSouth(),b=t.getWest(),W=t.getEast(),R=1<<n.z,I=W-b,h=c-s,Z=I/p,F=-h/u[i],V=[0,Z,0,F,0,0,c,b,0];if(n.z>0){let G=180/o;ut.mat3.multiply(V,V,[G/I+1,0,0,0,G/h+1,0,-.5*G/Z,.5*G/F,1])}return V[2]=R,V[5]=n.x,V[8]=n.y,V},l.cC=no,l.cD=function(n,t,i){let o=ut.mat4.identity(new Float64Array(16)),c=(t/(1<<n)-.5)*Math.PI*2;return ut.mat4.rotateY(o,i.globeMatrix,c),Float32Array.from(o)},l.cE=class{isDataAvailableAtPoint(n){let t=this._source();if(this.isUsingMockSource()||!t||n.y<0||n.y>1)return!1;let i=t.getSource().maxzoom,o=1<<i,c=Math.floor(n.x),s=Math.floor((n.x-c)*o),b=Math.floor(n.y*o),W=this.findDEMTileFor(new Ti(i,c,i,s,b));return!(!W||!W.dem)}getAtPointOrZero(n,t=0){return this.getAtPoint(n,t)||0}getAtPoint(n,t,i=!0){if(this.isUsingMockSource())return null;t==null&&(t=null);let o=this._source();if(!o||n.y<0||n.y>1)return t;let c=o.getSource().maxzoom,s=1<<c,b=Math.floor(n.x),W=n.x-b,R=new Ti(c,b,c,Math.floor(W*s),Math.floor(n.y*s)),I=this.findDEMTileFor(R);if(!I||!I.dem)return t;let h=I.dem,Z=1<<I.tileID.canonical.z,F=(W*Z-I.tileID.canonical.x)*h.dim,V=(n.y*Z-I.tileID.canonical.y)*h.dim,G=Math.floor(F),N=Math.floor(V);return(i?this.exaggeration():1)*Je(Je(h.get(G,N),h.get(G,N+1),V-N),Je(h.get(G+1,N),h.get(G+1,N+1),V-N),F-G)}getAtTileOffset(n,t,i){let o=1<<n.canonical.z;return this.getAtPointOrZero(new Nt(n.wrap+(n.canonical.x+t/ne)/o,(n.canonical.y+i/ne)/o))}getAtTileOffsetFunc(n,t,i,o){return c=>{let s=this.getAtTileOffset(n,c.x,c.y),b=o.upVector(n.canonical,c.x,c.y),W=o.upVectorScale(n.canonical,t,i).metersToTile;return ut.vec3.scale(b,b,s*W),b}}getForTilePoints(n,t,i,o){if(this.isUsingMockSource())return!1;let c=rc.create(this,n,o);return!!c&&(t.forEach(s=>{s[2]=this.exaggeration()*c.getElevationAt(s[0],s[1],i)}),!0)}getMinMaxForTile(n){if(this.isUsingMockSource())return null;let t=this.findDEMTileFor(n);if(!t||!t.dem)return null;let i=t.dem.tree,o=t.tileID,c=1<<n.canonical.z-o.canonical.z,s=n.canonical.x/c-o.canonical.x,b=n.canonical.y/c-o.canonical.y,W=0;for(let R=0;R<n.canonical.z-o.canonical.z&&!i.leaves[W];R++){s*=2,b*=2;let I=2*Math.floor(b)+Math.floor(s);W=i.childOffsets[W]+I,s%=1,b%=1}return{min:this.exaggeration()*i.minimums[W],max:this.exaggeration()*i.maximums[W]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(n,t,i){throw new Error("Pure virtual method called.")}pointCoordinate(n){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(n){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let n=this.visibleDemTiles;if(n.length===0)return null;let t=!1,i=Number.MAX_VALUE,o=Number.MIN_VALUE;for(let c of n){let s=this.getMinMaxForTile(c.tileID);s&&(i=Math.min(i,s.min),o=Math.max(o,s.max),t=!0)}return t?{min:i,max:o}:null}},l.cF=xu,l.cG=No,l.cH=function(n,t){return[Math.pow(n[0],2.2)*t,Math.pow(n[1],2.2)*t,Math.pow(n[2],2.2)*t]},l.cI=bu,l.cJ=ot,l.cK=_,l.cL=256,l.cM=function(n,t){let i=[0,0,0],o=Hh(no(t.canonical));return ut.vec3.transformMat4(i,i,o),ut.vec3.transformMat4(i,i,n),i},l.cN=n=>({u_camera_to_center_distance:new wa(n),u_extrude_scale:new vb(n),u_device_pixel_ratio:new wa(n),u_matrix:new xr(n),u_inv_rot_matrix:new xr(n),u_merc_center:new cl(n),u_tile_id:new Qb(n),u_zoom_transition:new wa(n),u_up_dir:new Qb(n),u_emissive_strength:new wa(n)}),l.cO=n=>({u_matrix:new xr(n),u_pixels_to_tile_units:new vb(n),u_device_pixel_ratio:new wa(n),u_units_to_pixels:new cl(n),u_dash_image:new Uo(n),u_gradient_image:new Uo(n),u_image_height:new wa(n),u_texsize:new cl(n),u_tile_units_to_pixels:new wa(n),u_alpha_discard_threshold:new wa(n),u_trim_offset:new cl(n),u_trim_fade_range:new cl(n),u_trim_color:new qd(n),u_emissive_strength:new wa(n)}),l.cP=n=>({u_matrix:new xr(n),u_texsize:new cl(n),u_pixels_to_tile_units:new vb(n),u_device_pixel_ratio:new wa(n),u_image:new Uo(n),u_units_to_pixels:new cl(n),u_tile_units_to_pixels:new wa(n),u_alpha_discard_threshold:new wa(n),u_trim_offset:new cl(n)}),l.cQ=Pa,l.cR=rU,l.cS=dU,l.cT=Wu,l.cU=(n,t,i,o,c,s)=>{let b=n.transform,W=b.projection.name==="globe",R;if(s.paint.get("circle-pitch-alignment")==="map")if(W){let h=bu(b.zoom,t.canonical)*b._pixelsPerMercatorPixel;R=Float32Array.from([h,0,0,h])}else R=b.calculatePixelsToTileUnitsMatrix(i);else R=new Float32Array([b.pixelsToGLUnits[0],0,0,b.pixelsToGLUnits[1]]);let I={u_camera_to_center_distance:n.transform.getCameraToCenterDistance(b.projection),u_matrix:n.translatePosMatrix(t.projMatrix,i,s.paint.get("circle-translate"),s.paint.get("circle-translate-anchor")),u_device_pixel_ratio:ce.devicePixelRatio,u_extrude_scale:R,u_inv_rot_matrix:mI,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:s.paint.get("circle-emissive-strength")};if(W){I.u_inv_rot_matrix=o,I.u_merc_center=c,I.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],I.u_zoom_transition=Fs(b.zoom);let h=c[0]*ne,Z=c[1]*ne;I.u_up_dir=b.projection.upVector(new Va(0,0,0),h,Z)}return I},l.cV=IZ,l.cW=(n,t,i,o,c,s)=>{let b=n.transform;return{u_matrix:FZ(n,t,i,o),u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:b.calculatePixelsToTileUnitsMatrix(t),u_device_pixel_ratio:c,u_image:0,u_tile_units_to_pixels:GZ(t,b),u_units_to_pixels:[1/b.pixelsToGLUnits[0],1/b.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:s}},l.cX=(n,t,i,o,c,s,b)=>{let W=n.transform,R=W.calculatePixelsToTileUnitsMatrix(t);return{u_matrix:FZ(n,t,i,o),u_pixels_to_tile_units:R,u_device_pixel_ratio:s,u_units_to_pixels:[1/W.pixelsToGLUnits[0],1/W.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:c,u_texsize:UZ(i)&&t.lineAtlasTexture?t.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:GZ(t,n.transform),u_alpha_discard_threshold:0,u_trim_offset:b,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toRenderColor(i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength")}},l.cY=As,l.cZ=zb,l.c_=cZ,l.ca=Wn,l.cb=function(n){return[Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)]},l.cc=function(n){return n({pluginStatus:Ia,pluginURL:Kl}),Rb.on("pluginStateChange",n),n},l.cd=dc,l.ce=N0,l.cf=nc,l.cg=GW,l.ch=kc,l.ci=Uh,l.cj=fe,l.ck=an,l.cl=Xn,l.cm=function(n){let t=n.indexOf(hs);return t>=0?n.slice(0,t):n},l.cn=function(n){return n.indexOf(hs)>=0},l.co=function(n){let t=n.indexOf(hs);return t>=0?n.slice(t+1):""},l.cp=function(n){let t=[],i=n.id;return i===void 0&&t.push({message:`layers.${i}: missing required property "id"`}),n.render===void 0&&t.push({message:`layers.${i}: missing required method "render"`}),n.renderingMode&&n.renderingMode!=="2d"&&n.renderingMode!=="3d"&&t.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),t},l.cq=function(n,t,i,o){return n.type==="custom"?new EU(n,t):new KU[n.type](n,t,i,o)},l.cr=So,l.cs=Rb,l.ct=_s,l.cu=fb,l.cv=class extends Cl{constructor(n){super(n),this.current=Ep}set(n,t,i){if(this.fetchUniformLocation(n,t)){for(let o=0;o<9;o++)if(i[o]!==this.current[o]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},l.cw=Ul,l.cx=function(n,t,i){let o=Fs(i.zoom),c=n.style.map._antialias,s=t.options.extStandardDerivativesForceOff||n.terrain&&n.terrain.exaggeration()>0;return o===0&&!c&&!s},l.cy=function(n){let t=n.pixelsPerMeter,i=t/K(1,n.center.lat),o=ut.mat4.identity(new Float64Array(16));return ut.mat4.translate(o,o,[n.point.x,n.point.y,0]),ut.mat4.scale(o,o,[i,i,t]),Float32Array.from(o)},l.cz=wh,l.d=function(n){return pt.API_TILEJSON_REGEX.test(n)},l.d$=lt,l.d0=e0,l.d1=Us,l.d2=450,l.d3=7,l.d4=vU,l.d5=pi,l.d6=Od,l.d7=256,l.d8=Dp,l.d9=to,l.dA=hu,l.dB=function(n){let t=[0,0,0],i=ut.mat4.identity(new Float64Array(16));return ut.mat4.multiply(i,n.pixelMatrix,n.globeMatrix),ut.vec3.transformMat4(t,t,i),new ee(t[0],t[1])},l.dC=function(n,t,i=!1){if(Ia===pr||Ia===Wr||Ia===Qd)throw new Error("setRTLTextPlugin cannot be called multiple times.");Kl=ce.resolveURL(n),Ia=pr,ds=t,Vb(),i||Fb()},l.dD=Gb,l.dE=function(){N0().acquire(AW)},l.dF=function(){let n=Wm;n&&(n.isPreloaded()&&n.numActive()===1?(n.release(AW),Wm=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},l.dG=pm,l.dH=function(n){let t=zi();if(!t)return;let i=t.delete(Ee);n&&i.catch(n).then(()=>n())},l.dI=hm,l.dJ=iV,l.dK=function(n){HW=ce.resolveURL(n),mc||(mc=new dc(N0(),new zo)),mc.broadcast("setDracoUrl",HW)},l.dL=aV,l.dM=function(n){bc=ce.resolveURL(n),mc||(mc=new dc(N0(),new zo)),mc.broadcast("setMeshoptUrl",bc)},l.dN=he,l.dO=Is,l.dP=Ql,l.dQ=mV,l.dR=pV,l.dS=uZ,l.dT=co,l.dU=HZ,l.dV=function(n,t,i,o,c,s,b,W,R,I,h){n.createArrays(),n.tilePixelRatio=ne/(512*n.overscaling),n.compareText={},n.iconsNeedLinear=!1;let Z=n.layers[0].layout,F=n.layers[0]._unevaluatedLayout._values,V={};if(n.textSizeData.kind==="composite"){let{minZoom:M,maxZoom:S}=n.textSizeData;V.compositeTextSizes=[F["text-size"].possiblyEvaluate(new ji(M),W),F["text-size"].possiblyEvaluate(new ji(S),W)]}if(n.iconSizeData.kind==="composite"){let{minZoom:M,maxZoom:S}=n.iconSizeData;V.compositeIconSizes=[F["icon-size"].possiblyEvaluate(new ji(M),W),F["icon-size"].possiblyEvaluate(new ji(S),W)]}V.layoutTextSize=F["text-size"].possiblyEvaluate(new ji(R+1),W),V.layoutIconSize=F["icon-size"].possiblyEvaluate(new ji(R+1),W),V.textMaxSize=F["text-size"].possiblyEvaluate(new ji(18),W);let G=Z.get("text-rotation-alignment")==="map"&&Z.get("symbol-placement")!=="point",N=Z.get("text-size"),X=!1;for(let M of n.features)if(M.icon&&M.icon.nameSecondary){X=!0;break}for(let M of n.features){let S=Z.get("text-font").evaluate(M,{},W).join(","),f=N.evaluate(M,{},W),T=V.layoutTextSize.evaluate(M,{},W),v=(V.layoutIconSize.evaluate(M,{},W),{horizontal:{},vertical:void 0}),L=M.text,D,q=[0,0];if(L){let st=L.toString(),it=Z.get("text-letter-spacing").evaluate(M,{},W)*Ma,dt=Z.get("text-line-height").evaluate(M,{},W)*Ma,Zt=Jp(st)?it:0,Vt=Z.get("text-anchor").evaluate(M,{},W),Rt=Z.get("text-variable-anchor");if(!Rt){let At=Z.get("text-radial-offset").evaluate(M,{},W);q=At?PZ(Vt,[At*Ma,FW]):Z.get("text-offset").evaluate(M,{},W).map(Ct=>Ct*Ma)}let Ft=G?"center":Z.get("text-justify").evaluate(M,{},W),yt=Z.get("symbol-placement")==="point",xt=yt?Z.get("text-max-width").evaluate(M,{},W)*Ma:1/0,ft=At=>{n.allowVerticalPlacement&&Cd(st)&&(v.vertical=gW(L,t,i,c,S,xt,dt,Vt,At,Zt,q,qn.vertical,!0,T,f))};if(!G&&Rt){let At=Ft==="auto"?Rt.map(se=>IW(se)):[Ft],Ct=!1;for(let se=0;se<At.length;se++){let ae=At[se];if(!v.horizontal[ae])if(Ct)v.horizontal[ae]=v.horizontal[0];else{let Pt=gW(L,t,i,c,S,xt,dt,"center",ae,Zt,q,qn.horizontal,!1,T,f);Pt&&(v.horizontal[ae]=Pt,Ct=Pt.positionedLines.length===1)}}ft("left")}else{if(Ft==="auto"&&(Ft=IW(Vt)),yt||Z.get("text-writing-mode").indexOf("horizontal")>=0||!Cd(st)){let At=gW(L,t,i,c,S,xt,dt,Vt,Ft,Zt,q,qn.horizontal,!1,T,f);At&&(v.horizontal[Ft]=At)}ft(yt?"left":Ft)}}let tt=!1;if(M.icon&&M.icon.namePrimary){let st=o[M.icon.namePrimary];st&&(D=VU(c[M.icon.namePrimary],M.icon.nameSecondary?c[M.icon.nameSecondary]:void 0,Z.get("icon-offset").evaluate(M,{},W),Z.get("icon-anchor").evaluate(M,{},W)),tt=st.sdf,n.sdfIcons===void 0?n.sdfIcons=st.sdf:n.sdfIcons!==st.sdf&&mi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(st.pixelRatio!==n.pixelRatio||Z.get("icon-rotate").constantOr(1)!==0)&&(n.iconsNeedLinear=!0))}let P=qZ(v.horizontal)||v.vertical;n.iconsInText||(n.iconsInText=!!P&&P.iconsInText),(P||D)&&NU(n,M,v,D,o,V,T,0,q,tt,b,W,I,h,X)}s&&n.generateCollisionDebugBuffers(R,n.collisionBoxArray)},l.dW=ec,l.dX=x0,l.dY=Il,l.dZ=Lu,l.d_=yZ,l.da=Tl,l.db=Mb,l.dc=function(n,t,i,o,c){return ze((n-t)/(i-t)*(c-o)+o,o,c)},l.dd=Nd,l.de=gt,l.df=class{constructor(n,t,i,o){this.context=n,this.format=o,this.size=i,this.texture=n.gl.createTexture();let[c,s,b]=this.size,{gl:W}=n;W.bindTexture(W.TEXTURE_3D,this.texture),n.pixelStoreUnpackFlipY.set(!1),n.pixelStoreUnpack.set(1),n.pixelStoreUnpackPremultiplyAlpha.set(!1),W.texImage3D(W.TEXTURE_3D,0,this.format,c,s,b,0,yW(this.format),BW(this.format),t.data)}bind(n,t){let{context:i}=this,{gl:o}=i;o.bindTexture(o.TEXTURE_3D,this.texture),n!==this.minFilter&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MAG_FILTER,n),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MIN_FILTER,n),this.minFilter=n),t!==this.wrapS&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_S,t),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_T,t),this.wrapS=t)}destroy(){let{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}},l.dg=kW,l.dh=[1,1,1],l.di=rc,l.dj=sc,l.dk=eo,l.dl=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new ee(1/0,1/0),max:new ee(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(n,t=!1){let i=Ou(new ee(0,0),new ee(ne,ne),n),o=[];if(t&&!sW(i,this._globalClipBounds))return o;for(let c of this._activeRegions){if(c.hiddenByOverlap||!sW(i,c))continue;let s=kI(c.min,c.max,n);o.push({min:s.min,max:s.max,sourceId:this._sourceIds[c.priority],footprint:c.footprint,footprintTileId:c.tileId,order:c.order,clipMask:c.clipMask,clipScope:c.clipScope})}return o}setSources(n){this._setSources(n.map(t=>({getSourceId:()=>t.cache.id,getFootprints:()=>{let i=[];for(let o of t.cache.getVisibleCoordinates()){let c=t.cache.getTile(o).buckets[t.layer];c&&c.updateFootprints(o.toUnwrapped(),i)}return i},getOrder:()=>t.order,getClipMask:()=>t.clipMask,getClipScope:()=>t.clipScope})))}_addSource(n){let t=n.getFootprints();if(t.length===0)return;let i=n.getOrder(),o=n.getClipMask(),c=n.getClipScope();for(let s of t){if(!s.footprint)continue;let b=Ou(s.footprint.min,s.footprint.max,s.id);this._activeRegions.push({min:b.min,max:b.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:s.id,footprint:s.footprint,order:i,clipMask:o,clipScope:c})}this._sourceIds.push(n.getSourceId())}_computeReplacement(){this._activeRegions.sort((t,i)=>t.priority-i.priority||$h(t.min,i.min)||$h(t.max,i.max)||t.order-i.order||t.clipMask-i.clipMask||function(o,c){let s=(b,W)=>b+W;return o.length-c.length||o.reduce(s,"").localeCompare(c.reduce(s,""))}(t.clipScope,i.clipScope));let n=this._activeRegions.length!==this._prevRegions.length;if(!n){let t=0;for(;!n&&t!==this._activeRegions.length;){let i=this._activeRegions[t],o=this._prevRegions[t];n=i.priority!==o.priority||!ju(i,o)||i.order!==o.order||i.clipMask!==o.clipMask||!il(i.clipScope,o.clipScope),++t}}if(n){++this._updateTime;for(let i of this._activeRegions)i.order!==qh&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));let t=i=>{let o=this._activeRegions;if(i>=o.length)return i;let c=o[i].priority;for(;i<o.length&&o[i].priority===c;)++i;return i};if(this._sourceIds.length>1){let i=0,o=t(i);for(;i!==o;){let c=i,s=i;for(;c!==o;){let b=this._activeRegions[c];b.hiddenByOverlap=!1;for(let W=0;W<s;W++){let R=this._activeRegions[W];if(!R.hiddenByOverlap&&b.order===qh&&sW(b,R)&&(b.hiddenByOverlap=_u(b.footprint,b.tileId,R.footprint,R.tileId),b.hiddenByOverlap))break}++c}i=o,o=t(i)}}}}_setSources(n){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let t=n.length-1;t>=0;t--)this._addSource(n[t]);this._computeReplacement()}},l.dm=class{constructor(n){this._createGrid(n),this._createPoles(n)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(let n of this._poleSegments)n.destroy();for(let n of this._gridSegments)n.withSkirts.destroy(),n.withoutSkirts.destroy()}_fillGridMeshWithLods(n,t){let i=new ql,o=new Ja,c=[],s=n+1+2,b=t[0]+1,W=t[0]+1+(1+t.length),R=(I,h,Z)=>{let F=I===s-1?I-2:I===0?I:I-1;return F+=Z?24575:0,[F,h]};for(let I=0;I<s;++I)i.emplaceBack(...R(I,0,!0));for(let I=0;I<b;++I)for(let h=0;h<s;++h)i.emplaceBack(...R(h,I,(h===0||h===s-1)&&!0));for(let I=0;I<t.length;++I){let h=t[I];for(let Z=0;Z<s;++Z)i.emplaceBack(...R(Z,h,!0))}for(let I=0;I<t.length;++I){let h=o.length,Z=t[I]+1+2,F=new Ja;for(let N=0;N<Z-1;N++){let X=N===Z-2,M=X?s*(W-t.length+I-N):s;for(let S=0;S<s-1;S++){let f=N*s+S;N===0||X||S===0||S===s-2?(F.emplaceBack(f+1,f,f+M),F.emplaceBack(f+M,f+M+1,f+1)):(o.emplaceBack(f+1,f,f+M),o.emplaceBack(f+M,f+M+1,f+1))}}let V=Oi.simpleSegment(0,h,i.length,o.length-h);for(let N=0;N<F.uint16.length;N+=3)o.emplaceBack(F.uint16[N],F.uint16[N+1],F.uint16[N+2]);let G=Oi.simpleSegment(0,h,i.length,o.length-h);c.push({withoutSkirts:V,withSkirts:G})}return{vertices:i,indices:o,segments:c}}_createGrid(n){let t=this._fillGridMeshWithLods(p,u);this._gridSegments=t.segments,this._gridBuffer=n.createVertexBuffer(t.vertices,Tn.members),this._gridIndexBuffer=n.createIndexBuffer(t.indices,!0)}_createPoles(n){let t=new Ja;for(let b=0;b<=p;b++)t.emplaceBack(0,b+1,b+2);this._poleIndexBuffer=n.createIndexBuffer(t,!0);let i=new Tl,o=new Tl,c=new Tl,s=new Tl;this._poleSegments=[];for(let b=0,W=0;b<a;b++){let R=360/(1<<b);i.emplaceBack(0,-e,0,.5,0),o.emplaceBack(0,-e,0,.5,1),c.emplaceBack(0,-e,0,.5,.5),s.emplaceBack(0,-e,0,.5,.5);for(let I=0;I<=p;I++){let h=I/p,Z=0,F=Je(0,R,h),[V,G,N]=y(cI,bI,F,e);i.emplaceBack(V,G,N,h,Z),o.emplaceBack(V,G,N,h,1-Z);let X=ti(F);h=.5+.5*Math.sin(X),Z=.5+.5*Math.cos(X),c.emplaceBack(V,G,N,h,Z),s.emplaceBack(V,G,N,h,1-Z)}this._poleSegments.push(Oi.simpleSegment(W,0,66,64)),W+=66}this._poleNorthVertexBuffer=n.createVertexBuffer(i,Fn,!1),this._poleSouthVertexBuffer=n.createVertexBuffer(o,Fn,!1),this._texturedPoleNorthVertexBuffer=n.createVertexBuffer(c,Fn,!1),this._texturedPoleSouthVertexBuffer=n.createVertexBuffer(s,Fn,!1)}getGridBuffers(n,t){return[this._gridBuffer,this._gridIndexBuffer,t?this._gridSegments[n].withSkirts:this._gridSegments[n].withoutSkirts]}getPoleBuffers(n,t){return[t?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,t?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[n]]}},l.dn=qh,l.dp=fa,l.dq=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},l.dr=zn,l.ds=Wt,l.dt=B,l.du=function([n,t,i]){let o=Math.hypot(n,t,i),c=Math.atan2(n,i),s=.5*Math.PI-Math.acos(-t/o);return new Q(sa(c),sa(s))},l.dv=CW,l.dw=C,l.dx=function(n){let t=n.navigator?n.navigator.userAgent:null;return!!function(i){if(Os==null){let o=i.navigator?i.navigator.userAgent:null;Os=!!i.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return Os}(n)&&t&&(t.match("Version/15.4")||t.match("Version/15.5")||t.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},l.dy=function(n,t){ve=n,Vi=t},l.dz=Pp,l.e=pt,l.e0=function(n){let t=0;if(new Uint32Array(n,0,1)[0]!==lV){let i=new Uint32Array(n,0,7),[,,o,c,s,b]=i;t=i.byteLength+c+s+b+s,(o!==n.byteLength||t>=n.byteLength)&&mi("Invalid b3dm header information.")}return dV(n,t)},l.e1=function(n,t){let i=bV(n);for(let o of i){for(let c of o.meshes)Qx(c);o.lights&&(o.lightMeshIndex=o.meshes.length,o.meshes.push(fx(o.lights,t)))}return i},l.e2=U0,l.e3=vg,l.e4=sn,l.e5=function(n){ra(),Oe?.then(t=>{t.keys().then(i=>{for(let o=0;o<i.length-n;o++)t.delete(i[o])})})},l.f=function(n){return n.indexOf("mapbox:")===0},l.g=function(n,t){return _s(Fa(n,{method:"GET"}),t)},l.h=mt,l.i=function(n){return pt.API_STYLE_REGEX.test(n)&&!Ut(n)},l.j=function(n){return decodeURIComponent(atob(n).split("").map(t=>"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)).join(""))},l.k=function(n){return btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,(t,i)=>String.fromCharCode(+("0x"+i))))},l.l=Fa,l.m=Ya,l.n=function(n,t){return _s(Fa(n,{type:"json"}),t)},l.o=ll,l.p=function(n,t){return _s(Fa(n,{method:"POST"}),t)},l.q=ce,l.r=$a,l.s=function(n){try{let t=self[n];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch{return!1}},l.t=Ks,l.u=function(){return function n(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,n)}()},l.v=function(n){return!!n&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n)},l.w=mi,l.x=Hl,l.y=2,l.z=AZ}),E(["./shared"],function(l){function lt(Tt){let j=Tt?Tt.url.toString():void 0;return j?performance.getEntriesByName(j):[]}function It(Tt){if(typeof Tt=="number"||typeof Tt=="boolean"||typeof Tt=="string"||Tt==null)return JSON.stringify(Tt);if(Array.isArray(Tt)){let _="[";for(let ot of Tt)_+=`${It(ot)},`;return`${_}]`}let j="{";for(let _ of Object.keys(Tt).sort())j+=`${_}:${It(Tt[_])},`;return`${j}}`}function Gt(Tt){let j="";for(let _ of l.bg)j+=`/${It(Tt[_])}`;return j}class $t{constructor(j){this.keyCache={},this._layers={},this._layerConfigs={},j&&this.replace(j)}replace(j,_){this._layerConfigs={},this._layers={},this.update(j,[],_)}update(j,_,ot){this._options=ot;for(let mt of j)this._layerConfigs[mt.id]=mt,(this._layers[mt.id]=l.cq(mt,this.scope,null,this._options)).compileFilter(ot),this.keyCache[mt.id]&&delete this.keyCache[mt.id];for(let mt of _)delete this.keyCache[mt],delete this._layerConfigs[mt],delete this._layers[mt];this.familiesBySource={};let pt=function(mt,Ut){let Bt={};for(let Mt=0;Mt<mt.length;Mt++){let Et=Ut&&Ut[mt[Mt].id]||Gt(mt[Mt]);Ut&&(Ut[mt[Mt].id]=Et);let Qt=Bt[Et];Qt||(Qt=Bt[Et]=[]),Qt.push(mt[Mt])}let Jt=[];for(let Mt in Bt)Jt.push(Bt[Mt]);return Jt}(l.bd(this._layerConfigs),this.keyCache);for(let mt of pt){let Ut=mt.map(Dt=>this._layers[Dt.id]),Bt=Ut[0];if(Bt.visibility==="none")continue;let Jt=Bt.source||"",Mt=this.familiesBySource[Jt];Mt||(Mt=this.familiesBySource[Jt]={});let Et=Bt.sourceLayer||"_geojsonTileLayer",Qt=Mt[Et];Qt||(Qt=Mt[Et]=[]),Qt.push(Ut)}}}let Kt=1*l.dP;class Ve{constructor(j){let _={},ot=[];for(let Bt in j){let Jt=j[Bt],Mt=_[Bt]={};for(let Et in Jt.glyphs){let Qt=Jt.glyphs[+Et];if(!Qt||Qt.bitmap.width===0||Qt.bitmap.height===0)continue;let Dt=Qt.metrics.localGlyph?Kt:1,de={x:0,y:0,w:Qt.bitmap.width+2*Dt,h:Qt.bitmap.height+2*Dt};ot.push(de),Mt[Et]=de}}let{w:pt,h:mt}=l.z(ot),Ut=new l.dO({width:pt||1,height:mt||1});for(let Bt in j){let Jt=j[Bt];for(let Mt in Jt.glyphs){let Et=Jt.glyphs[+Mt];if(!Et||Et.bitmap.width===0||Et.bitmap.height===0)continue;let Qt=_[Bt][Mt],Dt=Et.metrics.localGlyph?Kt:1;l.dO.copy(Et.bitmap,Ut,{x:0,y:0},{x:Qt.x+Dt,y:Qt.y+Dt},Et.bitmap)}}this.image=Ut,this.positions=_}}l.dN(Ve,"GlyphAtlas");class re{constructor(j){this.tileID=new l.aA(j.tileID.overscaledZ,j.tileID.wrap,j.tileID.canonical.z,j.tileID.canonical.x,j.tileID.canonical.y),this.tileZoom=j.tileZoom,this.uid=j.uid,this.zoom=j.zoom,this.lut=j.lut,this.canonical=j.tileID.canonical,this.pixelRatio=j.pixelRatio,this.tileSize=j.tileSize,this.source=j.source,this.scope=j.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=j.showCollisionBoxes,this.collectResourceTiming=!!j.collectResourceTiming,this.promoteId=j.promoteId,this.isSymbolTile=j.isSymbolTile,this.tileTransform=l.aK(j.tileID.canonical,j.projection),this.projection=j.projection,this.brightness=j.brightness,this.extraShadowCaster=!!j.extraShadowCaster,this.tessellationStep=j.tessellationStep}parse(j,_,ot,pt,mt){this.status="parsing",this.data=j,this.collisionBoxArray=new l.aQ;let Ut=new l.dQ(Object.keys(j.layers).sort()),Bt=new l.dR(this.tileID,this.promoteId);Bt.bucketLayerIDs=[];let Jt={},Mt=new l.dS(256,256),Et={featureIndex:Bt,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:Mt,availableImages:ot,brightness:this.brightness},Qt=_.familiesBySource[this.source];for(let ve in Qt){let Vi=j.layers[ve];if(!Vi)continue;let xi=!1,Oe=!1,Ii=!1;for(let ba of Qt[ve])ba[0].type==="symbol"?xi=!0:Oe=!0,ba[0].is3D()&&ba[0].type!=="model"&&(Ii=!0);if(this.extraShadowCaster&&!Ii||this.isSymbolTile===!0&&!xi||this.isSymbolTile===!1&&!Oe)continue;Vi.version===1&&l.w(`Vector tile source "${this.source}" layer "${ve}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let zi=Ut.encode(ve),ra=[];for(let ba=0;ba<Vi.length;ba++){let Ya=Vi.feature(ba),wn=Bt.getId(Ya,ve);ra.push({feature:Ya,id:wn,index:ba,sourceLayerIndex:zi})}for(let ba of Qt[ve]){let Ya=ba[0];(!this.extraShadowCaster||Ya.is3D()&&Ya.type!=="model")&&(this.isSymbolTile!==void 0&&Ya.type==="symbol"!==this.isSymbolTile||Ya.minzoom&&this.zoom<Math.floor(Ya.minzoom)||Ya.maxzoom&&this.zoom>=Ya.maxzoom||Ya.visibility!=="none"&&(le(ba,this.zoom,Et.brightness,ot),(Jt[Ya.id]=Ya.createBucket({index:Bt.bucketLayerIDs.length,layers:ba,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:zi,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(ra,Et,this.tileID.canonical,this.tileTransform),Bt.bucketLayerIDs.push(ba.map(wn=>wn.id))))}}let Dt,de,ce,ke;Mt.trim();let fe={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Ee=()=>{if(Dt)return this.status="done",mt(Dt);if(this.extraShadowCaster)this.status="done",mt(null,{buckets:l.bd(Jt).filter(ve=>!ve.isEmpty()),featureIndex:Bt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Et.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(de&&ce&&ke){let ve=new Ve(de),Vi=new l.dU(ce,ke,this.lut);for(let xi in Jt){let Oe=Jt[xi];Oe instanceof l.aR?(le(Oe.layers,this.zoom,Et.brightness,ot),l.dV(Oe,de,ve.positions,ce,Vi.iconPositions,this.showCollisionBoxes,ot,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):Oe.hasPattern&&(Oe instanceof l.aX||Oe instanceof l.aY||Oe instanceof l.d0)&&(le(Oe.layers,this.zoom,Et.brightness,ot),Oe.addFeatures(Et,this.tileID.canonical,Vi.patternPositions,ot,this.tileTransform,this.brightness))}this.status="done",mt(null,{buckets:l.bd(Jt).filter(xi=>!xi.isEmpty()),featureIndex:Bt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:ve.image,lineAtlas:Mt,imageAtlas:Vi,brightness:Et.brightness})}};if(!this.extraShadowCaster){let ve=l.dT(Et.glyphDependencies,Oe=>Object.keys(Oe).map(Number));Object.keys(ve).length?pt.send("getGlyphs",{uid:this.uid,stacks:ve,scope:this.scope},(Oe,Ii)=>{Dt||(Dt=Oe,de=Ii,Ee())},void 0,!1,fe):de={};let Vi=Object.keys(Et.iconDependencies);Vi.length?pt.send("getImages",{icons:Vi,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Oe,Ii)=>{Dt||(Dt=Oe,ce=Ii,Ee())},void 0,!1,fe):ce={};let xi=Object.keys(Et.patternDependencies);xi.length?pt.send("getImages",{icons:xi,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Oe,Ii)=>{Dt||(Dt=Oe,ke=Ii,Ee())},void 0,!1,fe):ke={}}Ee()}}function le(Tt,j,_,ot){let pt=new l.a3(j,{brightness:_});for(let mt of Tt)mt.recalculate(pt,ot)}class je extends l.E{constructor(j,_,ot,pt,mt,Ut){super(),this.actor=j,this.layerIndex=_,this.availableImages=ot,this.loadVectorData=mt||l.aw,this.loading={},this.loaded={},this.deduped=new l.au(j.scheduler),this.isSpriteLoaded=pt,this.scheduler=j.scheduler,this.brightness=Ut}loadTile(j,_){let ot=j.uid,pt=j&&j.request,mt=pt&&pt.collectResourceTiming,Ut=this.loading[ot]=new re(j);Ut.abort=this.loadVectorData(j,(Bt,Jt)=>{let Mt=!this.loading[ot];if(delete this.loading[ot],Mt||Bt||!Jt)return Ut.status="done",Mt||(this.loaded[ot]=Ut),_(Bt);let Et=Jt.rawData,Qt={};Jt.expires&&(Qt.expires=Jt.expires),Jt.cacheControl&&(Qt.cacheControl=Jt.cacheControl),Ut.vectorTile=Jt.vectorTile||new l.dW.VectorTile(new l.bb(Et));let Dt=()=>{Ut.parse(Ut.vectorTile,this.layerIndex,this.availableImages,this.actor,(de,ce)=>{if(de||!ce)return _(de);let ke={};if(mt){let fe=lt(pt);fe.length>0&&(ke.resourceTiming=JSON.parse(JSON.stringify(fe)))}_(null,l.l({rawTileData:Et.slice(0)},ce,Qt,ke))})};this.isSpriteLoaded?Dt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Dt,{type:"parseTile",isSymbolTile:j.isSymbolTile,zoom:j.tileZoom}):Dt()}),this.loaded=this.loaded||{},this.loaded[ot]=Ut})}reloadTile(j,_){let ot=this.loaded,pt=j.uid;if(ot&&ot[pt]){let mt=ot[pt];mt.showCollisionBoxes=j.showCollisionBoxes,mt.projection=j.projection,mt.brightness=j.brightness,mt.tileTransform=l.aK(j.tileID.canonical,j.projection),mt.extraShadowCaster=j.extraShadowCaster,mt.lut=j.lut;let Ut=(Bt,Jt)=>{let Mt=mt.reloadCallback;Mt&&(delete mt.reloadCallback,mt.parse(mt.vectorTile,this.layerIndex,this.availableImages,this.actor,Mt)),_(Bt,Jt)};mt.status==="parsing"?mt.reloadCallback=Ut:mt.status==="done"&&(mt.vectorTile?mt.parse(mt.vectorTile,this.layerIndex,this.availableImages,this.actor,Ut):Ut())}else _(null,void 0)}abortTile(j,_){let ot=j.uid,pt=this.loading[ot];pt&&(pt.abort&&pt.abort(),delete this.loading[ot]),_()}removeTile(j,_){let ot=this.loaded,pt=j.uid;ot&&ot[pt]&&delete ot[pt],_()}}class Ze{loadTile(j,_){let{uid:ot,encoding:pt,rawImageData:mt,padding:Ut}=j,Bt=ImageBitmap&&mt instanceof ImageBitmap?this.getImageData(mt,Ut):mt;_(null,new l.dX(ot,Bt,pt,Ut<1))}getImageData(j,_){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(j.width,j.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=j.width,this.offscreenCanvas.height=j.height,this.offscreenCanvasContext.drawImage(j,0,0,j.width,j.height);let ot=this.offscreenCanvasContext.getImageData(-_,-_,j.width+2*_,j.height+2*_);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ot}}l.ba.setPbf(l.bb);class ii{decodeRasterArray({task:j,buffer:_},ot){l.ba.performDecoding(_,j).then(pt=>{ot(null,pt)},pt=>{ot(pt)})}}let bi=l.dW.VectorTileFeature.prototype.toGeoJSON;class Xe{constructor(j){this._feature=j,this.extent=l.ab,this.type=j.type,this.properties=j.tags,"id"in j&&!isNaN(j.id)&&(this.id=parseInt(j.id,10))}loadGeometry(){if(this._feature.type===1){let j=[];for(let _ of this._feature.geometry)j.push([new l.P(_[0],_[1])]);return j}{let j=[];for(let _ of this._feature.geometry){let ot=[];for(let pt of _)ot.push(new l.P(pt[0],pt[1]));j.push(ot)}return j}}toGeoJSON(j,_,ot){return bi.call(this,j,_,ot)}}class vi{constructor(j){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=l.ab,this.length=j.length,this._features=j}feature(j){return new Xe(this._features[j])}}let we=64/4096,We=128;class _e{constructor(){this.features=new Map}clear(){this.features.clear()}load(j=[],_){for(let ot of j){let pt=ot.id;if(pt==null)continue;let mt=this.features.get(pt);mt&&this.updateCache(mt,_),ot.geometry?(mt=Re(ot),this.updateCache(mt,_),this.features.set(pt,mt)):this.features.delete(pt),this.updateCache(mt,_)}}updateCache(j,_){for(let{canonical:ot,uid:pt}of Object.values(_)){let{z:mt,x:Ut,y:Bt}=ot;Zi(j,Math.pow(2,mt),Ut,Bt)&&delete _[pt]}}getTile(j,_,ot){let pt=Math.pow(2,j),mt=[];for(let Ut of this.features.values())Zi(Ut,pt,_,ot)&&mt.push(Sa(Ut,pt,_,ot));return{features:mt}}getFeatures(){return[...this.features.values()]}}function Zi({minX:Tt,minY:j,maxX:_,maxY:ot},pt,mt,Ut){return Tt<(mt+1+we)/pt&&j<(Ut+1+we)/pt&&_>(mt-we)/pt&&ot>(Ut-we)/pt}function Re(Tt){let{id:j,geometry:_,properties:ot}=Tt;if(!_)return;if(_.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");let{type:pt,coordinates:mt}=_,Ut={id:j,type:1,geometry:[],tags:ot,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Bt=Ut.geometry;if(pt==="Point")Fe(mt,Bt,Ut);else if(pt==="MultiPoint")for(let Jt of mt)Fe(Jt,Bt,Ut);else if(pt==="LineString")Ut.type=2,wi(mt,Bt,Ut);else if(pt==="MultiLineString")Ut.type=2,Pi(mt,Bt,Ut);else if(pt==="Polygon")Ut.type=3,Pi(mt,Bt,Ut,!0);else{if(pt!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");Ut.type=3;for(let Jt of mt)Pi(Jt,Bt,Ut,!0)}return Ut}function Fe([Tt,j],_,ot){let pt=l.am(Tt),mt=l.at(j);mt=mt<0?0:mt>1?1:mt,_.push(pt,mt),ot.minX=Math.min(ot.minX,pt),ot.minY=Math.min(ot.minY,mt),ot.maxX=Math.max(ot.maxX,pt),ot.maxY=Math.max(ot.maxY,mt)}function wi(Tt,j,_,ot=!1,pt=!1){let mt=[];for(let Ut of Tt)Fe(Ut,mt,_);j.push(mt),ot&&function(Ut,Bt){let Jt=0;for(let Mt=0,Et=Ut.length,Qt=Et-2;Mt<Et;Qt=Mt,Mt+=2)Jt+=(Ut[Mt]-Ut[Qt])*(Ut[Mt+1]+Ut[Qt+1]);if(Jt>0===Bt)for(let Mt=0,Et=Ut.length;Mt<Et/2;Mt+=2){let Qt=Ut[Mt],Dt=Ut[Mt+1];Ut[Mt]=Ut[Et-2-Mt],Ut[Mt+1]=Ut[Et-1-Mt],Ut[Et-2-Mt]=Qt,Ut[Et-1-Mt]=Dt}}(mt,pt)}function Pi(Tt,j,_,ot=!1){for(let pt=0;pt<Tt.length;pt++)wi(Tt[pt],j,_,ot,pt===0)}function Sa(Tt,j,_,ot){let{id:pt,type:mt,geometry:Ut,tags:Bt}=Tt,Jt=[];if(mt===1)(function(Mt,Et,Qt,Dt,de){for(let ce=0;ce<Mt.length;ce+=2){let ke=Math.round(l.ab*(Mt[ce+0]*Et-Qt)),fe=Math.round(l.ab*(Mt[ce+1]*Et-Dt));de.push([ke,fe])}})(Ut,j,_,ot,Jt);else for(let Mt of Ut)ye(Mt,j,_,ot,Jt);return{id:pt,type:mt,geometry:Jt,tags:Bt}}function ye(Tt,j,_,ot,pt){let mt=-We,Ut=l.ab+We,Bt;for(let Jt=0;Jt<Tt.length-2;Jt+=2){let Mt=Math.round(l.ab*(Tt[Jt+0]*j-_)),Et=Math.round(l.ab*(Tt[Jt+1]*j-ot)),Qt=Math.round(l.ab*(Tt[Jt+2]*j-_)),Dt=Math.round(l.ab*(Tt[Jt+3]*j-ot)),de=Qt-Mt,ce=Dt-Et;Mt<mt&&Qt<mt||(Mt<mt?(Et+=Math.round(ce*((mt-Mt)/de)),Mt=mt):Qt<mt&&(Dt=Et+Math.round(ce*((mt-Mt)/de)),Qt=mt),Et<mt&&Dt<mt||(Et<mt?(Mt+=Math.round(de*((mt-Et)/ce)),Et=mt):Dt<mt&&(Qt=Mt+Math.round(de*((mt-Et)/ce)),Dt=mt),Mt>=Ut&&Qt>=Ut||(Mt>=Ut?(Et+=Math.round(ce*((Ut-Mt)/de)),Mt=Ut):Qt>=Ut&&(Dt=Et+Math.round(ce*((Ut-Mt)/de)),Qt=Ut),Et>=Ut&&Dt>=Ut||(Et>=Ut?(Mt+=Math.round(de*((Ut-Et)/ce)),Et=Ut):Dt>=Ut&&(Qt=Mt+Math.round(de*((Ut-Et)/ce)),Dt=Ut),Bt&&Mt===Bt[Bt.length-1][0]&&Et===Bt[Bt.length-1][1]||(Bt=[[Mt,Et]],pt.push(Bt)),Bt.push([Qt,Dt])))))}}var aa,ya,ua,Be={exports:{}},Yn=function(){if(ua)return Be.exports;ua=1;var Tt=l.d_(),j=function(){if(ya)return aa;ya=1;var Et=l.dY(),Qt=l.dZ().VectorTileFeature;function Dt(ce,ke){this.options=ke||{},this.features=ce,this.length=ce.length}function de(ce,ke){this.id=typeof ce.id=="number"?ce.id:void 0,this.type=ce.type,this.rawGeometry=ce.type===1?[ce.geometry]:ce.geometry,this.properties=ce.tags,this.extent=ke||4096}return aa=Dt,Dt.prototype.feature=function(ce){return new de(this.features[ce],this.options.extent)},de.prototype.loadGeometry=function(){var ce=this.rawGeometry;this.geometry=[];for(var ke=0;ke<ce.length;ke++){for(var fe=ce[ke],Ee=[],ve=0;ve<fe.length;ve++)Ee.push(new Et(fe[ve][0],fe[ve][1]));this.geometry.push(Ee)}return this.geometry},de.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var ce=this.geometry,ke=1/0,fe=-1/0,Ee=1/0,ve=-1/0,Vi=0;Vi<ce.length;Vi++)for(var xi=ce[Vi],Oe=0;Oe<xi.length;Oe++){var Ii=xi[Oe];ke=Math.min(ke,Ii.x),fe=Math.max(fe,Ii.x),Ee=Math.min(Ee,Ii.y),ve=Math.max(ve,Ii.y)}return[ke,Ee,fe,ve]},de.prototype.toGeoJSON=Qt.prototype.toGeoJSON,aa}();function _(Et){var Qt=new Tt;return function(Dt,de){for(var ce in Dt.layers)de.writeMessage(3,ot,Dt.layers[ce])}(Et,Qt),Qt.finish()}function ot(Et,Qt){var Dt;Qt.writeVarintField(15,Et.version||1),Qt.writeStringField(1,Et.name||""),Qt.writeVarintField(5,Et.extent||4096);var de={keys:[],values:[],keycache:{},valuecache:{}};for(Dt=0;Dt<Et.length;Dt++)de.feature=Et.feature(Dt),Qt.writeMessage(2,pt,de);var ce=de.keys;for(Dt=0;Dt<ce.length;Dt++)Qt.writeStringField(3,ce[Dt]);var ke=de.values;for(Dt=0;Dt<ke.length;Dt++)Qt.writeMessage(4,Mt,ke[Dt])}function pt(Et,Qt){var Dt=Et.feature;Dt.id!==void 0&&Qt.writeVarintField(1,Dt.id),Qt.writeMessage(2,mt,Et),Qt.writeVarintField(3,Dt.type),Qt.writeMessage(4,Jt,Dt)}function mt(Et,Qt){var Dt=Et.feature,de=Et.keys,ce=Et.values,ke=Et.keycache,fe=Et.valuecache;for(var Ee in Dt.properties){var ve=Dt.properties[Ee],Vi=ke[Ee];if(ve!==null){Vi===void 0&&(de.push(Ee),ke[Ee]=Vi=de.length-1),Qt.writeVarint(Vi);var xi=typeof ve;xi!=="string"&&xi!=="boolean"&&xi!=="number"&&(ve=JSON.stringify(ve));var Oe=xi+":"+ve,Ii=fe[Oe];Ii===void 0&&(ce.push(ve),fe[Oe]=Ii=ce.length-1),Qt.writeVarint(Ii)}}}function Ut(Et,Qt){return(Qt<<3)+(7&Et)}function Bt(Et){return Et<<1^Et>>31}function Jt(Et,Qt){for(var Dt=Et.loadGeometry(),de=Et.type,ce=0,ke=0,fe=Dt.length,Ee=0;Ee<fe;Ee++){var ve=Dt[Ee],Vi=1;de===1&&(Vi=ve.length),Qt.writeVarint(Ut(1,Vi));for(var xi=de===3?ve.length-1:ve.length,Oe=0;Oe<xi;Oe++){Oe===1&&de!==1&&Qt.writeVarint(Ut(2,xi-1));var Ii=ve[Oe].x-ce,zi=ve[Oe].y-ke;Qt.writeVarint(Bt(Ii)),Qt.writeVarint(Bt(zi)),ce+=Ii,ke+=zi}de===3&&Qt.writeVarint(Ut(7,1))}}function Mt(Et,Qt){var Dt=typeof Et;Dt==="string"?Qt.writeStringField(1,Et):Dt==="boolean"?Qt.writeBooleanField(7,Et):Dt==="number"&&(Et%1!=0?Qt.writeDoubleField(3,Et):Et<0?Qt.writeSVarintField(6,Et):Qt.writeVarintField(5,Et))}return Be.exports=_,Be.exports.fromVectorTileJs=_,Be.exports.fromGeojsonVt=function(Et,Qt){Qt=Qt||{};var Dt={};for(var de in Et)Dt[de]=new j(Et[de].features,Qt),Dt[de].name=de,Dt[de].version=Qt.version,Dt[de].extent=Qt.extent;return _({layers:Dt})},Be.exports.GeoJSONWrapper=j,Be.exports}(),bn=l.d$(Yn);let fn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Tt=>Tt},Qe=Math.fround||(vn=new Float32Array(1),Tt=>(vn[0]=+Tt,vn[0]));var vn;let Qa=3,Ga=5,ja=6;class En{constructor(j){this.options=Object.assign(Object.create(fn),j),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(j){let{log:_,minZoom:ot,maxZoom:pt}=this.options;_&&console.time("total time");let mt=`prepare ${j.length} points`;_&&console.time(mt),this.points=j;let Ut=[];for(let Jt=0;Jt<j.length;Jt++){let Mt=j[Jt];if(!Mt.geometry)continue;let[Et,Qt]=Mt.geometry.coordinates,Dt=Qe(mn(Et)),de=Qe(el(Qt));Ut.push(Dt,de,1/0,Jt,-1,1),this.options.reduce&&Ut.push(0)}let Bt=this.trees[pt+1]=this._createTree(Ut);_&&console.timeEnd(mt);for(let Jt=pt;Jt>=ot;Jt--){let Mt=+Date.now();Bt=this.trees[Jt]=this._createTree(this._cluster(Bt,Jt)),_&&console.log("z%d: %d clusters in %dms",Jt,Bt.numItems,+Date.now()-Mt)}return _&&console.timeEnd("total time"),this}getClusters(j,_){let ot=((j[0]+180)%360+360)%360-180,pt=Math.max(-90,Math.min(90,j[1])),mt=j[2]===180?180:((j[2]+180)%360+360)%360-180,Ut=Math.max(-90,Math.min(90,j[3]));if(j[2]-j[0]>=360)ot=-180,mt=180;else if(ot>mt){let Qt=this.getClusters([ot,pt,180,Ut],_),Dt=this.getClusters([-180,pt,mt,Ut],_);return Qt.concat(Dt)}let Bt=this.trees[this._limitZoom(_)],Jt=Bt.range(mn(ot),el(Ut),mn(mt),el(pt)),Mt=Bt.data,Et=[];for(let Qt of Jt){let Dt=this.stride*Qt;Et.push(Mt[Dt+Ga]>1?Jn(Mt,Dt,this.clusterProps):this.points[Mt[Dt+Qa]])}return Et}getChildren(j){let _=this._getOriginId(j),ot=this._getOriginZoom(j),pt="No cluster with the specified id.",mt=this.trees[ot];if(!mt)throw new Error(pt);let Ut=mt.data;if(_*this.stride>=Ut.length)throw new Error(pt);let Bt=this.options.radius/(this.options.extent*Math.pow(2,ot-1)),Jt=mt.within(Ut[_*this.stride],Ut[_*this.stride+1],Bt),Mt=[];for(let Et of Jt){let Qt=Et*this.stride;Ut[Qt+4]===j&&Mt.push(Ut[Qt+Ga]>1?Jn(Ut,Qt,this.clusterProps):this.points[Ut[Qt+Qa]])}if(Mt.length===0)throw new Error(pt);return Mt}getLeaves(j,_,ot){let pt=[];return this._appendLeaves(pt,j,_=_||10,ot=ot||0,0),pt}getTile(j,_,ot){let pt=this.trees[this._limitZoom(j)],mt=Math.pow(2,j),{extent:Ut,radius:Bt}=this.options,Jt=Bt/Ut,Mt=(ot-Jt)/mt,Et=(ot+1+Jt)/mt,Qt={features:[]};return this._addTileFeatures(pt.range((_-Jt)/mt,Mt,(_+1+Jt)/mt,Et),pt.data,_,ot,mt,Qt),_===0&&this._addTileFeatures(pt.range(1-Jt/mt,Mt,1,Et),pt.data,mt,ot,mt,Qt),_===mt-1&&this._addTileFeatures(pt.range(0,Mt,Jt/mt,Et),pt.data,-1,ot,mt,Qt),Qt.features.length?Qt:null}getClusterExpansionZoom(j){let _=this._getOriginZoom(j)-1;for(;_<=this.options.maxZoom;){let ot=this.getChildren(j);if(_++,ot.length!==1)break;j=ot[0].properties.cluster_id}return _}_appendLeaves(j,_,ot,pt,mt){let Ut=this.getChildren(_);for(let Bt of Ut){let Jt=Bt.properties;if(Jt&&Jt.cluster?mt+Jt.point_count<=pt?mt+=Jt.point_count:mt=this._appendLeaves(j,Jt.cluster_id,ot,pt,mt):mt<pt?mt++:j.push(Bt),j.length===ot)break}return mt}_createTree(j){let _=new l.by(j.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ot=0;ot<j.length;ot+=this.stride)_.add(j[ot],j[ot+1]);return _.finish(),_.data=j,_}_addTileFeatures(j,_,ot,pt,mt,Ut){for(let Bt of j){let Jt=Bt*this.stride,Mt=_[Jt+Ga]>1,Et,Qt,Dt;if(Mt)Et=ut(_,Jt,this.clusterProps),Qt=_[Jt],Dt=_[Jt+1];else{let ke=this.points[_[Jt+Qa]];Et=ke.properties;let[fe,Ee]=ke.geometry.coordinates;Qt=mn(fe),Dt=el(Ee)}let de={type:1,geometry:[[Math.round(this.options.extent*(Qt*mt-ot)),Math.round(this.options.extent*(Dt*mt-pt))]],tags:Et},ce;ce=Mt||this.options.generateId?_[Jt+Qa]:this.points[_[Jt+Qa]].id,ce!==void 0&&(de.id=ce),Ut.features.push(de)}}_limitZoom(j){return Math.max(this.options.minZoom,Math.min(Math.floor(+j),this.options.maxZoom+1))}_cluster(j,_){let{radius:ot,extent:pt,reduce:mt,minPoints:Ut}=this.options,Bt=ot/(pt*Math.pow(2,_)),Jt=j.data,Mt=[],Et=this.stride;for(let Qt=0;Qt<Jt.length;Qt+=Et){if(Jt[Qt+2]<=_)continue;Jt[Qt+2]=_;let Dt=Jt[Qt],de=Jt[Qt+1],ce=j.within(Jt[Qt],Jt[Qt+1],Bt),ke=Jt[Qt+Ga],fe=ke;for(let Ee of ce){let ve=Ee*Et;Jt[ve+2]>_&&(fe+=Jt[ve+Ga])}if(fe>ke&&fe>=Ut){let Ee,ve=Dt*ke,Vi=de*ke,xi=-1,Oe=(Qt/Et<<5)+(_+1)+this.points.length;for(let Ii of ce){let zi=Ii*Et;if(Jt[zi+2]<=_)continue;Jt[zi+2]=_;let ra=Jt[zi+Ga];ve+=Jt[zi]*ra,Vi+=Jt[zi+1]*ra,Jt[zi+4]=Oe,mt&&(Ee||(Ee=this._map(Jt,Qt,!0),xi=this.clusterProps.length,this.clusterProps.push(Ee)),mt(Ee,this._map(Jt,zi)))}Jt[Qt+4]=Oe,Mt.push(ve/fe,Vi/fe,1/0,Oe,-1,fe),mt&&Mt.push(xi)}else{for(let Ee=0;Ee<Et;Ee++)Mt.push(Jt[Qt+Ee]);if(fe>1)for(let Ee of ce){let ve=Ee*Et;if(!(Jt[ve+2]<=_)){Jt[ve+2]=_;for(let Vi=0;Vi<Et;Vi++)Mt.push(Jt[ve+Vi])}}}}return Mt}_getOriginId(j){return j-this.points.length>>5}_getOriginZoom(j){return(j-this.points.length)%32}_map(j,_,ot){if(j[_+Ga]>1){let Ut=this.clusterProps[j[_+ja]];return ot?Object.assign({},Ut):Ut}let pt=this.points[j[_+Qa]].properties,mt=this.options.map(pt);return ot&&mt===pt?Object.assign({},mt):mt}}function Jn(Tt,j,_){return{type:"Feature",id:Tt[j+Qa],properties:ut(Tt,j,_),geometry:{type:"Point",coordinates:[(ot=Tt[j],360*(ot-.5)),Il(Tt[j+1])]}};var ot}function ut(Tt,j,_){let ot=Tt[j+Ga],pt=ot>=1e4?`${Math.round(ot/1e3)}k`:ot>=1e3?Math.round(ot/100)/10+"k":ot,mt=Tt[j+ja],Ut=mt===-1?{}:Object.assign({},_[mt]);return Object.assign(Ut,{cluster:!0,cluster_id:Tt[j+Qa],point_count:ot,point_count_abbreviated:pt})}function mn(Tt){return Tt/360+.5}function el(Tt){let j=Math.sin(Tt*Math.PI/180),_=.5-.25*Math.log((1+j)/(1-j))/Math.PI;return _<0?0:_>1?1:_}function Il(Tt){let j=(180-360*Tt)*Math.PI/180;return 360*Math.atan(Math.exp(j))/Math.PI-90}function ee(Tt,j,_,ot){let pt=ot,mt=j+(_-j>>1),Ut,Bt=_-j,Jt=Tt[j],Mt=Tt[j+1],Et=Tt[_],Qt=Tt[_+1];for(let Dt=j+3;Dt<_;Dt+=3){let de=il(Tt[Dt],Tt[Dt+1],Jt,Mt,Et,Qt);if(de>pt)Ut=Dt,pt=de;else if(de===pt){let ce=Math.abs(Dt-mt);ce<Bt&&(Ut=Dt,Bt=ce)}}pt>ot&&(Ut-j>3&&ee(Tt,j,Ut,ot),Tt[Ut+2]=pt,_-Ut>3&&ee(Tt,Ut,_,ot))}function il(Tt,j,_,ot,pt,mt){let Ut=pt-_,Bt=mt-ot;if(Ut!==0||Bt!==0){let Jt=((Tt-_)*Ut+(j-ot)*Bt)/(Ut*Ut+Bt*Bt);Jt>1?(_=pt,ot=mt):Jt>0&&(_+=Ut*Jt,ot+=Bt*Jt)}return Ut=Tt-_,Bt=j-ot,Ut*Ut+Bt*Bt}function Za(Tt,j,_,ot){let pt={id:Tt??null,type:j,geometry:_,tags:ot,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(j==="Point"||j==="MultiPoint"||j==="LineString")Ln(pt,_);else if(j==="Polygon")Ln(pt,_[0]);else if(j==="MultiLineString")for(let mt of _)Ln(pt,mt);else if(j==="MultiPolygon")for(let mt of _)Ln(pt,mt[0]);return pt}function Ln(Tt,j){for(let _=0;_<j.length;_+=3)Tt.minX=Math.min(Tt.minX,j[_]),Tt.minY=Math.min(Tt.minY,j[_+1]),Tt.maxX=Math.max(Tt.maxX,j[_]),Tt.maxY=Math.max(Tt.maxY,j[_+1])}function ti(Tt,j,_,ot){if(!j.geometry)return;let pt=j.geometry.coordinates;if(pt&&pt.length===0)return;let mt=j.geometry.type,Ut=Math.pow(_.tolerance/((1<<_.maxZoom)*_.extent),2),Bt=[],Jt=j.id;if(_.promoteId?Jt=j.properties[_.promoteId]:_.generateId&&(Jt=ot||0),mt==="Point")sa(pt,Bt);else if(mt==="MultiPoint")for(let Mt of pt)sa(Mt,Bt);else if(mt==="LineString")hn(pt,Bt,Ut,!1);else if(mt==="MultiLineString"){if(_.lineMetrics){for(let Mt of pt)Bt=[],hn(Mt,Bt,Ut,!1),Tt.push(Za(Jt,"LineString",Bt,j.properties));return}Ul(pt,Bt,Ut,!1)}else if(mt==="Polygon")Ul(pt,Bt,Ut,!0);else{if(mt!=="MultiPolygon"){if(mt==="GeometryCollection"){for(let Mt of j.geometry.geometries)ti(Tt,{id:Jt,geometry:Mt,properties:j.properties},_,ot);return}throw new Error("Input data is not a valid GeoJSON object.")}for(let Mt of pt){let Et=[];Ul(Mt,Et,Ut,!0),Bt.push(Et)}}Tt.push(Za(Jt,mt,Bt,j.properties))}function sa(Tt,j){j.push(fa(Tt[0]),zn(Tt[1]),0)}function hn(Tt,j,_,ot){let pt,mt,Ut=0;for(let Jt=0;Jt<Tt.length;Jt++){let Mt=fa(Tt[Jt][0]),Et=zn(Tt[Jt][1]);j.push(Mt,Et,0),Jt>0&&(Ut+=ot?(pt*Et-Mt*mt)/2:Math.sqrt(Math.pow(Mt-pt,2)+Math.pow(Et-mt,2))),pt=Mt,mt=Et}let Bt=j.length-3;j[2]=1,ee(j,0,Bt,_),j[Bt+2]=1,j.size=Math.abs(Ut),j.start=0,j.end=j.size}function Ul(Tt,j,_,ot){for(let pt=0;pt<Tt.length;pt++){let mt=[];hn(Tt[pt],mt,_,ot),j.push(mt)}}function fa(Tt){return Tt/360+.5}function zn(Tt){let j=Math.sin(Tt*Math.PI/180),_=.5-.25*Math.log((1+j)/(1-j))/Math.PI;return _<0?0:_>1?1:_}function ze(Tt,j,_,ot,pt,mt,Ut,Bt){if(ot/=j,mt>=(_/=j)&&Ut<ot)return Tt;if(Ut<_||mt>=ot)return null;let Jt=[];for(let Mt of Tt){let Et=Mt.geometry,Qt=Mt.type,Dt=pt===0?Mt.minX:Mt.minY,de=pt===0?Mt.maxX:Mt.maxY;if(Dt>=_&&de<ot){Jt.push(Mt);continue}if(de<_||Dt>=ot)continue;let ce=[];if(Qt==="Point"||Qt==="MultiPoint")xl(Et,ce,_,ot,pt);else if(Qt==="LineString")pn(Et,ce,_,ot,pt,!1,Bt.lineMetrics);else if(Qt==="MultiLineString")Fa(Et,ce,_,ot,pt,!1);else if(Qt==="Polygon")Fa(Et,ce,_,ot,pt,!0);else if(Qt==="MultiPolygon")for(let ke of Et){let fe=[];Fa(ke,fe,_,ot,pt,!0),fe.length&&ce.push(fe)}if(ce.length){if(Bt.lineMetrics&&Qt==="LineString"){for(let ke of ce)Jt.push(Za(Mt.id,Qt,ke,Mt.tags));continue}Qt!=="LineString"&&Qt!=="MultiLineString"||(ce.length===1?(Qt="LineString",ce=ce[0]):Qt="MultiLineString"),Qt!=="Point"&&Qt!=="MultiPoint"||(Qt=ce.length===3?"Point":"MultiPoint"),Jt.push(Za(Mt.id,Qt,ce,Mt.tags))}}return Jt.length?Jt:null}function xl(Tt,j,_,ot,pt){for(let mt=0;mt<Tt.length;mt+=3){let Ut=Tt[mt+pt];Ut>=_&&Ut<=ot&&va(j,Tt[mt],Tt[mt+1],Tt[mt+2])}}function pn(Tt,j,_,ot,pt,mt,Ut){let Bt=al(Tt),Jt=pt===0?Al:As,Mt,Et,Qt=Tt.start;for(let fe=0;fe<Tt.length-3;fe+=3){let Ee=Tt[fe],ve=Tt[fe+1],Vi=Tt[fe+2],xi=Tt[fe+3],Oe=Tt[fe+4],Ii=pt===0?Ee:ve,zi=pt===0?xi:Oe,ra=!1;Ut&&(Mt=Math.sqrt(Math.pow(Ee-xi,2)+Math.pow(ve-Oe,2))),Ii<_?zi>_&&(Et=Jt(Bt,Ee,ve,xi,Oe,_),Ut&&(Bt.start=Qt+Mt*Et)):Ii>ot?zi<ot&&(Et=Jt(Bt,Ee,ve,xi,Oe,ot),Ut&&(Bt.start=Qt+Mt*Et)):va(Bt,Ee,ve,Vi),zi<_&&Ii>=_&&(Et=Jt(Bt,Ee,ve,xi,Oe,_),ra=!0),zi>ot&&Ii<=ot&&(Et=Jt(Bt,Ee,ve,xi,Oe,ot),ra=!0),!mt&&ra&&(Ut&&(Bt.end=Qt+Mt*Et),j.push(Bt),Bt=al(Tt)),Ut&&(Qt+=Mt)}let Dt=Tt.length-3,de=Tt[Dt],ce=Tt[Dt+1],ke=pt===0?de:ce;ke>=_&&ke<=ot&&va(Bt,de,ce,Tt[Dt+2]),Dt=Bt.length-3,mt&&Dt>=3&&(Bt[Dt]!==Bt[0]||Bt[Dt+1]!==Bt[1])&&va(Bt,Bt[0],Bt[1],Bt[2]),Bt.length&&j.push(Bt)}function al(Tt){let j=[];return j.size=Tt.size,j.start=Tt.start,j.end=Tt.end,j}function Fa(Tt,j,_,ot,pt,mt){for(let Ut of Tt)pn(Ut,j,_,ot,pt,mt,!1)}function va(Tt,j,_,ot){Tt.push(j,_,ot)}function Al(Tt,j,_,ot,pt,mt){let Ut=(mt-j)/(ot-j);return va(Tt,mt,_+(pt-_)*Ut,1),Ut}function As(Tt,j,_,ot,pt,mt){let Ut=(mt-_)/(pt-_);return va(Tt,j+(ot-j)*Ut,mt,1),Ut}function ko(Tt,j){let _=[];for(let ot=0;ot<Tt.length;ot++){let pt=Tt[ot],mt=pt.type,Ut;if(mt==="Point"||mt==="MultiPoint"||mt==="LineString")Ut=Nl(pt.geometry,j);else if(mt==="MultiLineString"||mt==="Polygon"){Ut=[];for(let Bt of pt.geometry)Ut.push(Nl(Bt,j))}else if(mt==="MultiPolygon"){Ut=[];for(let Bt of pt.geometry){let Jt=[];for(let Mt of Bt)Jt.push(Nl(Mt,j));Ut.push(Jt)}}_.push(Za(pt.id,mt,Ut,pt.tags))}return _}function Nl(Tt,j){let _=[];_.size=Tt.size,Tt.start!==void 0&&(_.start=Tt.start,_.end=Tt.end);for(let ot=0;ot<Tt.length;ot+=3)_.push(Tt[ot]+j,Tt[ot+1],Tt[ot+2]);return _}function co(Tt,j){if(Tt.transformed)return Tt;let _=1<<Tt.z,ot=Tt.x,pt=Tt.y;for(let mt of Tt.features){let Ut=mt.geometry,Bt=mt.type;if(mt.geometry=[],Bt===1)for(let Jt=0;Jt<Ut.length;Jt+=2)mt.geometry.push(So(Ut[Jt],Ut[Jt+1],j,_,ot,pt));else for(let Jt=0;Jt<Ut.length;Jt++){let Mt=[];for(let Et=0;Et<Ut[Jt].length;Et+=2)Mt.push(So(Ut[Jt][Et],Ut[Jt][Et+1],j,_,ot,pt));mt.geometry.push(Mt)}}return Tt.transformed=!0,Tt}function So(Tt,j,_,ot,pt,mt){return[Math.round(_*(Tt*ot-pt)),Math.round(_*(j*ot-mt))]}function Xn(Tt,j,_,ot,pt){let mt=j===pt.maxZoom?0:pt.tolerance/((1<<j)*pt.extent),Ut={features:[],numPoints:0,numSimplified:0,numFeatures:Tt.length,source:null,x:_,y:ot,z:j,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let Bt of Tt)Hs(Ut,Bt,mt,pt);return Ut}function Hs(Tt,j,_,ot){let pt=j.geometry,mt=j.type,Ut=[];if(Tt.minX=Math.min(Tt.minX,j.minX),Tt.minY=Math.min(Tt.minY,j.minY),Tt.maxX=Math.max(Tt.maxX,j.maxX),Tt.maxY=Math.max(Tt.maxY,j.maxY),mt==="Point"||mt==="MultiPoint")for(let Bt=0;Bt<pt.length;Bt+=3)Ut.push(pt[Bt],pt[Bt+1]),Tt.numPoints++,Tt.numSimplified++;else if(mt==="LineString")mi(Ut,pt,Tt,_,!1,!1);else if(mt==="MultiLineString"||mt==="Polygon")for(let Bt=0;Bt<pt.length;Bt++)mi(Ut,pt[Bt],Tt,_,mt==="Polygon",Bt===0);else if(mt==="MultiPolygon")for(let Bt=0;Bt<pt.length;Bt++){let Jt=pt[Bt];for(let Mt=0;Mt<Jt.length;Mt++)mi(Ut,Jt[Mt],Tt,_,!0,Mt===0)}if(Ut.length){let Bt=j.tags||null;if(mt==="LineString"&&ot.lineMetrics){Bt={};for(let Mt in j.tags)Bt[Mt]=j.tags[Mt];Bt.mapbox_clip_start=pt.start/pt.size,Bt.mapbox_clip_end=pt.end/pt.size}let Jt={geometry:Ut,type:mt==="Polygon"||mt==="MultiPolygon"?3:mt==="LineString"||mt==="MultiLineString"?2:1,tags:Bt};j.id!==null&&(Jt.id=j.id),Tt.features.push(Jt)}}function mi(Tt,j,_,ot,pt,mt){let Ut=ot*ot;if(ot>0&&j.size<(pt?Ut:ot))return void(_.numPoints+=j.length/3);let Bt=[];for(let Jt=0;Jt<j.length;Jt+=3)(ot===0||j[Jt+2]>Ut)&&(_.numSimplified++,Bt.push(j[Jt],j[Jt+1])),_.numPoints++;pt&&function(Jt,Mt){let Et=0;for(let Qt=0,Dt=Jt.length,de=Dt-2;Qt<Dt;de=Qt,Qt+=2)Et+=(Jt[Qt]-Jt[de])*(Jt[Qt+1]+Jt[de+1]);if(Et>0===Mt)for(let Qt=0,Dt=Jt.length;Qt<Dt/2;Qt+=2){let de=Jt[Qt],ce=Jt[Qt+1];Jt[Qt]=Jt[Dt-2-Qt],Jt[Qt+1]=Jt[Dt-1-Qt],Jt[Dt-2-Qt]=de,Jt[Dt-1-Qt]=ce}}(Bt,mt),Tt.push(Bt)}let nl={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class $r{constructor(j,_){let ot=(_=this.options=function(mt,Ut){for(let Bt in Ut)mt[Bt]=Ut[Bt];return mt}(Object.create(nl),_)).debug;if(ot&&console.time("preprocess data"),_.maxZoom<0||_.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(_.promoteId&&_.generateId)throw new Error("promoteId and generateId cannot be used together.");let pt=function(mt,Ut){let Bt=[];if(mt.type==="FeatureCollection")for(let Jt=0;Jt<mt.features.length;Jt++)ti(Bt,mt.features[Jt],Ut,Jt);else ti(Bt,mt.type==="Feature"?mt:{geometry:mt},Ut);return Bt}(j,_);this.tiles={},this.tileCoords=[],ot&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",_.indexMaxZoom,_.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),pt=function(mt,Ut){let Bt=Ut.buffer/Ut.extent,Jt=mt,Mt=ze(mt,1,-1-Bt,Bt,0,-1,2,Ut),Et=ze(mt,1,1-Bt,2+Bt,0,-1,2,Ut);return(Mt||Et)&&(Jt=ze(mt,1,-Bt,1+Bt,0,-1,2,Ut)||[],Mt&&(Jt=ko(Mt,1).concat(Jt)),Et&&(Jt=Jt.concat(ko(Et,-1)))),Jt}(pt,_),pt.length&&this.splitTile(pt,0,0,0),ot&&(pt.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(j,_,ot,pt,mt,Ut,Bt){let Jt=[j,_,ot,pt],Mt=this.options,Et=Mt.debug;for(;Jt.length;){pt=Jt.pop(),ot=Jt.pop(),_=Jt.pop(),j=Jt.pop();let Qt=1<<_,Dt=Wn(_,ot,pt),de=this.tiles[Dt];if(!de&&(Et>1&&console.time("creation"),de=this.tiles[Dt]=Xn(j,_,ot,pt,Mt),this.tileCoords.push({z:_,x:ot,y:pt}),Et)){Et>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",_,ot,pt,de.numFeatures,de.numPoints,de.numSimplified),console.timeEnd("creation"));let ra=`z${_}`;this.stats[ra]=(this.stats[ra]||0)+1,this.total++}if(de.source=j,mt==null){if(_===Mt.indexMaxZoom||de.numPoints<=Mt.indexMaxPoints)continue}else{if(_===Mt.maxZoom||_===mt)continue;if(mt!=null){let ra=mt-_;if(ot!==Ut>>ra||pt!==Bt>>ra)continue}}if(de.source=null,j.length===0)continue;Et>1&&console.time("clipping");let ce=.5*Mt.buffer/Mt.extent,ke=.5-ce,fe=.5+ce,Ee=1+ce,ve=null,Vi=null,xi=null,Oe=null,Ii=ze(j,Qt,ot-ce,ot+fe,0,de.minX,de.maxX,Mt),zi=ze(j,Qt,ot+ke,ot+Ee,0,de.minX,de.maxX,Mt);j=null,Ii&&(ve=ze(Ii,Qt,pt-ce,pt+fe,1,de.minY,de.maxY,Mt),Vi=ze(Ii,Qt,pt+ke,pt+Ee,1,de.minY,de.maxY,Mt),Ii=null),zi&&(xi=ze(zi,Qt,pt-ce,pt+fe,1,de.minY,de.maxY,Mt),Oe=ze(zi,Qt,pt+ke,pt+Ee,1,de.minY,de.maxY,Mt),zi=null),Et>1&&console.timeEnd("clipping"),Jt.push(ve||[],_+1,2*ot,2*pt),Jt.push(Vi||[],_+1,2*ot,2*pt+1),Jt.push(xi||[],_+1,2*ot+1,2*pt),Jt.push(Oe||[],_+1,2*ot+1,2*pt+1)}}getTile(j,_,ot){j=+j,_=+_,ot=+ot;let pt=this.options,{extent:mt,debug:Ut}=pt;if(j<0||j>24)return null;let Bt=1<<j,Jt=Wn(j,_=_+Bt&Bt-1,ot);if(this.tiles[Jt])return co(this.tiles[Jt],mt);Ut>1&&console.log("drilling down to z%d-%d-%d",j,_,ot);let Mt,Et=j,Qt=_,Dt=ot;for(;!Mt&&Et>0;)Et--,Qt>>=1,Dt>>=1,Mt=this.tiles[Wn(Et,Qt,Dt)];return Mt&&Mt.source?(Ut>1&&(console.log("found parent tile z%d-%d-%d",Et,Qt,Dt),console.time("drilling down")),this.splitTile(Mt.source,Et,Qt,Dt,j,_,ot),Ut>1&&console.timeEnd("drilling down"),this.tiles[Jt]?co(this.tiles[Jt],mt):null):null}}function Wn(Tt,j,_){return 32*((1<<Tt)*_+j)+Tt}function bo(Tt,j){let _=Tt.tileID.canonical;if(!this._geoJSONIndex)return void j(null,null);let ot=this._geoJSONIndex.getTile(_.z,_.x,_.y);if(!ot)return void j(null,null);let pt=new vi(ot.features),mt=bn(pt);mt.byteOffset===0&&mt.byteLength===mt.buffer.byteLength||(mt=new Uint8Array(mt)),j(null,{vectorTile:pt,rawData:mt.buffer})}class js extends je{constructor(j,_,ot,pt,mt,Ut){super(j,_,ot,pt,bo,Ut),mt&&(this.loadGeoJSON=mt),this._dynamicIndex=new _e}loadData(j,_){let ot=j&&j.request,pt=ot&&ot.collectResourceTiming;this.loadGeoJSON(j,(mt,Ut)=>{if(mt||!Ut)return _(mt);if(typeof Ut!="object")return _(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`));{try{if(j.filter){let Jt=l.M(j.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Jt.result==="error")throw new Error(Jt.value.map(Mt=>`${Mt.key}: ${Mt.message}`).join(", "));Ut.features=Ut.features.filter(Mt=>Jt.value.evaluate({zoom:0},Mt))}j.dynamic?(Ut.type==="Feature"&&(Ut={type:"FeatureCollection",features:[Ut]}),j.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(Ut.features,this.loaded),j.cluster&&(Ut.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=j.cluster?new En(function({superclusterOptions:Jt,clusterProperties:Mt}){if(!Mt||!Jt)return Jt;let Et={},Qt={},Dt={accumulated:null,zoom:0},de={properties:null},ce=Object.keys(Mt);for(let ke of ce){let[fe,Ee]=Mt[ke],ve=l.M(Ee),Vi=l.M(typeof fe=="string"?[fe,["accumulated"],["get",ke]]:fe);Et[ke]=ve.value,Qt[ke]=Vi.value}return Jt.map=ke=>{de.properties=ke;let fe={};for(let Ee of ce)fe[Ee]=Et[Ee].evaluate(Dt,de);return fe},Jt.reduce=(ke,fe)=>{de.properties=fe;for(let Ee of ce)Dt.accumulated=ke[Ee],ke[Ee]=Qt[Ee].evaluate(Dt,de)},Jt}(j)).load(Ut.features):j.dynamic?this._dynamicIndex:function(Jt,Mt){return new $r(Jt,Mt)}(Ut,j.geojsonVtOptions)}catch(Jt){return _(Jt)}let Bt={};if(pt){let Jt=lt(ot);Jt&&(Bt.resourceTiming={},Bt.resourceTiming[j.source]=JSON.parse(JSON.stringify(Jt)))}_(null,Bt)}})}reloadTile(j,_){let ot=this.loaded;return ot&&ot[j.uid]?j.partial?_(null,void 0):super.reloadTile(j,_):this.loadTile(j,_)}loadGeoJSON(j,_){if(j.request)l.n(j.request,_);else{if(typeof j.data!="string")return _(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`));try{return _(null,JSON.parse(j.data))}catch{return _(new Error(`Input data given to '${j.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(j,_){try{_(null,this._geoJSONIndex.getClusterExpansionZoom(j.clusterId))}catch(ot){_(ot)}}getClusterChildren(j,_){try{_(null,this._geoJSONIndex.getChildren(j.clusterId))}catch(ot){_(ot)}}getClusterLeaves(j,_){try{_(null,this._geoJSONIndex.getLeaves(j.clusterId,j.limit,j.offset))}catch(ot){_(ot)}}}class Qo{constructor(j,_){this.tileID=new l.aA(j.tileID.overscaledZ,j.tileID.wrap,j.tileID.canonical.z,j.tileID.canonical.x,j.tileID.canonical.y),this.tileZoom=j.tileZoom,this.uid=j.uid,this.zoom=j.zoom,this.canonical=j.tileID.canonical,this.pixelRatio=j.pixelRatio,this.tileSize=j.tileSize,this.source=j.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=j.projection,this.brightness=_}parse(j,_,ot,pt){this.status="parsing";let mt=new l.aA(ot.tileID.overscaledZ,ot.tileID.wrap,ot.tileID.canonical.z,ot.tileID.canonical.x,ot.tileID.canonical.y),Ut={},Bt=_.familiesBySource[ot.source],Jt=new l.dR(mt,ot.promoteId);return Jt.bucketLayerIDs=[],Jt.is3DTile=!0,l.e0(j).then(Mt=>{if(!Mt)return pt(new Error("Could not parse tile"));let Et=l.e1(Mt,1/l.c8(ot.tileID.canonical)),Qt=Mt.json.extensionsUsed&&Mt.json.extensionsUsed.includes("MAPBOX_mesh_features")||Mt.json.asset.extras&&Mt.json.asset.extras.MAPBOX_mesh_features,Dt=Mt.json.extensionsUsed&&Mt.json.extensionsUsed.includes("EXT_meshopt_compression"),de=new l.a3(this.zoom,{brightness:this.brightness});for(let ce in Bt)for(let ke of Bt[ce]){let fe=ke[0];Jt.bucketLayerIDs.push(ke.map(ve=>ve.id)),fe.recalculate(de,[]);let Ee=new l.e2(Et,mt,Qt,Dt,this.brightness,Jt);Qt||(Ee.needsUpload=!0),Ut[fe.fqid]=Ee,Ee.evaluate(fe)}this.status="done",pt(null,{buckets:Ut,featureIndex:Jt})}).catch(Mt=>pt(new Error(Mt.message)))}}class Os{constructor(j,_,ot,pt,mt,Ut){this.actor=j,this.layerIndex=_,this.brightness=Ut,this.loading={},this.loaded={}}loadTile(j,_){let ot=j.uid,pt=this.loading[ot]=new Qo(j,this.brightness);l.bc(j.request,(mt,Ut)=>{let Bt=!this.loading[ot];return delete this.loading[ot],Bt||mt?(pt.status="done",Bt||(this.loaded[ot]=pt),_(mt)):Ut&&Ut.byteLength!==0?void pt.parse(Ut,this.layerIndex,j,(Jt,Mt)=>{pt.status="done",this.loaded=this.loaded||{},this.loaded[ot]=pt,Jt||!Mt?_(Jt):_(null,Mt)}):(pt.status="done",this.loaded[ot]=pt,_())})}reloadTile(j,_){let ot=this.loaded,pt=j.uid;if(ot&&ot[pt]){let mt=ot[pt];mt.projection=j.projection,mt.brightness=j.brightness;let Ut=(Bt,Jt)=>{mt.reloadCallback&&(delete mt.reloadCallback,this.loadTile(j,_)),_(Bt,Jt)};mt.status==="parsing"?mt.reloadCallback=Ut:mt.status==="done"&&this.loadTile(j,_)}}abortTile(j,_){let ot=j.uid;this.loading[ot]&&delete this.loading[ot],_()}removeTile(j,_){let ot=this.loaded,pt=j.uid;ot&&ot[pt]&&delete ot[pt],_()}}class mo{constructor(j){this.self=j,this.actor=new l.e3(j,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=l.bL({name:"mercator"}),this.workerSourceTypes={vector:je,geojson:js,"batched-model":Os},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(_,ot)=>{if(this.workerSourceTypes[_])throw new Error(`Worker source with name "${_}" already registered.`);this.workerSourceTypes[_]=ot},this.self.registerRTLTextPlugin=_=>{if(l.e4.isParsed())throw new Error("RTL text plugin already registered.");l.e4.applyArabicShaping=_.applyArabicShaping,l.e4.processBidirectionalText=_.processBidirectionalText,l.e4.processStyledBidirectionalText=_.processStyledBidirectionalText}}clearCaches(j,_,ot){delete this.layerIndexes[j],delete this.availableImages[j],delete this.workerSources[j],delete this.demWorkerSources[j],delete this.rasterArrayWorkerSource,ot()}checkIfReady(j,_,ot){ot()}setReferrer(j,_){this.referrer=_}spriteLoaded(j,{scope:_,isLoaded:ot}){if(this.isSpriteLoaded[j]||(this.isSpriteLoaded[j]={}),this.isSpriteLoaded[j][_]=ot,this.workerSources[j]&&this.workerSources[j][_])for(let pt in this.workerSources[j][_]){let mt=this.workerSources[j][_][pt];for(let Ut in mt){let Bt=mt[Ut];Bt instanceof je&&(Bt.isSpriteLoaded=ot,Bt.fire(new l.x("isSpriteLoaded")))}}}setImages(j,{scope:_,images:ot},pt){if(this.availableImages[j]||(this.availableImages[j]={}),this.availableImages[j][_]=ot,this.workerSources[j]&&this.workerSources[j][_]){for(let mt in this.workerSources[j][_]){let Ut=this.workerSources[j][_][mt];for(let Bt in Ut)Ut[Bt].availableImages=ot}pt()}else pt()}setProjection(j,_){this.projections[j]=l.bL(_)}setBrightness(j,_,ot){this.brightness=_,ot()}setLayers(j,_,ot){this.getLayerIndex(j,_.scope).replace(_.layers,_.options),ot()}updateLayers(j,_,ot){this.getLayerIndex(j,_.scope).update(_.layers,_.removedIds,_.options),ot()}loadTile(j,_,ot){_.projection=this.projections[j]||this.defaultProjection,this.getWorkerSource(j,_.type,_.source,_.scope).loadTile(_,ot)}loadDEMTile(j,_,ot){this.getDEMWorkerSource(j,_.source,_.scope).loadTile(_,ot)}decodeRasterArray(j,_,ot){this.getRasterArrayWorkerSource().decodeRasterArray(_,ot)}reloadTile(j,_,ot){_.projection=this.projections[j]||this.defaultProjection,this.getWorkerSource(j,_.type,_.source,_.scope).reloadTile(_,ot)}abortTile(j,_,ot){this.getWorkerSource(j,_.type,_.source,_.scope).abortTile(_,ot)}removeTile(j,_,ot){this.getWorkerSource(j,_.type,_.source,_.scope).removeTile(_,ot)}removeSource(j,_,ot){if(!(this.workerSources[j]&&this.workerSources[j][_.scope]&&this.workerSources[j][_.scope][_.type]&&this.workerSources[j][_.scope][_.type][_.source]))return;let pt=this.workerSources[j][_.scope][_.type][_.source];delete this.workerSources[j][_.scope][_.type][_.source],pt.removeSource!==void 0?pt.removeSource(_,ot):ot()}loadWorkerSource(j,_,ot){try{this.self.importScripts(_.url),ot()}catch(pt){ot(pt.toString())}}syncRTLPluginState(j,_,ot){try{l.e4.setState(_);let pt=l.e4.getPluginURL();if(l.e4.isLoaded()&&!l.e4.isParsed()&&pt!=null){this.self.importScripts(pt);let mt=l.e4.isParsed();ot(mt?void 0:new Error(`RTL Text Plugin failed to import scripts from ${pt}`),mt)}}catch(pt){ot(pt.toString())}}setDracoUrl(j,_){this.dracoUrl=_}getAvailableImages(j,_){this.availableImages[j]||(this.availableImages[j]={});let ot=this.availableImages[j][_];return ot||(ot=[]),ot}getLayerIndex(j,_){this.layerIndexes[j]||(this.layerIndexes[j]={});let ot=this.layerIndexes[j][_];return ot||(ot=this.layerIndexes[j][_]=new $t,ot.scope=_),ot}getWorkerSource(j,_,ot,pt){return this.workerSources[j]||(this.workerSources[j]={}),this.workerSources[j][pt]||(this.workerSources[j][pt]={}),this.workerSources[j][pt][_]||(this.workerSources[j][pt][_]={}),this.isSpriteLoaded[j]||(this.isSpriteLoaded[j]={}),this.workerSources[j][pt][_][ot]||(this.workerSources[j][pt][_][ot]=new this.workerSourceTypes[_]({send:(mt,Ut,Bt,Jt,Mt,Et)=>{this.actor.send(mt,Ut,Bt,j,Mt,Et)},scheduler:this.actor.scheduler},this.getLayerIndex(j,pt),this.getAvailableImages(j,pt),this.isSpriteLoaded[j][pt],void 0,this.brightness)),this.workerSources[j][pt][_][ot]}getDEMWorkerSource(j,_,ot){return this.demWorkerSources[j]||(this.demWorkerSources[j]={}),this.demWorkerSources[j][ot]||(this.demWorkerSources[j][ot]={}),this.demWorkerSources[j][ot][_]||(this.demWorkerSources[j][ot][_]=new Ze),this.demWorkerSources[j][ot][_]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new ii),this.rasterArrayWorkerSource}enforceCacheSizeLimit(j,_){l.e5(_)}getWorkerPerformanceMetrics(j,_,ot){ot(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new mo(self)),mo}),E(["./shared"],function(l){var lt="3.7.0";let It={create:"create",load:"load",fullLoad:"fullLoad"},Gt={mark(r){performance.mark(r)},measure(r,e,a){performance.measure(r,e,a)}};function $t(r){let e=r.name.split("?")[0];return l.a(e)&&e.includes("mapbox-gl.js")?"javascript":l.a(e)&&e.includes("mapbox-gl.css")?"css":l.b(e)?"fontRange":l.c(e)?"sprite":l.i(e)?"style":l.d(e)?"tilejson":"other"}var Kt,Ve={},re=function(){if(Kt)return Ve;function r(d){return!e(d)}function e(d){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var p,u,U=new Blob([""],{type:"text/javascript"}),Y=URL.createObjectURL(U);try{u=new Worker(Y),p=!0}catch{p=!1}return u&&u.terminate(),URL.revokeObjectURL(Y),p}()?function(){var p=document.createElement("canvas");p.width=p.height=1;var u=p.getContext("2d");if(!u)return!1;var U=u.getImageData(0,0,1,1);return U&&U.width===p.width}()?(a[m=d&&d.failIfMajorPerformanceCaveat]===void 0&&(a[m]=function(p){var u,U=function(Y){var y=document.createElement("canvas"),B=Object.create(r.webGLContextAttributes);return B.failIfMajorPerformanceCaveat=Y,y.getContext("webgl2",B)}(p);if(!U)return!1;try{u=U.createShader(U.VERTEX_SHADER)}catch{return!1}return!(!u||U.isContextLost())&&(U.shaderSource(u,"void main() {}"),U.compileShader(u),U.getShaderParameter(u,U.COMPILE_STATUS)===!0)}(m)),a[m]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var m}Kt=1,Ve.supported=r,Ve.notSupportedReason=e;var a={};return r.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Ve}();function le(r,e,a){let d=document.createElement(r);return e!=null&&(d.className=e),a&&a.appendChild(d),d}function je(r,e,a){let d=document.createElementNS("http://www.w3.org/2000/svg",r);for(let m of Object.keys(e))d.setAttributeNS(null,m,String(e[m]));return a&&a.appendChild(d),d}let Ze=typeof document<"u"?document.documentElement&&document.documentElement.style:null,ii=Ze&&Ze.userSelect!==void 0?"userSelect":"WebkitUserSelect",bi;function Xe(){Ze&&ii&&(bi=Ze[ii],Ze[ii]="none")}function vi(){Ze&&ii&&(Ze[ii]=bi)}function we(r){r.preventDefault(),r.stopPropagation(),window.removeEventListener("click",we,!0)}function We(){window.addEventListener("click",we,!0),window.setTimeout(()=>{window.removeEventListener("click",we,!0)},0)}function _e(r,e){let a=r.getBoundingClientRect();return Fe(r,a,e)}function Zi(r,e){let a=r.getBoundingClientRect(),d=[];for(let m=0;m<e.length;m++)d.push(Fe(r,a,e[m]));return d}function Re(r){return window.InstallTrigger!==void 0&&r.button===2&&r.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:r.button}function Fe(r,e,a){let d=r.offsetWidth===e.width?1:r.offsetWidth/e.width;return new l.P((a.clientX-e.left)*d,(a.clientY-e.top)*d)}let wi="01",Pi="NO_ACCESS_TOKEN";class Sa{constructor(e,a,d){this._transformRequestFn=e,this._customAccessToken=a,this._silenceAuthErrors=!!d,this._createSkuToken()}_createSkuToken(){let e=function(){let a="";for(let d=0;d<10;d++)a+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",wi,a].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=e.token,this._skuTokenExpiresAt=e.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(e,a){return this._transformRequestFn&&this._transformRequestFn(e,a)||{url:e}}normalizeStyleURL(e,a){if(!l.f(e))return e;let d=aa(e);return d.params.push(`sdk=js-${lt}`),d.path=`/styles/v1${d.path}`,this._makeAPIURL(d,this._customAccessToken||a)}normalizeGlyphsURL(e,a){if(!l.f(e))return e;let d=aa(e);return d.path=`/fonts/v1${d.path}`,this._makeAPIURL(d,this._customAccessToken||a)}normalizeModelURL(e,a){if(!l.f(e))return e;let d=aa(e);return d.path=`/models/v1${d.path}`,this._makeAPIURL(d,this._customAccessToken||a)}normalizeSourceURL(e,a,d,m){if(!l.f(e))return e;let p=aa(e);return p.path=`/v4/${p.authority}.json`,p.params.push("secure"),d&&p.params.push(`language=${d}`),m&&p.params.push(`worldview=${m}`),this._makeAPIURL(p,this._customAccessToken||a)}normalizeSpriteURL(e,a,d,m){let p=aa(e);return l.f(e)?(p.path=`/styles/v1${p.path}/sprite${a}${d}`,this._makeAPIURL(p,this._customAccessToken||m)):(p.path+=`${a}${d}`,ya(p))}normalizeTileURL(e,a,d){if(this._isSkuTokenExpired()&&this._createSkuToken(),e&&!l.f(e))return e;let m=aa(e);m.path=m.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${a||d&&m.authority!=="raster"&&d===512?"@2x":""}${l.m.supported?".webp":"$1"}`),m.authority==="raster"?m.path=`/${l.e.RASTER_URL_PREFIX}${m.path}`:m.authority==="rasterarrays"?m.path=`/${l.e.RASTERARRAYS_URL_PREFIX}${m.path}`:m.authority==="3dtiles"?m.path=`/${l.e.TILES3D_URL_PREFIX}${m.path}`:(m.path=m.path.replace(/^.+\/v4\//,"/"),m.path=`/${l.e.TILE_URL_VERSION}${m.path}`);let p=this._customAccessToken||function(u){for(let U of u){let Y=U.match(/^access_token=(.*)$/);if(Y)return Y[1]}return null}(m.params)||l.e.ACCESS_TOKEN;return l.e.REQUIRE_ACCESS_TOKEN&&p&&this._skuToken&&m.params.push(`sku=${this._skuToken}`),this._makeAPIURL(m,p)}canonicalizeTileURL(e,a){let d=aa(e);if(!d.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!d.path.match(/\.[\w]+$/))return e;let m="mapbox://";d.path.match(/^\/raster\/v1\//)?m+=`raster/${d.path.replace(`/${l.e.RASTER_URL_PREFIX}/`,"")}`:d.path.match(/^\/rasterarrays\/v1\//)?m+=`rasterarrays/${d.path.replace(`/${l.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:m+=`tiles/${d.path.replace(`/${l.e.TILE_URL_VERSION}/`,"")}`;let p=d.params;return a&&(p=p.filter(u=>!u.match(/^access_token=/))),p.length&&(m+=`?${p.join("&")}`),m}canonicalizeTileset(e,a){let d=!!a&&l.f(a),m=[];for(let p of e.tiles||[])l.h(p)?m.push(this.canonicalizeTileURL(p,d)):m.push(p);return m}_makeAPIURL(e,a){let d="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",m=aa(l.e.API_URL);if(e.protocol=m.protocol,e.authority=m.authority,e.protocol==="http"){let p=e.params.indexOf("secure");p>=0&&e.params.splice(p,1)}if(m.path!=="/"&&(e.path=`${m.path}${e.path}`),!l.e.REQUIRE_ACCESS_TOKEN)return ya(e);if(a=a||l.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!a)throw new Error(`An API access token is required to use Mapbox GL. ${d}`);if(a[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${d}`)}return e.params=e.params.filter(p=>p.indexOf("access_token")===-1),e.params.push(`access_token=${a||""}`),ya(e)}}let ye=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function aa(r){let e=r.match(ye);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function ya(r){let e=r.params.length?`?${r.params.join("&")}`:"";return`${r.protocol}://${r.authority}${r.path}${e}`}let ua="mapbox.eventData";function Be(r){if(!r)return null;let e=r.split(".");if(!e||e.length!==3)return null;try{return JSON.parse(l.j(e[1]))}catch{return null}}class Yn{constructor(e){this.type=e,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(e){let a=Be(l.e.ACCESS_TOKEN),d="";return d=a&&a.u?l.k(a.u):l.e.ACCESS_TOKEN||"",e?`${ua}.${e}:${d}`:`${ua}:${d}`}fetchEventData(){let e=l.s("localStorage"),a=this.getStorageKey(),d=this.getStorageKey("uuid");if(e)try{let m=localStorage.getItem(a);m&&(this.eventData=JSON.parse(m));let p=localStorage.getItem(d);p&&(this.anonId=p)}catch{l.w("Unable to read from LocalStorage")}}saveEventData(){let e=l.s("localStorage"),a=this.getStorageKey(),d=this.getStorageKey("uuid"),m=this.anonId;if(e&&m)try{localStorage.setItem(d,m),Object.keys(this.eventData).length>=1&&localStorage.setItem(a,JSON.stringify(this.eventData))}catch{l.w("Unable to write to LocalStorage")}}processRequests(e){}postEvent(e,a,d,m){if(!l.e.EVENTS_URL)return;let p=aa(l.e.EVENTS_URL);p.params.push(`access_token=${m||l.e.ACCESS_TOKEN||""}`);let u={event:this.type,created:new Date(e).toISOString()},U=a?l.l(u,a):u,Y={url:ya(p),headers:{"Content-Type":"text/plain"},body:JSON.stringify([U])};this.pendingRequest=l.p(Y,y=>{this.pendingRequest=null,d(y),this.saveEventData(),this.processRequests(m)})}queueRequest(e,a){this.queue.push(e),this.processRequests(a)}}let bn=new class extends Yn{constructor(r){super("appUserTurnstile"),this._customAccessToken=r}postTurnstileEvent(r,e){l.e.EVENTS_URL&&l.e.ACCESS_TOKEN&&Array.isArray(r)&&r.some(a=>l.f(a)||l.h(a))&&this.queueRequest(Date.now(),e)}processRequests(r){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let e=Be(l.e.ACCESS_TOKEN),a=e?e.u:l.e.ACCESS_TOKEN,d=a!==this.eventData.tokenU;l.v(this.anonId)||(this.anonId=l.u(),d=!0);let m=this.queue.shift();if(this.eventData.lastSuccess){let p=new Date(this.eventData.lastSuccess),u=new Date(m),U=(m-this.eventData.lastSuccess)/864e5;d=d||U>=1||U<-1||p.getDate()!==u.getDate()}else d=!0;d?this.postEvent(m,{sdkIdentifier:"mapbox-gl-js",sdkVersion:lt,skuId:wi,"enabled.telemetry":!1,userId:this.anonId},p=>{p||(this.eventData.lastSuccess=m,this.eventData.tokenU=a)},r):this.processRequests()}},fn=bn.postTurnstileEvent.bind(bn),Qe=new class extends Yn{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(r,e,a,d){this.skuToken=e,this.errorCb=d,l.e.EVENTS_URL&&(a||l.e.ACCESS_TOKEN?this.queueRequest({id:r,timestamp:Date.now()},a):this.errorCb(new Error(Pi)))}processRequests(r){if(this.pendingRequest||this.queue.length===0)return;let{id:e,timestamp:a}=this.queue.shift();e&&this.success[e]||(this.anonId||this.fetchEventData(),l.v(this.anonId)||(this.anonId=l.u()),this.postEvent(a,{sdkIdentifier:"mapbox-gl-js",sdkVersion:lt,skuId:wi,skuToken:this.skuToken,userId:this.anonId},d=>{d?this.errorCb(d):e&&(this.success[e]=!0)},r))}remove(){this.errorCb=null}},vn=Qe.postMapLoadEvent.bind(Qe),Qa=new class extends Yn{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(r){let e=this.mapInstanceIdMap.get(r);return e||(e=l.u(),this.mapInstanceIdMap.set(r,e)),e}getEventId(r){let e=this.eventIdPerMapInstanceMap.get(r)||0;return this.eventIdPerMapInstanceMap.set(r,e+1),e}postStyleLoadEvent(r,e){let{map:a,style:d,importedStyles:m}=e;if(!l.e.EVENTS_URL||!r&&!l.e.ACCESS_TOKEN)return;let p=this.getMapInstanceId(a),u={mapInstanceId:p,eventId:this.getEventId(p),style:d};m.length&&(u.importedStyles=m),this.queueRequest({timestamp:Date.now(),payload:u},r)}processRequests(r){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:e,payload:a}=this.queue.shift();this.postEvent(e,a,()=>{},r)}},Ga=Qa.postStyleLoadEvent.bind(Qa),ja=new class extends Yn{constructor(){super("gljs.performance")}postPerformanceEvent(r,e){l.e.EVENTS_URL&&(r||l.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:e},r)}processRequests(r){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:e,performanceData:a}=this.queue.shift(),d=function(m){let p=performance.getEntriesByType("resource"),u=performance.getEntriesByType("mark"),U=function(Q){let z={};if(Q){for(let w in Q)if(w!=="other")for(let A of Q[w]){let H=`${w}ResolveRangeMin`,$=`${w}ResolveRangeMax`,et=`${w}RequestCount`,K=`${w}RequestCachedCount`;z[H]=Math.min(z[H]||1/0,A.startTime),z[$]=Math.max(z[$]||-1/0,A.responseEnd);let nt=at=>{z[at]===void 0&&(z[at]=0),++z[at]};A.transferSize!==void 0&&A.transferSize===0&&nt(K),nt(et)}}return z}(function(Q,z){let w={};if(Q)for(let A of Q){let H=z(A);w[H]===void 0&&(w[H]=[]),w[H].push(A)}return w}(p,$t)),Y=window.devicePixelRatio,y=navigator.connection||navigator.mozConnection||navigator.webkitConnection,B=y?y.effectiveType:void 0,C={counters:[],metadata:[],attributes:[]},k=(Q,z,w)=>{w!=null&&Q.push({name:z,value:w.toString()})};for(let Q in U)k(C.counters,Q,U[Q]);if(m.interactionRange[0]!==1/0&&m.interactionRange[1]!==-1/0&&(k(C.counters,"interactionRangeMin",m.interactionRange[0]),k(C.counters,"interactionRangeMax",m.interactionRange[1])),u)for(let Q of Object.keys(It)){let z=It[Q],w=u.find(A=>A.name===z);w&&k(C.counters,z,w.startTime)}return k(C.counters,"visibilityHidden",m.visibilityHidden),k(C.attributes,"style",function(Q){if(Q)for(let z of Q){let w=z.name.split("?")[0];if(l.i(w)){let A=w.split("/").slice(-2);if(A.length===2)return`mapbox://styles/${A[0]}/${A[1]}`}}}(p)),k(C.attributes,"terrainEnabled",m.terrainEnabled?"true":"false"),k(C.attributes,"fogEnabled",m.fogEnabled?"true":"false"),k(C.attributes,"projection",m.projection),k(C.attributes,"zoom",m.zoom),k(C.metadata,"devicePixelRatio",Y),k(C.metadata,"connectionEffectiveType",B),k(C.metadata,"navigatorUserAgent",navigator.userAgent),k(C.metadata,"screenWidth",window.screen.width),k(C.metadata,"screenHeight",window.screen.height),k(C.metadata,"windowWidth",window.innerWidth),k(C.metadata,"windowHeight",window.innerHeight),k(C.metadata,"mapWidth",m.width/Y),k(C.metadata,"mapHeight",m.height/Y),k(C.metadata,"webglRenderer",m.renderer),k(C.metadata,"webglVendor",m.vendor),k(C.metadata,"sdkVersion",lt),k(C.metadata,"sdkIdentifier","mapbox-gl-js"),C}(a);for(let m of d.metadata);for(let m of d.counters);for(let m of d.attributes);this.postEvent(e,d,()=>{},r)}},En=ja.postPerformanceEvent.bind(ja),Jn=new class extends Yn{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(r,e,a,d){if(!l.e.API_URL||!l.e.SESSION_PATH)return;let m=aa(l.e.API_URL+l.e.SESSION_PATH);m.params.push(`sku=${e||""}`),m.params.push(`access_token=${d||l.e.ACCESS_TOKEN||""}`);let p={url:ya(m),headers:{"Content-Type":"text/plain"}};this.pendingRequest=l.g(p,u=>{this.pendingRequest=null,a(u),this.saveEventData(),this.processRequests(d)})}getSessionAPI(r,e,a,d){this.skuToken=e,this.errorCb=d,l.e.SESSION_PATH&&l.e.API_URL&&(a||l.e.ACCESS_TOKEN?this.queueRequest({id:r,timestamp:Date.now()},a):this.errorCb(new Error(Pi)))}processRequests(r){if(this.pendingRequest||this.queue.length===0)return;let{id:e,timestamp:a}=this.queue.shift();e&&this.success[e]||this.getSession(a,this.skuToken,d=>{d?this.errorCb(d):e&&(this.success[e]=!0)},r)}remove(){this.errorCb=null}},ut=Jn.getSessionAPI.bind(Jn),mn=new Set;function el(r,e){e?mn.add(r):mn.delete(r)}class Il{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(e,a){this._updatedSourceCaches[e]=a,this.setDirty()}discardSourceCacheUpdate(e){delete this._updatedSourceCaches[e]}updateLayer(e){let a=e.scope;this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._updatedLayers[a].add(e.id),this.setDirty()}removeLayer(e){let a=e.scope;this._removedLayers[a]=this._removedLayers[a]||{},this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._removedLayers[a][e.id]=e,this._updatedLayers[a].delete(e.id),this._updatedPaintProps.delete(e.fqid),this.setDirty()}getRemovedLayer(e){return this._removedLayers[e.scope]?this._removedLayers[e.scope][e.id]:null}discardLayerRemoval(e){this._removedLayers[e.scope]&&delete this._removedLayers[e.scope][e.id]}getLayerUpdatesByScope(){let e={};for(let a in this._updatedLayers)e[a]=e[a]||{},e[a].updatedIds=Array.from(this._updatedLayers[a].values());for(let a in this._removedLayers)e[a]=e[a]||{},e[a].removedIds=Object.keys(this._removedLayers[a]);return e}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(e){this._updatedPaintProps.add(e.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(e){this._updatedImages.add(e),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}function ee(r){let{userImage:e}=r;return!!(e&&e.render&&e.render())&&(r.data.replace(new Uint8Array(e.data.buffer)),!0)}class il extends l.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(e){this.images[e]={},this.loaded[e]=!1,this.updatedImages[e]={},this.patterns[e]={},this.callbackDispatchedThisFrame[e]={},this.atlasImage[e]=new l.r({width:1,height:1})}isLoaded(){for(let e in this.loaded)if(!this.loaded[e])return!1;return!0}setLoaded(e,a){if(this.loaded[a]!==e&&(this.loaded[a]=e,e)){for(let{ids:d,callback:m}of this.requestors)this._notify(d,a,m);this.requestors=[]}}hasImage(e,a){return!!this.getImage(e,a)}getImage(e,a){return this.images[a][e]}addImage(e,a,d){this._validate(e,d)&&(this.images[a][e]=d)}_validate(e,a){let d=!0;return this._validateStretch(a.stretchX,a.data&&a.data.width)||(this.fire(new l.t(new Error(`Image "${e}" has invalid "stretchX" value`))),d=!1),this._validateStretch(a.stretchY,a.data&&a.data.height)||(this.fire(new l.t(new Error(`Image "${e}" has invalid "stretchY" value`))),d=!1),this._validateContent(a.content,a)||(this.fire(new l.t(new Error(`Image "${e}" has invalid "content" value`))),d=!1),d}_validateStretch(e,a){if(!e)return!0;let d=0;for(let m of e){if(m[0]<d||m[1]<m[0]||a<m[1])return!1;d=m[1]}return!0}_validateContent(e,a){return!(e&&(e.length!==4||e[0]<0||a.data.width<e[0]||e[1]<0||a.data.height<e[1]||e[2]<0||a.data.width<e[2]||e[3]<0||a.data.height<e[3]||e[2]<e[0]||e[3]<e[1]))}updateImage(e,a,d){d.version=this.images[a][e].version+1,this.images[a][e]=d,this.updatedImages[a][e]=!0}removeImage(e,a){let d=this.images[a][e];delete this.images[a][e],delete this.patterns[a][e],d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(e){return Object.keys(this.images[e])}getImages(e,a,d){let m=!0,p=!!this.loaded[a];if(!p)for(let u of e)this.images[a][u]||(m=!1);p||m?this._notify(e,a,d):this.requestors.push({ids:e,scope:a,callback:d})}getUpdatedImages(e){return this.updatedImages[e]}_notify(e,a,d){let m={};for(let p of e){this.images[a][p]||this.fire(new l.x("styleimagemissing",{id:p}));let u=this.images[a][p];u?m[p]={data:u.data.clone(),pixelRatio:u.pixelRatio,sdf:u.sdf,version:u.version,stretchX:u.stretchX,stretchY:u.stretchY,content:u.content,hasRenderCallback:!!(u.userImage&&u.userImage.render)}:l.w(`Image "${p}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}d(null,m)}getPixelSize(e){let{width:a,height:d}=this.atlasImage[e];return{width:a,height:d}}getPattern(e,a,d){let m=this.patterns[a][e],p=this.getImage(e,a);if(!p)return null;if(m&&m.position.version===p.version)return m.position;if(m)m.position.version=p.version;else{let u={w:p.data.width+2*l.y,h:p.data.height+2*l.y,x:0,y:0},U=new l.I(u,p,l.y);this.patterns[a][e]={bin:u,position:U}}return this._updatePatternAtlas(a,d),this.patterns[a][e].position}bind(e,a){let d=e.gl,m=this.atlasTexture[a];m?this.dirty&&(m.update(this.atlasImage[a]),this.dirty=!1):(m=new l.T(e,this.atlasImage[a],d.RGBA8),this.atlasTexture[a]=m),m.bind(d.LINEAR,d.CLAMP_TO_EDGE)}_updatePatternAtlas(e,a){let d=[];for(let U in this.patterns[e])d.push(this.patterns[e][U].bin);let{w:m,h:p}=l.z(d),u=this.atlasImage[e];u.resize({width:m||1,height:p||1});for(let U in this.patterns[e]){let{bin:Y,position:y}=this.patterns[e][U],B=y.padding,C=Y.x+B,k=Y.y+B,Q=this.images[e][U].data,z=Q.width,w=Q.height;B=B>1?B-1:B,l.r.copy(Q,u,{x:0,y:0},{x:C,y:k},{width:z,height:w},a),l.r.copy(Q,u,{x:0,y:w-B},{x:C,y:k-B},{width:z,height:B},a),l.r.copy(Q,u,{x:0,y:0},{x:C,y:k+w},{width:z,height:B},a),l.r.copy(Q,u,{x:z-B,y:0},{x:C-B,y:k},{width:B,height:w},a),l.r.copy(Q,u,{x:0,y:0},{x:C+z,y:k},{width:B,height:w},a),l.r.copy(Q,u,{x:z-B,y:w-B},{x:C-B,y:k-B},{width:B,height:B},a),l.r.copy(Q,u,{x:0,y:w-B},{x:C+z,y:k-B},{width:B,height:B},a),l.r.copy(Q,u,{x:0,y:0},{x:C+z,y:k+w},{width:B,height:B},a),l.r.copy(Q,u,{x:z-B,y:0},{x:C-B,y:k+w},{width:B,height:B},a)}this.dirty=!0}beginFrame(){for(let e in this.images)this.callbackDispatchedThisFrame[e]={}}dispatchRenderCallbacks(e,a){for(let d of e){if(this.callbackDispatchedThisFrame[a][d])continue;this.callbackDispatchedThisFrame[a][d]=!0;let m=this.images[a][d];ee(m)&&this.updateImage(d,a,m)}}}function Za(r){let e=r.key,a=r.value,d=r.valueSpec||{},m=r.objectElementValidators||{},p=r.style,u=r.styleSpec,U=[],Y=l.B(a);if(Y!=="object")return[new l.V(e,a,`object expected, ${Y} found`)];for(let y in a){let B=y.split(".")[0],C;m[B]?C=m[B]:d[B]?C=mi:m["*"]?C=m["*"]:d["*"]&&(C=mi),C?U=U.concat(C({key:(e&&`${e}.`)+y,value:a[y],valueSpec:d[B]||d["*"],style:p,styleSpec:u,object:a,objectKey:y},a)):U.push(new l.A(e,a[y],`unknown property "${y}"`))}for(let y in d)m[y]||d[y].required&&d[y].default===void 0&&a[y]===void 0&&U.push(new l.V(e,a,`missing required property "${y}"`));return U}function Ln(r){let e=r.value,a=r.valueSpec,d=r.style,m=r.styleSpec,p=r.key,u=r.arrayElementValidator||mi;if(l.B(e)!=="array")return[new l.V(p,e,`array expected, ${l.B(e)} found`)];if(a.length&&e.length!==a.length)return[new l.V(p,e,`array length ${a.length} expected, length ${e.length} found`)];if(a["min-length"]&&e.length<a["min-length"])return[new l.V(p,e,`array length at least ${a["min-length"]} expected, length ${e.length} found`)];let U={type:a.value,values:a.values,minimum:a.minimum,maximum:a.maximum,function:void 0};m.$version<7&&(U.function=a.function),l.B(a.value)==="object"&&(U=a.value);let Y=[];for(let y=0;y<e.length;y++)Y=Y.concat(u({array:e,arrayIndex:y,value:e[y],valueSpec:U,style:d,styleSpec:m,key:`${p}[${y}]`},!0));return Y}function ti(r){let e=r.key,a=r.value,d=r.valueSpec,m=l.B(a);if(m==="number"&&a!=a&&(m="NaN"),m!=="number")return[new l.V(e,a,`number expected, ${m} found`)];if("minimum"in d){let p=d.minimum;if(l.B(d.minimum)==="array"&&(p=d.minimum[r.arrayIndex]),a<p)return[new l.V(e,a,`${a} is less than the minimum value ${p}`)]}if("maximum"in d){let p=d.maximum;if(l.B(d.maximum)==="array"&&(p=d.maximum[r.arrayIndex]),a>p)return[new l.V(e,a,`${a} is greater than the maximum value ${p}`)]}return[]}function sa(r){let e=r.valueSpec,a=l.D(r.value.type),d,m,p,u={},U=a!=="categorical"&&r.value.property===void 0,Y=!U,y=l.B(r.value.stops)==="array"&&l.B(r.value.stops[0])==="array"&&l.B(r.value.stops[0][0])==="object",B=Za({key:r.key,value:r.value,valueSpec:r.styleSpec.function,style:r.style,styleSpec:r.styleSpec,objectElementValidators:{stops:function(Q){if(a==="identity")return[new l.V(Q.key,Q.value,'identity function may not have a "stops" property')];let z=[],w=Q.value;return z=z.concat(Ln({key:Q.key,value:w,valueSpec:Q.valueSpec,style:Q.style,styleSpec:Q.styleSpec,arrayElementValidator:C})),l.B(w)==="array"&&w.length===0&&z.push(new l.V(Q.key,w,"array must have at least one stop")),z},default:function(Q){return mi({key:Q.key,value:Q.value,valueSpec:e,style:Q.style,styleSpec:Q.styleSpec})}}});return a==="identity"&&U&&B.push(new l.V(r.key,r.value,'missing required property "property"')),a==="identity"||r.value.stops||B.push(new l.V(r.key,r.value,'missing required property "stops"')),a==="exponential"&&r.valueSpec.expression&&!l.F(r.valueSpec)&&B.push(new l.V(r.key,r.value,"exponential functions not supported")),r.styleSpec.$version>=8&&(Y&&!l.G(r.valueSpec)?B.push(new l.V(r.key,r.value,"property functions not supported")):U&&!l.H(r.valueSpec)&&B.push(new l.V(r.key,r.value,"zoom functions not supported"))),a!=="categorical"&&!y||r.value.property!==void 0||B.push(new l.V(r.key,r.value,'"property" property is required')),B;function C(Q){let z=[],w=Q.value,A=Q.key;if(l.B(w)!=="array")return[new l.V(A,w,`array expected, ${l.B(w)} found`)];if(w.length!==2)return[new l.V(A,w,`array length 2 expected, length ${w.length} found`)];if(y){if(l.B(w[0])!=="object")return[new l.V(A,w,`object expected, ${l.B(w[0])} found`)];if(w[0].zoom===void 0)return[new l.V(A,w,"object stop key must have zoom")];if(w[0].value===void 0)return[new l.V(A,w,"object stop key must have value")];let H=l.D(w[0].zoom);if(typeof H!="number")return[new l.V(A,w[0].zoom,"stop zoom values must be numbers")];if(p&&p>H)return[new l.V(A,w[0].zoom,"stop zoom values must appear in ascending order")];H!==p&&(p=H,m=void 0,u={}),z=z.concat(Za({key:`${A}[0]`,value:w[0],valueSpec:{zoom:{}},style:Q.style,styleSpec:Q.styleSpec,objectElementValidators:{zoom:ti,value:k}}))}else z=z.concat(k({key:`${A}[0]`,value:w[0],valueSpec:{},style:Q.style,styleSpec:Q.styleSpec},w));return l.J(l.K(w[1]))?z.concat([new l.V(`${A}[1]`,w[1],"expressions are not allowed in function stops.")]):z.concat(mi({key:`${A}[1]`,value:w[1],valueSpec:e,style:Q.style,styleSpec:Q.styleSpec}))}function k(Q,z){let w=l.B(Q.value),A=l.D(Q.value),H=Q.value!==null?Q.value:z;if(d){if(w!==d)return[new l.V(Q.key,H,`${w} stop domain type must match previous stop domain type ${d}`)]}else d=w;if(w!=="number"&&w!=="string"&&w!=="boolean"&&typeof A!="number"&&typeof A!="string"&&typeof A!="boolean")return[new l.V(Q.key,H,"stop domain value must be a number, string, or boolean")];if(w!=="number"&&a!=="categorical"){let $=`number expected, ${w} found`;return l.G(e)&&a===void 0&&($+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new l.V(Q.key,H,$)]}return a!=="categorical"||w!=="number"||typeof A=="number"&&isFinite(A)&&Math.floor(A)===A?a!=="categorical"&&w==="number"&&typeof A=="number"&&typeof m=="number"&&m!==void 0&&A<m?[new l.V(Q.key,H,"stop domain values must appear in ascending order")]:(m=A,a==="categorical"&&A in u?[new l.V(Q.key,H,"stop domain values must be unique")]:(u[A]=!0,[])):[new l.V(Q.key,H,`integer expected, found ${String(A)}`)]}}function hn(r){let e=(r.expressionContext==="property"?l.L:l.M)(l.K(r.value),r.valueSpec);if(e.result==="error")return e.value.map(d=>new l.V(`${r.key}${d.key}`,r.value,d.message));let a=e.value.expression||e.value._styleExpression.expression;if(r.expressionContext==="property"&&r.propertyKey==="text-font"&&!a.outputDefined())return[new l.V(r.key,r.value,`Invalid data expression for "${r.propertyKey}". Output values must be contained as literals within the expression.`)];if(r.expressionContext==="property"&&r.propertyType==="layout"&&!l.N(a))return[new l.V(r.key,r.value,'"feature-state" data expressions are not supported with layout properties.')];if(r.expressionContext==="filter")return Ul(a,r);if(r.expressionContext&&r.expressionContext.indexOf("cluster")===0){if(!l.O(a,["zoom","feature-state"]))return[new l.V(r.key,r.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(r.expressionContext==="cluster-initial"&&!l.Q(a))return[new l.V(r.key,r.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Ul(r,e){let a=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(e.valueSpec&&e.valueSpec.expression)for(let m of e.valueSpec.expression.parameters)a.delete(m);if(a.size===0)return[];let d=[];return r instanceof l.S&&a.has(r.name)?[new l.V(e.key,e.value,`["${r.name}"] expression is not supported in a filter for a ${e.object.type} layer with id: ${e.object.id}`)]:(r.eachChild(m=>{d.push(...Ul(m,e))}),d)}function fa(r){let e=r.key,a=r.value,d=r.valueSpec,m=[];return Array.isArray(d.values)?d.values.indexOf(l.D(a))===-1&&m.push(new l.V(e,a,`expected one of [${d.values.join(", ")}], ${JSON.stringify(a)} found`)):Object.keys(d.values).indexOf(l.D(a))===-1&&m.push(new l.V(e,a,`expected one of [${Object.keys(d.values).join(", ")}], ${JSON.stringify(a)} found`)),m}function zn(r){return l.W(l.K(r.value))?hn(l.C({},r,{expressionContext:"filter",valueSpec:r.styleSpec[`filter_${r.layerType||"fill"}`]})):ze(r)}function ze(r){let e=r.value,a=r.key;if(l.B(e)!=="array")return[new l.V(a,e,`array expected, ${l.B(e)} found`)];let d=r.styleSpec,m,p=[];if(e.length<1)return[new l.V(a,e,"filter array must have at least 1 element")];switch(p=p.concat(fa({key:`${a}[0]`,value:e[0],valueSpec:d.filter_operator,style:r.style,styleSpec:r.styleSpec})),l.D(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&l.D(e[1])==="$type"&&p.push(new l.V(a,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&p.push(new l.V(a,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(m=l.B(e[1]),m!=="string"&&p.push(new l.V(`${a}[1]`,e[1],`string expected, ${m} found`)));for(let u=2;u<e.length;u++)m=l.B(e[u]),l.D(e[1])==="$type"?p=p.concat(fa({key:`${a}[${u}]`,value:e[u],valueSpec:d.geometry_type,style:r.style,styleSpec:r.styleSpec})):m!=="string"&&m!=="number"&&m!=="boolean"&&p.push(new l.V(`${a}[${u}]`,e[u],`string, number, or boolean expected, ${m} found`));break;case"any":case"all":case"none":for(let u=1;u<e.length;u++)p=p.concat(ze({key:`${a}[${u}]`,value:e[u],style:r.style,styleSpec:r.styleSpec}));break;case"has":case"!has":m=l.B(e[1]),e.length!==2?p.push(new l.V(a,e,`filter array for "${e[0]}" operator must have 2 elements`)):m!=="string"&&p.push(new l.V(`${a}[1]`,e[1],`string expected, ${m} found`))}return p}function xl(r,e){let a=r.key,d=r.style,m=r.layer,p=r.styleSpec,u=r.value,U=r.objectKey,Y=p[`${e}_${r.layerType}`];if(!Y)return[];let y=U.match(/^(.*)-transition$/);if(e==="paint"&&y&&Y[y[1]]&&Y[y[1]].transition)return mi({key:a,value:u,valueSpec:p.transition,style:d,styleSpec:p});let B=r.valueSpec||Y[U];if(!B)return[new l.A(a,u,`unknown property "${U}"`)];let C;if(l.B(u)==="string"&&l.G(B)&&!B.tokens&&(C=/^{([^}]+)}$/.exec(u))){let Q=`\`{ "type": "identity", "property": ${C?JSON.stringify(C[1]):'"_"'} }\``;return[new l.V(a,u,`"${U}" does not support interpolation syntax
Use an identity property function instead: ${Q}.`)]}let k=[];if(r.layerType==="symbol")U!=="text-field"||!d||d.glyphs||d.imports||k.push(new l.V(a,u,'use of "text-field" requires a style "glyphs" property')),U==="text-font"&&l.X(l.K(u))&&l.D(u.type)==="identity"&&k.push(new l.V(a,u,'"text-font" does not support identity functions'));else if(r.layerType==="model"&&e==="paint"&&m&&m.layout&&m.layout.hasOwnProperty("model-id")&&l.G(B)&&(l.Y(B)||l.H(B))){let Q=l.L(l.K(u),B),z=Q.value.expression||Q.value._styleExpression.expression;z&&!l.O(z,["measure-light"])&&(U==="model-emissive-strength"&&l.Q(z)&&l.N(z)||k.push(new l.V(a,u,`${U} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return k.concat(mi({key:r.key,value:u,valueSpec:B,style:d,styleSpec:p,expressionContext:"property",propertyType:e,propertyKey:U}))}function pn(r){return xl(r,"paint")}function al(r){return xl(r,"layout")}function Fa(r){let e=[],a=r.value,d=r.key,m=r.style,p=r.styleSpec;a.type||a.ref||e.push(new l.V(d,a,'either "type" or "ref" is required'));let u=l.D(a.type),U=l.D(a.ref);if(a.id){let Y=l.D(a.id);for(let y=0;y<r.arrayIndex;y++){let B=m.layers[y];l.D(B.id)===Y&&e.push(new l.V(d,a.id,`duplicate layer id "${a.id}", previously used at line ${B.id.__line__}`))}}if("ref"in a){let Y;["type","source","source-layer","filter","layout"].forEach(y=>{y in a&&e.push(new l.V(d,a[y],`"${y}" is prohibited for ref layers`))}),m.layers.forEach(y=>{l.D(y.id)===U&&(Y=y)}),Y?Y.ref?e.push(new l.V(d,a.ref,"ref cannot reference another ref layer")):u=l.D(Y.type):typeof U=="string"&&e.push(new l.V(d,a.ref,`ref layer "${U}" not found`))}else if(u!=="background"&&u!=="sky"&&u!=="slot")if(a.source){let Y=m.sources&&m.sources[a.source],y=Y&&l.D(Y.type);Y?y==="vector"&&u==="raster"?e.push(new l.V(d,a.source,`layer "${a.id}" requires a raster source`)):y==="raster"&&u!=="raster"?e.push(new l.V(d,a.source,`layer "${a.id}" requires a vector source`)):y!=="vector"||a["source-layer"]?y==="raster-dem"&&u!=="hillshade"?e.push(new l.V(d,a.source,"raster-dem source can only be used with layer type 'hillshade'.")):y!=="raster-array"||["raster","raster-particle"].includes(u)?u!=="line"||!a.paint||!a.paint["line-gradient"]&&!a.paint["line-trim-offset"]||y==="geojson"&&Y.lineMetrics?u==="raster-particle"&&y!=="raster-array"&&e.push(new l.V(d,a.source,`layer "${a.id}" requires a 'raster-array' source.`)):e.push(new l.V(d,a,`layer "${a.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new l.V(d,a.source,"raster-array source can only be used with layer type 'raster'.")):e.push(new l.V(d,a,`layer "${a.id}" must specify a "source-layer"`)):e.push(new l.V(d,a.source,`source "${a.source}" not found`))}else e.push(new l.V(d,a,'missing required property "source"'));return e=e.concat(Za({key:d,value:a,valueSpec:p.layer,style:r.style,styleSpec:r.styleSpec,objectElementValidators:{"*":()=>[],type:()=>mi({key:`${d}.type`,value:a.type,valueSpec:p.layer.type,style:r.style,styleSpec:r.styleSpec,object:a,objectKey:"type"}),filter:Y=>zn(l.C({layerType:u},Y)),layout:Y=>Za({layer:a,key:Y.key,value:Y.value,valueSpec:{},style:Y.style,styleSpec:Y.styleSpec,objectElementValidators:{"*":y=>al(l.C({layerType:u},y))}}),paint:Y=>Za({layer:a,key:Y.key,value:Y.value,valueSpec:{},style:Y.style,styleSpec:Y.styleSpec,objectElementValidators:{"*":y=>pn(l.C({layerType:u,layer:a},y))}})}})),e}function va(r){let e=r.value,a=r.key,d=l.B(e);return d!=="string"?[new l.V(a,e,`string expected, ${d} found`)]:[]}let Al={promoteId:function({key:r,value:e}){if(l.B(e)==="string")return va({key:r,value:e});{let a=[];for(let d in e)a.push(...va({key:`${r}.${d}`,value:e[d]}));return a}}};function As(r){let e=r.value,a=r.key,d=r.styleSpec,m=r.style;if(!e.type)return[new l.V(a,e,'"type" is required')];let p=l.D(e.type),u=[];switch(["vector","raster","raster-dem","raster-array"].includes(p)&&(e.url||e.tiles||u.push(new l.A(a,e,'Either "url" or "tiles" is required.'))),p){case"vector":case"raster":case"raster-dem":case"raster-array":return u=u.concat(Za({key:a,value:e,valueSpec:d[`source_${p.replace("-","_")}`],style:r.style,styleSpec:d,objectElementValidators:Al})),u;case"geojson":if(u=Za({key:a,value:e,valueSpec:d.source_geojson,style:m,styleSpec:d,objectElementValidators:Al}),e.cluster)for(let U in e.clusterProperties){let[Y,y]=e.clusterProperties[U],B=typeof Y=="string"?[Y,["accumulated"],["get",U]]:Y;u.push(...hn({key:`${a}.${U}.map`,value:y,expressionContext:"cluster-map"})),u.push(...hn({key:`${a}.${U}.reduce`,value:B,expressionContext:"cluster-reduce"}))}return u;case"video":return Za({key:a,value:e,valueSpec:d.source_video,style:m,styleSpec:d});case"image":return Za({key:a,value:e,valueSpec:d.source_image,style:m,styleSpec:d});case"canvas":return[new l.V(a,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return fa({key:`${a}.type`,value:e.type,valueSpec:{values:ko(d)},style:m,styleSpec:d})}}function ko(r){return r.source.reduce((e,a)=>{let d=r[a];return d.type.type==="enum"&&(e=e.concat(Object.keys(d.type.values))),e},[])}function Nl(r){let e=r.value,a=r.styleSpec,d=a.light,m=r.style,p=[],u=l.B(e);if(e===void 0)return p;if(u!=="object")return p=p.concat([new l.V("light",e,`object expected, ${u} found`)]),p;for(let U in e){let Y=U.match(/^(.*)-transition$/);p=p.concat(Y&&d[Y[1]]&&d[Y[1]].transition?mi({key:U,value:e[U],valueSpec:a.transition,style:m,styleSpec:a}):d[U]?mi({key:U,value:e[U],valueSpec:d[U],style:m,styleSpec:a}):[new l.V(U,e[U],`unknown property "${U}"`)])}return p}function co(r){let e=r.value,a=[];if(!e)return a;let d=l.B(e);if(d!=="object")return a=a.concat([new l.V("light-3d",e,`object expected, ${d} found`)]),a;let m=r.styleSpec,p=m["light-3d"],u=r.key,U=r.style,Y=r.style.lights;for(let C of["type","id"])if(!(C in e))return a=a.concat([new l.V("light-3d",e,`missing property ${C} on light`)]),a;if(e.type&&Y)for(let C=0;C<r.arrayIndex;C++){let k=l.D(e.type),Q=Y[C];l.D(Q.type)===k&&a.push(new l.V(u,e.id,`duplicate light type "${e.type}", previously defined at line ${Q.id.__line__}`))}let y=`properties_light_${e.type}`;if(!(y in m))return a=a.concat([new l.V("light-3d",e,`Invalid light type ${e.type}`)]),a;let B=m[y];for(let C in e)if(C==="properties"){let k=e[C],Q=l.B(k);if(Q!=="object")return a=a.concat([new l.V("properties",k,`object expected, ${Q} found`)]),a;for(let z in k)a=a.concat(B[z]?mi({key:z,value:k[z],valueSpec:B[z],style:U,styleSpec:m}):[new l.A(r.key,k[z],`unknown property "${z}"`)])}else{let k=C.match(/^(.*)-transition$/);a=a.concat(k&&p[k[1]]&&p[k[1]].transition?mi({key:C,value:e[C],valueSpec:m.transition,style:U,styleSpec:m}):p[C]?mi({key:C,value:e[C],valueSpec:p[C],style:U,styleSpec:m}):[new l.A(C,e[C],`unknown property "${C}"`)])}return a}function So(r){let e=r.value,a=r.key,d=r.style,m=r.styleSpec,p=m.terrain,u=[],U=l.B(e);if(e===void 0||U==="null")return u;if(U!=="object")return u=u.concat([new l.V("terrain",e,`object expected, ${U} found`)]),u;for(let Y in e){let y=Y.match(/^(.*)-transition$/);u=u.concat(y&&p[y[1]]&&p[y[1]].transition?mi({key:Y,value:e[Y],valueSpec:m.transition,style:d,styleSpec:m}):p[Y]?mi({key:Y,value:e[Y],valueSpec:p[Y],style:d,styleSpec:m}):[new l.A(Y,e[Y],`unknown property "${Y}"`)])}if(e.source){let Y=d.sources&&d.sources[e.source],y=Y&&l.D(Y.type);Y?y!=="raster-dem"&&u.push(new l.V(a,e.source,`terrain cannot be used with a source of type ${String(y)}, it only be used with a "raster-dem" source type`)):u.push(new l.V(a,e.source,`source "${e.source}" not found`))}else u.push(new l.V(a,e,'terrain is missing required property "source"'));return u}function Xn(r){let e=r.value,a=r.style,d=r.styleSpec,m=d.fog,p=[],u=l.B(e);if(e===void 0)return p;if(u!=="object")return p=p.concat([new l.V("fog",e,`object expected, ${u} found`)]),p;for(let U in e){let Y=U.match(/^(.*)-transition$/);p=p.concat(Y&&m[Y[1]]&&m[Y[1]].transition?mi({key:U,value:e[U],valueSpec:d.transition,style:a,styleSpec:d}):m[U]?mi({key:U,value:e[U],valueSpec:m[U],style:a,styleSpec:d}):[new l.A(U,e[U],`unknown property "${U}"`)])}return p}let Hs={"*":()=>[],array:Ln,boolean:function(r){let e=r.value,a=r.key,d=l.B(e);return d!=="boolean"?[new l.V(a,e,`boolean expected, ${d} found`)]:[]},number:ti,color:function(r){let e=r.key,a=r.value,d=l.B(a);return d!=="string"?[new l.V(e,a,`color expected, ${d} found`)]:l.U.parseCSSColor(a)===null?[new l.V(e,a,`color expected, "${a}" found`)]:[]},enum:fa,filter:zn,function:sa,layer:Fa,object:Za,source:As,model:l.Z,light:Nl,"light-3d":co,terrain:So,fog:Xn,string:va,formatted:function(r){return va(r).length===0?[]:hn(r)},resolvedImage:function(r){return va(r).length===0?[]:hn(r)},projection:function(r){let e=r.value,a=r.styleSpec,d=a.projection,m=r.style,p=[],u=l.B(e);if(u==="object")for(let U in e)p=p.concat(mi({key:U,value:e[U],valueSpec:d[U],style:m,styleSpec:a}));else u!=="string"&&(p=p.concat([new l.V("projection",e,`object or string expected, ${u} found`)]));return p},import:function(r){let{value:e,styleSpec:a}=r,{data:d,...m}=e;Object.defineProperty(m,"__line__",{value:e.__line__,enumerable:!1});let p=Za(l.C({},r,{value:m,valueSpec:a.import}));return l.D(m.id)===""&&p.push(new l.V(`${r.key}.id`,m,"import id can't be an empty string")),d&&(p=p.concat($r(d,a,{key:`${r.key}.data`}))),p}};function mi(r,e=!1){let a=r.value,d=r.valueSpec,m=r.styleSpec;if(d.expression&&l.X(l.D(a)))return sa(r);if(d.expression&&l.J(l.K(a)))return hn(r);if(d.type&&Hs[d.type]){let p=Hs[d.type](r);return e===!0&&p.length>0&&l.B(r.value)==="array"?hn(r):p}return Za(l.C({},r,{valueSpec:d.type?m[d.type]:d}))}function nl(r){let e=r.value,a=r.key,d=va(r);return d.length||(e.indexOf("{fontstack}")===-1&&d.push(new l.V(a,e,'"glyphs" url must include a "{fontstack}" token')),e.indexOf("{range}")===-1&&d.push(new l.V(a,e,'"glyphs" url must include a "{range}" token'))),d}function $r(r,e=l._,a={}){return mi({key:a.key||"",value:r,valueSpec:e.$root,styleSpec:e,style:r,objectElementValidators:{glyphs:nl,"*":()=>[]}})}function Wn(r,e=l._){return mt($r(r,e))}let bo=r=>mt(As(r)),js=r=>mt(Nl(r)),Qo=r=>mt(co(r)),Os=r=>mt(So(r)),mo=r=>mt(Xn(r)),Tt=r=>mt(Fa(r)),j=r=>mt(zn(r)),_=r=>mt(pn(r)),ot=r=>mt(al(r)),pt=r=>mt(l.Z(r));function mt(r){return r.slice().sort((e,a)=>e.line&&a.line?e.line-a.line:0)}function Ut(r,e){let a=!1;if(e&&e.length)for(let d of e)d instanceof l.A?l.w(d.message):(r.fire(new l.t(new Error(d.message))),a=!0);return a}let Bt;class Jt extends l.E{constructor(e,a="flat"){super(),this._transitionable=new l.$(Bt||(Bt=new l.a0({anchor:new l.a1(l._.light.anchor),position:new l.a2(l._.light.position),color:new l.a1(l._.light.color),intensity:new l.a1(l._.light.intensity)}))),this.setLight(e,a),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,a,d={}){this._validate(js,e,d)||(this._transitionable.setTransitionOrValue(e),this.id=a)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,a,d){return(!d||d.validate!==!1)&&Ut(this,e.call(Wn,l.l({value:a,style:{glyphs:!0,sprite:!0},styleSpec:l._})))}}let Mt=new l.a0({source:new l.a1(l._.terrain.source),exaggeration:new l.a1(l._.terrain.exaggeration)}),Et=class extends l.E{constructor(r,e,a,d){super(),this.scope=a,this._transitionable=new l.$(Mt,a,d),this._transitionable.setTransitionOrValue(r,d),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=e}get(){return this._transitionable.serialize()}set(r,e){this._transitionable.setTransitionOrValue(r,e)}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}getExaggeration(r){return this._transitioning.possiblyEvaluate(new l.a3(r)).get("exaggeration")}isZoomDependent(){let r=this._transitionable._values.exaggeration;return r!=null&&r.value!=null&&r.value.expression!=null&&r.value.expression instanceof l.a4}},Qt=45,Dt=65,de=.05;function ce(r,e,a,d){let m=l.a7(Qt,Dt,a),[p,u]=ke(r,d),U=1-Math.min(1,Math.exp((e-p)/(u-p)*-6));return U*=U*U,U=Math.min(1,1.00747*U),U*m*r.alpha}function ke(r,e){let a=.5/Math.tan(.5*e);return[r.range[0]+a,r.range[1]+a]}function fe(r,e,a,d,m){let p=l.a6.vec3.transformMat4([],[e,a,d],m.mercatorFogMatrix);return ce(r,l.a6.vec3.length(p),m.pitch,m._fov)}function Ee(r,e,a,d,m,p,u){let U=[[a,d,0],[m,d,0],[m,p,0],[a,p,0]],Y=Number.MAX_VALUE,y=-Number.MAX_VALUE;for(let B of U){let C=l.a6.vec3.transformMat4([],B,e),k=l.a6.vec3.length(C);Y=Math.min(Y,k),y=Math.max(y,k)}return[ce(r,Y,u.pitch,u._fov),ce(r,y,u.pitch,u._fov)]}let ve=new l.a0({range:new l.a1(l._.fog.range),color:new l.a1(l._.fog.color),"high-color":new l.a1(l._.fog["high-color"]),"space-color":new l.a1(l._.fog["space-color"]),"horizon-blend":new l.a1(l._.fog["horizon-blend"]),"star-intensity":new l.a1(l._.fog["star-intensity"]),"vertical-range":new l.a1(l._.fog["vertical-range"])});class Vi extends l.E{constructor(e,a,d,m){super(),this._transitionable=new l.$(ve,d,new Map(m)),this.set(e,m),this._transitioning=this._transitionable.untransitioned(),this._transform=a,this.properties=new l.a8(ve),this.scope=d}get state(){let e=this._transform,a=e.projection.name==="globe",d=l.a9(e.zoom),m=this.properties.get("range"),p=[.5,3];return{range:a?[l.aa(p[0],m[0],d),l.aa(p[1],m[1],d)]:m,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(e,a,d={}){if(this._validate(mo,e,d))return;let m=l.l({},e);for(let p of Object.keys(l._.fog))m[p]===void 0&&(m[p]=l._.fog[p].default);this._options=m,this._transitionable.setTransitionOrValue(this._options,a)}getOpacity(e){if(!this._transform.projection.supportsFog)return 0;let a=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:l.a7(Qt,Dt,e))*a.a}getOpacityAtLatLng(e,a){return this._transform.projection.supportsFog?function(d,m,p){let u=l.a5.fromLngLat(m),U=p.elevation?p.elevation.getAtPointOrZero(u):0;return fe(d,u.x,u.y,U,p)}(this.state,e,a):0}getOpacityForTile(e){if(!this._transform.projection.supportsFog)return[1,1];let a=this._transform.calculateFogTileMatrix(e.toUnwrapped());return Ee(this.state,a,0,0,l.ab,l.ab,this._transform)}getOpacityForBounds(e,a,d,m,p){return this._transform.projection.supportsFog?Ee(this.state,e,a,d,m,p,this._transform):[1,1]}getFovAdjustedRange(e){return this._transform.projection.supportsFog?ke(this.state,e):[0,1]}isVisibleOnFrustum(e){if(!this._transform.projection.supportsFog)return!1;let a=[4,5,6,7];for(let d of a){let m=e.points[d],p;if(m[2]>=0)p=m;else{let u=e.points[d-4];p=l.ac(u,m,u[2]/(u[2]-m[2]))}if(fe(this.state,p[0],p[1],0,this._transform)>=de)return!0}return!1}updateConfig(e){this._transitionable.setTransitionOrValue(this._options,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,a,d){return(!d||d.validate!==!1)&&Ut(this,e.call(Wn,l.l({value:a,style:{glyphs:!0,sprite:!0},styleSpec:l._})))}}class xi extends l.E{constructor(e,a,d,m){super(),this.scope=d,this._options=e,this.properties=new l.a8(a),this._transitionable=new l.$(a,d,new Map(m)),this._transitionable.setTransitionOrValue(e.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(e){this._transitionable.setTransitionOrValue(this._options.properties,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(e,a){this._options=e,this._transitionable.setTransitionOrValue(e.properties,a)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}let Oe,Ii;class zi{constructor(e,a,d,m){this.screenBounds=e,this.cameraPoint=a,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=d,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,m)}static createFromScreenPoints(e,a){let d,m;if(e instanceof l.P||typeof e[0]=="number"){let p=l.P.convert(e);d=[p],m=a.isPointAboveHorizon(p)}else{let p=l.P.convert(e[0]),u=l.P.convert(e[1]);d=[p,u],m=l.ae(p,u).every(U=>a.isPointAboveHorizon(U))}return new zi(d,a.getCameraPoint(),m,a)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(e){return l.ae(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],e)}bufferedCameraGeometry(e){let a=this.screenBounds[0],d=this.screenBounds.length===1?this.screenBounds[0].add(new l.P(1,1)):this.screenBounds[1],m=l.ae(a,d,0,!1);return this.cameraPoint.y>d.y&&(this.cameraPoint.x>a.x&&this.cameraPoint.x<d.x?m.splice(3,0,this.cameraPoint):this.cameraPoint.x>=d.x?m[2]=this.cameraPoint:this.cameraPoint.x<=a.x&&(m[3]=this.cameraPoint)),l.af(m,e)}bufferedCameraGeometryGlobe(e){let a=this.screenBounds[0],d=this.screenBounds.length===1?this.screenBounds[0].add(new l.P(1,1)):this.screenBounds[1],m=l.ae(a,d,e),p=this.cameraPoint.clone();switch(3*((p.y>a.y)+(p.y>d.y))+((p.x>a.x)+(p.x>d.x))){case 0:m[0]=p,m[4]=p.clone();break;case 1:m.splice(1,0,p);break;case 2:m[1]=p;break;case 3:m.splice(4,0,p);break;case 5:m.splice(2,0,p);break;case 6:m[3]=p;break;case 7:m.splice(3,0,p);break;case 8:m[2]=p}return m}containsTile(e,a,d,m=0){let p=e.queryPadding/a._pixelsPerMercatorPixel+1,u=d?this._bufferedCameraMercator(p,a):this._bufferedScreenMercator(p,a),U=e.tileID.wrap+(u.unwrapped?m:0),Y=u.polygon.map(A=>l.ag(e.tileTransform,A,U));if(!l.ah(Y,0,0,l.ab,l.ab))return;U=e.tileID.wrap+(this.screenGeometryMercator.unwrapped?m:0);let y=this.screenGeometryMercator.polygon.map(A=>l.ai(e.tileTransform,A,U)),B=y.map(A=>new l.P(A[0],A[1])),C=a.getFreeCameraOptions().position||new l.a5(0,0,0),k=l.ai(e.tileTransform,C,U),Q=y.map(A=>{let H=l.a6.vec3.sub(A,A,k);return l.a6.vec3.normalize(H,H),new l.aj(k,H)}),z=l.ak(e,1,a.zoom)*a._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:B,tilespaceRays:Q,bufferedTilespaceGeometry:Y,bufferedTilespaceBounds:(w=l.al(Y),w.min.x=l.ap(w.min.x,0,l.ab),w.min.y=l.ap(w.min.y,0,l.ab),w.max.x=l.ap(w.max.x,0,l.ab),w.max.y=l.ap(w.max.y,0,l.ab),w),tile:e,tileID:e.tileID,pixelToTileUnitsFactor:z};var w}_bufferedScreenMercator(e,a){let d=Ya(e);if(this._screenRaycastCache[d])return this._screenRaycastCache[d];{let m;return m=a.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(e),a):{polygon:this.bufferedScreenGeometry(e).map(p=>a.pointCoordinate3D(p)),unwrapped:!0},this._screenRaycastCache[d]=m,m}}_bufferedCameraMercator(e,a){let d=Ya(e);if(this._cameraRaycastCache[d])return this._cameraRaycastCache[d];{let m;return m=a.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(e),a):{polygon:this.bufferedCameraGeometry(e).map(p=>a.pointCoordinate3D(p)),unwrapped:!0},this._cameraRaycastCache[d]=m,m}}_projectAndResample(e,a){let d=function(p,u){let U=l.a6.mat4.multiply([],u.pixelMatrix,u.globeMatrix),Y=[0,-l.aq,0,1],y=[0,l.aq,0,1],B=[0,0,0,1];l.a6.vec4.transformMat4(Y,Y,U),l.a6.vec4.transformMat4(y,y,U),l.a6.vec4.transformMat4(B,B,U);let C=new l.P(Y[0]/Y[3],Y[1]/Y[3]),k=new l.P(y[0]/y[3],y[1]/y[3]),Q=l.an(p,C)&&Y[3]<B[3],z=l.an(p,k)&&y[3]<B[3];if(!Q&&!z)return null;let w=function(ct,rt,bt){for(let gt=1;gt<ct.length;gt++){let Wt=ba(rt.pointCoordinate3D(ct[gt-1]).x),ht=ba(rt.pointCoordinate3D(ct[gt]).x);if(bt<0){if(Wt<ht)return{idx:gt,t:-Wt/(ht-1-Wt)}}else if(ht<Wt)return{idx:gt,t:(1-Wt)/(ht+1-Wt)}}return null}(p,u,Q?-1:1);if(!w)return null;let{idx:A,t:H}=w,$=A>1?ra(p.slice(0,A),u):[],et=A<p.length?ra(p.slice(A),u):[];$=$.map(ct=>new l.P(ba(ct.x),ct.y)),et=et.map(ct=>new l.P(ba(ct.x),ct.y));let K=[...$];K.length===0&&K.push(et[et.length-1]);let nt=l.aa(K[K.length-1].y,(et.length===0?$[0]:et[0]).y,H),at;return at=Q?[new l.P(0,nt),new l.P(0,0),new l.P(1,0),new l.P(1,nt)]:[new l.P(1,nt),new l.P(1,1),new l.P(0,1),new l.P(0,nt)],K.push(...at),et.length===0?K.push($[0]):K.push(...et),{polygon:K.map(ct=>new l.a5(ct.x,ct.y)),unwrapped:!1}}(e,a);if(d)return d;let m=function(p,u){let U=!1,Y=-1/0,y=0;for(let C=0;C<p.length-1;C++)p[C].x>Y&&(Y=p[C].x,y=C);for(let C=0;C<p.length-1;C++){let k=(y+C)%(p.length-1),Q=p[k],z=p[k+1];Math.abs(Q.x-z.x)>.5&&(Q.x<z.x?(Q.x+=1,k===0&&(p[p.length-1].x+=1)):(z.x+=1,k+1===p.length-1&&(p[0].x+=1)),U=!0)}let B=l.am(u.center.lng);return U&&B<Math.abs(B-1)&&p.forEach(C=>{C.x-=1}),{polygon:p,unwrapped:U}}(ra(e,a).map(p=>new l.P(ba(p.x),p.y)),a);return{polygon:m.polygon.map(p=>new l.a5(p.x,p.y)),unwrapped:m.unwrapped}}}function ra(r,e){return l.ao(r,a=>{let d=e.pointCoordinate3D(a);a.x=d.x,a.y=d.y},1/256)}function ba(r){return r<0?1+r%1:r%1}function Ya(r){return 100*r|0}function wn(r,e,a,d,m){let p=function(U,Y){if(U)return m(U);if(Y){if(r.url&&Y.tiles&&r.tiles&&delete r.tiles,Y.variants){if(!Array.isArray(Y.variants))return m(new Error("variants must be an array"));for(let B of Y.variants){if(B==null||typeof B!="object"||B.constructor!==Object)return m(new Error("variant must be an object"));if(!Array.isArray(B.capabilities))return m(new Error("capabilities must be an array"));if(B.capabilities.length===1&&B.capabilities[0]==="meshopt"){Y=l.l(Y,B);break}}}let y=l.ar(l.l(Y,r),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);Y.vector_layers&&(y.vectorLayers=Y.vector_layers,y.vectorLayerIds=y.vectorLayers.map(B=>B.id)),Y.raster_layers&&(y.rasterLayers=Y.raster_layers,y.rasterLayerIds=y.rasterLayers.map(B=>B.id)),y.tiles=e.canonicalizeTileset(y,r.url),m(null,y)}},u=function(U,Y,y){if(!U)return null;if(!Y&&!y)return U;y=y||U.worldview_default;let B=Object.values(U.language||{});if(B.length===0)return null;let C=Object.values(U.worldview||{});if(C.length===0)return null;let k=B.every(z=>z===Y),Q=C.every(z=>z===y);return k&&Q?U:Y in(U.language_options||{})||y in(U.worldview_options||{})?null:U.language_options&&U.worldview_options?U:null}(r.data,a,d);return u?l.q.frame(()=>p(null,u)):r.url?l.n(e.transformRequest(e.normalizeSourceURL(r.url,null,a,d),l.R.Source),p):l.q.frame(()=>{let{data:U,...Y}=r;p(null,Y)})}class Yl{constructor(e,a,d){this.bounds=l.as.convert(this.validateBounds(e)),this.minzoom=a||0,this.maxzoom=d||24}validateBounds(e){return Array.isArray(e)&&e.length===4?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]}contains(e){let a=Math.pow(2,e.z),d=Math.floor(l.am(this.bounds.getWest())*a),m=Math.floor(l.at(this.bounds.getNorth())*a),p=Math.ceil(l.am(this.bounds.getEast())*a),u=Math.ceil(l.at(this.bounds.getSouth())*a);return e.x>=d&&e.x<p&&e.y>=m&&e.y<u}}class td extends l.E{constructor(e,a,d,m){if(super(),this.id=e,this.dispatcher=d,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,l.l(this,l.ar(a,["url","scheme","tileSize","promoteId"])),this._options=l.l({type:"vector"},a),this._collectResourceTiming=!!a.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(m),this._tileWorkers={},this._deduped=new l.au}load(e){this._loaded=!1,this.fire(new l.x("dataloading",{dataType:"source"}));let a=Array.isArray(this.map._language)?this.map._language.join():this.map._language,d=this.map._worldview;this._tileJSONRequest=wn(this._options,this.map._requestManager,a,d,(m,p)=>{this._tileJSONRequest=null,this._loaded=!0,m?(a&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${a}`),d&&d.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${d}`),this.fire(new l.t(m))):p&&(l.l(this,p),p.bounds&&(this.tileBounds=new Yl(p.bounds,this.minzoom,this.maxzoom)),fn(p.tiles,this.map._requestManager._customAccessToken),this.fire(new l.x("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.x("data",{dataType:"source",sourceDataType:"content"}))),e&&e(m)})}loaded(){return this._loaded}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();let e=l.av(this.id,this.scope);this.load(()=>this.map.style.clearSource(e))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return l.l({},this._options)}loadTile(e,a){let d=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme)),m=this.map._requestManager.transformRequest(d,l.R.Tile),p=this.map.style?this.map.style.getLut(this.scope):null,u={request:m,data:void 0,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,lut:p?{image:p.image.clone()}:null,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:l.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:e.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:e.isExtraShadowCaster,tessellationStep:this.map._tessellationStep};if(u.request.collectResourceTiming=this._collectResourceTiming,e.actor&&e.state!=="expired")e.state==="loading"?e.reloadCallback=a:e.request=e.actor.send("reloadTile",u,U.bind(this));else if(e.actor=this._tileWorkers[d]=this._tileWorkers[d]||this.dispatcher.getActor(),this.dispatcher.ready)e.request=e.actor.send("loadTile",u,U.bind(this),void 0,!0);else{let Y=l.aw.call({deduped:this._deduped},u,(y,B)=>{y||!B?U.call(this,y):(u.data={cacheControl:B.cacheControl,expires:B.expires,rawData:B.rawData.slice(0)},e.actor&&e.actor.send("loadTile",u,U.bind(this),void 0,!0))},!0);e.request={cancel:Y}}function U(Y,y){return delete e.request,e.aborted?a(null):Y&&Y.status!==404?a(Y):(y&&y.resourceTiming&&(e.resourceTiming=y.resourceTiming),this.map._refreshExpiredTiles&&y&&e.setExpiryData(y),e.loadVectorData(y,this.map.painter),l.ax(this.dispatcher),a(null),void(e.reloadCallback&&(this.loadTile(e,e.reloadCallback),e.reloadCallback=null)))}}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(e,a){e.actor&&e.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope}),e.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Ds extends l.E{constructor(e,a,d,m){super(),this.id=e,this.dispatcher=d,this.setEventedParent(m),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=l.l({type:"raster"},a),l.l(this,l.ar(a,["url","scheme","tileSize"]))}load(e){this._loaded=!1,this.fire(new l.x("dataloading",{dataType:"source"})),this._tileJSONRequest=wn(this._options,this.map._requestManager,null,null,(a,d)=>{this._tileJSONRequest=null,this._loaded=!0,a?this.fire(new l.t(a)):d&&(l.l(this,d),d.bounds&&(this.tileBounds=new Yl(d.bounds,this.minzoom,this.maxzoom)),fn(d.tiles),this.fire(new l.x("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.x("data",{dataType:"source",sourceDataType:"content"}))),e&&e(a)})}loaded(){return this._loaded}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();let e=l.av(this.id,this.scope);this.load(()=>this.map.style.clearSource(e))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return l.l({},this._options)}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e,a){let d=l.q.devicePixelRatio>=2,m=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),d,this.tileSize);e.request=l.o(this.map._requestManager.transformRequest(m,l.R.Tile),(p,u,U,Y)=>(delete e.request,e.aborted?(e.state="unloaded",a(null)):p?(e.state="errored",a(p)):u?(this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:U,expires:Y}),e.setTexture(u,this.map.painter),e.state="loaded",l.ax(this.dispatcher),void a(null)):a(null)))}abortTile(e,a){e.request&&(e.request.cancel(),delete e.request),a&&a()}unloadTile(e,a){e.texture&&e.texture instanceof l.T?(e.destroy(!0),e.texture&&e.texture instanceof l.T&&this.map.painter.saveTileTexture(e.texture)):e.destroy(),a&&a()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class fo extends Ds{constructor(e,a,d,m){super(e,a,d,m),this.type="raster-array",this.maxzoom=22,this._options=l.l({type:"raster-array"},a)}triggerRepaint(e){let a=this.map.painter._terrain,d=this.map.style.getSourceCache(this.id);a&&a.enabled&&d&&a._clearRenderCacheForTile(d.id,e.tileID),this.map.triggerRepaint()}loadTile(e,a){let d=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),m=this.map._requestManager.transformRequest(d,l.R.Tile);e.requestParams=m,e.actor||(e.actor=this.dispatcher.getActor()),e.request=e.fetchHeader(void 0,(p,u,U,Y)=>{if(delete e.request,e.aborted)return e.state="unloaded",a(null);if(p)return p.code===20?void 0:(e.state="errored",a(p));this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:U,expires:Y}),e.state="empty",a(null)})}unloadTile(e,a){let d=e.texture;d&&d instanceof l.T?(e.destroy(!0),this.map.painter.saveTileTexture(d)):(e.destroy(),e.flushQueues(),e._isHeaderLoaded=!1,delete e._mrt,delete e.textureDescriptor),e.fbo&&(e.fbo.destroy(),delete e.fbo),delete e.request,delete e.requestParams,delete e.neighboringTiles,e.state="unloaded"}prepareTile(e,a,d){e._isHeaderLoaded&&(e.state!=="empty"&&(e.state="reloading"),e.fetchBand(a,d,(m,p)=>{if(m)return e.state="errored",this.fire(new l.t(m)),void this.triggerRepaint(e);p&&(e.setTexture(p,this.map.painter),e.state="loaded",this.triggerRepaint(e))}))}getInitialBand(e){if(!this.rasterLayers)return 0;let a=this.rasterLayers.find(({id:p})=>p===e),d=a&&a.fields,m=d&&d.bands&&d.bands;return m?m[0]:0}getTextureDescriptor(e,a,d){if(!e)return;let m=a.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!m)return;let p=null;a instanceof l.aB?p=a.paint.get("raster-array-band"):a instanceof l.aC&&(p=a.paint.get("raster-particle-array-band"));let u=p||this.getInitialBand(m);if(u!=null)if(e.textureDescriptor){if(!e.updateNeeded(m,u)||d)return Object.assign({},e.textureDescriptor,{texture:e.texture})}else this.prepareTile(e,m,u)}}let ed={vector:td,raster:Ds,"raster-dem":class extends Ds{constructor(r,e,a,d){super(r,e,a,d),this.type="raster-dem",this.maxzoom=22,this._options=l.l({type:"raster-dem"},e),this.encoding=e.encoding||"mapbox"}loadTile(r,e){let a=this.map._requestManager.normalizeTileURL(r.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function d(m,p){m&&(r.state="errored",e(m)),p&&(r.dem=p,r.dem.onDeserialize(),r.needsHillshadePrepare=!0,r.needsDEMTextureUpload=!0,r.state="loaded",e(null))}r.request=l.o(this.map._requestManager.transformRequest(a,l.R.Tile),(function(m,p,u,U){if(delete r.request,r.aborted)r.state="unloaded",e(null);else if(m)r.state="errored",e(m);else if(p){this.map._refreshExpiredTiles&&r.setExpiryData({cacheControl:u,expires:U});let Y=ImageBitmap&&p instanceof ImageBitmap&&l.ay(),y=1-(p.width-l.az(p.width))/2;y<1||r.neighboringTiles||(r.neighboringTiles=this._getNeighboringTiles(r.tileID));let B=Y?p:l.q.getImageData(p,y),C={uid:r.uid,coord:r.tileID,source:this.id,scope:this.scope,rawImageData:B,encoding:this.encoding,padding:y};r.actor&&r.state!=="expired"||(r.actor=this.dispatcher.getActor(),r.actor.send("loadDEMTile",C,d.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(r){let e=r.canonical,a=Math.pow(2,e.z),d=(e.x-1+a)%a,m=e.x===0?r.wrap-1:r.wrap,p=(e.x+1+a)%a,u=e.x+1===a?r.wrap+1:r.wrap,U={};return U[new l.aA(r.overscaledZ,m,e.z,d,e.y).key]={backfilled:!1},U[new l.aA(r.overscaledZ,u,e.z,p,e.y).key]={backfilled:!1},e.y>0&&(U[new l.aA(r.overscaledZ,m,e.z,d,e.y-1).key]={backfilled:!1},U[new l.aA(r.overscaledZ,r.wrap,e.z,e.x,e.y-1).key]={backfilled:!1},U[new l.aA(r.overscaledZ,u,e.z,p,e.y-1).key]={backfilled:!1}),e.y+1<a&&(U[new l.aA(r.overscaledZ,m,e.z,d,e.y+1).key]={backfilled:!1},U[new l.aA(r.overscaledZ,r.wrap,e.z,e.x,e.y+1).key]={backfilled:!1},U[new l.aA(r.overscaledZ,u,e.z,p,e.y+1).key]={backfilled:!1}),U}},"raster-array":fo,geojson:class extends l.E{constructor(r,e,a,d){super(),this.id=r,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=a.getActor(),this.setEventedParent(d),this._data=e.data,this._options=l.l({},e),this._collectResourceTiming=e.collectResourceTiming,e.maxzoom!==void 0&&(this.maxzoom=e.maxzoom),e.minzoom!==void 0&&(this.minzoom=e.minzoom),e.type&&(this.type=e.type),e.attribution&&(this.attribution=e.attribution),this.promoteId=e.promoteId;let m=l.ab/this.tileSize;this.workerOptions=l.l({source:this.id,scope:this.scope,cluster:e.cluster||!1,geojsonVtOptions:{buffer:(e.buffer!==void 0?e.buffer:128)*m,tolerance:(e.tolerance!==void 0?e.tolerance:.375)*m,extent:l.ab,maxZoom:this.maxzoom,lineMetrics:e.lineMetrics||!1,generateId:e.generateId||!1},superclusterOptions:{maxZoom:e.clusterMaxZoom!==void 0?e.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,e.clusterMinPoints||2),extent:l.ab,radius:(e.clusterRadius!==void 0?e.clusterRadius:50)*m,log:!1,generateId:e.generateId||!1},clusterProperties:e.clusterProperties,filter:e.filter,dynamic:e.dynamic},e.workerOptions)}onAdd(r){this.map=r,this.setData(this._data)}setData(r){return this._data=r,this._updateWorkerData(),this}updateData(r){if(!this._options.dynamic)return this.fire(new l.t(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof r!="string"&&(r.type==="Feature"&&(r={type:"FeatureCollection",features:[r]}),r.type!=="FeatureCollection"))return this.fire(new l.t(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof r!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){let e=new Map;for(let a of this._data.features)e.set(a.id,a);for(let a of r.features)e.set(a.id,a);this._data.features=[...e.values()]}else this._data=r;return this._updateWorkerData(!0),this}getClusterExpansionZoom(r,e){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:r,source:this.id,scope:this.scope},e),this}getClusterChildren(r,e){return this.actor.send("geojson.getClusterChildren",{clusterId:r,source:this.id,scope:this.scope},e),this}getClusterLeaves(r,e,a,d){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:r,limit:e,offset:a},d),this}_updateWorkerData(r=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new l.x("dataloading",{dataType:"source"})),this._loaded=!1;let e=l.l({append:r},this.workerOptions);e.scope=this.scope;let a=this._data;typeof a=="string"?(e.request=this.map._requestManager.transformRequest(l.q.resolveURL(a),l.R.Source),e.request.collectResourceTiming=this._collectResourceTiming):e.data=JSON.stringify(a),this._pendingLoad=this.actor.send(`${this.type}.loadData`,e,(d,m)=>{if(this._loaded=!0,this._pendingLoad=null,d)this.fire(new l.t(d));else{let p={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&m&&m.resourceTiming&&m.resourceTiming[this.id]&&(p.resourceTiming=m.resourceTiming[this.id]),r&&(this._partialReload=!0),this.fire(new l.x("data",p)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(r),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(r,e){let a=r.actor?"reloadTile":"loadTile";r.actor=this.actor;let d=this.map.style?this.map.style.getLut(this.scope):null,m=this._partialReload,p={type:this.type,uid:r.uid,tileID:r.tileID,tileZoom:r.tileZoom,zoom:r.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:d?{image:d.image.clone()}:null,scope:this.scope,pixelRatio:l.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,partial:m};r.request=this.actor.send(a,p,(u,U)=>m&&!U?(r.state="loaded",e(null)):(delete r.request,r.destroy(),r.aborted?e(null):u?e(u):(r.loadVectorData(U,this.map.painter,a==="reloadTile"),e(null))),void 0,a==="loadTile")}abortTile(r){r.request&&(r.request.cancel(),delete r.request),r.aborted=!0}unloadTile(r,e){this.actor.send("removeTile",{uid:r.uid,type:this.type,source:this.id,scope:this.scope}),r.destroy()}onRemove(r){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return l.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends l.aD{constructor(r,e,a,d){super(r,e,a,d),this.roundZoom=!0,this.type="video",this.options=e}load(){this._loaded=!1;let r=this.options;this.urls=[];for(let e of r.urls)this.urls.push(this.map._requestManager.transformRequest(e,l.R.Source).url);l.aE(this.urls,(e,a)=>{this._loaded=!0,e?this.fire(new l.t(e)):a&&(this.video=a,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(r){if(this.video){let e=this.video.seekable;r<e.start(0)||r>e.end(0)?this.fire(new l.t(new l.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${e.start(0)} and ${e.end(0)}-second mark.`))):this.video.currentTime=r}}getVideo(){return this.video}onAdd(r){this.map||(this.map=r,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;let r=this.map.painter.context,e=r.gl;this.texture?this.video.paused||(this.texture.bind(e.LINEAR,e.CLAMP_TO_EDGE),e.texSubImage2D(e.TEXTURE_2D,0,0,0,e.RGBA,e.UNSIGNED_BYTE,this.video)):(this.texture=new l.T(r,this.video,e.RGBA8),this.texture.bind(e.LINEAR,e.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(r)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:l.aD,model:class extends l.E{constructor(r,e,a,d){super(),this.id=r,this.type="model",this.models=[],this._loaded=!1,this._options=e}load(){let r=[];for(let e in this._options.models){let a=this._options.models[e],d=l.aG(this.map._requestManager.transformRequest(a.uri,l.R.Model).url).then(m=>{if(!m)return;let p=l.aH(m),u=new l.aI(e,a.position,a.orientation,p);u.computeBoundsAndApplyParent(),this.models.push(u)}).catch(m=>{this.fire(new l.t(new Error(`Could not load model ${e} from ${a.uri}: ${m.message}`)))});r.push(d)}return Promise.allSettled(r).then(()=>{this._loaded=!0,this.fire(new l.x("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(e=>{this.fire(new l.t(new Error(`Could not load models: ${e.message}`)))})}onAdd(r){this.map=r,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(r,e){}serialize(){return{type:"model"}}},"batched-model":class extends l.E{constructor(r,e,a,d){super(),this.type="batched-model",this.id=r,this.tileSize=512,this._options=e,this.tiles=this._options.tiles,this.maxzoom=e.maxzoom||19,this.minzoom=e.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=a,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(d)}onAdd(r){this.map=r,this.load()}load(r){this._loaded=!1,this.fire(new l.x("dataloading",{dataType:"source"}));let e=Array.isArray(this.map._language)?this.map._language.join():this.map._language,a=this.map._worldview;this._tileJSONRequest=wn(this._options,this.map._requestManager,e,a,(d,m)=>{this._tileJSONRequest=null,this._loaded=!0,d?(e&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${e}`),a&&a.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${a}`),this.fire(new l.t(d))):m&&(l.l(this,m),m.bounds&&(this.tileBounds=new Yl(m.bounds,this.minzoom,this.maxzoom)),fn(m.tiles,this.map._requestManager._customAccessToken),this.fire(new l.x("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.x("data",{dataType:"source",sourceDataType:"content"}))),r&&r(d)})}hasTransition(){return!1}hasTile(r){return!this.tileBounds||this.tileBounds.contains(r.canonical)}loaded(){return this._loaded}loadTile(r,e){let a=this.map._requestManager.normalizeTileURL(r.tileID.canonical.url(this.tiles,this.scheme)),d={request:this.map._requestManager.transformRequest(a,l.R.Tile),data:void 0,uid:r.uid,tileID:r.tileID,tileZoom:r.tileZoom,zoom:r.tileID.overscaledZ,tileSize:this.tileSize*r.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:r.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(r.actor&&r.state!=="expired")if(r.state==="loading")r.reloadCallback=e;else{if(r.buckets){let p=Object.values(r.buckets);for(let u of p)u.dirty=!0;return void(r.state="loaded")}r.request=r.actor.send("reloadTile",d,m.bind(this))}else r.actor=this.dispatcher.getActor(),r.request=r.actor.send("loadTile",d,m.bind(this),void 0,!0);function m(p,u){return r.aborted?e(null):p&&p.status!==404?e(p):(u&&(u.resourceTiming&&(r.resourceTiming=u.resourceTiming),this.map._refreshExpiredTiles&&r.setExpiryData(u),r.buckets={...r.buckets,...u.buckets},u.featureIndex&&(r.latestFeatureIndex=u.featureIndex)),r.state="loaded",void e(null))}}serialize(){return l.l({},this._options)}},canvas:class extends l.aD{constructor(r,e,a,d){super(r,e,a,d),e.coordinates?Array.isArray(e.coordinates)&&e.coordinates.length===4&&!e.coordinates.some(m=>!Array.isArray(m)||m.length!==2||m.some(p=>typeof p!="number"))||this.fire(new l.t(new l.V(`sources.${r}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new l.t(new l.V(`sources.${r}`,null,'missing required property "coordinates"'))),e.animate&&typeof e.animate!="boolean"&&this.fire(new l.t(new l.V(`sources.${r}`,null,'optional "animate" property must be a boolean value'))),e.canvas?typeof e.canvas=="string"||e.canvas instanceof HTMLCanvasElement||this.fire(new l.t(new l.V(`sources.${r}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new l.t(new l.V(`sources.${r}`,null,'missing required property "canvas"'))),this.options=e,this.animate=e.animate===void 0||e.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new l.t(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(r){this.map=r,this.load(),this.canvas&&this.animate&&this.play()}onRemove(r){this.pause()}prepare(){let r=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,r=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,r=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;let e=this.map.painter.context;this.texture?!r&&!this._playing||this.texture instanceof l.aF||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new l.T(e,this.canvas,e.gl.RGBA8,{premultiply:!0}),this._prepareData(e)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let r of[this.canvas.width,this.canvas.height])if(isNaN(r)||r<=0)return!0;return!1}},custom:class extends l.E{constructor(r,e,a,d){super(),this.id=r,this.type="custom",this._dataType="raster",this._dispatcher=a,this._implementation=e,this.setEventedParent(d),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new l.t(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new l.t(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Yl(this._implementation.bounds,this.minzoom,this.maxzoom)),e.update=this._update.bind(this),e.clearTiles=this._clearTiles.bind(this),e.coveringTiles=this._coveringTiles.bind(this),l.l(this,l.ar(e,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return l.ar(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new l.x("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.x("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(r){this.map=r,this._loaded=!1,this.fire(new l.x("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(r),this.load()}onRemove(r){this._implementation.onRemove&&this._implementation.onRemove(r)}hasTile(r){if(this._implementation.hasTile){let{x:e,y:a,z:d}=r.canonical;return this._implementation.hasTile({x:e,y:a,z:d})}return!this.tileBounds||this.tileBounds.contains(r.canonical)}loadTile(r,e){let{x:a,y:d,z:m}=r.tileID.canonical,p=new AbortController;r.request=Promise.resolve(this._implementation.loadTile({x:a,y:d,z:m},{signal:p.signal})).then((function(u){return delete r.request,r.aborted?(r.state="unloaded",e(null)):u===void 0?(r.state="errored",e(null)):u===null?(this.loadTileData(r,{width:this.tileSize,height:this.tileSize,data:null}),r.state="loaded",e(null)):function(U){return U instanceof ImageData||U instanceof HTMLCanvasElement||U instanceof ImageBitmap||U instanceof HTMLImageElement}(u)?(this.loadTileData(r,u),r.state="loaded",void e(null)):(r.state="errored",e(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(u=>{u.code!==20&&(r.state="errored",e(u))}),r.request.cancel=()=>p.abort()}loadTileData(r,e){r.setTexture(e,this.map.painter)}unloadTile(r,e){if(r.texture&&r.texture instanceof l.T?(r.destroy(!0),r.texture&&r.texture instanceof l.T&&this.map.painter.saveTileTexture(r.texture)):r.destroy(),this._implementation.unloadTile){let{x:a,y:d,z:m}=r.tileID.canonical;this._implementation.unloadTile({x:a,y:d,z:m})}e&&e()}abortTile(r,e){r.request&&r.request.cancel&&(r.request.cancel(),delete r.request),e&&e()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(r=>({x:r.canonical.x,y:r.canonical.y,z:r.canonical.z}))}_clearTiles(){let r=l.av(this.id,this.scope);this.map.style.clearSource(r)}_update(){this.fire(new l.x("data",{dataType:"source",sourceDataType:"content"}))}}},vo=function(r,e,a,d){let m=new ed[e.type](r,e,a,d);if(m.id!==r)throw new Error(`Expected Source id to be ${r} instead of ${m.id}`);return l.aJ(["load","abort","unload","serialize","prepare"],m),m};function Cc(r,e){let a=l.a6.mat4.identity([]);return l.a6.mat4.scale(a,a,[.5*r.width,.5*-r.height,1]),l.a6.mat4.translate(a,a,[1,-1,0]),l.a6.mat4.multiply(a,a,r.calculateProjMatrix(e.toUnwrapped())),Float32Array.from(a)}function kc(r,e,a,d,m,p,u,U=!1){let Y=r.tilesIn(d,u,U);Y.sort(Eo);let y=[];for(let C of Y)y.push({wrappedTileID:C.tile.tileID.wrapped().key,queryResults:C.tile.queryRenderedFeatures(e,a,r._state,C,m,p,Cc(r.transform,C.tile.tileID),U)});let B=function(C){let k={},Q={};for(let z of C){let w=z.queryResults,A=z.wrappedTileID,H=Q[A]=Q[A]||{};for(let $ in w){let et=w[$],K=H[$]=H[$]||{},nt=k[$]=k[$]||[];for(let at of et)K[at.featureIndex]||(K[at.featureIndex]=!0,nt.push(at))}}return k}(y);for(let C in B)B[C].forEach(k=>{let Q=k.feature,z=Q.layer;z&&z.type!=="background"&&z.type!=="sky"&&z.type!=="slot"&&(Q.source=z.source,z["source-layer"]&&(Q.sourceLayer=z["source-layer"]),Q.state=Q.id!==void 0?r.getFeatureState(z["source-layer"],Q.id):{})});return B}function _s(r,e){let a=r.getRenderableIds().map(p=>r.getTileByID(p)),d=[],m={};for(let p=0;p<a.length;p++){let u=a[p],U=u.tileID.canonical.key;m[U]||(m[U]=!0,u.querySourceFeatures(d,e))}return d}function Eo(r,e){let a=r.tileID,d=e.tileID;return a.overscaledZ-d.overscaledZ||a.canonical.y-d.canonical.y||a.wrap-d.wrap||a.canonical.x-d.canonical.x}let yn=32,An=33,Hn=new Uint16Array(8184);for(let r=0;r<2046;r++){let e=r+2,a=0,d=0,m=0,p=0,u=0,U=0;for(1&e?m=p=u=yn:a=d=U=yn;(e>>=1)>1;){let y=a+m>>1,B=d+p>>1;1&e?(m=a,p=d,a=u,d=U):(a=m,d=p,m=u,p=U),u=y,U=B}let Y=4*r;Hn[Y+0]=a,Hn[Y+1]=d,Hn[Y+2]=m,Hn[Y+3]=p}let en=new Uint16Array(2178),ll=new Uint8Array(1089),Ps=new Uint16Array(1089);function Sc(r){return r===0?-.03125:r===32?.03125:0}let Qc={type:2,extent:l.ab,loadGeometry:()=>[[new l.P(0,0),new l.P(l.ab+1,0),new l.P(l.ab+1,l.ab+1),new l.P(0,l.ab+1),new l.P(0,0)]]};class ol{constructor(e,a,d,m,p){this.tileID=e,this.uid=l.aP(),this.uses=0,this.tileSize=a,this.tileZoom=d,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=p,m&&m.style&&(this._lastUpdatedBrightness=m.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",m&&m.transform&&(this.projection=m.transform.projection)}registerFadeDuration(e){let a=e+this.timeAdded;a<l.q.now()||this.fadeEndTime&&a<this.fadeEndTime||(this.fadeEndTime=a)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=l.aK(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(e,a,d){if(this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=function(m,p){let u={};if(!p)return u;for(let U of m){let Y=U.layerIds.map(y=>p.getLayer(y)).filter(Boolean);if(Y.length!==0){U.layers=Y,U.stateDependentLayerIds&&(U.stateDependentLayers=U.stateDependentLayerIds.map(y=>Y.filter(B=>B.id===y)[0]));for(let y of Y)u[y.fqid]=U}}return u}(e.buckets,a.style),this.hasSymbolBuckets=!1;for(let m in this.buckets){let p=this.buckets[m];if(p instanceof l.aR){if(this.hasSymbolBuckets=!0,!d)break;p.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let m in this.buckets){let p=this.buckets[m];if(p instanceof l.aR&&p.hasRTLText){this.hasRTLText=!0,l.aS();break}}this.queryPadding=0;for(let m in this.buckets){let p=this.buckets[m],u=a.style.getOwnLayer(m);if(!u)continue;let U=u.queryRadius(p);this.queryPadding=Math.max(this.queryPadding,U)}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage),e.lineAtlas&&(this.lineAtlas=e.lineAtlas),this._lastUpdatedBrightness=e.brightness}else this.collisionBoxArray=new l.aQ}unloadVectorData(){if(this.hasData()){for(let e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(e){return this.buckets[e.fqid]}upload(e){for(let m in this.buckets){let p=this.buckets[m];p.uploadPending()&&p.upload(e)}let a=e.gl,d=this.imageAtlas;if(d&&!d.uploaded){let m=!!Object.keys(d.patternPositions).length;this.imageAtlasTexture=new l.T(e,d.image,a.RGBA8,{useMipmap:m}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new l.T(e,this.glyphAtlasImage,a.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new l.T(e,this.lineAtlas.image,a.R8),this.lineAtlas.uploaded=!0)}prepare(e,a,d){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture,d),!a||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let m=a.style.getBrightness();(this._lastUpdatedBrightness||m)&&(this._lastUpdatedBrightness&&m&&Math.abs(this._lastUpdatedBrightness-m)<.001||(this._lastUpdatedBrightness=m,this.updateBuckets(a)))}queryRenderedFeatures(e,a,d,m,p,u,U,Y){return this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)?this.latestFeatureIndex.query({tileResult:m,pixelPosMatrix:U,transform:u,params:p,tileTransform:this.tileTransform},e,a,d):{}}querySourceFeatures(e,a){let d=this.latestFeatureIndex;if(!d||!d.rawTileData)return;let m=d.loadVTLayers(),p=a?a.sourceLayer:"",u=m._geojsonTileLayer||m[p];if(!u)return;let U=l.aT(a&&a.filter),{z:Y,x:y,y:B}=this.tileID.canonical,C={z:Y,x:y,y:B};for(let k=0;k<u.length;k++){let Q=u.feature(k);if(U.needGeometry){let A=l.aU(Q,!0);if(!U.filter(new l.a3(this.tileID.overscaledZ),A,this.tileID.canonical))continue}else if(!U.filter(new l.a3(this.tileID.overscaledZ),Q))continue;let z=d.getId(Q,p),w=new l.aV(Q,Y,y,B,z);w.tile=C,e.push(w)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(e){let a=this.expirationTime;if(e.cacheControl){let d=l.aW(e.cacheControl);d["max-age"]&&(this.expirationTime=Date.now()+1e3*d["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){let d=Date.now(),m=!1;if(this.expirationTime>d)m=!1;else if(a)if(this.expirationTime<a)m=!0;else{let p=this.expirationTime-a;p?this.expirationTime=d+Math.max(p,3e4):m=!0}else m=!0;m?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(e,a){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&Object.keys(e).length!==0&&a&&this.updateBuckets(a)}updateBuckets(e){if(!this.latestFeatureIndex)return;let a=this.latestFeatureIndex.loadVTLayers(),d=e.style.listImages(),m=e.style.getBrightness();for(let p in this.buckets){if(!e.style.hasLayer(p))continue;let u=this.buckets[p],U=u.layers[0].sourceLayer||"_geojsonTileLayer",Y=a[U],y=e.style.getOwnSourceCache(u.layers[0].source),B={};y&&(B=y._state.getState(U,void 0)),u.update(B,Y,d,this.imageAtlas&&this.imageAtlas.patternPositions||{},m),(u instanceof l.aX||u instanceof l.aY)&&e._terrain&&e._terrain.enabled&&y&&u.programConfigurations.needsUpload&&e._terrain._clearRenderCacheForTile(y.id,this.tileID);let C=e&&e.style&&e.style.getOwnLayer(p);C&&(this.queryPadding=Math.max(this.queryPadding,C.queryRadius(u)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<l.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=l.q.now()+e}setTexture(e,a){let d=a.context,m=d.gl;this.texture=this.texture||a.getTileTexture(e.width),this.texture&&this.texture instanceof l.T?this.texture.update(e):(this.texture=new l.T(d,e,m.RGBA8,{useMipmap:!0}),this.texture.bind(m.LINEAR,m.CLAMP_TO_EDGE))}setDependencies(e,a){let d={};for(let m of a)d[m]=!0;this.dependencies[e]=d}hasDependency(e,a){for(let d of e){let m=this.dependencies[d];if(m){for(let p of a)if(m[p])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(e,a){if(!a||a.name==="mercator"||this._tileDebugBuffer)return;let d=l.aZ(Qc,this.tileID.canonical,this.tileTransform)[0],m=new l.a_,p=new l.a$;for(let u=0;u<d.length;u++){let{x:U,y:Y}=d[u];m.emplaceBack(U,Y),p.emplaceBack(u)}p.emplaceBack(0),this._tileDebugIndexBuffer=e.createIndexBuffer(p),this._tileDebugBuffer=e.createVertexBuffer(m,l.b0.members),this._tileDebugSegments=l.b1.simpleSegment(0,0,m.length,p.length)}_makeTileBoundsBuffers(e,a){if(this._tileBoundsBuffer||!a||a.name==="mercator")return;let d=l.aZ(Qc,this.tileID.canonical,this.tileTransform)[0],m,p;if(this.isRaster){let u=function(U,Y){let y=l.aK(U,Y),B=Math.pow(2,U.z);for(let A=0;A<An;A++)for(let H=0;H<An;H++){let $=l.aL((U.x+(H+Sc(H))/yn)/B),et=l.aM((U.y+(A+Sc(A))/yn)/B),K=Y.project($,et),nt=A*An+H;en[2*nt+0]=Math.round((K.x*y.scale-y.x)*l.ab),en[2*nt+1]=Math.round((K.y*y.scale-y.y)*l.ab)}ll.fill(0),Ps.fill(0);for(let A=2045;A>=0;A--){let H=4*A,$=Hn[H+0],et=Hn[H+1],K=Hn[H+2],nt=Hn[H+3],at=$+K>>1,ct=et+nt>>1,rt=at+ct-et,bt=ct+$-at,gt=et*An+$,Wt=nt*An+K,ht=ct*An+at,Nt=Math.hypot((en[2*gt+0]+en[2*Wt+0])/2-en[2*ht+0],(en[2*gt+1]+en[2*Wt+1])/2-en[2*ht+1])>=16;ll[ht]=ll[ht]||(Nt?1:0),A<1022&&(ll[ht]=ll[ht]||ll[(et+bt>>1)*An+($+rt>>1)]||ll[(nt+bt>>1)*An+(K+rt>>1)])}let C=new l.aN,k=new l.aO,Q=0;function z(A,H){let $=H*An+A;return Ps[$]===0&&(C.emplaceBack(en[2*$+0],en[2*$+1],A*l.ab/yn,H*l.ab/yn),Ps[$]=++Q),Ps[$]-1}function w(A,H,$,et,K,nt){let at=A+$>>1,ct=H+et>>1;if(Math.abs(A-K)+Math.abs(H-nt)>1&&ll[ct*An+at])w(K,nt,A,H,at,ct),w($,et,K,nt,at,ct);else{let rt=z(A,H),bt=z($,et),gt=z(K,nt);k.emplaceBack(rt,bt,gt)}}return w(0,0,yn,yn,yn,0),w(yn,yn,0,0,0,yn),{vertices:C,indices:k}}(this.tileID.canonical,a);m=u.vertices,p=u.indices}else{m=new l.aN,p=new l.aO;for(let{x:U,y:Y}of d)m.emplaceBack(U,Y,0,0);let u=l.b2(m.int16,void 0,4);for(let U=0;U<u.length;U+=3)p.emplaceBack(u[U],u[U+1],u[U+2])}this._tileBoundsBuffer=e.createVertexBuffer(m,l.b3.members),this._tileBoundsIndexBuffer=e.createIndexBuffer(p),this._tileBoundsSegments=l.b1.simpleSegment(0,0,m.length,p.length)}_makeGlobeTileDebugBuffers(e,a){let d=a.projection;if(!d||d.name!=="globe"||a.freezeTileCoverage)return;let m=this.tileID.canonical,p=l.b4(m,a),u=l.b5(p),U=l.a9(a.zoom),Y;U>0&&(Y=l.a6.mat4.invert(new Float64Array(16),a.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(e,m,a,u,Y,U),this._makeGlobeTileDebugTextBuffer(e,m,a,u,Y,U)}_globePoint(e,a,d,m,p,u,U){let Y=l.b6(e,a,d);if(u){let y=1<<d.z,B=l.am(m.center.lng),C=l.at(m.center.lat),k=(d.x+.5)/y-B,Q=0;k>.5?Q=-1:k<-.5&&(Q=1);let z=(e/l.ab+d.x)/y+Q,w=(a/l.ab+d.y)/y;z=(z-B)*m._pixelsPerMercatorPixel+B,w=(w-C)*m._pixelsPerMercatorPixel+C;let A=[z*m.worldSize,w*m.worldSize,0];l.a6.vec3.transformMat4(A,A,u),Y=l.b7(Y,A,U)}return l.a6.vec3.transformMat4(Y,Y,p)}_makeGlobeTileDebugBorderBuffer(e,a,d,m,p,u){let U=new l.a_,Y=new l.a$,y=new l.b8,B=(k,Q,z,w,A)=>{let H=(z-k)/(A-1),$=(w-Q)/(A-1),et=U.length;for(let K=0;K<A;K++){let nt=k+K*H,at=Q+K*$;U.emplaceBack(nt,at);let ct=this._globePoint(nt,at,a,d,m,p,u);y.emplaceBack(ct[0],ct[1],ct[2]),Y.emplaceBack(et+K)}},C=l.ab;B(0,0,C,0,16),B(C,0,C,C,16),B(C,C,0,C,16),B(0,C,0,0,16),this._tileDebugIndexBuffer=e.createIndexBuffer(Y),this._tileDebugBuffer=e.createVertexBuffer(U,l.b0.members),this._globeTileDebugBorderBuffer=e.createVertexBuffer(y,l.b9.members),this._tileDebugSegments=l.b1.simpleSegment(0,0,U.length,Y.length)}_makeGlobeTileDebugTextBuffer(e,a,d,m,p,u){let U=l.ab/4,Y=new l.a_,y=new l.aO,B=new l.b8,C=25;y.reserve(32),Y.reserve(C),B.reserve(C);let k=(Q,z)=>C*Q+z;for(let Q=0;Q<C;Q++){let z=Q*U;for(let w=0;w<C;w++){let A=w*U;Y.emplaceBack(A,z);let H=this._globePoint(A,z,a,d,m,p,u);B.emplaceBack(H[0],H[1],H[2])}}for(let Q=0;Q<4;Q++)for(let z=0;z<4;z++){let w=k(Q,z),A=k(Q,z+1),H=k(Q+1,z),$=k(Q+1,z+1);y.emplaceBack(w,A,H),y.emplaceBack(H,A,$)}this._tileDebugTextIndexBuffer=e.createIndexBuffer(y),this._tileDebugTextBuffer=e.createVertexBuffer(Y,l.b0.members),this._globeTileDebugTextBuffer=e.createVertexBuffer(B,l.b9.members),this._tileDebugTextSegments=l.b1.simpleSegment(0,0,C,32)}destroy(e=!1){for(let a in this.buckets)this.buckets[a].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!e&&this.texture&&this.texture instanceof l.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}l.ba.setPbf(l.bb);class id extends ol{constructor(e,a,d,m,p){super(e,a,d,m,p),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(e,a){let d=a.context,m=d.gl;this.texture=this.texture||a.getTileTexture(e.width),this.texture&&this.texture instanceof l.T?this.texture.update(e,{premultiply:!1}):this.texture=new l.T(d,e,m.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(e=16384,a){let d=this._mrt=new l.ba(30),m=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(e-1)}});return this.entireBuffer=null,this.request=l.bc(m,(p,u,U,Y)=>{if(p)a(p);else try{let y=d.getHeaderLength(u);if(y>e)return void(this.request=this.fetchHeader(y,a));d.parseHeader(u),this._isHeaderLoaded=!0;let B=0;for(let C of Object.values(d.layers))B=Math.max(B,C.dataIndex[C.dataIndex.length-1].last_byte);u.byteLength>=B&&(this.entireBuffer=u),a(null,this.entireBuffer||u,U,Y)}catch(y){a(y)}}),this.request}fetchBand(e,a,d){let m=this._mrt;if(!this._isHeaderLoaded||!m)return void d(new Error("Tile header is not ready"));let p=this.actor;if(!p)return void d(new Error("Can't fetch tile band without an actor"));let u,U=(C,k)=>{u.complete(C,k),C?d(C):(this.updateTextureDescriptor(e,a),d(null,this.textureDescriptor&&this.textureDescriptor.img))},Y=(C,k)=>{if(C)return d(C);let Q=p.send("decodeRasterArray",{buffer:k,task:u},U,void 0,!0);this._workQueue.push(()=>{Q&&Q.cancel(),u.cancel()})},y=m.getLayer(e);if(!y)return void d(new Error(`Unknown sourceLayer "${e}"`));if(y.hasDataForBand(a))return this.updateTextureDescriptor(e,a),void d(null,this.textureDescriptor?this.textureDescriptor.img:null);let B=y.getDataRange([a]);if(u=m.createDecodingTask(B),!u||u.tasks.length)if(this.flushQueues(),this.entireBuffer)Y(null,this.entireBuffer.slice(B.firstByte,B.lastByte+1));else{let C=Object.assign({},this.requestParams,{headers:{Range:`bytes=${B.firstByte}-${B.lastByte}`}}),k=l.bc(C,Y);this._fetchQueue.push(()=>{k.cancel(),u.cancel()})}else d(null)}updateNeeded(e,a){return(!this.textureDescriptor||this.textureDescriptor.band!==a||this.textureDescriptor.layer!==e)&&this.state!=="errored"}updateTextureDescriptor(e,a){if(!this._mrt)return;let d=this._mrt.getLayer(e);if(!d||!d.hasBand(a)||!d.hasDataForBand(a))return;let{bytes:m,tileSize:p,buffer:u,offset:U,scale:Y}=d.getBandView(a),y=p+2*u,B={data:m,width:y,height:y},C=this.texture;C&&C instanceof l.T&&C.update(B,{premultiply:!1}),this.textureDescriptor={layer:e,band:a,img:B,buffer:u,offset:U,tileSize:p,format:d.pixelFormat,mix:[Y,256*Y,65536*Y,16777216*Y]}}}class Em{constructor(e,a){this.max=e,this.onRemove=a,this.reset()}reset(){for(let e in this.data)for(let a of this.data[e])a.timeout&&clearTimeout(a.timeout),this.onRemove(a.value);return this.data={},this.order=[],this}add(e,a,d){let m=e.wrapped().key;this.data[m]===void 0&&(this.data[m]=[]);let p={value:a,timeout:void 0};if(d!==void 0&&(p.timeout=setTimeout(()=>{this.remove(e,p)},d)),this.data[m].push(p),this.order.push(m),this.order.length>this.max){let u=this._getAndRemoveByKey(this.order[0]);u&&this.onRemove(u)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){let a=this.data[e].shift();return a.timeout&&clearTimeout(a.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),a.value}getByKey(e){let a=this.data[e];return a?a[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,a){if(!this.has(e))return this;let d=e.wrapped().key,m=a===void 0?0:this.data[d].indexOf(a),p=this.data[d][m];return this.data[d].splice(m,1),p.timeout&&clearTimeout(p.timeout),this.data[d].length===0&&delete this.data[d],this.onRemove(p.value),this.order.splice(this.order.indexOf(d),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){let a=this._getAndRemoveByKey(this.order[0]);a&&this.onRemove(a)}return this}filter(e){let a=[];for(let d in this.data)for(let m of this.data[d])e(m.value)||a.push(m);for(let d of a)this.remove(d.value.tileID,d)}}class Wp{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,a,d){let m=String(a);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][m]=this.stateChanges[e][m]||{},l.l(this.stateChanges[e][m],d),this.deletedStates[e]===null){this.deletedStates[e]={};for(let p in this.state[e])p!==m&&(this.deletedStates[e][p]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][m]===null){this.deletedStates[e][m]={};for(let p in this.state[e][m])d[p]||(this.deletedStates[e][m][p]=null)}else for(let p in d)this.deletedStates[e]&&this.deletedStates[e][m]&&this.deletedStates[e][m][p]===null&&delete this.deletedStates[e][m][p]}removeFeatureState(e,a,d){if(this.deletedStates[e]===null)return;let m=String(a);if(this.deletedStates[e]=this.deletedStates[e]||{},d&&a!==void 0)this.deletedStates[e][m]!==null&&(this.deletedStates[e][m]=this.deletedStates[e][m]||{},this.deletedStates[e][m][d]=null);else if(a!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][m])for(d in this.deletedStates[e][m]={},this.stateChanges[e][m])this.deletedStates[e][m][d]=null;else this.deletedStates[e][m]=null;else this.deletedStates[e]=null}getState(e,a){let d=this.state[e]||{},m=this.stateChanges[e]||{},p=this.deletedStates[e];if(p===null)return{};if(a!==void 0){let U=String(a),Y=l.l({},d[U],m[U]);if(p){let y=p[a];if(y===null)return{};for(let B in y)delete Y[B]}return Y}let u=l.l({},d,m);if(p)for(let U in p)delete u[U];return u}initializeTileState(e,a){e.setFeatureState(this.state,a)}coalesceChanges(e,a){let d={};for(let m in this.stateChanges){this.state[m]=this.state[m]||{};let p={};for(let u in this.stateChanges[m])this.state[m][u]||(this.state[m][u]={}),l.l(this.state[m][u],this.stateChanges[m][u]),p[u]=this.state[m][u];d[m]=p}for(let m in this.deletedStates){this.state[m]=this.state[m]||{};let p={};if(this.deletedStates[m]===null)for(let u in this.state[m])p[u]={},this.state[m][u]={};else for(let u in this.deletedStates[m]){if(this.deletedStates[m][u]===null)this.state[m][u]={};else if(this.state[m][u])for(let U of Object.keys(this.deletedStates[m][u]))delete this.state[m][u][U];p[u]=this.state[m][u]}d[m]=d[m]||{},l.l(d[m],p)}if(this.stateChanges={},this.deletedStates={},Object.keys(d).length!==0)for(let m in e)e[m].setFeatureState(d,a)}}class an extends l.E{constructor(e,a,d){super(),this.id=e,this._onlySymbols=d,a.on("data",m=>{m.dataType==="source"&&m.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&m.dataType==="source"&&m.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),a.on("error",()=>{this._sourceErrored=!0}),this._source=a,this._tiles={},this._cache=new Em(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=a.minTileCacheSize,this._maxTileCacheSize=a.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Wp,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(e){this.map=e,this._minTileCacheSize=this._minTileCacheSize===void 0&&e?e._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&e?e._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let e in this._tiles){let a=this._tiles[e];if(a.state!=="loaded"&&a.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(e,a){return e.isSymbolTile=this._onlySymbols,e.isExtraShadowCaster=this._shadowCasterTiles[e.tileID.key],this._source.loadTile(e,a)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e)}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e)}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(let a in this._tiles){let d=this._tiles[a];d.upload(e),d.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return l.bd(this._tiles).map(e=>e.tileID).sort(Hl).map(e=>e.key)}getRenderableIds(e,a){let d=[];for(let m in this._tiles)this._isIdRenderable(+m,e,a)&&d.push(this._tiles[m]);return e?d.sort((m,p)=>{let u=m.tileID,U=p.tileID,Y=new l.P(u.canonical.x,u.canonical.y)._rotate(this.transform.angle),y=new l.P(U.canonical.x,U.canonical.y)._rotate(this.transform.angle);return u.overscaledZ-U.overscaledZ||y.y-Y.y||y.x-Y.x}).map(m=>m.tileID.key):d.map(m=>m.tileID).sort(Hl).map(m=>m.key)}hasRenderableParent(e){let a=this.findLoadedParent(e,0);return!!a&&this._isIdRenderable(a.tileID.key)}_isIdRenderable(e,a,d){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(a||!this._tiles[e].holdingForFade())&&(d||!this._shadowCasterTiles[e])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(let e in this._tiles)this._tiles[e].state!=="errored"&&this._reloadTile(+e,"reloading")}}_reloadTile(e,a){let d=this._tiles[e];d&&(d.state!=="loading"&&(d.state=a),this._loadTile(d,this._tileLoaded.bind(this,d,e,a)))}_tileLoaded(e,a,d,m){if(m)if(e.state="errored",m.status!==404)this._source.fire(new l.t(m,{tile:e}));else{if(this._source.fire(new l.x("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:e})),!(e.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){let p=this.map.painter.terrain;this.update(this.transform,p.getScaledDemTileSize(),!0),p.resetTileLookupCache(this.id)}else this.update(this.transform)}else e.timeAdded=l.q.now(),d==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(a,e),this._source.type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null),this._source.fire(new l.x("data",{dataType:"source",tile:e,coord:e.tileID,sourceCacheId:this.id}))}_backfillDEM(e){let a=this.getRenderableIds();for(let m=0;m<a.length;m++){let p=a[m];if(e.neighboringTiles&&e.neighboringTiles[p]){let u=this.getTileByID(p);d(e,u),d(u,e)}}function d(m,p){if(!m.dem||m.dem.borderReady)return;m.needsHillshadePrepare=!0,m.needsDEMTextureUpload=!0;let u=p.tileID.canonical.x-m.tileID.canonical.x,U=p.tileID.canonical.y-m.tileID.canonical.y,Y=Math.pow(2,m.tileID.canonical.z),y=p.tileID.key;u===0&&U===0||Math.abs(U)>1||(Math.abs(u)>1&&(Math.abs(u+Y)===1?u+=Y:Math.abs(u-Y)===1&&(u-=Y)),p.dem&&m.dem&&(m.dem.backfillBorder(p.dem,u,U),m.neighboringTiles&&m.neighboringTiles[y]&&(m.neighboringTiles[y].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,a,d,m){for(let p in this._tiles){let u=this._tiles[p];if(m[p]||!u.hasData()||u.tileID.overscaledZ<=a||u.tileID.overscaledZ>d)continue;let U=u.tileID;for(;u&&u.tileID.overscaledZ>a+1;){let y=u.tileID.scaledTo(u.tileID.overscaledZ-1);u=this._tiles[y.key],u&&u.hasData()&&(U=y)}let Y=U;for(;Y.overscaledZ>a;)if(Y=Y.scaledTo(Y.overscaledZ-1),e[Y.key]){m[U.key]=U;break}}}findLoadedParent(e,a){if(e.key in this._loadedParentTiles){let d=this._loadedParentTiles[e.key];return d&&d.tileID.overscaledZ>=a?d:null}for(let d=e.overscaledZ-1;d>=a;d--){let m=e.scaledTo(d),p=this._getLoadedTile(m);if(p)return p}}_getLoadedTile(e){let a=this._tiles[e.key];return a&&a.hasData()?a:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key)}updateCacheSize(e,a){a=a||this._source.tileSize;let d=Math.ceil(e.width/a)+1,m=Math.ceil(e.height/a)+1,p=Math.floor(d*m*5),u=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,p):p,U=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,u):u;this._cache.setMaxSize(U)}handleWrapJump(e){let a=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,a){let d={};for(let m in this._tiles){let p=this._tiles[m];p.tileID=p.tileID.unwrapTo(p.tileID.wrap+a),d[p.tileID.key]=p}this._tiles=d;for(let m in this._timers)clearTimeout(this._timers[m]),delete this._timers[m];for(let m in this._tiles)this._setTileReloadTimer(+m,this._tiles[m])}}update(e,a,d,m){if(this.transform=e,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!d)return;this.updateCacheSize(e,a),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};let p=this._source.type==="batched-model",u;if(this.used||this.usedForTerrain){if(this._source.tileID)u=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(y=>new l.aA(y.canonical.z,y.wrap,y.canonical.z,y.canonical.x,y.canonical.y));else if(this.tileCoverLift!==0){let y=e.clone();y.tileCoverLift=this.tileCoverLift,u=y.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!d,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:p}),this._source.minzoom<=1&&e.projection.name==="globe"&&(u.push(new l.aA(1,0,1,0,0)),u.push(new l.aA(1,0,1,1,0)),u.push(new l.aA(1,0,1,0,1)),u.push(new l.aA(1,0,1,1,1)))}else if(u=e.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!d,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:p}),this._source.hasTile){let y=this._source.hasTile.bind(this._source);u=u.filter(B=>y(B))}}else u=[];if(u.length>0&&this.castsShadows&&m&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Ks(this._source.type)){let y=e.coveringZoomLevel({tileSize:a||this._source.tileSize,roundZoom:this._source.roundZoom&&!d}),B=Math.min(y,this._source.maxzoom);if(p){let C=e.extendTileCover(u,B);for(let k of C)u.push(k)}else{let C=e.extendTileCover(u,B,m);for(let k of C)this._shadowCasterTiles[k.key]=!0,u.push(k)}}let U=this._updateRetainedTiles(u);if(Ks(this._source.type)&&u.length!==0){let y={},B={},C=Object.keys(U);for(let Q of C){let z=U[Q],w=this._tiles[Q];if(!w||w.fadeEndTime&&w.fadeEndTime<=l.q.now())continue;let A=this.findLoadedParent(z,Math.max(z.overscaledZ-an.maxOverzooming,this._source.minzoom));A&&(this._addTile(A.tileID),y[A.tileID.key]=A.tileID),B[Q]=z}let k=u[u.length-1].overscaledZ;for(let Q in this._tiles){let z=this._tiles[Q];if(U[Q]||!z.hasData())continue;let w=z.tileID;for(;w.overscaledZ>k;){w=w.scaledTo(w.overscaledZ-1);let A=this._tiles[w.key];if(A&&A.hasData()&&B[w.key]){U[Q]=z.tileID;break}}}for(let Q in y)U[Q]||(this._coveredTiles[Q]=!0,U[Q]=y[Q])}for(let y in U)this._tiles[y].clearFadeHold();let Y=l.be(this._tiles,U);for(let y of Y){let B=this._tiles[y];B.hasSymbolBuckets&&!B.holdingForFade()?B.setHoldDuration(this.map._fadeDuration):B.hasSymbolBuckets&&!B.symbolFadeFinished()||this._removeTile(+y)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e)}_updateRetainedTiles(e){let a={};if(e.length===0)return a;let d={},m=e.reduce((y,B)=>Math.min(y,B.overscaledZ),1/0),p=e[0].overscaledZ,u=Math.max(p-an.maxOverzooming,this._source.minzoom),U=Math.max(p+an.maxUnderzooming,this._source.minzoom),Y={};for(let y of e){let B=this._addTile(y);a[y.key]=y,B.hasData()||m<this._source.maxzoom&&(Y[y.key]=y)}this._retainLoadedChildren(Y,m,U,a);for(let y of e){let B=this._tiles[y.key];if(B.hasData())continue;if(y.canonical.z>=this._source.maxzoom){let k=y.children(this._source.maxzoom)[0],Q=this.getTile(k);if(Q&&Q.hasData()){a[k.key]=k;continue}}else{let k=y.children(this._source.maxzoom);if(a[k[0].key]&&a[k[1].key]&&a[k[2].key]&&a[k[3].key])continue}let C=B.wasRequested();for(let k=y.overscaledZ-1;k>=u;--k){let Q=y.scaledTo(k);if(d[Q.key]||(d[Q.key]=!0,B=this.getTile(Q),!B&&C&&(B=this._addTile(Q)),B&&(a[Q.key]=Q,C=B.wasRequested(),B.hasData())))break}}return a}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(let e in this._tiles){let a=[],d,m=this._tiles[e].tileID;for(;m.overscaledZ>0;){if(m.key in this._loadedParentTiles){d=this._loadedParentTiles[m.key];break}a.push(m.key);let p=m.scaledTo(m.overscaledZ-1);if(d=this._getLoadedTile(p),d)break;m=p}for(let p of a)this._loadedParentTiles[p]=d}}_addTile(e){let a=this._tiles[e.key];if(a)return a.isExtraShadowCaster!==!0||this._shadowCasterTiles[e.key]||this._reloadTile(e.key,"reloading"),a;a=this._cache.getAndRemove(e),a&&(this._setTileReloadTimer(e.key,a),a.tileID=e,this._state.initializeTileState(a,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,a)));let d=!!a;if(!d){let m=this.map?this.map.painter:null,p=this._source.tileSize*e.overscaleFactor();a=this._source.type==="raster-array"?new id(e,p,this.transform.tileZoom,m,this._isRaster):new ol(e,p,this.transform.tileZoom,m,this._isRaster),this._loadTile(a,this._tileLoaded.bind(this,a,e.key,a.state))}return a?(a.uses++,this._tiles[e.key]=a,d||this._source.fire(new l.x("dataloading",{tile:a,coord:a.tileID,dataType:"source"})),a):null}_setTileReloadTimer(e,a){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);let d=a.getExpiryTimeout();d&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},d))}_removeTile(e){let a=this._tiles[e];a&&(a.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),a.uses>0||(a.hasData()&&a.state!=="reloading"||a.state==="empty"?this._cache.add(a.tileID,a,a.getExpiryTimeout()):(a.aborted=!0,this._abortTile(a),this._unloadTile(a))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(let e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(e,a,d){let m=[],p=this.transform;if(!p)return m;let u=p.projection.name==="globe",U=l.am(p.center.lng);for(let Y in this._tiles){let y=this._tiles[Y];if(d&&y.clearQueryDebugViz(),y.holdingForFade())continue;let B;if(u){let C=y.tileID.canonical;if(C.z===0){let k=[Math.abs(l.ap(U,...Lo(C,-1))-U),Math.abs(l.ap(U,...Lo(C,1))-U)];B=[0,2*k.indexOf(Math.min(...k))-1]}else{let k=[Math.abs(l.ap(U,...Lo(C,-1))-U),Math.abs(l.ap(U,...Lo(C,0))-U),Math.abs(l.ap(U,...Lo(C,1))-U)];B=[k.indexOf(Math.min(...k))-1]}}else B=[0];for(let C of B){let k=e.containsTile(y,p,a,C);k&&m.push(k)}}return m}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(e){return this._getRenderableCoordinates(e)}_getRenderableCoordinates(e,a){let d=this.getRenderableIds(e,a).map(p=>this._tiles[p].tileID),m=this.transform.projection.name==="globe";for(let p of d)p.projMatrix=this.transform.calculateProjMatrix(p.toUnwrapped()),p.expandedProjMatrix=m?this.transform.calculateProjMatrix(p.toUnwrapped(),!1,!0):p.projMatrix;return d}sortCoordinatesByDistance(e){let a=e.slice(),d=this.transform._camera.position,m=this.transform._camera.forward(),p={};for(let u of a){let U=1/(1<<u.canonical.z);p[u.key]=((u.canonical.x+.5)*U+u.wrap-d[0])*m[0]+((u.canonical.y+.5)*U-d[1])*m[1]-d[2]*m[2]}return a.sort((u,U)=>p[u.key]-p[U.key]),a}hasTransition(){if(this._source.hasTransition())return!0;if(Ks(this._source.type))for(let e in this._tiles){let a=this._tiles[e];if(a.fadeEndTime!==void 0&&a.fadeEndTime>=l.q.now())return!0}return!1}setFeatureState(e,a,d){this._state.updateState(e=e||"_geojsonTileLayer",a,d)}removeFeatureState(e,a,d){this._state.removeFeatureState(e=e||"_geojsonTileLayer",a,d)}getFeatureState(e,a){return this._state.getState(e=e||"_geojsonTileLayer",a)}setDependencies(e,a,d){let m=this._tiles[e];m&&m.setDependencies(a,d)}reloadTilesForDependencies(e,a){for(let d in this._tiles)this._tiles[d].hasDependency(e,a)&&this._reloadTile(+d,"reloading");this._cache.filter(d=>!d.hasDependency(e,a))}_preloadTiles(e,a){if(!this._sourceLoaded){let Y=()=>{this._sourceLoaded&&(this._source.off("data",Y),this._preloadTiles(e,a))};return void this._source.on("data",Y)}let d=new Map,m=Array.isArray(e)?e:[e],p=this.map.painter.terrain,u=this.usedForTerrain&&p?p.getScaledDemTileSize():this._source.tileSize;for(let Y of m){let y=Y.coveringTiles({tileSize:u,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let B of y)d.set(B.key,B);this.usedForTerrain&&Y.updateElevation(!1)}let U=Array.from(d.values());l.bf(U,(Y,y)=>{let B=new ol(Y,this._source.tileSize*Y.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(B,C=>{this._source.type==="raster-dem"&&B.dem&&this._backfillDEM(B),y(C,B)})},a)}}function Hl(r,e){let a=Math.abs(2*r.wrap)-+(r.wrap<0),d=Math.abs(2*e.wrap)-+(e.wrap<0);return r.overscaledZ-e.overscaledZ||d-a||e.canonical.y-r.canonical.y||e.canonical.x-r.canonical.x}function Ks(r){return r==="raster"||r==="image"||r==="video"||r==="custom"}function Lo(r,e){let a=1<<r.z;return[r.x/a+e,(r.x+1)/a+e]}an.maxOverzooming=10,an.maxUnderzooming=3;class fc{constructor(e){this.style=e,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];let e=!1,a=!1;for(let d in this.style._mergedLayers){let m=this.style._mergedLayers[d];if(m.type==="fill-extrusion")this.layers.push({layer:m,visible:e,visibilityChanged:a});else if(m.type==="model"){let p=this.style.getLayerSource(m);p&&p.type==="batched-model"&&this.layers.push({layer:m,visible:e,visibilityChanged:a})}}}onNewFrame(e){this.layersGotHidden=!1;for(let a of this.layers){let d=a.layer,m=!1;d.type==="fill-extrusion"?m=!d.isHidden(e)&&d.paint.get("fill-extrusion-opacity")>0:d.type==="model"&&(m=!d.isHidden(e)&&d.paint.get("model-opacity")>0),this.layersGotHidden=this.layersGotHidden||!m&&a.visible,a.visible=m}}updateZOffset(e,a){this.currentBuildingBuckets=[];for(let m of this.layers){let p=m.layer,u=this.style.getLayerSourceCache(p),U=1;p.type==="fill-extrusion"&&(U=m.visible?p.paint.get("fill-extrusion-vertical-scale"):0);let Y=u?u.getTile(a):null;if(!Y&&u&&a.canonical.z>u.getSource().minzoom){let y=a.scaledTo(Math.min(u.getSource().maxzoom,a.overscaledZ-1));for(;y.overscaledZ>=u.getSource().minzoom&&(Y=u.getTile(y),!Y&&y.overscaledZ!==0);)y=y.scaledTo(y.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:Y?Y.getBucket(p):null,tileID:Y?Y.tileID:a,verticalScale:U})}e.hasAnyZOffset=!1;let d=!1;for(let m=0;m<e.symbolInstances.length;m++){let p=e.symbolInstances.get(m),u=p.zOffset,U=this._getHeightAtTileOffset(a,p.tileAnchorX,p.tileAnchorY);p.zOffset=U!==Number.NEGATIVE_INFINITY?U:u,d||u===p.zOffset||(d=!0),e.hasAnyZOffset||p.zOffset===0||(e.hasAnyZOffset=!0)}d&&(e.zOffsetBuffersNeedUpload=!0,e.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(e,a,d,m){let p=a,u=d;if(e.canonical.z!==m.canonical.z){let U=m.canonical,Y=1/(1<<e.canonical.z-U.z);p=(a+e.canonical.x*l.ab)*Y-U.x*l.ab|0,u=(d+e.canonical.y*l.ab)*Y-U.y*l.ab|0}return{tileX:p,tileY:u}}_getHeightAtTileOffset(e,a,d){let m,p;for(let u=0;u<this.layers.length;++u){if(this.layers[u].layer.type!=="fill-extrusion")continue;let{bucket:U,tileID:Y,verticalScale:y}=this.currentBuildingBuckets[u];if(!U)continue;let{tileX:B,tileY:C}=this._mapCoordToOverlappingTile(e,a,d,Y),k=U.getHeightAtTileCoord(B,C);k&&k.height!==void 0&&(k.hidden?m=k.height:p=Math.max(k.height*y,p||0))}if(p!==void 0)return p;for(let u=0;u<this.layers.length;++u){let U=this.layers[u];if(U.layer.type!=="model"||!U.visible)continue;let{bucket:Y,tileID:y}=this.currentBuildingBuckets[u];if(!Y)continue;let{tileX:B,tileY:C}=this._mapCoordToOverlappingTile(e,a,d,y),k=Y.getHeightAtTileCoord(B,C);if(k&&!k.hidden)return k.height===void 0&&m!==void 0?Math.min(k.maxHeight,m)*k.verticalScale:k.height?k.height*k.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function zo(r,e){let a={};for(let d in r)d!=="ref"&&(a[d]=r[d]);return l.bg.forEach(d=>{d in e&&(a[d]=e[d])}),a}function vc(r){r=r.slice();let e=Object.create(null);for(let a=0;a<r.length;a++)e[r[a].id]=r[a];for(let a=0;a<r.length;a++)"ref"in r[a]&&(r[a]=zo(r[a],e[r[a].ref]));return r}let hi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Ec(r,e,a){a.push({command:hi.addSource,args:[r,e[r]]})}function Ri(r,e,a){e.push({command:hi.removeSource,args:[r]}),a[r]=!0}function up(r,e,a,d){Ri(r,a,d),Ec(r,e,a)}function Je(r,e,a){let d;for(d in r[a])if(r[a].hasOwnProperty(d)&&d!=="data"&&!l.bh(r[a][d],e[a][d]))return!1;for(d in e[a])if(e[a].hasOwnProperty(d)&&d!=="data"&&!l.bh(r[a][d],e[a][d]))return!1;return!0}function qs(r,e,a,d,m,p){let u;for(u in e=e||{},r=r||{})r.hasOwnProperty(u)&&(l.bh(r[u],e[u])||a.push({command:p,args:[d,u,e[u],m]}));for(u in e)e.hasOwnProperty(u)&&!r.hasOwnProperty(u)&&(l.bh(r[u],e[u])||a.push({command:p,args:[d,u,e[u],m]}))}function ho(r){return r.id}function wo(r,e){return r[e.id]=e,r}class sl{constructor(e,a){this.reset(e,a)}reset(e,a){this.points=e||[],this._distances=[0];for(let d=1;d<this.points.length;d++)this._distances[d]=this._distances[d-1]+this.points[d].dist(this.points[d-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(a||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(e){if(this.points.length===1)return this.points[0];e=l.ap(e,0,1);let a=1,d=this._distances[a],m=e*this.paddedLength+this.padding;for(;d<m&&a<this._distances.length;)d=this._distances[++a];let p=a-1,u=this._distances[p],U=d-u,Y=U>0?(m-u)/U:0;return this.points[p].mult(1-Y).add(this.points[a].mult(Y))}}class ad{constructor(e,a,d){let m=this.boxCells=[],p=this.circleCells=[];this.xCellCount=Math.ceil(e/d),this.yCellCount=Math.ceil(a/d);for(let u=0;u<this.xCellCount*this.yCellCount;u++)m.push([]),p.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=a,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/a,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(e,a,d,m,p){this._forEachCell(a,d,m,p,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(a),this.bboxes.push(d),this.bboxes.push(m),this.bboxes.push(p)}insertCircle(e,a,d,m){this._forEachCell(a-m,d-m,a+m,d+m,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(a),this.circles.push(d),this.circles.push(m)}_insertBoxCell(e,a,d,m,p,u){this.boxCells[p].push(u)}_insertCircleCell(e,a,d,m,p,u){this.circleCells[p].push(u)}_query(e,a,d,m,p,u){if(d<0||e>this.width||m<0||a>this.height)return!p&&[];let U=[];if(e<=0&&a<=0&&this.width<=d&&this.height<=m){if(p)return!0;for(let Y=0;Y<this.boxKeys.length;Y++)U.push({key:this.boxKeys[Y],x1:this.bboxes[4*Y],y1:this.bboxes[4*Y+1],x2:this.bboxes[4*Y+2],y2:this.bboxes[4*Y+3]});for(let Y=0;Y<this.circleKeys.length;Y++){let y=this.circles[3*Y],B=this.circles[3*Y+1],C=this.circles[3*Y+2];U.push({key:this.circleKeys[Y],x1:y-C,y1:B-C,x2:y+C,y2:B+C})}return u?U.filter(u):U}return this._forEachCell(e,a,d,m,this._queryCell,U,{hitTest:p,seenUids:{box:{},circle:{}}},u),p?U.length>0:U}_queryCircle(e,a,d,m,p){let u=e-d,U=e+d,Y=a-d,y=a+d;if(U<0||u>this.width||y<0||Y>this.height)return!m&&[];let B=[];return this._forEachCell(u,Y,U,y,this._queryCellCircle,B,{hitTest:m,circle:{x:e,y:a,radius:d},seenUids:{box:{},circle:{}}},p),m?B.length>0:B}query(e,a,d,m,p){return this._query(e,a,d,m,!1,p)}hitTest(e,a,d,m,p){return this._query(e,a,d,m,!0,p)}hitTestCircle(e,a,d,m){return this._queryCircle(e,a,d,!0,m)}_queryCell(e,a,d,m,p,u,U,Y){let y=U.seenUids,B=this.boxCells[p];if(B!==null){let k=this.bboxes;for(let Q of B)if(!y.box[Q]){y.box[Q]=!0;let z=4*Q;if(e<=k[z+2]&&a<=k[z+3]&&d>=k[z+0]&&m>=k[z+1]&&(!Y||Y(this.boxKeys[Q]))){if(U.hitTest)return u.push(!0),!0;u.push({key:this.boxKeys[Q],x1:k[z],y1:k[z+1],x2:k[z+2],y2:k[z+3]})}}}let C=this.circleCells[p];if(C!==null){let k=this.circles;for(let Q of C)if(!y.circle[Q]){y.circle[Q]=!0;let z=3*Q;if(this._circleAndRectCollide(k[z],k[z+1],k[z+2],e,a,d,m)&&(!Y||Y(this.circleKeys[Q]))){if(U.hitTest)return u.push(!0),!0;{let w=k[z],A=k[z+1],H=k[z+2];u.push({key:this.circleKeys[Q],x1:w-H,y1:A-H,x2:w+H,y2:A+H})}}}}}_queryCellCircle(e,a,d,m,p,u,U,Y){let y=U.circle,B=U.seenUids,C=this.boxCells[p];if(C!==null){let Q=this.bboxes;for(let z of C)if(!B.box[z]){B.box[z]=!0;let w=4*z;if(this._circleAndRectCollide(y.x,y.y,y.radius,Q[w+0],Q[w+1],Q[w+2],Q[w+3])&&(!Y||Y(this.boxKeys[z])))return u.push(!0),!0}}let k=this.circleCells[p];if(k!==null){let Q=this.circles;for(let z of k)if(!B.circle[z]){B.circle[z]=!0;let w=3*z;if(this._circlesCollide(Q[w],Q[w+1],Q[w+2],y.x,y.y,y.radius)&&(!Y||Y(this.circleKeys[z])))return u.push(!0),!0}}}_forEachCell(e,a,d,m,p,u,U,Y){let y=this._convertToXCellCoord(e),B=this._convertToYCellCoord(a),C=this._convertToXCellCoord(d),k=this._convertToYCellCoord(m);for(let Q=y;Q<=C;Q++)for(let z=B;z<=k;z++)if(p.call(this,e,a,d,m,this.xCellCount*z+Q,u,U,Y))return}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}_circlesCollide(e,a,d,m,p,u){let U=m-e,Y=p-a,y=d+u;return y*y>U*U+Y*Y}_circleAndRectCollide(e,a,d,m,p,u,U){let Y=(u-m)/2,y=Math.abs(e-(m+Y));if(y>Y+d)return!1;let B=(U-p)/2,C=Math.abs(a-(p+B));if(C>B+d)return!1;if(y<=Y||C<=B)return!0;let k=y-Y,Q=C-B;return k*k+Q*Q<=d*d}}let jn={unknown:0,flipRequired:1,flipNotRequired:2},pe=Math.tan(85*Math.PI/180);function oi(r,e,a,d,m,p,u){let U=l.a6.mat4.create();if(a)if(p.name==="globe"){let Y=l.bi(m,e);l.a6.mat4.multiply(U,U,Y)}else{let Y=l.a6.mat2.invert([],u);U[0]=Y[0],U[1]=Y[1],U[4]=Y[2],U[5]=Y[3],d||l.a6.mat4.rotateZ(U,U,m.angle)}else l.a6.mat4.multiply(U,m.labelPlaneMatrix,r);return U}function si(r,e,a,d,m,p,u){let U=oi(r,e,a,d,m,p,u);return p.name==="globe"&&a||(U[2]=U[6]=U[10]=U[14]=0),U}function nn(r,e,a,d,m,p,u){if(a){if(p.name==="globe"){let U=oi(r,e,a,d,m,p,u);return l.a6.mat4.invert(U,U),l.a6.mat4.multiply(U,r,U),U}{let U=l.a6.mat4.clone(r),Y=l.a6.mat4.identity([]);return Y[0]=u[0],Y[1]=u[1],Y[4]=u[2],Y[5]=u[3],l.a6.mat4.multiply(U,U,Y),d||l.a6.mat4.rotateZ(U,U,-m.angle),U}}return m.glCoordMatrix}function Ea(r,e,a,d){let m=[r,e,a,1];a?l.a6.vec4.transformMat4(m,m,d):ld(m,m,d);let p=m[3];return m[0]/=p,m[1]/=p,m[2]/=p,m}function ci(r,e){return Math.min(.5+r/e*.5,1.5)}function nd(r,e){let a=r[0]/r[3],d=r[1]/r[3];return a>=-e[0]&&a<=e[0]&&d>=-e[1]&&d<=e[1]}function Ao(r,e,a,d,m,p,u,U,Y,y){let B=a.transform,C=d?r.textSizeData:r.iconSizeData,k=l.bj(C,a.transform.zoom),Q=B.projection.name==="globe",z=[256/a.width*2+1,256/a.height*2+1],w=d?r.text.dynamicLayoutVertexArray:r.icon.dynamicLayoutVertexArray;w.clear();let A=null;Q&&(A=d?r.text.globeExtVertexArray:r.icon.globeExtVertexArray);let H=r.lineVertexArray,$=d?r.text.placedSymbolArray:r.icon.placedSymbolArray,et=a.transform.width/a.transform.height,K,nt=!1;for(let at=0;at<$.length;at++){let ct=$.get(at),{numGlyphs:rt,writingMode:bt}=ct;if(bt!==l.bk.vertical||nt||K===l.bk.horizontal||(nt=!0),K=bt,(ct.hidden||bt===l.bk.vertical)&&!nt){rl(rt,w);continue}nt=!1;let gt=new l.P(ct.tileAnchorX,ct.tileAnchorY),{x:Wt,y:ht,z:Nt}=B.projection.projectTilePoint(gt.x,gt.y,y.canonical);if(Y){let[zt,Ht,Ue]=Y(gt);Wt+=zt,ht+=Ht,Nt+=Ue}let St=[Wt,ht,Nt,1];if(l.a6.vec4.transformMat4(St,St,e),!nd(St,z)){rl(rt,w);continue}let wt=St[3],kt=ci(a.transform.getCameraToCenterDistance(B.projection),wt),Ot=l.bl(C,k,ct),Yt=u?Ot/kt:Ot*kt,Lt=Ea(Wt,ht,Nt,m);if(Lt[3]<=0){rl(rt,w);continue}let vt={},_t=u?null:Y,qt=Ki(ct,Yt,!1,U,e,m,p,r.glyphOffsetArray,H,w,A,Lt,gt,vt,et,_t,B.projection,y,u);nt=qt.useVertical,_t&&qt.needsFlipping&&(vt={}),(qt.notEnoughRoom||nt||qt.needsFlipping&&Ki(ct,Yt,!0,U,e,m,p,r.glyphOffsetArray,H,w,A,Lt,gt,vt,et,_t,B.projection,y,u).notEnoughRoom)&&rl(rt,w)}d?(r.text.dynamicLayoutVertexBuffer.updateData(w),A&&r.text.globeExtVertexBuffer&&r.text.globeExtVertexBuffer.updateData(A)):(r.icon.dynamicLayoutVertexBuffer.updateData(w),A&&r.icon.globeExtVertexBuffer&&r.icon.globeExtVertexBuffer.updateData(A))}function Ho(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w){let{lineStartIndex:A,glyphStartIndex:H,segment:$}=U,et=H+U.numGlyphs,K=A+U.lineLength,nt=e.getoffsetX(H),at=e.getoffsetX(et-1),ct=Oo(r*nt,a,d,m,p,u,$,A,K,Y,y,B,C,k,!0,Q,z,w);if(!ct)return null;let rt=Oo(r*at,a,d,m,p,u,$,A,K,Y,y,B,C,k,!0,Q,z,w);return rt?{first:ct,last:rt}:null}function Oa(r,e,a,d){return r===l.bk.horizontal&&Math.abs(d)>Math.abs(a)?{useVertical:!0}:r===l.bk.vertical?d>0?{needsFlipping:!0}:null:e!==jn.unknown&&function(m,p){return m===0||Math.abs(p/m)>pe}(a,d)?e===jn.flipRequired?{needsFlipping:!0}:null:a<0?{needsFlipping:!0}:null}function Ki(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w,A,H,$){let et=e/24,K=r.lineOffsetX*et,nt=r.lineOffsetY*et,{lineStartIndex:at,glyphStartIndex:ct,numGlyphs:rt,segment:bt,writingMode:gt,flipState:Wt}=r,ht=at+r.lineLength,Nt=St=>{if(B){let[Yt,Lt,vt]=St.up,_t=y.length;l.bm(B,_t+0,Yt,Lt,vt),l.bm(B,_t+1,Yt,Lt,vt),l.bm(B,_t+2,Yt,Lt,vt),l.bm(B,_t+3,Yt,Lt,vt)}let[wt,kt,Ot]=St.point;l.bn(y,wt,kt,Ot,St.angle)};if(rt>1){let St=Ho(et,U,K,nt,a,C,k,r,Y,p,Q,w,!1,A,H,$);if(!St)return{notEnoughRoom:!0};if(d&&!a){let[wt,kt,Ot]=St.first.point,[Yt,Lt,vt]=St.last.point;[wt,kt]=Ea(wt,kt,Ot,u),[Yt,Lt]=Ea(Yt,Lt,vt,u);let _t=Oa(gt,Wt,(Yt-wt)*z,Lt-kt);if(r.flipState=_t&&_t.needsFlipping?jn.flipRequired:jn.flipNotRequired,_t)return _t}Nt(St.first);for(let wt=ct+1;wt<ct+rt-1;wt++){let kt=Oo(et*U.getoffsetX(wt),K,nt,a,C,k,bt,at,ht,Y,p,Q,w,!1,!1,A,H,$);if(!kt)return y.length-=4*(wt-ct),{notEnoughRoom:!0};Nt(kt)}Nt(St.last)}else{if(d&&!a){let wt=Ea(k.x,k.y,0,m),kt=at+bt+1,Ot=new l.P(Y.getx(kt),Y.gety(kt)),Yt=Ea(Ot.x,Ot.y,0,m),Lt=Yt[3]>0?Yt:jo(k,Ot,wt,1,m,void 0,A,H.canonical),vt=Oa(gt,Wt,(Lt[0]-wt[0])*z,Lt[1]-wt[1]);if(r.flipState=vt&&vt.needsFlipping?jn.flipRequired:jn.flipNotRequired,vt)return vt}let St=Oo(et*U.getoffsetX(ct),K,nt,a,C,k,bt,at,ht,Y,p,Q,w,!1,!1,A,H,$);if(!St)return{notEnoughRoom:!0};Nt(St)}return{}}function Lm(r,e,a,d,m){let{x:p,y:u,z:U}=d.projectTilePoint(r.x,r.y,e);if(!m)return Ea(p,u,U,a);let[Y,y,B]=m(r);return Ea(p+Y,u+y,U+B,a)}function jo(r,e,a,d,m,p,u,U){let Y=Lm(r.sub(e)._unit()._add(r),U,m,u,p);return l.a6.vec3.sub(Y,a,Y),l.a6.vec3.normalize(Y,Y),l.a6.vec3.scaleAndAdd(Y,a,Y,d)}function Oo(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w,A,H){let $=d?r-e:r+e,et=$>0?1:-1,K=0;d&&(et*=-1,K=Math.PI),et<0&&(K+=Math.PI);let nt=U+u+(et>0?0:1)|0,at=m,ct=m,rt=0,bt=0,gt=Math.abs($),Wt=[],ht=[],Nt=p,St=Nt,wt=()=>jo(St,Nt,ct,gt-rt+1,B,k,w,A.canonical);for(;rt+bt<=gt;){if(nt+=et,nt<U||nt>=Y)return null;if(ct=at,St=Nt,Wt.push(ct),Q&&ht.push(St),Nt=new l.P(y.getx(nt),y.gety(nt)),at=C[nt],!at){let Ht=Lm(Nt,A.canonical,B,w,k);at=Ht[3]>0?C[nt]=Ht:wt()}rt+=bt,bt=l.a6.vec3.distance(ct,at)}z&&k&&(C[nt]&&(at=wt(),bt=l.a6.vec3.distance(ct,at)),C[nt]=at);let kt=(gt-rt)/bt,Ot=Nt.sub(St)._mult(kt)._add(St),Yt=l.a6.vec3.sub([],at,ct),Lt=l.a6.vec3.scaleAndAdd([],ct,Yt,kt),vt=[0,0,1],_t=Yt[0],qt=Yt[1];if(H&&(vt=w.upVector(A.canonical,Ot.x,Ot.y),vt[0]!==0||vt[1]!==0||vt[2]!==1)){let Ht=[vt[2],0,-vt[0]],Ue=l.a6.vec3.cross([],vt,Ht);l.a6.vec3.normalize(Ht,Ht),l.a6.vec3.normalize(Ue,Ue),_t=l.a6.vec3.dot(Yt,Ht),qt=l.a6.vec3.dot(Yt,Ue)}if(a){let Ht=l.a6.vec3.cross([],vt,Yt);l.a6.vec3.normalize(Ht,Ht),l.a6.vec3.scaleAndAdd(Lt,Lt,Ht,a*et)}let zt=K+Math.atan2(qt,_t);return Wt.push(Lt),Q&&ht.push(Ot),{point:Lt,angle:zt,path:Wt,tilePath:ht,up:vt}}function rl(r,e){let a=e.length,d=a+4*r;e.resize(d),e.float32.fill(-1/0,4*a,4*d)}function ld(r,e,a){let d=e[0],m=e[1];return r[0]=a[0]*d+a[4]*m+a[12],r[1]=a[1]*d+a[5]*m+a[13],r[3]=a[3]*d+a[7]*m+a[15],r}let un=100;class La{constructor(e,a,d=new ad(e.width+200,e.height+200,25),m=new ad(e.width+200,e.height+200,25)){this.transform=e,this.grid=d,this.ignoredGrid=m,this.pitchfactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+un,this.screenBottomBoundary=e.height+un,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.fogState=a}placeCollisionBox(e,a,d,m,p,u,U,Y){let y=d.projectedAnchorX,B=d.projectedAnchorY,C=d.projectedAnchorZ,k=d.elevation,Q=d.tileID,z=e.getProjection();if(k&&Q){let[at,ct,rt]=z.upVector(Q.canonical,d.tileAnchorX,d.tileAnchorY),bt=z.upVectorScale(Q.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;y+=at*k*bt,B+=ct*k*bt,C+=rt*k*bt}let w=this.projectAndGetPerspectiveRatio(U,y,B,C,d.tileID,z.name==="globe"||!!k||this.transform.pitch>0,z),A=u*w.perspectiveRatio,H=(d.x1*a+m.x-d.padding)*A+w.point.x,$=(d.y1*a+m.y-d.padding)*A+w.point.y,et=(d.x2*a+m.x+d.padding)*A+w.point.x,K=(d.y2*a+m.y+d.padding)*A+w.point.y,nt=w.perspectiveRatio<=.55||w.occluded;return!this.isInsideGrid(H,$,et,K)||!p&&this.grid.hitTest(H,$,et,K,Y)||nt?{box:[],offscreen:!1,occluded:w.occluded}:{box:[H,$,et,K],offscreen:this.isOffscreen(H,$,et,K),occluded:!1}}placeCollisionCircles(e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w){let A=[],H=this.transform.elevation,$=e.getProjection(),et=H?H.getAtTileOffsetFunc(w,this.transform.center.lat,this.transform.worldSize,$):null,K=new l.P(d.tileAnchorX,d.tileAnchorY),{x:nt,y:at,z:ct}=$.projectTilePoint(K.x,K.y,w.canonical);if(et){let[Ot,Yt,Lt]=et(K);nt+=Ot,at+=Yt,ct+=Lt}let rt=$.name==="globe",bt=this.projectAndGetPerspectiveRatio(U,nt,at,ct,w,rt||!!H||this.transform.pitch>0,$),{perspectiveRatio:gt}=bt,Wt=(C?u/gt:u*gt)/l.bq,ht=Ea(nt,at,ct,Y),Nt=bt.signedDistanceFromCamera>0?Ho(Wt,p,d.lineOffsetX*Wt,d.lineOffsetY*Wt,!1,ht,K,d,m,Y,{},H&&!C?et:null,C&&!!H,$,w,C):null,St=!1,wt=!1,kt=!0;if(Nt&&!bt.occluded){let Ot=.5*Q*gt+z,Yt=new l.P(-100,-100),Lt=new l.P(this.screenRightBoundary,this.screenBottomBoundary),vt=new sl,{first:_t,last:qt}=Nt,zt=_t.path.length,Ht=[];for(let be=zt-1;be>=1;be--)Ht.push(_t.path[be]);for(let be=1;be<qt.path.length;be++)Ht.push(qt.path[be]);let Ue=2.5*Ot;y&&(Ht=Ht.map(([be,Me,ge],Ye)=>(et&&!rt&&(ge=et(Ye<zt-1?_t.tilePath[zt-1-Ye]:qt.tilePath[Ye-zt+2])[2]),Ea(be,Me,ge,y))),Ht.some(be=>be[3]<=0)&&(Ht=[]));let ie=[];if(Ht.length>0){let be=1/0,Me=-1/0,ge=1/0,Ye=-1/0;for(let qe of Ht)be=Math.min(be,qe[0]),ge=Math.min(ge,qe[1]),Me=Math.max(Me,qe[0]),Ye=Math.max(Ye,qe[1]);Me>=Yt.x&&be<=Lt.x&&Ye>=Yt.y&&ge<=Lt.y&&(ie=[Ht.map(qe=>new l.P(qe[0],qe[1]))],(be<Yt.x||Me>Lt.x||ge<Yt.y||Ye>Lt.y)&&(ie=l.bo(ie,Yt.x,Yt.y,Lt.x,Lt.y)))}for(let be of ie){vt.reset(be,.25*Ot);let Me=0;Me=vt.length<=.5*Ot?1:Math.ceil(vt.paddedLength/Ue)+1;for(let ge=0;ge<Me;ge++){let Ye=ge/Math.max(Me-1,1),qe=vt.lerp(Ye),De=qe.x+un,Ui=qe.y+un;A.push(De,Ui,Ot,0);let Xi=De-Ot,Si=Ui-Ot,Bn=De+Ot,ta=Ui+Ot;if(kt=kt&&this.isOffscreen(Xi,Si,Bn,ta),wt=wt||this.isInsideGrid(Xi,Si,Bn,ta),!a&&this.grid.hitTestCircle(De,Ui,Ot,k)&&(St=!0,!B))return{circles:[],offscreen:!1,collisionDetected:St,occluded:!1}}}}return{circles:!B&&St||!wt?[]:A,offscreen:kt,collisionDetected:St,occluded:bt.occluded}}queryRenderedSymbols(e){if(e.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};let a=[],d=1/0,m=1/0,p=-1/0,u=-1/0;for(let B of e){let C=new l.P(B.x+un,B.y+un);d=Math.min(d,C.x),m=Math.min(m,C.y),p=Math.max(p,C.x),u=Math.max(u,C.y),a.push(C)}let U=this.grid.query(d,m,p,u).concat(this.ignoredGrid.query(d,m,p,u)),Y={},y={};for(let B of U){let C=B.key;if(Y[C.bucketInstanceId]===void 0&&(Y[C.bucketInstanceId]={}),Y[C.bucketInstanceId][C.featureIndex])continue;let k=[new l.P(B.x1,B.y1),new l.P(B.x2,B.y1),new l.P(B.x2,B.y2),new l.P(B.x1,B.y2)];l.bp(a,k)&&(Y[C.bucketInstanceId][C.featureIndex]=!0,y[C.bucketInstanceId]===void 0&&(y[C.bucketInstanceId]=[]),y[C.bucketInstanceId].push(C.featureIndex))}return y}insertCollisionBox(e,a,d,m,p){(a?this.ignoredGrid:this.grid).insert({bucketInstanceId:d,featureIndex:m,collisionGroupID:p},e[0],e[1],e[2],e[3])}insertCollisionCircles(e,a,d,m,p){let u=a?this.ignoredGrid:this.grid,U={bucketInstanceId:d,featureIndex:m,collisionGroupID:p};for(let Y=0;Y<e.length;Y+=4)u.insertCircle(U,e[Y],e[Y+1],e[Y+2])}projectAndGetPerspectiveRatio(e,a,d,m,p,u,U){let Y=[a,d,m,1],y=!1;m||this.transform.pitch>0?(l.a6.vec4.transformMat4(Y,Y,e),this.fogState&&p&&U.name!=="globe"&&(y=function(k,Q,z,w,A,H){let $=H.calculateFogTileMatrix(A),et=[Q,z,w];return l.a6.vec3.transformMat4(et,et,$),ce(k,l.a6.vec3.length(et),H.pitch,H._fov)}(this.fogState,a,d,m,p.toUnwrapped(),this.transform)>.9)):ld(Y,Y,e);let B=Y[3];return{point:new l.P((Y[0]/B+1)/2*this.transform.width+un,(-Y[1]/B+1)/2*this.transform.height+un),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(U)/B*.5,1.5),signedDistanceFromCamera:B,occluded:u&&Y[2]>B||y}}isOffscreen(e,a,d,m){return d<un||e>=this.screenRightBoundary||m<un||a>this.screenBottomBoundary}isInsideGrid(e,a,d,m){return d>=0&&e<this.gridRightBoundary&&m>=0&&a<this.gridBottomBoundary}getViewportMatrix(){let e=l.a6.mat4.identity([]);return l.a6.mat4.translate(e,e,[-100,-100,0]),e}}function Da(r,e,a){let d=e.createTileMatrix(r,r.worldSize,a.toUnwrapped());return l.a6.mat4.multiply(new Float32Array(16),r.projMatrix,d)}function zm(r,e,a){if(e.projection.name===a.projection.name)return r.projMatrix;let d=a.clone();return d.setProjection(e.projection),Da(d,e.getProjection(),r)}function jl(r,e,a){return e.name===a.projection.name?r.projMatrix:Da(a,e,r)}class na{constructor(e,a,d,m){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?a:-a))):m&&d?1:0,this.placed=d}isHidden(){return this.opacity===0&&!this.placed}}class _a{constructor(e,a,d,m,p,u=!1){this.text=new na(e?e.text:null,a,d,p),this.icon=new na(e?e.icon:null,a,m,p),this.clipped=u}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class On{constructor(e,a,d,m=!1){this.text=e,this.icon=a,this.skipFade=d,this.clipped=m}}class ga{constructor(){this.invProjMatrix=l.a6.mat4.create(),this.viewportMatrix=l.a6.mat4.create(),this.circles=[]}}class Lc{constructor(e,a,d,m,p){this.bucketInstanceId=e,this.featureIndex=a,this.sourceLayerIndex=d,this.bucketIndex=m,this.tileID=p}}class Dn{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={}}get(e){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[e]){let a=++this.maxGroupID;this.collisionGroups[e]={ID:a,predicate:d=>d.collisionGroupID===a}}return this.collisionGroups[e]}}function Do(r,e,a,d,m){let{horizontalAlign:p,verticalAlign:u}=l.bx(r),U=-(p-.5)*e,Y=-(u-.5)*a,y=l.bw(r,d);return new l.P(U+y[0]*m,Y+y[1]*m)}function po(r,e,a,d,m){let p=new l.P(r,e);return a&&p._rotate(d?m:-m),p}class Wo{constructor(e,a,d,m,p,u){this.transform=e.clone(),this.projection=e.projection.name,this.collisionIndex=new La(this.transform,p),this.buildingIndex=u,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=a,this.retainedQueryData={},this.collisionGroups=new Dn(d),this.collisionCircleArrays={},this.prevPlacement=m,m&&(m.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(e,a,d,m){let p=d.getBucket(a),u=d.latestFeatureIndex;if(!p||!u||a.fqid!==p.layerIds[0])return;let U=p.layers[0].layout,Y=p.layers[0].paint,y=d.collisionBoxArray,B=Math.pow(2,this.transform.zoom-d.tileID.overscaledZ),C=d.tileSize/l.ab,k=d.tileID.toUnwrapped();this.transform.setProjection(p.projection);let Q=(z=d.tileID,w=p.getProjection(),A=this.transform,w.name===this.projection?A.calculateProjMatrix(z.toUnwrapped()):Da(A,w,z));var z,w,A;let H=U.get("text-pitch-alignment")==="map",$=U.get("text-rotation-alignment")==="map";a.compileFilter();let et=a.dynamicFilter(),K=a.dynamicFilterNeedsFeature(),nt=this.transform.calculatePixelsToTileUnitsMatrix(d),at=si(Q,d.tileID.canonical,H,$,this.transform,p.getProjection(),nt),ct=null;if(H){let gt=nn(Q,d.tileID.canonical,H,$,this.transform,p.getProjection(),nt);ct=l.a6.mat4.multiply([],this.transform.labelPlaneMatrix,gt)}let rt=null;et&&d.latestFeatureIndex&&(rt={unwrappedTileID:k,dynamicFilter:et,dynamicFilterNeedsFeature:K}),this.retainedQueryData[p.bucketInstanceId]=new Lc(p.bucketInstanceId,u,p.sourceLayerIndex,p.index,d.tileID);let bt={bucket:p,layout:U,paint:Y,posMatrix:Q,textLabelPlaneMatrix:at,labelToScreenMatrix:ct,clippingData:rt,scale:B,textPixelRatio:C,holdingForFade:d.holdingForFade(),collisionBoxArray:y,partiallyEvaluatedTextSize:l.bj(p.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:l.bj(p.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(p.sourceID),latestFeatureIndex:d.latestFeatureIndex};if(m)for(let gt of p.sortKeyRanges){let{sortKey:Wt,symbolInstanceStart:ht,symbolInstanceEnd:Nt}=gt;e.push({sortKey:Wt,symbolInstanceStart:ht,symbolInstanceEnd:Nt,parameters:bt})}else e.push({symbolInstanceStart:0,symbolInstanceEnd:p.symbolInstances.length,parameters:bt})}attemptAnchorPlacement(e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w,A,H,$){let{textOffset0:et,textOffset1:K,crossTileID:nt}=k,at=[et,K],ct=Do(e,d,m,at,p),rt=this.collisionIndex.placeCollisionBox(z,p,a,po(ct.x,ct.y,u,U,this.transform.angle),C,Y,y,B.predicate);if(A){let bt=z.getSymbolInstanceIconSize($,this.transform.zoom,k.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(z,bt,A,po(ct.x,ct.y,u,U,this.transform.angle),C,Y,y,B.predicate).box.length===0)return}if(rt.box.length>0){let bt;return this.prevPlacement&&this.prevPlacement.variableOffsets[nt]&&this.prevPlacement.placements[nt]&&this.prevPlacement.placements[nt].text&&(bt=this.prevPlacement.variableOffsets[nt].anchor),this.variableOffsets[nt]={textOffset:at,width:d,height:m,anchor:e,textScale:p,prevAnchor:bt},this.markUsedJustification(z,e,k,w),z.allowVerticalPlacement&&(this.markUsedOrientation(z,w,k),this.placedOrientations[nt]=w),{shift:ct,placedGlyphBoxes:rt}}}placeLayerBucketPart(e,a,d,m){let{bucket:p,layout:u,paint:U,posMatrix:Y,textLabelPlaneMatrix:y,labelToScreenMatrix:B,clippingData:C,textPixelRatio:k,holdingForFade:Q,collisionBoxArray:z,partiallyEvaluatedTextSize:w,partiallyEvaluatedIconSize:A,collisionGroup:H,latestFeatureIndex:$}=e.parameters,et=u.get("text-optional"),K=u.get("icon-optional"),nt=u.get("text-allow-overlap"),at=u.get("icon-allow-overlap"),ct=u.get("text-rotation-alignment")==="map",rt=u.get("text-pitch-alignment")==="map",bt=u.get("symbol-z-elevate"),gt=U.get("symbol-z-offset"),Wt=U.get("symbol-elevation-reference")==="sea";this.transform.setProjection(p.projection);let ht=nt&&(at||!p.hasIconData()||K),Nt=at&&(nt||!p.hasTextData()||et),St=!gt.isConstant();!p.collisionArrays&&z&&p.deserializeCollisionBoxes(z),d&&m&&p.updateCollisionDebugBuffers(this.transform.zoom,z);let wt=(kt,Ot,Yt)=>{let{crossTileID:Lt,numVerticalGlyphVertices:vt}=kt,_t=null;if(C&&C.dynamicFilterNeedsFeature||St){let Pe=this.retainedQueryData[p.bucketInstanceId];_t=$.loadFeature({featureIndex:kt.featureIndex,bucketIndex:Pe.bucketIndex,sourceLayerIndex:Pe.sourceLayerIndex,layoutVertexArrayOffset:0})}if(C&&!(0,C.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},_t,this.retainedQueryData[p.bucketInstanceId].tileID.canonical,new l.P(kt.tileAnchorX,kt.tileAnchorY),this.transform.calculateDistanceTileData(C.unwrappedTileID)))return this.placements[Lt]=new On(!1,!1,!1,!0),void a.add(Lt);let qt=gt.evaluate(_t,{});if(a.has(Lt))return;if(Q)return void(this.placements[Lt]=new On(!1,!1,!1));let zt=!1,Ht=!1,Ue=!0,ie=!1,be=!1,Me=null,ge={box:null,offscreen:null,occluded:null},Ye={box:null,offscreen:null,occluded:null},qe=null,De=null,Ui=null,Xi=0,Si=0,Bn=0;Yt.textFeatureIndex?Xi=Yt.textFeatureIndex:kt.useRuntimeCollisionCircles&&(Xi=kt.featureIndex),Yt.verticalTextFeatureIndex&&(Si=Yt.verticalTextFeatureIndex);let ta=Pe=>{Pe.tileID=this.retainedQueryData[p.bucketInstanceId].tileID;let Wi=this.transform.elevation;Pe.elevation=Wt?qt:qt+(Wi?Wi.getAtTileOffset(Pe.tileID,Pe.tileAnchorX,Pe.tileAnchorY):0),Pe.elevation+=kt.zOffset},ni=Yt.textBox;if(ni){ta(ni);let Pe=Gi=>{let Di=l.bk.horizontal;if(p.allowVerticalPlacement&&!Gi&&this.prevPlacement){let ea=this.prevPlacement.placedOrientations[Lt];ea&&(this.placedOrientations[Lt]=ea,Di=ea,this.markUsedOrientation(p,Di,kt))}return Di},Wi=(Gi,Di)=>{if(p.allowVerticalPlacement&&vt>0&&Yt.verticalTextBox){for(let ea of p.writingModes)if(ea===l.bk.vertical?(ge=Di(),Ye=ge):ge=Gi(),ge&&ge.box&&ge.box.length)break}else ge=Gi()};if(u.get("text-variable-anchor")){let Gi=u.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Lt]){let di=this.prevPlacement.variableOffsets[Lt];Gi.indexOf(di.anchor)>0&&(Gi=Gi.filter(ma=>ma!==di.anchor),Gi.unshift(di.anchor))}let Di=(di,ma,Va)=>{let ha=p.getSymbolInstanceTextSize(w,kt,this.transform.zoom,Ot),Ti=(di.x2-di.x1)*ha+2*di.padding,Ka=(di.y2-di.y1)*ha+2*di.padding,qa=kt.hasIconTextFit&&!at?ma:null;qa&&ta(qa);let Mn={box:[],offscreen:!1,occluded:!1},Fn=nt?2*Gi.length:Gi.length;for(let rn=0;rn<Fn;++rn){let Tn=this.attemptAnchorPlacement(Gi[rn%Gi.length],di,Ti,Ka,ha,ct,rt,k,Y,H,rn>=Gi.length,kt,Ot,p,Va,qa,w,A);if(Tn&&(Mn=Tn.placedGlyphBoxes,Mn&&Mn.box&&Mn.box.length)){zt=!0,Me=Tn.shift;break}}return Mn};Wi(()=>Di(ni,Yt.iconBox,l.bk.horizontal),()=>{let di=Yt.verticalTextBox;return di&&ta(di),p.allowVerticalPlacement&&!(ge&&ge.box&&ge.box.length)&&vt>0&&di?Di(di,Yt.verticalIconBox,l.bk.vertical):{box:null,offscreen:null,occluded:null}}),ge&&(zt=ge.box,Ue=ge.offscreen,ie=ge.occluded);let ea=Pe(!(!ge||!ge.box));if(!zt&&this.prevPlacement){let di=this.prevPlacement.variableOffsets[Lt];di&&(this.variableOffsets[Lt]=di,this.markUsedJustification(p,di.anchor,kt,ea))}}else{let Gi=(Di,ea)=>{let di=p.getSymbolInstanceTextSize(w,kt,this.transform.zoom,Ot),ma=this.collisionIndex.placeCollisionBox(p,di,Di,new l.P(0,0),nt,k,Y,H.predicate);return ma&&ma.box&&ma.box.length&&(this.markUsedOrientation(p,ea,kt),this.placedOrientations[Lt]=ea),ma};Wi(()=>Gi(ni,l.bk.horizontal),()=>{let Di=Yt.verticalTextBox;return p.allowVerticalPlacement&&vt>0&&Di?(ta(Di),Gi(Di,l.bk.vertical)):{box:null,offscreen:null,occluded:null}}),Pe(!!(ge&&ge.box&&ge.box.length))}}if(qe=ge,zt=qe&&qe.box&&qe.box.length>0,Ue=qe&&qe.offscreen,ie=qe&&qe.occluded,kt.useRuntimeCollisionCircles){let Pe=p.text.placedSymbolArray.get(kt.centerJustifiedTextSymbolIndex>=0?kt.centerJustifiedTextSymbolIndex:kt.verticalPlacedTextSymbolIndex),Wi=l.bl(p.textSizeData,w,Pe),Gi=u.get("text-padding");De=this.collisionIndex.placeCollisionCircles(p,nt,Pe,p.lineVertexArray,p.glyphOffsetArray,Wi,Y,y,B,d,rt,H.predicate,kt.collisionCircleDiameter*Wi/l.bq,Gi,this.retainedQueryData[p.bucketInstanceId].tileID),zt=nt||De.circles.length>0&&!De.collisionDetected,Ue=Ue&&De.offscreen,ie=De.occluded}if(Yt.iconFeatureIndex&&(Bn=Yt.iconFeatureIndex),Yt.iconBox){let Pe=Wi=>{ta(Wi);let Gi=kt.hasIconTextFit&&Me?po(Me.x,Me.y,ct,rt,this.transform.angle):new l.P(0,0),Di=p.getSymbolInstanceIconSize(A,this.transform.zoom,kt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(p,Di,Wi,Gi,at,k,Y,H.predicate)};Ye&&Ye.box&&Ye.box.length&&Yt.verticalIconBox?(Ui=Pe(Yt.verticalIconBox),Ht=Ui.box.length>0):(Ui=Pe(Yt.iconBox),Ht=Ui.box.length>0),Ue=Ue&&Ui.offscreen,be=Ui.occluded}let Yi=et||kt.numHorizontalGlyphVertices===0&&vt===0,Li=K||kt.numIconVertices===0;if(Yi||Li?Li?Yi||(Ht=Ht&&zt):zt=Ht&&zt:Ht=zt=Ht&&zt,zt&&qe&&qe.box&&this.collisionIndex.insertCollisionBox(qe.box,u.get("text-ignore-placement"),p.bucketInstanceId,Ye&&Ye.box&&Si?Si:Xi,H.ID),Ht&&Ui&&this.collisionIndex.insertCollisionBox(Ui.box,u.get("icon-ignore-placement"),p.bucketInstanceId,Bn,H.ID),De&&(zt&&this.collisionIndex.insertCollisionCircles(De.circles,u.get("text-ignore-placement"),p.bucketInstanceId,Xi,H.ID),d)){let Pe=p.bucketInstanceId,Wi=this.collisionCircleArrays[Pe];Wi===void 0&&(Wi=this.collisionCircleArrays[Pe]=new ga);for(let Gi=0;Gi<De.circles.length;Gi+=4)Wi.circles.push(De.circles[Gi+0]),Wi.circles.push(De.circles[Gi+1]),Wi.circles.push(De.circles[Gi+2]),Wi.circles.push(De.collisionDetected?1:0)}let Ni=p.projection.name!=="globe";ht=ht&&(Ni||!ie),Nt=Nt&&(Ni||!be),this.placements[Lt]=new On(zt||ht,Ht||Nt,Ue||p.justReloaded),a.add(Lt)};if(bt&&this.buildingIndex&&(this.buildingIndex.updateZOffset(p,this.retainedQueryData[p.bucketInstanceId].tileID),p.updateZOffset()),p.sortFeaturesByY){let kt=p.getSortedSymbolIndexes(this.transform.angle);for(let Ot=kt.length-1;Ot>=0;--Ot){let Yt=kt[Ot];wt(p.symbolInstances.get(Yt),Yt,p.collisionArrays[Yt])}p.hasAnyZOffset&&l.w(`${p.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(p.hasAnyZOffset){let kt=p.getSortedIndexesByZOffset();for(let Ot=0;Ot<kt.length;++Ot){let Yt=kt[Ot];wt(p.symbolInstances.get(Yt),Yt,p.collisionArrays[Yt])}}else for(let kt=e.symbolInstanceStart;kt<e.symbolInstanceEnd;kt++)wt(p.symbolInstances.get(kt),kt,p.collisionArrays[kt]);if(d&&p.bucketInstanceId in this.collisionCircleArrays){let kt=this.collisionCircleArrays[p.bucketInstanceId];l.a6.mat4.invert(kt.invProjMatrix,Y),kt.viewportMatrix=this.collisionIndex.getViewportMatrix()}p.justReloaded=!1}markUsedJustification(e,a,d,m){let{leftJustifiedTextSymbolIndex:p,centerJustifiedTextSymbolIndex:u,rightJustifiedTextSymbolIndex:U,verticalPlacedTextSymbolIndex:Y,crossTileID:y}=d,B=l.bv(a),C=m===l.bk.vertical?Y:B==="left"?p:B==="center"?u:B==="right"?U:-1;p>=0&&(e.text.placedSymbolArray.get(p).crossTileID=C>=0&&p!==C?0:y),u>=0&&(e.text.placedSymbolArray.get(u).crossTileID=C>=0&&u!==C?0:y),U>=0&&(e.text.placedSymbolArray.get(U).crossTileID=C>=0&&U!==C?0:y),Y>=0&&(e.text.placedSymbolArray.get(Y).crossTileID=C>=0&&Y!==C?0:y)}markUsedOrientation(e,a,d){let m=a===l.bk.horizontal||a===l.bk.horizontalOnly?a:0,p=a===l.bk.vertical?a:0,{leftJustifiedTextSymbolIndex:u,centerJustifiedTextSymbolIndex:U,rightJustifiedTextSymbolIndex:Y,verticalPlacedTextSymbolIndex:y}=d,B=e.text.placedSymbolArray;u>=0&&(B.get(u).placedOrientation=m),U>=0&&(B.get(U).placedOrientation=m),Y>=0&&(B.get(Y).placedOrientation=m),y>=0&&(B.get(y).placedOrientation=p)}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;let a=this.prevPlacement,d=!1;this.prevZoomAdjustment=a?a.zoomAdjustment(this.transform.zoom):0;let m=a?a.symbolFadeChange(e):1,p=a?a.opacities:{},u=a?a.variableOffsets:{},U=a?a.placedOrientations:{};for(let Y in this.placements){let y=this.placements[Y],B=p[Y];B?(this.opacities[Y]=new _a(B,m,y.text,y.icon,null,y.clipped),d=d||y.text!==B.text.placed||y.icon!==B.icon.placed):(this.opacities[Y]=new _a(null,m,y.text,y.icon,y.skipFade,y.clipped),d=d||y.text||y.icon)}for(let Y in p){let y=p[Y];if(!this.opacities[Y]){let B=new _a(y,m,!1,!1);B.isHidden()||(this.opacities[Y]=B,d=d||y.text.placed||y.icon.placed)}}for(let Y in u)this.variableOffsets[Y]||!this.opacities[Y]||this.opacities[Y].isHidden()||(this.variableOffsets[Y]=u[Y]);for(let Y in U)this.placedOrientations[Y]||!this.opacities[Y]||this.opacities[Y].isHidden()||(this.placedOrientations[Y]=U[Y]);d?this.lastPlacementChangeTime=e:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=a?a.lastPlacementChangeTime:e)}updateLayerOpacities(e,a,d,m){let p=new Set;for(let u of a){let U=u.getBucket(e);U&&u.latestFeatureIndex&&e.fqid===U.layerIds[0]&&(this.updateBucketOpacities(U,p,u,u.collisionBoxArray,d,m,u.tileID,e.scope),U.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(U,u.tileID),U.updateZOffset()))}}updateBucketOpacities(e,a,d,m,p,u,U,Y){e.hasTextData()&&e.text.opacityVertexArray.clear(),e.hasIconData()&&e.icon.opacityVertexArray.clear(),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexArray.clear(),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexArray.clear();let y=e.layers[0].layout,B=e.layers[0].paint,C=!!e.layers[0].dynamicFilter(),k=new _a(null,0,!1,!1,!0),Q=y.get("text-allow-overlap"),z=y.get("icon-allow-overlap"),w=y.get("text-variable-anchor"),A=y.get("text-rotation-alignment")==="map",H=y.get("text-pitch-alignment")==="map",$=B.get("symbol-z-offset"),et=B.get("symbol-elevation-reference")==="sea",K=!$.isConstant(),nt=new _a(null,0,Q&&(z||!e.hasIconData()||y.get("icon-optional")),z&&(Q||!e.hasTextData()||y.get("text-optional")),!0);!e.collisionArrays&&m&&(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData())&&e.deserializeCollisionBoxes(m);let at=(rt,bt,gt)=>{for(let Wt=0;Wt<bt/4;Wt++)rt.opacityVertexArray.emplaceBack(gt)},ct=0;u&&e.updateReplacement(U,u);for(let rt=0;rt<e.symbolInstances.length;rt++){let bt=e.symbolInstances.get(rt),{numHorizontalGlyphVertices:gt,numVerticalGlyphVertices:Wt,crossTileID:ht,numIconVertices:Nt,tileAnchorX:St,tileAnchorY:wt}=bt,kt=null;if(bt&&K){let ie=this.retainedQueryData[e.bucketInstanceId];kt=d.latestFeatureIndex.loadFeature({featureIndex:bt.featureIndex,bucketIndex:ie.bucketIndex,sourceLayerIndex:ie.sourceLayerIndex,layoutVertexArrayOffset:0})}let Ot=$.evaluate(kt,{}),Yt=a.has(ht),Lt=this.opacities[ht];Yt?Lt=k:Lt||(Lt=nt,this.opacities[ht]=Lt),a.add(ht);let vt=gt>0||Wt>0,_t=Nt>0,qt=this.placedOrientations[ht],zt=qt===l.bk.vertical,Ht=qt===l.bk.horizontal||qt===l.bk.horizontalOnly;!vt&&!_t||Lt.isHidden()||ct++;let Ue=!1;if((vt||_t)&&u)for(let ie of e.activeReplacements){if(l.br(ie,p,l.bs.Symbol,Y)||ie.min.x>St||St>ie.max.x||ie.min.y>wt||wt>ie.max.y)continue;let be=l.bt(St,wt,U.canonical,ie.footprintTileId.canonical);if(Ue=l.bu(be,ie.footprint),Ue)break}if(vt){let ie=Ue?Po:_o(Lt.text);at(e.text,gt,zt?Po:ie),at(e.text,Wt,Ht?Po:ie);let be=Lt.text.isHidden(),{leftJustifiedTextSymbolIndex:Me,centerJustifiedTextSymbolIndex:ge,rightJustifiedTextSymbolIndex:Ye,verticalPlacedTextSymbolIndex:qe}=bt,De=e.text.placedSymbolArray,Ui=be||zt?1:0;Me>=0&&(De.get(Me).hidden=Ui),ge>=0&&(De.get(ge).hidden=Ui),Ye>=0&&(De.get(Ye).hidden=Ui),qe>=0&&(De.get(qe).hidden=be||Ht?1:0);let Xi=this.variableOffsets[ht];Xi&&this.markUsedJustification(e,Xi.anchor,bt,qt);let Si=this.placedOrientations[ht];Si&&(this.markUsedJustification(e,"left",bt,Si),this.markUsedOrientation(e,Si,bt))}if(_t){let ie=Ue?Po:_o(Lt.icon),{placedIconSymbolIndex:be,verticalPlacedIconSymbolIndex:Me}=bt,ge=e.icon.placedSymbolArray,Ye=Lt.icon.isHidden()?1:0;be>=0&&(at(e.icon,Nt,zt?Po:ie),ge.get(be).hidden=Ye),Me>=0&&(at(e.icon,bt.numVerticalIconVertices,Ht?Po:ie),ge.get(Me).hidden=Ye)}if(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData()){let ie=e.collisionArrays[rt];if(ie){let be=new l.P(0,0),Me=!0;if(ie.textBox||ie.verticalTextBox){if(w){let Ye=this.variableOffsets[ht];Ye?(be=Do(Ye.anchor,Ye.width,Ye.height,Ye.textOffset,Ye.textScale),A&&be._rotate(H?this.transform.angle:-this.transform.angle)):Me=!1}C&&(Me=!Lt.clipped),ie.textBox&&od(e.textCollisionBox.collisionVertexArray,Lt.text.placed,!Me||zt,Ot,et,be.x,be.y),ie.verticalTextBox&&od(e.textCollisionBox.collisionVertexArray,Lt.text.placed,!Me||Ht,Ot,et,be.x,be.y)}let ge=Me&&!!(!Ht&&ie.verticalIconBox);ie.iconBox&&od(e.iconCollisionBox.collisionVertexArray,Lt.icon.placed,ge,Ot,et,bt.hasIconTextFit?be.x:0,bt.hasIconTextFit?be.y:0),ie.verticalIconBox&&od(e.iconCollisionBox.collisionVertexArray,Lt.icon.placed,!ge,Ot,et,bt.hasIconTextFit?be.x:0,bt.hasIconTextFit?be.y:0)}}}if(e.fullyClipped=ct===0,e.sortFeatures(this.transform.angle),this.retainedQueryData[e.bucketInstanceId]&&(this.retainedQueryData[e.bucketInstanceId].featureSortOrder=e.featureSortOrder),e.hasTextData()&&e.text.opacityVertexBuffer&&e.text.opacityVertexBuffer.updateData(e.text.opacityVertexArray),e.hasIconData()&&e.icon.opacityVertexBuffer&&e.icon.opacityVertexBuffer.updateData(e.icon.opacityVertexArray),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexBuffer&&e.iconCollisionBox.collisionVertexBuffer.updateData(e.iconCollisionBox.collisionVertexArray),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexBuffer&&e.textCollisionBox.collisionVertexBuffer.updateData(e.textCollisionBox.collisionVertexArray),e.bucketInstanceId in this.collisionCircleArrays){let rt=this.collisionCircleArrays[e.bucketInstanceId];e.placementInvProjMatrix=rt.invProjMatrix,e.placementViewportMatrix=rt.viewportMatrix,e.collisionCircleArray=rt.circles,delete this.collisionCircleArrays[e.bucketInstanceId]}}symbolFadeChange(e){return this.fadeDuration===0?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5)}hasTransitions(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(e,a){let d=this.zoomAtLastRecencyCheck===a?1-this.zoomAdjustment(a):1;return this.zoomAtLastRecencyCheck=a,this.commitTime+this.fadeDuration*d>e}setStale(){this.stale=!0}}function od(r,e,a,d,m,p,u){r.emplaceBack(e?1:0,a?1:0,p||0,u||0,d,m?1:0),r.emplaceBack(e?1:0,a?1:0,p||0,u||0,d,m?1:0),r.emplaceBack(e?1:0,a?1:0,p||0,u||0,d,m?1:0),r.emplaceBack(e?1:0,a?1:0,p||0,u||0,d,m?1:0)}let Jl=Math.pow(2,25),Zp=Math.pow(2,24),wm=Math.pow(2,17),ln=Math.pow(2,16),gp=Math.pow(2,9),sd=Math.pow(2,8),Am=Math.pow(2,1);function _o(r){if(r.opacity===0&&!r.placed)return 0;if(r.opacity===1&&r.placed)return 4294967295;let e=r.placed?1:0,a=Math.floor(127*r.opacity);return a*Jl+e*Zp+a*wm+e*ln+a*gp+e*sd+a*Am+e}let Po=0;class Vp{constructor(e){this._sortAcrossTiles=e.layout.get("symbol-z-order")!=="viewport-y"&&e.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(e,a,d,m,p){let u=this._bucketParts;for(;this._currentTileIndex<e.length;)if(a.getBucketParts(u,m,e[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,p())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,u.sort((U,Y)=>U.sortKey-Y.sortKey));this._currentPartIndex<u.length;){let U=u[this._currentPartIndex];if(a.placeLayerBucketPart(U,this._seenCrossTileIDs,d,U.symbolInstanceStart===0),this._currentPartIndex++,p())return!0}return!1}}class $s{constructor(e,a,d,m,p,u,U,Y,y){this.placement=new Wo(e,p,u,U,Y,y),this._currentPlacementIndex=a.length-1,this._forceFullPlacement=d,this._showCollisionBoxes=m,this._done=!1}isDone(){return this._done}continuePlacement(e,a,d,m){let p=l.q.now(),u=()=>{let U=l.q.now()-p;return!this._forceFullPlacement&&U>2};for(;this._currentPlacementIndex>=0;){let U=a[e[this._currentPlacementIndex]],Y=this.placement.collisionIndex.transform.zoom;if(U.type==="symbol"&&(!U.minzoom||U.minzoom<=Y)&&(!U.maxzoom||U.maxzoom>Y)){let y=U,B=y.layout.get("symbol-z-elevate"),C=y.layout.get("symbol-sort-key").constantOr(1)!==void 0,k=y.layout.get("symbol-z-order"),Q=k==="viewport-y"||k==="auto"&&!(k!=="viewport-y"&&C),z=y.layout.get("text-allow-overlap")||y.layout.get("icon-allow-overlap")||y.layout.get("text-ignore-placement")||y.layout.get("icon-ignore-placement"),w=Q&&z,A=this._inProgressLayer=this._inProgressLayer||new Vp(y),H=l.av(U.source,U.scope);if(A.continuePlacement(B||w?m[H]:d[H],this.placement,this._showCollisionBoxes,U,u))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(e){return this.placement.commit(e),this.placement}}let uo=512/l.ab/2;class Rp{constructor(e,a,d){this.tileID=e,this.bucketInstanceId=d,this.index=new l.by(a.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let m=e.canonical.x*l.ab,p=e.canonical.y*l.ab;for(let u=0;u<a.length;u++){let{key:U,crossTileID:Y,tileAnchorX:y,tileAnchorY:B}=a.get(u),C=Math.floor((m+y)*uo),k=Math.floor((p+B)*uo);this.index.add(C,k),this.keys.push(U),this.crossTileIDs.push(Y)}this.index.finish()}findMatches(e,a,d){let m=this.tileID.canonical.z<a.canonical.z?1:Math.pow(2,this.tileID.canonical.z-a.canonical.z),p=uo/Math.pow(2,a.canonical.z-this.tileID.canonical.z),u=a.canonical.x*l.ab,U=a.canonical.y*l.ab;for(let Y=0;Y<e.length;Y++){let y=e.get(Y);if(y.crossTileID)continue;let{key:B,tileAnchorX:C,tileAnchorY:k}=y,Q=Math.floor((u+C)*p),z=Math.floor((U+k)*p),w=this.index.range(Q-m,z-m,Q+m,z+m);for(let A of w){let H=this.crossTileIDs[A];if(this.keys[A]===B&&!d.has(H)){d.add(H),y.crossTileID=H;break}}}}}class Ko{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Hm{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(e){let a=Math.round((e-this.lng)/360);if(a!==0)for(let d in this.indexes){let m=this.indexes[d],p={};for(let u in m){let U=m[u];U.tileID=U.tileID.unwrapTo(U.tileID.wrap+a),p[U.tileID.key]=U}this.indexes[d]=p}this.lng=e}addBucket(e,a,d){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===a.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key])}for(let p=0;p<a.symbolInstances.length;p++)a.symbolInstances.get(p).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]=new Set);let m=this.usedCrossTileIDs[e.overscaledZ];for(let p in this.indexes){let u=this.indexes[p];if(Number(p)>e.overscaledZ)for(let U in u){let Y=u[U];Y.tileID.isChildOf(e)&&Y.findMatches(a.symbolInstances,e,m)}else{let U=u[e.scaledTo(Number(p)).key];U&&U.findMatches(a.symbolInstances,e,m)}}for(let p=0;p<a.symbolInstances.length;p++){let u=a.symbolInstances.get(p);u.crossTileID||(u.crossTileID=d.generate(),m.add(u.crossTileID))}return this.indexes[e.overscaledZ]===void 0&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new Rp(e,a.symbolInstances,a.bucketInstanceId),!0}removeBucketCrossTileIDs(e,a){for(let d of a.crossTileIDs)this.usedCrossTileIDs[e].delete(d)}removeStaleBuckets(e){let a=!1;for(let d in this.indexes){let m=this.indexes[d];for(let p in m)e[m[p].bucketInstanceId]||(this.removeBucketCrossTileIDs(d,m[p]),delete m[p],a=!0)}return a}}class rd{constructor(){this.layerIndexes={},this.crossTileIDs=new Ko,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(e,a,d,m){let p=this.layerIndexes[e.fqid];p===void 0&&(p=this.layerIndexes[e.fqid]=new Hm);let u=!1,U={};m.name!=="globe"&&p.handleWrapJump(d);for(let Y of a){let y=Y.getBucket(e);y&&e.fqid===y.layerIds[0]&&(y.bucketInstanceId||(y.bucketInstanceId=++this.maxBucketInstanceId),p.addBucket(Y.tileID,y,this.crossTileIDs)&&(u=!0),U[y.bucketInstanceId]=!0)}return p.removeStaleBuckets(U)&&(u=!0),u}pruneUnusedLayers(e){let a={};e.forEach(d=>{a[d]=!0});for(let d in this.layerIndexes)a[d]||delete this.layerIndexes[d]}}let Zn=771;class ai{constructor(e,a,d,m){this.blendFunction=e,this.blendColor=a,this.mask=d,this.blendEquation=m}}ai.Replace=[1,0,1,0],ai.disabled=new ai(ai.Replace,l.bz.transparent,[!1,!1,!1,!1]),ai.unblended=new ai(ai.Replace,l.bz.transparent,[!0,!0,!0,!0]),ai.alphaBlended=new ai([1,Zn,1,Zn],l.bz.transparent,[!0,!0,!0,!0]),ai.alphaBlendedNonPremultiplied=new ai([770,Zn,770,Zn],l.bz.transparent,[!0,!0,!0,!0]),ai.multiply=new ai([774,0,774,0],l.bz.transparent,[!0,!0,!0,!0]);class Ne{constructor(e,a,d){this.func=e,this.mask=a,this.range=d}}Ne.ReadOnly=!1,Ne.ReadWrite=!0,Ne.disabled=new Ne(519,Ne.ReadOnly,[0,1]);let zc=7680;class Le{constructor(e,a,d,m,p,u){this.test=e,this.ref=a,this.mask=d,this.fail=m,this.depthFail=p,this.pass=u}}Le.disabled=new Le({func:519,mask:0},0,0,zc,zc,zc);let wc=1029,tr=2305;class Te{constructor(e,a,d){this.enable=e,this.mode=a,this.frontFace=d}}function Ac(r,e){let a=l.bC(r,3);l.a6.mat4.fromQuat(r,e),l.bE(r,3,a)}function dd(r,e){let a=l.a6.quat.identity([]);return l.a6.quat.rotateZ(a,a,-e),l.a6.quat.rotateX(a,a,-r),a}function Hc(r,e){let a=[r[0],r[1],0],d=[e[0],e[1],0];if(l.a6.vec3.length(a)>=1e-15){let u=l.a6.vec3.normalize([],a);l.a6.vec3.scale(d,u,l.a6.vec3.dot(d,u)),e[0]=d[0],e[1]=d[1]}let m=l.a6.vec3.cross([],e,r);if(l.a6.vec3.len(m)<1e-15)return null;let p=Math.atan2(-m[1],m[0]);return dd(Math.atan2(Math.sqrt(r[0]*r[0]+r[1]*r[1]),-r[2]),p)}Te.disabled=new Te(!1,wc,tr),Te.backCCW=new Te(!0,wc,tr),Te.backCW=new Te(!0,wc,2304),Te.frontCW=new Te(!0,1028,2304),Te.frontCCW=new Te(!0,1028,tr);class Ol{constructor(e,a){this.position=e,this.orientation=a}get position(){return this._position}set position(e){if(e){let a=e instanceof l.a5?e:new l.a5(e[0],e[1],e[2]);this._renderWorldCopies&&(a.x=l.bA(a.x,0,1)),this._position=a}else this._position=null}lookAtPoint(e,a){if(this.orientation=null,!this.position)return;let d=this.position,m=this._elevation?this._elevation.getAtPointOrZero(l.a5.fromLngLat(e)):0,p=l.a5.fromLngLat(e,m),u=[p.x-d.x,p.y-d.y,p.z-d.z];a||(a=[0,0,1]),a[2]=Math.abs(a[2]),this.orientation=Hc(u,a)}setPitchBearing(e,a){this.orientation=dd(l.bB(e),l.bB(-a))}}class Zo{constructor(e,a){this._transform=l.a6.mat4.identity([]),this.orientation=a,this.position=e}get mercatorPosition(){let e=this.position;return new l.a5(e[0],e[1],e[2])}get position(){let e=l.bC(this._transform,3);return[e[0],e[1],e[2]]}set position(e){var a;e&&l.bE(this._transform,3,[(a=e)[0],a[1],a[2],1])}get orientation(){return this._orientation}set orientation(e){this._orientation=e||l.a6.quat.identity([]),e&&Ac(this._transform,this._orientation)}getPitchBearing(){let e=this.forward(),a=this.right();return{bearing:Math.atan2(-a[1],a[0]),pitch:Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2])}}setPitchBearing(e,a){this._orientation=dd(e,a),Ac(this._transform,this._orientation)}forward(){let e=l.bC(this._transform,2);return[-e[0],-e[1],-e[2]]}up(){let e=l.bC(this._transform,1);return[-e[0],-e[1],-e[2]]}right(){let e=l.bC(this._transform,0);return[e[0],e[1],e[2]]}getCameraToWorld(e,a){let d=new Float64Array(16);return l.a6.mat4.invert(d,this.getWorldToCamera(e,a)),d}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(e,a,d){let m=this.position;l.a6.vec3.scale(m,m,-e);let p=new Float64Array(16);return l.a6.mat4.fromScaling(p,[d,d,d]),l.a6.mat4.translate(p,p,m),p[10]*=a,p}getWorldToCamera(e,a){let d=new Float64Array(16),m=new Float64Array(4),p=this.position;return l.a6.quat.conjugate(m,this._orientation),l.a6.vec3.scale(p,p,-e),l.a6.mat4.fromQuat(d,m),l.a6.mat4.translate(d,d,p),d[1]*=-1,d[5]*=-1,d[9]*=-1,d[13]*=-1,d[8]*=a,d[9]*=a,d[10]*=a,d[11]*=a,d}getCameraToClipPerspective(e,a,d,m){let p=new Float64Array(16);return l.a6.mat4.perspective(p,e,a,d,m),p}getCameraToClipOrthographic(e,a,d,m,p,u){let U=new Float64Array(16);return l.a6.mat4.ortho(U,e,a,d,m,p,u),U}getDistanceToElevation(e,a=!1){let d=e===0?0:l.bD(e,a?l.aM(this.position[1]):this.position[1]),m=this.forward();return(d-this.position[2])/m[2]}clone(){return new Zo([...this.position],[...this.orientation])}}let Ba={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class cd{constructor(e=0,a=0,d=0,m=0){if(isNaN(e)||e<0||isNaN(a)||a<0||isNaN(d)||d<0||isNaN(m)||m<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=a,this.left=d,this.right=m}interpolate(e,a,d){return a.top!=null&&e.top!=null&&(this.top=l.aa(e.top,a.top,d)),a.bottom!=null&&e.bottom!=null&&(this.bottom=l.aa(e.bottom,a.bottom,d)),a.left!=null&&e.left!=null&&(this.left=l.aa(e.left,a.left,d)),a.right!=null&&e.right!=null&&(this.right=l.aa(e.right,a.right,d)),this}getCenter(e,a){let d=l.ap((this.left+e-this.right)/2,0,e),m=l.ap((this.top+a-this.bottom)/2,0,a);return new l.P(d,m)}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right}clone(){return new cd(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}let qo=(r,e,a)=>(1-a)*r+a*e,$o=r=>r*r*r*r*r;class bd{constructor(e,a,d,m,p,u,U){this.tileSize=512,this._renderWorldCopies=p===void 0||p,this._minZoom=e||0,this._maxZoom=a||22,this._minPitch=d??0,this._maxPitch=m??60,this.setProjection(u),this.setMaxBounds(U),this.width=0,this.height=0,this._center=new l.bK(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new cd,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Zo,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){let e=new bd(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return e._elevation=this._elevation,e._centerAltitude=this._centerAltitude,e._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,e.tileSize=this.tileSize,e.mercatorFromTransition=this.mercatorFromTransition,e.width=this.width,e.height=this.height,e.cameraElevationReference=this.cameraElevationReference,e._center=this._center,e._setZoom(this.zoom),e._seaLevelZoom=this._seaLevelZoom,e.angle=this.angle,e._fov=this._fov,e._pitch=this._pitch,e._nearZ=this._nearZ,e._farZ=this._farZ,e._averageElevation=this._averageElevation,e._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,e._unmodified=this._unmodified,e._edgeInsets=this._edgeInsets.clone(),e._camera=this._camera.clone(),e._calcMatrices(),e.freezeTileCoverage=this.freezeTileCoverage,e.frustumCorners=this.frustumCorners,e}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(e){this._elevation!==e&&(this._elevation=e,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(e,a=!1){let d=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||d)&&this._updateCameraOnTerrain(),(e||d)&&this._constrainCamera(a),this._calcMatrices()}getProjection(){return l.ar(this.projection,["name","center","parallels"])}setProjection(e){this.projectionOptions=e||{name:"mercator"};let a=this.projection?this.getProjection():void 0;this.projection=l.bL(this.projectionOptions);let d=this.getProjection(),m=!l.bh(a,d);return m&&this._calcMatrices(),this.mercatorFromTransition=!1,m}setOrthographicProjectionAtLowPitch(e){return this._orthographicProjectionAtLowPitch!==e&&(this._orthographicProjectionAtLowPitch=e,this._calcMatrices(),!0)}setMercatorFromTransition(){let e=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=l.bL({name:"mercator"});let a=e!==this.projection.name;return a&&this._calcMatrices(),a}get minZoom(){return this._minZoom}set minZoom(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e))}get maxZoom(){return this._maxZoom}set maxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e))}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e))}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(e){e===void 0?e=!0:e===null&&(e=!1),this._renderWorldCopies=e}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let e=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get cameraWorldSize(){let e=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return l.bD(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new l.P(this.width,this.height)}get bearing(){return l.bA(this.rotation,-180,180)}set bearing(e){this.rotation=e}get rotation(){return-this.angle/Math.PI*180}set rotation(e){let a=-e*Math.PI/180;this.angle!==a&&(this._unmodified=!1,this.angle=a,this._calcMatrices(),this.rotationMatrix=l.a6.mat2.create(),l.a6.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(e){let a=l.ap(e,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==a&&(this._unmodified=!1,this._pitch=a,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){let e=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/e)}set fov(e){e=Math.max(.01,Math.min(60,e)),this._fov!==e&&(this._unmodified=!1,this._fov=l.bB(e),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(e){this._averageElevation=e,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(e){let a=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==a&&(this._unmodified=!1,this._setZoom(a),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(e){this._zoom=e,this.scale=this.zoomScale(e),this.tileZoom=Math.floor(e),this.zoomFraction=e-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(e){this._tileCoverLift!==e&&(this._tileCoverLift=e)}_updateCameraOnTerrain(){let e=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,a=this.elevation&&e===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||e===Number.NEGATIVE_INFINITY&&(!a||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let d=this._elevation;a||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&d.exaggeration()&&this._centerAltitudeValidForExaggeration!==d.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*d.exaggeration(),this._centerAltitudeValidForExaggeration=d.exaggeration()):(this._centerAltitude=e||0,this._centerAltitudeValidForExaggeration=d.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;let e=this._elevation,a=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],d=this.horizonLineFromTop(),m=0,p=0;for(let u=0;u<a.length;u++){let U=new l.P(a[u][0]*this.width,d+a[u][1]*(this.height-d)),Y=e.pointCoordinate(U);if(!Y)continue;let y=1/Math.hypot(Y[0]-this._camera.position[0],Y[1]-this._camera.position[1]);m+=Y[3]*y,p+=y}return p===0?NaN:m/p}get center(){return this._center}set center(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;let e=this._seaLevelZoom,a=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),d=this.pixelsPerMeter/this.worldSize*a,m=this._mercatorZfromZoom(e),p=this._mercatorZfromZoom(this._maxZoom),u=Math.max(m-d,p);this._setZoom(this._zoomFromMercatorZ(u))}get padding(){return this._edgeInsets.toJSON()}set padding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices())}computeZoomRelativeTo(e){let a=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,e.toAltitude())),d;d=e.z<this._camera.position[2]?[a.x,a.y,a.z]:[e.x,e.y,e.z];let m=l.a6.vec3.length(l.a6.vec3.sub([],this._camera.position,d));return l.ap(this._zoomFromMercatorZ(m),this._minZoom,this._maxZoom)}setFreeCameraOptions(e){if(!this.height||!e.position&&!e.orientation)return;this._updateCameraState();let a=!1;if(e.orientation&&!l.a6.quat.exactEquals(e.orientation,this._camera.orientation)&&(a=this._setCameraOrientation(e.orientation)),e.position){let d=[e.position.x,e.position.y,e.position.z];l.a6.vec3.exactEquals(d,this._camera.position)||(this._setCameraPosition(d),a=!0)}a&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let e=this._camera.position,a=new Ol;return a.position=new l.a5(e[0],e[1],e[2]),a.orientation=this._camera.orientation,a._elevation=this.elevation,a._renderWorldCopies=this.renderWorldCopies,a}_setCameraOrientation(e){if(!l.a6.quat.length(e))return!1;l.a6.quat.normalize(e,e);let a=l.a6.vec3.transformQuat([],[0,0,-1],e),d=l.a6.vec3.transformQuat([],[0,-1,0],e);if(d[2]<0)return!1;let m=Hc(a,d);return!!m&&(this._camera.orientation=m,!0)}_setCameraPosition(e){let a=this.zoomScale(this.minZoom)*this.tileSize,d=this.zoomScale(this.maxZoom)*this.tileSize,m=this.cameraToCenterDistance;e[2]=l.ap(e[2],m/d,m/a),this._camera.position=e}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(e){return this._edgeInsets.equals(e)}interpolatePadding(e,a,d){this._unmodified=!1,this._edgeInsets.interpolate(e,a,d),this._constrain(),this._calcMatrices()}coveringZoomLevel(e){let a=(e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize));return Math.max(0,a)}getVisibleUnwrappedCoordinates(e){let a=[new l.bM(0,e)];if(this.renderWorldCopies){let d=this.pointCoordinate(new l.P(0,0)),m=this.pointCoordinate(new l.P(this.width,0)),p=this.pointCoordinate(new l.P(this.width,this.height)),u=this.pointCoordinate(new l.P(0,this.height)),U=Math.floor(Math.min(d.x,m.x,p.x,u.x)),Y=Math.floor(Math.max(d.x,m.x,p.x,u.x)),y=1;for(let B=U-y;B<=Y+y;B++)B!==0&&a.push(new l.bM(B,e))}return a}isLODDisabled(e){return(!e||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(e,a,d){let m=[],p=d!==void 0,u=!p;if(u&&this.zoom<a||p&&d[0]===0&&d[1]===0)return m;let U=new Set,Y=(B,C,k,Q,z)=>{let w=l.c1(C,B,k,Q,z);U.has(w)||(m.push(new l.aA(B,C,k,Q,z)),U.add(w))};for(let B=0;B<e.length;B++){let C=e[B];if(u&&C.canonical.z!==a)continue;let k=C.canonical,Q=C.overscaledZ,z=C.wrap,w=1<<k.z,A=k.x+1<w,H=k.x>0,$=k.y+1<w,et=k.y>0,K=C.wrap-(H?0:1),nt=C.wrap+(A?0:1),at=H?k.x-1:w-1,ct=A?k.x+1:0;if(p)d[0]<0?(Y(Q,nt,k.z,ct,k.y),d[1]<0&&$&&(Y(Q,z,k.z,k.x,k.y+1),Y(Q,nt,k.z,ct,k.y+1)),d[1]>0&&et&&(Y(Q,z,k.z,k.x,k.y-1),Y(Q,nt,k.z,ct,k.y-1))):d[0]>0?(Y(Q,K,k.z,at,k.y),d[1]<0&&$&&(Y(Q,z,k.z,k.x,k.y+1),Y(Q,K,k.z,at,k.y+1)),d[1]>0&&et&&(Y(Q,z,k.z,k.x,k.y-1),Y(Q,K,k.z,at,k.y-1))):d[1]<0&&$?Y(Q,z,k.z,k.x,k.y+1):et&&Y(Q,z,k.z,k.x,k.y-1);else{let rt=C.visibleQuadrants;1&rt&&(Y(Q,K,k.z,at,k.y),et&&(Y(Q,z,k.z,k.x,k.y-1),Y(Q,K,k.z,at,k.y-1))),2&rt&&(Y(Q,nt,k.z,ct,k.y),et&&(Y(Q,z,k.z,k.x,k.y-1),Y(Q,nt,k.z,ct,k.y-1))),4&rt&&(Y(Q,K,k.z,at,k.y),$&&(Y(Q,z,k.z,k.x,k.y+1),Y(Q,K,k.z,at,k.y+1))),8&rt&&(Y(Q,nt,k.z,ct,k.y),$&&(Y(Q,z,k.z,k.x,k.y+1),Y(Q,nt,k.z,ct,k.y+1)))}}let y=[];for(let B of m)m.some(C=>B.isChildOf(C))||y.push(B);if(m=y.filter(B=>!e.some(C=>!!(B.overscaledZ<a&&C.isChildOf(B))||B.equals(C)||B.isChildOf(C))),u){let B=1<<a,C=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),k=[B*C.x,B*C.y],Q=4,z=Q*Q;m=m.filter(w=>{let A=w.canonical.x+.5-k[0],H=w.canonical.y+.5-k[1];return A*A+H*H<z})}return m}coveringTiles(e){let a=this.coveringZoomLevel(e),d=a,m=this.elevation&&this.elevation.exaggeration(),p=m&&!e.isTerrainDEM,u=this.projection.name==="mercator";if(e.minzoom!==void 0&&a<e.minzoom)return[];e.maxzoom!==void 0&&a>e.maxzoom&&(a=e.maxzoom);let U=this.locationCoordinate(this.center),Y=this.center.lat,y=1<<a,B=[y*U.x,y*U.y,0],C=this.projection.name==="globe",k=!C,Q=l.bN.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,a,k),z=C?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),w=y*l.bD(1,this.center.lat),A=this._camera.position[2]/l.bD(1,this.center.lat),H=[y*z.x,y*z.y,A*(k?1:w)],$=C||m,et=this.cameraToCenterDistance/e.tileSize*(e.roundZoom?1:.502),K=this.isLODDisabled(!0)?a:0,nt;if(this._elevation&&e.isTerrainDEM)nt=1e4*this._elevation.exaggeration();else if(this._elevation){let Yt=this._elevation.getMinMaxForVisibleTiles();nt=Yt?Yt.max:this._centerAltitude}else nt=this._centerAltitude;let at=e.isTerrainDEM?-nt:this._elevation?this._elevation.getMinElevationBelowMSL():0,ct=this.projection.isReprojectedInTileSpace?l.bO(this):1,rt=Yt=>{let vt=new l.a5(Yt.x+25e-6,Yt.y,Yt.z),_t=new l.a5(Yt.x,Yt.y+25e-6,Yt.z),qt=Yt.toLngLat(),zt=vt.toLngLat(),Ht=_t.toLngLat(),Ue=this.locationCoordinate(qt),ie=this.locationCoordinate(zt),be=this.locationCoordinate(Ht),Me=Math.hypot(ie.x-Ue.x,ie.y-Ue.y),ge=Math.hypot(be.x-Ue.x,be.y-Ue.y);return Math.sqrt(Me*ge)*ct/25e-6},bt=Yt=>{let Lt=nt,vt=at;return{aabb:l.bR(this,y,0,0,0,Yt,vt,Lt,this.projection),zoom:0,x:0,y:0,minZ:vt,maxZ:Lt,wrap:Yt,fullyVisible:!1}},gt=[],Wt=[],ht=a,Nt=e.reparseOverscaled?d:a,St=(A-this._centerAltitude)*w,wt=Yt=>{if(!this._elevation||!Yt.tileID||!u)return;let Lt=this._elevation.getMinMaxForTile(Yt.tileID),vt=Yt.aabb;Lt?(vt.min[2]=Lt.min,vt.max[2]=Lt.max,vt.center[2]=(vt.min[2]+vt.max[2])/2):(Yt.shouldSplit=Ot(Yt),Yt.shouldSplit||(vt.min[2]=vt.max[2]=vt.center[2]=this._centerAltitude))},kt=(Yt,Lt)=>{if(.707*Lt<Yt)return 1;let vt=Lt/Yt;return vt/(1.4144271570014144+(Math.pow(1.1,vt-1.4144271570014144+1)-1)/(1.1-1)-1)},Ot=Yt=>{if(Yt.zoom<K)return!0;if(Yt.zoom===ht)return!1;if(Yt.shouldSplit!=null)return Yt.shouldSplit;let Lt=Yt.aabb.distanceX(H),vt=Yt.aabb.distanceY(H),_t=St,qt=1;if(C){_t=Yt.aabb.distanceZ(H);let ge=Math.pow(2,Yt.zoom),Ye=l.aM((Yt.y+1)/ge),qe=l.aM(Yt.y/ge),De=Math.min(Math.max(Y,Ye),qe),Ui=l.c5(De)/l.c5(Y);if(qt=De===Y?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Ui/this._mercatorScaleRatio),this.zoom<=l.c2&&Yt.zoom===ht-1&&Ui>=.9)return!0}else if(p&&(_t=Yt.aabb.distanceZ(H)*w),this.projection.isReprojectedInTileSpace&&d<=5){let ge=Math.pow(2,Yt.zoom),Ye=rt(new l.a5((Yt.x+.5)/ge,(Yt.y+.5)/ge));qt=Ye>.85?1:Ye}if(!u){let ge=Math.sqrt(Lt*Lt+vt*vt+_t*_t),Ye=(1<<ht-Yt.zoom)*et*qt;return Ye*=kt(Math.max(_t,St),ge),ge<Ye}let zt=Number.MAX_VALUE,Ht=0,Ue=Yt.aabb.getCorners(),ie=[];for(let ge of Ue){l.a6.vec3.sub(ie,ge,H),C||(p?ie[2]*=w:ie[2]=St);let Ye=l.a6.vec3.dot(ie,this._camera.forward());Ye<zt&&(zt=Ye,Ht=Math.abs(ie[2]))}let be=(1<<ht-Yt.zoom)*et*qt;if(be*=kt(Math.max(Ht,St),zt),zt<be)return!0;let Me=Yt.aabb.closestPoint(B);return Me[0]===B[0]&&Me[1]===B[1]};if(this.renderWorldCopies)for(let Yt=1;Yt<=3;Yt++)gt.push(bt(-Yt)),gt.push(bt(Yt));for(gt.push(bt(0));gt.length>0;){let Yt=gt.pop(),Lt=Yt.x,vt=Yt.y,_t=Yt.fullyVisible,qt=()=>this.projection.name==="globe"&&(Yt.y===0||Yt.y===(1<<Yt.zoom)-1);if(!_t){let zt=$?Yt.aabb.intersects(Q):Yt.aabb.intersectsFlat(Q);if(zt===0&&qt()){let Ht=new l.bP(Yt.zoom,Lt,vt);zt=l.bQ(this,y,Ht,!0).intersects(Q)}if(zt===0)continue;_t=zt===2}if(Yt.zoom!==ht&&Ot(Yt))for(let zt=0;zt<4;zt++){let Ht=(Lt<<1)+zt%2,Ue=(vt<<1)+(zt>>1),ie={aabb:u?Yt.aabb.quadrant(zt):l.bR(this,y,Yt.zoom+1,Ht,Ue,Yt.wrap,Yt.minZ,Yt.maxZ,this.projection),zoom:Yt.zoom+1,x:Ht,y:Ue,wrap:Yt.wrap,fullyVisible:_t,tileID:void 0,shouldSplit:void 0,minZ:Yt.minZ,maxZ:Yt.maxZ};p&&!C&&(ie.tileID=new l.aA(Yt.zoom+1===ht?Nt:Yt.zoom+1,Yt.wrap,Yt.zoom+1,Ht,Ue),wt(ie)),gt.push(ie)}else{let zt=Yt.zoom===ht?Nt:Yt.zoom;if(e.minzoom&&e.minzoom>zt)continue;let Ht=0;if(!_t){let Me=$?Yt.aabb.intersectsPrecise(Q):Yt.aabb.intersectsPreciseFlat(Q);if(Me===0&&qt()){let ge=new l.bP(Yt.zoom,Lt,vt);Me=l.bQ(this,y,ge,!0).intersectsPrecise(Q)}if(Me===0)continue;if(e.calculateQuadrantVisibility)if(Q.containsPoint(Yt.aabb.center))Ht=15;else for(let ge=0;ge<4;ge++)Yt.aabb.quadrant(ge).intersects(Q)!==0&&(Ht|=1<<ge)}let Ue=B[0]-(.5+Lt+(Yt.wrap<<Yt.zoom))*(1<<a-Yt.zoom),ie=B[1]-.5-vt,be=Yt.tileID?Yt.tileID:new l.aA(zt,Yt.wrap,Yt.zoom,Lt,vt);e.calculateQuadrantVisibility&&(be.visibleQuadrants=Ht),Wt.push({tileID:be,distanceSq:Ue*Ue+ie*ie})}}if(this.fogCullDistSq){let Yt=this.fogCullDistSq,Lt=this.horizonLineFromTop();Wt=Wt.filter(vt=>{let _t=[0,0,0,1],qt=[l.ab,l.ab,0,1],zt=this.calculateFogTileMatrix(vt.tileID.toUnwrapped());l.a6.vec4.transformMat4(_t,_t,zt),l.a6.vec4.transformMat4(qt,qt,zt);let Ht=l.a6.vec4.min([],_t,qt),Ue=l.a6.vec4.max([],_t,qt),ie=l.bS(Ht,Ue);if(ie===0)return!0;let be=!1,Me=this._elevation;if(Me&&ie>Yt&&Lt!==0){let ge=this.calculateProjMatrix(vt.tileID.toUnwrapped()),Ye;e.isTerrainDEM||(Ye=Me.getMinMaxForTile(vt.tileID)),Ye||(Ye={min:at,max:nt});let qe=l.c3(this.rotation),De=[qe[0]*l.ab,qe[1]*l.ab,Ye.max];l.a6.vec3.transformMat4(De,De,ge),be=(1-De[1])*this.height*.5<Lt}return ie<Yt||be})}return Wt.sort((Yt,Lt)=>Yt.distanceSq-Lt.distanceSq).map(Yt=>Yt.tileID)}resize(e,a){this.width=e,this.height=a,this.pixelsToGLUnits=[2/e,-2/a],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(e){return Math.pow(2,e)}scaleZoom(e){return Math.log(e)/Math.LN2}project(e){let a=l.ap(e.lat,-l.bT,l.bT),d=this.projection.project(e.lng,a);return new l.P(d.x*this.worldSize,d.y*this.worldSize)}unproject(e){return this.projection.unproject(e.x/this.worldSize,e.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/l.bD(1,this.center.lat)/this.worldSize}setLocationAtPoint(e,a){let d,m,p=this.centerPoint;if(this.projection.name==="globe"){let U=this.worldSize;d=(a.x-p.x)/U,m=(a.y-p.y)/U}else{let U=this.pointCoordinate(a),Y=this.pointCoordinate(p);d=U.x-Y.x,m=U.y-Y.y}let u=this.locationCoordinate(e);this.setLocation(new l.a5(u.x-d,u.y-m))}setLocation(e){this.center=this.coordinateLocation(e),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(e){return this.projection.locationPoint(this,e)}locationPoint3D(e){return this.projection.locationPoint(this,e,!0)}pointLocation(e){return this.coordinateLocation(this.pointCoordinate(e))}pointLocation3D(e){return this.coordinateLocation(this.pointCoordinate3D(e))}locationCoordinate(e,a){let d=a?l.bD(a,e.lat):void 0,m=this.projection.project(e.lng,e.lat);return new l.a5(m.x,m.y,d)}coordinateLocation(e){return this.projection.unproject(e.x,e.y)}pointRayIntersection(e,a){let d=a??this._centerAltitude,m=[e.x,e.y,0,1],p=[e.x,e.y,1,1];l.a6.vec4.transformMat4(m,m,this.pixelMatrixInverse),l.a6.vec4.transformMat4(p,p,this.pixelMatrixInverse);let u=p[3];l.a6.vec4.scale(m,m,1/m[3]),l.a6.vec4.scale(p,p,1/u);let U=m[2],Y=p[2];return{p0:m,p1:p,t:U===Y?0:(d-U)/(Y-U)}}screenPointToMercatorRay(e){let a=[e.x,e.y,0,1],d=[e.x,e.y,1,1];return l.a6.vec4.transformMat4(a,a,this.pixelMatrixInverse),l.a6.vec4.transformMat4(d,d,this.pixelMatrixInverse),l.a6.vec4.scale(a,a,1/a[3]),l.a6.vec4.scale(d,d,1/d[3]),a[2]=l.bD(a[2],this._center.lat)*this.worldSize,d[2]=l.bD(d[2],this._center.lat)*this.worldSize,l.a6.vec4.scale(a,a,1/this.worldSize),l.a6.vec4.scale(d,d,1/this.worldSize),new l.aj([a[0],a[1],a[2]],l.a6.vec3.normalize([],l.a6.vec3.sub([],d,a)))}rayIntersectionCoordinate(e){let{p0:a,p1:d,t:m}=e,p=l.bD(a[2],this._center.lat),u=l.bD(d[2],this._center.lat);return new l.a5(l.aa(a[0],d[0],m)/this.worldSize,l.aa(a[1],d[1],m)/this.worldSize,l.aa(p,u,m))}pointCoordinate(e,a=this._centerAltitude){return this.projection.pointCoordinate(this,e.x,e.y,a)}pointCoordinate3D(e){if(!this.elevation)return this.pointCoordinate(e);let a=this.projection.pointCoordinate3D(this,e.x,e.y);if(a)return new l.a5(a[0],a[1],a[2]);let d=0,m=this.horizonLineFromTop();if(e.y>m)return this.pointCoordinate(e);let p=.02*m,u=e.clone();for(let U=0;U<10&&m-d>p;U++){u.y=l.aa(d,m,.66);let Y=this.projection.pointCoordinate3D(this,u.x,u.y);Y?(m=u.y,a=Y):d=u.y}return a?new l.a5(a[0],a[1],a[2]):this.pointCoordinate(e)}isPointAboveHorizon(e){return this.projection.isPointAboveHorizon(this,e)}isPointOnSurface(e){if(e.y<0||e.y>this.height||e.x<0||e.x>this.width)return!1;if(this.elevation||this.zoom>=l.bU)return!this.isPointAboveHorizon(e);let a=this.pointCoordinate(e);return a.y>=0&&a.y<=1}_coordinatePoint(e,a){let d=a&&this.elevation?this.elevation.getAtPointOrZero(e,this._centerAltitude):this._centerAltitude,m=[e.x*this.worldSize,e.y*this.worldSize,d+e.toAltitude(),1];return l.a6.vec4.transformMat4(m,m,this.pixelMatrix),m[3]>0?new l.P(m[0]/m[3],m[1]/m[3]):new l.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:e,left:a}=this._edgeInsets,d=this.height-this._edgeInsets.bottom,m=this.width-this._edgeInsets.right,p=this.pointLocation3D(new l.P(a,e)),u=this.pointLocation3D(new l.P(m,e)),U=this.pointLocation3D(new l.P(m,d)),Y=this.pointLocation3D(new l.P(a,d)),y=Math.min(p.lng,u.lng,U.lng,Y.lng),B=Math.max(p.lng,u.lng,U.lng,Y.lng),C=Math.min(p.lat,u.lat,U.lat,Y.lat),k=Math.max(p.lat,u.lat,U.lat,Y.lat),Q=Math.pow(2,-this.zoom)/16*270,z=this.projection.name==="globe"?1:4,w=(A,H,$,et,K)=>{let nt=(A+$)/2,at=(H+et)/2,ct=new l.P(nt,at),{lng:rt,lat:bt}=this.pointLocation3D(ct),gt=Math.max(0,y-rt,C-bt,rt-B,bt-k);y=Math.min(y,rt),B=Math.max(B,rt),C=Math.min(C,bt),k=Math.max(k,bt),(K<z||gt>Q)&&(w(A,H,nt,at,K+1),w(nt,at,$,et,K+1))};if(w(a,e,m,e,1),w(m,e,m,d,1),w(m,d,a,d,1),w(a,d,a,e,1),this.projection.name==="globe"){let[A,H]=l.bV(this);A?(k=90,B=180,y=-180):H&&(C=-90,B=180,y=-180)}return new l.as(new l.bK(y,C),new l.bK(B,k))}_getBoundsRectangular(e,a){let{top:d,left:m}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,u=this.width-this._edgeInsets.right,U=new l.P(m,d),Y=new l.P(u,d),y=new l.P(u,p),B=new l.P(m,p),C=this.pointCoordinate(U,e),k=this.pointCoordinate(Y,e),Q=this.pointCoordinate(y,a),z=this.pointCoordinate(B,a),w=(A,H)=>(H.y-A.y)/(H.x-A.x);return C.y>1&&k.y>=0?C=new l.a5((1-z.y)/w(z,C)+z.x,1):C.y<0&&k.y<=1&&(C=new l.a5(-z.y/w(z,C)+z.x,0)),k.y>1&&C.y>=0?k=new l.a5((1-Q.y)/w(Q,k)+Q.x,1):k.y<0&&C.y<=1&&(k=new l.a5(-Q.y/w(Q,k)+Q.x,0)),new l.as().extend(this.coordinateLocation(C)).extend(this.coordinateLocation(k)).extend(this.coordinateLocation(z)).extend(this.coordinateLocation(Q))}_getBoundsRectangularTerrain(){let e=this.elevation;if(!e.visibleDemTiles.length||e.isUsingMockSource())return this._getBoundsRectangular(0,0);let a=e.visibleDemTiles.reduce((d,m)=>{if(m.dem){let p=m.dem.tree;d.min=Math.min(d.min,p.minimums[0]),d.max=Math.max(d.max,p.maximums[0])}return d},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(a.min*e.exaggeration(),a.max*e.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(e=!0){let a=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,d=this.height/2-a*(1-this._horizonShift);return e?Math.max(0,d):d}getMaxBounds(){return this.maxBounds}setMaxBounds(e){this.maxBounds=e,this.minLat=-l.bT,this.maxLat=l.bT,this.minLng=-180,this.maxLng=180,e&&(this.minLat=e.getSouth(),this.maxLat=e.getNorth(),this.minLng=e.getWest(),this.maxLng=e.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=l.am(this.minLng)*this.tileSize,this.worldMaxX=l.am(this.maxLng)*this.tileSize,this.worldMinY=l.at(this.maxLat)*this.tileSize,this.worldMaxY=l.at(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(e,a){return this.projection.createTileMatrix(this,a,e)}calculateDistanceTileData(e){let a=e.key,d=this._distanceTileDataCache;if(d[a])return d[a];let m=e.canonical,p=1/this.height,u=this.cameraWorldSize,U=u/this.zoomScale(m.z),Y=(m.x+Math.pow(2,m.z)*e.wrap)*U,y=m.y*U,B=this.point;B.x*=u/this.worldSize,B.y*=u/this.worldSize;let C=this.angle,k=Math.sin(-C),Q=-Math.cos(-C);return d[a]={bearing:[k,Q],center:[(B.x-Y)*p,(B.y-y)*p],scale:U/l.ab*p},d[a]}calculateFogTileMatrix(e){let a=e.key,d=this._fogTileMatrixCache;if(d[a])return d[a];let m=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,e);return l.a6.mat4.multiply(m,this.worldToFogMatrix,m),d[a]=new Float32Array(m),d[a]}calculateProjMatrix(e,a=!1,d=!1){let m=e.key,p;if(p=d?this._expandedProjMatrixCache:a?this._alignedProjMatrixCache:this._projMatrixCache,p[m])return p[m];let u=this.calculatePosMatrix(e,this.worldSize),U;return U=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:d?this.expandedFarZProjMatrix:a?this.alignedProjMatrix:this.projMatrix,l.a6.mat4.multiply(u,U,u),p[m]=new Float32Array(u),p[m]}calculatePixelsToTileUnitsMatrix(e){let a=e.tileID.key,d=this._pixelsToTileUnitsCache;if(d[a])return d[a];let m=l.bW(e,this);return d[a]=m,d[a]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){let e=1/this.worldSize,a=l.a6.mat4.fromScaling([],[e,e,e]);return l.a6.mat4.multiply(a,a,this.globeMatrix),a}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;let e=this._elevation;this._updateCameraState();let a=l.bD(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(a),m=this._camera.forward(),p=l.bD(1,this._center.lat);d[2]/=p,m[2]/=p,l.a6.vec3.normalize(m,m);let u=e.raycast(d,m,e.exaggeration());if(u){let U=l.a6.vec3.scaleAndAdd([],d,m,u),Y=new l.a5(U[0],U[1],l.bD(U[2],l.aM(U[1]))),y=(Y.z+l.a6.vec3.length([Y.x-d[0],Y.y-d[1],Y.z-d[2]*p]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(y),this._centerAltitude=Y.toAltitude(),this._center=this.coordinateLocation(Y),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(e=!1){if(!this._elevation)return;let a=this._elevation,d=l.bD(1,this._center.lat)*this.worldSize,m=this._computeCameraPosition(d),p=a.getAtPointOrZero(new l.a5(...m)),u=this.pixelsPerMeter/this.worldSize*p,U=this._minimumHeightOverTerrain(),Y=m[2]-u;if(Y<=U)if(Y<0||e){let y=this.locationCoordinate(this._center,this._centerAltitude),B=[m[0],m[1],y.z-m[2]],C=l.a6.vec3.length(B);B[2]-=(U-Y)/this._pixelsPerMercatorPixel;let k=l.a6.vec3.length(B);if(k===0)return;l.a6.vec3.scale(B,B,C/k*this._pixelsPerMercatorPixel),this._camera.position=[m[0],m[1],y.z*this._pixelsPerMercatorPixel-B[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let e=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||e){let k=this.center;return k.lat=l.ap(k.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!e)&&(k.lng=l.ap(k.lng,this.minLng,this.maxLng)),this.center=k,void(this._constraining=!1)}let a=this._unmodified,{x:d,y:m}=this.point,p=0,u=d,U=m,Y=this.width/2,y=this.height/2,B=this.worldMinY*this.scale,C=this.worldMaxY*this.scale;if(m-y<B&&(U=B+y),m+y>C&&(U=C-y),C-B<this.height&&(p=Math.max(p,this.height/(C-B)),U=(C+B)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let k=this.worldMinX*this.scale,Q=this.worldMaxX*this.scale,z=this.worldSize/2-(k+Q)/2;u=(d+z+this.worldSize)%this.worldSize-z,u-Y<k&&(u=k+Y),u+Y>Q&&(u=Q-Y),Q-k<this.width&&(p=Math.max(p,this.width/(Q-k)),u=(Q+k)/2)}u===d&&U===m||(this.center=this.unproject(new l.P(u,U))),p&&(this.zoom+=this.scaleZoom(p)),this._constrainCamera(),this._unmodified=a,this._constraining=!1}_minZoomForBounds(){let e=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(e=Math.max(e,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),e}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;let e=this.centerOffset,a=this.projection.name==="globe",d=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=l.bD(1,this.center.lat)/l.bD(1,l.c4));let m=l.bX(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,m),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let p=this.projection.zAxisUnit==="meters"?d:1,u=this._camera.getWorldToCamera(this.worldSize,p),U,Y=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(Y[8]=2*-e.x/this.width,Y[9]=2*e.y/this.height,this.isOrthographic){let bt=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),gt=bt*this.aspect,Wt=-gt,ht=-bt;gt-=e.x,Wt-=e.x,bt+=e.y,ht+=e.y,U=this._camera.getCameraToClipOrthographic(Wt,gt,ht,bt,this._nearZ,this._farZ),((Nt,St,wt,kt)=>{for(let Ot=0;Ot<16;Ot++)Nt[Ot]=qo(St[Ot],wt[Ot],kt)})(U,U,Y,$o(this.pitch>=15?1:this.pitch/15))}else U=Y;let y=l.a6.mat4.mul([],Y,u),B=l.a6.mat4.mul([],U,u);if(this.projection.isReprojectedInTileSpace){let bt=this.locationCoordinate(this.center),gt=l.a6.mat4.identity([]);l.a6.mat4.translate(gt,gt,[bt.x*this.worldSize,bt.y*this.worldSize,0]),l.a6.mat4.multiply(gt,gt,l.bY(this)),l.a6.mat4.translate(gt,gt,[-bt.x*this.worldSize,-bt.y*this.worldSize,0]),l.a6.mat4.multiply(B,B,gt),l.a6.mat4.multiply(y,y,gt),this.inverseAdjustmentMatrix=l.bZ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=l.a6.mat4.scale([],B,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=B,this.invProjMatrix=l.a6.mat4.invert(new Float64Array(16),this.projMatrix),a){let bt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);bt[8]=2*-e.x/this.width,bt[9]=2*e.y/this.height,this.expandedFarZProjMatrix=l.a6.mat4.mul([],bt,u)}else this.expandedFarZProjMatrix=this.projMatrix;let C=l.a6.mat4.invert([],U);this.frustumCorners=l.b_.fromInvProjectionMatrix(C,this.horizonLineFromTop(),this.height),this.cameraFrustum=l.bN.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!a);let k=new Float32Array(16);l.a6.mat4.identity(k),l.a6.mat4.scale(k,k,[1,-1,1]),l.a6.mat4.rotateX(k,k,this._pitch),l.a6.mat4.rotateZ(k,k,this.angle);let Q=l.a6.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=l.a6.mat4.clone(Q);let z=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;Q[8]=2*-e.x/this.width,Q[9]=2*(e.y+z)/this.height,this.skyboxMatrix=l.a6.mat4.multiply(k,Q,k);let w=this.point,A=w.x,H=w.y,$=this.width%2/2,et=this.height%2/2,K=Math.cos(this.angle),nt=Math.sin(this.angle),at=A-Math.round(A)+K*$+nt*et,ct=H-Math.round(H)+K*et+nt*$,rt=new Float64Array(B);if(l.a6.mat4.translate(rt,rt,[at>.5?at-1:at,ct>.5?ct-1:ct,0]),this.alignedProjMatrix=rt,B=l.a6.mat4.create(),l.a6.mat4.scale(B,B,[this.width/2,-this.height/2,1]),l.a6.mat4.translate(B,B,[1,-1,0]),this.labelPlaneMatrix=B,B=l.a6.mat4.create(),l.a6.mat4.scale(B,B,[1,-1,1]),l.a6.mat4.translate(B,B,[-1,-1,0]),l.a6.mat4.scale(B,B,[2/this.width,2/this.height,1]),this.glCoordMatrix=B,this.pixelMatrix=l.a6.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,y),this._calcFogMatrices(),this._distanceTileDataCache={},B=l.a6.mat4.invert(new Float64Array(16),this.pixelMatrix),!B)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=B,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=l.b$(this);let bt=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=l.a6.vec3.transformMat4(bt,bt,u),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=B;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let e=this.cameraWorldSizeForFog,a=this.cameraPixelsPerMeter,d=this._camera.position,m=1/this.height/this._pixelsPerMercatorPixel,p=[e,e,a];l.a6.vec3.scale(p,p,m),l.a6.vec3.scale(d,d,-1),l.a6.vec3.multiply(d,d,p);let u=l.a6.mat4.create();l.a6.mat4.translate(u,u,d),l.a6.mat4.scale(u,u,p),this.mercatorFogMatrix=u,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(e,a,m)}_computeCameraPosition(e){let a=(e=e||this.pixelsPerMeter)/this.pixelsPerMeter,d=this._camera.forward(),m=this.point,p=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*a-e/this.worldSize*this._centerAltitude;return[m.x/this.worldSize-d[0]*p,m.y/this.worldSize-d[1]*p,e/this.worldSize*this._centerAltitude-d[2]*p]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(e){let a=this._maxCameraBoundsDistance()*Math.cos(this._pitch),d=this._camera.position[2],m=e[2],p=1;this.projection.wrap&&(this.center=this.center.wrap()),m>0&&(p=Math.min((a-d)/m,1)),this._camera.position=l.a6.vec3.scaleAndAdd([],this._camera.position,e,p),this._updateStateFromCamera()}_updateStateFromCamera(){let e=this._camera.position,a=this._camera.forward(),{pitch:d,bearing:m}=this._camera.getPitchBearing(),p=l.bD(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,u=this._mercatorZfromZoom(this._maxZoom)*Math.cos(l.bB(this._maxPitch)),U=Math.max((e[2]-p)/Math.cos(d),u),Y=this._zoomFromMercatorZ(U);l.a6.vec3.scaleAndAdd(e,e,a,U),this._pitch=l.ap(d,l.bB(this.minPitch),l.bB(this.maxPitch)),this.angle=l.bA(m,-Math.PI,Math.PI),this._setZoom(l.ap(Y,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new l.a5(e[0],e[1],e[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(e){return Math.pow(2,e)*this.tileSize}_mercatorZfromZoom(e){return this.cameraToCenterDistance/this._worldSizeFromZoom(e)}_minimumHeightOverTerrain(){let e=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(e)}_zoomFromMercatorZ(e){return this.scaleZoom(this.cameraToCenterDistance/(e*this.tileSize))}zoomFromMercatorZAdjusted(e){let a=0,d=l.bU,m=0,p=1/0;for(;d-a>1e-6&&d>a;){let u=a+.5*(d-a),U=this.tileSize*Math.pow(2,u),Y=this.getCameraToCenterDistance(this.projection,u,U),y=this.scaleZoom(Y/(e*this.tileSize)),B=Math.abs(u-y);B<p&&(p=B,m=u),u<y?a=u:d=u}return m}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(l.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(e,a){let d=Math.min(e.x,a.x),m=Math.max(e.x,a.x),p=Math.min(e.y,a.y),u=Math.max(e.y,a.y);if(p<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;let U=[new l.P(d,p),new l.P(m,u),new l.P(d,u),new l.P(m,p)],Y=this.renderWorldCopies?-3:0,y=this.renderWorldCopies?4:1;for(let B of U){let C=this.pointRayIntersection(B);if(C.t<0)return!0;let k=this.rayIntersectionCoordinate(C);if(k.x<Y||k.y<0||k.x>y||k.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+l.c0(this.fovAboveCenter)>88||this.anyCornerOffEdge(new l.P(0,0),new l.P(this.width,this.height))}zoomDeltaToMovement(e,a){let d=l.a6.vec3.length(l.a6.vec3.sub([],this._camera.position,e)),m=this._zoomFromMercatorZ(d)+a;return d-this._mercatorZfromZoom(m)}getCameraPoint(){if(this.projection.name==="globe"){let e=function([a,d,m],p){let u=[a,d,m,1];l.a6.vec4.transformMat4(u,u,p);let U=u[3]=Math.max(u[3],1e-6);return u[0]/=U,u[1]/=U,u[2]/=U,u}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new l.P(e[0],e[1])}{let e=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new l.P(0,e))}}getCameraToCenterDistance(e,a=this.zoom,d=this.worldSize){let m=l.bX(e,a,this.width,this.height,1024),p=e.pixelSpaceConversion(this.center.lat,d,m),u=.5/Math.tan(.5*this._fov)*this.height*p;return this.isOrthographic&&(u=qo(1,u,$o(this.pitch>=15?1:this.pitch/15))),u}getWorldToCameraMatrix(){let e=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&l.a6.mat4.multiply(e,e,this.globeMatrix),e}getFrustum(e){return l.bN.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,e,this.projection.zAxisUnit==="meters")}}let Xl=(r,e)=>{if(e>0&&r.terrain&&l.w("Cutoff is currently disabled on terrain"),e<=0||r.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let a=r.transform,d=Math.max(Math.abs(a._zoom-(r.minCutoffZoom-1)),1),m=a.isLODDisabled(!1)?l.a7(60,45,a.pitch):l.a7(30,15,a.pitch),p=a._farZ-a._nearZ,u=e*a.height,U=((1-(Y=m))*a.cameraToCenterDistance+Y*(a._farZ+u))*d;var Y;return{shouldRenderCutoff:m<1,uniformValues:{u_cutoff_params:[a._nearZ,a._farZ,(U-a._nearZ)/p,(U-u-a._nearZ)/p]}}},Ai={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class jc{constructor(e,a){this.aabb=e,this.lastCascade=a}}class ne{add(e,a){let d=this.receivers[e.key];d!==void 0?(d.aabb.min[0]=Math.min(d.aabb.min[0],a.min[0]),d.aabb.min[1]=Math.min(d.aabb.min[1],a.min[1]),d.aabb.min[2]=Math.min(d.aabb.min[2],a.min[2]),d.aabb.max[0]=Math.max(d.aabb.max[0],a.max[0]),d.aabb.max[1]=Math.max(d.aabb.max[1],a.max[1]),d.aabb.max[2]=Math.max(d.aabb.max[2],a.max[2])):this.receivers[e.key]=new jc(a,null)}clear(){this.receivers={}}get(e){return this.receivers[e.key]}computeRequiredCascades(e,a,d){let m=l.c9.fromPoints(e.points),p=0;for(let u in this.receivers){let U=this.receivers[u];if(!U||!m.intersectsAabb(U.aabb))continue;U.aabb.min=m.closestPoint(U.aabb.min),U.aabb.max=m.closestPoint(U.aabb.max);let Y=U.aabb.getCorners();for(let y=0;y<d.length;y++){let B=!0;for(let C of Y){let k=[C[0]*a,C[1]*a,C[2]];if(l.a6.vec3.transformMat4(k,k,d[y].matrix),k[0]<-1||k[0]>1||k[1]<-1||k[1]>1){B=!1;break}}if(U.lastCascade=y,p=Math.max(p,y),B)break}}return p+1}}class jm{constructor(e){this.painter=e,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new ne,this._depthMode=new Ne(e.context.gl.LEQUAL,Ne.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,e.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),e.tp.registerParameter(Ai,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),e.tp.registerParameter(Ai,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),e.tp.registerParameter(Ai,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),e.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(let e of this._cascades)e.texture.destroy(),e.framebuffer.destroy();this._cascades=[]}updateShadowParameters(e,a){let d=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!a||!a.properties)return;let m=a.properties.get("shadow-intensity");if(!a.shadowsEnabled()||m<=0||(this._shadowLayerCount=d.style.order.reduce((z,w)=>{let A=d.style._mergedLayers[w];return z+(A.hasShadowPass()&&!A.isHidden(e.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;let p=d.context,u=Ai.shadowMapResolution,U=Ai.shadowMapResolution;if(this._cascades.length===0||Ai.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let z=0;z<Ai.cascadeCount;++z){let w=d._shadowMapDebug,A=p.gl,H=p.createFramebuffer(u,U,w,"texture"),$=new l.T(p,{width:u,height:U,data:null},A.DEPTH_COMPONENT16);if(H.depthAttachment.set($.texture),w){let et=new l.T(p,{width:u,height:U,data:null},A.RGBA8);H.colorAttachment.set(et.texture)}this._cascades.push({framebuffer:H,texture:$,matrix:[],far:0,boundingSphereRadius:0,frustum:new l.bN,scale:0})}}this.shadowDirection=md(a);let Y=0;if(e.elevation){let z=e.elevation,w=[1e4,-1e4];z.visibleDemTiles.filter(A=>A.dem).forEach(A=>{let H=A.dem.tree;w[0]=Math.min(w[0],H.minimums[0]),w[1]=Math.max(w[1],H.maximums[0])}),w[0]!==1e4&&(Y=(w[1]-w[0])*z.exaggeration())}let y=1.5*e.cameraToCenterDistance,B=3*y,C=new Float64Array(16);for(let z=0;z<this._cascades.length;++z){let w=this._cascades[z],A=e.height/50,H=1;Ai.cascadeCount===1?H=B:z===0?H=y:(A=y,H=B);let[$,et]=pd(e,this.shadowDirection,A,H,Ai.shadowMapResolution,Y);w.scale=e.scale,w.matrix=$,w.boundingSphereRadius=et,l.a6.mat4.invert(C,w.matrix),w.frustum=l.bN.fromInvProjectionMatrix(C,1,0,!0),w.far=H}let k=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[k].far,this._cascades[k].far],this._uniformValues.u_shadow_intensity=m,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Ai.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Ai.shadowMapResolution,this._uniformValues.u_shadowmap_0=Ba.ShadowMap0,this._uniformValues.u_shadowmap_1=Ba.ShadowMap0+1,this._groundShadowTiles=d.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let Q=d.transform.elevation;for(let z of this._groundShadowTiles){let w={min:0,max:0};if(Q){let A=Q.getMinMaxForTile(z);A&&(w=A)}this.addShadowReceiver(z.toUnwrapped(),w.min,w.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(e){this._enabled=e}drawShadowPass(e,a){if(!this.enabled)return;let d=this.painter,m=d.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(d.transform.getFrustum(0),d.transform.worldSize,this._cascades),m.viewport.set([0,0,Ai.shadowMapResolution,Ai.shadowMapResolution]);for(let p=0;p<this._numCascadesToRender;++p){d.currentShadowCascade=p,m.bindFramebuffer.set(this._cascades[p].framebuffer.framebuffer),m.clear({color:l.bz.white,depth:1});for(let u of e.order){let U=e._mergedLayers[u];if(!U.hasShadowPass()||U.isHidden(d.transform.zoom))continue;let Y=e.getLayerSourceCache(U),y=Y?a[Y.id]:void 0;(U.type==="model"||y&&y.length)&&d.renderLayer(d,Y,U,y)}}d.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;let e=this.painter,a=e.style,d=e.context,m=a.directionalLight,p=a.ambientLight;if(!m||!p)return;let u=[],U=Xl(e,e.longestCutoffRange);U.shouldRenderCutoff&&u.push("RENDER_CUTOFF");let Y=hd(a,m,p),y=new Ne(d.gl.LEQUAL,Ne.ReadOnly,e.depthRangeFor3D);for(let B of this._groundShadowTiles){let C=B.toUnwrapped(),k=e.isTileAffectedByFog(B),Q=e.getOrCreateProgram("groundShadow",{defines:u,overrideFog:k});this.setupShadows(C,Q),e.uploadCommonUniforms(d,Q,C,null,U);let z={u_matrix:e.transform.calculateProjMatrix(C),u_ground_shadow_factor:Y};Q.draw(e,d.gl.TRIANGLES,y,Le.disabled,ai.multiply,Te.disabled,z,"ground_shadow",e.tileExtentBuffer,e.quadTriangleIndexBuffer,e.tileExtentSegments,{},e.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ai.unblended:ai.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(e){let a=this.painter.transform,d=a.calculatePosMatrix(e,a.worldSize);return l.a6.mat4.multiply(d,this._cascades[this.painter.currentShadowCascade].matrix,d),Float32Array.from(d)}calculateShadowPassMatrixFromMatrix(e){return l.a6.mat4.multiply(e,this._cascades[this.painter.currentShadowCascade].matrix,e),Float32Array.from(e)}setupShadows(e,a,d,m=0){if(!this.enabled)return;let p=this.painter.transform,u=this.painter.context,U=u.gl,Y=this._uniformValues,y=new Float64Array(16),B=p.calculatePosMatrix(e,p.worldSize);for(let C=0;C<this._cascades.length;C++)l.a6.mat4.multiply(y,this._cascades[C].matrix,B),Y[C===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(y),u.activeTexture.set(U.TEXTURE0+Ba.ShadowMap0+C),this._cascades[C].texture.bind(U.NEAREST,U.CLAMP_TO_EDGE);if(this.useNormalOffset=!!d,this.useNormalOffset){let C=l.c8(e.canonical),k=2/p.tileSize*l.ab/Ai.shadowMapResolution,Q=k*this._cascades[0].boundingSphereRadius,z=k*this._cascades[this._cascades.length-1].boundingSphereRadius,w=(d==="vector-tile"?1:3)/Math.pow(2,m-e.canonical.z-(1-p.zoom+Math.floor(p.zoom)));Y.u_shadow_normal_offset=[C,Q*w,z*w],Y.u_shadow_bias=[6e-5,.0012,.012]}else Y.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(u,Y)}setupShadowsFromMatrix(e,a,d=!1){if(!this.enabled)return;let m=this.painter.context,p=m.gl,u=this._uniformValues,U=new Float64Array(16);for(let Y=0;Y<Ai.cascadeCount;Y++)l.a6.mat4.multiply(U,this._cascades[Y].matrix,e),u[Y===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(U),m.activeTexture.set(p.TEXTURE0+Ba.ShadowMap0+Y),this._cascades[Y].texture.bind(p.NEAREST,p.CLAMP_TO_EDGE);if(this.useNormalOffset=d,d){let Y=Ai.normalOffset;u.u_shadow_normal_offset=[1,Y,Y],u.u_shadow_bias=[6e-5,.0012,.012]}else u.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(m,u)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(e,a,d,m){if(m[2]>=0)return{};let p=function(Y,y,B){let C=B/(1<<Y.canonical.z);return new l.c9([Y.canonical.x*C+Y.wrap*B,Y.canonical.y*C+Y.wrap*B,0],[(Y.canonical.x+1)*C+Y.wrap*B,(Y.canonical.y+1)*C+Y.wrap*B,y])}(e,a,d).getCorners(),u=a/-m[2];m[0]<0?(l.a6.vec3.add(p[0],p[0],[m[0]*u,0,0]),l.a6.vec3.add(p[3],p[3],[m[0]*u,0,0])):m[0]>0&&(l.a6.vec3.add(p[1],p[1],[m[0]*u,0,0]),l.a6.vec3.add(p[2],p[2],[m[0]*u,0,0])),m[1]<0?(l.a6.vec3.add(p[0],p[0],[0,m[1]*u,0]),l.a6.vec3.add(p[1],p[1],[0,m[1]*u,0])):m[1]>0&&(l.a6.vec3.add(p[2],p[2],[0,m[1]*u,0]),l.a6.vec3.add(p[3],p[3],[0,m[1]*u,0]));let U={};return U.vertices=p,U.planes=[ts(p[1],p[0],p[4]),ts(p[2],p[1],p[5]),ts(p[3],p[2],p[6]),ts(p[0],p[3],p[7])],U}addShadowReceiver(e,a,d){this._receivers.add(e,l.c9.fromTileIdAndHeight(e,a,d))}getMaxCascadeForTile(e){let a=this._receivers.get(e);return a&&a.lastCascade?a.lastCascade:0}}function ts(r,e,a){let d=l.a6.vec3.sub([],a,e),m=l.a6.vec3.sub([],r,e),p=l.a6.vec3.cross([],d,m),u=l.a6.vec3.length(p);return u===0?[0,0,1,0]:(l.a6.vec3.scale(p,p,1/u),[p[0],p[1],p[2],-l.a6.vec3.dot(p,e)])}function md(r){let e=r.properties.get("direction"),a=l.c7(e.x,e.y,e.z);a[2]=l.ap(a[2],0,75);let d=l.ca([a[0],a[1],a[2]]);return l.a6.vec3.fromValues(d.x,d.y,d.z)}function hd(r,e,a){let d=e.properties.get("color"),m=e.properties.get("intensity"),p=e.properties.get("direction"),u=[p.x,p.y,p.z],U=a.properties.get("color"),Y=a.properties.get("intensity"),y=Math.max(l.a6.vec3.dot([0,0,1],u),0),B=[0,0,0];l.a6.vec3.scale(B,U.toRenderColor(r.getLut(e.scope)).toArray01Linear().slice(0,3),Y);let C=[0,0,0];return l.a6.vec3.scale(C,d.toRenderColor(r.getLut(a.scope)).toArray01Linear().slice(0,3),y*m),l.cb([B[0]>0?B[0]/(B[0]+C[0]):0,B[1]>0?B[1]/(B[1]+C[1]):0,B[2]>0?B[2]/(B[2]+C[2]):0])}function pd(r,e,a,d,m,p){let u=r.zoom,U=r.scale,Y=r.worldSize,y=1/Y,B=r.aspect,C=Math.sqrt(1+B*B)*Math.tan(.5*r.fovX),k=C*C,Q=d-a,z=d+a,w,A;k>Q/z?(w=d,A=d*C):(w=.5*z*(1+k),A=.5*Math.sqrt(Q*Q+2*(d*d+a*a)*k+z*z*k*k));let H=r.projection.pixelsPerMeter(r.center.lat,Y),$=r._camera.getCameraToWorldMercator(),et=[0,0,-w*y];l.a6.vec3.transformMat4(et,et,$);let K=A*y,nt=r._edgeInsets;if(!(nt.left===0&&nt.top===0&&nt.right===0&&nt.bottom===0||nt.left===nt.right&&nt.top===nt.bottom)){let _t=r._camera.getWorldToCamera(r.worldSize,r.projection.zAxisUnit==="meters"?H:1),qt=r._camera.getCameraToClipPerspective(r._fov,r.width/r.height,a,d);qt[8]=2*-r.centerOffset.x/r.width,qt[9]=2*r.centerOffset.y/r.height;let zt=new Float64Array(16);l.a6.mat4.mul(zt,qt,_t);let Ht=new Float64Array(16);l.a6.mat4.invert(Ht,zt);let Ue=l.bN.fromInvProjectionMatrix(Ht,Y,u,!0);for(let ie of Ue.points){let be=((at=ie)[0]/=U,at[1]/=U,at[2]=l.bD(at[2],r._center.lat),at);K=Math.max(K,l.a6.vec3.len(l.a6.vec3.subtract([],et,be)))}}var at;K*=m/(m-1);let ct=Math.acos(e[2]),rt=Math.atan2(-e[0],-e[1]),bt=new Zo;bt.position=et,bt.setPitchBearing(ct,rt);let gt=bt.getWorldToCamera(Y,H),Wt=K*Y,ht=Math.min(r._mercatorZfromZoom(17)*Y*-2,-2*Wt),Nt=bt.getCameraToClipOrthographic(-Wt,Wt,-Wt,Wt,ht,(Wt+p*H)/e[2]),St=new Float64Array(16);l.a6.mat4.multiply(St,Nt,gt);let wt=l.a6.vec3.fromValues(Math.floor(1e6*et[0])/1e6*Y,Math.floor(1e6*et[1])/1e6*Y,0),kt=.5*m,Ot=[0,0,0];l.a6.vec3.transformMat4(Ot,wt,St),l.a6.vec3.scale(Ot,Ot,kt);let Yt=[Math.floor(Ot[0]),Math.floor(Ot[1]),Math.floor(Ot[2])],Lt=[0,0,0];l.a6.vec3.sub(Lt,Ot,Yt),l.a6.vec3.scale(Lt,Lt,-1/kt);let vt=new Float64Array(16);return l.a6.mat4.identity(vt),l.a6.mat4.translate(vt,vt,Lt),l.a6.mat4.multiply(St,vt,St),[St,Wt]}class yl extends l.E{constructor(e){super(),this.requestManager=e,this.models={"":{}},this.numModelsLoading={}}loadModel(e,a){return l.aG(this.requestManager.transformRequest(a,l.R.Model).url).then(d=>{if(!d)return;let m=l.aH(d),p=new l.aI(e,void 0,void 0,m);return p.computeBoundsAndApplyParent(),p}).catch(d=>{if(d&&d.status===404)return null;this.fire(new l.t(new Error(`Could not load model ${e} from ${a}: ${d.message}`)))})}load(e,a){this.models[a]||(this.models[a]={});let d=Object.keys(e);this.numModelsLoading[a]=(this.numModelsLoading[a]||0)+d.length;let m=[];for(let p of d)m.push(this.loadModel(p,e[p]));Promise.allSettled(m).then(p=>{for(let u=0;u<p.length;u++){let{status:U,value:Y}=p[u];U==="fulfilled"&&Y&&(this.models[a][d[u]]={model:Y,numReferences:1})}this.numModelsLoading[a]-=d.length,this.fire(new l.x("data",{dataType:"style"}))}).catch(p=>{this.fire(new l.t(new Error(`Could not load models: ${p.message}`)))})}isLoaded(){for(let e in this.numModelsLoading)if(this.numModelsLoading[e]>0)return!1;return!0}hasModel(e,a){return!!this.getModel(e,a)}getModel(e,a){return this.models[a]||(this.models[a]={}),this.models[a][e]?this.models[a][e].model:void 0}addModel(e,a,d){this.models[d]||(this.models[d]={}),this.hasModel(e,d)&&this.models[d][e].numReferences++,this.load({[e]:this.requestManager.normalizeModelURL(a)},d)}addModels(e,a){this.models[a]||(this.models[a]={});let d={};for(let m in e)this.models[a][m]={},d[m]=this.requestManager.normalizeModelURL(e[m]);this.load(d,a)}addModelsFromBucket(e,a){this.models[a]||(this.models[a]={});let d={};for(let m of e)this.hasModel(m,a)?this.models[a][m].numReferences++:d[m]=this.requestManager.normalizeModelURL(m);this.load(d,a)}removeModel(e,a){if(this.models[a]&&this.models[a][e]&&(this.models[a][e].numReferences--,this.models[a][e].numReferences===0)){let d=this.models[a][e].model;delete this.models[a][e],d.destroy()}}listModels(e){return this.models[e]||(this.models[e]={}),Object.keys(this.models[e])}upload(e,a){this.models[a]||(this.models[a]={});for(let d in this.models[a])this.models[a][d].model&&this.models[a][d].model.upload(e.context)}}let Oc=new l.a0({data:new l.a1(l._.colorTheme.data)}),gn=(r,e)=>Ut(r,e&&e.filter(a=>a.identifier!=="source.canvas")),Wd=l.ar(hi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","updateImport"]),es=l.ar(hi,["setCenter","setZoom","setBearing","setPitch"]),Om={version:8,layers:[],sources:{}},Dm={duration:300,delay:0};class Vn extends l.E{constructor(e,a={}){super(),this.map=e,this.scope=a.scope||"",this.globalId=null,this.fragments=[],this.importDepth=a.importDepth||0,this.importsCache=a.importsCache||new Map,this.resolvedImports=a.resolvedImports||new Set,this.transition=l.l({},Dm),this._buildingIndex=new fc(this),this.crossTileSymbolIndex=new rd,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=a.styleChanges||new Il,this.dispatcher=a.dispatcher?a.dispatcher:new l.cd(l.ce(),this),a.imageManager?this.imageManager=a.imageManager:(this.imageManager=new il,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=a.glyphManager?a.glyphManager:new l.cf(e._requestManager,a.localFontFamily?l.cg.all:a.localIdeographFontFamily?l.cg.ideographs:l.cg.none,a.localFontFamily||a.localIdeographFontFamily),a.modelManager?this.modelManager=a.modelManager:(this.modelManager=new yl(e._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null},this._styleColorThemeForScope={},this.options=a.configOptions?a.configOptions:new Map,this._configDependentLayers=a.configDependentLayers?a.configDependentLayers:new Set,this._config=a.config,this._initialConfig=a.initialConfig,this.dispatcher.broadcast("setReferrer",l.ch());let d=this;this._rtlTextPluginCallback=Vn.registerForPluginStateChange(m=>{d.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:m.pluginStatus,pluginURL:m.pluginURL},(p,u)=>{if(l.ci(p),u&&u.every(U=>U))for(let U in d._sourceCaches){let Y=d._sourceCaches[U],y=Y.getSource().type;y!=="vector"&&y!=="geojson"||Y.reload()}})}),this.on("data",m=>{if(m.dataType!=="source"||m.sourceDataType!=="metadata")return;let p=this.getOwnSource(m.sourceId);if(p&&p.vectorLayerIds)for(let u in this._layers){let U=this._layers[u];U.source===p.id&&this._validateLayer(U)}})}load(e){return e?(typeof e=="string"?this.loadURL(e):this.loadJSON(e),this):this}_getGlobalId(e){if(!e)return null;if(typeof e=="string"){if(l.f(e))return e;let a=l.cj(e);if(!a.startsWith("http"))try{return new URL(a,location.href).toString()}catch{return a}return a}return`json://${l.ck(JSON.stringify(e))}`}_diffStyle(e,a,d){this.globalId=this._getGlobalId(e);let m=(p,u)=>{try{u(null,this.setState(p,d))}catch(U){u(U,!1)}};if(typeof e=="string"){let p=this.map._requestManager.normalizeStyleURL(e),u=this.map._requestManager.transformRequest(p,l.R.Style);l.n(u,(U,Y)=>{U?this.fire(new l.t(U)):Y&&m(Y,a)})}else typeof e=="object"&&m(e,a)}loadURL(e,a={}){this.fire(new l.x("dataloading",{dataType:"style"}));let d=typeof a.validate=="boolean"?a.validate:!l.f(e);this.globalId=this._getGlobalId(e),e=this.map._requestManager.normalizeStyleURL(e,a.accessToken),this.resolvedImports.add(e);let m=this.importsCache.get(e);if(m)return this._load(m,d);let p=this.map._requestManager.transformRequest(e,l.R.Style);this._request=l.n(p,(u,U)=>{if(this._request=null,u)this.fire(new l.t(u));else if(U)return this.importsCache.set(e,U),this._load(U,d)})}loadJSON(e,a={}){this.fire(new l.x("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(e),this._request=l.q.frame(()=>{this._request=null,this._load(e,a.validate!==!1)})}loadEmpty(){this.fire(new l.x("dataloading",{dataType:"style"})),this._load(Om,!1)}_loadImports(e,a,d){if(this.importDepth>=4)return l.w("Style doesn't support nesting deeper than 5"),Promise.resolve();let m=[];for(let p of e){let u=this._createFragmentStyle(p),U=new Promise(B=>{u.once("style.import.load",B),u.once("error",B)}).then(()=>this.mergeAll());if(m.push(U),this.resolvedImports.has(p.url)){u.loadEmpty();continue}let Y=p.data||this.importsCache.get(p.url);Y?(u.loadJSON(Y,{validate:a}),this._isInternalStyle(Y)&&(u.globalId=null)):p.url?u.loadURL(p.url,{validate:a}):u.loadEmpty();let y={style:u,id:p.id,config:p.config};if(d){let B=this.fragments.findIndex(({id:C})=>C===d);this.fragments=this.fragments.slice(0,B).concat(y).concat(this.fragments.slice(B))}else this.fragments.push(y)}return Promise.allSettled(m)}getImportGlobalIds(e=this,a=new Set){for(let d of e.fragments)d.style.globalId&&a.add(d.style.globalId),this.getImportGlobalIds(d.style,a);return[...a.values()]}_createFragmentStyle(e){let a=this.scope?l.av(e.id,this.scope):e.id,d,m=this._initialConfig&&this._initialConfig[a];(e.config||m)&&(d=l.l({},e.config,m));let p=new Vn(this.map,{scope:a,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:d,configOptions:this.options,configDependentLayers:this._configDependentLayers});return p.setEventedParent(this.map,{style:p}),p}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(e){return this.isRootStyle()&&(e.fragment||!!e.schema&&e.fragment!==!1)}_load(e,a){let d=e.schema;if(this._isInternalStyle(e)){let u=l.l({},Om,{imports:[{id:"basemap",data:e,url:""}]});return void this._load(u,a)}if(this.updateConfig(this._config,d),a&&gn(this,Wn(e)))return;this._loaded=!0,this.stylesheet=l.cl(e);let m=()=>{for(let y in e.sources)this.addSource(y,e.sources[y],{validate:!1,isInitialLoad:!0});e.sprite?this._loadSprite(e.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(e.glyphs,this.scope);let u=vc(this.stylesheet.layers);if(this._order=u.map(y=>y.id),this.stylesheet.light&&l.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){let y=this.stylesheet.lights[0];this.light=new Jt(y.properties,y.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Jt(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(let y of u){let B=l.cq(y,this.scope,this._styleColorTheme.lut,this.options);B.configDependencies.size!==0&&this._configDependentLayers.add(B.fqid),B.setEventedParent(this,{layer:{id:B.id}}),this._layers[B.id]=B,this._serializedLayers[B.id]=B.serialize();let C=this.getOwnLayerSourceCache(B),k=!!this.directionalLight&&this.directionalLight.shadowsEnabled();C&&B.canCastShadows()&&k&&(C.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);let U=this.stylesheet.terrain;U&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(U,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new l.x("data",{dataType:"style"}));let Y=this.isRootStyle();e.imports?this._loadImports(e.imports,a).then(()=>{this._reloadImports(),this.fire(new l.x(Y?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new l.x(Y?"style.load":"style.import.load")))},p=this.stylesheet["color-theme"];if(this._styleColorTheme.colorTheme=p,p){let u=this._evaluateColorThemeData(p);this._loadColorTheme(u).then(()=>{m()}).catch(U=>{l.w(`Couldn't load color theme from the stylesheet: ${U}`),m()})}else this._styleColorTheme.lut=null,m()}isRootStyle(){return this.importDepth===0}mergeAll(){let e,a,d,m,p,u,U,Y,y={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(B=>{if(B.stylesheet){if(B.light!=null&&(e=B.light),B.stylesheet.lights)for(let C of B.stylesheet.lights)C.type==="ambient"&&B.ambientLight!=null&&(a=B.ambientLight),C.type==="directional"&&B.directionalLight!=null&&(d=B.directionalLight);m=this._prioritizeTerrain(m,B.terrain,B.stylesheet.terrain),B.stylesheet.fog&&B.fog!=null&&(p=B.fog),B.stylesheet.camera!=null&&(Y=B.stylesheet.camera),B.stylesheet.projection!=null&&(u=B.stylesheet.projection),B.stylesheet.transition!=null&&(U=B.stylesheet.transition),y[B.scope]=B._styleColorTheme}}),this.light=e,this.ambientLight=a,this.directionalLight=d,this.fog=p,this._styleColorThemeForScope=y,m===null?delete this.terrain:this.terrain=m,this.camera=Y||{"camera-projection":"perspective"},this.projection=u||{name:"mercator"},this.transition=l.l({},Dm,U),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(e){let a=d=>{for(let m of d.fragments)a(m.style);e(d)};a(this)}_prioritizeTerrain(e,a,d){let m=e&&e.drapeRenderMode===0;return d===null?a&&a.drapeRenderMode===0?a:m?e:null:a!=null&&(!e||m||a&&a.drapeRenderMode===1)?a:e}mergeTerrain(){let e;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(a=>{e=this._prioritizeTerrain(e,a.terrain,a.stylesheet.terrain)}),e===null?delete this.terrain:this.terrain=e}mergeProjection(){let e;this.forEachFragmentStyle(a=>{a.stylesheet.projection!=null&&(e=a.stylesheet.projection)}),this.projection=e||{name:"mercator"}}mergeSources(){let e={},a={},d={};this.forEachFragmentStyle(m=>{for(let p in m._sourceCaches){let u=l.av(p,m.scope);e[u]=m._sourceCaches[p]}for(let p in m._otherSourceCaches){let u=l.av(p,m.scope);a[u]=m._otherSourceCaches[p]}for(let p in m._symbolSourceCaches){let u=l.av(p,m.scope);d[u]=m._symbolSourceCaches[p]}}),this._mergedSourceCaches=e,this._mergedOtherSourceCaches=a,this._mergedSymbolSourceCaches=d}mergeLayers(){let e={},a=[],d={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(p=>{for(let u of p._order){let U=p._layers[u];if(U.type==="slot"){let Y=l.cm(u);if(e[Y])continue;e[Y]=[]}U.slot&&e[U.slot]?e[U.slot].push(U):a.push(U)}}),this._mergedOrder=[];let m=(p=[])=>{for(let u of p)if(u.type==="slot"){let U=l.cm(u.id);e[U]&&m(e[U]),this._mergedSlots.push(U)}else{let U=l.av(u.id,u.scope);this._mergedOrder.push(U),d[U]=u,u.is3D()&&(this._has3DLayers=!0),u.type==="circle"&&(this._hasCircleLayers=!0),u.type==="symbol"&&(this._hasSymbolLayers=!0),u.type==="clip"&&(this._clipLayerPresent=!0)}};m(a),this._mergedOrder.sort((p,u)=>{let U=d[p],Y=d[u];return U.hasInitialOcclusionOpacityProperties?Y.is3D()?1:0:U.is3D()&&Y.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=d,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(e){return this.stylesheet.camera=l.l({},this.stylesheet.camera,e),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(e){return e.data?function(a,d,m){let p=l.l({},d);for(let U of Object.keys(l._.colorTheme))p[U]===void 0&&(p[U]=l._.colorTheme[U].default);let u=new l.$(Oc,a,new Map(m));return u.setTransitionOrValue(p,m),u.untransitioned().possiblyEvaluate(new l.a3(0))}(this.scope,e,this.options).get("data"):null}_loadColorTheme(e){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;let a=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((d,m)=>{let p="data:image/png;base64,";if(!e||e.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void d();let u=e;u.startsWith(p)||(u=p+u);let U="mapbox-reserved-lut",Y=new Image;Y.src=u,Y.onerror=()=>{this._styleColorTheme.lutLoading=!1,m(new Error("Failed to load image data"))},Y.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==a)return void d();this._styleColorTheme.lutLoading=!1;let{width:y,height:B,data:C}=l.q.getImageData(Y);if(B>32)return void m(new Error("The height of the image must be less than or equal to 32 pixels."));if(y!==B*B)return void m(new Error("The width of the image must be equal to the height squared."));this.getImage(U)&&this.removeImage(U),this.addImage(U,{data:new l.r({width:y,height:B},C),pixelRatio:1,sdf:!1,version:0});let k=this.imageManager.getImage(U,this.scope);k?(this._styleColorTheme.lut={image:k.data,data:e},d()):m(new Error("Missing LUT image."))}})}getLut(e){let a=this._styleColorThemeForScope[e];return a?a.lut:null}setProjection(e){e?this.stylesheet.projection=e:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(e){this._spriteRequest=function(a,d,m){let p,u,U,Y=l.q.devicePixelRatio>1?"@2x":"",y=l.n(d.transformRequest(d.normalizeSpriteURL(a,Y,".json"),l.R.SpriteJSON),(k,Q)=>{y=null,U||(U=k,p=Q,C())}),B=l.o(d.transformRequest(d.normalizeSpriteURL(a,Y,".png"),l.R.SpriteImage),(k,Q)=>{B=null,U||(U=k,u=Q,C())});function C(){if(U)m(U);else if(p&&u){let k=l.q.getImageData(u),Q={};for(let z in p){let{width:w,height:A,x:H,y:$,sdf:et,pixelRatio:K,stretchX:nt,stretchY:at,content:ct}=p[z],rt=new l.r({width:w,height:A});l.r.copy(k,rt,{x:H,y:$},{x:0,y:0},{width:w,height:A},null),Q[z]={data:rt,pixelRatio:K,sdf:et,stretchX:nt,stretchY:at,content:ct}}m(null,Q)}}return{cancel(){y&&(y.cancel(),y=null),B&&(B.cancel(),B=null)}}}(e,this.map._requestManager,(a,d)=>{if(this._spriteRequest=null,a)this.fire(new l.t(a));else if(d)for(let m in d)this.imageManager.addImage(m,this.scope,d[m]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new l.x("data",{dataType:"style"}))})}_validateLayer(e){let a=this.getOwnSource(e.source);if(!a)return;let d=e.sourceLayer;d&&(a.type==="geojson"||a.vectorLayerIds&&a.vectorLayerIds.indexOf(d)===-1)&&this.fire(new l.t(new Error(`Source layer "${d}" does not exist on source "${a.id}" as specified by style layer "${e.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let e in this._sourceCaches)if(!this._sourceCaches[e].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(let{style:e}of this.fragments)if(!e.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((e,a)=>{let d=this.fragments[a];return d&&d.style&&(e.data=d.style.serialize()),e})}_serializeSources(){let e={};for(let a in this._sourceCaches){let d=this._sourceCaches[a].getSource();e[d.id]||(e[d.id]=d.serialize())}return e}_serializeLayers(e){let a=[];for(let d of e){let m=this._layers[d];m&&m.type!=="custom"&&a.push(m.serialize())}return a}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition())return!0;for(let e in this._sourceCaches)if(this._sourceCaches[e].hasTransition())return!0;for(let e in this._layers)if(this._layers[e].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(e){return!!this.terrain&&e.isDraped(this.getLayerSourceCache(e))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(e){let a=this.getOwnLayer(e);if(a)return a;this.fire(new l.t(new Error(`The layer '${e}' does not exist in the map's style.`)))}_checkSource(e){let a=this.getOwnSource(e);if(a)return a;this.fire(new l.t(new Error(`The source '${e}' does not exist in the map's style.`)))}precompilePrograms(e,a){let d=this.map.painter;if(d)for(let m=e.minzoom||0;m<(e.maxzoom||25.5);m++){let p=e.getProgramIds();if(p)for(let u of p){let U=e.getDefaultProgramParams(u,a.zoom,this._styleColorTheme.lut);U&&(d.style=this,this.fog&&(d._fogVisible=!0,U.overrideFog=!0,d.getOrCreateProgram(u,U)),d._fogVisible=!1,U.overrideFog=!1,d.getOrCreateProgram(u,U),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(U.overrideRtt=!0,d.getOrCreateProgram(u,U)))}}}update(e){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(e),this.directionalLight&&this.directionalLight.recalculate(e);let a=this.calculateLightsBrightness();e.brightness=a||0,a!==this._brightness&&(this._brightness=a,this.dispatcher.broadcast("setBrightness",a));let d=this._changes.isDirty(),m=!1;if(this._changes.isDirty()){let u=this._changes.getLayerUpdatesByScope();for(let U in u){let{updatedIds:Y,removedIds:y}=u[U];(Y||y)&&(this._updateWorkerLayers(U,Y,y),m=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(e),this.light&&this.light.updateTransitions(e),this.ambientLight&&this.ambientLight.updateTransitions(e),this.directionalLight&&this.directionalLight.updateTransitions(e),this.fog&&this.fog.updateTransitions(e),this._changes.reset()}let p={};for(let u in this._mergedSourceCaches){let U=this._mergedSourceCaches[u];p[u]=U.used,U.used=!1,U.tileCoverLift=0}for(let u of this._mergedOrder){let U=this._mergedLayers[u];if(U.recalculate(e,this._availableImages),!U.isHidden(e.zoom)){let Y=this.getLayerSourceCache(U);Y&&(Y.used=!0,Y.tileCoverLift=Math.max(Y.tileCoverLift,U.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(U,e)}):this.precompilePrograms(U,e))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&m&&this.mergeLayers();for(let u in p){let U=this._mergedSourceCaches[u];p[u]!==U.used&&U.getSource().fire(new l.x("data",{sourceDataType:"visibility",dataType:"source",sourceId:U.getSource().id}))}this.light&&this.light.recalculate(e),this.terrain&&this.terrain.recalculate(e),this.fog&&this.fog.recalculate(e),this.z=e.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),d&&this.fire(new l.x("data",{dataType:"style"}))}_updateTilesForChangedImages(){let e=this._changes.getUpdatedImages();if(e.length){for(let a in this._sourceCaches)this._sourceCaches[a].reloadTilesForDependencies(["icons","patterns"],e);this._changes.resetUpdatedImages()}}_updateWorkerLayers(e,a,d){let m=this.getFragmentStyle(e);m&&this.dispatcher.broadcast("updateLayers",{layers:a?m._serializeLayers(a):[],scope:e,removedIds:d||[],options:m.options})}setState(e,a){if(this._checkLoaded(),gn(this,Wn(e)))return!1;(e=l.cl(e)).layers=vc(e.layers);let d=function(u,U){if(!u)return[{command:hi.setStyle,args:[U]}];let Y=[];try{if(!l.bh(u.version,U.version))return[{command:hi.setStyle,args:[U]}];if(l.bh(u.center,U.center)||Y.push({command:hi.setCenter,args:[U.center]}),l.bh(u.zoom,U.zoom)||Y.push({command:hi.setZoom,args:[U.zoom]}),l.bh(u.bearing,U.bearing)||Y.push({command:hi.setBearing,args:[U.bearing]}),l.bh(u.pitch,U.pitch)||Y.push({command:hi.setPitch,args:[U.pitch]}),l.bh(u.sprite,U.sprite)||Y.push({command:hi.setSprite,args:[U.sprite]}),l.bh(u.glyphs,U.glyphs)||Y.push({command:hi.setGlyphs,args:[U.glyphs]}),l.bh(u.imports,U.imports)||function(Q=[],z=[],w){z=z||[];let A=(Q=Q||[]).map(ho),H=z.map(ho),$=Q.reduce(wo,{}),et=z.reduce(wo,{}),K=A.slice(),nt,at,ct,rt;for(nt=0,at=0;nt<A.length;nt++)ct=A[nt],et.hasOwnProperty(ct)?at++:(w.push({command:hi.removeImport,args:[ct]}),K.splice(K.indexOf(ct,at),1));for(nt=0,at=0;nt<H.length;nt++)ct=H[H.length-1-nt],K[K.length-1-nt]!==ct&&($.hasOwnProperty(ct)?(w.push({command:hi.removeImport,args:[ct]}),K.splice(K.lastIndexOf(ct,K.length-at),1)):at++,rt=K[K.length-nt],w.push({command:hi.addImport,args:[et[ct],rt]}),K.splice(K.length-nt,0,ct));for(let bt of z){let gt=$[bt.id];gt&&!l.bh(gt,bt)&&w.push({command:hi.updateImport,args:[bt.id,bt]})}}(u.imports,U.imports,Y),l.bh(u.transition,U.transition)||Y.push({command:hi.setTransition,args:[U.transition]}),l.bh(u.light,U.light)||Y.push({command:hi.setLight,args:[U.light]}),l.bh(u.fog,U.fog)||Y.push({command:hi.setFog,args:[U.fog]}),l.bh(u.projection,U.projection)||Y.push({command:hi.setProjection,args:[U.projection]}),l.bh(u.lights,U.lights)||Y.push({command:hi.setLights,args:[U.lights]}),l.bh(u.camera,U.camera)||Y.push({command:hi.setCamera,args:[U.camera]}),!l.bh(u["color-theme"],U["color-theme"]))return[{command:hi.setStyle,args:[U]}];let y={},B=[];(function(Q,z,w,A){let H;for(H in z=z||{},Q=Q||{})Q.hasOwnProperty(H)&&(z.hasOwnProperty(H)||Ri(H,w,A));for(H in z){if(!z.hasOwnProperty(H))continue;let $=z[H];Q.hasOwnProperty(H)?l.bh(Q[H],$)||(Q[H].type==="geojson"&&$.type==="geojson"&&Je(Q,z,H)?w.push({command:hi.setGeoJSONSourceData,args:[H,$.data]}):up(H,z,w,A)):Ec(H,z,w)}})(u.sources,U.sources,B,y);let C=[];u.layers&&u.layers.forEach(Q=>{Q.source&&y[Q.source]?Y.push({command:hi.removeLayer,args:[Q.id]}):C.push(Q)});let k=u.terrain;k&&y[k.source]&&(Y.push({command:hi.setTerrain,args:[void 0]}),k=void 0),Y=Y.concat(B),l.bh(k,U.terrain)||Y.push({command:hi.setTerrain,args:[U.terrain]}),function(Q,z,w){z=z||[];let A=(Q=Q||[]).map(ho),H=z.map(ho),$=Q.reduce(wo,{}),et=z.reduce(wo,{}),K=A.slice(),nt=Object.create(null),at,ct,rt,bt,gt,Wt,ht;for(at=0,ct=0;at<A.length;at++)rt=A[at],et.hasOwnProperty(rt)?ct++:(w.push({command:hi.removeLayer,args:[rt]}),K.splice(K.indexOf(rt,ct),1));for(at=0,ct=0;at<H.length;at++)rt=H[H.length-1-at],K[K.length-1-at]!==rt&&($.hasOwnProperty(rt)?(w.push({command:hi.removeLayer,args:[rt]}),K.splice(K.lastIndexOf(rt,K.length-ct),1)):ct++,Wt=K[K.length-at],w.push({command:hi.addLayer,args:[et[rt],Wt]}),K.splice(K.length-at,0,rt),nt[rt]=!0);for(at=0;at<H.length;at++)if(rt=H[at],bt=$[rt],gt=et[rt],!nt[rt]&&!l.bh(bt,gt))if(l.bh(bt.source,gt.source)&&l.bh(bt["source-layer"],gt["source-layer"])&&l.bh(bt.type,gt.type)){for(ht in qs(bt.layout,gt.layout,w,rt,null,hi.setLayoutProperty),qs(bt.paint,gt.paint,w,rt,null,hi.setPaintProperty),l.bh(bt.slot,gt.slot)||w.push({command:hi.setSlot,args:[rt,gt.slot]}),l.bh(bt.filter,gt.filter)||w.push({command:hi.setFilter,args:[rt,gt.filter]}),l.bh(bt.minzoom,gt.minzoom)&&l.bh(bt.maxzoom,gt.maxzoom)||w.push({command:hi.setLayerZoomRange,args:[rt,gt.minzoom,gt.maxzoom]}),bt)bt.hasOwnProperty(ht)&&ht!=="layout"&&ht!=="paint"&&ht!=="filter"&&ht!=="metadata"&&ht!=="minzoom"&&ht!=="maxzoom"&&ht!=="slot"&&(ht.indexOf("paint.")===0?qs(bt[ht],gt[ht],w,rt,ht.slice(6),hi.setPaintProperty):l.bh(bt[ht],gt[ht])||w.push({command:hi.setLayerProperty,args:[rt,ht,gt[ht]]}));for(ht in gt)gt.hasOwnProperty(ht)&&!bt.hasOwnProperty(ht)&&ht!=="layout"&&ht!=="paint"&&ht!=="filter"&&ht!=="metadata"&&ht!=="minzoom"&&ht!=="maxzoom"&&ht!=="slot"&&(ht.indexOf("paint.")===0?qs(bt[ht],gt[ht],w,rt,ht.slice(6),hi.setPaintProperty):l.bh(bt[ht],gt[ht])||w.push({command:hi.setLayerProperty,args:[rt,ht,gt[ht]]}))}else w.push({command:hi.removeLayer,args:[rt]}),Wt=K[K.lastIndexOf(rt)+1],w.push({command:hi.addLayer,args:[gt,Wt]})}(C,U.layers,Y)}catch(y){console.warn("Unable to compute style diff:",y),Y=[{command:hi.setStyle,args:[U]}]}return Y}(this.serialize(),e).filter(u=>!(u.command in es));if(d.length===0)return!1;let m=d.filter(u=>!(u.command in Wd));if(m.length>0)throw new Error(`Unimplemented: ${m.map(u=>u.command).join(", ")}.`);let p=[];return d.forEach(u=>{p.push(this[u.command].apply(this,u.args))}),a&&Promise.all(p).then(a),this.stylesheet=e,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(e,a){return this.getImage(e)?this.fire(new l.t(new Error("An image with this name already exists."))):(this.imageManager.addImage(e,this.scope,a),this._afterImageUpdated(e),this)}updateImage(e,a){this.imageManager.updateImage(e,this.scope,a)}getImage(e){return this.imageManager.getImage(e,this.scope)}removeImage(e){return this.getImage(e)?(this.imageManager.removeImage(e,this.scope),this._afterImageUpdated(e),this):this.fire(new l.t(new Error("No image with this name exists.")))}_afterImageUpdated(e){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(e),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new l.x("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(e,a,d={}){return this._checkLoaded(),this._validate(pt,`models.${e}`,a,null,d)||(this.modelManager.addModel(e,a,this.scope),this._changes.setDirty()),this}hasModel(e){return this.modelManager.hasModel(e,this.scope)}removeModel(e){return this.hasModel(e)?(this.modelManager.removeModel(e,this.scope),this):this.fire(new l.t(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(e,a,d={}){if(this._checkLoaded(),this.getOwnSource(e)!==void 0)throw new Error(`There is already a source with ID "${e}".`);if(!a.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(a).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(a.type)>=0&&this._validate(bo,`sources.${e}`,a,null,d))return;this.map&&this.map._collectResourceTiming&&(a.collectResourceTiming=!0);let m=vo(e,a,this.dispatcher,this);m.scope=this.scope,m.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(m.id),source:m.serialize(),sourceId:m.id}));let p=u=>{let U=(u?"symbol:":"other:")+m.id,Y=l.av(U,this.scope),y=this._sourceCaches[U]=new an(Y,m,u);(u?this._symbolSourceCaches:this._otherSourceCaches)[m.id]=y,y.onAdd(this.map)};p(!1),a.type!=="vector"&&a.type!=="geojson"||p(!0),m.onAdd&&m.onAdd(this.map),d.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(e){this._checkLoaded();let a=this.getOwnSource(e);if(!a)throw new Error("There is no source with this ID");for(let m in this._layers)if(this._layers[m].source===e)return this.fire(new l.t(new Error(`Source "${e}" cannot be removed while layer "${m}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===e)return this.fire(new l.t(new Error(`Source "${e}" cannot be removed while terrain is using it.`)));let d=this.getOwnSourceCaches(e);for(let m of d){let p=l.cm(m.id);delete this._sourceCaches[p],this._changes.discardSourceCacheUpdate(m.id),m.fire(new l.x("data",{sourceDataType:"metadata",dataType:"source",sourceId:m.getSource().id})),m.setEventedParent(null),m.clearTiles()}return delete this._otherSourceCaches[e],delete this._symbolSourceCaches[e],this.mergeSources(),a.setEventedParent(null),a.onRemove&&a.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(e,a){this._checkLoaded(),this.getOwnSource(e).setData(a),this._changes.setDirty()}getOwnSource(e){let a=this.getOwnSourceCache(e);return a&&a.getSource()}getOwnSources(){let e=[];for(let a in this._otherSourceCaches){let d=this.getOwnSourceCache(a);d&&e.push(d.getSource())}return e}areTilesLoaded(){let e=this._mergedSourceCaches;for(let a in e){let d=e[a]._tiles;for(let m in d){let p=d[m];if(p.state!=="loaded"&&p.state!=="errored")return!1}}return!0}setLights(e){if(this._checkLoaded(),!e)return delete this.ambientLight,void delete this.directionalLight;let a=this._getTransitionParameters();for(let m of e){if(this._validate(Qo,"lights",m))return;switch(m.type){case"ambient":if(this.ambientLight){let p=this.ambientLight;p.set(m),p.updateTransitions(a)}else this.ambientLight=new xi(m,Oe||(Oe=new l.a0({color:new l.a1(l._.properties_light_ambient.color),intensity:new l.a1(l._.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){let p=this.directionalLight;p.set(m),p.updateTransitions(a)}else this.directionalLight=new xi(m,Ii||(Ii=new l.a0({direction:new l.ad(l._.properties_light_directional.direction),color:new l.a1(l._.properties_light_directional.color),intensity:new l.a1(l._.properties_light_directional.intensity),"cast-shadows":new l.a1(l._.properties_light_directional["cast-shadows"]),"shadow-intensity":new l.a1(l._.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}let d=new l.a3(this.z||0,a);this.ambientLight&&this.ambientLight.recalculate(d),this.directionalLight&&this.directionalLight.recalculate(d),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let e=this.directionalLight,a=this.ambientLight;if(!e||!a)return;let d=C=>.2126*(C[0]<=.03928?C[0]/12.92:Math.pow((C[0]+.055)/1.055,2.4))+.7152*(C[1]<=.03928?C[1]/12.92:Math.pow((C[1]+.055)/1.055,2.4))+.0722*(C[2]<=.03928?C[2]/12.92:Math.pow((C[2]+.055)/1.055,2.4)),m=e.properties.get("color").toRenderColor(null).toArray01(),p=e.properties.get("intensity"),u=e.properties.get("direction"),U=1-l.c7(u.x,u.y,u.z)[2]/90,Y=d(m)*p*U,y=a.properties.get("color").toRenderColor(null).toArray01(),B=a.properties.get("intensity");return(Y+d(y)*B)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let e=[];return this.directionalLight&&e.push(this.directionalLight.get()),this.ambientLight&&e.push(this.ambientLight.get()),e}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(e){if(!e)return this;if(l.cn(e)){let a=l.co(e),d=this.fragments.find(({id:p})=>p===a);if(!d)throw new Error(`Style import not found: ${e}`);let m=l.cm(e);return d.style.getFragmentStyle(m)}{let a=this.fragments.find(({id:d})=>d===e);if(!a)throw new Error(`Style import not found: ${e}`);return a.style}}getConfigProperty(e,a){let d=this.getFragmentStyle(e);if(!d)return null;let m=l.av(a,d.scope),p=d.options.get(m),u=p?p.value||p.default:null;return u?u.serialize():null}setConfigProperty(e,a,d){let m=this.getFragmentStyle(e);if(!m)return;let p=m.stylesheet.schema;if(!p||!p[a])return;let u=l.M(d);if(u.result!=="success")return void gn(this,u.value);let U=u.value.expression,Y=l.av(a,m.scope),y=m.options.get(Y);if(!y)return;let B,{minValue:C,maxValue:k,stepValue:Q,type:z,values:w}=p[a],A=l.M(p[a].default);A.result==="success"&&(B=A.value.expression),B?(this.options.set(Y,{...y,value:U,default:B,minValue:C,maxValue:k,stepValue:Q,type:z,values:w}),this.updateConfigDependencies(a)):this.fire(new l.t(new Error(`No schema defined for the config option "${a}" in the "${e}" fragment.`)))}getConfig(e){let a=this.getFragmentStyle(e);if(!a)return null;let d=a.stylesheet.schema;if(!d)return null;let m={};for(let p in d){let u=l.av(p,a.scope),U=a.options.get(u),Y=U?U.value||U.default:null;m[p]=Y?Y.serialize():null}return m}setConfig(e,a){let d=this.getFragmentStyle(e);d&&(d.updateConfig(a,d.stylesheet.schema),this.updateConfigDependencies())}getSchema(e){let a=this.getFragmentStyle(e);return a?a.stylesheet.schema:null}setSchema(e,a){let d=this.getFragmentStyle(e);d&&(d.stylesheet.schema=a,d.updateConfig(d._config,a),this.updateConfigDependencies())}updateConfig(e,a){if(this._config=e,e||a)if(a)for(let d in a){let m,p,u=l.M(a[d].default);if(u.result==="success"&&(m=u.value.expression),e&&e[d]!==void 0){let k=l.M(e[d]);k.result==="success"&&(p=k.value.expression)}let{minValue:U,maxValue:Y,stepValue:y,type:B,values:C}=a[d];if(m){let k=l.av(d,this.scope);this.options.set(k,{default:m,value:p,minValue:U,maxValue:Y,stepValue:y,type:B,values:C})}else this.fire(new l.t(new Error(`No schema defined for config option "${d}".`)))}else this.fire(new l.t(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(e){for(let a of this._configDependentLayers){let d=this.getLayer(a);if(d){if(e&&!d.configDependencies.has(e))continue;d.possiblyEvaluateVisibility(),this._updateLayer(d)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.forEachFragmentStyle(a=>{if(a._styleColorTheme.colorTheme){let d=a._evaluateColorThemeData(a._styleColorTheme.colorTheme);(!a._styleColorTheme.lut&&d!==""||a._styleColorTheme.lut&&d!==a._styleColorTheme.lut.data)&&a.setColorTheme(a._styleColorTheme.colorTheme)}}),this._changes.setDirty()}addLayer(e,a,d={}){this._checkLoaded();let m=e.id;if(this._layers[m])return void this.fire(new l.t(new Error(`Layer with id "${m}" already exists on this map`)));let p;if(e.type==="custom"){if(gn(this,l.cp(e)))return;p=l.cq(e,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof e.source=="object"&&(this.addSource(m,e.source),e=l.cl(e),e=l.l(e,{source:m})),this._validate(Tt,`layers.${m}`,e,{arrayIndex:-1},d))return;p=l.cq(e,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(p),p.setEventedParent(this,{layer:{id:m}}),this._serializedLayers[p.id]=p.serialize()}p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid);let u=this._order.length;if(a){let B=this._order.indexOf(a);if(B===-1)return void this.fire(new l.t(new Error(`Layer with id "${a}" does not exist on this map.`)));p.slot===this._layers[a].slot?u=B:l.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(u,0,m),this._layerOrderChanged=!0,this._layers[m]=p;let U=this.getOwnLayerSourceCache(p),Y=!!this.directionalLight&&this.directionalLight.shadowsEnabled();U&&p.canCastShadows()&&Y&&(U.castsShadows=!0);let y=this._changes.getRemovedLayer(p);if(y&&p.source&&U&&p.type!=="custom"){this._changes.discardLayerRemoval(p);let B=l.av(p.source,p.scope);y.type!==p.type?this._changes.updateSourceCache(B,"clear"):(this._changes.updateSourceCache(B,"reload"),U.pause())}this._updateLayer(p),p.onAdd&&p.onAdd(this.map),p.scope=this.scope,this.mergeLayers()}moveLayer(e,a){this._checkLoaded();let d=this._checkLayer(e);if(!d||e===a)return;let m=this._order.indexOf(e);this._order.splice(m,1);let p=this._order.length;if(a){let u=this._order.indexOf(a);if(u===-1)return void this.fire(new l.t(new Error(`Layer with id "${a}" does not exist on this map.`)));d.slot===this._layers[a].slot?p=u:l.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(p,0,e),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(e){this._checkLoaded();let a=this._checkLayer(e);if(!a)return;a.setEventedParent(null);let d=this._order.indexOf(e);this._order.splice(d,1),delete this._layers[e],delete this._serializedLayers[e],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(a.fqid),this._changes.removeLayer(a);let m=this.getOwnLayerSourceCache(a);if(m&&m.castsShadows){let p=!1;for(let u in this._layers)if(this._layers[u].source===a.source&&this._layers[u].canCastShadows()){p=!0;break}m.castsShadows=p}a.onRemove&&a.onRemove(this.map),this.mergeLayers()}getOwnLayer(e){return this._layers[e]}hasLayer(e){return e in this._mergedLayers}hasLayerType(e){for(let a in this._layers)if(this._layers[a].type===e)return!0;return!1}setLayerZoomRange(e,a,d){this._checkLoaded();let m=this._checkLayer(e);m&&(m.minzoom===a&&m.maxzoom===d||(a!=null&&(m.minzoom=a),d!=null&&(m.maxzoom=d),this._updateLayer(m)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(e,a){this._checkLoaded();let d=this._checkLayer(e);d&&d.slot!==a&&(d.slot=a,this._updateLayer(d))}setFilter(e,a,d={}){this._checkLoaded();let m=this._checkLayer(e);if(m&&!l.bh(m.filter,a))return a==null?(m.filter=void 0,void this._updateLayer(m)):void(this._validate(j,`layers.${m.id}.filter`,a,{layerType:m.type},d)||(m.filter=l.cl(a),this._updateLayer(m)))}getFilter(e){let a=this._checkLayer(e);if(a)return l.cl(a.filter)}setLayoutProperty(e,a,d,m={}){this._checkLoaded();let p=this._checkLayer(e);if(p&&!l.bh(p.getLayoutProperty(a),d)){if(d!=null&&(!m||m.validate!==!1)&&gn(p,ot.call(Wn,{key:`layers.${e}.layout.${a}`,layerType:p.type,objectKey:a,value:d,styleSpec:l._,style:{glyphs:!0,sprite:!0}})))return;p.setLayoutProperty(a,d),p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),this._updateLayer(p)}}getLayoutProperty(e,a){let d=this._checkLayer(e);if(d)return d.getLayoutProperty(a)}setPaintProperty(e,a,d,m={}){this._checkLoaded();let p=this._checkLayer(e);if(!p||l.bh(p.getPaintProperty(a),d)||d!=null&&(!m||m.validate!==!1)&&gn(p,_.call(Wn,{key:`layers.${e}.paint.${a}`,layerType:p.type,objectKey:a,value:d,styleSpec:l._})))return;let u=p.setPaintProperty(a,d);p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),u&&this._updateLayer(p),this._changes.updatePaintProperties(p)}getPaintProperty(e,a){let d=this._checkLayer(e);if(d)return d.getPaintProperty(a)}setFeatureState(e,a){this._checkLoaded();let d=e.source,m=e.sourceLayer,p=this._checkSource(d);if(!p)return;let u=p.type;if(u==="geojson"&&m)return void this.fire(new l.t(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(u==="vector"&&!m)return void this.fire(new l.t(new Error("The sourceLayer parameter must be provided for vector source types.")));e.id===void 0&&this.fire(new l.t(new Error("The feature id parameter must be provided.")));let U=this.getOwnSourceCaches(d);for(let Y of U)Y.setFeatureState(m,e.id,a)}removeFeatureState(e,a){this._checkLoaded();let d=e.source,m=this._checkSource(d);if(!m)return;let p=m.type,u=p==="vector"?e.sourceLayer:void 0;if(p==="vector"&&!u)return void this.fire(new l.t(new Error("The sourceLayer parameter must be provided for vector source types.")));if(a&&typeof e.id!="string"&&typeof e.id!="number")return void this.fire(new l.t(new Error("A feature id is required to remove its specific state property.")));let U=this.getOwnSourceCaches(d);for(let Y of U)Y.removeFeatureState(u,e.id,a)}getFeatureState(e){this._checkLoaded();let a=e.source,d=e.sourceLayer,m=this._checkSource(a);if(m){if(m.type!=="vector"||d)return e.id===void 0&&this.fire(new l.t(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(a)[0].getFeatureState(d,e.id);this.fire(new l.t(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(e){return this.stylesheet.transition=l.l({},this.stylesheet.transition,e),this.transition=this.stylesheet.transition,this}getTransition(){return l.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();let e=this.getTerrain(),a=e&&this.terrain&&this.terrain.scope===this.scope?e:this.stylesheet.terrain;return l.cr({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:a,fog:this.stylesheet.fog,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},d=>d!==void 0)}_updateLayer(e){this._changes.updateLayer(e);let a=this.getLayerSourceCache(e),d=l.av(e.source,e.scope),m=this._changes.getUpdatedSourceCaches();e.source&&!m[d]&&a&&a.getSource().type!=="raster"&&(this._changes.updateSourceCache(d,"reload"),a.pause()),e.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(e){let a=U=>this._mergedLayers[U].is3D(),d=this.order,m={},p=[];for(let U=d.length-1;U>=0;U--){let Y=d[U];if(a(Y)){m[Y]=U;for(let y of e){let B=y[Y];if(B)for(let C of B)p.push(C)}}}p.sort((U,Y)=>Y.intersectionZ-U.intersectionZ);let u=[];for(let U=d.length-1;U>=0;U--){let Y=d[U];if(a(Y))for(let y=p.length-1;y>=0;y--){let B=p[y].feature;if(B.layer&&m[B.layer.id]<U)break;u.push(B),p.pop()}else for(let y of e){let B=y[Y];if(B)for(let C of B)u.push(C.feature)}}return u}queryRenderedFeatures(e,a,d){a&&a.filter&&this._validate(j,"queryRenderedFeatures.filter",a.filter,null,a),a.scope=this.scope,a.availableImages=this._availableImages,a.serializedLayers=this._serializedLayers;let m={};if(a&&a.layers){if(!Array.isArray(a.layers))return this.fire(new l.t(new Error("parameters.layers must be an Array."))),[];for(let y of a.layers){let B=this._mergedLayers[y];if(!B)return this.fire(new l.t(new Error(`The layer '${y}' does not exist in the map's style and cannot be queried for features.`))),[];m[B.source]=!0}}let p=[],u=a.serializedLayers||{},U=a&&a.layers?a.layers.some(y=>{let B=this.getLayer(y);return B&&B.is3D()}):this.has3DLayers(),Y=zi.createFromScreenPoints(e,d);for(let y in this._mergedSourceCaches){let B=this._mergedSourceCaches[y].getSource();if(!B||B.scope!==a.scope)continue;let C=this._mergedSourceCaches[y].getSource().id;a.layers&&!m[C]||p.push(kc(this._mergedSourceCaches[y],this._mergedLayers,u,Y,a,d,U,!!this.map._showQueryGeometry))}return this.placement&&p.push(function(y,B,C,k,Q,z,w){let A={},H=z.queryRenderedSymbols(k),$=[];for(let et of Object.keys(H).map(Number))$.push(w[et]);$.sort(Eo);for(let et of $){let K=et.featureIndex.lookupSymbolFeatures(H[et.bucketInstanceId],B,et.bucketIndex,et.sourceLayerIndex,Q.filter,Q.layers,Q.availableImages,y);for(let nt in K){let at=A[nt]=A[nt]||[],ct=K[nt];ct.sort((rt,bt)=>{let gt=et.featureSortOrder;if(gt){let Wt=gt.indexOf(rt.featureIndex);return gt.indexOf(bt.featureIndex)-Wt}return bt.featureIndex-rt.featureIndex});for(let rt of ct)at.push(rt)}}for(let et in A)A[et].forEach(K=>{let nt=K.feature,at=C(y[et]);if(!at)return;let ct=at.getFeatureState(nt.layer["source-layer"],nt.id);nt.source=nt.layer.source,nt.layer["source-layer"]&&(nt.sourceLayer=nt.layer["source-layer"]),nt.state=ct});return A}(this._mergedLayers,u,this.getLayerSourceCache.bind(this),Y.screenGeometry,a,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(p)}querySourceFeatures(e,a){a&&a.filter&&this._validate(j,"querySourceFeatures.filter",a.filter,null,a);let d=this.getOwnSourceCaches(e),m=[];for(let p of d)m=m.concat(_s(p,a));return m}addSourceType(e,a,d){return Vn.getSourceType(e)?d(new Error(`A source type called "${e}" already exists.`)):(Vn.setSourceType(e,a),a.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:e,url:a.workerSourceURL},d):d(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(e,a,d={}){this._checkLoaded();let m=this.light.getLight(),p=!1;for(let U in e)if(!l.bh(e[U],m[U])){p=!0;break}if(!p)return;let u=this._getTransitionParameters();this.light.setLight(e,a,d),this.light.updateTransitions(u)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=l.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&l.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(e,a=1){if(this._checkLoaded(),!e)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),a===0&&delete this.terrain,e===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let d=e,m=e.source==null;if(a===1){if(this.disableElevatedTerrain)return;if(typeof d.source=="object"){let U="terrain-dem-src";this.addSource(U,d.source),d=l.cl(d),d=l.l(d,{source:U})}let p=l.l({},d),u={};if(this.terrain&&m){p.source=this.terrain.get().source;let U=this.terrain?this.getFragmentStyle(this.terrain.scope):null;U&&(u.style=U.serialize())}if(this._validate(Os,"terrain",p,u))return}if(!this.terrain||this.terrain.scope!==this.scope&&!m||this.terrain&&a!==this.terrain.drapeRenderMode){if(!d)return;this._createTerrain(d,a),this.fire(new l.x("data",{dataType:"style"}))}else{let p=this.terrain,u=p.get();for(let U of Object.keys(l._.terrain))!d.hasOwnProperty(U)&&l._.terrain[U].default&&(d[U]=l._.terrain[U].default);for(let U in e)if(!l.bh(e[U],u[U])){p.set(e,this.options),this.stylesheet.terrain=e;let Y=this._getTransitionParameters({duration:0});p.updateTransitions(Y),this.fire(new l.x("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(e){let a=this.fog=new Vi(e,this.map.transform,this.scope,this.options);this.stylesheet.fog=a.get();let d=this._getTransitionParameters({duration:0});a.updateTransitions(d)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(let e of this.map._markers)e._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(e){if(this._checkLoaded(),!e)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let a=this.fog;if(!l.bh(a.get(),e)){a.set(e,this.options),this.stylesheet.fog=a.get();let d=this._getTransitionParameters({duration:0});a.updateTransitions(d)}}else this._createFog(e);this._markersNeedUpdate=!0}setColorTheme(e){this._checkLoaded();let a=()=>{for(let m in this._layers)this._layers[m].lut=this._styleColorTheme.lut;for(let m in this._sourceCaches)this._sourceCaches[m].clearTiles()};if(this._styleColorTheme.colorTheme=e,!e)return this._styleColorTheme.lut=null,void a();let d=this._evaluateColorThemeData(e);this._loadColorTheme(d).then(()=>{this.fire(new l.x("colorthemeset")),a()}).catch(m=>{l.w(`Couldn't set color theme: ${m}`)})}_getTransitionParameters(e){return{now:l.q.now(),transition:l.l(this.transition,e)}}updateDrapeFirstLayers(){if(!this.terrain)return;let e=[],a=[];for(let d of this._mergedOrder)this.isLayerDraped(this._mergedLayers[d])?e.push(d):a.push(d);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...e),this._drapedFirstOrder.push(...a)}_createTerrain(e,a){let d=this.terrain=new Et(e,a,this.scope,this.options);a===1&&(this.stylesheet.terrain=e),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let m=this._getTransitionParameters({duration:0});d.updateTransitions(m)}_force3DLayerUpdate(){for(let e in this._layers){let a=this._layers[e];a.type==="fill-extrusion"&&this._updateLayer(a)}}_forceSymbolLayerUpdate(){for(let e in this._layers){let a=this._layers[e];a.type==="symbol"&&this._updateLayer(a)}}_validate(e,a,d,m,p={}){if(p&&p.validate===!1)return!1;let u=l.l({},this.serialize());return gn(this,e.call(Wn,l.l({key:a,style:u,value:d,styleSpec:l._},m)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),l.cs.off("pluginStateChange",this._rtlTextPluginCallback);for(let e in this._mergedLayers)this._mergedLayers[e].setEventedParent(null);for(let e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles(),this._mergedSourceCaches[e].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(e){let a=this.getSourceCaches(e);for(let d of a)d.clearTiles()}clearSources(){for(let e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles()}reloadSource(e){let a=this.getSourceCaches(e);for(let d of a)d.resume(),d.reload()}reloadSources(){for(let e of this.getSources())e.reload&&e.reload()}updateSources(e){let a;this.directionalLight&&(a=md(this.directionalLight));for(let d in this._mergedSourceCaches)this._mergedSourceCaches[d].update(e,void 0,void 0,a)}_generateCollisionBoxes(){for(let e in this._sourceCaches){let a=this._sourceCaches[e];a.resume(),a.reload()}}_updatePlacement(e,a,d,m,p,u,U=!1){let Y=!1,y=!1,B={},C={};for(let k of this._mergedOrder){let Q=this._mergedLayers[k];if(Q.type!=="symbol")continue;let z=l.av(Q.source,Q.scope),w=B[z];if(!w){let H=this.getLayerSourceCache(Q);if(!H)continue;let $=H.getRenderableIds(!0).map(et=>H.getTileByID(et));C[z]=$.slice(),w=B[z]=$.sort((et,K)=>K.tileID.overscaledZ-et.tileID.overscaledZ||(et.tileID.isLessThan(K.tileID)?-1:1))}let A=this.crossTileSymbolIndex.addLayer(Q,w,a.center.lng,a.projection);Y=Y||A}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),U=U||this._layerOrderChanged||m===0,this._layerOrderChanged&&this.fire(new l.x("neworder")),(U||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(l.q.now(),a.zoom))&&(this.pauseablePlacement=new $s(a,this._mergedOrder,U,d,m,p,this.placement,this.fog&&a.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,B,C),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(l.q.now()),y=!0),Y&&this.pauseablePlacement.placement.setStale()),y||Y){this._buildingIndex.onNewFrame(a.zoom);for(let k=0;k<this._mergedOrder.length;k++){let Q=this._mergedLayers[this._mergedOrder[k]];if(Q.type!=="symbol")continue;let z=this.isLayerClipped(Q);this.placement.updateLayerOpacities(Q,B[l.av(Q.source,Q.scope)],k,z?u:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(l.q.now())}}_releaseSymbolFadeTiles(){for(let e in this._sourceCaches)this._sourceCaches[e].releaseSymbolFadeTiles()}addImport(e,a){this._checkLoaded();let d=this.stylesheet.imports=this.stylesheet.imports||[];if(d.findIndex(({id:p})=>p===e.id)!==-1)return void this.fire(new l.t(new Error(`Import with id '${e.id}' already exists in the map's style.`)));if(!a)return d.push(e),this._loadImports([e],!0);let m=d.findIndex(({id:p})=>p===a);return m===-1&&this.fire(new l.t(new Error(`Import with id "${a}" does not exist on this map.`))),this.stylesheet.imports=d.slice(0,m).concat(e).concat(d.slice(m)),this._loadImports([e],!0,a)}updateImport(e,a){this._checkLoaded();let d=this.stylesheet.imports||[],m=this.getImportIndex(e);return m===-1?this:typeof a=="string"?(this.setImportUrl(e,a),this):(a.url&&a.url!==d[m].url&&this.setImportUrl(e,a.url),l.bh(a.config,d[m].config)||this.setImportConfig(e,a.config),l.bh(a.data,d[m].data)||this.setImportData(e,a.data),this)}moveImport(e,a){this._checkLoaded();let d=this.stylesheet.imports||[],m=this.getImportIndex(e);if(m===-1)return this;let p=this.getImportIndex(a);if(p===-1)return this;let u=d[m],U=this.fragments[m];return d=d.filter(({id:Y})=>Y!==e),this.fragments=this.fragments.filter(({id:Y})=>Y!==e),this.stylesheet.imports=d.slice(0,p).concat(u).concat(d.slice(p)),this.fragments=this.fragments.slice(0,p).concat(U).concat(this.fragments.slice(p)),this.mergeLayers(),this}setImportUrl(e,a){this._checkLoaded();let d=this.stylesheet.imports||[],m=this.getImportIndex(e);if(m===-1)return this;d[m].url=a;let p=this.fragments[m];return p.style=this._createFragmentStyle(d[m]),p.style.on("style.import.load",()=>this.mergeAll()),p.style.loadURL(a),this}setImportData(e,a){this._checkLoaded();let d=this.getImportIndex(e),m=this.stylesheet.imports||[];return d===-1?this:a?(this.fragments[d].style.setState(a),this._reloadImports(),this):(delete m[d].data,this.setImportUrl(e,m[d].url))}setImportConfig(e,a){this._checkLoaded();let d=this.getImportIndex(e),m=this.stylesheet.imports||[];if(d===-1)return this;a?m[d].config=a:delete m[d].config;let p=this.fragments[d],u=p.style.stylesheet&&p.style.stylesheet.schema;return p.config=a,p.style.updateConfig(a,u),this.updateConfigDependencies(),this}removeImport(e){this._checkLoaded();let a=this.stylesheet.imports||[],d=this.getImportIndex(e);d!==-1&&(a.splice(d,1),this.fragments[d].style._remove(),this.fragments.splice(d,1),this._reloadImports())}getImportIndex(e){let a=(this.stylesheet.imports||[]).findIndex(d=>d.id===e);return a===-1&&this.fire(new l.t(new Error(`Import '${e}' does not exist in the map's style and cannot be updated.`))),a}getLayer(e){return this._mergedLayers[e]}getSources(){let e=[];for(let a in this._mergedOtherSourceCaches){let d=this._mergedOtherSourceCaches[a];d&&e.push(d.getSource())}return e}getSource(e,a){let d=this.getSourceCache(e,a);return d&&d.getSource()}getLayerSource(e){let a=this.getLayerSourceCache(e);return a&&a.getSource()}getSourceCache(e,a){let d=l.av(e,a);return this._mergedOtherSourceCaches[d]}getLayerSourceCache(e){let a=l.av(e.source,e.scope);return e.type==="symbol"?this._mergedSymbolSourceCaches[a]:this._mergedOtherSourceCaches[a]}getSourceCaches(e){if(e==null)return Object.values(this._mergedSourceCaches);let a=[];return this._mergedOtherSourceCaches[e]&&a.push(this._mergedOtherSourceCaches[e]),this._mergedSymbolSourceCaches[e]&&a.push(this._mergedSymbolSourceCaches[e]),a}updateSourceCaches(){let e=this._changes.getUpdatedSourceCaches();for(let a in e){let d=e[a];d==="reload"?this.reloadSource(a):d==="clear"&&this.clearSource(a)}}updateLayers(e){let a=this._changes.getUpdatedPaintProperties();for(let d of a){let m=this.getLayer(d);m&&m.updateTransitions(e)}}getImages(e,a,d){this.imageManager.getImages(a.icons,a.scope,d),this._updateTilesForChangedImages();let m=p=>{p&&p.setDependencies(a.tileID.key,a.type,a.icons)};m(this._otherSourceCaches[a.source]),m(this._symbolSourceCaches[a.source])}getGlyphs(e,a,d){this.glyphManager.getGlyphs(a.stacks,a.scope,d)}getResource(e,a,d){return l.ct(a,d)}getOwnSourceCache(e){return this._otherSourceCaches[e]}getOwnLayerSourceCache(e){return e.type==="symbol"?this._symbolSourceCaches[e.source]:this._otherSourceCaches[e.source]}getOwnSourceCaches(e){let a=[];return this._otherSourceCaches[e]&&a.push(this._otherSourceCaches[e]),this._symbolSourceCaches[e]&&a.push(this._symbolSourceCaches[e]),a}_isSourceCacheLoaded(e){let a=this.getOwnSourceCaches(e);return a.length===0?(this.fire(new l.t(new Error(`There is no source with ID '${e}'`))),!1):a.every(d=>d.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(e,a){if(!this._clipLayerPresent&&e.type!=="fill-extrusion")return!1;let d=e.type==="fill-extrusion"&&e.sourceLayer==="building";if(e.is3D()){if(d||a&&a.type==="batched-model"||e.type==="model")return!0}else if(e.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(e=>{e.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Vn.getSourceType=function(r){return ed[r]},Vn.setSourceType=function(r,e){ed[r]=e},Vn.registerForPluginStateChange=l.cc;var _m=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Dc=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color) {
#ifdef INDICATOR_CUTOUT
float holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,_c=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,ud="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Pm=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,Km=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,qm=`highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {
#ifdef FOG_DITHERING
vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);
#else
return color;
#endif
}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,$m=`#ifdef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Pc=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,th=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,er=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef NATIVE
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;let Zd=[];_l(_m,Zd),_l(_c,Zd),_l(Dc,Zd);let ir={"_prelude_fog.vertex.glsl":Km,"_prelude_terrain.vertex.glsl":Pm,"_prelude_shadow.vertex.glsl":th,"_prelude_fog.fragment.glsl":qm,"_prelude_shadow.fragment.glsl":er,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":$m,"_prelude_raster_particle.glsl":Pc},is={};ri("",Pm),ri(qm,Km),ri(er,th),ri($m,""),ri(Pc,"");let ar=ri(Dc,_c),gd=_m;var Dl={background:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float opacity_t=smoothstep((1.0-blur_positive)*antialiased_blur,blur_positive*antialiased_blur,extrude_length-1.0)-smoothstep(0.0,antialiasblur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:ri("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:ri(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:ri(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:ri("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:ri("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:ri("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:ri(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:ri(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:ri(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:ri(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=out_color.a;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trim_alpha,out_color.rgb,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in float a_z_offset;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);
#ifdef ELEVATED_ROADS
gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset+0.01*step(0.01,a_z_offset),1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 halfCellProgress=normal.yx*32.0;float ele0=elevation(pos);float ele_line=max(ele0,max(elevation(pos+halfCellProgress),elevation(pos-halfCellProgress)));float ele1=elevation(pos+offsetTile);float ele2=elevation(pos-offsetTile);float ele_max=max(ele_line,0.5*(ele1+ele2));float ele=ele_max-ele0+ele1+a_z_offset ;gl_Position=u_matrix*vec4(pos+offsetTile,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*0.1*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 v_uv;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {color=vec4(0,0,0,0);}}
#endif
#ifdef LINE_JOIN_NONE
float pattern_len=pattern_size/aspect;float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_ground(color);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in float a_z_offset;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec4 v_uv;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);
#ifdef ELEVATED_ROADS
gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset+0.01*step(0.01,a_z_offset),1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 halfCellProgress=normal.yx*32.0;float ele0=elevation(pos);float ele_line=max(ele0,max(elevation(pos+halfCellProgress),elevation(pos-halfCellProgress)));float ele1=elevation(pos+offsetTile);float ele2=elevation(pos-offsetTile);float ele_max=max(ele_line,0.5*(ele1+ele2));float ele=ele_max-ele0+ele1+a_z_offset ;gl_Position=u_matrix*vec4(pos+offsetTile,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*0.1*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
float a_uv_x=a_packed[0];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef LINE_JOIN_NONE
v_width=floorwidth+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:ri("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:ri("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:ri(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:ri(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;
#else
z+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
}`),terrainRaster:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:ri("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:ri(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,ud),skyboxGradient:ri(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,ud),skyboxCapture:ri(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:ri(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;
#ifndef NATIVE
c=dither(c,gl_FragCoord.xy+u_temporal_offset);
#endif
glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:ri(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:ri(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:ri(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),occlusion:ri("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function _l(r,e){let a=r.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let d of a)if(d=d.trim(),d[0]==="#"&&d.includes("if")&&!d.includes("endif")){d=d.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();let m=d.split(" ");for(let p of m)e.includes(p)||e.push(p)}}function ri(r,e){let a=/#include\s+"([^"]+)"/g,d=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,m=e.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);m&&(m=m.map(y=>{let B=y.split(" ");return B[B.length-1]}),m=[...new Set(m)]);let p={},u=[],U=[];if(r=r.replace(a,(y,B)=>(U.push(B),"")),(e=e.replace(a,(y,B)=>(u.push(B),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let Y=[...Zd];_l(r,Y),_l(e,Y);for(let y of[...u,...U])ir[y]||console.error(`Undefined include: ${y}`),is[y]||(is[y]=[],_l(ir[y],is[y])),Y=[...Y,...is[y]];return{fragmentSource:r=r.replace(d,(y,B,C,k,Q)=>(p[Q]=!0,B==="define"?`
#ifndef HAS_UNIFORM_u_${Q}
in ${C} ${k} ${Q};
#else
uniform ${C} ${k} u_${Q};
#endif
`:B==="initialize"?`
#ifdef HAS_UNIFORM_u_${Q}
    ${C} ${k} ${Q} = u_${Q};
#endif
`:B==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${Q}
    in ${C} ${k} ${Q};
#endif
`:B==="initialize-attribute"?"":void 0)),vertexSource:e=e.replace(d,(y,B,C,k,Q)=>{let z=k==="float"?"vec2":k,w=Q.match(/color/)?"color":z;return B==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${Q}
in ${C} ${k} a_${Q};
#endif
`:p[Q]?B==="define"?`
#ifndef HAS_UNIFORM_u_${Q}
uniform lowp float u_${Q}_t;
in ${C} ${z} a_${Q};
out ${C} ${k} ${Q};
#else
uniform ${C} ${k} u_${Q};
#endif
`:B==="initialize"?w==="vec4"?`
#ifndef HAS_UNIFORM_u_${Q}
    ${Q} = a_${Q};
#else
    ${C} ${k} ${Q} = u_${Q};
#endif
`:`
#ifndef HAS_UNIFORM_u_${Q}
    ${Q} = unpack_mix_${w}(a_${Q}, u_${Q}_t);
#else
    ${C} ${k} ${Q} = u_${Q};
#endif
`:B==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${Q}
    in ${C} ${k} a_${Q};
    out ${C} ${k} ${Q};
#endif
`:B==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${Q}
    ${Q} = a_${Q};
#endif
`:void 0:B==="define"?`
#ifndef HAS_UNIFORM_u_${Q}
uniform lowp float u_${Q}_t;
in ${C} ${z} a_${Q};
#else
uniform ${C} ${k} u_${Q};
#endif
`:B==="define-instanced"?w==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${Q}0;
in vec4 a_${Q}1;
in vec4 a_${Q}2;
in vec4 a_${Q}3;
#else
uniform ${C} ${k} u_${Q};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${C} ${z} a_${Q};
#else
uniform ${C} ${k} u_${Q};
#endif
`:B==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${Q}
    ${C} ${k} ${Q} = a_${Q};
#endif
`:w==="vec4"?`
#ifndef HAS_UNIFORM_u_${Q}
    ${C} ${k} ${Q} = a_${Q};
#else
    ${C} ${k} ${Q} = u_${Q};
#endif
`:`
#ifndef HAS_UNIFORM_u_${Q}
    ${C} ${k} ${Q} = unpack_mix_${w}(a_${Q}, u_${Q}_t);
#else
    ${C} ${k} ${Q} = u_${Q};
#endif
`}),staticAttributes:m,usedDefines:Y,vertexIncludes:u,fragmentIncludes:U}}class as{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(e,a,d,m,p,u,U,Y){this.context=e;let y=this.boundPaintVertexBuffers.length!==m.length;for(let C=0;!y&&C<m.length;C++)this.boundPaintVertexBuffers[C]!==m[C]&&(y=!0);let B=this.boundDynamicVertexBuffers.length!==U.length;for(let C=0;!B&&C<U.length;C++)this.boundDynamicVertexBuffers[C]!==U[C]&&(B=!0);if(!this.vao||this.boundProgram!==a||this.boundLayoutVertexBuffer!==d||y||B||this.boundIndexBuffer!==p||this.boundVertexOffset!==u)this.freshBind(a,d,m,p,u,U,Y);else{e.bindVertexArrayOES.set(this.vao);for(let C of U)C&&(C.bind(),Y&&C.instanceCount&&C.setVertexAttribDivisor(e.gl,a,Y));p&&p.dynamicDraw&&p.bind()}}freshBind(e,a,d,m,p,u,U){let Y=e.numAttributes,y=this.context,B=y.gl;this.vao&&this.destroy(),this.vao=y.gl.createVertexArray(),y.bindVertexArrayOES.set(this.vao),this.boundProgram=e,this.boundLayoutVertexBuffer=a,this.boundPaintVertexBuffers=d,this.boundIndexBuffer=m,this.boundVertexOffset=p,this.boundDynamicVertexBuffers=u,a.enableAttributes(B,e),a.bind(),a.setVertexAttribPointers(B,e,p);for(let C of d)C.enableAttributes(B,e),C.bind(),C.setVertexAttribPointers(B,e,p);for(let C of u)C&&(C.enableAttributes(B,e),C.bind(),C.setVertexAttribPointers(B,e,p),U&&C.instanceCount&&C.setVertexAttribDivisor(B,e,U));m&&m.bind(),y.currentNumAttributes=Y}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function nr(r,e){let a=Math.pow(2,e.canonical.z),d=e.canonical.y;return[new l.a5(0,d/a).toLngLat().lat,new l.a5(0,(d+1)/a).toLngLat().lat]}function Vd(r,e,a,d,m,p,u){let U=r.context,Y=U.gl,y=a.hillshadeFBO;if(!y)return;r.prepareDrawTile();let B=r.isTileAffectedByFog(e),C=r.getOrCreateProgram("hillshade",{overrideFog:B});U.activeTexture.set(Y.TEXTURE0),Y.bindTexture(Y.TEXTURE_2D,y.colorAttachment.get());let k=((A,H,$,et)=>{let K=$.paint.get("hillshade-shadow-color"),nt=$.paint.get("hillshade-highlight-color"),at=$.paint.get("hillshade-accent-color"),ct=$.paint.get("hillshade-emissive-strength"),rt=l.bB($.paint.get("hillshade-illumination-direction"));if($.paint.get("hillshade-illumination-anchor")==="viewport")rt-=A.transform.angle;else if(A.style&&A.style.enable3dLights()&&A.style.directionalLight){let gt=A.style.directionalLight.properties.get("direction"),Wt=l.c7(gt.x,gt.y,gt.z);rt=l.bB(Wt[1])}let bt=!A.options.moving;return{u_matrix:et||A.transform.calculateProjMatrix(H.tileID.toUnwrapped(),bt),u_image:0,u_latrange:nr(0,H.tileID),u_light:[$.paint.get("hillshade-exaggeration"),rt],u_shadow:K.toRenderColor($.lut),u_highlight:nt.toRenderColor($.lut),u_emissive_strength:ct,u_accent:at.toRenderColor($.lut)}})(r,a,d,r.terrain?e.projMatrix:null);r.uploadCommonUniforms(U,C,e.toUnwrapped());let{tileBoundsBuffer:Q,tileBoundsIndexBuffer:z,tileBoundsSegments:w}=r.getTileBoundsBuffers(a);C.draw(r,Y.TRIANGLES,m,p,u,Te.disabled,k,d.id,Q,z,w)}function Rd(r,e,a){if(!e.needsDEMTextureUpload)return;let d=r.context,m=d.gl;d.pixelStoreUnpackPremultiplyAlpha.set(!1),e.demTexture=e.demTexture||r.getTileTexture(a.stride);let p=a.getPixels();e.demTexture?e.demTexture.update(p,{premultiply:!1}):e.demTexture=new l.T(d,p,m.R32F,{premultiply:!1}),e.needsDEMTextureUpload=!1}function lr(r,e,a){let d=r.context,m=d.gl;if(!e.dem)return;let p=e.dem;if(d.activeTexture.set(m.TEXTURE1),Rd(r,e,p),!e.demTexture)return;e.demTexture.bind(m.NEAREST,m.CLAMP_TO_EDGE);let u=p.dim;d.activeTexture.set(m.TEXTURE0);let U=e.hillshadeFBO;if(!U){let k=new l.T(d,{width:u,height:u,data:null},m.RGBA8);k.bind(m.LINEAR,m.CLAMP_TO_EDGE),U=e.hillshadeFBO=d.createFramebuffer(u,u,!0,"renderbuffer"),U.colorAttachment.set(k.texture)}d.bindFramebuffer.set(U.framebuffer),d.viewport.set([0,0,u,u]);let{tileBoundsBuffer:Y,tileBoundsIndexBuffer:y,tileBoundsSegments:B}=r.getMercatorTileBoundsBuffers(),C=[];r.linearFloatFilteringSupported()&&C.push("TERRAIN_DEM_FLOAT_FORMAT"),r.getOrCreateProgram("hillshadePrepare",{defines:C}).draw(r,m.TRIANGLES,Ne.disabled,Le.disabled,ai.unblended,Te.disabled,((k,Q)=>{let z=Q.stride,w=l.a6.mat4.create();return l.a6.mat4.ortho(w,0,l.ab,-l.ab,0,0,1),l.a6.mat4.translate(w,w,[0,-l.ab,0]),{u_matrix:w,u_image:1,u_dimension:[z,z],u_zoom:k.overscaledZ}})(e.tileID,p),a.id,Y,y,B),e.needsHillshadePrepare=!1}class Ji{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(e){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Kc extends Ji{getDefault(){return l.bz.transparent}set(e){let a=this.current;(e.r!==a.r||e.g!==a.g||e.b!==a.b||e.a!==a.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class eh extends Ji{getDefault(){return 1}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1)}}class qc extends Ji{getDefault(){return 0}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1)}}class Gd extends Ji{getDefault(){return[!0,!0,!0,!0]}set(e){let a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class or extends Ji{getDefault(){return!0}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1)}}class ih extends Ji{getDefault(){return 255}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1)}}class ah extends Ji{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(e){let a=this.current;(e.func!==a.func||e.ref!==a.ref||e.mask!==a.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1)}}class nh extends Ji{getDefault(){let e=this.gl;return[e.KEEP,e.KEEP,e.KEEP]}set(e){let a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1)}}class ns extends Ji{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;e?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),this.current=e,this.dirty=!1}}class lh extends Ji{getDefault(){return[0,1]}set(e){let a=this.current;(e[0]!==a[0]||e[1]!==a[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1)}}class Gp extends Ji{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;e?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),this.current=e,this.dirty=!1}}class Fp extends Ji{getDefault(){return this.gl.LESS}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1)}}class Ip extends Ji{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;e?a.enable(a.BLEND):a.disable(a.BLEND),this.current=e,this.dirty=!1}}class $c extends Ji{getDefault(){let e=this.gl;return[e.ONE,e.ZERO,e.ONE,e.ZERO]}set(e){let a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3]||this.dirty)&&(this.gl.blendFuncSeparate(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class tb extends Ji{getDefault(){return l.bz.transparent}set(e){let a=this.current;(e.r!==a.r||e.g!==a.g||e.b!==a.b||e.a!==a.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class eb extends Ji{getDefault(){return this.gl.FUNC_ADD}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(e,e),this.current=e,this.dirty=!1)}}class ib extends Ji{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;e?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),this.current=e,this.dirty=!1}}class oh extends Ji{getDefault(){return this.gl.BACK}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1)}}class sh extends Ji{getDefault(){return this.gl.CCW}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1)}}let Up=class extends Ji{getDefault(){return null}set(r){(r!==this.current||this.dirty)&&(this.gl.useProgram(r),this.current=r,this.dirty=!1)}};class sr extends Ji{getDefault(){return this.gl.TEXTURE0}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1)}}class rr extends Ji{getDefault(){let e=this.gl;return[0,0,e.drawingBufferWidth,e.drawingBufferHeight]}set(e){let a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class rh extends Ji{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,e),this.current=e,this.dirty=!1}}class Rn extends Ji{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;a.bindRenderbuffer(a.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class ab extends Ji{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;a.bindTexture(a.TEXTURE_2D,e),this.current=e,this.dirty=!1}}class Fd extends Ji{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;a.bindBuffer(a.ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Id extends Ji{getDefault(){return null}set(e){let a=this.gl;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class nb extends Ji{getDefault(){return null}set(e){this.gl&&(e!==this.current||this.dirty)&&(this.gl.bindVertexArray(e),this.current=e,this.dirty=!1)}}class lb extends Ji{getDefault(){return 4}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;a.pixelStorei(a.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1}}class Ud extends Ji{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1}}class ob extends Ji{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;let a=this.gl;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1}}class dr extends Ji{constructor(e,a){super(e),this.context=e,this.parent=a}getDefault(){return null}}class xd extends dr{setDirty(){this.dirty=!0}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class sb extends dr{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let a=this.gl;a.framebufferRenderbuffer(a.FRAMEBUFFER,this.attachment(),a.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class dh extends dr{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,this.attachment(),a.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class ls extends sb{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}let xp=(r,e,a)=>({u_matrix:r,u_image0:0,u_skirt_height:e,u_ground_shadow_factor:a}),ch=(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w)=>({u_proj_matrix:Float32Array.from(r),u_globe_matrix:e,u_normalize_matrix:Float32Array.from(d),u_merc_matrix:a,u_zoom_transition:m,u_merc_center:p,u_image0:0,u_frustum_tl:u,u_frustum_tr:U,u_frustum_br:Y,u_frustum_bl:y,u_globe_pos:B,u_globe_radius:C,u_viewport:k,u_grid_matrix:w?Float32Array.from(w):new Float32Array(9),u_skirt_height:Q,u_far_z_cutoff:z});function bh(r,e){return r!=null&&e!=null&&!(!r.hasData()||!e.hasData())&&r.demTexture!=null&&e.demTexture!=null&&r.tileID.key!==e.tileID.key}let os=new class{constructor(){this.operations={}}newMorphing(r,e,a,d,m){if(r in this.operations){let p=this.operations[r];p.to.tileID.key!==a.tileID.key&&(p.queued=a)}else this.operations[r]={startTime:d,phase:0,duration:m,from:e,to:a,queued:null}}getMorphValuesForProxy(r){if(!(r in this.operations))return null;let e=this.operations[r];return{from:e.from,to:e.to,phase:e.phase}}update(r){for(let e in this.operations){let a=this.operations[e];for(a.phase=(r-a.startTime)/a.duration;a.phase>=1||!this._validOp(a);)if(!this._nextOp(a,r)){delete this.operations[e];break}}}_nextOp(r,e){return!!r.queued&&(r.from=r.to,r.to=r.queued,r.queued=null,r.phase=0,r.startTime=e,!0)}_validOp(r){return r.from.hasData()&&r.to.hasData()}},mh={0:null,1:"TERRAIN_VERTEX_MORPHING"};function hh(r,e,a){if(e===0)return 0;let d=e<1&&a===514?.25/e:1;return 6*Math.pow(1.5,22-r)*Math.max(e,1)*d}function rb(r,e){let a=1<<r.z;return!e&&(r.x===0||r.x===a-1)||r.y===0||r.y===a-1}let cr=r=>({u_matrix:r});function Nd(r,e,a,d,m){if(m>0){let p=l.q.now(),u=(p-r.timeAdded)/m,U=e?(p-e.timeAdded)/m:-1,Y=a.getSource(),y=d.coveringZoomLevel({tileSize:Y.tileSize,roundZoom:Y.roundZoom}),B=!e||Math.abs(e.tileID.overscaledZ-y)>Math.abs(r.tileID.overscaledZ-y),C=B&&r.refreshedUponExpiration?1:l.ap(B?u:1-U,0,1);return r.refreshedUponExpiration&&u>=1&&(r.refreshedUponExpiration=!1),e?{opacity:1,mix:1-C}:{opacity:C,mix:0}}return{opacity:1,mix:0}}class ss extends an{constructor(e){let a={type:"raster-dem",maxzoom:e.transform.maxZoom},d=new l.cd(l.ce(),null),m=vo("mock-dem",a,d,e.style);super("mock-dem",m,!1),m.setEventedParent(this),this._sourceLoaded=!0}_loadTile(e,a){e.state="loaded",a(null)}}class ph extends an{constructor(e){let a=vo("proxy",{type:"geojson",maxzoom:e.transform.maxZoom},new l.cd(l.ce(),null),e.style);super("proxy",a,!1),a.setEventedParent(this),this.map=this.getSource().map=e,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(e,a,d){if(e.freezeTileCoverage)return;this.transform=e;let m=e.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((p,u)=>{if(p[u.key]="",!this._tiles[u.key]){let U=new ol(u,this._source.tileSize*u.overscaleFactor(),e.tileZoom);U.state="loaded",this._tiles[u.key]=U}return p},{});for(let p in this._tiles)p in m||(this.freeFBO(p),this._tiles[p].unloadVectorData(),delete this._tiles[p])}freeFBO(e){let a=this.proxyCachedFBO[e];if(a!==void 0){let d=Object.values(a);this.renderCachePool.push(...d),delete this.proxyCachedFBO[e]}}deallocRenderCache(){this.renderCache.forEach(e=>e.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class db extends l.aA{constructor(e,a,d){super(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y),this.proxyTileKey=a,this.projMatrix=d}}class cb extends l.cE{constructor(e,a){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},e.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),e.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),e.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=e,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[d,m,p]=function(Y){let y=new l.a_,B=new l.aO,C=131;y.reserve(17161),B.reserve(33800);let k=l.ab/128,Q=l.ab+k/2,z=Q+k;for(let A=-k;A<z;A+=k)for(let H=-k;H<z;H+=k){let $=H<0||H>Q||A<0||A>Q?24575:0,et=l.ap(Math.round(H),0,l.ab),K=l.ap(Math.round(A),0,l.ab);y.emplaceBack(et+$,K)}let w=(A,H)=>{let $=H*C+A;B.emplaceBack($+1,$,$+C),B.emplaceBack($+C,$+C+1,$+1)};for(let A=1;A<129;A++)for(let H=1;H<129;H++)w(H,A);return[0,129].forEach(A=>{for(let H=0;H<130;H++)w(H,A),w(A,H)}),[y,B,32768]}(),u=e.context;this.gridBuffer=u.createVertexBuffer(d,l.b0.members),this.gridIndexBuffer=u.createIndexBuffer(m),this.gridSegments=l.b1.simpleSegment(0,0,d.length,m.length),this.gridNoSkirtSegments=l.b1.simpleSegment(0,0,d.length,p),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new ph(a.map),this.orthoMatrix=l.a6.mat4.create(),l.a6.mat4.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,l.ab,0,l.ab,0,1);let U=u.gl;this._overlapStencilMode=new Le({func:U.GEQUAL,mask:255},0,255,U.KEEP,U.KEEP,U.REPLACE),this._previousZoom=e.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=a,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new ss(a.map),this._pendingGroundEffectLayers=[]}set style(e){e.on("data",this._onStyleDataEvent.bind(this)),this._style=e,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(e,a,d){if(e&&e.terrain){this._style!==e&&(this.style=e,this._evaluationZoom=void 0);let m=e.terrain.properties,p=e.terrain.drapeRenderMode===0,u=e.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=l.q.now();let U=e.terrain&&e.terrain.scope,Y=m.get("source"),y=p?this._mockSourceCache:e.getSourceCache(Y,U);if(!y)return void l.w(`Couldn't find terrain source "${Y}".`);if(this.sourceCache=y,this._exaggeration=u?this.calculateExaggeration(a):m.get("exaggeration"),!a.projection.requiresDraping&&u&&this._exaggeration===0)return void this._disable();this.enabled=!0;let B=()=>{this.sourceCache.used&&l.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let C=this.getScaledDemTileSize();this.sourceCache.update(a,C,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,B(),this._initializing=!0),B(),a.updateElevation(!0,d),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(a),this._emptyDEMTextureDirty=!0,this._previousZoom=a.zoom}else this._disable()}calculateExaggeration(e){let a=this._previousCameraAltitude,d=e.getFreeCameraOptions().position.z/e.pixelsPerMeter*e.worldSize;this._previousCameraAltitude=d;let m=a!=null?d-a:Number.MAX_VALUE;if(Math.abs(m)<2)return this._exaggeration;let p=e.zoom,u=this._style.terrain;if(!this._previousUpdateTimestamp)return u.getExaggeration(p);let U=p-this._previousZoom,Y=this._previousUpdateTimestamp,y=p;this._evaluationZoom!=null&&(y=this._evaluationZoom,Math.abs(p-y)>.5&&(U=.5*(p-y+U)),U*m<0&&(y+=U)),this._evaluationZoom=y;let B=u.getExaggeration(y),C=B===u.getExaggeration(Math.max(0,y-.1));if(C&&Math.abs(B-this._exaggeration)<.01)return B;let k=Math.min(.1,.00375*(this._updateTimestamp-Y));return(C||B<.1||Math.abs(U)<1e-4)&&(k=Math.min(.2,4*k)),l.aa(this._exaggeration,B,k)}resetTileLookupCache(e){this._findCoveringTileCache[e]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(e){e.coord&&e.dataType==="source"?this._clearRenderCacheForTile(e.sourceCacheId,e.coord):e.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let e in this._style._mergedSourceCaches)this._style._mergedSourceCaches[e].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(e=>e.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let e=2*this.proxySourceCache.getSource().tileSize;return[e,e]}set useVertexMorphing(e){this._useVertexMorphing=e}updateTileBinding(e){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let a=this.proxySourceCache,d=this.painter.transform;this._initializing&&(this._initializing=d._centerAltitude===0&&this.getAtPointOrZero(l.a5.fromLngLat(d.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);let m=this.proxyCoords=a.getIds().map(Y=>{let y=a.getTileByID(Y).tileID;return y.projMatrix=d.calculateProjMatrix(y.toUnwrapped()),y});(function(Y,y){let B=y.transform.pointCoordinate(y.transform.getCameraPoint()),C=new l.P(B.x,B.y);Y.sort((k,Q)=>{if(Q.overscaledZ-k.overscaledZ)return Q.overscaledZ-k.overscaledZ;let z=new l.P(k.canonical.x+(1<<k.canonical.z)*k.wrap,k.canonical.y),w=new l.P(Q.canonical.x+(1<<Q.canonical.z)*Q.wrap,Q.canonical.y),A=C.mult(1<<k.canonical.z);return A.x-=.5,A.y-=.5,A.distSqr(z)-A.distSqr(w)})})(m,this.painter);let p=this.proxyToSource||{};this.proxyToSource={},m.forEach(Y=>{this.proxyToSource[Y.key]={}}),this.terrainTileForTile={};let u=this._style._mergedSourceCaches;for(let Y in u){let y=u[Y];if(!y.used||(y!==this.sourceCache&&this.resetTileLookupCache(y.id),this._setupProxiedCoordsForOrtho(y,e[Y],p),y.usedForTerrain))continue;let B=e[Y];y.getSource().reparseOverscaled&&this._assignTerrainTiles(B)}this.proxiedCoords[a.id]=m.map(Y=>new db(Y,Y.key,this.orthoMatrix)),this._assignTerrainTiles(m),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(p),this.renderingToTexture=!1;let U={};this._visibleDemTiles=[];for(let Y of this.proxyCoords){let y=this.terrainTileForTile[Y.key];if(!y)continue;let B=y.tileID.key;B in U||(this._visibleDemTiles.push(y),U[B]=B)}}_assignTerrainTiles(e){this._initializing||e.forEach(a=>{if(this.terrainTileForTile[a.key])return;let d=this._findTileCoveringTileID(a,this.sourceCache);d&&(this.terrainTileForTile[a.key]=d)})}_prepareDEMTextures(){let e=this.painter.context,a=e.gl;for(let d in this.terrainTileForTile){let m=this.terrainTileForTile[d],p=m.dem;!p||m.demTexture&&!m.needsDEMTextureUpload||(e.activeTexture.set(a.TEXTURE1),Rd(this.painter,m,p))}}_prepareDemTileUniforms(e,a,d,m){if(!a||a.demTexture==null)return!1;let p=e.tileID.canonical,u=Math.pow(2,a.tileID.canonical.z-p.z),U=m||"";return d[`u_dem_tl${U}`]=[p.x*u%1,p.y*u%1],d[`u_dem_scale${U}`]=u,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let e=0,a=this._visibleDemTiles.reduce((d,m)=>{if(!m.dem)return d;let p=m.dem.tree.minimums[0];return p>0&&e++,d+p},0);return e?a/e:0}_updateEmptyDEMTexture(){let e=this.painter.context,a=e.gl;e.activeTexture.set(a.TEXTURE2);let d=this._getLoadedAreaMinimum(),m=new l.cF({width:1,height:1},new Float32Array([d]));this._emptyDEMTextureDirty=!1;let p=this._emptyDEMTexture;return p?p.update(m,{premultiply:!1}):p=this._emptyDEMTexture=new l.T(e,m,a.R32F,{premultiply:!1}),p}setupElevationDraw(e,a,d){let m=this.painter.context,p=m.gl,u={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};u.u_exaggeration=this.exaggeration();let U=null,Y=null,y=1;if(d&&d.morphing&&this._useVertexMorphing){let Q=d.morphing.srcDemTile,z=d.morphing.dstDemTile;y=d.morphing.phase,Q&&z&&(this._prepareDemTileUniforms(e,Q,u,"_prev")&&(Y=Q),this._prepareDemTileUniforms(e,z,u)&&(U=z))}let B=Q=>Q&&Q.demTexture&&this.painter.linearFloatFilteringSupported()?p.LINEAR:p.NEAREST,C=null;var k;if(this.enabled?Y&&U?(C=U.demTexture,m.activeTexture.set(p.TEXTURE4),Y.demTexture.bind(B(Y),p.CLAMP_TO_EDGE),u.u_dem_lerp=y):(U=this.terrainTileForTile[e.tileID.key],C=this._prepareDemTileUniforms(e,U,u)?U.demTexture:this.emptyDEMTexture):C=this.emptyDEMTexture,m.activeTexture.set(p.TEXTURE2),C&&(u.u_dem_size=(k=C).size[0]===1?1:k.size[0]-2,C.bind(B(U),p.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(d&&d.useDepthForOcclusion,a,u),d&&d.useMeterToDem&&U){let Q=(1<<U.tileID.canonical.z)*l.bD(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;u.u_meter_to_dem=Q}if(d&&d.labelPlaneMatrixInv&&(u.u_label_plane_matrix_inv=d.labelPlaneMatrixInv),a.setTerrainUniformValues(m,u),this.painter.transform.projection.name==="globe"){let Q=this.globeUniformValues(this.painter.transform,e.tileID.canonical,d&&d.useDenormalizedUpVectorScale);a.setGlobeUniformValues(m,Q)}}globeUniformValues(e,a,d){let m=e.projection;return{u_tile_tl_up:m.upVector(a,0,0),u_tile_tr_up:m.upVector(a,l.ab,0),u_tile_br_up:m.upVector(a,l.ab,l.ab),u_tile_bl_up:m.upVector(a,0,l.ab),u_tile_up_scale:d?l.cG(1):m.upVectorScale(a,e.center.lat,e.worldSize).metersToTile}}renderToBackBuffer(e){let a=this.painter,d=this.painter.context;e.length!==0&&(d.bindFramebuffer.set(null),d.viewport.set([0,0,a.width,a.height]),a.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(m,p,u,U,Y){if(m.transform.projection.name==="globe")(function(y,B,C,k,Q){let z=y.context,w=z.gl,A,H,$=y.transform,et=l.cx(y,z,$),K=(Nt,St)=>{if(H===St)return;let wt=[mh[St],"PROJECTION_GLOBE_VIEW"];et&&wt.push("CUSTOM_ANTIALIASING");let kt=y.isTileAffectedByFog(Nt);A=y.getOrCreateProgram("globeRaster",{defines:wt,overrideFog:kt}),H=St},nt=y.colorModeForRenderPass(),at=new Ne(w.LEQUAL,Ne.ReadWrite,y.depthRangeFor3D);os.update(Q);let ct=l.cy($),rt=[l.am($.center.lng),l.at($.center.lat)],bt=y.globeSharedBuffers,gt=[$.width*l.q.devicePixelRatio,$.height*l.q.devicePixelRatio],Wt=Float32Array.from($.globeMatrix),ht={useDenormalizedUpVectorScale:!0};{let Nt=y.transform,St=hh(Nt.zoom,B.exaggeration(),B.sourceCache._source.tileSize);H=-1;let wt=w.TRIANGLES;for(let kt of k){let Ot=C.getTile(kt),Yt=Le.disabled,Lt=B.prevTerrainTileForTile[kt.key],vt=B.terrainTileForTile[kt.key];bh(Lt,vt)&&os.newMorphing(kt.key,Lt,vt,Q,250),z.activeTexture.set(w.TEXTURE0),Ot.texture&&Ot.texture.bind(w.LINEAR,w.CLAMP_TO_EDGE);let _t=os.getMorphValuesForProxy(kt.key),qt=_t?1:0;_t&&l.C(ht,{morphing:{srcDemTile:_t.from,dstDemTile:_t.to,phase:l.cw(_t.phase)}});let zt=l.cz(kt.canonical),Ht=l.cA(zt.getCenter().lat),Ue=l.cB(kt.canonical,zt,Ht,Nt.worldSize/Nt._pixelsPerMercatorPixel),ie=l.b5(l.cC(kt.canonical)),be=ch(Nt.expandedFarZProjMatrix,Wt,ct,ie,l.a9(Nt.zoom),rt,Nt.frustumCorners.TL,Nt.frustumCorners.TR,Nt.frustumCorners.BR,Nt.frustumCorners.BL,Nt.globeCenterInViewSpace,Nt.globeRadius,gt,St,Nt._farZ,Ue);if(K(kt,qt),A&&(B.setupElevationDraw(Ot,A,ht),y.uploadCommonUniforms(z,A,kt.toUnwrapped()),bt)){let[Me,ge,Ye]=bt.getGridBuffers(Ht,St!==0);A.draw(y,wt,at,Yt,nt,Te.backCCW,be,"globe_raster",Me,ge,Ye)}}}if(bt&&(y.renderDefaultNorthPole||y.renderDefaultSouthPole)){let Nt=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];et&&Nt.push("CUSTOM_ANTIALIASING"),A=y.getOrCreateProgram("globeRaster",{defines:Nt});for(let St of k){let{x:wt,y:kt,z:Ot}=St.canonical,Yt=kt===0,Lt=kt===(1<<Ot)-1,[vt,_t,qt,zt]=bt.getPoleBuffers(Ot,!1);if(zt&&(Yt||Lt)){let Ht=C.getTile(St);z.activeTexture.set(w.TEXTURE0),Ht.texture&&Ht.texture.bind(w.LINEAR,w.CLAMP_TO_EDGE);let Ue=l.cD(Ot,wt,$),ie=l.b5(l.cC(St.canonical)),be=(Me,ge)=>Me.draw(y,w.TRIANGLES,at,Le.disabled,nt,Te.disabled,ch($.expandedFarZProjMatrix,Ue,Ue,ie,0,rt,$.frustumCorners.TL,$.frustumCorners.TR,$.frustumCorners.BR,$.frustumCorners.BL,$.globeCenterInViewSpace,$.globeRadius,gt,0,$._farZ),"globe_pole_raster",ge,qt,zt);B.setupElevationDraw(Ht,A,ht),y.uploadCommonUniforms(z,A,St.toUnwrapped()),Yt&&y.renderDefaultNorthPole&&be(A,vt),Lt&&y.renderDefaultSouthPole&&(Ue=l.a6.mat4.scale(l.a6.mat4.create(),Ue,[1,-1,1]),be(A,_t))}}}})(m,p,u,U,Y);else{let y=m.context,B=y.gl,C,k,Q=m.shadowRenderer,z=Xl(m,m.longestCutoffRange),w=nt=>{if(k===nt)return;let at=[];at.push(mh[nt]),z.shouldRenderCutoff&&at.push("RENDER_CUTOFF"),C=m.getOrCreateProgram("terrainRaster",{defines:at}),k=nt},A=m.colorModeForRenderPass(),H=new Ne(B.LEQUAL,Ne.ReadWrite,m.depthRangeFor3D);os.update(Y);let $=m.transform,et=hh($.zoom,p.exaggeration(),p.sourceCache._source.tileSize),K=[0,0,0];if(Q){let nt=m.style.directionalLight,at=m.style.ambientLight;nt&&at&&(K=hd(m.style,nt,at))}{k=-1;let nt=B.TRIANGLES,[at,ct]=[p.gridIndexBuffer,p.gridSegments];for(let rt of U){let bt=u.getTile(rt),gt=Le.disabled,Wt=p.prevTerrainTileForTile[rt.key],ht=p.terrainTileForTile[rt.key];bh(Wt,ht)&&os.newMorphing(rt.key,Wt,ht,Y,250),y.activeTexture.set(B.TEXTURE0),bt.texture&&bt.texture.bind(B.LINEAR,B.CLAMP_TO_EDGE);let Nt=os.getMorphValuesForProxy(rt.key),St=Nt?1:0,wt;Nt&&(wt={morphing:{srcDemTile:Nt.from,dstDemTile:Nt.to,phase:l.cw(Nt.phase)}});let kt=xp(rt.projMatrix,rb(rt.canonical,$.renderWorldCopies)?et/10:et,K);if(w(St),!C)continue;p.setupElevationDraw(bt,C,wt);let Ot=rt.toUnwrapped();Q&&Q.setupShadows(Ot,C),m.uploadCommonUniforms(y,C,Ot,null,z),C.draw(m,nt,H,gt,A,Te.backCCW,kt,"terrain_raster",p.gridBuffer,at,ct)}}}}(a,this,this.proxySourceCache,e,this._updateTimestamp),this.renderingToTexture=!0,a.gpuTimingDeferredRenderEnd(),e.splice(0,e.length))}renderBatch(e){if(this._drapedRenderBatches.length===0)return e+1;this.renderingToTexture=!0;let a=this.painter,d=this.painter.context,m=this.proxySourceCache,p=this.proxiedCoords[m.id],u=this._drapedRenderBatches.shift(),U=a.style.order,Y=[],y=0;for(let B of p){let C=m.getTileByID(B.proxyTileKey),k=m.proxyCachedFBO[B.key]?m.proxyCachedFBO[B.key][e]:void 0,Q=k!==void 0?m.renderCache[k]:this.pool[y++],z=k!==void 0;if(C.texture=Q.tex,z&&!Q.dirty){Y.push(C.tileID);continue}let w;d.bindFramebuffer.set(Q.fb.framebuffer),this.renderedToTile=!1,Q.dirty&&(d.clear({color:l.bz.transparent,stencil:0}),Q.dirty=!1);for(let A=u.start;A<=u.end;++A){let H=a.style._mergedLayers[U[A]];if(H.isHidden(a.transform.zoom))continue;let $=a.style.getLayerSourceCache(H),et=$?this.proxyToSource[B.key][$.id]:[B];if(!et)continue;let K=et;d.viewport.set([0,0,Q.fb.width,Q.fb.height]),w!==($?$.id:null)&&(this._setupStencil(Q,et,H,$),w=$?$.id:null),a.renderLayer(a,$,H,K)}if(this._drapedRenderBatches.length===0)for(let A of this._pendingGroundEffectLayers){let H=a.style._mergedLayers[U[A]];if(H.isHidden(a.transform.zoom))continue;let $=a.style.getLayerSourceCache(H),et=$?this.proxyToSource[B.key][$.id]:[B];if(!et)continue;let K=et;d.viewport.set([0,0,Q.fb.width,Q.fb.height]),w!==($?$.id:null)&&(this._setupStencil(Q,et,H,$),w=$?$.id:null),a.renderLayer(a,$,H,K)}this.renderedToTile?(Q.dirty=!0,Y.push(C.tileID)):z||--y,y===5&&(y=0,this.renderToBackBuffer(Y))}return this.renderToBackBuffer(Y),this.renderingToTexture=!1,d.bindFramebuffer.set(null),d.viewport.set([0,0,a.width,a.height]),u.end+1}postRender(){}isLayerOrderingCorrect(e){let a=e.order.length,d=-1,m=a;for(let p=0;p<a;++p)this._style.isLayerDraped(e._mergedLayers[e.order[p]])?d=Math.max(d,p):m=Math.min(m,p);return m>d}getMinElevationBelowMSL(){let e=0;return this._visibleDemTiles.filter(a=>a.dem).forEach(a=>{e=Math.min(e,a.dem.tree.minimums[0])}),e===0?e:(e-30)*this._exaggeration}raycast(e,a,d){if(!this._visibleDemTiles)return null;let m=this._visibleDemTiles.filter(p=>p.dem).map(p=>{let u=p.tileID,U=1<<u.overscaledZ,{x:Y,y}=u.canonical,B=Y/U,C=(Y+1)/U,k=y/U,Q=(y+1)/U;return{minx:B,miny:k,maxx:C,maxy:Q,t:p.dem.tree.raycastRoot(B,k,C,Q,e,a,d),tile:p}});m.sort((p,u)=>(p.t!==null?p.t:Number.MAX_VALUE)-(u.t!==null?u.t:Number.MAX_VALUE));for(let p of m){if(p.t==null)return null;let u=p.tile.dem.tree.raycast(p.minx,p.miny,p.maxx,p.maxy,e,a,d);if(u!=null)return u}return null}_createFBO(){let e=this.painter.context,a=e.gl,d=this.drapeBufferSize;e.activeTexture.set(a.TEXTURE0);let m=new l.T(e,{width:d[0],height:d[1],data:null},a.RGBA8);m.bind(a.LINEAR,a.CLAMP_TO_EDGE);let p=e.createFramebuffer(d[0],d[1],!0,null);return p.colorAttachment.set(m.texture),p.depthAttachment=new ls(e,p.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=e.createRenderbuffer(e.gl.DEPTH_STENCIL,d[0],d[1]),this._stencilRef=0,p.depthAttachment.set(this._sharedDepthStencil),e.clear({stencil:0})):p.depthAttachment.set(this._sharedDepthStencil),e.extTextureFilterAnisotropic&&a.texParameterf(a.TEXTURE_2D,e.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e.extTextureFilterAnisotropicMax),{fb:p,tex:m,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let e in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[e].hasTransition())return!0;return this._style.order.some(e=>{let a=this._style._mergedLayers[e],d=a.isHidden(this.painter.transform.zoom);return a.type==="hillshade"||a.type==="custom"?!d&&a.shouldRedrape():!d&&a.hasTransition()})}_clearLineLayersFromRenderCache(){let e=!1;for(let d of this._style.getSources())if(d instanceof td){e=!0;break}if(!e)return;let a={};for(let d=0;d<this._style.order.length;++d){let m=this._style._mergedLayers[this._style.order[d]],p=this._style.getLayerSourceCache(m);if(p&&!a[p.id]&&!m.isHidden(this.painter.transform.zoom)&&m.type==="line"&&m.widthExpression()instanceof l.a4){a[p.id]=!0;for(let u of this.proxyCoords){let U=this.proxyToSource[u.key][p.id];if(U)for(let Y of U)this._clearRenderCacheForTile(p.id,Y)}}}}_clearRasterLayersFromRenderCache(){let e=!1;for(let d in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[d]._source instanceof Ds){e=!0;break}if(!e)return;let a={};for(let d=0;d<this._style.order.length;++d){let m=this._style._mergedLayers[this._style.order[d]],p=this._style.getLayerSourceCache(m);if(!p||a[p.id]||m.isHidden(this.painter.transform.zoom)||m.type!=="raster")continue;let u=m.paint.get("raster-fade-duration");for(let U of this.proxyCoords){let Y=this.proxyToSource[U.key][p.id];if(Y)for(let y of Y){let B=Nd(p.getTile(y),p.findLoadedParent(y,0),p,this.painter.transform,u);(B.opacity!==1||B.mix!==0)&&this._clearRenderCacheForTile(p.id,y)}}}}_setupDrapedRenderBatches(){let e=this._style.order,a=e.length;if(a===0)return;let d=[];this._pendingGroundEffectLayers=[];let m,p=0,u=this._style._mergedLayers[e[p]];for(;!this._style.isLayerDraped(u)&&u.isHidden(this.painter.transform.zoom)&&++p<a;)u=this._style._mergedLayers[e[p]];for(;p<a;++p){let U=this._style._mergedLayers[e[p]];U.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(U)?m===void 0&&(m=p):(U.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(p),m!==void 0&&(d.push({start:m,end:p-1}),m=void 0)))}if(m!==void 0&&d.push({start:m,end:p-1}),d.length!==0){let U=d[d.length-1];this._pendingGroundEffectLayers.every(Y=>Y>U.end)||l.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=d}_setupRenderCache(e){let a=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,a.renderCache.length>a.renderCachePool.length){let u=Object.values(a.proxyCachedFBO);a.proxyCachedFBO={};for(let U=0;U<u.length;++U){let Y=Object.values(u[U]);a.renderCachePool.push(...Y)}}return}this._clearRasterLayersFromRenderCache();let d=this.proxyCoords,m=this._tilesDirty;for(let u=d.length-1;u>=0;u--){let U=d[u];if(a.getTileByID(U.key),a.proxyCachedFBO[U.key]!==void 0){let Y=e[U.key],y=this.proxyToSource[U.key],B=0;for(let C in y){let k=y[C],Q=Y[C];if(!Q||Q.length!==k.length||k.some((z,w)=>z!==Q[w]||m[C]&&m[C].hasOwnProperty(z.key))){B=-1;break}++B}for(let C in a.proxyCachedFBO[U.key])a.renderCache[a.proxyCachedFBO[U.key][C]].dirty=B<0||B!==Object.values(Y).length}}let p=[...this._drapedRenderBatches];p.sort((u,U)=>U.end-U.start-(u.end-u.start));for(let u of p)for(let U of d){if(a.proxyCachedFBO[U.key])continue;let Y=a.renderCachePool.pop();Y===void 0&&a.renderCache.length<50&&(Y=a.renderCache.length,a.renderCache.push(this._createFBO())),Y!==void 0&&(a.proxyCachedFBO[U.key]={},a.proxyCachedFBO[U.key][u.start]=Y,a.renderCache[Y].dirty=!0)}this._tilesDirty={}}_setupStencil(e,a,d,m){if(!m||!this._sourceTilesOverlap[m.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let p=this.painter.context,u=p.gl;if(a.length<=1)return void(this._overlapStencilType=!1);let U;if(d.isTileClipped())U=a.length,this._overlapStencilMode.test={func:u.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(a[0].overscaledZ>a[a.length-1].overscaledZ))return void(this._overlapStencilType=!1);U=1,this._overlapStencilMode.test={func:u.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+U>255&&(p.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=U,this._overlapStencilMode.ref=this._stencilRef,d.isTileClipped()&&this._renderTileClippingMasks(a,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(e){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[e.key]),this._overlapStencilMode):Le.disabled}_renderTileClippingMasks(e,a){let d=this.painter,m=this.painter.context,p=m.gl;d._tileClippingMaskIDs={},m.setColorMode(ai.disabled),m.setDepthMode(Ne.disabled);let u=d.getOrCreateProgram("clippingMask");for(let U of e){let Y=d._tileClippingMaskIDs[U.key]=--a;u.draw(d,p.TRIANGLES,Ne.disabled,new Le({func:p.ALWAYS,mask:0},Y,255,p.KEEP,p.KEEP,p.REPLACE),ai.disabled,Te.disabled,cr(U.projMatrix),"$clipping",d.tileExtentBuffer,d.quadTriangleIndexBuffer,d.tileExtentSegments)}}pointCoordinate(e){let a=this.painter.transform;if(e.x<0||e.x>a.width||e.y<0||e.y>a.height)return null;let d=[e.x,e.y,1,1];l.a6.vec4.transformMat4(d,d,a.pixelMatrixInverse),l.a6.vec4.scale(d,d,1/d[3]),d[0]/=a.worldSize,d[1]/=a.worldSize;let m=a._camera.position,p=l.bD(1,a.center.lat),u=[m[0],m[1],m[2]/p,0],U=l.a6.vec3.subtract([],d.slice(0,3),u);l.a6.vec3.normalize(U,U);let Y=this.raycast(u,U,this._exaggeration);return Y!==null&&Y?(l.a6.vec3.scaleAndAdd(u,u,U,Y),u[3]=u[2],u[2]*=p,u):null}_setupProxiedCoordsForOrtho(e,a,d){if(e.getSource()instanceof l.aD)return this._setupProxiedCoordsForImageSource(e,a,d);this._findCoveringTileCache[e.id]=this._findCoveringTileCache[e.id]||{};let m=this.proxiedCoords[e.id]=[],p=this.proxyCoords;for(let Y=0;Y<p.length;Y++){let y=p[Y],B=this._findTileCoveringTileID(y,e);if(B){let C=this._createProxiedId(y,B,d[y.key]&&d[y.key][e.id]);m.push(C),this.proxyToSource[y.key][e.id]=[C]}}let u=!1,U=new Set;for(let Y=0;Y<a.length;Y++){let y=e.getTile(a[Y]);if(!y||!y.hasData())continue;let B=this._findTileCoveringTileID(y.tileID,this.proxySourceCache);if(B&&B.tileID.canonical.z!==y.tileID.canonical.z){let C=this.proxyToSource[B.tileID.key][e.id],k=this._createProxiedId(B.tileID,y,d[B.tileID.key]&&d[B.tileID.key][e.id]);C?C.splice(C.length-1,0,k):this.proxyToSource[B.tileID.key][e.id]=[k];let Q=this.proxyToSource[B.tileID.key][e.id];U.has(Q)||U.add(Q),m.push(k),u=!0}}if(this._sourceTilesOverlap[e.id]=u,u&&this._debugParams.sortTilesHiZFirst)for(let Y of U)Y.sort((y,B)=>B.overscaledZ-y.overscaledZ)}_setupProxiedCoordsForImageSource(e,a,d){if(!e.getSource().loaded())return;let m=this.proxiedCoords[e.id]=[],p=this.proxyCoords,u=e.getSource(),U=u.tileID;if(!U)return;let Y=new l.P(U.x,U.y)._div(1<<U.z),y=u.coordinates.map(l.a5.fromLngLat).reduce((C,k)=>(C.min.x=Math.min(C.min.x,k.x-Y.x),C.min.y=Math.min(C.min.y,k.y-Y.y),C.max.x=Math.max(C.max.x,k.x-Y.x),C.max.y=Math.max(C.max.y,k.y-Y.y),C),{min:new l.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new l.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),B=(C,k)=>{let Q=C.wrap+C.canonical.x/(1<<C.canonical.z),z=C.canonical.y/(1<<C.canonical.z),w=l.ab/(1<<C.canonical.z),A=k.wrap+k.canonical.x/(1<<k.canonical.z),H=k.canonical.y/(1<<k.canonical.z);return Q+w<A+y.min.x||Q>A+y.max.x||z+w<H+y.min.y||z>H+y.max.y};for(let C=0;C<p.length;C++){let k=p[C];for(let Q=0;Q<a.length;Q++){let z=e.getTile(a[Q]);if(!z||!z.hasData()||B(k,z.tileID))continue;let w=this._createProxiedId(k,z,d[k.key]&&d[k.key][e.id]),A=this.proxyToSource[k.key][e.id];A?A.push(w):this.proxyToSource[k.key][e.id]=[w],m.push(w)}}}_createProxiedId(e,a,d){let m=this.orthoMatrix;if(d){let p=d.find(u=>u.key===a.tileID.key);if(p)return p}if(a.tileID.key!==e.key){let p=e.canonical.z-a.tileID.canonical.z,u,U,Y;m=l.a6.mat4.create();let y=a.tileID.wrap-e.wrap<<e.overscaledZ;p>0?(u=l.ab>>p,U=u*((a.tileID.canonical.x<<p)-e.canonical.x+y),Y=u*((a.tileID.canonical.y<<p)-e.canonical.y)):(u=l.ab<<-p,U=l.ab*(a.tileID.canonical.x-(e.canonical.x+y<<-p)),Y=l.ab*(a.tileID.canonical.y-(e.canonical.y<<-p))),l.a6.mat4.ortho(m,0,u,0,u,0,1),l.a6.mat4.translate(m,m,[U,Y,0])}return new db(a.tileID,e.key,m)}_findTileCoveringTileID(e,a){let d=a.getTile(e);if(d&&d.hasData())return d;let m=this._findCoveringTileCache[a.id],p=m[e.key];if(d=p?a.getTileByID(p):null,d&&d.hasData()||p===null)return d;let u=d?d.tileID:e,U=u.overscaledZ,Y=a.getSource().minzoom,y=[];if(!p){let C=a.getSource().maxzoom;if(e.canonical.z>=C){let k=e.canonical.z-C;a.getSource().reparseOverscaled?(U=Math.max(e.canonical.z+2,a.transform.tileZoom),u=new l.aA(U,e.wrap,C,e.canonical.x>>k,e.canonical.y>>k)):k!==0&&(U=C,u=new l.aA(U,e.wrap,C,e.canonical.x>>k,e.canonical.y>>k))}u.key!==e.key&&(y.push(u.key),d=a.getTile(u))}let B=C=>{y.forEach(k=>{m[k]=C}),y.length=0};for(U-=1;U>=Y&&(!d||!d.hasData());U--){d&&B(d.tileID.key);let C=u.calculateScaledKey(U);if(d=a.getTileByID(C),d&&d.hasData())break;let k=m[C];if(k===null)break;k===void 0?y.push(C):d=a.getTileByID(k)}return B(d?d.tileID.key:null),d&&d.hasData()?d:null}findDEMTileFor(e){return this.enabled?this._findTileCoveringTileID(e,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(e,a){let d=this._tilesDirty[e];d||(d=this._tilesDirty[e]={}),d[a.key]=!0}}function bb(r,e,a){let d=function(U,Y,y){let B=l.a6.vec3.dot(Y,U),C=l.a6.vec3.dot(y,[.2126,.7152,.0722]),k=(z,w,A)=>(1-A)*z+A*w,Q=k(1-.3*Math.min(C,1),1,Math.min(B+1,1));return k(.92,1,Math.asin(l.ap(Y[2],-1,1))/Math.PI+.5)*Q}(r,[0,0,1],e),m=[0,0,0];l.a6.vec3.scale(m,a.slice(0,3),d);let p=[0,0,0];l.a6.vec3.scale(p,e.slice(0,3),r[2]);let u=[0,0,0];return l.a6.vec3.add(u,m,p),l.cb(u)}let go=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Wh=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbol"];class Pl{static cacheKey(e,a,d,m){let p=`${a}${m?m.cacheKey:""}`;for(let u of d)e.usedDefines.includes(u)&&(p+=`/${u}`);return p}constructor(e,a,d,m,p,u){let U=e.gl;this.program=U.createProgram(),this.configuration=m,this.name=a,this.fixedDefines=[...u];let Y=m?m.getBinderAttributes():[],y=(d.staticAttributes||[]).concat(Y),B=m?m.defines():[];B=B.concat(u.map(A=>`#define ${A}`));let C=`#version 300 es
`,k=C+B.concat("precision mediump float;",gd,ar.fragmentSource).join(`
`);for(let A of d.fragmentIncludes)k+=`
${ir[A]}`;k+=`
${d.fragmentSource}`;let Q=C+B.concat("precision highp float;",gd,ar.vertexSource).join(`
`);for(let A of d.vertexIncludes)Q+=`
${ir[A]}`;Q+=`
${d.vertexSource}`;let z=U.createShader(U.FRAGMENT_SHADER);if(U.isContextLost())return void(this.failedToCreate=!0);U.shaderSource(z,k),U.compileShader(z),U.attachShader(this.program,z);let w=U.createShader(U.VERTEX_SHADER);if(U.isContextLost())this.failedToCreate=!0;else{U.shaderSource(w,Q),U.compileShader(w),U.attachShader(this.program,w),this.attributes={},this.numAttributes=y.length;for(let A=0;A<this.numAttributes;A++)if(y[A]){let H=y[A].startsWith("a_")?y[A]:`a_${y[A]}`;U.bindAttribLocation(this.program,A,H),this.attributes[H]=A}U.linkProgram(this.program),U.deleteShader(w),U.deleteShader(z),this.fixedUniforms=p(e),this.binderUniforms=m?m.getUniforms(e):[],(u.includes("TERRAIN")||a.indexOf("symbol")!==-1||a.indexOf("circle")!==-1)&&(this.terrainUniforms=(A=>({u_dem:new l.bJ(A),u_dem_prev:new l.bJ(A),u_dem_tl:new l.bG(A),u_dem_scale:new l.bI(A),u_dem_tl_prev:new l.bG(A),u_dem_scale_prev:new l.bI(A),u_dem_size:new l.bI(A),u_dem_lerp:new l.bI(A),u_exaggeration:new l.bI(A),u_depth:new l.bJ(A),u_depth_size_inv:new l.bG(A),u_depth_range_unpack:new l.bG(A),u_occluder_half_size:new l.bI(A),u_occlusion_depth_offset:new l.bI(A),u_meter_to_dem:new l.bI(A),u_label_plane_matrix_inv:new l.bF(A)}))(e)),u.includes("GLOBE")&&(this.globeUniforms=(A=>({u_tile_tl_up:new l.bH(A),u_tile_tr_up:new l.bH(A),u_tile_br_up:new l.bH(A),u_tile_bl_up:new l.bH(A),u_tile_up_scale:new l.bI(A)}))(e)),u.includes("FOG")&&(this.fogUniforms=(A=>({u_fog_matrix:new l.bF(A),u_fog_range:new l.bG(A),u_fog_color:new l.c6(A),u_fog_horizon_blend:new l.bI(A),u_fog_vertical_limit:new l.bG(A),u_fog_temporal_offset:new l.bI(A),u_frustum_tl:new l.bH(A),u_frustum_tr:new l.bH(A),u_frustum_br:new l.bH(A),u_frustum_bl:new l.bH(A),u_globe_pos:new l.bH(A),u_globe_radius:new l.bI(A),u_globe_transition:new l.bI(A),u_is_globe:new l.bJ(A),u_viewport:new l.bG(A)}))(e)),u.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(A=>({u_cutoff_params:new l.c6(A)}))(e)),u.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(A=>({u_lighting_ambient_color:new l.bH(A),u_lighting_directional_dir:new l.bH(A),u_lighting_directional_color:new l.bH(A),u_ground_radiance:new l.bH(A)}))(e)),u.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(A=>({u_light_matrix_0:new l.bF(A),u_light_matrix_1:new l.bF(A),u_fade_range:new l.bG(A),u_shadow_normal_offset:new l.bH(A),u_shadow_intensity:new l.bI(A),u_shadow_texel_size:new l.bI(A),u_shadow_map_resolution:new l.bI(A),u_shadow_direction:new l.bH(A),u_shadow_bias:new l.bH(A),u_shadowmap_0:new l.bJ(A),u_shadowmap_1:new l.bJ(A)}))(e))}}setTerrainUniformValues(e,a){if(!this.terrainUniforms)return;let d=this.terrainUniforms;if(!this.failedToCreate){e.program.set(this.program);for(let m in a)d[m]&&d[m].set(this.program,m,a[m])}}setGlobeUniformValues(e,a){if(!this.globeUniforms)return;let d=this.globeUniforms;if(!this.failedToCreate){e.program.set(this.program);for(let m in a)d[m]&&d[m].set(this.program,m,a[m])}}setFogUniformValues(e,a){if(!this.fogUniforms)return;let d=this.fogUniforms;if(!this.failedToCreate){e.program.set(this.program);for(let m in a)d[m].set(this.program,m,a[m])}}setCutoffUniformValues(e,a){if(!this.cutoffUniforms)return;let d=this.cutoffUniforms;if(!this.failedToCreate){e.program.set(this.program);for(let m in a)d[m].set(this.program,m,a[m])}}setLightsUniformValues(e,a){if(!this.lightsUniforms)return;let d=this.lightsUniforms;if(!this.failedToCreate){e.program.set(this.program);for(let m in a)d[m].set(this.program,m,a[m])}}setShadowUniformValues(e,a){if(this.failedToCreate||!this.shadowUniforms)return;let d=this.shadowUniforms;e.program.set(this.program);for(let m in a)d[m].set(this.program,m,a[m])}_drawDebugWireframe(e,a,d,m,p,u,U,Y,y,B){let C=e.options.wireframe;if(C.terrain===!1&&C.layers2D===!1&&C.layers3D===!1)return;let k=e.context;if(!(!(!C.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!C.layers2D||e._terrain&&e._terrain.renderingToTexture||!go.includes(this.name))||!(!C.layers3D||!Wh.includes(this.name))))return;let Q=k.gl,z=e.wireframeDebugCache.getLinesFromTrianglesBuffer(e.frameCounter,p,k);if(!z)return;let w=[...this.fixedDefines];w.push("DEBUG_WIREFRAME");let A=e.getOrCreateProgram(this.name,{config:this.configuration,defines:w});k.program.set(A.program);let H=(K,nt,at)=>{if(nt[K]&&at[K])for(let ct in nt[K])at[K][ct]&&at[K][ct].set(at.program,ct,nt[K][ct].current)};y&&y.setUniforms(A.program,k,A.binderUniforms,U,{zoom:Y}),H("fixedUniforms",this,A),H("terrainUniforms",this,A),H("globeUniforms",this,A),H("fogUniforms",this,A),H("lightsUniforms",this,A),H("shadowUniforms",this,A),z.bind(),k.setColorMode(new ai([Q.ONE,Q.ONE_MINUS_SRC_ALPHA,Q.ZERO,Q.ONE],l.bz.transparent,[!0,!0,!0,!1])),k.setDepthMode(new Ne(a.func===Q.LESS?Q.LEQUAL:a.func,Ne.ReadOnly,a.range)),k.setStencilMode(Le.disabled);let $=3*u.primitiveLength*2,et=3*u.primitiveOffset*2*2;B&&B>1?Q.drawElementsInstanced(Q.LINES,$,Q.UNSIGNED_SHORT,et,B):Q.drawElements(Q.LINES,$,Q.UNSIGNED_SHORT,et),p.bind(),k.program.set(this.program),k.setDepthMode(a),k.setStencilMode(d),k.setColorMode(m)}draw(e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w,A){let H=e.context,$=H.gl;if(this.failedToCreate)return;H.program.set(this.program),H.setDepthMode(d),H.setStencilMode(m),H.setColorMode(p),H.setCullFace(u);for(let nt of Object.keys(this.fixedUniforms))this.fixedUniforms[nt].set(this.program,nt,U[nt]);z&&z.setUniforms(this.program,H,this.binderUniforms,k,{zoom:Q});let et={[$.POINTS]:1,[$.LINES]:2,[$.TRIANGLES]:3,[$.LINE_STRIP]:1}[a],K=A&&A>0?1:void 0;for(let nt of C.get()){let at=nt.vaos||(nt.vaos={});(at[Y]||(at[Y]=new as)).bind(H,this,y,z?z.getPaintVertexBuffers():[],B,nt.vertexOffset,w||[],K),A&&A>1?$.drawElementsInstanced(a,nt.primitiveLength*et,$.UNSIGNED_SHORT,nt.primitiveOffset*et*2,A):B?$.drawElements(a,nt.primitiveLength*et,$.UNSIGNED_SHORT,nt.primitiveOffset*et*2):$.drawArrays(a,nt.vertexOffset,nt.vertexLength),a===$.TRIANGLES&&B&&this._drawDebugWireframe(e,d,m,p,B,nt,k,Q,z,A)}}}function mb(r,e){let a=Math.pow(2,e.tileID.overscaledZ),d=e.tileSize*Math.pow(2,r.transform.tileZoom)/a,m=d*(e.tileID.canonical.x+e.tileID.wrap*a),p=d*e.tileID.canonical.y;return{u_image:0,u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/l.ak(e,1,r.transform.tileZoom),u_pixel_coord_upper:[m>>16,p>>16],u_pixel_coord_lower:[65535&m,65535&p]}}let Yd=l.a6.mat4.create(),hb=(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w)=>{let A=e.style.light,H=A.properties.get("position"),$=[H.x,H.y,H.z],et=l.a6.mat3.create();A.properties.get("anchor")==="viewport"&&(l.a6.mat3.fromRotation(et,-e.transform.angle),l.a6.vec3.transformMat3($,$,et));let K=A.properties.get("color"),nt=e.transform,at={u_matrix:r,u_lightpos:$,u_lightintensity:A.properties.get("intensity"),u_lightcolor:[K.r,K.g,K.b],u_vertical_gradient:+a,u_opacity:d,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Yd,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:m,u_edge_radius:p,u_width_scale:u,u_flood_light_color:k,u_vertical_scale:Q,u_flood_light_intensity:z,u_ground_shadow_factor:w};return nt.projection.name==="globe"&&(at.u_tile_id=[U.canonical.x,U.canonical.y,1<<U.canonical.z],at.u_zoom_transition=y,at.u_inv_rot_matrix=C,at.u_merc_center=B,at.u_up_dir=nt.projection.upVector(new l.bP(0,0,0),B[0]*l.ab,B[1]*l.ab),at.u_height_lift=Y),at},uh=(r,e,a,d)=>({u_matrix:r,u_edge_radius:e,u_width_scale:a,u_vertical_scale:d}),pb=(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q,z)=>{let w=hb(r,e,a,d,m,p,u,U,y,B,C,k,Q,z,1,[0,0,0]),A={u_height_factor:-Math.pow(2,U.overscaledZ)/Y.tileSize/8};return l.l(w,mb(e,Y),A)},Jd=(r,e)=>({u_matrix:r,u_emissive_strength:e}),Zh=(r,e,a,d)=>l.l(Jd(r,e),mb(a,d)),gh=(r,e,a)=>({u_matrix:r,u_world:a,u_emissive_strength:e}),br=(r,e,a,d,m)=>l.l(Zh(r,e,a,d),{u_world:m}),Np=(r,e,a,d)=>{let m=l.ab/a.tileSize;return{u_matrix:r,u_camera_to_center_distance:e.getCameraToCenterDistance(d),u_extrude_scale:[e.pixelsToGLUnits[0]/m,e.pixelsToGLUnits[1]/m]}},Vh=(r,e,a=1)=>({u_matrix:r,u_color:e.toRenderColor(null),u_overlay:0,u_overlay_scale:a}),Rh=l.a6.mat4.create(),Yp=(r,e,a,d,m,p,u)=>{let U=r.transform,Y=U.projection.name==="globe",y=Y?l.cI(U.zoom,e.canonical)*U._pixelsPerMercatorPixel:l.ak(a,1,p),B={u_matrix:e.projMatrix,u_extrude_scale:y,u_intensity:u,u_inv_rot_matrix:Rh,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(Y){B.u_inv_rot_matrix=d,B.u_merc_center=m,B.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],B.u_zoom_transition=l.a9(U.zoom);let C=m[0]*l.ab,k=m[1]*l.ab;B.u_up_dir=U.projection.upVector(new l.bP(0,0,0),C,k)}return B};function Xd(r,[e,a,d,m],[p,u]){if(p===u)return[0,0,0,0];let U=255*(r-1)/(r*(u-p));return[e*U,a*U,d*U,m*U]}function yd(r,e,[a,d]){return a===d?0:.5/r+(e-a)*(r-1)/(r*(d-a))}let mr=(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w,A,H,$,et,K)=>({u_matrix:r,u_normalize_matrix:e,u_globe_matrix:a,u_merc_matrix:d,u_grid_matrix:m,u_tl_parent:p,u_scale_parent:y,u_fade_t:B.mix,u_opacity:B.opacity*C.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:C.paint.get("raster-brightness-min"),u_brightness_high:C.paint.get("raster-brightness-max"),u_saturation_factor:l.cJ(C.paint.get("raster-saturation")),u_contrast_factor:l.cK(C.paint.get("raster-contrast")),u_spin_weights:Wb(C.paint.get("raster-hue-rotate")),u_perspective_transform:k,u_raster_elevation:Q,u_zoom_transition:u,u_merc_center:U,u_cutoff_params:Y,u_colorization_mix:Xd(l.cL,w,H),u_colorization_offset:yd(l.cL,A,H),u_color_ramp:z,u_texture_offset:[et/($+2*et),$/($+2*et)],u_texture_res:[$+2*et,$+2*et],u_emissive_strength:K});function Wb(r){r*=Math.PI/180;let e=Math.sin(r),a=Math.cos(r);return[(2*a+1)/3,(-Math.sqrt(3)*e-a+1)/3,(Math.sqrt(3)*e-a+1)/3]}let dl=.05,Gh=(r,e,a,d,m,p,u,U,Y,y,B,C)=>({u_matrix:r,u_normalize_matrix:e,u_globe_matrix:a,u_merc_matrix:d,u_grid_matrix:m,u_tl_parent:p,u_scale_parent:y,u_fade_t:B.mix,u_opacity:B.opacity,u_image0:0,u_image1:1,u_raster_elevation:C,u_zoom_transition:u,u_merc_center:U,u_cutoff_params:Y}),Bd=(r,e,a,d,m,p,u,U,Y,y)=>({u_particle_texture:r,u_particle_texture_side_len:e,u_tile_offset:a,u_velocity:d,u_color_ramp:p,u_velocity_res:m,u_max_speed:u,u_uv_offset:U,u_data_scale:[255*Y[0],255*Y[1]],u_data_offset:y,u_particle_pos_scale:1.1,u_particle_pos_offset:[dl,dl]}),Md=(r,e,a,d,m,p,u,U,Y,y)=>({u_particle_texture:r,u_particle_texture_side_len:e,u_velocity:a,u_velocity_res:d,u_max_speed:m,u_speed_factor:p,u_reset_rate:u,u_rand_seed:Math.random(),u_uv_offset:U,u_data_scale:[255*Y[0],255*Y[1]],u_data_offset:y,u_particle_pos_scale:1.1,u_particle_pos_offset:[dl,dl]}),Td=l.a6.mat4.create(),ub=(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w,A,H,$,et,K)=>{let nt=m.transform,at={u_is_size_zoom_constant:+(r==="constant"||r==="source"),u_is_size_feature_constant:+(r==="constant"||r==="camera"),u_size_t:e?e.uSizeT:0,u_size:e?e.uSize:0,u_camera_to_center_distance:nt.getCameraToCenterDistance($),u_rotate_symbol:+a,u_aspect_ratio:nt.width/nt.height,u_fade_change:m.options.fadeDuration?m.symbolFadeChange:1,u_matrix:p,u_label_plane_matrix:u,u_coord_matrix:U,u_is_text:+y,u_elevation_from_sea:Y?1:0,u_pitch_with_map:+d,u_texsize:B,u_texsize_icon:C,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Td,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Td,u_up_vector:[0,-1,0],u_color_adj_mat:et,u_icon_transition:K||0,u_gamma_scale:d?m.transform.getCameraToCenterDistance($)*Math.cos(m.terrain?0:m.transform._pitch):1,u_device_pixel_ratio:l.q.devicePixelRatio,u_is_halo:+k};return $.name==="globe"&&(at.u_tile_id=[Q.canonical.x,Q.canonical.y,1<<Q.canonical.z],at.u_zoom_transition=z,at.u_inv_rot_matrix=A,at.u_merc_center=w,at.u_camera_forward=nt._camera.forward(),at.u_ecef_origin=l.cM(nt.globeMatrix,Q.toUnwrapped()),at.u_tile_matrix=Float32Array.from(nt.globeMatrix),at.u_up_vector=H),at},Fh=(r,e,a,d)=>({u_matrix:r,u_emissive_strength:e,u_opacity:a,u_color:d}),Vo=(r,e,a,d,m,p,u,U,Y)=>l.l(function(y,B,C,k,Q,z){let{width:w,height:A}=k.imageManager.getPixelSize(B),H=Math.pow(2,z.tileID.overscaledZ),$=z.tileSize*Math.pow(2,k.transform.tileZoom)/H,et=$*(z.tileID.canonical.x+z.tileID.wrap*H),K=$*z.tileID.canonical.y;return{u_image:0,u_pattern_tl:C.tl,u_pattern_br:C.br,u_texsize:[w,A],u_pattern_size:C.displaySize,u_pattern_units_to_pixels:Q?[k.transform.width,-1*k.transform.height]:[1/l.ak(z,1,k.transform.tileZoom),1/l.ak(z,1,k.transform.tileZoom)],u_pixel_coord_upper:[et>>16,K>>16],u_pixel_coord_lower:[65535&et,65535&K]}}(0,p,u,d,U,Y),{u_matrix:r,u_emissive_strength:e,u_opacity:a}),rs=new Float32Array(l.a6.mat4.identity([])),he=(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q=[0,0,0],z)=>{let w=m.style.light,A=w.properties.get("position"),H=[-A.x,-A.y,A.z],$=l.a6.mat3.create();w.properties.get("anchor")==="viewport"&&(l.a6.mat3.fromRotation($,-m.transform.angle),l.a6.vec3.transformMat3(H,H,$));let et=B.alphaMode==="MASK",K=w.properties.get("color").toRenderColor(null),nt=k.paint.get("model-ambient-occlusion-intensity"),at=k.paint.get("model-color").constantOr(l.bz.white).toRenderColor(null),ct=k.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:r,u_lighting_matrix:e,u_normal_matrix:a,u_node_matrix:d||rs,u_lightpos:H,u_lightintensity:w.properties.get("intensity"),u_lightcolor:[K.r,K.g,K.b],u_camera_pos:Q,u_opacity:p,u_baseTextureIsAlpha:0,u_alphaMask:+et,u_alphaCutoff:B.alphaCutoff,u_baseColorFactor:[u.r,u.g,u.b,u.a],u_emissiveFactor:[U[0],U[1],U[2],1],u_metallicFactor:Y,u_roughnessFactor:y,u_baseColorTexture:Ba.BaseColor,u_metallicRoughnessTexture:Ba.MetallicRoughness,u_normalTexture:Ba.Normal,u_occlusionTexture:Ba.Occlusion,u_emissionTexture:Ba.Emission,u_lutTexture:Ba.LUT,u_color_mix:[at.r,at.g,at.b,ct],u_aoIntensity:nt,u_emissive_strength:C,u_occlusionTextureTransform:z||[0,0,0,0]}},Zb=(r,e=rs,a=rs)=>({u_matrix:r,u_instance:e,u_node_matrix:a}),Ih={fillExtrusion:r=>({u_matrix:new l.bF(r),u_lightpos:new l.bH(r),u_lightintensity:new l.bI(r),u_lightcolor:new l.bH(r),u_vertical_gradient:new l.bI(r),u_opacity:new l.bI(r),u_edge_radius:new l.bI(r),u_width_scale:new l.bI(r),u_ao:new l.bG(r),u_tile_id:new l.bH(r),u_zoom_transition:new l.bI(r),u_inv_rot_matrix:new l.bF(r),u_merc_center:new l.bG(r),u_up_dir:new l.bH(r),u_height_lift:new l.bI(r),u_flood_light_color:new l.bH(r),u_vertical_scale:new l.bI(r),u_flood_light_intensity:new l.bI(r),u_ground_shadow_factor:new l.bH(r)}),fillExtrusionDepth:r=>({u_matrix:new l.bF(r),u_edge_radius:new l.bI(r),u_width_scale:new l.bI(r),u_vertical_scale:new l.bI(r)}),fillExtrusionPattern:r=>({u_matrix:new l.bF(r),u_lightpos:new l.bH(r),u_lightintensity:new l.bI(r),u_lightcolor:new l.bH(r),u_vertical_gradient:new l.bI(r),u_height_factor:new l.bI(r),u_edge_radius:new l.bI(r),u_width_scale:new l.bI(r),u_ao:new l.bG(r),u_tile_id:new l.bH(r),u_zoom_transition:new l.bI(r),u_inv_rot_matrix:new l.bF(r),u_merc_center:new l.bG(r),u_up_dir:new l.bH(r),u_height_lift:new l.bI(r),u_image:new l.bJ(r),u_texsize:new l.bG(r),u_pixel_coord_upper:new l.bG(r),u_pixel_coord_lower:new l.bG(r),u_tile_units_to_pixels:new l.bI(r),u_opacity:new l.bI(r)}),fillExtrusionGroundEffect:r=>({u_matrix:new l.bF(r),u_opacity:new l.bI(r),u_ao_pass:new l.bI(r),u_meter_to_tile:new l.bI(r),u_ao:new l.bG(r),u_flood_light_intensity:new l.bI(r),u_flood_light_color:new l.bH(r),u_attenuation:new l.bI(r),u_edge_radius:new l.bI(r),u_fb:new l.bJ(r),u_fb_size:new l.bI(r),u_dynamic_offset:new l.bI(r)}),fill:r=>({u_matrix:new l.bF(r),u_emissive_strength:new l.bI(r)}),fillPattern:r=>({u_matrix:new l.bF(r),u_emissive_strength:new l.bI(r),u_image:new l.bJ(r),u_texsize:new l.bG(r),u_pixel_coord_upper:new l.bG(r),u_pixel_coord_lower:new l.bG(r),u_tile_units_to_pixels:new l.bI(r)}),fillOutline:r=>({u_matrix:new l.bF(r),u_emissive_strength:new l.bI(r),u_world:new l.bG(r)}),fillOutlinePattern:r=>({u_matrix:new l.bF(r),u_emissive_strength:new l.bI(r),u_world:new l.bG(r),u_image:new l.bJ(r),u_texsize:new l.bG(r),u_pixel_coord_upper:new l.bG(r),u_pixel_coord_lower:new l.bG(r),u_tile_units_to_pixels:new l.bI(r)}),circle:l.cN,collisionBox:r=>({u_matrix:new l.bF(r),u_camera_to_center_distance:new l.bI(r),u_extrude_scale:new l.bG(r)}),collisionCircle:r=>({u_matrix:new l.bF(r),u_inv_matrix:new l.bF(r),u_camera_to_center_distance:new l.bI(r),u_viewport_size:new l.bG(r)}),debug:r=>({u_color:new l.cu(r),u_matrix:new l.bF(r),u_overlay:new l.bJ(r),u_overlay_scale:new l.bI(r)}),clippingMask:r=>({u_matrix:new l.bF(r)}),heatmap:r=>({u_extrude_scale:new l.bI(r),u_intensity:new l.bI(r),u_matrix:new l.bF(r),u_inv_rot_matrix:new l.bF(r),u_merc_center:new l.bG(r),u_tile_id:new l.bH(r),u_zoom_transition:new l.bI(r),u_up_dir:new l.bH(r)}),heatmapTexture:r=>({u_image:new l.bJ(r),u_color_ramp:new l.bJ(r),u_opacity:new l.bI(r)}),hillshade:r=>({u_matrix:new l.bF(r),u_image:new l.bJ(r),u_latrange:new l.bG(r),u_light:new l.bG(r),u_shadow:new l.cu(r),u_highlight:new l.cu(r),u_emissive_strength:new l.bI(r),u_accent:new l.cu(r)}),hillshadePrepare:r=>({u_matrix:new l.bF(r),u_image:new l.bJ(r),u_dimension:new l.bG(r),u_zoom:new l.bI(r)}),line:l.cO,linePattern:l.cP,raster:r=>({u_matrix:new l.bF(r),u_normalize_matrix:new l.bF(r),u_globe_matrix:new l.bF(r),u_merc_matrix:new l.bF(r),u_grid_matrix:new l.cv(r),u_tl_parent:new l.bG(r),u_scale_parent:new l.bI(r),u_fade_t:new l.bI(r),u_opacity:new l.bI(r),u_image0:new l.bJ(r),u_image1:new l.bJ(r),u_brightness_low:new l.bI(r),u_brightness_high:new l.bI(r),u_saturation_factor:new l.bI(r),u_contrast_factor:new l.bI(r),u_spin_weights:new l.bH(r),u_perspective_transform:new l.bG(r),u_raster_elevation:new l.bI(r),u_zoom_transition:new l.bI(r),u_merc_center:new l.bG(r),u_cutoff_params:new l.c6(r),u_colorization_mix:new l.c6(r),u_colorization_offset:new l.bI(r),u_color_ramp:new l.bJ(r),u_texture_offset:new l.bG(r),u_texture_res:new l.bG(r),u_emissive_strength:new l.bI(r)}),rasterParticle:r=>({u_matrix:new l.bF(r),u_normalize_matrix:new l.bF(r),u_globe_matrix:new l.bF(r),u_merc_matrix:new l.bF(r),u_grid_matrix:new l.cv(r),u_tl_parent:new l.bG(r),u_scale_parent:new l.bI(r),u_fade_t:new l.bI(r),u_opacity:new l.bI(r),u_image0:new l.bJ(r),u_image1:new l.bJ(r),u_raster_elevation:new l.bI(r),u_zoom_transition:new l.bI(r),u_merc_center:new l.bG(r),u_cutoff_params:new l.c6(r)}),rasterParticleTexture:r=>({u_texture:new l.bJ(r),u_opacity:new l.bI(r)}),rasterParticleDraw:r=>({u_particle_texture:new l.bJ(r),u_particle_texture_side_len:new l.bI(r),u_tile_offset:new l.bG(r),u_velocity:new l.bJ(r),u_color_ramp:new l.bJ(r),u_velocity_res:new l.bG(r),u_max_speed:new l.bI(r),u_uv_offset:new l.bG(r),u_data_scale:new l.bG(r),u_data_offset:new l.bI(r),u_particle_pos_scale:new l.bI(r),u_particle_pos_offset:new l.bG(r)}),rasterParticleUpdate:r=>({u_particle_texture:new l.bJ(r),u_particle_texture_side_len:new l.bI(r),u_velocity:new l.bJ(r),u_velocity_res:new l.bG(r),u_max_speed:new l.bI(r),u_speed_factor:new l.bI(r),u_reset_rate:new l.bI(r),u_rand_seed:new l.bI(r),u_uv_offset:new l.bG(r),u_data_scale:new l.bG(r),u_data_offset:new l.bI(r),u_particle_pos_scale:new l.bI(r),u_particle_pos_offset:new l.bG(r)}),symbol:r=>({u_is_size_zoom_constant:new l.bJ(r),u_is_size_feature_constant:new l.bJ(r),u_size_t:new l.bI(r),u_size:new l.bI(r),u_camera_to_center_distance:new l.bI(r),u_rotate_symbol:new l.bJ(r),u_aspect_ratio:new l.bI(r),u_fade_change:new l.bI(r),u_matrix:new l.bF(r),u_label_plane_matrix:new l.bF(r),u_coord_matrix:new l.bF(r),u_is_text:new l.bJ(r),u_elevation_from_sea:new l.bJ(r),u_pitch_with_map:new l.bJ(r),u_texsize:new l.bG(r),u_texsize_icon:new l.bG(r),u_texture:new l.bJ(r),u_texture_icon:new l.bJ(r),u_gamma_scale:new l.bI(r),u_device_pixel_ratio:new l.bI(r),u_tile_id:new l.bH(r),u_zoom_transition:new l.bI(r),u_inv_rot_matrix:new l.bF(r),u_merc_center:new l.bG(r),u_camera_forward:new l.bH(r),u_tile_matrix:new l.bF(r),u_up_vector:new l.bH(r),u_ecef_origin:new l.bH(r),u_is_halo:new l.bJ(r),u_icon_transition:new l.bI(r),u_color_adj_mat:new l.bF(r)}),background:r=>({u_matrix:new l.bF(r),u_emissive_strength:new l.bI(r),u_opacity:new l.bI(r),u_color:new l.cu(r)}),backgroundPattern:r=>({u_matrix:new l.bF(r),u_emissive_strength:new l.bI(r),u_opacity:new l.bI(r),u_image:new l.bJ(r),u_pattern_tl:new l.bG(r),u_pattern_br:new l.bG(r),u_texsize:new l.bG(r),u_pattern_size:new l.bG(r),u_pixel_coord_upper:new l.bG(r),u_pixel_coord_lower:new l.bG(r),u_pattern_units_to_pixels:new l.bG(r)}),terrainRaster:r=>({u_matrix:new l.bF(r),u_image0:new l.bJ(r),u_skirt_height:new l.bI(r),u_ground_shadow_factor:new l.bH(r)}),skybox:r=>({u_matrix:new l.bF(r),u_sun_direction:new l.bH(r),u_cubemap:new l.bJ(r),u_opacity:new l.bI(r),u_temporal_offset:new l.bI(r)}),skyboxGradient:r=>({u_matrix:new l.bF(r),u_color_ramp:new l.bJ(r),u_center_direction:new l.bH(r),u_radius:new l.bI(r),u_opacity:new l.bI(r),u_temporal_offset:new l.bI(r)}),skyboxCapture:r=>({u_matrix_3f:new l.cv(r),u_sun_direction:new l.bH(r),u_sun_intensity:new l.bI(r),u_color_tint_r:new l.c6(r),u_color_tint_m:new l.c6(r),u_luminance:new l.bI(r)}),globeRaster:r=>({u_proj_matrix:new l.bF(r),u_globe_matrix:new l.bF(r),u_normalize_matrix:new l.bF(r),u_merc_matrix:new l.bF(r),u_zoom_transition:new l.bI(r),u_merc_center:new l.bG(r),u_image0:new l.bJ(r),u_grid_matrix:new l.cv(r),u_skirt_height:new l.bI(r),u_far_z_cutoff:new l.bI(r),u_frustum_tl:new l.bH(r),u_frustum_tr:new l.bH(r),u_frustum_br:new l.bH(r),u_frustum_bl:new l.bH(r),u_globe_pos:new l.bH(r),u_globe_radius:new l.bI(r),u_viewport:new l.bG(r)}),globeAtmosphere:r=>({u_frustum_tl:new l.bH(r),u_frustum_tr:new l.bH(r),u_frustum_br:new l.bH(r),u_frustum_bl:new l.bH(r),u_horizon:new l.bI(r),u_transition:new l.bI(r),u_fadeout_range:new l.bI(r),u_color:new l.c6(r),u_high_color:new l.c6(r),u_space_color:new l.c6(r),u_temporal_offset:new l.bI(r),u_horizon_angle:new l.bI(r)}),model:r=>({u_matrix:new l.bF(r),u_lighting_matrix:new l.bF(r),u_normal_matrix:new l.bF(r),u_node_matrix:new l.bF(r),u_lightpos:new l.bH(r),u_lightintensity:new l.bI(r),u_lightcolor:new l.bH(r),u_camera_pos:new l.bH(r),u_opacity:new l.bI(r),u_baseColorFactor:new l.c6(r),u_emissiveFactor:new l.c6(r),u_metallicFactor:new l.bI(r),u_roughnessFactor:new l.bI(r),u_baseTextureIsAlpha:new l.bJ(r),u_alphaMask:new l.bJ(r),u_alphaCutoff:new l.bI(r),u_baseColorTexture:new l.bJ(r),u_metallicRoughnessTexture:new l.bJ(r),u_normalTexture:new l.bJ(r),u_occlusionTexture:new l.bJ(r),u_emissionTexture:new l.bJ(r),u_lutTexture:new l.bJ(r),u_color_mix:new l.c6(r),u_aoIntensity:new l.bI(r),u_emissive_strength:new l.bI(r),u_occlusionTextureTransform:new l.c6(r)}),modelDepth:r=>({u_matrix:new l.bF(r),u_instance:new l.bF(r),u_node_matrix:new l.bF(r)}),groundShadow:r=>({u_matrix:new l.bF(r),u_ground_shadow_factor:new l.bH(r)}),stars:r=>({u_matrix:new l.bF(r),u_up:new l.bH(r),u_right:new l.bH(r),u_intensity_multiplier:new l.bI(r)}),occlusion:r=>({u_matrix:new l.bF(r),u_anchorPos:new l.bH(r),u_screenSizePx:new l.bG(r),u_occluderSizePx:new l.bG(r),u_color:new l.c6(r)})};class on{constructor(e,a,d,m){this.id=on.uniqueIdxCounter,on.uniqueIdxCounter++,this.context=e;let p=e.gl;this.buffer=p.createBuffer(),this.dynamicDraw=!!d,this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?p.DYNAMIC_DRAW:p.STATIC_DRAW),this.dynamicDraw||m||a.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){this.id=on.uniqueIdxCounter,on.uniqueIdxCounter++;let a=this.context.gl;this.context.unbindVAO(),this.bind(),a.bufferSubData(a.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}on.uniqueIdxCounter=0;let Ro={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Ge{constructor(e,a,d,m,p,u){this.length=a.length,this.attributes=d,this.itemSize=a.bytesPerElement,this.dynamicDraw=m,this.instanceCount=u,this.context=e;let U=e.gl;this.buffer=U.createBuffer(),e.bindVertexBuffer.set(this.buffer),U.bufferData(U.ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?U.DYNAMIC_DRAW:U.STATIC_DRAW),this.dynamicDraw||p||a.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(e){let a=this.context.gl;this.bind(),a.bufferSubData(a.ARRAY_BUFFER,0,e.arrayBuffer)}enableAttributes(e,a){for(let d=0;d<this.attributes.length;d++){let m=a.attributes[this.attributes[d].name];m!==void 0&&e.enableVertexAttribArray(m)}}setVertexAttribPointers(e,a,d){for(let m=0;m<this.attributes.length;m++){let p=this.attributes[m],u=a.attributes[p.name];u!==void 0&&e.vertexAttribPointer(u,p.components,e[Ro[p.type]],!1,this.itemSize,p.offset+this.itemSize*(d||0))}}setVertexAttribDivisor(e,a,d){for(let m=0;m<this.attributes.length;m++){let p=a.attributes[this.attributes[m].name];p!==void 0&&this.instanceCount&&this.instanceCount>0&&e.vertexAttribDivisor(p,d)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Cd{constructor(e,a,d,m,p){this.context=e,this.width=a,this.height=d;let u=this.framebuffer=e.gl.createFramebuffer();m&&(this.colorAttachment=new xd(e,u)),p&&(this.depthAttachmentType=p,this.depthAttachment=p==="renderbuffer"?new sb(e,u):new dh(e,u))}destroy(){let e=this.context.gl;if(this.colorAttachment){let a=this.colorAttachment.get();a&&e.deleteTexture(a)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){let a=this.depthAttachment.get();a&&e.deleteRenderbuffer(a)}else{let a=this.depthAttachment.get();a&&e.deleteTexture(a)}e.deleteFramebuffer(this.framebuffer)}}class Jp{constructor(e,a){this.gl=e,this.clearColor=new Kc(this),this.clearDepth=new eh(this),this.clearStencil=new qc(this),this.colorMask=new Gd(this),this.depthMask=new or(this),this.stencilMask=new ih(this),this.stencilFunc=new ah(this),this.stencilOp=new nh(this),this.stencilTest=new ns(this),this.depthRange=new lh(this),this.depthTest=new Gp(this),this.depthFunc=new Fp(this),this.blend=new Ip(this),this.blendFunc=new $c(this),this.blendColor=new tb(this),this.blendEquation=new eb(this),this.cullFace=new ib(this),this.cullFaceSide=new oh(this),this.frontFace=new sh(this),this.program=new Up(this),this.activeTexture=new sr(this),this.viewport=new rr(this),this.bindFramebuffer=new rh(this),this.bindRenderbuffer=new Rn(this),this.bindTexture=new ab(this),this.bindVertexBuffer=new Fd(this),this.bindElementBuffer=new Id(this),this.bindVertexArrayOES=new nb(this),this.pixelStoreUnpack=new lb(this),this.pixelStoreUnpackPremultiplyAlpha=new Ud(this),this.pixelStoreUnpackFlipY=new ob(this),this.options=a?{...a}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=e.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=e.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=e.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=e.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=e.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=e.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPointSize=e.getParameter(e.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(e,a,d){return new on(this,e,a,d)}createVertexBuffer(e,a,d,m,p){return new Ge(this,e,a,d,m,p)}createRenderbuffer(e,a,d){let m=this.gl,p=m.createRenderbuffer();return this.bindRenderbuffer.set(p),m.renderbufferStorage(m.RENDERBUFFER,e,a,d),this.bindRenderbuffer.set(null),p}createFramebuffer(e,a,d,m){return new Cd(this,e,a,d,m)}clear({color:e,depth:a,stencil:d,colorMask:m}){let p=this.gl,u=0;e&&(u|=p.COLOR_BUFFER_BIT,this.clearColor.set(e),this.colorMask.set(m||[!0,!0,!0,!0])),a!==void 0&&(u|=p.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(a),this.depthMask.set(!0)),d!==void 0&&(u|=p.STENCIL_BUFFER_BIT,this.clearStencil.set(d),this.stencilMask.set(255)),p.clear(u)}setCullFace(e){e.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace))}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1)}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1)}setColorMode(e){l.bh(e.blendFunction,ai.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(e.blendFunction),this.blendColor.set(e.blendColor),e.blendEquation?this.blendEquation.set(e.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(e.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let kd;function Sd(r,e,a,d,m,p,u){let U=r.context,Y=U.gl,y=r.transform,B=r.getOrCreateProgram("collisionBox"),C=[],k=0,Q=0;for(let K=0;K<d.length;K++){let nt=d[K],at=e.getTile(nt),ct=at.getBucket(a);if(!ct)continue;let rt=zm(nt,ct,y),bt=rt;m[0]===0&&m[1]===0||(bt=r.translatePosMatrix(rt,at,m,p));let gt=u?ct.textCollisionBox:ct.iconCollisionBox,Wt=ct.collisionCircleArray;if(Wt.length>0){let ht=l.a6.mat4.create(),Nt=bt;l.a6.mat4.mul(ht,ct.placementInvProjMatrix,y.glCoordMatrix),l.a6.mat4.mul(ht,ht,ct.placementViewportMatrix),C.push({circleArray:Wt,circleOffset:Q,transform:Nt,invTransform:ht,projection:ct.getProjection()}),k+=Wt.length/4,Q=k}gt&&(r.terrain&&r.terrain.setupElevationDraw(at,B),B.draw(r,Y.LINES,Ne.disabled,Le.disabled,r.colorModeForRenderPass(),Te.disabled,Np(bt,y,at,ct.getProjection()),a.id,gt.layoutVertexBuffer,gt.indexBuffer,gt.segments,null,y.zoom,null,[gt.collisionVertexBuffer,gt.collisionVertexBufferExt]))}if(!u||!C.length)return;let z=r.getOrCreateProgram("collisionCircle"),w=new l.cQ;w.resize(4*k),w._trim();let A=0;for(let K of C)for(let nt=0;nt<K.circleArray.length/4;nt++){let at=4*nt,ct=K.circleArray[at+0],rt=K.circleArray[at+1],bt=K.circleArray[at+2],gt=K.circleArray[at+3];w.emplace(A++,ct,rt,bt,gt,0),w.emplace(A++,ct,rt,bt,gt,1),w.emplace(A++,ct,rt,bt,gt,2),w.emplace(A++,ct,rt,bt,gt,3)}(!kd||kd.length<2*k)&&(kd=function(K){let nt=2*K,at=new l.aO;at.resize(nt),at._trim();for(let ct=0;ct<nt;ct++){let rt=6*ct;at.uint16[rt+0]=4*ct+0,at.uint16[rt+1]=4*ct+1,at.uint16[rt+2]=4*ct+2,at.uint16[rt+3]=4*ct+2,at.uint16[rt+4]=4*ct+3,at.uint16[rt+5]=4*ct+0}return at}(k));let H=U.createIndexBuffer(kd,!0),$=U.createVertexBuffer(w,l.cR.members,!0);for(let K of C){let nt={u_matrix:K.transform,u_inv_matrix:K.invTransform,u_camera_to_center_distance:(et=y).getCameraToCenterDistance(K.projection),u_viewport_size:[et.width,et.height]};z.draw(r,Y.TRIANGLES,Ne.disabled,Le.disabled,r.colorModeForRenderPass(),Te.disabled,nt,a.id,$,H,l.b1.simpleSegment(0,2*K.circleOffset,K.circleArray.length,K.circleArray.length/2),null,y.zoom)}var et;$.destroy(),H.destroy()}let hr=l.a6.mat4.create();function gb(r){let e=r._camera.getWorldToCamera(r.worldSize,1),a=l.a6.mat4.multiply([],e,r.globeMatrix);l.a6.mat4.invert(a,a);let d=[0,0,0],m=[0,1,0,0];return l.a6.vec4.transformMat4(m,m,a),d[0]=m[0],d[1]=m[1],d[2]=m[2],l.a6.vec3.normalize(d,d),d}function Xp({width:r,height:e,anchor:a,textOffset:d,textScale:m},p){let{horizontalAlign:u,verticalAlign:U}=l.bx(a),Y=-(u-.5)*r,y=-(U-.5)*e,B=l.bw(a,d);return new l.P((Y/m+B[0])*p,(y/m+B[1])*p)}function yp(r,e,a,d,m,p,u,U,Y,y,B){let C=r.text.placedSymbolArray,k=r.text.dynamicLayoutVertexArray,Q=r.icon.dynamicLayoutVertexArray,z={},w=r.getProjection(),A=jl(U,w,p),H=p.elevation,$=w.upVectorScale(U.canonical,p.center.lat,p.worldSize).metersToTile;k.clear();for(let et=0;et<C.length;et++){let K=C.get(et),{tileAnchorX:nt,tileAnchorY:at,numGlyphs:ct}=K,rt=K.hidden||!K.crossTileID||r.allowVerticalPlacement&&!K.placedOrientation?null:d[K.crossTileID];if(rt){let bt=0,gt=0,Wt=0;if(H){let vt=H?H.getAtTileOffset(U,nt,at):0,[_t,qt,zt]=w.upVector(U.canonical,nt,at);bt=vt*_t*$,gt=vt*qt*$,Wt=vt*zt*$}let[ht,Nt,St,wt]=Ea(K.projectedAnchorX+bt,K.projectedAnchorY+gt,K.projectedAnchorZ+Wt,a?A:u),kt=ci(p.getCameraToCenterDistance(w),wt),Ot=m.evaluateSizeForFeature(r.textSizeData,y,K)*kt/l.bq;a&&(Ot*=r.tilePixelRatio/Y);let Yt=Xp(rt,Ot);a?({x:ht,y:Nt,z:St}=w.projectTilePoint(nt+Yt.x,at+Yt.y,U.canonical),[ht,Nt,St]=Ea(ht+bt,Nt+gt,St+Wt,u)):(e&&Yt._rotate(-p.angle),ht+=Yt.x,Nt+=Yt.y,St=0);let Lt=r.allowVerticalPlacement&&K.placedOrientation===l.bk.vertical?Math.PI/2:0;for(let vt=0;vt<ct;vt++)l.bn(k,ht,Nt,St,Lt);B&&K.associatedIconIndex>=0&&(z[K.associatedIconIndex]={x:ht,y:Nt,z:St,angle:Lt})}else rl(ct,k)}if(B){Q.clear();let et=r.icon.placedSymbolArray;for(let K=0;K<et.length;K++){let nt=et.get(K),{numGlyphs:at}=nt,ct=z[K];if(nt.hidden||!ct)rl(at,Q);else{let{x:rt,y:bt,z:gt,angle:Wt}=ct;for(let ht=0;ht<at;ht++)l.bn(Q,rt,bt,gt,Wt)}}r.icon.dynamicLayoutVertexBuffer.updateData(Q)}r.text.dynamicLayoutVertexBuffer.updateData(k)}function pr(r,e,a,d,m,p,u={}){let U=a.paint.get("icon-translate"),Y=a.paint.get("text-translate"),y=a.paint.get("icon-translate-anchor"),B=a.paint.get("text-translate-anchor"),C=a.layout.get("icon-rotation-alignment"),k=a.layout.get("text-rotation-alignment"),Q=a.layout.get("icon-pitch-alignment"),z=a.layout.get("text-pitch-alignment"),w=a.layout.get("icon-keep-upright"),A=a.layout.get("text-keep-upright"),H=a.paint.get("icon-color-saturation"),$=a.paint.get("icon-color-contrast"),et=a.paint.get("icon-color-brightness-min"),K=a.paint.get("icon-color-brightness-max"),nt=a.paint.get("symbol-elevation-reference")==="sea",at=a.paint.get("text-occlusion-opacity").constantOr(0),ct=r.context,rt=ct.gl,bt=r.transform,gt=C==="map",Wt=k==="map",ht=Q==="map",Nt=z==="map",St=a.layout.get("symbol-sort-key").constantOr(1)!==void 0,wt=!1,kt=r.depthModeForSublayer(0,Ne.ReadOnly),Ot=[l.am(bt.center.lng),l.at(bt.center.lat)],Yt=a.layout.get("text-variable-anchor"),Lt=bt.projection.name==="globe",vt=[],_t=[0,-1,0];for(let qt of d){let zt=e.getTile(qt),Ht=zt.getBucket(a);if(!Ht||Ht.projection.name==="mercator"&&Lt||Ht.fullyClipped)continue;let Ue=Ht.projection.name==="globe",ie=Ue?l.a9(bt.zoom):0,be=jl(qt,Ht.getProjection(),bt),Me=bt.calculatePixelsToTileUnitsMatrix(zt),ge=Yt&&Ht.hasTextData(),Ye=Ht.hasIconTextFit()&&ge&&Ht.hasIconData(),qe=Ht.getProjection().createInversionMatrix(bt,qt.canonical),De=Ni=>{bt.depthOcclusionForSymbolsAndCircles&&(a.hasInitialOcclusionOpacityProperties||r.terrain)&&(Ni.push("DEPTH_D24"),Ni.push("DEPTH_OCCLUSION"))},Ui=()=>{let Ni=gt&&a.layout.get("symbol-placement")!=="point",Pe=[];De(Pe);let Wi=Ni||Ye,Gi=a.paint.get("icon-image-cross-fade").constantOr(0);r.terrainRenderModeElevated()&&ht&&Pe.push("PITCH_WITH_MAP_TERRAIN"),Ue&&(Pe.push("PROJECTION_GLOBE_VIEW"),Wi&&Pe.push("PROJECTED_POS_ON_VIEWPORT")),Gi>0&&Pe.push("ICON_TRANSITION"),Ht.icon.zOffsetVertexBuffer&&Pe.push("Z_OFFSET"),H===0&&$===0&&et===0&&K===1||Pe.push("COLOR_ADJUSTMENT"),Ht.sdfIcons&&Pe.push("RENDER_SDF");let Di=Ht.icon.programConfigurations.get(a.id),ea=r.getOrCreateProgram("symbol",{config:Di,defines:Pe}),di=zt.imageAtlasTexture?zt.imageAtlasTexture.size:[0,0],ma=Ht.iconSizeData,Va=l.bj(ma,bt.zoom),ha=ht||bt.pitch!==0,Ti=oi(be,zt.tileID.canonical,ht,gt,bt,Ht.getProjection(),Me),Ka=nn(be,zt.tileID.canonical,ht,gt,bt,Ht.getProjection(),Me),qa=r.translatePosMatrix(Ka,zt,U,y,!0),Mn=r.translatePosMatrix(be,zt,U,y),Fn=Wi?hr:Ti,rn=gt&&!ht&&!Ni,Tn=_t;!Lt&&!bt.mercatorFromTransition||gt||(Tn=gb(bt));let kl=Ue?Tn:_t,ao=a.getColorAdjustmentMatrix(H,$,et,K),hl=ub(ma.kind,Va,rn,ht,r,Mn,Fn,qa,nt,!1,di,[0,0],!0,qt,ie,Ot,qe,kl,Ht.getProjection(),ao,Gi),Vs=zt.imageAtlasTexture?zt.imageAtlasTexture:null,Rs=a.layout.get("icon-size").constantOr(0)!==1||Ht.iconsNeedLinear,$d=Ht.sdfIcons||r.options.rotating||r.options.zooming||Rs||ha?rt.LINEAR:rt.NEAREST,Gs=Ht.sdfIcons&&a.paint.get("icon-halo-width").constantOr(1)!==0,Ci=r.terrain&&ht&&Ni?l.a6.mat4.invert(l.a6.mat4.create(),Ti):hr;if(Ni&&Ht.icon){let No=bt.elevation,Hp=No?No.getAtTileOffsetFunc(qt,bt.center.lat,bt.worldSize,Ht.getProjection()):null,zh=si(be,zt.tileID.canonical,ht,gt,bt,Ht.getProjection(),Me);Ao(Ht,be,r,!1,zh,Ka,ht,w,Hp,qt)}return{program:ea,buffers:Ht.icon,uniformValues:hl,atlasTexture:Vs,atlasTextureIcon:null,atlasInterpolation:$d,atlasInterpolationIcon:null,isSDF:Ht.sdfIcons,hasHalo:Gs,tile:zt,labelPlaneMatrixInv:Ci}},Xi=()=>{let Ni=Wt&&a.layout.get("symbol-placement")!=="point",Pe=[],Wi=Ni||Yt||Ye;r.terrainRenderModeElevated()&&Nt&&Pe.push("PITCH_WITH_MAP_TERRAIN"),Ue&&(Pe.push("PROJECTION_GLOBE_VIEW"),Wi&&Pe.push("PROJECTED_POS_ON_VIEWPORT")),Ht.text.zOffsetVertexBuffer&&Pe.push("Z_OFFSET"),Ht.iconsInText&&Pe.push("RENDER_TEXT_AND_SYMBOL"),Pe.push("RENDER_SDF"),De(Pe);let Gi=Ht.text.programConfigurations.get(a.id),Di=r.getOrCreateProgram("symbol",{config:Gi,defines:Pe}),ea,di=[0,0],ma=null,Va=Ht.textSizeData;Ht.iconsInText&&(di=zt.imageAtlasTexture?zt.imageAtlasTexture.size:[0,0],ma=zt.imageAtlasTexture?zt.imageAtlasTexture:null,ea=Nt||bt.pitch!==0||r.options.rotating||r.options.zooming||Va.kind==="composite"||Va.kind==="camera"?rt.LINEAR:rt.NEAREST);let ha=zt.glyphAtlasTexture?zt.glyphAtlasTexture.size:[0,0],Ti=l.bj(Va,bt.zoom),Ka=oi(be,zt.tileID.canonical,Nt,Wt,bt,Ht.getProjection(),Me),qa=nn(be,zt.tileID.canonical,Nt,Wt,bt,Ht.getProjection(),Me),Mn=r.translatePosMatrix(qa,zt,Y,B,!0),Fn=r.translatePosMatrix(be,zt,Y,B),rn=Wi?hr:Ka,Tn=Wt&&!Nt&&!Ni,kl=_t;!Lt&&!bt.mercatorFromTransition||Wt||(kl=gb(bt));let ao=ub(Va.kind,Ti,Tn,Nt,r,Fn,rn,Mn,nt,!0,ha,di,!0,qt,ie,Ot,qe,Ue?kl:_t,Ht.getProjection(),at),hl=zt.glyphAtlasTexture?zt.glyphAtlasTexture:null,Vs=rt.LINEAR,Rs=a.paint.get("text-halo-width").constantOr(1)!==0,$d=r.terrain&&Nt&&Ni?l.a6.mat4.invert(l.a6.mat4.create(),Ka):hr;if(Ni&&Ht.text){let Gs=bt.elevation,Ci=Gs?Gs.getAtTileOffsetFunc(qt,bt.center.lat,bt.worldSize,Ht.getProjection()):null,No=si(be,zt.tileID.canonical,Nt,Wt,bt,Ht.getProjection(),Me);Ao(Ht,be,r,!0,No,qa,Nt,A,Ci,qt)}return{program:Di,buffers:Ht.text,uniformValues:ao,atlasTexture:hl,atlasTextureIcon:ma,atlasInterpolation:Vs,atlasInterpolationIcon:ea,isSDF:!0,hasHalo:Rs,tile:zt,labelPlaneMatrixInv:$d}},Si=Ht.icon.segments.get().length,Bn=Ht.text.segments.get().length,ta=Si&&!u.onlyText?Ui():null,ni=Bn&&!u.onlyIcons?Xi():null,Yi=a.paint.get("icon-opacity").constantOr(1),Li=a.paint.get("text-opacity").constantOr(1);if(St&&Ht.canOverlap){wt=!0;let Ni=Yi&&!u.onlyText?Ht.icon.segments.get():[],Pe=Li&&!u.onlyIcons?Ht.text.segments.get():[];for(let Wi of Ni)vt.push({segments:new l.b1([Wi]),sortKey:Wi.sortKey,state:ta});for(let Wi of Pe)vt.push({segments:new l.b1([Wi]),sortKey:Wi.sortKey,state:ni})}else u.onlyText||vt.push({segments:Yi?Ht.icon.segments:new l.b1([]),sortKey:0,state:ta}),u.onlyIcons||vt.push({segments:Li?Ht.text.segments:new l.b1([]),sortKey:0,state:ni})}wt&&vt.sort((qt,zt)=>qt.sortKey-zt.sortKey);for(let qt of vt){let zt=qt.state;if(zt)if(r.terrain?r.terrain.setupElevationDraw(zt.tile,zt.program,{useDepthForOcclusion:bt.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:zt.labelPlaneMatrixInv}):r.setupDepthForOcclusion(bt.depthOcclusionForSymbolsAndCircles,zt.program),ct.activeTexture.set(rt.TEXTURE0),zt.atlasTexture&&zt.atlasTexture.bind(zt.atlasInterpolation,rt.CLAMP_TO_EDGE,!0),zt.atlasTextureIcon&&(ct.activeTexture.set(rt.TEXTURE1),zt.atlasTextureIcon&&zt.atlasTextureIcon.bind(zt.atlasInterpolationIcon,rt.CLAMP_TO_EDGE,!0)),r.uploadCommonLightUniforms(r.context,zt.program),zt.hasHalo){let Ht=zt.uniformValues;Ht.u_is_halo=1,Wr(zt.buffers,qt.segments,a,r,zt.program,kt,m,p,Ht,2),Ht.u_is_halo=0}else{if(zt.isSDF){let Ht=zt.uniformValues;zt.hasHalo&&(Ht.u_is_halo=1,Wr(zt.buffers,qt.segments,a,r,zt.program,kt,m,p,Ht,1)),Ht.u_is_halo=0}Wr(zt.buffers,qt.segments,a,r,zt.program,kt,m,p,zt.uniformValues,1)}}}function Wr(r,e,a,d,m,p,u,U,Y,y){let B=[r.dynamicLayoutVertexBuffer,r.opacityVertexBuffer,r.iconTransitioningVertexBuffer,r.globeExtVertexBuffer,r.zOffsetVertexBuffer];m.draw(d,d.context.gl.TRIANGLES,p,u,U,Te.disabled,Y,a.id,r.layoutVertexBuffer,r.indexBuffer,e,a.paint,d.transform.zoom,r.programConfigurations.get(a.id),B,y)}function Qd(r,e,a,d,m,p,u){let U=r.context.gl,Y=a.paint.get("fill-pattern"),y=a.is3D(),B=y?r.stencilModeFor3D():Le.disabled,C=Y&&Y.constantOr(1),k,Q,z,w,A;u?(Q=C&&!a.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",k=U.LINES):(Q=C?"fillPattern":"fill",k=U.TRIANGLES);for(let H of d){let $=e.getTile(H);if(C&&!$.patternsLoaded())continue;let et=$.getBucket(a);if(!et)continue;r.prepareDrawTile();let K=et.programConfigurations.get(a.id),nt=r.isTileAffectedByFog(H),at=r.getOrCreateProgram(Q,{config:K,overrideFog:nt});C&&(r.context.activeTexture.set(U.TEXTURE0),$.imageAtlasTexture&&$.imageAtlasTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE),K.updatePaintBuffers());let ct=Y.constantOr(null);if(ct&&$.imageAtlas){let gt=$.imageAtlas.patternPositions[ct.toString()];gt&&K.setConstantPatternPositions(gt)}let rt=r.translatePosMatrix(H.projMatrix,$,a.paint.get("fill-translate"),a.paint.get("fill-translate-anchor")),bt=a.paint.get("fill-emissive-strength");if(u){w=et.indexBuffer2,A=et.segments2;let gt=r.terrain&&r.terrain.renderingToTexture?r.terrain.drapeBufferSize:[U.drawingBufferWidth,U.drawingBufferHeight];z=Q==="fillOutlinePattern"&&C?br(rt,bt,r,$,gt):gh(rt,bt,gt)}else w=et.indexBuffer,A=et.segments,z=C?Zh(rt,bt,r,$):Jd(rt,bt);r.uploadCommonUniforms(r.context,at,H.toUnwrapped()),at.draw(r,k,m,y?B:r.stencilModeForClipping(H),p,Te.disabled,z,a.id,et.layoutVertexBuffer,w,A,a.paint,r.transform.zoom,K,void 0)}}function ds(r,e,a,d,m,p,u,U){a.resetLayerRenderingStats(r);let Y=r.context,y=Y.gl,B=r.transform,C=a.paint.get("fill-extrusion-pattern"),k=C.constantOr(1),Q=a.paint.get("fill-extrusion-opacity"),z=r.style.enable3dLights(),w=a.paint.get(z&&!k?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),A=[a.paint.get("fill-extrusion-ambient-occlusion-intensity"),w],H=a.layout.get("fill-extrusion-edge-radius"),$=H>0&&!a.paint.get("fill-extrusion-rounded-roof"),et=$?0:H,K=B.projection.name==="globe"?l.c_():0,nt=B.projection.name==="globe",at=nt?l.a9(B.zoom):0,ct=[l.am(B.center.lng),l.at(B.center.lat)],rt=a.paint.get("fill-extrusion-flood-light-color").toRenderColor(a.lut).toArray01().slice(0,3),bt=a.paint.get("fill-extrusion-flood-light-intensity"),gt=a.paint.get("fill-extrusion-vertical-scale"),Wt=a.paint.get("fill-extrusion-line-width").constantOr(1)!==0,ht=Xl(r,a.paint.get("fill-extrusion-cutoff-fade-range")),Nt=[],St;nt&&Nt.push("PROJECTION_GLOBE_VIEW"),A[0]>0&&Nt.push("FAUX_AO"),$&&Nt.push("ZERO_ROOF_RADIUS"),U&&Nt.push("HAS_CENTROID"),bt>0&&Nt.push("FLOOD_LIGHT"),ht.shouldRenderCutoff&&Nt.push("RENDER_CUTOFF"),Wt&&Nt.push("RENDER_WALL_MODE");let wt=r.renderPass==="shadow",kt=r.shadowRenderer,Ot=wt&&!!kt;r.shadowRenderer&&(r.shadowRenderer.useNormalOffset=!0);let Yt=[0,0,0];if(kt){let _t=r.style.directionalLight,qt=r.style.ambientLight;_t&&qt&&(Yt=hd(r.style,_t,qt)),St=Nt.concat(["SHADOWS_SINGLE_CASCADE"])}let Lt=Ot?"fillExtrusionDepth":k?"fillExtrusionPattern":"fillExtrusion",vt=a.getLayerRenderingStats();for(let _t of d){let qt=e.getTile(_t),zt=qt.getBucket(a);if(!zt||zt.projection.name!==B.projection.name)continue;let Ht=!1;kt&&(Ht=kt.getMaxCascadeForTile(_t.toUnwrapped())===0);let Ue=r.isTileAffectedByFog(_t),ie=zt.programConfigurations.get(a.id),be=r.getOrCreateProgram(Lt,{config:ie,defines:Ht?St:Nt,overrideFog:Ue});if(r.terrain&&r.terrain.setupElevationDraw(qt,be,{useMeterToDem:!0}),!zt.centroidVertexBuffer){let Xi=be.attributes.a_centroid_pos;Xi!==void 0&&y.vertexAttrib2f(Xi,0,0)}!wt&&kt&&kt.setupShadows(qt.tileID.toUnwrapped(),be,"vector-tile",qt.tileID.overscaledZ),k&&(r.context.activeTexture.set(y.TEXTURE0),qt.imageAtlasTexture&&qt.imageAtlasTexture.bind(y.LINEAR,y.CLAMP_TO_EDGE),ie.updatePaintBuffers());let Me=C.constantOr(null);if(Me&&qt.imageAtlas){let Xi=qt.imageAtlas.patternPositions[Me.toString()];Xi&&ie.setConstantPatternPositions(Xi)}let ge=a.paint.get("fill-extrusion-vertical-gradient"),Ye=1/zt.tileToMeter,qe;if(wt&&kt){if(Gb(qt.tileID,zt,r))continue;let Xi=kt.calculateShadowPassMatrixFromTile(qt.tileID.toUnwrapped());qe=uh(Xi,et,Ye,gt)}else{let Xi=r.translatePosMatrix(_t.expandedProjMatrix,qt,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),Si=B.projection.createInversionMatrix(B,_t.canonical);qe=k?pb(Xi,r,ge,Q,A,et,Ye,_t,qt,K,at,ct,Si,rt,gt):hb(Xi,r,ge,Q,A,et,Ye,_t,K,at,ct,Si,rt,gt,bt,Yt)}r.uploadCommonUniforms(Y,be,_t.toUnwrapped(),null,ht);let De=zt.segments;if(B.projection.name==="mercator"&&!wt&&(De=zt.getVisibleSegments(qt.tileID,r.terrain,r.transform.getFrustum(0)),!De.get().length))continue;if(vt)if(wt)for(let Xi of De.get())vt.numRenderedVerticesInShadowPass+=Xi.primitiveLength;else for(let Xi of De.get())vt.numRenderedVerticesInTransparentPass+=Xi.primitiveLength;let Ui=[];(r.terrain||U)&&Ui.push(zt.centroidVertexBuffer),nt&&Ui.push(zt.layoutVertexExtBuffer),Wt&&Ui.push(zt.wallVertexBuffer),be.draw(r,Y.gl.TRIANGLES,m,p,u,Te.backCCW,qe,a.id,zt.layoutVertexBuffer,zt.indexBuffer,De,a.paint,r.transform.zoom,ie,Ui)}r.shadowRenderer&&(r.shadowRenderer.useNormalOffset=!1)}function Ia(r,e,a,d,m,p,u,U,Y,y,B,C,k,Q,z,w,A,H,$){let et=r.context,K=et.gl,nt=r.transform,at=r.transform.zoom,ct=[],rt=Xl(r,a.paint.get("fill-extrusion-cutoff-fade-range"));y==="clear"?(ct.push("CLEAR_SUBPASS"),$&&(ct.push("CLEAR_FROM_TEXTURE"),et.activeTexture.set(K.TEXTURE0),$.bind(K.LINEAR,K.CLAMP_TO_EDGE))):y==="sdf"&&ct.push("SDF_SUBPASS"),A&&ct.push("HAS_CENTROID"),rt.shouldRenderCutoff&&ct.push("RENDER_CUTOFF");let bt=a.layout.get("fill-extrusion-edge-radius"),gt=(Wt,ht,Nt,St,wt)=>{let kt=ht.programConfigurations.get(a.id),Ot=r.isTileAffectedByFog(Wt),Yt=r.getOrCreateProgram("fillExtrusionGroundEffect",{config:kt,defines:ct,overrideFog:Ot}),Lt=((_t,qt,zt,Ht,Ue,ie,be,Me,ge,Ye,qe)=>({u_matrix:qt,u_opacity:zt,u_ao_pass:Ht?1:0,u_meter_to_tile:Ue,u_ao:ie,u_flood_light_intensity:be,u_flood_light_color:Me,u_attenuation:ge,u_edge_radius:Ye,u_fb:0,u_fb_size:qe,u_dynamic_offset:1}))(0,St,B,Y,wt,[C,k*wt],Q,z,w,at>=17?0:bt*wt,$?$.size[0]:0),vt=[];A&&vt.push(ht.hiddenByLandmarkVertexBuffer),r.uploadCommonUniforms(et,Yt,Wt.toUnwrapped(),null,rt),Yt.draw(r,et.gl.TRIANGLES,m,p,u,U,Lt,a.id,ht.vertexBuffer,ht.indexBuffer,Nt,a.paint,at,kt,vt)};for(let Wt of d){let ht=e.getTile(Wt),Nt=ht.getBucket(a);if(!Nt||Nt.projection.name!==nt.projection.name||!Nt.groundEffect||Nt.groundEffect&&!Nt.groundEffect.hasData())continue;let St=Nt.groundEffect,wt=1/Nt.tileToMeter;{let kt=r.translatePosMatrix(Wt.projMatrix,ht,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),Ot=St.getDefaultSegment();gt(Wt,St,Ot,kt,wt)}if(H)for(let kt=0;kt<4;kt++){let Ot=l.c$[kt](Wt),Yt=e.getTile(Ot);if(!Yt)continue;let Lt=Yt.getBucket(a);if(!Lt||Lt.projection.name!==nt.projection.name||!Lt.groundEffect||Lt.groundEffect&&!Lt.groundEffect.hasData())continue;let vt=Lt.groundEffect,_t,qt;kt===0?(_t=[-l.ab,0,0],qt=1):kt===1?(_t=[l.ab,0,0],qt=0):kt===2?(_t=[0,-l.ab,0],qt=3):(_t=[0,l.ab,0],qt=2);let zt=vt.regionSegments[qt];if(!zt)continue;let Ht=new Float32Array(16);l.a6.mat4.translate(Ht,Wt.projMatrix,_t),gt(Wt,vt,zt,r.translatePosMatrix(Ht,ht,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),wt)}}}function Kl(r,e,a,d,m,p,u){d.centroidVertexArray.length===0&&d.createCentroidsBuffer();let U=p?p.findDEMTileFor(a):null;if(!(U&&U.dem||u))return;let Y=H=>new l.P(Math.ceil((H+l.d2)*l.d3),0),y=H=>{let $=e.getSource().minzoom,et=nt=>{let at=e.getTileByID(nt);if(at&&at.hasData())return at.getBucket(m)},K=[0,-1,1];for(let nt of K){if(H.overscaledZ+nt<$)continue;let at=et(H.calculateScaledKey(H.overscaledZ+nt));if(at)return at}},B=[0,0,0],C=(H,$)=>(B[0]=Math.min(H.min.y,$.min.y),B[1]=Math.max(H.max.y,$.max.y),B[2]=l.ab-$.min.x>H.max.x?$.min.x-l.ab:H.max.x,B),k=(H,$)=>(B[0]=Math.min(H.min.x,$.min.x),B[1]=Math.max(H.max.x,$.max.x),B[2]=l.ab-$.min.y>H.max.y?$.min.y-l.ab:H.max.y,B),Q=[(H,$)=>C(H,$),(H,$)=>C($,H),(H,$)=>k(H,$),(H,$)=>k($,H)],z=(H,$,et,K,nt,at,ct)=>{if(!p)return 0;let rt=[[at?et:H,at?H:et,0],[at?et:$,at?$:et,0]],bt=ct<0?l.ab+ct:ct,gt=[at?bt:(H+$)/2,at?(H+$)/2:bt,0];return et===0&&ct<0||et!==0&&ct>0?p.getForTilePoints(nt,[gt],!0,K):rt.push(gt),p.getForTilePoints(a,rt,!0,U),Math.max(rt[0][2],rt[1][2],gt[2])/p.exaggeration()};for(let H=0;H<4;H++){let $=d.borderFeatureIndices[H];if($.length===0)continue;let et=l.c$[H](a),K=y(et);if(!(K&&K instanceof l.d0)||d.borderDoneWithNeighborZ[H]===K.canonical.z)continue;K.centroidVertexArray.length===0&&K.createCentroidsBuffer();let nt=p?p.findDEMTileFor(et):null;if(!(nt&&nt.dem||u))continue;let at=(H<2?1:5)-H,ct=K.borderDoneWithNeighborZ[at]!==d.canonical.z,rt=K.borderFeatureIndices[at],bt=0;if(d.canonical.z!==K.canonical.z){for(let gt of $)d.showCentroid(d.featuresOnBorder[gt]);if(ct)for(let gt of rt)K.showCentroid(K.featuresOnBorder[gt]);d.borderDoneWithNeighborZ[H]=K.canonical.z,K.borderDoneWithNeighborZ[at]=d.canonical.z}for(let gt of $){let Wt=d.featuresOnBorder[gt],ht=d.centroidData[Wt.centroidDataIndex],Nt=Wt.borders[H],St;for(;bt<rt.length;){St=K.featuresOnBorder[rt[bt]];let wt=St.borders[at];if(wt[1]>Nt[0]+3||wt[0]>Nt[0]-3)break;K.showCentroid(St),bt++}if(St&&bt<rt.length){let wt=bt,kt=0;for(;!(St.borders[at][0]>Nt[1]-3)&&(kt++,++bt!==rt.length);)St=K.featuresOnBorder[rt[bt]];St=K.featuresOnBorder[rt[wt]];let Ot=!1;if(kt>=1){let vt=St.borders[at];Math.abs(Nt[0]-vt[0])<3&&Math.abs(Nt[1]-vt[1])<3&&(kt=1,Ot=!0,bt=wt+1)}else if(kt===0){d.showCentroid(Wt);continue}let Yt=K.centroidData[St.centroidDataIndex];u&&Ot&&(((w=ht).flags|(A=Yt).flags)&l.d1?(w.flags|=l.d1,A.flags|=l.d1):(w.flags&=~l.d1,A.flags&=~l.d1));let Lt=Wt.intersectsCount()>1||St.intersectsCount()>1;if(kt>1)bt=wt,ht.centroidXY=Yt.centroidXY=new l.P(0,0);else if(nt&&nt.dem&&!Lt){let vt=Q[H](ht,Yt),_t=H%2?l.ab-1:0,qt=z(vt[0],Math.min(l.ab-1,vt[1]),_t,nt,et,H<2,vt[2]);ht.centroidXY=Yt.centroidXY=Y(qt)}else Lt?ht.centroidXY=Yt.centroidXY=new l.P(0,0):(ht.centroidXY=d.encodeBorderCentroid(Wt),Yt.centroidXY=K.encodeBorderCentroid(St));d.writeCentroidToBuffer(ht),K.writeCentroidToBuffer(Yt)}else d.showCentroid(Wt)}d.borderDoneWithNeighborZ[H]=K.canonical.z,K.borderDoneWithNeighborZ[at]=d.canonical.z}var w,A;(d.needsCentroidUpdate||!d.centroidVertexBuffer&&d.centroidVertexArray.length!==0)&&d.uploadCentroid(r)}let Uh=[1,0,0],Vb=[0,1,0],Rb=[0,0,1];function Gb(r,e,a){let d=a.transform,m=a.shadowRenderer;if(!m)return!0;let p=r.toUnwrapped(),u=d.tileSize*m._cascades[a.currentShadowCascade].scale,U=e.maxHeight;if(d.elevation){let w=d.elevation.getMinMaxForTile(r);w&&(U+=w.max)}let Y=[...m.shadowDirection];Y[2]=-Y[2];let y=m.computeSimplifiedTileShadowVolume(p,U,u,Y);if(!y)return!1;let B=[Uh,Vb,Rb,Y,[Y[0],0,Y[2]],[0,Y[1],Y[2]]],C=d.projection.name==="globe",k=d.scaleZoom(u),Q=l.bN.fromInvProjectionMatrix(d.invProjMatrix,d.worldSize,k,!C),z=m.getCurrentCascadeFrustum();return Q.intersectsPrecise(y.vertices,y.planes,B)===0||z.intersectsPrecise(y.vertices,y.planes,B)===0}function Fb(r){return[r[0]*l.d4,r[1]*l.d4,r[2]*l.d4,0]}function sn(r,e,a,d,m,p,u,U,Y){let y=d.getSource(),B=a.globeSharedBuffers;if(!B)return;let C,k,Q;if(e&&(C=d.getTile(e)),y instanceof l.aD?(k=y.texture,Q=l.cD(0,0,a.transform)):C&&e&&(k=C.texture,Q=l.cD(e.canonical.z,e.canonical.x,a.transform)),!k||!Q)return;r||(Q=l.a6.mat4.scale(l.a6.mat4.create(),Q,[1,-1,1]));let z=a.context,w=z.gl,A=m.paint.get("raster-resampling")==="nearest"?w.NEAREST:w.LINEAR,H=a.colorModeForDrapableLayerRenderPass(p),$=u.defines;$.push("GLOBE_POLES");let et=new Ne(w.LEQUAL,Ne.ReadWrite,a.depthRangeFor3D),K=Float32Array.from(a.transform.expandedFarZProjMatrix),nt=Float32Array.from(l.b5(l.cC(new l.bP(0,0,0))));a.terrain&&a.terrain.prepareDrawTile(),z.activeTexture.set(w.TEXTURE0),k.bind(A,w.CLAMP_TO_EDGE),z.activeTexture.set(w.TEXTURE1),k.bind(A,w.CLAMP_TO_EDGE),k.useMipmap&&z.extTextureFilterAnisotropic&&a.transform.pitch>20&&w.texParameterf(w.TEXTURE_2D,z.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,z.extTextureFilterAnisotropicMax);let[at,ct,rt,bt]=e?B.getPoleBuffers(e.canonical.z,!1):B.getPoleBuffers(0,!0),gt=m.paint.get("raster-elevation"),Wt;r?(Wt=at,a.renderDefaultNorthPole=gt!==0):(Wt=ct,a.renderDefaultSouthPole=gt!==0);let ht=Fb(u.mix),Nt=((wt,kt,Ot,Yt,Lt,vt,_t,qt,zt,Ht,Ue,ie,be)=>mr(wt,kt,Ot,new Float32Array(16),new Float32Array(9),[0,0],Yt,[0,0],[0,0,0,0],1,{opacity:1,mix:0},vt,[0,0],qt,2,Ht,Ue,ie,1,0,be))(K,nt,Q,l.a9(a.transform.zoom),0,m,0,gt,0,ht,u.offset,u.range,p),St=a.getOrCreateProgram("raster",{defines:$});a.uploadCommonUniforms(z,St,null),St.draw(a,w.TRIANGLES,et,Y,H,U,Nt,m.id,Wt,rt,bt)}function ji(r){let e=r._nearZ,a=r.projection.farthestPixelDistance(r),d=a-e,m=.2*r.height,p=e+m;return[e,a,(p-m-e)/d,(p-e)/d]}function fd(r,e,a,d){if(r)return e instanceof fo&&r instanceof id?e.getTextureDescriptor(r,a,!0):{texture:r.texture,mix:Fb(d.mix),offset:d.offset,buffer:0,tileSize:1}}var Ib=l.d5([{name:"a_index",type:"Int16",components:1}]);class xh{constructor(e,a,d,m){let p={width:d[0],height:d[1],data:null},u=e.gl;this.targetColorTexture=new l.T(e,p,u.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new l.T(e,p,u.RGBA8,{useMipmap:!1}),this.context=e,this.updateParticleTexture(a,m),this.lastInvalidatedAt=0}updateParticleTexture(e,a){if(this.particleTextureDimension===a.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());let d=this.context.gl,m=a.width*a.height;this.particleTexture0=new l.T(this.context,a,d.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new l.T(this.context,a,d.RGBA8,{premultiply:!1,useMipmap:!1});let p=new l.d6;p.reserve(m);for(let u=0;u<m;u++)p.emplaceBack(u);this.particleIndexBuffer=this.context.createVertexBuffer(p,Ib.members,!0),this.particleSegment=l.b1.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=a.width}update(e){return!(this.lastInvalidatedAt<e&&(this.lastInvalidatedAt=l.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Nh(r,e,a){if(!r)return null;let d=e.getTextureDescriptor(r,a,!0);if(!d)return null;let{texture:m,mix:p,offset:u,tileSize:U,buffer:Y,format:y}=d;if(!m||!y)return null;let B=!1;return y==="uint32"&&(B=!0,p[3]=0,p=Xd(l.d7,p,[0,a.paint.get("raster-particle-max-speed")]),u=yd(l.d7,u,[0,a.paint.get("raster-particle-max-speed")])),{texture:m,textureOffset:[Y/(U+2*Y),U/(U+2*Y)],tileSize:U,scalarData:B,scale:p,offset:u,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[y]]}}function Yh(r){let e=r._nearZ,a=r.projection.farthestPixelDistance(r),d=a-e,m=.2*r.height,p=e+m;return[e,a,(p-m-e)/d,(p-e)/d]}let Bp=new l.bz(1,0,0,1),cs=new l.bz(0,1,0,1),bs=new l.bz(0,0,1,1),te=new l.bz(1,0,1,1),Ie=new l.bz(0,1,1,1);function _n(r,e,a,d,m,p,u){let U=r.context,Y=r.transform,y=U.gl,B=Y.projection.name==="globe",C=B?["PROJECTION_GLOBE_VIEW"]:[],k=l.a6.mat4.clone(a.projMatrix);if(B&&l.a9(Y.zoom)>0){let ht=l.b4(a.canonical,Y),Nt=l.d8(ht);k=l.a6.mat4.multiply(new Float32Array(16),Y.globeMatrix,Nt),l.a6.mat4.multiply(k,Y.projMatrix,k)}let Q=l.a6.mat4.create();Q[12]+=2*m/(l.q.devicePixelRatio*Y.width),Q[13]+=2*p/(l.q.devicePixelRatio*Y.height),l.a6.mat4.multiply(k,Q,k);let z=r.getOrCreateProgram("debug",{defines:C}),w=e.getTileByID(a.key);r.terrain&&r.terrain.setupElevationDraw(w,z);let A=Ne.disabled,H=Le.disabled,$=r.colorModeForRenderPass(),et="$debug";U.activeTexture.set(y.TEXTURE0),r.emptyTexture.bind(y.LINEAR,y.CLAMP_TO_EDGE),B?w._makeGlobeTileDebugBuffers(r.context,Y):w._makeDebugTileBoundsBuffers(r.context,Y.projection);let K=w._tileDebugBuffer||r.debugBuffer,nt=w._tileDebugIndexBuffer||r.debugIndexBuffer,at=w._tileDebugSegments||r.debugSegments;if(z.draw(r,y.LINE_STRIP,A,H,$,Te.disabled,Vh(k,d),et,K,nt,at,null,null,null,[w._globeTileDebugBorderBuffer]),u){let ht=w.latestRawTileData,Nt=Math.floor((ht&&ht.byteLength||0)/1024),St=a.canonical.toString();a.overscaledZ!==a.canonical.z&&(St+=` => ${a.overscaledZ}`),St+=` ${w.state}`,St+=` ${Nt}kb`,function(wt,kt){wt.initDebugOverlayCanvas();let Ot=wt.debugOverlayCanvas,Yt=wt.context.gl,Lt=wt.debugOverlayCanvas.getContext("2d");Lt.clearRect(0,0,Ot.width,Ot.height),Lt.shadowColor="white",Lt.shadowBlur=2,Lt.lineWidth=1.5,Lt.strokeStyle="white",Lt.textBaseline="top",Lt.font="bold 36px Open Sans, sans-serif",Lt.fillText(kt,5,5),Lt.strokeText(kt,5,5),wt.debugOverlayTexture.update(Ot),wt.debugOverlayTexture.bind(Yt.LINEAR,Yt.CLAMP_TO_EDGE)}(r,St)}let ct=e.getTile(a).tileSize,rt=512/Math.min(ct,512)*(a.overscaledZ/Y.zoom)*.5,bt=w._tileDebugTextBuffer||r.debugBuffer,gt=w._tileDebugTextIndexBuffer||r.quadTriangleIndexBuffer,Wt=w._tileDebugTextSegments||r.debugSegments;z.draw(r,y.TRIANGLES,A,H,ai.alphaBlended,Te.disabled,Vh(k,l.bz.transparent,rt),et,bt,gt,Wt,null,null,null,[w._globeTileDebugTextBuffer])}function Ei(r,e,a,d){ur(r,0,e+a/2,r.transform.width,a,d)}function Xt(r,e,a,d){ur(r,e-a/2,0,a,r.transform.height,d)}function ur(r,e,a,d,m,p){let u=r.context,U=u.gl;U.enable(U.SCISSOR_TEST),U.scissor(e*l.q.devicePixelRatio,a*l.q.devicePixelRatio,d*l.q.devicePixelRatio,m*l.q.devicePixelRatio),u.clear({color:p}),U.disable(U.SCISSOR_TEST)}let vd=l.d5([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Ub}=vd;function Pn(r,e,a,d){r.emplaceBack(e,a,d)}class xb{constructor(e){this.vertexArray=new l.d9,this.indices=new l.aO,Pn(this.vertexArray,-1,-1,1),Pn(this.vertexArray,1,-1,1),Pn(this.vertexArray,-1,1,1),Pn(this.vertexArray,1,1,1),Pn(this.vertexArray,-1,-1,-1),Pn(this.vertexArray,1,-1,-1),Pn(this.vertexArray,-1,1,-1),Pn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=e.createVertexBuffer(this.vertexArray,Ub),this.indexBuffer=e.createIndexBuffer(this.indices),this.segment=l.b1.simpleSegment(0,0,36,12)}}function Go(r,e,a,d,m,p){let u=r.context.gl,U=e.paint.get("sky-atmosphere-color"),Y=e.paint.get("sky-atmosphere-halo-color"),y=e.paint.get("sky-atmosphere-sun-intensity"),B=((C,k,Q,z,w)=>({u_matrix_3f:C,u_sun_direction:k,u_sun_intensity:Q,u_color_tint_r:[z.r,z.g,z.b,z.a],u_color_tint_m:[w.r,w.g,w.b,w.a],u_luminance:5e-5}))(l.a6.mat3.fromMat4(l.a6.mat3.create(),d),m,y,U,Y);u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+p,e.skyboxTexture,0),a.draw(r,u.TRIANGLES,Ne.disabled,Le.disabled,ai.unblended,Te.frontCW,B,"skyboxCapture",e.skyboxGeometry.vertexBuffer,e.skyboxGeometry.indexBuffer,e.skyboxGeometry.segment)}let ms=l.d5([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class Mp{constructor(e){let a=new l.da;a.emplaceBack(-1,1,1,0,0),a.emplaceBack(1,1,1,1,0),a.emplaceBack(1,-1,1,1,1),a.emplaceBack(-1,-1,1,0,1);let d=new l.aO;d.emplaceBack(0,1,2),d.emplaceBack(2,3,0),this.vertexBuffer=e.createVertexBuffer(a,ms.members),this.indexBuffer=e.createIndexBuffer(d),this.segments=l.b1.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}let Tp=l.d5([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Jh{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Ed{constructor(e){this.colorModeAlphaBlendedWriteRGB=new ai([1,Zn,1,Zn],l.bz.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ai([1,0,1,0],l.bz.transparent,[!1,!1,!1,!0]),this.params=new Jh,this.updateNeeded=!0,e.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),e.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),e.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),e.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(e){let a=e.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new Mp(a);let d=this.params.sizeRange,m=this.params.intensityRange,p=function(B){let C=l.dd(30),k=[];for(let Q=0;Q<B;++Q){let z=2*Math.PI*C(),w=Math.acos(1-2*C())-.5*Math.PI;k.push(l.a6.vec3.fromValues(Math.cos(w)*Math.cos(z),Math.cos(w)*Math.sin(z),Math.sin(w)))}return k}(this.params.starsCount),u=l.dd(300),U=new l.db,Y=new l.aO,y=0;for(let B=0;B<p.length;++B){let C=l.a6.vec3.scale([],p[B],200),k=Math.max(0,1+.01*d*(1*u()-.5)),Q=Math.max(0,1+.01*m*(1*u()-.5));U.emplaceBack(C[0],C[1],C[2],-1,-1,k,Q),U.emplaceBack(C[0],C[1],C[2],1,-1,k,Q),U.emplaceBack(C[0],C[1],C[2],1,1,k,Q),U.emplaceBack(C[0],C[1],C[2],-1,1,k,Q),Y.emplaceBack(y+0,y+1,y+2),Y.emplaceBack(y+0,y+2,y+3),y+=4}this.starsVx=a.createVertexBuffer(U,Tp.members),this.starsIdx=a.createIndexBuffer(Y),this.starsSegments=l.b1.simpleSegment(0,0,U.length,Y.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(e,a){let d=e.context,m=d.gl,p=e.transform,u=new Ne(m.LEQUAL,Ne.ReadOnly,[0,1]),U=l.a9(p.zoom),Y=e.style.getLut(a.scope),y=a.properties.get("color").toRenderColor(Y).toArray01(),B=a.properties.get("high-color").toRenderColor(Y).toArray01(),C=a.properties.get("space-color").toRenderColor(Y).toArray01PremultipliedAlpha(),k=5e-4,Q=l.dc(a.properties.get("horizon-blend"),0,1,k,.25),z=l.cx(e,d,p)&&Q===k?p.worldSize/(2*Math.PI*1.025)-1:p.globeRadius,w=e.frameCounter/1e3%1,A=l.a6.vec3.length(p.globeCenterInViewSpace),H=Math.sqrt(Math.pow(A,2)-Math.pow(z,2)),$=Math.acos(H/A),et=K=>{let nt=p.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];K&&nt.push("ALPHA_PASS");let at=e.getOrCreateProgram("globeAtmosphere",{defines:nt}),ct=((bt,gt,Wt,ht,Nt,St,wt,kt,Ot,Yt,Lt,vt)=>({u_frustum_tl:bt,u_frustum_tr:gt,u_frustum_br:Wt,u_frustum_bl:ht,u_horizon:Nt,u_transition:St,u_fadeout_range:wt,u_color:kt,u_high_color:Ot,u_space_color:Yt,u_temporal_offset:Lt,u_horizon_angle:vt}))(p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.frustumCorners.horizon,U,Q,y,B,C,w,$);e.uploadCommonUniforms(d,at);let rt=this.atmosphereBuffer;rt&&at.draw(e,m.TRIANGLES,u,Le.disabled,K?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Te.backCW,ct,K?"atmosphere_glow_alpha":"atmosphere_glow",rt.vertexBuffer,rt.indexBuffer,rt.segments)};et(!1),et(!0)}drawStars(e,a){let d=l.ap(a.properties.get("star-intensity"),0,1);if(d===0)return;let m=e.context,p=m.gl,u=e.transform,U=e.getOrCreateProgram("stars"),Y=l.a6.quat.identity([]);l.a6.quat.rotateX(Y,Y,-u._pitch),l.a6.quat.rotateZ(Y,Y,-u.angle),l.a6.quat.rotateX(Y,Y,l.bB(u._center.lat)),l.a6.quat.rotateY(Y,Y,-l.bB(u._center.lng));let y=l.a6.mat4.fromQuat(new Float32Array(16),Y),B=l.a6.mat4.multiply([],u.starsProjMatrix,y),C=l.a6.mat3.fromMat4([],y),k=l.a6.mat3.invert([],C),Q=[0,1,0];l.a6.vec3.transformMat3(Q,Q,k),l.a6.vec3.scale(Q,Q,this.params.sizeMultiplier);let z=[1,0,0];l.a6.vec3.transformMat3(z,z,k),l.a6.vec3.scale(z,z,this.params.sizeMultiplier);let w=(A=Q,H=z,$=d,{u_matrix:Float32Array.from(B),u_up:A,u_right:H,u_intensity_multiplier:$});var A,H,$;e.uploadCommonUniforms(m,U),this.starsVx&&this.starsIdx&&U.draw(e,p.TRIANGLES,Ne.disabled,Le.disabled,this.colorModeAlphaBlendedWriteRGB,Te.disabled,w,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function Ld(r,e){let a=[...r],d=e.cameraWorldSizeForFog/e.worldSize,m=l.a6.mat4.identity([]);return l.a6.mat4.scale(m,m,[d,d,1]),l.a6.mat4.multiply(a,m,a),l.a6.mat4.multiply(a,e.worldToFogMatrix,a),a}function zd(r,e,a,d,m){let p=a.material,u=d.context,{baseColorTexture:U,metallicRoughnessTexture:Y}=p.pbrMetallicRoughness,{normalTexture:y,occlusionTexture:B,emissionTexture:C}=p;function k(Q,z,w){if(Q&&(r.push(z),u.activeTexture.set(u.gl.TEXTURE0+w),Q.gfxTexture)){let{minFilter:A,magFilter:H,wrapS:$,wrapT:et}=Q.sampler;Q.gfxTexture.bindExtraParam(A,H,$,et)}}k(U,"HAS_TEXTURE_u_baseColorTexture",Ba.BaseColor),k(Y,"HAS_TEXTURE_u_metallicRoughnessTexture",Ba.MetallicRoughness),k(y,"HAS_TEXTURE_u_normalTexture",Ba.Normal),k(B,"HAS_TEXTURE_u_occlusionTexture",Ba.Occlusion),k(C,"HAS_TEXTURE_u_emissionTexture",Ba.Emission),m&&(m.texture||(m.texture=new l.df(d.context,m.image,[m.image.height,m.image.height,m.image.height],u.gl.RGBA8)),u.activeTexture.set(u.gl.TEXTURE0+Ba.LUT),m.texture&&m.texture.bind(u.gl.LINEAR,u.gl.CLAMP_TO_EDGE),r.push("APPLY_LUT_ON_GPU")),a.texcoordBuffer&&(r.push("HAS_ATTRIBUTE_a_uv_2f"),e.push(a.texcoordBuffer)),a.colorBuffer&&(r.push(a.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),e.push(a.colorBuffer)),a.normalBuffer&&(r.push("HAS_ATTRIBUTE_a_normal_3f"),e.push(a.normalBuffer)),a.pbrBuffer&&(r.push("HAS_ATTRIBUTE_a_pbr"),r.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),e.push(a.pbrBuffer)),p.alphaMode!=="OPAQUE"&&p.alphaMode!=="MASK"||r.push("UNPREMULT_TEXTURE_IN_SHADER"),p.defined||r.push("DIFFUSE_SHADED"),r.push("USE_STANDARD_DERIVATIVES")}function Zr(r,e,a,d,m,p){let u=a.paint.get("model-opacity"),U=e.context,Y=new Ne(e.context.gl.LEQUAL,Ne.ReadWrite,e.depthRangeFor3D),y=e.transform,B=r.mesh,C=B.material,k=C.pbrMetallicRoughness,Q=e.style.fog,z;z=e.transform.projection.zAxisUnit==="pixels"?[...r.nodeModelMatrix]:l.a6.mat4.multiply([],d.zScaleMatrix,r.nodeModelMatrix),l.a6.mat4.multiply(z,d.negCameraPosMatrix,z);let w=l.a6.mat4.invert([],z);l.a6.mat4.transpose(w,w);let A=a.paint.get("model-emissive-strength").constantOr(0),H=he(new Float32Array(r.worldViewProjection),new Float32Array(z),new Float32Array(w),null,e,u,k.baseColorFactor.toRenderColor(null),C.emissiveFactor,k.metallicFactor,k.roughnessFactor,C,A,a),$={defines:[]},et=[];zd($.defines,et,B,e,a.lut);let K=e.shadowRenderer;K&&(K.useNormalOffset=!1);let nt=null;if(Q){let rt=Ld(r.nodeModelMatrix,e.transform);if(nt=new Float32Array(rt),y.projection.name!=="globe"){let bt=B.aabb.min,gt=B.aabb.max,[Wt,ht]=Q.getOpacityForBounds(rt,bt[0],bt[1],gt[0],gt[1]);$.overrideFog=Wt>=de||ht>=de}}let at=Xl(e,a.paint.get("model-cutoff-fade-range"));at.shouldRenderCutoff&&$.defines.push("RENDER_CUTOFF");let ct=e.getOrCreateProgram("model",$);e.uploadCommonUniforms(U,ct,null,nt,at),e.renderPass!=="shadow"&&K&&K.setupShadowsFromMatrix(r.nodeModelMatrix,ct),ct.draw(e,U.gl.TRIANGLES,Y,m,p,B.material.doubleSided?Te.disabled:Te.backCCW,H,a.id,B.vertexBuffer,B.indexBuffer,B.segments,a.paint,e.transform.zoom,void 0,et)}function gr(r,e,a,d,m,p,u){let U;U=r.projection.name==="globe"?l.dg(a,r):[...a],l.a6.mat4.multiply(U,U,e.matrix);let Y=l.a6.mat4.multiply([],d,U);if(e.meshes)for(let y of e.meshes){if(y.material.alphaMode!=="BLEND"){u.push({mesh:y,depth:0,modelIndex:m,worldViewProjection:Y,nodeModelMatrix:U});continue}let B=l.a6.vec3.transformMat4([],y.centroid,Y);B[2]>0&&p.push({mesh:y,depth:B[2],modelIndex:m,worldViewProjection:Y,nodeModelMatrix:U})}if(e.children)for(let y of e.children)gr(r,y,a,d,m,p,u)}function hs(r,e,a,d){let m=a.shadowRenderer;if(!m)return;let p=m.getShadowPassDepthMode(),u=m.getShadowPassColorMode(),U=m.calculateShadowPassMatrixFromMatrix(e),Y=Zb(U);a.getOrCreateProgram("modelDepth",{defines:a._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(a,a.context.gl.TRIANGLES,p,Le.disabled,u,Te.backCCW,Y,d.id,r.vertexBuffer,r.indexBuffer,r.segments,d.paint,a.transform.zoom,void 0,void 0)}function Xh(r,e,a){let d=e.updateZoomBasedPaintProperties(),m=function(p,u,U){let Y,y,B,C=p.terrain?p.terrain.exaggeration():0;if(p.terrain&&C>0){let k=p.terrain,Q=k.findDEMTileFor(U);Q&&Q.dem?Y=l.di.create(k,U,Q):C=0}if(C===0&&(u.terrainElevationMin=0,u.terrainElevationMax=0),C===u.validForExaggeration&&(C===0||Y&&Y._demTile&&Y._demTile.tileID===u.validForDEMTile.id&&Y._dem._timestamp===u.validForDEMTile.timestamp))return!1;for(let k in u.instancesPerModel){let Q=u.instancesPerModel[k];for(let z=0;z<Q.instancedDataArray.length;++z){let w=(Y?C*Y.getElevationAt(0|Q.instancedDataArray.float32[16*z],0|Q.instancedDataArray.float32[16*z+1],!0,!0):0)+Q.instancesEvaluatedElevation[z];Q.instancedDataArray.float32[16*z+6]=w,y=y?Math.min(u.terrainElevationMin,w):w,B=B?Math.max(u.terrainElevationMax,w):w}}return u.terrainElevationMin=y||0,u.terrainElevationMax=B||0,u.validForExaggeration=C,u.validForDEMTile=Y&&Y._demTile?{id:Y._demTile.tileID,timestamp:Y._dem._timestamp}:{id:void 0,timestamp:0},!0}(r,e,a);(d||m)&&(e.uploaded=!1,e.upload(r.context))}let Kn={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new l.c9([0,0,0],[l.ab,l.ab,0])};function Cp(r,e){let a=1<<r.canonical.z,d=e.getFreeCameraOptions().position,m=e.elevation,p=r.canonical.x/a,u=(r.canonical.x+1)/a,U=r.canonical.y/a,Y=(r.canonical.y+1)/a,y=e._centerAltitude;if(m){let Q=m.getMinMaxForTile(r);Q&&Q.max>y&&(y=Q.max)}let B=l.ap(d.x,p,u)-d.x,C=l.ap(d.y,U,Y)-d.y,k=l.bD(y,e.center.lat)-d.z;return e._zoomFromMercatorZ(Math.sqrt(B*B+C*C+k*k))}function za(r,e,a,d,m,p,u){let U=r.context,Y=r.renderPass==="shadow",y=r.shadowRenderer,B=Y&&y?y.getShadowPassDepthMode():new Ne(U.gl.LEQUAL,Ne.ReadWrite,r.depthRangeFor3D),C=r.isTileAffectedByFog(p);if(a.meshes)for(let k of a.meshes){let Q=["MODEL_POSITION_ON_GPU"],z=[],w,A,H;d.instancedDataArray.length>20&&Q.push("INSTANCED_ARRAYS");let $=Xl(r,e.paint.get("model-cutoff-fade-range"));if($.shouldRenderCutoff&&Q.push("RENDER_CUTOFF"),Y&&y)w=r.getOrCreateProgram("modelDepth",{defines:Q}),A=Zb(u.shadowTileMatrix,u.shadowTileMatrix,Float32Array.from(a.matrix)),H=y.getShadowPassColorMode();else{zd(Q,z,k,r,e.lut),w=r.getOrCreateProgram("model",{defines:Q,overrideFog:C});let K=k.material,nt=K.pbrMetallicRoughness,at=e.paint.get("model-opacity"),ct=e.paint.get("model-emissive-strength").constantOr(0);A=he(p.expandedProjMatrix,Float32Array.from(a.matrix),new Float32Array(16),null,r,at,nt.baseColorFactor.toRenderColor(null),K.emissiveFactor,nt.metallicFactor,nt.roughnessFactor,K,ct,e,m),y&&(u.shadowUniformsInitialized?w.setShadowUniformValues(U,y.getShadowUniformValues()):(y.setupShadows(p.toUnwrapped(),w,"model-tile",p.overscaledZ),u.shadowUniformsInitialized=!0)),H=$.shouldRenderCutoff||at<1||K.alphaMode!=="OPAQUE"?ai.alphaBlended:ai.unblended}r.uploadCommonUniforms(U,w,p.toUnwrapped(),null,$);let et=k.material.doubleSided?Te.disabled:Te.backCCW;if(d.instancedDataArray.length>20)z.push(d.instancedDataBuffer),w.draw(r,U.gl.TRIANGLES,B,Le.disabled,H,et,A,e.id,k.vertexBuffer,k.indexBuffer,k.segments,e.paint,r.transform.zoom,void 0,z,d.instancedDataArray.length);else{let K=Y?"u_instance":"u_normal_matrix";for(let nt=0;nt<d.instancedDataArray.length;++nt)A[K]=new Float32Array(d.instancedDataArray.arrayBuffer,64*nt,16),w.draw(r,U.gl.TRIANGLES,B,Le.disabled,H,et,A,e.id,k.vertexBuffer,k.indexBuffer,k.segments,e.paint,r.transform.zoom,void 0,z)}}if(a.children)for(let k of a.children)za(r,e,k,d,m,p,u)}let kp=[1,-1,1];function Vr(r,e,a,d){if(!a.modelManager)return!0;let m=a.modelManager;if(!a.shadowRenderer)return!0;let p=a.shadowRenderer,u=e.aabb,U=!0,Y=r.maxHeight;if(Y===0){let B=0;for(let C in r.instancesPerModel){let k=m.getModel(C,d);k?B=Math.max(B,Math.max(Math.max(k.aabb.max[0],k.aabb.max[1]),k.aabb.max[2])):U=!1}Y=r.maxScale*B*1.41+r.maxVerticalOffset,U&&(r.maxHeight=Y)}u.max[2]=Y,u.min[2]+=r.terrainElevationMin,u.max[2]+=r.terrainElevationMax,l.a6.vec3.transformMat4(u.min,u.min,e.tileMatrix),l.a6.vec3.transformMat4(u.max,u.max,e.tileMatrix);let y=u.intersects(p.getCurrentCascadeFrustum());return a.currentShadowCascade===0&&(r.isInsideFirstShadowMapFrustum=y===2),y===0}function fi(r,e){let a=r.uniformValues.u_cutoff_params[0],d=r.uniformValues.u_cutoff_params[1],m=r.uniformValues.u_cutoff_params[2],p=r.uniformValues.u_cutoff_params[3];return d===a||p===m?1:l.ap(((e-a)/(d-a)-m)/(p-m),0,1)}function pi(r,e,a,d){if(e.pitch<20)return 1;let m=e.getWorldToCameraMatrix();l.a6.mat4.multiply(m,m,r);let p=l.a6.vec4.fromValues(a.min[0],a.min[1],a.min[2],1),u=l.a6.vec4.transformMat4(l.a6.vec4.create(),p,m),U=u,Y=u;p[1]=a.max[1],u=l.a6.vec4.transformMat4(l.a6.vec4.create(),p,m),U=u[1]<U[1]?u:U,Y=u[1]>Y[1]?u:Y,p[0]=a.max[0],u=l.a6.vec4.transformMat4(l.a6.vec4.create(),p,m),U=u[1]<U[1]?u:U,Y=u[1]>Y[1]?u:Y,p[1]=a.min[1],u=l.a6.vec4.transformMat4(l.a6.vec4.create(),p,m),U=u[1]<U[1]?u:U,Y=u[1]>Y[1]?u:Y;let y=l.ap(d[0],0,1),B=100*e.pixelsPerMeter*l.ap(d[1],0,1),C=l.ap(d[2],0,1),k=l.a6.vec4.lerp(l.a6.vec4.create(),U,Y,y),Q=Math.tan(.5*e.fovX),z=-k[2]*Q;if(B===0)return k[1]<-Math.abs(z)?C:1;let w=(-Math.abs(z)-k[1])/B,A=($,et,K)=>(1-K)*$+K*et,H=l.ap(A(1,C,w),C,1);return A(1,H,l.ap((e.pitch-20)/20,0,1))}class yh{}class ql{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(e,a,d){{let C=this._storage.get(a.id);if(C)return C.lastUsedFrameIdx=e,C.buf}let m=d.gl,p=m.getBufferParameter(m.ELEMENT_ARRAY_BUFFER,m.BUFFER_SIZE),u=new ArrayBuffer(p),U=new Int16Array(u);m.getBufferSubData(m.ELEMENT_ARRAY_BUFFER,0,new Int16Array(u));let Y=new l.dk;for(let C=0;C<p/2;C+=3){let k=U[C],Q=U[C+1],z=U[C+2];Y.emplaceBack(k,Q),Y.emplaceBack(Q,z),Y.emplaceBack(z,k)}let y=d.bindVertexArrayOES.current,B=new yh;return B.buf=new on(d,Y),B.lastUsedFrameIdx=e,this._storage.set(a.id,B),d.bindVertexArrayOES.set(y),B.buf}update(e){for(let[a,d]of this._storage)e-d.lastUsedFrameIdx>30&&(d.buf.destroy(),this._storage.delete(a))}destroy(){for(let[e,a]of this._storage)a.buf.destroy(),this._storage.delete(e)}}class wd{constructor(e){this.occluderSize=30,this.depthOffset=-1e-4,e.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),e.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}let $l={symbol:function(r,e,a,d,m){if(r.renderPass!=="translucent")return;let p=Le.disabled,u=r.colorModeForRenderPass();a.layout.get("text-variable-anchor")&&function(y,B,C,k,Q,z,w){let A=B.transform,H=Q==="map",$=z==="map";for(let et of y){let K=k.getTile(et),nt=K.getBucket(C);if(!nt||!nt.text||!nt.text.segments.get().length)continue;let at=l.bj(nt.textSizeData,A.zoom),ct=jl(et,nt.getProjection(),A),rt=A.calculatePixelsToTileUnitsMatrix(K),bt=oi(ct,K.tileID.canonical,$,H,A,nt.getProjection(),rt),gt=nt.hasIconTextFit()&&nt.hasIconData();if(at){let Wt=Math.pow(2,A.zoom-K.tileID.overscaledZ);yp(nt,H,$,w,l.cS,A,bt,et,Wt,at,gt)}}}(d,r,a,e,a.layout.get("text-rotation-alignment"),a.layout.get("text-pitch-alignment"),m);let U=a.paint.get("icon-opacity").constantOr(1)!==0,Y=a.paint.get("text-opacity").constantOr(1)!==0;a.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(U||Y)?pr(r,e,a,d,p,u):(U&&pr(r,e,a,d,p,u,{onlyIcons:!0}),Y&&pr(r,e,a,d,p,u,{onlyText:!0})),e.map.showCollisionBoxes&&(Sd(r,e,a,d,a.paint.get("text-translate"),a.paint.get("text-translate-anchor"),!0),Sd(r,e,a,d,a.paint.get("icon-translate"),a.paint.get("icon-translate-anchor"),!1))},circle:function(r,e,a,d){if(r.renderPass!=="translucent")return;let m=a.paint.get("circle-opacity"),p=a.paint.get("circle-stroke-width"),u=a.paint.get("circle-stroke-opacity"),U=a.layout.get("circle-sort-key").constantOr(1)!==void 0,Y=a.paint.get("circle-emissive-strength");if(m.constantOr(1)===0&&(p.constantOr(1)===0||u.constantOr(1)===0))return;let y=r.context,B=y.gl,C=r.transform,k=r.depthModeForSublayer(0,Ne.ReadOnly),Q=Le.disabled,z=r.colorModeForDrapableLayerRenderPass(Y),w=C.projection.name==="globe",A=[l.am(C.center.lng),l.at(C.center.lat)],H=[];for(let et=0;et<d.length;et++){let K=d[et],nt=e.getTile(K),at=nt.getBucket(a);if(!at||at.projection.name!==C.projection.name)continue;let ct=at.programConfigurations.get(a.id),rt=l.cT(a),bt=r.isTileAffectedByFog(K);w&&rt.push("PROJECTION_GLOBE_VIEW"),rt.push("DEPTH_D24"),r.terrain&&C.depthOcclusionForSymbolsAndCircles&&rt.push("DEPTH_OCCLUSION");let gt=r.getOrCreateProgram("circle",{config:ct,defines:rt,overrideFog:bt}),Wt=at.layoutVertexBuffer,ht=at.globeExtVertexBuffer,Nt=at.indexBuffer,St=C.projection.createInversionMatrix(C,K.canonical),wt={programConfiguration:ct,program:gt,layoutVertexBuffer:Wt,globeExtVertexBuffer:ht,indexBuffer:Nt,uniformValues:l.cU(r,K,nt,St,A,a),tile:nt};if(U){let kt=at.segments.get();for(let Ot of kt)H.push({segments:new l.b1([Ot]),sortKey:Ot.sortKey,state:wt})}else H.push({segments:at.segments,sortKey:0,state:wt})}U&&H.sort((et,K)=>et.sortKey-K.sortKey);let $={useDepthForOcclusion:C.depthOcclusionForSymbolsAndCircles};for(let et of H){let{programConfiguration:K,program:nt,layoutVertexBuffer:at,globeExtVertexBuffer:ct,indexBuffer:rt,uniformValues:bt,tile:gt}=et.state,Wt=et.segments;r.terrain&&r.terrain.setupElevationDraw(gt,nt,$),r.uploadCommonUniforms(y,nt,gt.tileID.toUnwrapped()),nt.draw(r,B.TRIANGLES,k,Q,z,Te.disabled,bt,a.id,at,rt,Wt,a.paint,C.zoom,K,[ct])}},heatmap:function(r,e,a,d){if(a.paint.get("heatmap-opacity")!==0)if(r.renderPass==="offscreen"){let m=r.context,p=m.gl,u=Le.disabled,U=new ai([p.ONE,p.ONE,p.ONE,p.ONE],l.bz.transparent,[!0,!0,!0,!0]);(function(Q,z,w,A){let H=Q.gl,$=z.width*A,et=z.height*A;Q.activeTexture.set(H.TEXTURE1),Q.viewport.set([0,0,$,et]);let K=w.heatmapFbo;if(!K||K&&(K.width!==$||K.height!==et)){K&&K.destroy();let nt=H.createTexture();H.bindTexture(H.TEXTURE_2D,nt),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_WRAP_S,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_WRAP_T,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_MIN_FILTER,H.LINEAR),H.texParameteri(H.TEXTURE_2D,H.TEXTURE_MAG_FILTER,H.LINEAR),K=w.heatmapFbo=Q.createFramebuffer($,et,!0,null),function(at,ct,rt,bt,gt,Wt){let ht=at.gl;ht.texImage2D(ht.TEXTURE_2D,0,at.extRenderToTextureHalfFloat?ht.RGBA16F:ht.RGBA,gt,Wt,0,ht.RGBA,at.extRenderToTextureHalfFloat?ht.HALF_FLOAT:ht.UNSIGNED_BYTE,null),bt.colorAttachment.set(rt)}(Q,0,nt,K,$,et)}else H.bindTexture(H.TEXTURE_2D,K.colorAttachment.get()),Q.bindFramebuffer.set(K.framebuffer)})(m,r,a,r.transform.projection.name==="globe"?.5:.25),m.clear({color:l.bz.transparent});let Y=r.transform,y=Y.projection.name==="globe",B=y?["PROJECTION_GLOBE_VIEW"]:[],C=y?Te.frontCCW:Te.disabled,k=[l.am(Y.center.lng),l.at(Y.center.lat)];for(let Q=0;Q<d.length;Q++){let z=d[Q];if(e.hasRenderableParent(z))continue;let w=e.getTile(z),A=w.getBucket(a);if(!A||A.projection.name!==Y.projection.name)continue;let H=r.isTileAffectedByFog(z),$=A.programConfigurations.get(a.id),et=r.getOrCreateProgram("heatmap",{config:$,defines:B,overrideFog:H}),{zoom:K}=r.transform;r.terrain&&r.terrain.setupElevationDraw(w,et),r.uploadCommonUniforms(m,et,z.toUnwrapped());let nt=Y.projection.createInversionMatrix(Y,z.canonical);et.draw(r,p.TRIANGLES,Ne.disabled,u,U,C,Yp(r,z,w,nt,k,K,a.paint.get("heatmap-intensity")),a.id,A.layoutVertexBuffer,A.indexBuffer,A.segments,a.paint,r.transform.zoom,$,y?[A.globeExtVertexBuffer]:null)}m.viewport.set([0,0,r.width,r.height])}else r.renderPass==="translucent"&&(r.context.setColorMode(r.colorModeForRenderPass()),function(m,p){let u=m.context,U=u.gl,Y=p.heatmapFbo;if(!Y)return;u.activeTexture.set(U.TEXTURE0),U.bindTexture(U.TEXTURE_2D,Y.colorAttachment.get()),u.activeTexture.set(U.TEXTURE1);let y=p.colorRampTexture;y||(y=p.colorRampTexture=new l.T(u,p.colorRamp,U.RGBA8)),y.bind(U.LINEAR,U.CLAMP_TO_EDGE),m.getOrCreateProgram("heatmapTexture").draw(m,U.TRIANGLES,Ne.disabled,Le.disabled,m.colorModeForRenderPass(),Te.disabled,((B,C,k,Q)=>({u_image:0,u_color_ramp:1,u_opacity:C.paint.get("heatmap-opacity")}))(0,p),p.id,m.viewportBuffer,m.quadTriangleIndexBuffer,m.viewportSegments,p.paint,m.transform.zoom)}(r,a))},line:function(r,e,a,d){if(r.renderPass!=="translucent")return;let m=a.paint.get("line-opacity"),p=a.paint.get("line-width");if(m.constantOr(1)===0||p.constantOr(1)===0)return;let u=a.paint.get("line-emissive-strength"),U=a.paint.get("line-occlusion-opacity"),Y=r.context,y=Y.gl,B=a.layout.get("line-z-offset"),C=!B.isConstant()||!!B.constantOr(0),k=C?new Ne(r.depthOcclusion?y.GREATER:y.LEQUAL,Ne.ReadOnly,r.depthRangeFor3D):r.depthModeForSublayer(0,Ne.ReadOnly),Q=r.colorModeForDrapableLayerRenderPass(u),z=r.terrain&&r.terrain.renderingToTexture,w=z?1:l.q.devicePixelRatio,A=a.paint.get("line-dasharray"),H=A.constantOr(1),$=a.layout.get("line-cap"),et=A.constantOr(null),K=$.constantOr(null),nt=a.paint.get("line-pattern"),at=nt.constantOr(1),ct=nt.constantOr(null),rt=a.paint.get("line-opacity").constantOr(1),bt=!at&&rt!==1||r.depthOcclusion&&U>0&&U<1,gt=a.paint.get("line-gradient"),Wt=at?"linePattern":"line",ht=l.cV(a),Nt;if(z&&r.terrain&&r.terrain.clipOrMaskOverlapStencilType()&&(bt=!1),U!==0&&r.depthOcclusion){let wt=a.paint._values["line-opacity"];wt&&wt.value&&wt.value.kind==="constant"?Nt=wt.value:l.w(`Occlusion opacity for layer ${a.id} is supported only when line-opacity isn't data-driven.`)}if(C&&(r.forceTerrainMode=!0),!C&&U!==0&&r.terrain&&!z)return void l.w(`Occlusion opacity for layer ${a.id} is supported on terrain only if the layer has non-zero line-z-offset.`);let St=bt&&C?r.stencilModeFor3D():Le.disabled;for(let wt of d){let kt=e.getTile(wt);if(at&&!kt.patternsLoaded())continue;let Ot=kt.getBucket(a);if(!Ot)continue;r.prepareDrawTile();let Yt=Ot.programConfigurations.get(a.id),Lt=r.isTileAffectedByFog(wt),vt=r.getOrCreateProgram(Wt,{config:Yt,defines:C?[...ht,"ELEVATED"]:ht,overrideFog:Lt});if(ct&&kt.imageAtlas){let ie=kt.imageAtlas.patternPositions[ct.toString()];ie&&Yt.setConstantPatternPositions(ie)}if(!at&&et&&K&&kt.lineAtlas){let ie=kt.lineAtlas.getDash(et,K);ie&&Yt.setConstantPatternPositions(ie)}let[_t,qt]=a.paint.get("line-trim-offset");(K==="round"||K==="square")&&_t!==qt&&(_t===0&&(_t-=1),qt===1&&(qt+=1));let zt=z?wt.projMatrix:null,Ht=at?l.cW(r,kt,a,zt,w,[_t,qt]):l.cX(r,kt,a,zt,Ot.lineClipsArray.length,w,[_t,qt]);if(gt){let ie=Ot.gradients[a.id],be=ie.texture;if(a.gradientVersion!==ie.version){let Me=256;if(a.stepInterpolant){let ge=e.getSource().maxzoom,Ye=wt.canonical.z===ge?Math.ceil(1<<r.transform.maxZoom-wt.canonical.z):1;Me=l.ap(l.cY(Ot.maxLineLength/l.ab*1024*Ye),256,Y.maxTextureSize)}ie.gradient=l.cZ({expression:a.gradientExpression(),evaluationKey:"lineProgress",resolution:Me,image:ie.gradient||void 0,clips:Ot.lineClipsArray}),ie.texture?ie.texture.update(ie.gradient):ie.texture=new l.T(Y,ie.gradient,y.RGBA8),ie.version=a.gradientVersion,be=ie.texture}Y.activeTexture.set(y.TEXTURE1),be.bind(a.stepInterpolant?y.NEAREST:y.LINEAR,y.CLAMP_TO_EDGE)}H&&(Y.activeTexture.set(y.TEXTURE0),kt.lineAtlasTexture&&kt.lineAtlasTexture.bind(y.LINEAR,y.REPEAT),Yt.updatePaintBuffers()),at&&(Y.activeTexture.set(y.TEXTURE0),kt.imageAtlasTexture&&kt.imageAtlasTexture.bind(y.LINEAR,y.CLAMP_TO_EDGE),Yt.updatePaintBuffers()),C&&r.terrain.setupElevationDraw(kt,vt),r.uploadCommonUniforms(Y,vt,wt.toUnwrapped());let Ue=ie=>{Nt!=null&&(Nt.value=rt*U),vt.draw(r,y.TRIANGLES,k,ie,Q,Te.disabled,Ht,a.id,Ot.layoutVertexBuffer,Ot.indexBuffer,Ot.segments,a.paint,r.transform.zoom,Yt,[Ot.layoutVertexBuffer2,Ot.patternVertexBuffer,Ot.zOffsetVertexBuffer]),Nt!=null&&(Nt.value=rt)};if(bt&&!C){let ie=r.stencilModeForClipping(wt).ref;ie===0&&z&&Y.clear({stencil:0});let be={func:y.EQUAL,mask:255};Ht.u_alpha_discard_threshold=.8,Ue(new Le(be,ie,255,y.KEEP,y.KEEP,y.INVERT)),Ht.u_alpha_discard_threshold=0,Ue(new Le(be,ie,255,y.KEEP,y.KEEP,y.KEEP))}else bt&&C&&(Ht.u_alpha_discard_threshold=.001),Ue(C?St:r.stencilModeForClipping(wt))}bt&&(r.resetStencilClippingMasks(),z&&Y.clear({stencil:0})),U===0||r.depthOcclusion||z||r.layersWithOcclusionOpacity.push(r.currentLayer),C&&(r.forceTerrainMode=!1)},fill:function(r,e,a,d){let m=a.paint.get("fill-color"),p=a.paint.get("fill-opacity"),u=a.is3D(),U=new Ne(r.context.gl.LEQUAL,Ne.ReadWrite,r.depthRangeFor3D);if(p.constantOr(1)===0)return;let Y=a.paint.get("fill-emissive-strength"),y=r.colorModeForDrapableLayerRenderPass(Y),B=a.paint.get("fill-pattern"),C=r.opaquePassEnabledForLayer()&&!B.constantOr(1)&&m.constantOr(l.bz.transparent).a===1&&p.constantOr(0)===1?"opaque":"translucent";if(r.renderPass===C){let k=u?U:r.depthModeForSublayer(1,r.renderPass==="opaque"?Ne.ReadWrite:Ne.ReadOnly);Qd(r,e,a,d,k,y,!1)}if(!u&&r.renderPass==="translucent"&&a.paint.get("fill-antialias")){let k=u?U:r.depthModeForSublayer(a.getPaintProperty("fill-outline-color")?2:0,Ne.ReadOnly);Qd(r,e,a,d,k,y,!0)}},"fill-extrusion":function(r,e,a,d){let m=a.paint.get("fill-extrusion-opacity"),p=r.context,u=p.gl,U=r.terrain,Y=U&&U.renderingToTexture;if(m===0)return;let y=r.conflationActive&&r.style.isLayerClipped(a,e.getSource()),B=r.style.order.indexOf(a.fqid);if(y&&function(C,k,Q,z,w){for(let A of z){let H=k.getTile(A).getBucket(Q);H&&(H.updateReplacement(A,C.replacementSource,w),H.uploadCentroid(C.context))}}(r,e,a,d,B),U||y)for(let C of d){let k=e.getTile(C).getBucket(a);k&&Kl(r.context,e,C,k,a,U,y)}if(r.renderPass==="shadow"&&r.shadowRenderer){let C=r.shadowRenderer;if(U&&m<.65&&a._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof l.a4)return;let k=C.getShadowPassDepthMode(),Q=C.getShadowPassColorMode();ds(r,e,a,d,k,Le.disabled,Q,y)}else if(r.renderPass==="translucent"){let C=!a.paint.get("fill-extrusion-pattern").constantOr(1),k=a.paint.get("fill-extrusion-color").constantOr(l.bz.white);if(!Y&&k.a!==0){let Q=new Ne(r.context.gl.LEQUAL,Ne.ReadWrite,r.depthRangeFor3D);m===1&&C?ds(r,e,a,d,Q,Le.disabled,ai.unblended,y):(ds(r,e,a,d,Q,Le.disabled,ai.disabled,y),ds(r,e,a,d,Q,r.stencilModeFor3D(),r.colorModeForRenderPass(),y),r.resetStencilClippingMasks())}if(r.style.enable3dLights()&&C&&(!U&&r.transform.projection.name!=="globe"||Y)){let Q=a.paint.get("fill-extrusion-opacity"),z=a.paint.get("fill-extrusion-ambient-occlusion-intensity"),w=a.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),A=a.paint.get("fill-extrusion-flood-light-intensity"),H=a.paint.get("fill-extrusion-flood-light-color").toRenderColor(a.lut).toArray01().slice(0,3),$=z>0&&w>0,et=A>0,K=(at,ct,rt)=>(1-rt)*at+rt*ct,nt=at=>{let ct=r.depthModeForSublayer(1,Ne.ReadOnly,u.LEQUAL,!0),rt=a.paint.get(at?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),bt=K(.1,3,rt),gt=r._showOverdrawInspector;if(!gt){let Wt=new Le({func:u.ALWAYS,mask:255},255,255,u.KEEP,u.KEEP,u.REPLACE),ht=new ai([u.ONE,u.ONE,u.ONE,u.ONE],l.bz.transparent,[!1,!1,!1,!0],u.MIN);Ia(r,e,a,d,ct,Wt,ht,Te.disabled,at,"sdf",Q,z,w,A,H,bt,y,!1)}{let Wt=gt?Le.disabled:new Le({func:u.EQUAL,mask:255},255,255,u.KEEP,u.DECR,u.DECR),ht=gt?r.colorModeForRenderPass():new ai([u.ONE_MINUS_DST_ALPHA,u.DST_ALPHA,u.ONE,u.ONE],l.bz.transparent,[!0,!0,!0,!0]);Ia(r,e,a,d,ct,Wt,ht,Te.disabled,at,"color",Q,z,w,A,H,bt,y,!1)}};if(Y){let at=(ct,rt,bt)=>{let gt=r.depthModeForSublayer(1,Ne.ReadOnly,u.LEQUAL,!1),Wt=a.paint.get(ct?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ht=K(.1,3,Wt);{let Nt=new ai([u.ONE,u.ONE,u.ONE,u.ONE],l.bz.transparent,[!1,!1,!1,!0]);Ia(r,e,a,d,gt,Le.disabled,Nt,Te.disabled,ct,"clear",Q,z,w,A,H,ht,y,rt)}{let Nt=new Le({func:u.ALWAYS,mask:255},255,255,u.KEEP,u.KEEP,u.REPLACE),St=new ai([u.ONE,u.ONE,u.ONE,u.ONE],l.bz.transparent,[!1,!1,!1,!0],u.MIN);Ia(r,e,a,d,gt,Nt,St,Te.disabled,ct,"sdf",Q,z,w,A,H,ht,y,rt)}{let Nt=ct?u.ZERO:u.ONE_MINUS_DST_ALPHA,St=new Le({func:u.EQUAL,mask:255},255,255,u.KEEP,u.DECR,u.DECR),wt=new ai([Nt,u.DST_ALPHA,u.ONE_MINUS_DST_ALPHA,u.ZERO],l.bz.transparent,[!0,!0,!0,!0]);Ia(r,e,a,d,gt,St,wt,Te.disabled,ct,"color",Q,z,w,A,H,ht,y,rt)}{let Nt=new ai([u.ONE,u.ONE,u.ONE,ct?u.ZERO:u.ONE],l.bz.transparent,[!1,!1,!1,!0],ct?u.FUNC_ADD:u.MAX);Ia(r,e,a,d,gt,Le.disabled,Nt,Te.disabled,ct,"clear",Q,z,w,A,H,ht,y,rt,bt)}};if($||et){let ct;if(r.prepareDrawTile(),U){let rt=U.drapeBufferSize[0],bt=U.drapeBufferSize[1];ct=U.framebufferCopyTexture,ct&&(!ct||ct.size[0]===rt&&ct.size[1]===bt)||(ct&&ct.destroy(),ct=U.framebufferCopyTexture=new l.T(p,new l.r({width:rt,height:bt}),u.RGBA8)),ct.bind(u.LINEAR,u.CLAMP_TO_EDGE),u.copyTexImage2D(u.TEXTURE_2D,0,u.RGBA,0,0,rt,bt,0)}$&&at(!0,!1,ct),et&&at(!1,!0,ct)}}else $&&nt(!0),et&&nt(!1),($||et)&&r.resetStencilClippingMasks()}}},hillshade:function(r,e,a,d){if(r.renderPass!=="offscreen"&&r.renderPass!=="translucent"||r.style.disableElevatedTerrain)return;let m=r.context,p=r.terrain&&r.terrain.renderingToTexture,[u,U]=r.renderPass!=="translucent"||p?[{},d]:r.stencilConfigForOverlap(d);for(let Y of U){let y=e.getTile(Y);if(y.needsHillshadePrepare&&r.renderPass==="offscreen")lr(r,y,a);else if(r.renderPass==="translucent"){let B=r.depthModeForSublayer(0,Ne.ReadOnly),C=a.paint.get("hillshade-emissive-strength"),k=r.colorModeForDrapableLayerRenderPass(C),Q=p&&r.terrain?r.terrain.stencilModeForRTTOverlap(Y):u[Y.overscaledZ];Vd(r,Y,y,a,B,Q,k)}}m.viewport.set([0,0,r.width,r.height]),r.resetStencilClippingMasks()},raster:function(r,e,a,d,m,p){if(r.renderPass!=="translucent"||a.paint.get("raster-opacity")===0)return;let u=r.transform.projection.name==="globe",U=a.paint.get("raster-elevation")!==0,Y=U&&u;if(r.renderElevatedRasterBackface&&!Y)return;let y=r.context,B=y.gl,C=e.getSource(),k=function(at,ct,rt,bt){let gt=ct.paint.get("raster-color"),Wt=at.type==="raster-array",ht=[],Nt=ct.paint.get("raster-resampling"),St=ct.paint.get("raster-color-mix"),wt=ct.paint.get("raster-color-range"),kt=[St[0],St[1],St[2],0],Ot=St[3],Yt=Nt==="nearest"?bt.NEAREST:bt.LINEAR;if(Wt&&(ht.push("RASTER_ARRAY"),gt||ht.push("RASTER_COLOR"),Nt==="linear"&&ht.push("RASTER_ARRAY_LINEAR"),Yt=bt.NEAREST,!wt&&at.rasterLayers)){let Lt=at.rasterLayers.find(({id:vt})=>vt===ct.sourceLayer);Lt&&Lt.fields&&Lt.fields.range&&(wt=Lt.fields.range)}if(wt=wt||[0,1],gt){ht.push("RASTER_COLOR"),rt.activeTexture.set(bt.TEXTURE2),ct.updateColorRamp(wt);let Lt=ct.colorRampTexture;Lt||(Lt=ct.colorRampTexture=new l.T(rt,ct.colorRamp,bt.RGBA8)),Lt.bind(bt.LINEAR,bt.CLAMP_TO_EDGE)}return{mix:kt,range:wt,offset:Ot,defines:ht,resampling:Yt}}(C,a,y,B);if(C instanceof l.aD&&!d.length&&!u)return;let Q=a.paint.get("raster-emissive-strength"),z=r.colorModeForDrapableLayerRenderPass(Q),w=r.terrain&&r.terrain.renderingToTexture,A=!r.options.moving,H=a.paint.get("raster-resampling")==="nearest"?B.NEAREST:B.LINEAR;if(C instanceof l.aD&&!d.length&&(C.onNorthPole||C.onSouthPole)){let at=U?r.stencilModeFor3D():Le.disabled;return void sn(!!C.onNorthPole,null,r,e,a,Q,k,Te.disabled,at)}if(!d.length)return;let[$,et]=C instanceof l.aD||w?[{},d]:r.stencilConfigForOverlap(d),K=et[et.length-1].overscaledZ;Y&&k.defines.push("PROJECTION_GLOBE_VIEW"),U&&k.defines.push("RENDER_CUTOFF");let nt=(at,ct,rt)=>{for(let bt of at){let gt=bt.toUnwrapped(),Wt=e.getTile(bt);if(w&&(!Wt||!Wt.hasData()))continue;y.activeTexture.set(B.TEXTURE0);let ht=fd(Wt,C,a,k);if(!ht||!ht.texture)continue;let{texture:Nt,mix:St,offset:wt,tileSize:kt,buffer:Ot}=ht,Yt,Lt;w?(Yt=Ne.disabled,Lt=bt.projMatrix):U?(Yt=new Ne(B.LEQUAL,Ne.ReadWrite,r.depthRangeFor3D),Lt=u?Float32Array.from(r.transform.expandedFarZProjMatrix):r.transform.calculateProjMatrix(gt,A)):(Yt=r.depthModeForSublayer(bt.overscaledZ-K,a.paint.get("raster-opacity")===1?Ne.ReadWrite:Ne.ReadOnly,B.LESS),Lt=r.transform.calculateProjMatrix(gt,A));let vt=r.terrain&&w?r.terrain.stencilModeForRTTOverlap(bt):$[bt.overscaledZ],_t=p?0:a.paint.get("raster-fade-duration");Wt.registerFadeDuration(_t);let qt=e.findLoadedParent(bt,0),zt=Nd(Wt,qt,e,r.transform,_t),Ht,Ue;r.terrain&&r.terrain.prepareDrawTile(),y.activeTexture.set(B.TEXTURE0),Nt.bind(H,B.CLAMP_TO_EDGE),y.activeTexture.set(B.TEXTURE1),qt?(qt.texture&&qt.texture.bind(H,B.CLAMP_TO_EDGE),Ht=Math.pow(2,qt.tileID.overscaledZ-Wt.tileID.overscaledZ),Ue=[Wt.tileID.canonical.x*Ht%1,Wt.tileID.canonical.y*Ht%1]):Nt.bind(H,B.CLAMP_TO_EDGE),Nt.useMipmap&&y.extTextureFilterAnisotropic&&r.transform.pitch>20&&B.texParameterf(B.TEXTURE_2D,y.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,y.extTextureFilterAnisotropicMax);let ie=r.transform,be,Me=U?ji(ie):[0,0,0,0],ge,Ye,qe,De,Ui,Xi=0;if(Y&&C instanceof l.aD&&C.coordinates.length>3)ge=Float32Array.from(l.b5(l.cC(new l.bP(0,0,0)))),Ye=Float32Array.from(ie.globeMatrix),qe=Float32Array.from(l.cy(ie)),De=[l.am(ie.center.lng),l.at(ie.center.lat)],be=C.elevatedGlobePerspectiveTransform,Ui=C.elevatedGlobeGridMatrix||new Float32Array(9);else if(Y){let ni=l.cz(bt.canonical);Xi=l.cA(ni.getCenter().lat),ge=Float32Array.from(l.b5(l.cC(bt.canonical))),Ye=Float32Array.from(ie.globeMatrix),qe=Float32Array.from(l.cy(ie)),De=[l.am(ie.center.lng),l.at(ie.center.lat)],be=[0,0],Ui=Float32Array.from(l.cB(bt.canonical,ni,Xi,ie.worldSize/ie._pixelsPerMercatorPixel))}else be=C instanceof l.aD?C.perspectiveTransform:[0,0],ge=new Float32Array(16),Ye=new Float32Array(9),qe=new Float32Array(16),De=[0,0],Ui=new Float32Array(9);let Si=mr(Lt,ge,Ye,qe,Ui,Ue||[0,0],l.a9(r.transform.zoom),De,Me,Ht||1,zt,a,be,U?a.paint.get("raster-elevation"):0,2,St,wt,k.range,kt,Ot,Q),Bn=r.isTileAffectedByFog(bt),ta=r.getOrCreateProgram("raster",{defines:k.defines,overrideFog:Bn});if(r.uploadCommonUniforms(y,ta,gt),C instanceof l.aD){let ni=C.elevatedGlobeVertexBuffer,Yi=C.elevatedGlobeIndexBuffer;if(w||!u)C.boundsBuffer&&C.boundsSegments&&ta.draw(r,B.TRIANGLES,Yt,Le.disabled,z,Te.disabled,Si,a.id,C.boundsBuffer,r.quadTriangleIndexBuffer,C.boundsSegments);else if(ni&&Yi){let Li=ie.zoom<=l.c2?C.elevatedGlobeSegments:C.getSegmentsForLongitude(ie.center.lng);Li&&ta.draw(r,B.TRIANGLES,Yt,Le.disabled,z,ct,Si,a.id,ni,Yi,Li)}}else if(Y){Yt=new Ne(B.LEQUAL,Ne.ReadOnly,r.depthRangeFor3D);let ni=r.globeSharedBuffers;if(ni){let[Yi,Li,Ni]=ni.getGridBuffers(Xi,!1);ta.draw(r,B.TRIANGLES,Yt,rt||vt,r.colorModeForRenderPass(),ct,Si,a.id,Yi,Li,Ni)}}else{let{tileBoundsBuffer:ni,tileBoundsIndexBuffer:Yi,tileBoundsSegments:Li}=r.getTileBoundsBuffers(Wt);ta.draw(r,B.TRIANGLES,Yt,vt,z,Te.disabled,Si,a.id,ni,Yi,Li)}}if(!(C instanceof l.aD)&&Y)for(let bt of at){let gt=bt.canonical.y===(1<<bt.canonical.z)-1;bt.canonical.y===0&&sn(!0,bt,r,e,a,Q,k,ct,rt||Le.disabled),gt&&sn(!1,bt,r,e,a,Q,k,ct===Te.frontCW?Te.backCW:Te.frontCW,rt||Le.disabled)}};Y?nt(et,r.renderElevatedRasterBackface?Te.backCW:Te.frontCW,r.stencilModeFor3D()):nt(et,Te.disabled,void 0),r.resetStencilClippingMasks()},"raster-particle":function(r,e,a,d,m,p){r.renderPass==="offscreen"&&function(u,U,Y,y){if(!y.length)return;let B=u.context,C=B.gl,k=U.getSource();if(!(k instanceof fo))return;let Q=Math.ceil(Math.sqrt(Y.paint.get("raster-particle-count"))),z=Y.particlePositionRGBAImage;if(!z||z.width!==Q){let et=function(K){let nt=K*K,at=new Uint8Array(4*nt),ct=function(bt){return bt|=0,bt=Math.imul(2747636419^bt,2654435769),bt=Math.imul(bt^bt>>>16,2654435769),((bt=Math.imul(bt^bt>>>16,2654435769))>>>0)/4294967296},rt=1/1.1;for(let bt=0;bt<nt;bt++){let gt=rt*(ct(2*bt+0)+dl),Wt=rt*(ct(2*bt+1)+dl),ht=255*gt%1,Nt=255*Wt%1,St=ht,wt=Wt-Nt/255,kt=Nt;at[4*bt+0]=255*(gt-ht/255),at[4*bt+1]=255*St,at[4*bt+2]=255*wt,at[4*bt+3]=255*kt}return at}(Q);z=Y.particlePositionRGBAImage=new l.r({width:Q,height:Q},et)}let w=Y.particleFramebuffer;w?w.width!==Q&&(w.destroy(),w=Y.particleFramebuffer=B.createFramebuffer(Q,Q,!0,null)):w=Y.particleFramebuffer=B.createFramebuffer(Q,Q,!0,null);let A=[];for(let et of y){let K=U.getTile(et);if(!(K instanceof id))continue;let nt=Nh(K,k,Y);if(!nt)continue;let at=[K.tileSize,K.tileSize],ct=Y.tileFramebuffer;ct||(ct=Y.tileFramebuffer=B.createFramebuffer(at[0],at[1],!0,null));let rt=K.rasterParticleState;rt||(rt=K.rasterParticleState=new xh(B,et,at,z));let bt=rt.update(Y.lastInvalidatedAt);rt.particleTextureDimension!==Q&&rt.updateParticleTexture(et,z);let gt=rt.targetColorTexture;rt.targetColorTexture=rt.backgroundColorTexture,rt.backgroundColorTexture=gt;let Wt=rt.particleTexture0;rt.particleTexture0=rt.particleTexture1,rt.particleTexture1=Wt,A.push([et,nt,rt,bt])}if(A.length===0)return;let H=l.q.now(),$=Y.previousDrawTimestamp?.001*(H-Y.previousDrawTimestamp):.0167;if(Y.previousDrawTimestamp=H,Y.hasColorMap()){B.activeTexture.set(C.TEXTURE0+2);let et=Y.colorRampTexture;et||(et=Y.colorRampTexture=new l.T(B,Y.colorRamp,C.RGBA8)),et.bind(C.LINEAR,C.CLAMP_TO_EDGE)}B.bindFramebuffer.set(Y.tileFramebuffer.framebuffer),function(et,K,nt){let at=et.context,ct=at.gl,rt=K.tileFramebuffer;at.activeTexture.set(ct.TEXTURE0);let bt={u_texture:0,u_opacity:1.05*(Wt=K.paint.get("raster-particle-fade-opacity-factor"))/(Wt+.05)},gt=et.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Wt;for(let ht of nt){let[,,Nt,St]=ht;rt.colorAttachment.set(Nt.targetColorTexture.texture),at.viewport.set([0,0,rt.width,rt.height]),at.clear({color:l.bz.transparent}),St&&(Nt.backgroundColorTexture.bind(ct.NEAREST,ct.CLAMP_TO_EDGE),gt.draw(et,ct.TRIANGLES,Ne.disabled,Le.disabled,ai.alphaBlended,Te.disabled,bt,K.id,et.viewportBuffer,et.quadTriangleIndexBuffer,et.viewportSegments))}}(u,Y,A),function(et,K,nt,at){let ct=et.context,rt=ct.gl,bt=nt.tileFramebuffer,gt=et.transform.projection.name==="globe",Wt=nt.paint.get("raster-particle-max-speed");for(let ht of at){let[Nt,St,wt]=ht;ct.activeTexture.set(rt.TEXTURE0+0),St.texture.bind(rt.LINEAR,rt.CLAMP_TO_EDGE),bt.colorAttachment.set(wt.targetColorTexture.texture);let kt=et.getOrCreateProgram("rasterParticleDraw",{defines:St.defines,overrideFog:!1});ct.activeTexture.set(rt.TEXTURE0+1);let Ot=St.scalarData?[]:[0,1,2,3].map(vt=>l.c$[vt](Nt));Ot.push(Nt);let Yt=Nt.canonical.x,Lt=Nt.canonical.y;for(let vt of Ot){let _t=K.getTile(gt?vt.wrapped():vt);if(!_t)continue;let qt=_t.rasterParticleState;if(!qt)continue;let zt=vt.canonical.x+(1<<vt.canonical.z)*(vt.wrap-Nt.wrap),Ht=vt.canonical.y;qt.particleTexture0.bind(rt.NEAREST,rt.CLAMP_TO_EDGE);let Ue=Bd(1,qt.particleTexture0.size[0],[zt-Yt,Ht-Lt],0,St.texture.size,2,Wt,St.textureOffset,St.scale,St.offset);kt.draw(et,rt.POINTS,Ne.disabled,Le.disabled,ai.alphaBlended,Te.disabled,Ue,nt.id,qt.particleIndexBuffer,void 0,qt.particleSegment)}}}(u,U,Y,A),B.bindFramebuffer.set(Y.particleFramebuffer.framebuffer),function(et,K,nt,at){let ct=et.context,rt=ct.gl,bt=K.paint.get("raster-particle-max-speed"),gt=at*K.paint.get("raster-particle-speed-factor")*.15,Wt=function(Nt){return Math.pow(Nt,6)}(.01+1*K.paint.get("raster-particle-reset-rate-factor")),ht=K.particleFramebuffer;ct.viewport.set([0,0,ht.width,ht.height]);for(let Nt of nt){let[,St,wt]=Nt;ct.activeTexture.set(rt.TEXTURE0+0),St.texture.bind(rt.LINEAR,rt.CLAMP_TO_EDGE),ct.activeTexture.set(rt.TEXTURE0+1);let kt=wt.particleTexture0;kt.bind(rt.NEAREST,rt.CLAMP_TO_EDGE);let Ot=Md(1,kt.size[0],0,St.texture.size,bt,gt,Wt,St.textureOffset,St.scale,St.offset);ht.colorAttachment.set(wt.particleTexture1.texture),ct.clear({color:l.bz.transparent}),et.getOrCreateProgram("rasterParticleUpdate",{defines:St.defines}).draw(et,rt.TRIANGLES,Ne.disabled,Le.disabled,ai.unblended,Te.disabled,Ot,K.id,et.viewportBuffer,et.quadTriangleIndexBuffer,et.viewportSegments)}}(u,Y,A,$)}(r,e,a,d),r.renderPass==="translucent"&&(function(u,U,Y,y,B){let C=u.context,k=C.gl,Q=U.getSource().tileSize,z=5*(1-l.a7(l.bU,l.bU+1,u.transform.zoom))*Q+Y.paint.get("raster-particle-elevation"),w=!u.options.moving,A=u.transform.projection.name==="globe";if(!y.length)return;let[H,$]=u.stencilConfigForOverlap(y),et=[];A&&et.push("PROJECTION_GLOBE_VIEW");let K=u.stencilModeFor3D();for(let nt of $){let at=nt.toUnwrapped(),ct=U.getTile(nt);if(!ct.rasterParticleState)continue;let rt=ct.rasterParticleState,bt=100;ct.registerFadeDuration(bt);let gt=U.findLoadedParent(nt,0),Wt=Nd(ct,gt,U,u.transform,bt),ht,Nt;u.terrain&&u.terrain.prepareDrawTile(),C.activeTexture.set(k.TEXTURE0),rt.targetColorTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),C.activeTexture.set(k.TEXTURE1),gt&&gt.rasterParticleState?(gt.rasterParticleState.targetColorTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),ht=Math.pow(2,gt.tileID.overscaledZ-ct.tileID.overscaledZ),Nt=[ct.tileID.canonical.x*ht%1,ct.tileID.canonical.y*ht%1]):rt.targetColorTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE);let St=A?Float32Array.from(u.transform.expandedFarZProjMatrix):u.transform.calculateProjMatrix(at,w),wt=u.transform,kt=Yh(wt),Ot=l.cz(nt.canonical),Yt=l.cA(Ot.getCenter().lat),Lt,vt,_t,qt,zt;A?(Lt=Float32Array.from(l.b5(l.cC(nt.canonical))),vt=Float32Array.from(wt.globeMatrix),_t=Float32Array.from(l.cy(wt)),qt=[l.am(wt.center.lng),l.at(wt.center.lat)],zt=Float32Array.from(l.cB(nt.canonical,Ot,Yt,wt.worldSize/wt._pixelsPerMercatorPixel))):(Lt=new Float32Array(16),vt=new Float32Array(9),_t=new Float32Array(16),qt=[0,0],zt=new Float32Array(9));let Ht=Gh(St,Lt,vt,_t,zt,Nt||[0,0],l.a9(u.transform.zoom),qt,kt,ht||1,Wt,z),Ue=u.isTileAffectedByFog(nt),ie=u.getOrCreateProgram("rasterParticle",{defines:et,overrideFog:Ue});if(u.uploadCommonUniforms(C,ie,at),A){let be=new Ne(k.LEQUAL,Ne.ReadOnly,u.depthRangeFor3D),Me=0,ge=u.globeSharedBuffers;if(ge){let[Ye,qe,De]=ge.getGridBuffers(Yt,Me!==0);ie.draw(u,k.TRIANGLES,be,K,ai.alphaBlended,u.renderElevatedRasterBackface?Te.frontCCW:Te.backCCW,Ht,Y.id,Ye,qe,De)}}else{let be=u.depthModeForSublayer(0,Ne.ReadOnly),Me=H[nt.overscaledZ],{tileBoundsBuffer:ge,tileBoundsIndexBuffer:Ye,tileBoundsSegments:qe}=u.getTileBoundsBuffers(ct);ie.draw(u,k.TRIANGLES,be,Me,ai.alphaBlended,Te.disabled,Ht,Y.id,ge,Ye,qe)}}u.resetStencilClippingMasks()}(r,e,a,d),r.style.map.triggerRepaint())},background:function(r,e,a,d){let m=a.paint.get("background-color"),p=a.paint.get("background-opacity"),u=a.paint.get("background-emissive-strength"),U=a.paint.get("background-pitch-alignment")==="viewport";if(p===0)return;let Y=r.context,y=Y.gl,B=r.transform,C=B.tileSize,k=a.paint.get("background-pattern"),Q;if(k!==void 0&&(k===null||(Q=r.imageManager.getPattern(k.toString(),a.scope,r.style.getLut(a.scope)),!Q)))return;let z=!k&&m.a===1&&p===1&&r.opaquePassEnabledForLayer()?"opaque":"translucent";if(r.renderPass!==z)return;let w=Le.disabled,A=r.depthModeForSublayer(0,z==="opaque"?Ne.ReadWrite:Ne.ReadOnly),H=r.colorModeForDrapableLayerRenderPass(u),$=k?"backgroundPattern":"background",et,K=d;if(K||(et=r.getBackgroundTiles(),K=Object.values(et).map(nt=>nt.tileID)),k&&(Y.activeTexture.set(y.TEXTURE0),r.imageManager.bind(r.context,a.scope)),U){let nt=r.getOrCreateProgram($,{overrideFog:!1,overrideRtt:!0}),at=new Float32Array(l.a6.mat4.identity([])),ct=new l.aA(0,0,0,0,0),rt=k?Vo(at,u,p,r,0,a.scope,Q,U,{tileID:ct,tileSize:C}):Fh(at,u,p,m.toRenderColor(a.lut));nt.draw(r,y.TRIANGLES,A,w,H,Te.disabled,rt,a.id,r.viewportBuffer,r.quadTriangleIndexBuffer,r.viewportSegments)}else for(let nt of K){let at=r.isTileAffectedByFog(nt),ct=r.getOrCreateProgram($,{overrideFog:at}),rt=nt.toUnwrapped(),bt=d?nt.projMatrix:r.transform.calculateProjMatrix(rt);r.prepareDrawTile();let gt=e?e.getTile(nt):et?et[nt.key]:new ol(nt,C,B.zoom,r),Wt=k?Vo(bt,u,p,r,0,a.scope,Q,U,{tileID:nt,tileSize:C}):Fh(bt,u,p,m.toRenderColor(a.lut));r.uploadCommonUniforms(Y,ct,rt);let{tileBoundsBuffer:ht,tileBoundsIndexBuffer:Nt,tileBoundsSegments:St}=r.getTileBoundsBuffers(gt);ct.draw(r,y.TRIANGLES,A,w,H,Te.disabled,Wt,a.id,ht,Nt,St)}},sky:function(r,e,a){let d=r._atmosphere?l.a9(r.transform.zoom):1,m=a.paint.get("sky-opacity")*d;if(m===0)return;let p=r.context,u=a.paint.get("sky-type"),U=new Ne(p.gl.LEQUAL,Ne.ReadOnly,[0,1]),Y=r.frameCounter/1e3%1;u==="atmosphere"?r.renderPass==="offscreen"?a.needsSkyboxCapture(r)&&(function(y,B,C,k){let Q=y.context,z=Q.gl,w=B.skyboxFbo;if(!w){w=B.skyboxFbo=Q.createFramebuffer(32,32,!0,null),B.skyboxGeometry=new xb(Q),B.skyboxTexture=Q.gl.createTexture(),z.bindTexture(z.TEXTURE_CUBE_MAP,B.skyboxTexture),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_MIN_FILTER,z.LINEAR),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_MAG_FILTER,z.LINEAR);for(let et=0;et<6;++et)z.texImage2D(z.TEXTURE_CUBE_MAP_POSITIVE_X+et,0,z.RGBA,32,32,0,z.RGBA,z.UNSIGNED_BYTE,null)}Q.bindFramebuffer.set(w.framebuffer),Q.viewport.set([0,0,32,32]);let A=B.getCenter(y,!0),H=y.getOrCreateProgram("skyboxCapture"),$=new Float64Array(16);l.a6.mat4.identity($),l.a6.mat4.rotateY($,$,.5*-Math.PI),Go(y,B,H,$,A,0),l.a6.mat4.identity($),l.a6.mat4.rotateY($,$,.5*Math.PI),Go(y,B,H,$,A,1),l.a6.mat4.identity($),l.a6.mat4.rotateX($,$,.5*-Math.PI),Go(y,B,H,$,A,2),l.a6.mat4.identity($),l.a6.mat4.rotateX($,$,.5*Math.PI),Go(y,B,H,$,A,3),l.a6.mat4.identity($),Go(y,B,H,$,A,4),l.a6.mat4.identity($),l.a6.mat4.rotateY($,$,Math.PI),Go(y,B,H,$,A,5),Q.viewport.set([0,0,y.width,y.height])}(r,a),a.markSkyboxValid(r)):r.renderPass==="sky"&&function(y,B,C,k,Q){let z=y.context,w=z.gl,A=y.transform,H=y.getOrCreateProgram("skybox");z.activeTexture.set(w.TEXTURE0),w.bindTexture(w.TEXTURE_CUBE_MAP,B.skyboxTexture);let $=((et,K,nt,at,ct)=>({u_matrix:et,u_sun_direction:K,u_cubemap:0,u_opacity:at,u_temporal_offset:ct}))(A.skyboxMatrix,B.getCenter(y,!1),0,k,Q);y.uploadCommonUniforms(z,H),H.draw(y,w.TRIANGLES,C,Le.disabled,y.colorModeForRenderPass(),Te.backCW,$,"skybox",B.skyboxGeometry.vertexBuffer,B.skyboxGeometry.indexBuffer,B.skyboxGeometry.segment)}(r,a,U,m,Y):u==="gradient"&&r.renderPass==="sky"&&function(y,B,C,k,Q){let z=y.context,w=z.gl,A=y.transform,H=y.getOrCreateProgram("skyboxGradient");B.skyboxGeometry||(B.skyboxGeometry=new xb(z)),z.activeTexture.set(w.TEXTURE0);let $=B.colorRampTexture;$||($=B.colorRampTexture=new l.T(z,B.colorRamp,w.RGBA8)),$.bind(w.LINEAR,w.CLAMP_TO_EDGE);let et=((K,nt,at,ct,rt)=>({u_matrix:K,u_color_ramp:0,u_center_direction:nt,u_radius:l.bB(at),u_opacity:ct,u_temporal_offset:rt}))(A.skyboxMatrix,B.getCenter(y,!1),B.paint.get("sky-gradient-radius"),k,Q);y.uploadCommonUniforms(z,H),H.draw(y,w.TRIANGLES,C,Le.disabled,y.colorModeForRenderPass(),Te.backCW,et,"skyboxGradient",B.skyboxGeometry.vertexBuffer,B.skyboxGeometry.indexBuffer,B.skyboxGeometry.segment)}(r,a,U,m,Y)},debug:function(r,e,a,d,m,p){for(let u=0;u<a.length;u++)if(m){let y=new l.bz(d.r*.8,d.g*.8,d.b*.8,1);_n(r,e,a[u],d,-1,-1,p),_n(r,e,a[u],d,-1,1,p),_n(r,e,a[u],d,1,1,p),_n(r,e,a[u],d,1,-1,p),_n(r,e,a[u],y,0,0,p)}else _n(r,e,a[u],d,0,0,p)},custom:function(r,e,a,d){let m=r.context,p=a.implementation;if(!r.transform.projection.unsupportedLayers||!r.transform.projection.unsupportedLayers.includes("custom")||r.terrain&&(r.terrain.renderingToTexture||r.renderPass==="offscreen")&&a.isDraped(e)){if(r.renderPass==="offscreen"){let u=p.prerender;if(u){if(r.setCustomLayerDefaults(),m.setColorMode(r.colorModeForRenderPass()),r.transform.projection.name==="globe"){let U=r.transform.pointMerc;u.call(p,m.gl,r.transform.customLayerMatrix(),r.transform.getProjection(),r.transform.globeToMercatorMatrix(),l.a9(r.transform.zoom),[U.x,U.y],r.transform.pixelsPerMeterRatio)}else u.call(p,m.gl,r.transform.customLayerMatrix());m.setDirty(),r.setBaseState()}}else if(r.renderPass==="translucent"){if(r.terrain&&r.terrain.renderingToTexture){let U=p.renderToTile;if(U){let Y=d[0].canonical,y=new l.a5(Y.x+d[0].wrap*(1<<Y.z),Y.y,Y.z);m.setDepthMode(Ne.disabled),m.setStencilMode(Le.disabled),m.setColorMode(r.colorModeForRenderPass()),r.setCustomLayerDefaults(),U.call(p,m.gl,y),m.setDirty(),r.setBaseState()}return}r.setCustomLayerDefaults(),m.setColorMode(r.colorModeForRenderPass()),m.setStencilMode(Le.disabled);let u=p.renderingMode==="3d"?new Ne(r.context.gl.LEQUAL,Ne.ReadWrite,r.depthRangeFor3D):r.depthModeForSublayer(0,Ne.ReadOnly);if(m.setDepthMode(u),r.transform.projection.name==="globe"){let U=r.transform.pointMerc;p.render(m.gl,r.transform.customLayerMatrix(),r.transform.getProjection(),r.transform.globeToMercatorMatrix(),l.a9(r.transform.zoom),[U.x,U.y],r.transform.pixelsPerMeterRatio)}else p.render(m.gl,r.transform.customLayerMatrix());m.setDirty(),r.setBaseState(),m.bindFramebuffer.set(null)}}else l.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(r,e,a,d){if(r.renderPass==="opaque")return;let m=a.paint.get("model-opacity");if(m===0)return;let p=a.paint.get("model-cast-shadows");if(r.renderPass==="shadow"&&(!p||r.terrain&&m<.65&&a._transitionablePaint._values["model-opacity"].value.expression instanceof l.a4))return;let u=r.shadowRenderer,U=a.paint.get("model-receive-shadows");u&&(u.useNormalOffset=!0,U||(u.enabled=!1));let Y=()=>{u&&(u.useNormalOffset=!0,U||(u.enabled=!0))},y=e.getSource();if(r.renderPass==="light-beam"&&y.type!=="batched-model")return;if(y.type==="vector"||y.type==="geojson")return function(H,$,et,K,nt){let at=H.transform;if(at.projection.name!=="mercator")return void l.w(`Drawing 3D models for ${at.projection.name} projection is not yet implemented`);let ct=at.getFreeCameraOptions().position;if(!H.modelManager)return;let rt=H.modelManager;et.modelManager=rt;let bt=H.shadowRenderer;if(!et._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let gt=et._unevaluatedLayout._values["model-id"],Wt={...et.layout.get("model-id").parameters},ht=H.style.order.indexOf(et.fqid);for(let Nt of K){let St=$.getTile(Nt).getBucket(et);if(!St||St.projection.name!==at.projection.name)continue;let wt=St.getModelUris();wt&&!St.modelsRequested&&(rt.addModelsFromBucket(wt,nt),St.modelsRequested=!0);let kt=Cp(Nt,at);Wt.zoom=kt;let Ot=gt.possiblyEvaluate(Wt);if(Xh(H,St,Nt),Kn.shadowUniformsInitialized=!1,Kn.useSingleShadowCascade=!!bt&&bt.getMaxCascadeForTile(Nt.toUnwrapped())===0,H.renderPass==="shadow"&&bt){if(H.currentShadowCascade===1&&St.isInsideFirstShadowMapFrustum)continue;let vt=at.calculatePosMatrix(Nt.toUnwrapped(),at.worldSize);if(Kn.tileMatrix.set(vt),Kn.shadowTileMatrix=Float32Array.from(bt.calculateShadowPassMatrixFromMatrix(vt)),Kn.aabb.min.fill(0),Kn.aabb.max[0]=Kn.aabb.max[1]=l.ab,Kn.aabb.max[2]=0,Vr(St,Kn,H,et.scope))continue}let Yt=1<<Nt.canonical.z,Lt=[((ct.x-Nt.wrap)*Yt-Nt.canonical.x)*l.ab,(ct.y*Yt-Nt.canonical.y)*l.ab,ct.z*Yt*l.ab];H.conflationActive&&Object.keys(St.instancesPerModel).length>0&&H.style.isLayerClipped(et,$.getSource())&&St.updateReplacement(Nt,H.replacementSource,ht,nt)&&(St.uploaded=!1,St.upload(H.context));for(let vt in St.instancesPerModel){let _t=St.instancesPerModel[vt];_t.features.length>0&&(vt=Ot.evaluate(_t.features[0].feature,{}));let qt=rt.getModel(vt,nt);if(qt&&qt.uploaded)for(let zt of qt.nodes)za(H,et,zt,_t,Lt,Nt,Kn)}}}(r,e,a,d,y.type==="vector"?a.scope:""),void Y();if(!y.loaded())return;if(y.type==="batched-model")return function(H,$,et,K){et.resetLayerRenderingStats(H);let nt=H.context,at=H.transform,ct=H.style.fog,rt=H.shadowRenderer;if(at.projection.name!=="mercator")return void l.w(`Drawing 3D landmark models for ${at.projection.name} projection is not yet implemented`);let bt=H.transform.getFreeCameraOptions().position,gt=l.a6.vec3.scale([],[bt.x,bt.y,bt.z],H.transform.worldSize),Wt=l.a6.vec3.negate([],gt),ht=l.a6.mat4.identity([]),Nt=l.de(at.center.lat,at.zoom),St=l.a6.mat4.fromScaling([],[1,1,1/Nt]);l.a6.mat4.translate(ht,ht,Wt);let wt=et.paint.get("model-opacity"),kt=new Ne(nt.gl.LEQUAL,Ne.ReadWrite,H.depthRangeFor3D),Ot=new Ne(nt.gl.LEQUAL,Ne.ReadOnly,H.depthRangeFor3D),Yt=new l.c9([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Lt=H.renderPass==="shadow",vt=Lt&&rt?rt.getCurrentCascadeFrustum():at.getFrustum(at.scaleZoom(at.worldSize)),_t=et.paint.get("model-front-cutoff"),qt=_t[2]<1,zt=Xl(H,et.paint.get("model-cutoff-fade-range")),Ht=et.getLayerRenderingStats();(function(Ue,ie,be,Me){let ge=Ue.terrain?Ue.terrain.exaggeration():0,Ye=Ue.transform.zoom;for(let qe of Me){let De=ie.getTile(qe).getBucket(be);De&&(Ue.conflationActive&&De.updateReplacement(qe,Ue.replacementSource),De.evaluateScale(Ue,be),Ue.terrain&&ge>0&&De.elevationUpdate(Ue.terrain,ge,qe,be.source),De.needsReEvaluation(Ue,Ye,be)&&De.evaluate(be))}})(H,$,et,K),function(){let Ue,ie,be;qt?(Ue=K.length-1,ie=-1,be=-1):(Ue=0,ie=K.length,be=1);let Me=new Float64Array(16),ge=l.a6.vec3.create(),Ye=new l.P(0,0);for(let qe=Ue;qe!==ie;qe+=be){let De=K[qe],Ui=$.getTile(De).getBucket(et);if(!Ui||!Ui.uploaded)continue;let Xi=!1;rt&&(Xi=rt.getMaxCascadeForTile(De.toUnwrapped())===0);let Si=at.calculatePosMatrix(De.toUnwrapped(),at.worldSize),Bn=Ui.modelTraits;!Lt&&qt&&(l.a6.mat4.invert(Me,Si),l.a6.vec3.transformMat4(ge,gt,Me),Ye.x=ge[0],Ye.y=ge[1]);let ta=[];for(let ni of Ui.getNodesInfo()){if(ni.hiddenByReplacement||!ni.node.meshes)continue;let Yi=ni.node,Li=0;H.terrain&&Yi.elevation&&(Li=Yi.elevation*H.terrain.exaggeration());let Ni=(()=>{let Ti=ni.aabb;return Yt.min=[...Ti.min],Yt.max=[...Ti.max],Yt.min[2]+=Li,Yt.max[2]+=Li,l.a6.vec3.transformMat4(Yt.min,Yt.min,Si),l.a6.vec3.transformMat4(Yt.max,Yt.max,Si),Yt})(),Pe=ni.evaluatedScale;if(Pe[0]<=1&&Pe[1]<=1&&Pe[2]<=1&&Ni.intersects(vt)===0)continue;if(!Lt&&qt){let Ti=.16666666666666666;ni.cameraCollisionOpacity=gt[0]>Ni.min[0]&&gt[0]<Ni.max[0]&&gt[1]>Ni.min[1]&&gt[1]<Ni.max[1]&&gt[2]*Nt<Ni.max[2]&&Yi.footprint&&l.bu(Ye,Yi.footprint)?Math.max(ni.cameraCollisionOpacity-Ti,0):Math.min(1,ni.cameraCollisionOpacity+Ti)}let Wi=[...Si],Gi=Yi.anchor?Yi.anchor[0]:0,Di=Yi.anchor?Yi.anchor[1]:0;l.a6.mat4.translate(Wi,Wi,[Gi*(Pe[0]-1),Di*(Pe[1]-1),Li]),l.a6.vec3.exactEquals(Pe,l.dh)||l.a6.mat4.scale(Wi,Wi,Pe);let ea=l.a6.mat4.multiply([],Wi,Yi.matrix),di=l.a6.mat4.multiply([],at.expandedFarZProjMatrix,ea),ma=l.a6.mat4.multiply([],at.expandedFarZProjMatrix,Wi),Va=l.a6.vec4.transformMat4([],[Gi,Di,Li,1],di)[2];Yi.hidden=!1;let ha=wt;Lt||(qt&&(ha*=ni.cameraCollisionOpacity,ha*=pi(Wi,at,ni.aabb,_t)),ha*=fi(zt,Va)),ha!==0?ta.push({nodeInfo:ni,depth:Va,opacity:ha,wvpForNode:di,wvpForTile:ma,nodeModelMatrix:ea,tileModelMatrix:Wi}):Yi.hidden=!0}Lt||ta.sort((ni,Yi)=>!qt||ni.opacity===1&&Yi.opacity===1?ni.depth<Yi.depth?-1:1:ni.opacity===1?-1:Yi.opacity===1?1:ni.depth>Yi.depth?-1:1);for(let ni of ta){let Yi=ni.nodeInfo,Li=Yi.node,Ni=l.a6.mat4.multiply([],St,ni.tileModelMatrix);l.a6.mat4.multiply(Ni,ht,Ni);let Pe=l.a6.mat4.invert([],Ni);l.a6.mat4.transpose(Pe,Pe),l.a6.mat4.scale(Pe,Pe,kp),Ni=l.a6.mat4.multiply(Ni,Ni,Li.matrix);let Wi=H.renderPass==="light-beam",Gi=Bn&l.dj.HasMapboxMeshFeatures,Di=Gi?0:Yi.evaluatedRMEA[0][2];for(let ea=0;ea<Li.meshes.length;++ea){let di=Li.meshes[ea],ma=ea===Li.lightMeshIndex,Va=ni.wvpForNode;if(ma){if(!Wi&&!H.terrain&&H.shadowRenderer){H.currentLayer<H.firstLightBeamLayer&&(H.firstLightBeamLayer=H.currentLayer);continue}Va=ni.wvpForTile}else if(Wi)continue;let ha={defines:[]},Ti=[];if(zd(ha.defines,Ti,di,H,et.lut),Gi||ha.defines.push("DIFFUSE_SHADED"),Xi&&ha.defines.push("SHADOWS_SINGLE_CASCADE"),Ht&&(Lt?Ht.numRenderedVerticesInShadowPass+=di.vertexArray.length:Ht.numRenderedVerticesInTransparentPass+=di.vertexArray.length),Lt){hs(di,ni.nodeModelMatrix,H,et);continue}let Ka=null;if(ct){let kl=Ld(ni.nodeModelMatrix,H.transform);if(Ka=new Float32Array(kl),at.projection.name!=="globe"){let ao=di.aabb.min,hl=di.aabb.max,[Vs,Rs]=ct.getOpacityForBounds(kl,ao[0],ao[1],hl[0],hl[1]);ha.overrideFog=Vs>=de||Rs>=de}}let qa=di.material,Mn;qa.occlusionTexture&&qa.occlusionTexture.offsetScale&&(Mn=qa.occlusionTexture.offsetScale,ha.defines.push("OCCLUSION_TEXTURE_TRANSFORM")),!Lt&&rt&&(rt.useNormalOffset=!!di.normalBuffer);let Fn=H.getOrCreateProgram("model",ha);!Lt&&rt&&rt.setupShadowsFromMatrix(ni.tileModelMatrix,Fn,rt.useNormalOffset),H.uploadCommonUniforms(nt,Fn,null,Ka);let rn=qa.pbrMetallicRoughness;rn.metallicFactor=.9,rn.roughnessFactor=.5;let Tn=he(new Float32Array(Va),new Float32Array(Ni),new Float32Array(Pe),new Float32Array(Li.matrix),H,ni.opacity,rn.baseColorFactor.toRenderColor(null),qa.emissiveFactor,rn.metallicFactor,rn.roughnessFactor,qa,Di,et,[0,0,0],Mn);!ma&&(Yi.hasTranslucentParts||ni.opacity<1)&&Fn.draw(H,nt.gl.TRIANGLES,kt,Le.disabled,ai.disabled,Te.backCCW,Tn,et.id,di.vertexBuffer,di.indexBuffer,di.segments,et.paint,H.transform.zoom,void 0,Ti),Fn.draw(H,nt.gl.TRIANGLES,ma?Ot:kt,Le.disabled,ma||ni.opacity<1||Yi.hasTranslucentParts?ai.alphaBlended:ai.unblended,Te.backCCW,Tn,et.id,di.vertexBuffer,di.indexBuffer,di.segments,et.paint,H.transform.zoom,void 0,Ti)}}}}()}(r,e,a,d),void Y();if(y.type!=="model")return;let B=y.getModels(),C=[],k=r.transform.getFreeCameraOptions().position,Q=l.a6.vec3.scale([],[k.x,k.y,k.z],r.transform.worldSize);l.a6.vec3.negate(Q,Q);let z=[],w=[],A=0;for(let H of B){let $=a.paint.get("model-rotation").constantOr(null),et=a.paint.get("model-scale").constantOr(null),K=a.paint.get("model-translation").constantOr(null);H.computeModelMatrix(r,$,et,K,!0,!0,!1);let nt=l.a6.mat4.identity([]),at=l.de(H.position.lat,r.transform.zoom),ct=l.a6.mat4.fromScaling([],[1,1,1/at]);l.a6.mat4.translate(nt,nt,Q),C.push({zScaleMatrix:ct,negCameraPosMatrix:nt});for(let rt of H.nodes)gr(r.transform,rt,H.matrix,r.transform.expandedFarZProjMatrix,A,z,w);A++}if(z.sort((H,$)=>$.depth-H.depth),r.renderPass!=="shadow"){if(m===1)for(let H of w)Zr(H,r,a,C[H.modelIndex],Le.disabled,r.colorModeForRenderPass());else{for(let H of w)Zr(H,r,a,C[H.modelIndex],Le.disabled,ai.disabled);for(let H of w)Zr(H,r,a,C[H.modelIndex],r.stencilModeFor3D(),r.colorModeForRenderPass());r.resetStencilClippingMasks()}for(let H of z)Zr(H,r,a,C[H.modelIndex],Le.disabled,r.colorModeForRenderPass());Y()}else{for(let H of w)hs(H.mesh,H.nodeModelMatrix,r,a);for(let H of z)hs(H.mesh,H.nodeModelMatrix,r,a);Y()}}},Ad={model:function(r,e,a){let d=e.getSource();if(!d.loaded())return;if(d.type==="vector"||d.type==="geojson")return void(a.modelManager&&a.modelManager.upload(a,d.type==="vector"?r.scope:""));if(d.type==="batched-model"||d.type!=="model")return;let m=d.getModels();for(let p of m)p.upload(a.context)},raster:function(r,e,a){let d=e.getSource();if(!(d instanceof fo&&d.loaded()))return;let m=r.sourceLayer||d.rasterLayerIds&&d.rasterLayerIds[0];if(!m)return;let p=r.paint.get("raster-array-band")||d.getInitialBand(m);if(p==null)return;let u=e.getIds().map(U=>e.getTileByID(U));for(let U of u)U.updateNeeded(m,p)&&d.prepareTile(U,m,p)},"raster-particle":function(r,e,a){let d=e.getSource();if(!(d instanceof fo&&d.loaded()))return;let m=r.sourceLayer||d.rasterLayerIds&&d.rasterLayerIds[0];if(!m)return;let p=r.paint.get("raster-particle-array-band")||d.getInitialBand(m);if(p==null)return;let u=e.getIds().map(U=>e.getTileByID(U));for(let U of u)U.updateNeeded(m,p)&&d.prepareTile(U,m,p)}};class Nb{constructor(e,a,d,m){this.context=new Jp(e,a),this.transform=d,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=m,this._timeStamp=l.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};let p=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(let U of p)this._debugParams.enabledLayers[U]=!0;m.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),m.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),m.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),m.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),m.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(let U of p)m.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],U);this.occlusionParams=new wd(m),this.setup(),this.numSublayers=an.maxUnderzooming+an.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new l.dl,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new jm(this),this._wireframeDebugCache=new ql,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];let u=new l.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new l.T(this.context,u,e.RGBA8),this._clippingActiveLastFrame=!1}updateTerrain(e,a){let d=!!e&&!!e.terrain&&this.transform.projection.supportsTerrain;if(!(d||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new cb(this,e));let m=this._terrain;this.transform.elevation=d?m:null,m.update(e,this.transform,a),this.transform.elevation&&!m.enabled&&(this.transform.elevation=null)}_updateFog(e){let a=e.fog;if(!a||this.transform.projection.name==="globe"||a.getOpacity(this.transform.pitch)<1||a.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);let[d,m]=a.getFovAdjustedRange(this.transform._fov);if(d>m)return void(this.transform.fogCullDistSq=null);let p=d+.78*(m-d);this.transform.fogCullDistSq=p*p}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(e){e&&!this._terrain&&(this._terrain=new cb(this,this.style)),this._forceTerrainMode=e}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(e,a){if(this.width=e*l.q.devicePixelRatio,this.height=a*l.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let d of this.style.order)this.style._mergedLayers[d].resize()}setup(){let e=this.context,a=new l.a_;a.emplaceBack(0,0),a.emplaceBack(l.ab,0),a.emplaceBack(0,l.ab),a.emplaceBack(l.ab,l.ab),this.tileExtentBuffer=e.createVertexBuffer(a,l.b0.members),this.tileExtentSegments=l.b1.simpleSegment(0,0,4,2);let d=new l.a_;d.emplaceBack(0,0),d.emplaceBack(l.ab,0),d.emplaceBack(0,l.ab),d.emplaceBack(l.ab,l.ab),this.debugBuffer=e.createVertexBuffer(d,l.b0.members),this.debugSegments=l.b1.simpleSegment(0,0,4,5);let m=new l.a_;m.emplaceBack(-1,-1),m.emplaceBack(1,-1),m.emplaceBack(-1,1),m.emplaceBack(1,1),this.viewportBuffer=e.createVertexBuffer(m,l.b0.members),this.viewportSegments=l.b1.simpleSegment(0,0,4,2);let p=new l.aN;p.emplaceBack(0,0,0,0),p.emplaceBack(l.ab,0,l.ab,0),p.emplaceBack(0,l.ab,0,l.ab),p.emplaceBack(l.ab,l.ab,l.ab,l.ab),this.mercatorBoundsBuffer=e.createVertexBuffer(p,l.b3.members),this.mercatorBoundsSegments=l.b1.simpleSegment(0,0,4,2);let u=new l.aO;u.emplaceBack(0,1,2),u.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=e.createIndexBuffer(u);let U=new l.a$;for(let y of[0,1,3,2,0])U.emplaceBack(y);this.debugIndexBuffer=e.createIndexBuffer(U),this.emptyTexture=new l.T(e,new l.r({width:1,height:1},Uint8Array.of(0,0,0,0)),e.gl.RGBA8),this.identityMat=l.a6.mat4.create();let Y=this.context.gl;this.stencilClearMode=new Le({func:Y.ALWAYS,mask:0},0,255,Y.ZERO,Y.ZERO,Y.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(e){return e._makeTileBoundsBuffers(this.context,this.transform.projection),e._tileBoundsBuffer?{tileBoundsBuffer:e._tileBoundsBuffer,tileBoundsIndexBuffer:e._tileBoundsIndexBuffer,tileBoundsSegments:e._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let e=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,e.TRIANGLES,Ne.disabled,this.stencilClearMode,ai.disabled,Te.disabled,cr(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(e,a,d){if(!a||this.currentStencilSource===a.id||!e.isTileClipped()||!d||d.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let U=!1;for(let Y of d)if(this._tileClippingMaskIDs[Y.key]===void 0){U=!0;break}if(!U)return}this.currentStencilSource=a.id;let m=this.context,p=m.gl;this.nextStencilID+d.length>256&&this.clearStencil(),m.setColorMode(ai.disabled),m.setDepthMode(Ne.disabled);let u=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(let U of d){let Y=a.getTile(U),y=this._tileClippingMaskIDs[U.key]=this.nextStencilID++,{tileBoundsBuffer:B,tileBoundsIndexBuffer:C,tileBoundsSegments:k}=this.getTileBoundsBuffers(Y);u.draw(this,p.TRIANGLES,Ne.disabled,new Le({func:p.ALWAYS,mask:0},y,255,p.KEEP,p.KEEP,p.REPLACE),ai.disabled,Te.disabled,cr(U.projMatrix),"$clipping",B,C,k)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let e=this.nextStencilID++,a=this.context.gl;return new Le({func:a.NOTEQUAL,mask:255},e,255,a.KEEP,a.KEEP,a.REPLACE)}stencilModeForClipping(e){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(e);let a=this.context.gl;return new Le({func:a.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,a.KEEP,a.KEEP,a.REPLACE)}stencilConfigForOverlap(e){let a=this.context.gl,d=e.sort((u,U)=>U.overscaledZ-u.overscaledZ),m=d[d.length-1].overscaledZ,p=d[0].overscaledZ-m+1;if(p>1){this.currentStencilSource=void 0,this.nextStencilID+p>256&&this.clearStencil();let u={};for(let U=0;U<p;U++)u[U+m]=new Le({func:a.GEQUAL,mask:255},U+this.nextStencilID,255,a.KEEP,a.KEEP,a.REPLACE);return this.nextStencilID+=p,[u,d]}return[{[m]:Le.disabled},d]}colorModeForRenderPass(){let e=this.context.gl;return this._showOverdrawInspector?new ai([e.CONSTANT_COLOR,e.ONE,e.CONSTANT_COLOR,e.ONE],new l.bz(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?ai.unblended:ai.alphaBlended}colorModeForDrapableLayerRenderPass(e){let a=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new ai([a.ONE,a.ONE_MINUS_SRC_ALPHA,a.CONSTANT_ALPHA,a.ONE_MINUS_SRC_ALPHA],new l.bz(0,0,0,e===void 0?0:e),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(e,a,d,m=!1){if(this.depthOcclusion)return new Ne(this.context.gl.GREATER,Ne.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!m)return Ne.disabled;let p=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new Ne(d||this.context.gl.LEQUAL,a,[p,p])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){let e=this.context.gl,a=Math.ceil(this.width),d=Math.ceil(this.height),m=this.context.bindFramebuffer.get(),p=e.getParameter(e.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===a&&this.depthFBO.height===d||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),a!==0&&d!==0&&(this.depthFBO=new Cd(this.context,a,d,!1,"texture"),this.depthTexture=new l.T(this.context,{width:a,height:d,data:null},e.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(m),e.bindTexture(e.TEXTURE_2D,p),this.depthFBO&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),e.blitFramebuffer(0,0,a,d,0,0,a,d,e.DEPTH_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((e,a)=>e+a/this._fpsHistory.length,0))}render(e,a){let d=l.q.now();this._dt=d-this._timeStamp,this._timeStamp=d,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=e.map.repaint,this.style=e,this.options=a;let m=this.style._mergedLayers,p=this.style.order.filter(Wt=>{let ht=m[Wt];return!(ht.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[ht.type]}),u=!1,U=!1;for(let Wt of p){let ht=m[Wt];ht.type==="circle"&&(u=!0),ht.type==="symbol"&&(ht.hasInitialOcclusionOpacityProperties?U=!0:u=!0)}let Y=p.map(Wt=>m[Wt]),y=this.style._mergedSourceCaches;this.imageManager=e.imageManager,this.modelManager=e.modelManager,this.symbolFadeChange=e.placement.symbolFadeChange(l.q.now()),this.imageManager.beginFrame();let B=0,C=!1;for(let Wt in y){let ht=y[Wt];ht.used&&(ht.prepare(this.context),ht.getSource().usedInConflation&&++B)}let k=!1;for(let Wt of Y)Wt.isHidden(this.transform.zoom)||(Wt.type==="clip"&&(k=!0),this.prepareLayer(Wt));let Q={},z={},w={},A={},H={};for(let Wt in y){let ht=y[Wt];Q[Wt]=ht.getVisibleCoordinates(),z[Wt]=Q[Wt].slice().reverse(),w[Wt]=ht.getVisibleCoordinates(!0).reverse(),A[Wt]=ht.getShadowCasterCoordinates(),H[Wt]=ht.sortCoordinatesByDistance(Q[Wt])}let $=Wt=>{let ht=this.style.getLayerSourceCache(Wt);return ht&&ht.used?ht.getSource():null};if(B||k||this._clippingActiveLastFrame){let Wt=[],ht=[],Nt=0;for(let St of Y)this.isSourceForClippingOrConflation(St,$(St))&&(Wt.push(St),ht.push(Nt)),Nt++;if(Wt&&(k||Wt.length>1)||this._clippingActiveLastFrame){k=!1;let St=[];for(let wt=0;wt<Wt.length;wt++){let kt=Wt[wt],Ot=ht[wt],Yt=this.style.getLayerSourceCache(kt);if(!Yt||!Yt.used||!Yt.getSource().usedInConflation&&kt.type!=="clip")continue;let Lt=l.dn,vt=l.bs.None,_t=[],qt=!0;if(kt.type==="clip"){Lt=Ot;for(let zt of kt.layout.get("clip-layer-types"))vt|=zt==="model"?l.bs.Model:zt==="symbol"?l.bs.Symbol:l.bs.FillExtrusion;for(let zt of kt.layout.get("clip-layer-scope"))_t.push(zt);kt.isHidden(this.transform.zoom)?qt=!1:k=!0}qt&&St.push({layer:kt.fqid,cache:Yt,order:Lt,clipMask:vt,clipScope:_t})}this.replacementSource.setSources(St),C=!0}}this._clippingActiveLastFrame=k,C||this.replacementSource.clear(),this.conflationActive=C,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Wt=0;Wt<Y.length;Wt++){let ht=Y[Wt],Nt=ht.cutoffRange();if(this.longestCutoffRange=Math.max(Nt,this.longestCutoffRange),Nt>0){let St=$(ht);St&&(this.minCutoffZoom=Math.max(St.minzoom,this.minCutoffZoom)),ht.minzoom&&(this.minCutoffZoom=Math.max(ht.minzoom,this.minCutoffZoom))}ht.is3D()&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Wt),this._lastOcclusionLayer=Wt)}let et=this.style&&this.style.fog;et?(this._fogVisible=et.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=et.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(w),this.opaquePassCutoff=0);let K=this._shadowRenderer;if(K){K.updateShadowParameters(this.transform,this.style.directionalLight);for(let Wt in y)for(let ht of Q[Wt]){let Nt={min:0,max:0};this.terrain&&(Nt=this.terrain.getMinMaxForTile(ht)||Nt),K.addShadowReceiver(ht.toUnwrapped(),Nt.min,Nt.max)}}if(this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new l.dm(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Ed(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!mn.has(this.context.gl))return;this.renderPass="offscreen";for(let Wt of Y){let ht=e.getLayerSourceCache(Wt);if(!Wt.hasOffscreenPass()||Wt.isHidden(this.transform.zoom))continue;let Nt=ht?z[ht.id]:void 0;(Wt.type==="custom"||Wt.type==="raster"||Wt.type==="raster-particle"||Wt.isSky()||Nt&&Nt.length)&&this.renderLayer(this,ht,Wt,Nt)}this.depthRangeFor3D=[0,1-(Y.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,A)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let nt=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),at=(()=>{if(a.showOverdrawInspector)return l.bz.black;let Wt=this.style.fog;if(Wt&&this.transform.projection.supportsFog){let ht=this.style.getLut(Wt.scope);if(!nt){let Nt=Wt.properties.get("color").toRenderColor(ht).toArray01();return new l.bz(...Nt)}if(nt){let Nt=Wt.properties.get("space-color").toRenderColor(ht).toArray01();return new l.bz(...Nt)}}return l.bz.transparent})();if(this.context.clear({color:at,depth:1}),this.clearStencil(),this._showOverdrawInspector=a.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&nt&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=p.length-1;this.currentLayer>=0;this.currentLayer--){let Wt=Y[this.currentLayer],ht=e.getLayerSourceCache(Wt);if(Wt.isSky())continue;let Nt=ht?(Wt.is3D()?H:z)[ht.id]:void 0;this._renderTileClippingMasks(Wt,ht,Nt),this.renderLayer(this,ht,Wt,Nt)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&nt&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||l.a9(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<p.length;this.currentLayer++){let Wt=Y[this.currentLayer],ht=e.getLayerSourceCache(Wt);Wt.isSky()&&this.renderLayer(this,ht,Wt,ht?z[ht.id]:void 0)}function ct(Wt,ht){let Nt;return ht&&(Nt=(Wt.type==="symbol"?w:Wt.is3D()?H:z)[ht.id]),Nt}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<p.length;){let Wt=Y[this.currentLayer];if(Wt.type==="raster"||Wt.type==="raster-particle"){let ht=e.getLayerSourceCache(Wt);this.renderLayer(this,ht,Wt,ct(Wt,ht))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let rt=0;K&&(rt=K.getShadowCastingLayerCount());let bt=!1,gt=-1;for(let Wt=0;Wt<p.length;++Wt){let ht=Y[Wt];ht.isHidden(this.transform.zoom)||ht.is3D()&&(gt=Wt)}for(U&&gt===-1&&(u=!0);this.currentLayer<p.length;){let Wt=Y[this.currentLayer],ht=e.getLayerSourceCache(Wt);if(Wt.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Wt)){if(Wt.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(u&&!bt&&this.terrain&&!this.transform.isOrthographic&&(bt=!0,this.blitDepth()),U&&gt!==-1&&this.currentLayer===gt+1&&!this.transform.isOrthographic&&this.blitDepth(),Wt.is3D()||this.terrain||this._renderTileClippingMasks(Wt,ht,ht?Q[ht.id]:void 0),this.renderLayer(this,ht,Wt,ct(Wt,ht)),!this.terrain&&K&&rt>0&&Wt.hasShadowPass()&&--rt==0&&(K.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){let Nt=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Nt;this.currentLayer++){let St=Y[this.currentLayer];if(!St.hasLightBeamPass())continue;let wt=e.getLayerSourceCache(St);this.renderLayer(this,wt,St,wt?z[wt.id]:void 0)}this.currentLayer=Nt,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){let Nt=this.currentLayer;this.depthOcclusion=!0;for(let St of this.layersWithOcclusionOpacity){this.currentLayer=St;let wt=Y[this.currentLayer],kt=e.getLayerSourceCache(wt),Ot=kt?z[kt.id]:void 0;wt.is3D()||this.terrain||this._renderTileClippingMasks(wt,kt,kt?Q[kt.id]:void 0),this.renderLayer(this,kt,wt,Ot)}this.depthOcclusion=!1,this.currentLayer=Nt,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Wt=null;Y.forEach(ht=>{let Nt=e.getLayerSourceCache(ht);Nt&&!ht.isHidden(this.transform.zoom)&&Nt.getVisibleCoordinates().length&&(!Wt||Wt.getSource().maxzoom<Nt.getSource().maxzoom)&&(Wt=Nt)}),Wt&&this.options.showTileBoundaries&&$l.debug(this,Wt,Wt.getVisibleCoordinates(),l.bz.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&$l.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new l.bz(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Wt){let ht=Wt.transform.padding;Ei(Wt,Wt.transform.height-(ht.top||0),3,Bp),Ei(Wt,ht.bottom||0,3,cs),Xt(Wt,ht.left||0,3,bs),Xt(Wt,Wt.transform.width-(ht.right||0),3,te);let Nt=Wt.transform.centerPoint;(function(St,wt,kt,Ot){ur(St,wt-1,kt-10,2,20,Ot),ur(St,wt-10,kt-1,20,2,Ot)})(Wt,Nt.x,Wt.transform.height-Nt.y,Ie)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),C||(this.conflationActive=!1)}prepareLayer(e){this.gpuTimingStart(e);let{unsupportedLayers:a}=this.transform.projection,d=!a||!a.includes(e.type);if(Ad[e.type]&&(d||this.terrain&&e.type==="custom")){let m=this.style.getLayerSourceCache(e);Ad[e.type](e,m,this)}this.gpuTimingEnd()}renderLayer(e,a,d,m){d.isHidden(this.transform.zoom)||(d.type==="background"||d.type==="sky"||d.type==="custom"||d.type==="model"||d.type==="raster"||d.type==="raster-particle"||m&&m.length)&&(this.id=d.id,this.gpuTimingStart(d),e.transform.projection.unsupportedLayers&&e.transform.projection.unsupportedLayers.includes(d.type)&&(!e.terrain||d.type!=="custom")||d.type==="clip"||$l[d.type](e,a,d,m,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(e){if(!this.options.gpuTiming)return;let a=this.context.extTimerQuery,d=this.context.gl,m=this.gpuTimers[e.id];m||(m=this.gpuTimers[e.id]={calls:0,cpuTime:0,query:d.createQuery()}),m.calls++,d.beginQuery(a.TIME_ELAPSED_EXT,m.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let e=this.context.extTimerQuery,a=this.context.gl,d=a.createQuery();this.deferredRenderGpuTimeQueries.push(d),a.beginQuery(e.TIME_ELAPSED_EXT,d)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let e=this.gpuTimers;return this.gpuTimers={},e}collectDeferredRenderGpuQueries(){let e=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],e}queryGpuTimers(e){let a={};for(let d in e){let m=e[d],p=this.context.extTimerQuery,u=p.getQueryParameter(m.query,this.context.gl.QUERY_RESULT)/1e6;p.deleteQueryEXT(m.query),a[d]=u}return a}queryGpuTimeDeferredRender(e){if(!this.options.gpuTimingDeferredRender)return 0;let a=this.context.extTimerQuery,d=this.context.gl,m=0;for(let p of e)m+=a.getQueryParameter(p,d.QUERY_RESULT)/1e6,a.deleteQueryEXT(p);return m}translatePosMatrix(e,a,d,m,p){if(!d[0]&&!d[1])return e;let u=p?m==="map"?this.transform.angle:0:m==="viewport"?-this.transform.angle:0;if(u){let y=Math.sin(u),B=Math.cos(u);d=[d[0]*B-d[1]*y,d[0]*y+d[1]*B]}let U=[p?d[0]:l.ak(a,d[0],this.transform.zoom),p?d[1]:l.ak(a,d[1],this.transform.zoom),0],Y=new Float32Array(16);return l.a6.mat4.translate(Y,e,U),Y}saveTileTexture(e){let a=e.size[0],d=this._tileTextures[a];d?d.push(e):this._tileTextures[a]=[e]}getTileTexture(e){let a=this._tileTextures[e];return a&&a.length>0?a.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(e,a,d){let m=d===void 0?this.terrain&&this.terrain.renderingToTexture:d,p=[];return this.style&&this.style.enable3dLights()&&(e==="globeRaster"||e==="terrainRaster"?(p.push("LIGHTING_3D_MODE"),p.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):m||p.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"?this._shadowMapDebug||p.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?p.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):p.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(p.push("TERRAIN"),this.linearFloatFilteringSupported()&&p.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&p.push("GLOBE"),!this._fogVisible||m||a!==void 0&&!a||p.push("FOG","FOG_DITHERING"),m&&p.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&p.push("OVERDRAW_INSPECTOR"),p}getOrCreateProgram(e,a){this.cache=this.cache||{};let d=a&&a.defines||[],m=a&&a.config,p=this.currentGlobalDefines(e,a&&a.overrideFog,a&&a.overrideRtt).concat(d),u=Pl.cacheKey(Dl[e],e,p,m);return this.cache[u]||(this.cache[u]=new Pl(this.context,e,Dl[e],m,Ih[e],p)),this.cache[u]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new l.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(e,a){if(this.style.enable3dLights()){let d=this.style.directionalLight,m=this.style.ambientLight;if(d&&m){let p=((u,U,Y)=>{let y=u.properties.get("direction"),B=u.properties.get("color").toRenderColor(Y.getLut(u.scope)).toArray01(),C=u.properties.get("intensity"),k=U.properties.get("color").toRenderColor(Y.getLut(U.scope)).toArray01(),Q=U.properties.get("intensity"),z=[y.x,y.y,y.z],w=l.cH(k,Q),A=l.cH(B,C);return{u_lighting_ambient_color:w,u_lighting_directional_dir:z,u_lighting_directional_color:A,u_ground_radiance:bb(z,A,w)}})(d,m,this.style);a.setLightsUniformValues(e,p)}}}uploadCommonUniforms(e,a,d,m,p){if(this.uploadCommonLightUniforms(e,a),this.terrain&&this.terrain.renderingToTexture)return;let u=this.style.fog;if(u){let U=u.getOpacity(this.transform.pitch),Y=((y,B,C,k,Q,z,w,A,H,$,et,K)=>{let nt=y.transform,at=B.properties.get("color").toRenderColor(y.style.getLut(B.scope)).toArray01();at[3]=k;let ct=y.frameCounter/1e3%1,[rt,bt]=B.properties.get("vertical-range");return{u_fog_matrix:C?nt.calculateFogTileMatrix(C):K||y.identityMat,u_fog_range:B.getFovAdjustedRange(nt._fov),u_fog_color:at,u_fog_horizon_blend:B.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(rt,bt),bt],u_fog_temporal_offset:ct,u_frustum_tl:Q,u_frustum_tr:z,u_frustum_br:w,u_frustum_bl:A,u_globe_pos:H,u_globe_radius:$,u_viewport:et,u_globe_transition:l.a9(nt.zoom),u_is_globe:+(nt.projection.name==="globe")}})(this,u,d,U,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*l.q.devicePixelRatio,this.transform.height*l.q.devicePixelRatio],m);a.setFogUniformValues(e,Y)}p&&a.setCutoffUniformValues(e,p.uniformValues)}setTileLoadedFlag(e){this.tileLoaded=e}saveCanvasCopy(){let e=this.canvasCopy();e&&(this.frameCopies.push(e),this.tileLoaded=!1)}canvasCopy(){let e=this.context.gl,a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,0,0,e.drawingBufferWidth,e.drawingBufferHeight,0),a}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let e=this.style&&this.style.fog;return!!e&&e.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){let e=this._backgroundTiles,a=this._backgroundTiles={},d=this.transform.coveringTiles({tileSize:512});for(let m of d)a[m.key]=e[m.key]||new ol(m,512,this.transform.tileZoom,this);return a}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(e,a){return!(!e.is3D()||e.type!=="clip"&&(e.minzoom&&e.minzoom>this.transform.zoom||(this.style._clipLayerPresent||e.sourceLayer!=="building")&&(!a||a.type!=="batched-model")))}isTileAffectedByFog(e){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let a=this._cachedTileFogOpacities[e.key];return a||(this._cachedTileFogOpacities[e.key]=a=this.style.fog.getOpacityForTile(e)),a[0]>=de||a[1]>=de}setupDepthForOcclusion(e,a,d){let m=this.context,p=m.gl,u=!!d;var U;d||(d={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),m.activeTexture.set(p.TEXTURE3),e&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),d.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],d.u_depth_range_unpack=[2/((U=this.depthRangeFor3D)[1]-U[0]),-1-2*U[0]/(U[1]-U[0])],d.u_occluder_half_size=.5*this.occlusionParams.occluderSize,d.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),m.activeTexture.set(p.TEXTURE0),u||a.setTerrainUniformValues(m,d)}}function Bl(r,e){let a=!1,d=null,m=()=>{d=null,a&&(r(),d=setTimeout(m,e),a=!1)};return()=>(a=!0,d||m(),d)}class to{constructor(e){this._hashName=e&&encodeURIComponent(e),l.aJ(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Bl(this._updateHashUnthrottled.bind(this),300)}addTo(e){return this._map=e,window.addEventListener("hashchange",this._onHashChange,!1),e.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){let e=this._map;if(!e)return"";let a=Ml(e);if(this._hashName){let d=this._hashName,m=!1,p=location.hash.slice(1).split("&").map(u=>{let U=u.split("=")[0];return U===d?(m=!0,`${U}=${a}`):u}).filter(u=>u);return m||p.push(`${d}=${a}`),`#${p.join("&")}`}return`#${a}`}_getCurrentHash(){let e=location.hash.replace("#","");if(this._hashName){let a;return e.split("&").map(d=>d.split("=")).forEach(d=>{d[0]===this._hashName&&(a=d)}),(a&&a[1]||"").split("/")}return e.split("/")}_onHashChange(){let e=this._map;if(!e)return!1;let a=this._getCurrentHash();if(a.length>=3&&!a.some(d=>isNaN(d))){let d=e.dragRotate.isEnabled()&&e.touchZoomRotate.isEnabled()?+(a[3]||0):e.getBearing();return e.jumpTo({center:[+a[2],+a[1]],zoom:+a[0],bearing:d,pitch:+(a[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Ml(r,e){let a=r.getCenter(),d=Math.round(100*r.getZoom())/100,m=Math.ceil((d*Math.LN2+Math.log(512/360/.5))/Math.LN10),p=Math.pow(10,m),u=Math.round(a.lng*p)/p,U=Math.round(a.lat*p)/p,Y=r.getBearing(),y=r.getPitch(),B=e?`/${u}/${U}/${d}`:`${d}/${U}/${u}`;return(Y||y)&&(B+="/"+Math.round(10*Y)/10),y&&(B+=`/${Math.round(y)}`),B}let Fo={linearity:.3,easing:l.dp(0,0,.3,1)},Hd=l.l({deceleration:2500,maxSpeed:1400},Fo),Yb=l.l({deceleration:20,maxSpeed:1400},Fo),Jb=l.l({deceleration:1e3,maxSpeed:360},Fo),Xb=l.l({deceleration:1e3,maxSpeed:90},Fo);class eo{constructor(e){this._map=e,this.clear()}clear(){this._inertiaBuffer=[]}record(e){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:l.q.now(),settings:e})}_drainInertiaBuffer(){let e=this._inertiaBuffer,a=l.q.now();for(;e.length>0&&a-e[0].time>160;)e.shift()}_onMoveEnd(e){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let a={zoom:0,bearing:0,pitch:0,pan:new l.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:p}of this._inertiaBuffer)a.zoom+=p.zoomDelta||0,a.bearing+=p.bearingDelta||0,a.pitch+=p.pitchDelta||0,p.panDelta&&a.pan._add(p.panDelta),p.around&&(a.around=p.around),p.pinchAround&&(a.pinchAround=p.pinchAround);let d=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,m={};if(a.pan.mag()){let p=Io(a.pan.mag(),d,l.l({},Hd,e||{}));m.offset=a.pan.mult(p.amount/a.pan.mag()),m.center=this._map.transform.center,ps(m,p)}if(a.zoom){let p=Io(a.zoom,d,Yb);m.zoom=this._map.transform.zoom+p.amount,ps(m,p)}if(a.bearing){let p=Io(a.bearing,d,Jb);m.bearing=this._map.transform.bearing+l.ap(p.amount,-179,179),ps(m,p)}if(a.pitch){let p=Io(a.pitch,d,Xb);m.pitch=this._map.transform.pitch+p.amount,ps(m,p)}if(m.zoom||m.bearing){let p=a.pinchAround===void 0?a.around:a.pinchAround;m.around=p?this._map.unproject(p):this._map.getCenter()}return this.clear(),m.noMoveStart=!0,m}}function ps(r,e){(!r.duration||r.duration<e.duration)&&(r.duration=e.duration,r.easing=e.easing)}function Io(r,e,a){let{maxSpeed:d,linearity:m,deceleration:p}=a,u=l.ap(r*m/(e/1e3),-d,d),U=Math.abs(u)/(p*m);return{easing:a.easing,duration:1e3*U,amount:u*(U/2)}}class Pa extends l.x{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,a,d,m={}){let p=_e(a.getCanvasContainer(),d),u=a.unproject(p);super(e,l.l({point:p,lngLat:u,originalEvent:d},m)),this._defaultPrevented=!1,this.target=a}}class Ws extends l.x{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,a,d){let m=e==="touchend"?d.changedTouches:d.touches,p=Zi(a.getCanvasContainer(),m),u=p.map(Y=>a.unproject(Y)),U=p.reduce((Y,y,B,C)=>Y.add(y.div(C.length)),new l.P(0,0));super(e,{points:p,point:U,lngLats:u,lngLat:a.unproject(U),originalEvent:d}),this._defaultPrevented=!1}}class Ja extends l.x{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,a){super("wheel",{originalEvent:a}),this._defaultPrevented=!1}}class yb{constructor(e,a){this._map=e,this._clickTolerance=a.clickTolerance}reset(){this._mousedownPos=void 0}wheel(e){return this._firePreventable(new Ja(this._map,e))}mousedown(e,a){return this._mousedownPos=a,this._firePreventable(new Pa(e.type,this._map,e))}mouseup(e){this._map.fire(new Pa(e.type,this._map,e))}preclick(e){let a=l.l({},e);a.type="preclick",this._map.fire(new Pa(a.type,this._map,a))}click(e,a){this._mousedownPos&&this._mousedownPos.dist(a)>=this._clickTolerance||(this.preclick(e),this._map.fire(new Pa(e.type,this._map,e)))}dblclick(e){return this._firePreventable(new Pa(e.type,this._map,e))}mouseover(e){this._map.fire(new Pa(e.type,this._map,e))}mouseout(e){this._map.fire(new Pa(e.type,this._map,e))}touchstart(e){return this._firePreventable(new Ws(e.type,this._map,e))}touchmove(e){this._map.fire(new Ws(e.type,this._map,e))}touchend(e){this._map.fire(new Ws(e.type,this._map,e))}touchcancel(e){this._map.fire(new Ws(e.type,this._map,e))}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Bb{constructor(e){this._map=e}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(e){this._map.fire(new Pa(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Pa("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._map.fire(new Pa(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class us{constructor(e,a){this._map=e,this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=a.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,a){this.isEnabled()&&e.shiftKey&&e.button===0&&(Xe(),this._startPos=this._lastPos=a,this._active=!0)}mousemoveWindow(e,a){if(!this._active)return;let d=a,m=this._startPos,p=this._lastPos;if(!m||!p||p.equals(d)||!this._box&&d.dist(m)<this._clickTolerance)return;this._lastPos=d,this._box||(this._box=le("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",e));let u=Math.min(m.x,d.x),U=Math.max(m.x,d.x),Y=Math.min(m.y,d.y),y=Math.max(m.y,d.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${u}px,${Y}px)`,this._box.style.width=U-u+"px",this._box.style.height=y-Y+"px")})}mouseupWindow(e,a){if(!this._active)return;let d=this._startPos,m=a;if(d&&e.button===0){if(this.reset(),We(),d.x!==m.x||d.y!==m.y)return this._map.fire(new l.x("boxzoomend",{originalEvent:e})),{cameraAnimation:p=>p.fitScreenCoordinates(d,m,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",e)}}keydown(e){this._active&&e.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",e))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),vi(),delete this._startPos,delete this._lastPos}_fireEvent(e,a){return this._map.fire(new l.x(e,{originalEvent:a}))}}function Tl(r,e){let a={};for(let d=0;d<r.length;d++)a[r[d].identifier]=e[d];return a}class Mb{constructor(e){this.reset(),this.numTouches=e.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(e,a,d){(this.centroid||d.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=e.timeStamp),d.length===this.numTouches&&(this.centroid=function(m){let p=new l.P(0,0);for(let u of m)p._add(u);return p.div(m.length)}(a),this.touches=Tl(d,a)))}touchmove(e,a,d){if(this.aborted||!this.centroid)return;let m=Tl(d,a);for(let p in this.touches){let u=m[p];(!u||u.dist(this.touches[p])>30)&&(this.aborted=!0)}}touchend(e,a,d){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),d.length===0){let m=!this.aborted&&this.centroid;if(this.reset(),m)return m}}}class Rr{constructor(e){this.singleTap=new Mb(e),this.numTaps=e.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(e,a,d){this.singleTap.touchstart(e,a,d)}touchmove(e,a,d){this.singleTap.touchmove(e,a,d)}touchend(e,a,d){let m=this.singleTap.touchend(e,a,d);if(m){let p=e.timeStamp-this.lastTime<500,u=!this.lastTap||this.lastTap.dist(m)<30;if(p&&u||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=m,this.count===this.numTaps)return this.reset(),m}}}class Tb{constructor(){this._zoomIn=new Rr({numTouches:1,numTaps:2}),this._zoomOut=new Rr({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,a,d){this._zoomIn.touchstart(e,a,d),this._zoomOut.touchstart(e,a,d)}touchmove(e,a,d){this._zoomIn.touchmove(e,a,d),this._zoomOut.touchmove(e,a,d)}touchend(e,a,d){let m=this._zoomIn.touchend(e,a,d),p=this._zoomOut.touchend(e,a,d);return m?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:u=>u.easeTo({duration:300,zoom:u.getZoom()+1,around:u.unproject(m)},{originalEvent:e})}):p?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:u=>u.easeTo({duration:300,zoom:u.getZoom()-1,around:u.unproject(p)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}let Gr={0:1,2:2};class Fr{constructor(e){this.reset(),this._clickTolerance=e.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(e,a){return!1}_move(e,a){return{}}mousedown(e,a){if(this._lastPoint)return;let d=Re(e);this._correctButton(e,d)&&(this._lastPoint=a,this._eventButton=d)}mousemoveWindow(e,a){let d=this._lastPoint;if(d){if(e.preventDefault(),this._eventButton!=null&&function(m,p){let u=Gr[p];return m.buttons===void 0||(m.buttons&u)!==u}(e,this._eventButton))this.reset();else if(this._moved||!(a.dist(d)<this._clickTolerance))return this._moved=!0,this._lastPoint=a,this._move(d,a)}}mouseupWindow(e){this._lastPoint&&Re(e)===this._eventButton&&(this._moved&&We(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class jd extends Fr{mousedown(e,a){super.mousedown(e,a),this._lastPoint&&(this._active=!0)}_correctButton(e,a){return a===0&&!e.ctrlKey}_move(e,a){return{around:a,panDelta:a.sub(e)}}}class Od extends Fr{_correctButton(e,a){return a===0&&e.ctrlKey||a===2}_move(e,a){let d=.8*(a.x-e.x);if(d)return this._active=!0,{bearingDelta:d}}contextmenu(e){e.preventDefault()}}class Dd extends Fr{_correctButton(e,a){return a===0&&e.ctrlKey||a===2}_move(e,a){let d=-.5*(a.y-e.y);if(d)return this._active=!0,{pitchDelta:d}}contextmenu(e){e.preventDefault()}}class Bh{constructor(e,a){this._map=e,this._el=e.getCanvasContainer(),this._minTouches=1,this._clickTolerance=a.clickTolerance||1,this.reset(),l.aJ(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new l.P(0,0)}touchstart(e,a,d){return this._calculateTransform(e,a,d)}touchmove(e,a,d){if(this._active&&!(d.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(d.length===1&&!l.dq())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return e.cancelable&&e.preventDefault(),this._calculateTransform(e,a,d)}}touchend(e,a,d){this._calculateTransform(e,a,d),this._active&&d.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(e,a,d){d.length>0&&(this._active=!0);let m=Tl(d,a),p=new l.P(0,0),u=new l.P(0,0),U=0;for(let y in m){let B=m[y],C=this._touches[y];C&&(p._add(B),u._add(B.sub(C)),U++,m[y]=B)}if(this._touches=m,U<this._minTouches||!u.mag())return;let Y=u.div(U);return this._sum._add(Y),this._sum.mag()<this._clickTolerance?void 0:{around:p.div(U),panDelta:Y}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=le("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class _d{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(e){}_move(e,a,d){return{}}touchstart(e,a,d){this._firstTwoTouches||d.length<2||(this._firstTwoTouches=[d[0].identifier,d[1].identifier],this._start([a[0],a[1]]))}touchmove(e,a,d){let m=this._firstTwoTouches;if(!m)return;e.preventDefault();let[p,u]=m,U=Ir(d,a,p),Y=Ir(d,a,u);if(!U||!Y)return;let y=this._aroundCenter?null:U.add(Y).div(2);return this._move([U,Y],y,e)}touchend(e,a,d){if(!this._firstTwoTouches)return;let[m,p]=this._firstTwoTouches,u=Ir(d,a,m),U=Ir(d,a,p);u&&U||(this._active&&We(),this.reset())}touchcancel(){this.reset()}enable(e){this._enabled=!0,this._aroundCenter=!!e&&e.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Ir(r,e,a){for(let d=0;d<r.length;d++)if(r[d].identifier===a)return e[d]}function Cb(r,e){return Math.log(r/e)/Math.LN2}class Mh extends _d{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(e){this._startDistance=this._distance=e[0].dist(e[1])}_move(e,a){let d=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(Cb(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Cb(this._distance,d),pinchAround:a}}}function kb(r,e){return 180*r.angleWith(e)/Math.PI}class Th extends _d{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1])}_move(e,a){let d=this._vector;if(this._vector=e[0].sub(e[1]),d&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:kb(this._vector,d),pinchAround:a}}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());let a=25/(Math.PI*this._minDiameter)*360,d=this._startVector;if(!d)return!1;let m=kb(e,d);return Math.abs(m)<a}}function Pd(r){return Math.abs(r.y)>Math.abs(r.x)}class Ch extends _d{constructor(e){super(),this._map=e}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(e){this._lastPoints=e,Pd(e[0].sub(e[1]))&&(this._valid=!1)}_move(e,a,d){let m=this._lastPoints;if(!m)return;let p=e[0].sub(m[0]),u=e[1].sub(m[1]);return this._map._cooperativeGestures&&!l.dq()&&d.touches.length<3||(this._valid=this.gestureBeginsVertically(p,u,d.timeStamp),!this._valid)?void 0:(this._lastPoints=e,this._active=!0,{pitchDelta:(p.y+u.y)/2*-.5})}gestureBeginsVertically(e,a,d){if(this._valid!==void 0)return this._valid;let m=e.mag()>=2,p=a.mag()>=2;if(!m&&!p)return;if(!m||!p)return this._firstMove==null&&(this._firstMove=d),d-this._firstMove<100&&void 0;let u=e.y>0==a.y>0;return Pd(e)&&Pd(a)&&u}}let kh={panStep:100,bearingStep:15,pitchStep:10};class Sh{constructor(){let e=kh;this._panStep=e.panStep,this._bearingStep=e.bearingStep,this._pitchStep=e.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let a=0,d=0,m=0,p=0,u=0;switch(e.keyCode){case 61:case 107:case 171:case 187:a=1;break;case 189:case 109:case 173:a=-1;break;case 37:e.shiftKey?d=-1:(e.preventDefault(),p=-1);break;case 39:e.shiftKey?d=1:(e.preventDefault(),p=1);break;case 38:e.shiftKey?m=1:(e.preventDefault(),u=-1);break;case 40:e.shiftKey?m=-1:(e.preventDefault(),u=1);break;default:return}return this._rotationDisabled&&(d=0,m=0),{cameraAnimation:U=>{let Y=U.getZoom();U.easeTo({duration:300,easeId:"keyboardHandler",easing:Qh,zoom:a?Math.round(Y)+a*(e.shiftKey?2:1):Y,bearing:U.getBearing()+d*this._bearingStep,pitch:U.getPitch()+m*this._pitchStep,offset:[-p*this._panStep,-u*this._panStep],center:U.getCenter()},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Qh(r){return r*(2-r)}let Sb=4.000244140625,Sp=1/450;class Qp{constructor(e,a){this._map=e,this._el=e.getCanvasContainer(),this._handler=a,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Sp,l.aJ(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(e){this._defaultZoomRate=e}setWheelZoomRate(e){this._wheelZoomRate=e}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!e&&e.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(e){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(e.ctrlKey||e.metaKey||this.isZooming()||l.dq()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let a=e.deltaMode===WheelEvent.DOM_DELTA_LINE?40*e.deltaY:e.deltaY,d=l.q.now(),m=d-(this._lastWheelEventTime||0);this._lastWheelEventTime=d,a!==0&&a%Sb==0?this._type="wheel":a!==0&&Math.abs(a)<4?this._type="trackpad":m>400?(this._type=null,this._lastValue=a,this._timeout=window.setTimeout(this._onTimeout,40,e)):this._type||(this._type=Math.abs(m*a)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,a+=this._lastValue)),e.shiftKey&&a&&(a/=4),this._type&&(this._lastWheelEvent=e,this._delta-=a,this._active||this._start(e)),e.preventDefault()}_onTimeout(e){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(e)}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let a=_e(this._el,e);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:a,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let e=this._map.transform;this._type==="wheel"&&e.projection.wrap&&(e._center.lng>=180||e._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let a=()=>e._terrainEnabled()&&this._aroundCoord?e.computeZoomRelativeTo(this._aroundCoord):e.zoom;if(this._delta!==0){let y=this._type==="wheel"&&Math.abs(this._delta)>Sb?this._wheelZoomRate:this._defaultZoomRate,B=2/(1+Math.exp(-Math.abs(this._delta*y)));this._delta<0&&B!==0&&(B=1/B);let C=a(),k=Math.pow(2,C),Q=typeof this._targetZoom=="number"?e.zoomScale(this._targetZoom):k;this._targetZoom=Math.min(e.maxZoom,Math.max(e.minZoom,e.scaleZoom(Q*B))),this._type==="wheel"&&(this._startZoom=C,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let d=typeof this._targetZoom=="number"?this._targetZoom:a(),m=this._startZoom,p=this._easing,u,U=!1;if(this._type==="wheel"&&m&&p){let y=Math.min((l.q.now()-this._lastWheelEventTime)/200,1),B=p(y);u=l.aa(m,d,B),y<1?this._frameId||(this._frameId=!0):U=!0}else u=d,U=!0;this._active=!0,U&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let Y=u-a();return Y*this._lastDelta<0&&(Y=0),{noInertia:!0,needsRenderFrame:!U,zoomDelta:Y,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(e){let a=l.dr;if(this._prevEase){let d=this._prevEase,m=(l.q.now()-d.start)/d.duration,p=d.easing(m+.01)-d.easing(m),u=.27/Math.sqrt(p*p+1e-4)*.01,U=Math.sqrt(.0729-u*u);a=l.dp(u,U,.25,1)}return this._prevEase={start:l.q.now(),duration:e,easing:a},a}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=le("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Oi{constructor(e,a){this._clickZoom=e,this._tapZoom=a}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class fh{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(e,a){return e.preventDefault(),{cameraAnimation:d=>{d.easeTo({duration:300,zoom:d.getZoom()+(e.shiftKey?-1:1),around:d.unproject(a)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class fp{constructor(){this._tap=new Rr({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(e,a,d){this._swipePoint||(this._tapTime&&e.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?d.length>0&&(this._swipePoint=a[0],this._swipeTouch=d[0].identifier):this._tap.touchstart(e,a,d))}touchmove(e,a,d){if(this._tapTime){if(this._swipePoint){if(d[0].identifier!==this._swipeTouch)return;let m=a[0],p=m.y-this._swipePoint.y;return this._swipePoint=m,e.preventDefault(),this._active=!0,{zoomDelta:p/128}}}else this._tap.touchmove(e,a,d)}touchend(e,a,d){this._tapTime?this._swipePoint&&d.length===0&&this.reset():this._tap.touchend(e,a,d)&&(this._tapTime=e.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class vp{constructor(e,a,d){this._el=e,this._mousePan=a,this._touchPan=d}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Ur{constructor(e,a,d){this._pitchWithRotate=e.pitchWithRotate,this._mouseRotate=a,this._mousePitch=d}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class vh{constructor(e,a,d,m){this._el=e,this._touchZoom=a,this._touchRotate=d,this._tapDragZoom=m,this._rotationDisabled=!1,this._enabled=!0}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}let Zs=r=>r.zoom||r.drag||r.pitch||r.rotate;class Kd extends l.x{}class Cl{constructor(){this.constants=[1,1,.01],this.radius=0}setup(e,a){let d=l.a6.vec3.sub([],a,e);this.radius=l.a6.vec3.length(d[2]<0?l.a6.vec3.div([],d,this.constants):[d[0],d[1],0])}projectRay(e){l.a6.vec3.div(e,e,this.constants),l.a6.vec3.normalize(e,e),l.a6.vec3.mul(e,e,this.constants);let a=l.a6.vec3.scale([],e,this.radius);if(a[2]>0){let d=l.a6.vec3.scale([],[0,0,1],l.a6.vec3.dot(a,[0,0,1])),m=l.a6.vec3.scale([],l.a6.vec3.normalize([],[a[0],a[1],0]),this.radius),p=l.a6.vec3.add([],a,l.a6.vec3.scale([],l.a6.vec3.sub([],l.a6.vec3.add([],m,d),a),2));a[0]=p[0],a[1]=p[1]}return a}}function Uo(r){return r.panDelta&&r.panDelta.mag()||r.zoomDelta||r.bearingDelta||r.pitchDelta}class wa{constructor(e,a){this._map=e,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new eo(e),this._bearingSnap=a.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Cl,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(a),l.aJ(["handleEvent","handleWindowEvent"],this);let d=this._el;this._listeners=[[d,"touchstart",{passive:!0}],[d,"touchmove",{passive:!1}],[d,"touchend",void 0],[d,"touchcancel",void 0],[d,"mousedown",void 0],[d,"mousemove",void 0],[d,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[d,"mouseover",void 0],[d,"mouseout",void 0],[d,"dblclick",void 0],[d,"click",void 0],[d,"keydown",{capture:!1}],[d,"keyup",void 0],[d,"wheel",{passive:!1}],[d,"contextmenu",void 0],[window,"blur",void 0]];for(let[m,p,u]of this._listeners){let U=m===document?this.handleWindowEvent:this.handleEvent;m.addEventListener(p,U,u)}}destroy(){for(let[e,a,d]of this._listeners){let m=e===document?this.handleWindowEvent:this.handleEvent;e.removeEventListener(a,m,d)}}_addDefaultHandlers(e){let a=this._map,d=a.getCanvasContainer();this._add("mapEvent",new yb(a,e));let m=a.boxZoom=new us(a,e);this._add("boxZoom",m);let p=new Tb,u=new fh;a.doubleClickZoom=new Oi(u,p),this._add("tapZoom",p),this._add("clickZoom",u);let U=new fp;this._add("tapDragZoom",U);let Y=a.touchPitch=new Ch(a);this._add("touchPitch",Y);let y=new Od(e),B=new Dd(e);a.dragRotate=new Ur(e,y,B),this._add("mouseRotate",y,["mousePitch"]),this._add("mousePitch",B,["mouseRotate"]);let C=new jd(e),k=new Bh(a,e);a.dragPan=new vp(d,C,k),this._add("mousePan",C),this._add("touchPan",k,["touchZoom","touchRotate"]);let Q=new Th,z=new Mh;a.touchZoomRotate=new vh(d,z,Q,U),this._add("touchRotate",Q,["touchPan","touchZoom"]),this._add("touchZoom",z,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Bb(a));let w=a.scrollZoom=new Qp(a,this);this._add("scrollZoom",w,["mousePan"]);let A=a.keyboard=new Sh;this._add("keyboard",A);for(let H of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])e.interactive&&e[H]&&a[H].enable(e[H])}_add(e,a,d){this._handlers.push({handlerName:e,handler:a,allowed:d}),this._handlersById[e]=a}stop(e){if(!this._updatingCamera){for(let{handler:a}of this._handlers)a.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:e}of this._handlers)if(e.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Zs(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(e,a,d){for(let m in e)if(m!==d&&(!a||a.indexOf(m)<0))return!0;return!1}handleWindowEvent(e){this.handleEvent(e,`${e.type}Window`)}_getMapTouches(e){let a=[];for(let d of e)this._el.contains(d.target)&&a.push(d);return a}handleEvent(e,a){this._updatingCamera=!0;let d=e.type==="renderFrame",m=d?void 0:e,p={needsRenderFrame:!1},u={},U={},Y=e.touches?this._getMapTouches(e.touches):void 0,y=Y?Zi(this._el,Y):d?void 0:_e(this._el,e);for(let{handlerName:k,handler:Q,allowed:z}of this._handlers){if(!Q.isEnabled())continue;let w;this._blockedByActive(U,z,k)?Q.reset():Q[a||e.type]&&(w=Q[a||e.type](e,y,Y),this.mergeHandlerResult(p,u,w,k,m),w&&w.needsRenderFrame&&this._triggerRenderFrame()),(w||Q.isActive())&&(U[k]=Q)}let B={};for(let k in this._previousActiveHandlers)U[k]||(B[k]=m);this._previousActiveHandlers=U,(Object.keys(B).length||Uo(p))&&(this._changes.push([p,u,B]),this._triggerRenderFrame()),(Object.keys(U).length||Uo(p))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:C}=p;C&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],C(this._map))}mergeHandlerResult(e,a,d,m,p){if(!d)return;l.l(e,d);let u={handlerName:m,originalEvent:d.originalEvent||p};d.zoomDelta!==void 0&&(a.zoom=u),d.panDelta!==void 0&&(a.drag=u),d.pitchDelta!==void 0&&(a.pitch=u),d.bearingDelta!==void 0&&(a.rotate=u)}_applyChanges(){let e={},a={},d={};for(let[m,p,u]of this._changes)m.panDelta&&(e.panDelta=(e.panDelta||new l.P(0,0))._add(m.panDelta)),m.zoomDelta&&(e.zoomDelta=(e.zoomDelta||0)+m.zoomDelta),m.bearingDelta&&(e.bearingDelta=(e.bearingDelta||0)+m.bearingDelta),m.pitchDelta&&(e.pitchDelta=(e.pitchDelta||0)+m.pitchDelta),m.around!==void 0&&(e.around=m.around),m.aroundCoord!==void 0&&(e.aroundCoord=m.aroundCoord),m.pinchAround!==void 0&&(e.pinchAround=m.pinchAround),m.noInertia&&(e.noInertia=m.noInertia),l.l(a,p),l.l(d,u);this._updateMapTransform(e,a,d),this._changes=[]}_updateMapTransform(e,a,d){let m=this._map,p=m.transform,u=$=>[$.x,$.y,$.z];if(($=>{let et=this._eventsInProgress.drag;return et&&!this._handlersById[et.handlerName].isActive()})()&&!Uo(e)){let $=p.zoom;p.cameraElevationReference="sea",this._originalZoom!=null&&p._orthographicProjectionAtLowPitch&&p.projection.name!=="globe"&&p.pitch===0?(p.cameraElevationReference="ground",p.zoom=this._originalZoom):(p.recenterOnTerrain(),p.cameraElevationReference="ground"),$!==p.zoom&&this._map._update(!0)}if(p._isCameraConstrained&&m._stop(!0),!Uo(e))return void this._fireEvents(a,d,!0);let{panDelta:U,zoomDelta:Y,bearingDelta:y,pitchDelta:B,around:C,aroundCoord:k,pinchAround:Q}=e;p._isCameraConstrained&&(Y>0&&(Y=0),p._isCameraConstrained=!1),Q!==void 0&&(C=Q),(Y||($=>a[$]&&!this._eventsInProgress[$])("drag"))&&C&&(this._dragOrigin=u(p.pointCoordinate3D(C)),this._originalZoom=p.zoom,this._trackingEllipsoid.setup(p._camera.position,this._dragOrigin)),p.cameraElevationReference="sea",m._stop(!0),C=C||m.transform.centerPoint,y&&(p.bearing+=y),B&&(p.pitch+=B),p._updateCameraState();let z=[0,0,0];if(U)if(p.projection.name==="mercator"){let $=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(C).dir),et=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(C.sub(U)).dir);z[0]=et[0]-$[0],z[1]=et[1]-$[1]}else{let $=p.pointCoordinate(C);if(p.projection.name==="globe"){U=U.rotate(-p.angle);let et=p._pixelsPerMercatorPixel/p.worldSize;z[0]=-U.x*l.ds(l.aM($.y))*et,z[1]=-U.y*l.ds(p.center.lat)*et}else{let et=p.pointCoordinate(C.sub(U));$&&et&&(z[0]=et.x-$.x,z[1]=et.y-$.y)}}let w=p.zoom,A=[0,0,0];if(Y){let $=u(k||p.pointCoordinate3D(C)),et={dir:l.a6.vec3.normalize([],l.a6.vec3.sub([],$,p._camera.position))};if(et.dir[2]<0){let K=p.zoomDeltaToMovement($,Y);l.a6.vec3.scale(A,et.dir,K)}}let H=l.a6.vec3.add(z,z,A);p._translateCameraConstrained(H),Y&&Math.abs(p.zoom-w)>1e-4&&p.recenterOnTerrain(),p.cameraElevationReference="ground",this._map._update(),e.noInertia||this._inertia.record(e),this._fireEvents(a,d,!0)}_fireEvents(e,a,d){let m=Zs(this._eventsInProgress),p=Zs(e),u={};for(let B in e){let{originalEvent:C}=e[B];this._eventsInProgress[B]||(u[`${B}start`]=C),this._eventsInProgress[B]=e[B]}!m&&p&&this._fireEvent("movestart",p.originalEvent);for(let B in u)this._fireEvent(B,u[B]);p&&this._fireEvent("move",p.originalEvent);for(let B in e){let{originalEvent:C}=e[B];this._fireEvent(B,C)}let U={},Y;for(let B in this._eventsInProgress){let{handlerName:C,originalEvent:k}=this._eventsInProgress[B];this._handlersById[C].isActive()||(delete this._eventsInProgress[B],Y=a[C]||k,U[`${B}end`]=Y)}for(let B in U)this._fireEvent(B,U[B]);let y=Zs(this._eventsInProgress);if(d&&(m||p)&&!y){this._updatingCamera=!0;let B=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),C=k=>k!==0&&-this._bearingSnap<k&&k<this._bearingSnap;B?(C(B.bearing||this._map.getBearing())&&(B.bearing=0),this._map.easeTo(B,{originalEvent:Y})):(this._map.fire(new l.x("moveend",{originalEvent:Y})),C(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(e,a){this._map.fire(new l.x(e,a?{originalEvent:a}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(e=>{this._frameId=void 0,this.handleEvent(new Kd("renderFrame",{timeStamp:e})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}let cl="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Qb extends l.E{constructor(e,a){super(),this._moving=!1,this._zooming=!1,this.transform=e,this._bearingSnap=a.bearingSnap,this._respectPrefersReducedMotion=a.respectPrefersReducedMotion!==!1,l.aJ(["_renderFrameCallback"],this)}getCenter(){return new l.bK(this.transform.center.lng,this.transform.center.lat)}setCenter(e,a){return this.jumpTo({center:e},a)}panBy(e,a,d){return e=l.P.convert(e).mult(-1),this.panTo(this.transform.center,l.l({offset:e},a),d)}panTo(e,a,d){return this.easeTo(l.l({center:e},a),d)}getZoom(){return this.transform.zoom}setZoom(e,a){return this.jumpTo({zoom:e},a),this}zoomTo(e,a,d){return this.easeTo(l.l({zoom:e},a),d)}zoomIn(e,a){return this.zoomTo(this.getZoom()+1,e,a),this}zoomOut(e,a){return this.zoomTo(this.getZoom()-1,e,a),this}getBearing(){return this.transform.bearing}setBearing(e,a){return this.jumpTo({bearing:e},a),this}getPadding(){return this.transform.padding}setPadding(e,a){return this.jumpTo({padding:e},a),this}rotateTo(e,a,d){return this.easeTo(l.l({bearing:e},a),d)}resetNorth(e,a){return this.rotateTo(0,l.l({duration:1e3},e),a),this}resetNorthPitch(e,a){return this.easeTo(l.l({bearing:0,pitch:0,duration:1e3},e),a),this}snapToNorth(e,a){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,a):this}getPitch(){return this.transform.pitch}setPitch(e,a){return this.jumpTo({pitch:e},a),this}cameraForBounds(e,a){e=l.as.convert(e);let d=a&&a.bearing||0,m=a&&a.pitch||0,p=e.getNorthWest(),u=e.getSouthEast();return this._cameraForBounds(this.transform,p,u,d,m,a)}_extendPadding(e){let a={top:0,right:0,bottom:0,left:0};return e==null?l.l({},a,this.transform.padding):typeof e=="number"?{top:e,bottom:e,right:e,left:e}:l.l({},a,e)}_extendCameraOptions(e){return(e=l.l({offset:[0,0],maxZoom:this.transform.maxZoom},e)).padding=this._extendPadding(e.padding),e}_minimumAABBFrustumDistance(e,a){let d=a.max[0]-a.min[0],m=a.max[1]-a.min[1];return d/m>e.aspect?d/(2*Math.tan(.5*e.fovX)*e.aspect):m/(2*Math.tan(.5*e.fovY)*e.aspect)}_cameraForBoundsOnGlobe(e,a,d,m,p,u){let U=e.clone(),Y=this._extendCameraOptions(u);U.bearing=m,U.pitch=p;let y=l.bK.convert(a),B=l.bK.convert(d),C=.5*(y.lat+B.lat),k=.5*(y.lng+B.lng),Q=l.dt(C,k),z=l.a6.vec3.normalize([],Q),w=l.a6.vec3.normalize([],l.a6.vec3.cross([],z,[0,1,0])),A=l.a6.vec3.cross([],w,z),H=[w[0],w[1],w[2],0,A[0],A[1],A[2],0,z[0],z[1],z[2],0,0,0,0,1],$=[Q,l.dt(y.lat,y.lng),l.dt(B.lat,y.lng),l.dt(B.lat,B.lng),l.dt(y.lat,B.lng),l.dt(C,y.lng),l.dt(C,B.lng),l.dt(y.lat,k),l.dt(B.lat,k)],et=l.c9.fromPoints($.map(vt=>[l.a6.vec3.dot(w,vt),l.a6.vec3.dot(A,vt),l.a6.vec3.dot(z,vt)])),K=l.a6.vec3.transformMat4([],et.center,H);l.a6.vec3.squaredLength(K)===0&&l.a6.vec3.set(K,0,0,1),l.a6.vec3.normalize(K,K),l.a6.vec3.scale(K,K,l.aq),U.center=l.du(K);let nt=U.getWorldToCameraMatrix(),at=l.a6.mat4.invert(new Float64Array(16),nt);et=l.c9.applyTransform(et,l.a6.mat4.multiply([],nt,H));let ct=this._extendAABB(et,U,Y,m);if(!ct)return void l.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");et=ct,l.a6.vec3.transformMat4(K,K,nt);let rt=.5*(et.max[2]-et.min[2]),bt=this._minimumAABBFrustumDistance(U,et),gt=l.a6.vec3.scale([],[0,0,1],rt),Wt=l.a6.vec3.add(gt,K,gt),ht=bt+(U.pitch===0?0:l.a6.vec3.distance(K,Wt)),Nt=U.globeCenterInViewSpace,St=l.a6.vec3.sub([],K,[Nt[0],Nt[1],Nt[2]]);l.a6.vec3.normalize(St,St),l.a6.vec3.scale(St,St,ht);let wt=l.a6.vec3.add([],K,St);l.a6.vec3.transformMat4(wt,wt,at);let kt=l.dw/l.aq,Ot=l.a6.vec3.length(wt),Yt=l.bD(Math.max(Ot*kt-l.dw,Number.EPSILON),0),Lt=Math.min(U.zoomFromMercatorZAdjusted(Yt),Y.maxZoom);return Lt>.5*(l.c2+l.bU)?(U.setProjection({name:"mercator"}),U.zoom=Lt,this._cameraForBounds(U,a,d,m,p,u)):{center:U.center,zoom:Lt,bearing:m,pitch:p}}_extendAABB(e,a,d,m){let p=.5*((d.padding.left||0)+(d.padding.right||0)),u=.5*((d.padding.top||0)+(d.padding.bottom||0)),U=u,Y=p,y=p,B=u,C=a.width-(Y+y),k=a.height-(U+B),Q=l.a6.vec3.sub([],e.max,e.min),z=Math.min(C/Q[0],k/Q[1]),w=Math.min(a.scaleZoom(a.scale*z),d.maxZoom);if(isNaN(w))return null;let A=a.scale/a.zoomScale(w),H=new l.c9([e.min[0]-Y*A,e.min[1]-B*A,e.min[2]],[e.max[0]+y*A,e.max[1]+U*A,e.max[2]]),$=(typeof d.offset.x=="number"&&typeof d.offset.y=="number"?new l.P(d.offset.x,d.offset.y):l.P.convert(d.offset)).rotate(-l.bB(m));return H.center[0]-=$.x*A,H.center[1]+=$.y*A,H}queryTerrainElevation(e,a){let d=this.transform.elevation;return d?(a=l.l({},{exaggerated:!0},a),d.getAtPoint(l.a5.fromLngLat(e),null,a.exaggerated)):null}_cameraForBounds(e,a,d,m,p,u){if(e.projection.name==="globe")return this._cameraForBoundsOnGlobe(e,a,d,m,p,u);let U=e.clone(),Y=this._extendCameraOptions(u);U.bearing=m,U.pitch=p;let y=l.bK.convert(a),B=l.bK.convert(d),C=new l.bK(y.lng,B.lat),k=new l.bK(B.lng,y.lat),Q=U.project(y),z=U.project(B),w=this.queryTerrainElevation(y),A=this.queryTerrainElevation(B),H=this.queryTerrainElevation(C),$=this.queryTerrainElevation(k),et=[[Q.x,Q.y,Math.min(w||0,A||0,H||0,$||0)],[z.x,z.y,Math.max(w||0,A||0,H||0,$||0)]],K=l.c9.fromPoints(et),nt=U.getWorldToCameraMatrix(),at=l.a6.mat4.invert(new Float64Array(16),nt);K=l.c9.applyTransform(K,nt);let ct=this._extendAABB(K,U,Y,m);if(!ct)return void l.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");K=ct;let rt=.5*l.a6.vec3.sub([],K.max,K.min)[2],bt=this._minimumAABBFrustumDistance(U,K),gt=[0,0,1,0];l.a6.vec4.transformMat4(gt,gt,nt),l.a6.vec4.normalize(gt,gt);let Wt=l.a6.vec3.scale([],gt,bt+rt),ht=l.a6.vec3.add([],K.center,Wt);l.a6.vec3.transformMat4(K.center,K.center,at),l.a6.vec3.transformMat4(ht,ht,at);let Nt=U.unproject(new l.P(K.center[0],K.center[1])),St=l.dv(U.projection,Nt),wt=Math.pow(2,St),kt=Math.min(U._zoomFromMercatorZ(ht[2]*U.pixelsPerMeter*wt/U.worldSize),Y.maxZoom);return U.mercatorFromTransition&&kt<.5*(l.c2+l.bU)?(U.setProjection({name:"globe"}),U.zoom=kt,this._cameraForBounds(U,a,d,m,p,u)):{center:Nt,zoom:kt,bearing:m,pitch:p}}fitBounds(e,a,d){let m=this.cameraForBounds(e,a);return this._fitInternal(m,a,d)}fitScreenCoordinates(e,a,d,m,p){let u=l.P.convert(e),U=l.P.convert(a),Y=new l.P(Math.min(u.x,U.x),Math.min(u.y,U.y)),y=new l.P(Math.max(u.x,U.x),Math.max(u.y,U.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(u,U))return this;let B=this.transform.pointLocation3D(Y),C=this.transform.pointLocation3D(y),k=this.transform.pointLocation3D(new l.P(Y.x,y.y)),Q=this.transform.pointLocation3D(new l.P(y.x,Y.y)),z=[Math.min(B.lng,C.lng,k.lng,Q.lng),Math.min(B.lat,C.lat,k.lat,Q.lat)],w=[Math.max(B.lng,C.lng,k.lng,Q.lng),Math.max(B.lat,C.lat,k.lat,Q.lat)],A=m&&m.pitch?m.pitch:this.getPitch(),H=this._cameraForBounds(this.transform,z,w,d,A,m);return this._fitInternal(H,m,p)}_fitInternal(e,a,d){return e?(a=l.l(e,a)).linear?this.easeTo(a,d):this.flyTo(a,d):this}jumpTo(e,a){this.stop();let d=e.preloadOnly?this.transform.clone():this.transform,m=!1,p=!1,u=!1;"zoom"in e&&d.zoom!==+e.zoom&&(m=!0,d.zoom=+e.zoom),e.center!==void 0&&(d.center=l.bK.convert(e.center)),"bearing"in e&&d.bearing!==+e.bearing&&(p=!0,d.bearing=+e.bearing),"pitch"in e&&d.pitch!==+e.pitch&&(u=!0,d.pitch=+e.pitch);let U=typeof e.padding=="number"?this._extendPadding(e.padding):e.padding;if(e.padding!=null&&!d.isPaddingEqual(U))if(e.retainPadding===!1){let Y=d.clone();Y.padding=U,d.setLocationAtPoint(d.center,Y.centerPoint)}else d.padding=U;return e.preloadOnly?(this._preloadTiles(d),this):(this.fire(new l.x("movestart",a)).fire(new l.x("move",a)),m&&this.fire(new l.x("zoomstart",a)).fire(new l.x("zoom",a)).fire(new l.x("zoomend",a)),p&&this.fire(new l.x("rotatestart",a)).fire(new l.x("rotate",a)).fire(new l.x("rotateend",a)),u&&this.fire(new l.x("pitchstart",a)).fire(new l.x("pitch",a)).fire(new l.x("pitchend",a)),this.fire(new l.x("moveend",a)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||l.w(cl),this.transform.getFreeCameraOptions()}setFreeCameraOptions(e,a){let d=this.transform;if(!d.projection.supportsFreeCamera)return l.w(cl),this;this.stop();let m=d.zoom,p=d.pitch,u=d.bearing;d.setFreeCameraOptions(e);let U=m!==d.zoom,Y=p!==d.pitch,y=u!==d.bearing;return this.fire(new l.x("movestart",a)).fire(new l.x("move",a)),U&&this.fire(new l.x("zoomstart",a)).fire(new l.x("zoom",a)).fire(new l.x("zoomend",a)),y&&this.fire(new l.x("rotatestart",a)).fire(new l.x("rotate",a)).fire(new l.x("rotateend",a)),Y&&this.fire(new l.x("pitchstart",a)).fire(new l.x("pitch",a)).fire(new l.x("pitchend",a)),this.fire(new l.x("moveend",a)),this}easeTo(e,a){this._stop(!1,e.easeId),((e=l.l({offset:[0,0],duration:500,easing:l.dr},e)).animate===!1||this._prefersReducedMotion(e))&&(e.duration=0);let d=this.transform,m=this.getZoom(),p=this.getBearing(),u=this.getPitch(),U=this.getPadding(),Y="zoom"in e?+e.zoom:m,y="bearing"in e?this._normalizeBearing(e.bearing,p):p,B="pitch"in e?+e.pitch:u,C=this._extendPadding(e.padding),k=l.P.convert(e.offset),Q,z,w;if(d.projection.name==="globe"){let gt=l.a5.fromLngLat(d.center),Wt=k.rotate(-d.angle);gt.x+=Wt.x/d.worldSize,gt.y+=Wt.y/d.worldSize;let ht=gt.toLngLat(),Nt=l.bK.convert(e.center||ht);this._normalizeCenter(Nt),Q=d.centerPoint.add(Wt),z=new l.P(gt.x,gt.y).mult(d.worldSize),w=new l.P(l.am(Nt.lng),l.at(Nt.lat)).mult(d.worldSize).sub(z)}else{Q=d.centerPoint.add(k);let gt=d.pointLocation(Q),Wt=l.bK.convert(e.center||gt);this._normalizeCenter(Wt),z=d.project(gt),w=d.project(Wt).sub(z)}let A=d.zoomScale(Y-m),H,$;e.around&&(H=l.bK.convert(e.around),$=d.locationPoint(H));let et=this._zooming||Y!==m,K=this._rotating||p!==y,nt=this._pitching||B!==u,at=!d.isPaddingEqual(C),ct=e.retainPadding===!1?d.clone():d,rt=gt=>Wt=>{if(et&&(gt.zoom=l.aa(m,Y,Wt)),K&&(gt.bearing=l.aa(p,y,Wt)),nt&&(gt.pitch=l.aa(u,B,Wt)),at&&(ct.interpolatePadding(U,C,Wt),Q=ct.centerPoint.add(k)),H)gt.setLocationAtPoint(H,$);else{let ht=gt.zoomScale(gt.zoom-m),Nt=Y>m?Math.min(2,A):Math.max(.5,A),St=Math.pow(Nt,1-Wt),wt=gt.unproject(z.add(w.mult(Wt*St)).mult(ht));gt.setLocationAtPoint(gt.renderWorldCopies?wt.wrap():wt,Q)}return e.preloadOnly||this._fireMoveEvents(a),gt};if(e.preloadOnly){let gt=this._emulate(rt,e.duration,d);return this._preloadTiles(gt),this}let bt={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=et,this._rotating=K,this._pitching=nt,this._padding=at,this._easeId=e.easeId,this._prepareEase(a,e.noMoveStart,bt),this._ease(rt(d),gt=>{d.cameraElevationReference==="sea"&&d.recenterOnTerrain(),this._afterEase(a,gt)},e),this}_prepareEase(e,a,d={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),a||d.moving||this.fire(new l.x("movestart",e)),this._zooming&&!d.zooming&&this.fire(new l.x("zoomstart",e)),this._rotating&&!d.rotating&&this.fire(new l.x("rotatestart",e)),this._pitching&&!d.pitching&&this.fire(new l.x("pitchstart",e))}_fireMoveEvents(e){this.fire(new l.x("move",e)),this._zooming&&this.fire(new l.x("zoom",e)),this._rotating&&this.fire(new l.x("rotate",e)),this._pitching&&this.fire(new l.x("pitch",e))}_afterEase(e,a){if(this._easeId&&a&&this._easeId===a)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let d=this._zooming,m=this._rotating,p=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,d&&this.fire(new l.x("zoomend",e)),m&&this.fire(new l.x("rotateend",e)),p&&this.fire(new l.x("pitchend",e)),this.fire(new l.x("moveend",e))}flyTo(e,a){if(this._prefersReducedMotion(e)){let vt=l.ar(e,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(vt,a)}this.stop(),e=l.l({offset:[0,0],speed:1.2,curve:1.42,easing:l.dr},e);let d=this.transform,m=this.getZoom(),p=this.getBearing(),u=this.getPitch(),U=this.getPadding(),Y="zoom"in e?l.ap(+e.zoom,d.minZoom,d.maxZoom):m,y="bearing"in e?this._normalizeBearing(e.bearing,p):p,B="pitch"in e?+e.pitch:u,C=this._extendPadding(e.padding),k=d.zoomScale(Y-m),Q=l.P.convert(e.offset),z=d.centerPoint.add(Q),w=d.pointLocation(z),A=l.bK.convert(e.center||w);this._normalizeCenter(A);let H=d.project(w),$=d.project(A).sub(H),et=e.curve,K=Math.max(d.width,d.height),nt=K/k,at=$.mag();if("minZoom"in e){let vt=l.ap(Math.min(e.minZoom,m,Y),d.minZoom,d.maxZoom),_t=K/d.zoomScale(vt-m);et=Math.sqrt(_t/at*2)}let ct=et*et;function rt(vt){let _t=(nt*nt-K*K+(vt?-1:1)*ct*ct*at*at)/(2*(vt?nt:K)*ct*at);return Math.log(Math.sqrt(_t*_t+1)-_t)}function bt(vt){return(Math.exp(vt)-Math.exp(-vt))/2}function gt(vt){return(Math.exp(vt)+Math.exp(-vt))/2}let Wt=rt(0),ht=function(vt){return gt(Wt)/gt(Wt+et*vt)},Nt=function(vt){return K*((gt(Wt)*(bt(_t=Wt+et*vt)/gt(_t))-bt(Wt))/ct)/at;var _t},St=(rt(1)-Wt)/et;if(Math.abs(at)<1e-6||!isFinite(St)){if(Math.abs(K-nt)<1e-6)return this.easeTo(e,a);let vt=nt<K?-1:1;St=Math.abs(Math.log(nt/K))/et,Nt=function(){return 0},ht=function(_t){return Math.exp(vt*et*_t)}}e.duration="duration"in e?+e.duration:1e3*St/("screenSpeed"in e?+e.screenSpeed/et:+e.speed),e.maxDuration&&e.duration>e.maxDuration&&(e.duration=0);let wt=p!==y,kt=B!==u,Ot=!d.isPaddingEqual(C),Yt=e.retainPadding===!1?d.clone():d,Lt=vt=>_t=>{let qt=_t*St,zt=1/ht(qt);vt.zoom=_t===1?Y:m+vt.scaleZoom(zt),wt&&(vt.bearing=l.aa(p,y,_t)),kt&&(vt.pitch=l.aa(u,B,_t)),Ot&&(Yt.interpolatePadding(U,C,_t),z=Yt.centerPoint.add(Q));let Ht=_t===1?A:vt.unproject(H.add($.mult(Nt(qt))).mult(zt));return vt.setLocationAtPoint(vt.renderWorldCopies?Ht.wrap():Ht,z),vt._updateCameraOnTerrain(),e.preloadOnly||this._fireMoveEvents(a),vt};if(e.preloadOnly){let vt=this._emulate(Lt,e.duration,d);return this._preloadTiles(vt),this}return this._zooming=!0,this._rotating=wt,this._pitching=kt,this._padding=Ot,this._prepareEase(a,!1),this._ease(Lt(d),()=>this._afterEase(a),e),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(e){}_cancelRenderFrame(e){}_stop(e,a){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let d=this._onEaseEnd;this._onEaseEnd=void 0,d.call(this,a)}if(!e){let d=this.handlers;d&&d.stop(!1)}return this}_ease(e,a,d){d.animate===!1||d.duration===0?(e(1),a()):(this._easeStart=l.q.now(),this._easeOptions=d,this._onEaseFrame=e,this._onEaseEnd=a,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let e=Math.min((l.q.now()-this._easeStart)/this._easeOptions.duration,1),a=this._onEaseFrame;a&&a(this._easeOptions.easing(e)),e<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(e,a){e=l.bA(e,-180,180);let d=Math.abs(e-a);return Math.abs(e-360-a)<d&&(e-=360),Math.abs(e+360-a)<d&&(e+=360),e}_normalizeCenter(e){let a=this.transform;if(a.maxBounds||a.projection.name!=="globe"&&!a.renderWorldCopies)return;let d=e.lng-a.center.lng;e.lng+=d>180?-360:d<-180?360:0}_prefersReducedMotion(e){return this._respectPrefersReducedMotion&&l.q.prefersReducedMotion&&!(e&&e.essential)}_emulate(e,a,d){let m=Math.ceil(15*a/1e3),p=[],u=e(d.clone());for(let U=0;U<=m;U++){let Y=u(U/m);p.push(Y.clone())}return p}_preloadTiles(e,a){}}class qd{constructor(e={}){this.options=e,l.aJ(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(e){let a=this.options&&this.options.compact,d=e._getUIString("AttributionControl.ToggleAttribution");this._map=e,this._container=le("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=le("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",d);let m=le("span","mapboxgl-ctrl-icon",this._compactButton);return m.setAttribute("aria-hidden","true"),m.setAttribute("title",d),this._innerContainer=le("div","mapboxgl-ctrl-attrib-inner",this._container),a&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),a===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let e=this._editLink;e||(e=this._editLink=this._container.querySelector(".mapbox-improve-map"));let a=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||l.e.ACCESS_TOKEN}];if(e){let d=a.reduce((m,p,u)=>(p.value&&(m+=`${p.key}=${p.value}${u<a.length-1?"&":""}`),m),"?");e.href=`${l.e.FEEDBACK_URL}/${d}#${Ml(this._map,!0)}`,e.rel="noopener nofollow"}}_updateData(e){!e||e.sourceDataType!=="metadata"&&e.sourceDataType!=="visibility"&&e.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let e=[];if(this._map.style.stylesheet){let m=this._map.style.stylesheet;this.styleOwner=m.owner,this.styleId=m.id}let a=this._map.style._mergedSourceCaches;for(let m in a){let p=a[m];if(p.used){let u=p.getSource();u.attribution&&e.indexOf(u.attribution)<0&&e.push(u.attribution)}}e.sort((m,p)=>m.length-p.length),e=e.filter((m,p)=>{for(let u=p+1;u<e.length;u++)if(e[u].indexOf(m)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=[...this.options.customAttribution,...e]:e.unshift(this.options.customAttribution));let d=e.join(" | ");d!==this._attribHTML&&(this._attribHTML=d,e.length?(this._innerContainer.innerHTML=d,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class fb{constructor(){l.aJ(["_updateLogo","_updateCompact"],this)}onAdd(e){this._map=e,this._container=le("div","mapboxgl-ctrl");let a=le("a","mapboxgl-ctrl-logo");return a.target="_blank",a.rel="noopener nofollow",a.href="https://www.mapbox.com/",a.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),a.setAttribute("rel","noopener nofollow"),this._container.appendChild(a),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(e){e&&e.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let e=this._map.style._sourceCaches;if(Object.entries(e).length===0)return!0;for(let a in e){let d=e[a].getSource();if(d.hasOwnProperty("mapbox_logo")&&!d.mapbox_logo)return!1}return!0}_updateCompact(){let e=this._container.children;if(e.length){let a=e[0];this._map.getCanvasContainer().offsetWidth<250?a.classList.add("mapboxgl-compact"):a.classList.remove("mapboxgl-compact")}}}class Eh{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(e){let a=++this._id;return this._queue.push({callback:e,id:a,cancelled:!1}),a}remove(e){let a=this._currentlyRunning,d=a?this._queue.concat(a):this._queue;for(let m of d)if(m.id===e)return void(m.cancelled=!0)}run(e=0){let a=this._currentlyRunning=this._queue;this._queue=[];for(let d of a)if(!d.cancelled&&(d.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class xr{constructor(e){this.jumpTo(e)}getValue(e){if(e<=this._startTime)return this._start;if(e>=this._endTime)return this._end;let a=l.cw((e-this._startTime)/(this._endTime-this._startTime));return this._start*(1-a)+this._end*a}isEasing(e){return e>=this._startTime&&e<=this._endTime}jumpTo(e){this._startTime=-1/0,this._endTime=-1/0,this._start=e,this._end=e}easeTo(e,a,d){this._start=this.getValue(a),this._end=e,this._startTime=a,this._endTime=a+d}}let Ep={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Lp{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class vb{constructor(e){this.map=e,this.interactionsByType=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this)}add(e,a){if(this.typeById.has(e))throw new Error(`Interaction id "${e}" already exists.`);let{type:d,filter:m}=a;if(m){let u=l.M(m,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(u.result==="error")throw new Error(u.value.map(U=>`${U.key}: ${U.message}`).join(", "));this.filters.set(e,u.value)}let p=this.interactionsByType.get(d)||new Map;p.size===0&&(this.map.on(d,this.handleType),this.interactionsByType.set(d,p)),p.set(e,a),this.typeById.set(e,d)}remove(e){let a=this.typeById.get(e);if(!a)return;this.typeById.delete(e),this.filters.delete(e);let d=this.interactionsByType.get(a);d&&(d.delete(e),d.size===0&&this.map.off(a,this.handleType))}handleType(e){let a=e.features||this.map.queryRenderedFeatures(e.point);if(!a)return;let d=this.interactionsByType.get(e.type),m={zoom:0};for(let[p,u]of d){let U=this.filters.get(p),{handler:Y,layers:y}=u;for(let B of a)if((!y||y.includes(B.layer.id))&&(!U||U.evaluate(m,B))&&Y({id:p,feature:B,interaction:u})!==!1)break}}}let Eb={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0},Nr={showCompass:!0,showZoom:!0,visualizePitch:!1};class gs{constructor(e,a,d=!1){this._clickTolerance=10,this.element=a,this.mouseRotate=new Od({clickTolerance:e.dragRotate._mouseRotate._clickTolerance}),this.map=e,d&&(this.mousePitch=new Dd({clickTolerance:e.dragRotate._mousePitch._clickTolerance})),l.aJ(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),a.addEventListener("mousedown",this.mousedown),a.addEventListener("touchstart",this.touchstart,{passive:!1}),a.addEventListener("touchmove",this.touchmove),a.addEventListener("touchend",this.touchend),a.addEventListener("touchcancel",this.reset)}down(e,a){this.mouseRotate.mousedown(e,a),this.mousePitch&&this.mousePitch.mousedown(e,a),Xe()}move(e,a){let d=this.map,m=this.mouseRotate.mousemoveWindow(e,a),p=m&&m.bearingDelta;if(p&&d.setBearing(d.getBearing()+p),this.mousePitch){let u=this.mousePitch.mousemoveWindow(e,a),U=u&&u.pitchDelta;U&&d.setPitch(d.getPitch()+U)}}off(){let e=this.element;e.removeEventListener("mousedown",this.mousedown),e.removeEventListener("touchstart",this.touchstart,{passive:!1}),e.removeEventListener("touchmove",this.touchmove),e.removeEventListener("touchend",this.touchend),e.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){vi(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(e){this.down(l.l({},e,{ctrlKey:!0,preventDefault:()=>e.preventDefault()}),_e(this.element,e)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(e){this.move(e,_e(this.element,e))}mouseup(e){this.mouseRotate.mouseupWindow(e),this.mousePitch&&this.mousePitch.mouseupWindow(e),this.offTemp()}touchstart(e){e.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Zi(this.element,e.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>e.preventDefault()},this._startPos))}touchmove(e){e.targetTouches.length!==1?this.reset():(this._lastPos=Zi(this.element,e.targetTouches)[0],this.move({preventDefault:()=>e.preventDefault()},this._lastPos))}touchend(e){e.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function bl(r,e,a){if(r=new l.bK(r.lng,r.lat),e){let d=new l.bK(r.lng-360,r.lat),m=new l.bK(r.lng+360,r.lat),p=360*Math.ceil(Math.abs(r.lng-a.center.lng)/360),u=a.locationPoint(r).distSqr(e),U=e.x<0||e.y<0||e.x>a.width||e.y>a.height;a.locationPoint(d).distSqr(e)<u&&(U||Math.abs(d.lng-a.center.lng)<p)?r=d:a.locationPoint(m).distSqr(e)<u&&(U||Math.abs(m.lng-a.center.lng)<p)&&(r=m)}for(;Math.abs(r.lng-a.center.lng)>180;){let d=a.locationPoint(r);if(d.x>=0&&d.y>=0&&d.x<=a.width&&d.y<=a.height)break;r.lng>a.center.lng?r.lng-=360:r.lng+=360}return r}let Gn={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class ml extends l.E{constructor(e,a){if(super(),(e instanceof HTMLElement||a)&&(e=l.l({element:e},a)),l.aJ(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=e&&e.anchor||"center",this._color=e&&e.color||"#3FB1CE",this._scale=e&&e.scale||1,this._draggable=e&&e.draggable||!1,this._clickTolerance=e&&e.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=e&&e.rotation||0,this._rotationAlignment=e&&e.rotationAlignment||"auto",this._pitchAlignment=e&&e.pitchAlignment&&e.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=e&&e.occludedOpacity||.2,e&&e.element)this._element=e.element,this._offset=l.P.convert(e&&e.offset||[0,0]);else{this._defaultMarker=!0,this._element=le("div");let p=41,u=27,U=je("svg",{display:"block",height:p*this._scale+"px",width:u*this._scale+"px",viewBox:`0 0 ${u} ${p}`},this._element),Y=je("radialGradient",{id:"shadowGradient"},je("defs",{},U));je("stop",{offset:"10%","stop-opacity":.4},Y),je("stop",{offset:"100%","stop-opacity":.05},Y),je("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},U),je("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},U),je("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},U),je("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},U),this._offset=l.P.convert(e&&e.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",p=>{p.preventDefault()}),this._element.addEventListener("mousedown",p=>{p.preventDefault()});let d=this._element.classList;for(let p in Gn)d.remove(`mapboxgl-marker-anchor-${p}`);d.add(`mapboxgl-marker-anchor-${this._anchor}`);let m=e&&e.className?e.className.trim().split(/\s+/):[];d.add(...m),this._popup=null}addTo(e){return e===this._map||(this.remove(),this._map=e,e.getCanvasContainer().appendChild(this._element),e.on("move",this._updateMoving),e.on("moveend",this._update),e.on("remove",this._clearFadeTimer),e._addMarker(this),this.setDraggable(this._draggable),this._update(),e.on("click",this._onMapClick)),this}remove(){let e=this._map;return e&&(e.off("click",this._onMapClick),e.off("move",this._updateMoving),e.off("moveend",this._update),e.off("mousedown",this._addDragHandler),e.off("touchstart",this._addDragHandler),e.off("mouseup",this._onUp),e.off("touchend",this._onUp),e.off("mousemove",this._onMove),e.off("touchmove",this._onMove),e.off("remove",this._clearFadeTimer),e._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(e){return this._lngLat=l.bK.convert(e),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){let m=Math.sqrt(Math.pow(13.5,2)/2);e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[m,-1*(38.1-13.5+m)],"bottom-right":[-m,-1*(38.1-13.5+m)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=e,e._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(e){let a=e.code,d=e.charCode||e.keyCode;a!=="Space"&&a!=="Enter"&&d!==32&&d!==13||this.togglePopup()}_onMapClick(e){let a=e.originalEvent.target,d=this._element;this._popup&&(a===d||d.contains(a))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let e=this._popup;return e?(e.isOpen()?(e.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(e.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){let e=this._map,a=this._pos;if(!e||!a)return!1;let d=e.unproject(a),m=e.getFreeCameraOptions();if(!m.position)return!1;let p=m.position.toLngLat();return p.distanceTo(d)<.9*p.distanceTo(this._lngLat)}_evaluateOpacity(){let e=this._map;if(!e)return;let a=this._pos;if(!a||a.x<0||a.x>e.transform.width||a.y<0||a.y>e.transform.height)return void this._clearFadeTimer();let d=e.unproject(a),m;e._showingGlobe()&&l.dz(e.transform,this._lngLat)?m=0:(m=1-e._queryFogOpacity(d),e.transform._terrainEnabled()&&e.getTerrain()&&this._behindTerrain()&&(m*=this._occludedOpacity)),this._element.style.opacity=`${m}`,this._element.style.pointerEvents=m>0?"auto":"none",this._popup&&this._popup._setOpacity(m),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let e=this._pos;if(!e||!this._map)return;let a=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${e.x}px,${e.y}px)
            ${Gn[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${a.x}px,${a.y}px)
        `}_calculateXYTransform(){let e=this._pos,a=this._map,d=this.getPitchAlignment();if(!a||!e||d!=="map")return"";if(!a._showingGlobe()){let Y=a.getPitch();return Y?`rotateX(${Y}deg)`:""}let m=l.c0(l.dA(a.transform,this._lngLat)),p=e.sub(l.dB(a.transform)),u=Math.abs(p.x)+Math.abs(p.y);if(u===0)return"";let U=m/u;return`rotateX(${-p.y*U}deg) rotateY(${p.x*U}deg)`}_calculateZTransform(){let e=this._pos,a=this._map;if(!a||!e)return"";let d=0,m=this.getRotationAlignment();if(m==="map")if(a._showingGlobe()){let p=a.project(new l.bK(this._lngLat.lng,this._lngLat.lat+.001)),u=a.project(new l.bK(this._lngLat.lng,this._lngLat.lat-.001)).sub(p);d=l.c0(Math.atan2(u.y,u.x))-90}else d=-a.getBearing();else if(m==="horizon"){let p=l.a7(4,6,a.getZoom()),u=l.dB(a.transform);u.y+=p*a.transform.height;let U=e.sub(u),Y=l.c0(Math.atan2(U.y,U.x));d=(Y>90?Y-270:Y+90)*(1-p)}return d+=this._rotation,d?`rotateZ(${d}deg)`:""}_update(e){cancelAnimationFrame(this._updateFrameId);let a=this._map;a&&(a.transform.renderWorldCopies&&(this._lngLat=bl(this._lngLat,this._pos,a.transform)),this._pos=a.project(this._lngLat),e===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),a._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(a._showingGlobe()||a.getTerrain()||a.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(e){return this._offset=l.P.convert(e),this._update(),this}addClassName(e){return this._element.classList.add(e),this}removeClassName(e){return this._element.classList.remove(e),this}toggleClassName(e){return this._element.classList.toggle(e)}_onMove(e){let a=this._map;if(!a)return;let d=this._pointerdownPos,m=this._positionDelta;if(d&&m){if(!this._isDragging){let p=this._clickTolerance||a._clickTolerance;if(e.point.dist(d)<p)return;this._isDragging=!0}this._pos=e.point.sub(m),this._lngLat=a.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new l.x("dragstart"))),this.fire(new l.x("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let e=this._map;e&&(e.off("mousemove",this._onMove),e.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new l.x("dragend")),this._state="inactive"}_addDragHandler(e){let a=this._map,d=this._pos;a&&d&&this._element.contains(e.originalEvent.target)&&(e.preventDefault(),this._positionDelta=e.point.sub(d),this._pointerdownPos=e.point,this._state="pending",a.on("mousemove",this._onMove),a.on("touchmove",this._onMove),a.once("mouseup",this._onUp),a.once("touchend",this._onUp))}setDraggable(e){this._draggable=!!e;let a=this._map;return a&&(e?(a.on("mousedown",this._addDragHandler),a.on("touchstart",this._addDragHandler)):(a.off("mousedown",this._addDragHandler),a.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(e){return this._rotation=e||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(e){return this._rotationAlignment=e||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(e){return this._pitchAlignment=e||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(e){return this._occludedOpacity=e||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}let xo={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},io={maxWidth:100,unit:"metric"},zp={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},wp={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Ap=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Lh(r=new l.P(0,0),e="bottom"){if(typeof r=="number"){let a=Math.round(Math.sqrt(.5*Math.pow(r,2)));switch(e){case"top":return new l.P(0,r);case"top-left":return new l.P(a,a);case"top-right":return new l.P(-a,a);case"bottom":return new l.P(0,-r);case"bottom-left":return new l.P(a,-a);case"bottom-right":return new l.P(-a,-a);case"left":return new l.P(r,0);case"right":return new l.P(-r,0)}return new l.P(0,0)}return r instanceof l.P||Array.isArray(r)?l.P.convert(r):l.P.convert(r[e]||[0,0])}return{version:lt,supported:re.supported,setRTLTextPlugin:l.dC,getRTLTextPluginStatus:l.dD,Map:class extends Qb{constructor(r){Gt.mark(It.create);let e=r;if((r=l.l({},Eb,r)).minZoom!=null&&r.maxZoom!=null&&r.minZoom>r.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(r.minPitch!=null&&r.maxPitch!=null&&r.minPitch>r.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(r.minPitch!=null&&r.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(r.maxPitch!=null&&r.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(r.antialias&&l.dx(window)&&(r.antialias=!1,l.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new bd(r.minZoom,r.maxZoom,r.minPitch,r.maxPitch,r.renderWorldCopies),r),this._repaint=!!r.repaint,this._interactive=r.interactive,this._minTileCacheSize=r.minTileCacheSize,this._maxTileCacheSize=r.maxTileCacheSize,this._failIfMajorPerformanceCaveat=r.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=r.preserveDrawingBuffer,this._antialias=r.antialias,this._trackResize=r.trackResize,this._bearingSnap=r.bearingSnap,this._refreshExpiredTiles=r.refreshExpiredTiles,this._fadeDuration=r.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=r.crossSourceCollisions,this._collectResourceTiming=r.collectResourceTiming,this._language=this._parseLanguage(r.language),this._worldview=r.worldview,this._renderTaskQueue=new Eh,this._domRenderTaskQueue=new Eh,this._controls=[],this._markers=[],this._popups=[],this._mapId=l.aP(),this._locale=l.l({},Ep,r.locale),this._clickTolerance=r.clickTolerance,this._cooperativeGestures=r.cooperativeGestures,this._performanceMetricsCollection=r.performanceMetricsCollection,this._tessellationStep=r.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=r.precompilePrograms,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new xr(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._requestManager=new Sa(r.transformRequest,r.accessToken,r.testMode),this._silenceAuthErrors=!!r.testMode,this._contextCreateOptions=r.contextCreateOptions?{...r.contextCreateOptions}:{},typeof r.container=="string"){let a=document.getElementById(r.container);if(!a)throw new Error(`Container '${r.container.toString()}' not found.`);this._container=a}else{if(!(r.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=r.container}if(this._container.childNodes.length>0&&l.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),r.maxBounds&&this.setMaxBounds(r.maxBounds),l.aJ(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Lp),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new wa(this,r),this._localFontFamily=r.localFontFamily,this._localIdeographFontFamily=r.localIdeographFontFamily,(r.style||!r.testMode)&&this.setStyle(r.style||l.e.DEFAULT_STYLE,{config:r.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),r.projection&&this.setProjection(r.projection),r.hash&&(this._hash=new to(typeof r.hash=="string"&&r.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){e.center==null&&e.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:r.center,zoom:r.zoom,bearing:r.bearing,pitch:r.pitch});let a=r.bounds;a&&(this.resize(),this.fitBounds(a,l.l({},r.fitBoundsOptions,{duration:0})))}this.resize(),r.attributionControl&&this.addControl(new qd({customAttribution:r.customAttribution})),this._logoControl=new fb,this.addControl(this._logoControl,r.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",a=>{this._update(a.dataType==="style"),this.fire(new l.x(`${a.dataType}data`,a))}),this.on("dataloading",a=>{this.fire(new l.x(`${a.dataType}dataloading`,a))}),this._interactions=new vb(this)}_getMapId(){return this._mapId}addControl(r,e){if(e===void 0&&(e=r.getDefaultPosition?r.getDefaultPosition():"top-right"),!r||!r.onAdd)return this.fire(new l.t(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let a=r.onAdd(this);this._controls.push(r);let d=this._controlPositions[e];return e.indexOf("bottom")!==-1?d.insertBefore(a,d.firstChild):d.appendChild(a),this}removeControl(r){if(!r||!r.onRemove)return this.fire(new l.t(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let e=this._controls.indexOf(r);return e>-1&&this._controls.splice(e,1),r.onRemove(this),this}hasControl(r){return this._controls.indexOf(r)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(r){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let e=!this._moving;return e&&this.fire(new l.x("movestart",r)).fire(new l.x("move",r)),this.fire(new l.x("resize",r)),e&&this.fire(new l.x("moveend",r)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(r){return this.transform.setMaxBounds(l.as.convert(r)),this._update()}setMinZoom(r){if((r=r??-2)>=-2&&r<=this.transform.maxZoom)return this.transform.minZoom=r,this._update(),this.getZoom()<r?this.setZoom(r):this.fire(new l.x("zoomstart")).fire(new l.x("zoom")).fire(new l.x("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(r){if((r=r??22)>=this.transform.minZoom)return this.transform.maxZoom=r,this._update(),this.getZoom()>r?this.setZoom(r):this.fire(new l.x("zoomstart")).fire(new l.x("zoom")).fire(new l.x("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(r){if((r=r??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(r>=0&&r<=this.transform.maxPitch)return this.transform.minPitch=r,this._update(),this.getPitch()<r?this.setPitch(r):this.fire(new l.x("pitchstart")).fire(new l.x("pitch")).fire(new l.x("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(r){if((r=r??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(r>=this.transform.minPitch)return this.transform.maxPitch=r,this._update(),this.getPitch()>r?this.setPitch(r):this.fire(new l.x("pitchstart")).fire(new l.x("pitch")).fire(new l.x("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(r){return this.transform.renderWorldCopies=r,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(r){return r==="auto"?navigator.language:Array.isArray(r)?r.length===0?void 0:r.map(e=>e==="auto"?navigator.language:e):r}setLanguage(r){let e=this._parseLanguage(r);if(!this.style||e===this._language)return this;this._language=e,this.style.reloadSources();for(let a of this._controls)a._setLanguage&&a._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(r){return this.style&&r!==this._worldview?(this._worldview=r,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(r){return this._lazyInitEmptyStyle(),r?typeof r=="string"&&(r={name:r}):r=null,this._useExplicitProjection=!!r,this._prioritizeAndUpdateProjection(r,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;let r=this.transform,e=r.projection.name,a;e==="globe"&&r.zoom>=l.bU?(r.setMercatorFromTransition(),a=!0):e==="mercator"&&r.zoom<l.bU&&(r.setProjection({name:"globe"}),a=!0),a&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(r,e){return this._updateProjection(r||e||{name:"mercator"})}_updateProjection(r){let e;return e=r.name==="globe"&&this.transform.zoom>=l.bU?this.transform.setMercatorFromTransition():this.transform.setProjection(r),this.style.applyProjectionUpdate(),e&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(r){return this.transform.locationPoint3D(l.bK.convert(r))}unproject(r){return this.transform.pointLocation3D(l.P.convert(r))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(r,e,a){if(r==="mouseenter"||r==="mouseover"){let d=!1,m=u=>{let U=e.filter(y=>this.getLayer(y)),Y=U.length?this.queryRenderedFeatures(u.point,{layers:U}):[];Y.length?d||(d=!0,a.call(this,new Pa(r,this,u.originalEvent,{features:Y}))):d=!1},p=()=>{d=!1};return{layers:new Set(e),listener:a,delegates:{mousemove:m,mouseout:p}}}if(r==="mouseleave"||r==="mouseout"){let d=!1,m=u=>{let U=e.filter(Y=>this.getLayer(Y));(U.length?this.queryRenderedFeatures(u.point,{layers:U}):[]).length?d=!0:d&&(d=!1,a.call(this,new Pa(r,this,u.originalEvent)))},p=u=>{d&&(d=!1,a.call(this,new Pa(r,this,u.originalEvent)))};return{layers:new Set(e),listener:a,delegates:{mousemove:m,mouseout:p}}}{let d=m=>{let p=e.filter(U=>this.getLayer(U)),u=p.length?this.queryRenderedFeatures(m.point,{layers:p}):[];u.length&&(m.features=u,a.call(this,m),delete m.features)};return{layers:new Set(e),listener:a,delegates:{[r]:d}}}}on(r,e,a){if(typeof e=="function"||a===void 0)return super.on(r,e);if(Array.isArray(e)||(e=[e]),e){for(let m of e)if(!this._isValidId(m))return this}let d=this._createDelegatedListener(r,e,a);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[r]=this._delegatedListeners[r]||[],this._delegatedListeners[r].push(d);for(let m in d.delegates)this.on(m,d.delegates[m]);return this}once(r,e,a){if(typeof e=="function"||a===void 0)return super.once(r,e);if(Array.isArray(e)||(e=[e]),e){for(let m of e)if(!this._isValidId(m))return this}let d=this._createDelegatedListener(r,e,a);for(let m in d.delegates)this.once(m,d.delegates[m]);return this}off(r,e,a){if(typeof e=="function"||a===void 0)return super.off(r,e);let d=new Set(Array.isArray(e)?e:[e]);for(let u of d)if(!this._isValidId(u))return this;let m=(u,U)=>{if(u.size!==U.size)return!1;for(let Y of u)if(!U.has(Y))return!1;return!0},p=this._delegatedListeners?this._delegatedListeners[r]:void 0;return p&&(u=>{for(let U=0;U<u.length;U++){let Y=u[U];if(Y.listener===a&&m(Y.layers,d)){for(let y in Y.delegates)this.off(y,Y.delegates[y]);return u.splice(U,1),this}}})(p),this}queryRenderedFeatures(r,e){if(!this.style)return[];if(e!==void 0||r===void 0||r instanceof l.P||Array.isArray(r)||(e=r,r=void 0),r=r||[[0,0],[this.transform.width,this.transform.height]],(e=e||{}).layers&&Array.isArray(e.layers)){for(let a of e.layers)if(!this._isValidId(a))return[]}return this.style.queryRenderedFeatures(r,e,this.transform)}querySourceFeatures(r,e){return this._isValidId(r)?this.style.querySourceFeatures(r,e):[]}isPointOnSurface(r){let{name:e}=this.transform.projection;return e!=="globe"&&e!=="mercator"&&l.w(`${e} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(l.P.convert(r))}addInteraction(r,e){return this._interactions.add(r,e),this}removeInteraction(r){return this._interactions.remove(r),this}setStyle(r,e){return e=l.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},e),this.style&&r&&e.diff!==!1&&e.localFontFamily===this._localFontFamily&&e.localIdeographFontFamily===this._localIdeographFontFamily&&!e.config?(this.style._diffStyle(r,(a,d)=>{a?(l.w(`Unable to perform style diff: ${String(a.message||a.error||a)}. Rebuilding the style from scratch.`),this._updateStyle(r,e)):d&&this._update(!0)},()=>{this._postStyleLoadEvent()}),this):(this._localIdeographFontFamily=e.localIdeographFontFamily,this._localFontFamily=e.localFontFamily,this._updateStyle(r,e))}_getUIString(r){let e=this._locale[r];if(e==null)throw new Error(`Missing UI string '${r}'`);return e}_updateStyle(r,e){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),r){let a=l.l({},e);e&&e.config&&(a.initialConfig=e.config,delete a.config),this.style=new Vn(this,a).load(r),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Vn(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(l.w("There is no style added to the map."),!1)}_isValidId(r){return r==null?(this.fire(new l.t(new Error("IDs can't be empty."))),!1):!l.cn(r)||(this.fire(new l.t(new Error(`IDs can't contain special symbols: "${r}".`))),!1)}addSource(r,e){return this._isValidId(r)?(this._lazyInitEmptyStyle(),this.style.addSource(r,e),this._update(!0)):this}isSourceLoaded(r){return!!this._isValidId(r)&&!!this.style&&this.style._isSourceCacheLoaded(r)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(r,e,a){this._lazyInitEmptyStyle(),this.style.addSourceType(r,e,a)}removeSource(r){return this._isValidId(r)?(this.style.removeSource(r),this._updateTerrain(),this._update(!0)):this}getSource(r){return this._isValidId(r)?this.style.getOwnSource(r):null}addImage(r,e,{pixelRatio:a=1,sdf:d=!1,stretchX:m,stretchY:p,content:u}={}){if(this._lazyInitEmptyStyle(),e instanceof HTMLImageElement||ImageBitmap&&e instanceof ImageBitmap){let{width:U,height:Y,data:y}=l.q.getImageData(e);this.style.addImage(r,{data:new l.r({width:U,height:Y},y),pixelRatio:a,stretchX:m,stretchY:p,content:u,sdf:d,version:0})}else if(e.width===void 0||e.height===void 0)this.fire(new l.t(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:U,height:Y}=e,y=e;this.style.addImage(r,{data:new l.r({width:U,height:Y},new Uint8Array(y.data)),pixelRatio:a,stretchX:m,stretchY:p,content:u,sdf:d,version:0,userImage:y}),y.onAdd&&y.onAdd(this,r)}}updateImage(r,e){this._lazyInitEmptyStyle();let a=this.style.getImage(r);if(!a)return void this.fire(new l.t(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let d=e instanceof HTMLImageElement||ImageBitmap&&e instanceof ImageBitmap?l.q.getImageData(e):e,{width:m,height:p,data:u}=d;if(m===void 0||p===void 0)return void this.fire(new l.t(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(m!==a.data.width||p!==a.data.height)return void this.fire(new l.t(new Error(`The width and height of the updated image (${m}, ${p})
                must be that same as the previous version of the image
                (${a.data.width}, ${a.data.height})`)));let U=!(e instanceof HTMLImageElement||ImageBitmap&&e instanceof ImageBitmap);a.data.replace(u,U),this.style.updateImage(r,a)}hasImage(r){return r?!!this.style&&!!this.style.getImage(r):(this.fire(new l.t(new Error("Missing required image id"))),!1)}removeImage(r){this.style.removeImage(r)}loadImage(r,e){l.o(this._requestManager.transformRequest(r,l.R.Image),(a,d)=>{e(a,d instanceof HTMLImageElement?l.q.getImageData(d):d)})}listImages(){return this.style.listImages()}addModel(r,e){this._lazyInitEmptyStyle(),this.style.addModel(r,e)}hasModel(r){return r?this.style.hasModel(r):(this.fire(new l.t(new Error("Missing required model id"))),!1)}removeModel(r){this.style.removeModel(r)}listModels(){return this.style.listModels()}addLayer(r,e){return this._isValidId(r.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(r,e),this._update(!0)):this}getSlot(r){let e=this.getLayer(r);return e&&e.slot||null}setSlot(r,e){return this.style.setSlot(r,e),this.style.mergeLayers(),this._update(!0)}addImport(r,e){return this.style.addImport(r,e),this}updateImport(r,e){return typeof e!="string"&&e.id!==r?(this.removeImport(r),this.addImport(e)):(this.style.updateImport(r,e),this._update(!0))}removeImport(r){return this.style.removeImport(r),this}moveImport(r,e){return this.style.moveImport(r,e),this._update(!0)}moveLayer(r,e){return this._isValidId(r)?(this.style.moveLayer(r,e),this._update(!0)):this}removeLayer(r){return this._isValidId(r)?(this.style.removeLayer(r),this._update(!0)):this}getLayer(r){if(!this._isValidId(r))return null;let e=this.style.getOwnLayer(r);return e?e.type==="custom"?e.implementation:e.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(r,e,a){return this._isValidId(r)?(this.style.setLayerZoomRange(r,e,a),this._update(!0)):this}setFilter(r,e,a={}){return this._isValidId(r)?(this.style.setFilter(r,e,a),this._update(!0)):this}getFilter(r){return this._isValidId(r)?this.style.getFilter(r):null}setPaintProperty(r,e,a,d={}){return this._isValidId(r)?(this.style.setPaintProperty(r,e,a,d),this._update(!0)):this}getPaintProperty(r,e){return this._isValidId(r)?this.style.getPaintProperty(r,e):null}setLayoutProperty(r,e,a,d={}){return this._isValidId(r)?(this.style.setLayoutProperty(r,e,a,d),this._update(!0)):this}getLayoutProperty(r,e){return this._isValidId(r)?this.style.getLayoutProperty(r,e):null}getSchema(r){return this.style.getSchema(r)}setSchema(r,e){return this.style.setSchema(r,e),this._update(!0)}getConfig(r){return this.style.getConfig(r)}setConfig(r,e){return this.style.setConfig(r,e),this._update(!0)}getConfigProperty(r,e){return this.style.getConfigProperty(r,e)}setConfigProperty(r,e,a){return this.style.setConfigProperty(r,e,a),this._update(!0)}setLights(r){if(this._lazyInitEmptyStyle(),r&&r.length===1&&r[0].type==="flat"){let e=r[0];e.properties?this.style.setFlatLight(e.properties,e.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(r),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let r=this.style.getLights()||[];return r.length===0&&r.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),r}setLight(r,e={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:r}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(r){return this._lazyInitEmptyStyle(),!r&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(r),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(r){return this._lazyInitEmptyStyle(),this.style.setFog(r),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setColorTheme(r){return this._lazyInitEmptyStyle(),this.style.setColorTheme(r),this._update(!0)}setCamera(r){return this.style.setCamera(r),this._triggerCameraUpdate(r)}_triggerCameraUpdate(r){return this._update(this.transform.setOrthographicProjectionAtLowPitch(r["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(r){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(l.bK.convert(r),this.transform):0}setFeatureState(r,e){return this._isValidId(r.source)?(this.style.setFeatureState(r,e),this._update()):this}removeFeatureState(r,e){return this._isValidId(r.source)?(this.style.removeFeatureState(r,e),this._update()):this}getFeatureState(r){return this._isValidId(r.source)?this.style.getFeatureState(r):null}_updateContainerDimensions(){if(!this._container)return;let r=this._container.getBoundingClientRect().width||400,e=this._container.getBoundingClientRect().height||300,a,d,m,p=this._container;for(;p&&(!d||!m);){let u=window.getComputedStyle(p).transform;u&&u!=="none"&&(a=u.match(/matrix.*\((.+)\)/)[1].split(", "),a[0]&&a[0]!=="0"&&a[0]!=="1"&&(d=a[0]),a[3]&&a[3]!=="0"&&a[3]!=="1"&&(m=a[3])),p=p.parentElement}this._containerWidth=d?Math.abs(r/d):r,this._containerHeight=m?Math.abs(e/m):e}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&l.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){let r=this._container;r.classList.add("mapboxgl-map"),(this._missingCSSCanary=le("div","mapboxgl-canary",r)).style.visibility="hidden",this._detectMissingCSS();let e=this._canvasContainer=le("div","mapboxgl-canvas-container",r);this._canvas=le("canvas","mapboxgl-canvas",e),this._interactive&&(e.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let a=this._controlContainer=le("div","mapboxgl-control-container",r),d=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(m=>{d[m]=le("div",`mapboxgl-ctrl-${m}`,a)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(r,e){let a=l.q.devicePixelRatio||1;this._canvas.width=a*Math.ceil(r),this._canvas.height=a*Math.ceil(e),this._canvas.style.width=`${r}px`,this._canvas.style.height=`${e}px`}_addMarker(r){this._markers.push(r)}_removeMarker(r){let e=this._markers.indexOf(r);e!==-1&&this._markers.splice(e,1)}_addPopup(r){this._popups.push(r)}_removePopup(r){let e=this._popups.indexOf(r);e!==-1&&this._popups.splice(e,1)}_setupPainter(){let r=l.l({},re.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),e=this._canvas.getContext("webgl2",r);e?(el(e,!0),this.painter=new Nb(e,this._contextCreateOptions,this.transform,this._tp),this.on("data",a=>{a.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),l.m.testSupport(e)):this.fire(new l.t(new Error("Failed to initialize WebGL")))}_contextLost(r){r.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new l.x("webglcontextlost",{originalEvent:r}))}_contextRestored(r){this._setupPainter(),this.resize(),this._update(),this.fire(new l.x("webglcontextrestored",{originalEvent:r}))}_onMapScroll(r){if(r.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(r){return this.style?(this._styleDirty=this._styleDirty||r,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(r){return this._update(),this._renderTaskQueue.add(r)}_cancelRenderFrame(r){this._renderTaskQueue.remove(r)}_requestDomTask(r){!this.loaded()||this.loaded()&&!this.isMoving()?r():this._domRenderTaskQueue.add(r)}_render(r){let e;this.fire(new l.x("renderstart")),++this._frameId;let a=this.painter.context.extTimerQuery,d=l.q.now(),m=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(e=m.createQuery(),m.beginQuery(a.TIME_ELAPSED_EXT,e)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(r),this._domRenderTaskQueue.run(r),this._removed)return;this._updateProjectionTransition();let p=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let y=this.transform.zoom,B=this.transform.pitch,C=l.q.now(),k=new l.a3(y,{now:C,fadeDuration:p,pitch:B,transition:this.style.transition});this.style.update(k)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let u=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),u=this._updateAverageElevation(d),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):u=this._updateAverageElevation(d);let U=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,p,this._crossSourceCollisions,this.painter.replacementSource);if(U&&(this._placementDirty=U.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:p,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new l.x("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Gt.mark(It.load),this.fire(new l.x("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),e){let y=l.q.now()-d;m.endQuery(a.TIME_ELAPSED_EXT),setTimeout(()=>{let B=m.getQueryParameter(e,m.QUERY_RESULT)/1e6;m.deleteQuery(e),this.fire(new l.x("gpu-timing-frame",{cpuTime:y,gpuTime:B}))},50)}if(this.listens("gpu-timing-layer")){let y=this.painter.collectGpuTimers();setTimeout(()=>{let B=this.painter.queryGpuTimers(y);this.fire(new l.x("gpu-timing-layer",{layerTimes:B}))},50)}if(this.listens("gpu-timing-deferred-render")){let y=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let B=this.painter.queryGpuTimeDeferredRender(y);this.fire(new l.x("gpu-timing-deferred-render",{gpuTime:B}))},50)}let Y=this._sourcesDirty||this._styleDirty||this._placementDirty||u;if(Y||this._repaint)this.triggerRepaint();else{let y=this.idle();if(y&&(u=this._updateAverageElevation(d,!0)),u)this.triggerRepaint();else if(this._triggerFrame(!1),y&&(this.fire(new l.x("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let B=this._calculateSpeedIndex();this.fire(new l.x("speedindexcompleted",{speedIndex:B})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||Y||(this._fullyLoaded=!0,Gt.mark(It.fullLoad),this._performanceMetricsCollection&&En(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(r){for(let e of this._markers)r&&!this.getRenderWorldCopies()&&(e._lngLat=e._lngLat.wrap()),e._update();for(let e of this._popups)!r||this.getRenderWorldCopies()||e._trackPointer||(e._lngLat=e._lngLat.wrap()),e._update()}_updateAverageElevation(r,e=!1){let a=m=>(this.transform.averageElevation=m,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&a(0);let d=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(d||(e||r-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(r)){let m=this.transform.averageElevation,p=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(p)?p=0:this._averageElevationLastSampledAt=r;let u=Math.abs(m-p);if(u>1){if(this._isInitialLoad||d)return this._averageElevation.jumpTo(p),a(p);this._averageElevation.easeTo(p,r,300)}else if(u>1e-4)return this._averageElevation.jumpTo(p),a(p)}return!!this._averageElevation.isEasing(r)&&a(this._averageElevation.getValue(r))}_authenticate(){ut(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,r=>{if(r&&(r.message===Pi||r.status===401)){let e=this.painter.context.gl;el(e,!1),this._logoControl instanceof fb&&this._logoControl._updateLogo(),e&&e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new l.t(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),vn(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Ga(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){let r=this._isDragging();this.painter.updateTerrain(this.style,r)}_calculateSpeedIndex(){let r=this.painter.canvasCopy(),e=this.painter.getCanvasCopiesAndTimestamps();e.timeStamps.push(performance.now());let a=this.painter.context.gl,d=a.createFramebuffer();function m(p){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,p,0);let u=new Uint8Array(a.drawingBufferWidth*a.drawingBufferHeight*4);return a.readPixels(0,0,a.drawingBufferWidth,a.drawingBufferHeight,a.RGBA,a.UNSIGNED_BYTE,u),u}return a.bindFramebuffer(a.FRAMEBUFFER,d),this._canvasPixelComparison(m(r),e.canvasCopies.map(m),e.timeStamps)}_canvasPixelComparison(r,e,a){let d=a[1]-a[0],m=r.length/4;for(let p=0;p<e.length;p++){let u=e[p],U=0;for(let Y=0;Y<u.length;Y+=4)u[Y]===r[Y]&&u[Y+1]===r[Y+1]&&u[Y+2]===r[Y+2]&&u[Y+3]===r[Y+3]&&(U+=1);d+=(a[p+2]-a[p+1])*(1-U/m)}return d}remove(){this._hash&&this._hash.remove();for(let e of this._controls)e.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let r=this.painter.context.gl.getExtension("WEBGL_lose_context");r&&r.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),mn.delete(this.painter.context.gl),Jn.remove(),Qe.remove(),this._removed=!0,this.fire(new l.x("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(r){this._renderNextFrame=this._renderNextFrame||r,this.style&&!this._frame&&(this._frame=l.q.frame(e=>{let a=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,a&&this._render(e)}))}_preloadTiles(r){let e=this.style?this.style.getSourceCaches():[];return l.bf(e,(a,d)=>a._preloadTiles(r,d),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(r){this._trackResize&&this.resize({originalEvent:r})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(r){this._showTileBoundaries!==r&&(this._showTileBoundaries=r,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(r){this._showParseStatus!==r&&(this._showParseStatus=r,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(r){this._showTerrainWireframe!==r&&(this._showTerrainWireframe=r,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(r){this._showLayers2DWireframe!==r&&(this._showLayers2DWireframe=r,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(r){this._showLayers3DWireframe!==r&&(this._showLayers3DWireframe=r,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(r){this._speedIndexTiming!==r&&(this._speedIndexTiming=r,this._update())}get showPadding(){return!!this._showPadding}set showPadding(r){this._showPadding!==r&&(this._showPadding=r,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(r){this._showCollisionBoxes!==r&&(this._showCollisionBoxes=r,this._tp.refreshUI(),r?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(r){this._showOverdrawInspector!==r&&(this._showOverdrawInspector=r,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(r){this._repaint!==r&&(this._repaint=r,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(r){this._vertices=r,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(r){this._showTileAABBs!==r&&(this._showTileAABBs=r,this._tp.refreshUI(),r&&this._update())}_setCacheLimits(r,e){l.dy(r,e)}get version(){return lt}},NavigationControl:class{constructor(r={}){this.options=l.l({},Nr,r),this._container=le("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",e=>e.preventDefault()),this.options.showZoom&&(l.aJ(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",e=>{this._map&&this._map.zoomIn({},{originalEvent:e})}),le("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",e=>{this._map&&this._map.zoomOut({},{originalEvent:e})}),le("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(l.aJ(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",e=>{let a=this._map;a&&(this.options.visualizePitch?a.resetNorthPitch({},{originalEvent:e}):a.resetNorth({},{originalEvent:e}))}),this._compassIcon=le("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let r=this._map;if(!r)return;let e=r.getZoom(),a=e===r.getMaxZoom(),d=e===r.getMinZoom();this._zoomInButton.disabled=a,this._zoomOutButton.disabled=d,this._zoomInButton.setAttribute("aria-disabled",a.toString()),this._zoomOutButton.setAttribute("aria-disabled",d.toString())}_rotateCompassArrow(){let r=this._map;if(!r)return;let e=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(r.transform.pitch*(Math.PI/180)),.5)}) rotateX(${r.transform.pitch}deg) rotateZ(${r.transform.angle*(180/Math.PI)}deg)`:`rotate(${r.transform.angle*(180/Math.PI)}deg)`;r._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=e)})}onAdd(r){return this._map=r,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),r.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&r.on("pitch",this._rotateCompassArrow),r.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new gs(r,this._compass,this.options.visualizePitch)),this._container}onRemove(){let r=this._map;r&&(this._container.remove(),this.options.showZoom&&r.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&r.off("pitch",this._rotateCompassArrow),r.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(r,e){let a=le("button",r,this._container);return a.type="button",a.addEventListener("click",e),a}_setButtonTitle(r,e){if(!this._map)return;let a=this._map._getUIString(`NavigationControl.${e}`);r.setAttribute("aria-label",a),r.firstElementChild&&r.firstElementChild.setAttribute("title",a)}},GeolocateControl:class extends l.E{constructor(r={}){super();let e=navigator.geolocation;this.options=l.l({geolocation:e},xo,r),l.aJ(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Bl(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(r){return this._map=r,this._container=le("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(r){let e=(a=!!this.options.geolocation)=>{this._supportsGeolocation=a,r(a)};this._supportsGeolocation!==void 0?r(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(a=>e(a.state!=="denied")).catch(()=>e()):e()}_isOutOfMapMaxBounds(r){let e=this._map.getMaxBounds(),a=r.coords;return!!e&&(a.longitude<e.getWest()||a.longitude>e.getEast()||a.latitude<e.getSouth()||a.latitude>e.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(r){if(this._map){if(this._isOutOfMapMaxBounds(r))return this._setErrorState(),this.fire(new l.x("outofmaxbounds",r)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=r,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(r),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(r),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new l.x("geolocate",r)),this._finish()}}_updateCamera(r){let e=new l.bK(r.coords.longitude,r.coords.latitude),a=r.coords.accuracy,d=this._map.getBearing(),m=l.l({bearing:d},this.options.fitBoundsOptions);this._map.fitBounds(e.toBounds(a),m,{geolocateSource:!0})}_updateMarker(r){if(r){let e=new l.bK(r.coords.longitude,r.coords.latitude);this._accuracyCircleMarker.setLngLat(e).addTo(this._map),this._userLocationDotMarker.setLngLat(e).addTo(this._map),this._accuracy=r.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let r=this._map.transform,e=l.bD(1,r._center.lat)*r.worldSize,a=Math.ceil(2*this._accuracy*e);this._circleElement.style.width=`${a}px`,this._circleElement.style.height=`${a}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(r){if(this._map){if(this.options.trackUserLocation)if(r.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(r.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new l.x("error",r)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(r){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",e=>e.preventDefault()),this._geolocateButton=le("button","mapboxgl-ctrl-geolocate",this._container),le("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",r===!1){l.w("Geolocation support is not available so the GeolocateControl will be disabled.");let e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}else{let e=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=le("div","mapboxgl-user-location"),this._dotElement.appendChild(le("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(le("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ml({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=le("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ml({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",e=>{e.geolocateSource||this._watchState!=="ACTIVE_LOCK"||e.originalEvent&&e.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new l.x("trackuserlocationend")))})}}_onDeviceOrientation(r){this._userLocationDotMarker&&(r.webkitCompassHeading?this._heading=r.webkitCompassHeading:r.absolute===!0&&(this._heading=-1*r.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return l.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new l.x("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new l.x("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new l.x("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let r;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(r={maximumAge:6e5,timeout:0},this._noTimeout=!0):(r=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,r),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let r=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(e=>{e==="granted"&&r()}).catch(console.error):r()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:qd,ScaleControl:class{constructor(r={}){this.options=l.l({},io,r),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),l.aJ(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let r=this.options.maxWidth||100,e=this._map,a=e._containerHeight/2,d=e._containerWidth/2-r/2,m=e.unproject([d,a]),p=e.unproject([d+r,a]),u=m.distanceTo(p);if(this.options.unit==="imperial"){let U=3.2808*u;U>5280?this._setScale(r,U/5280,"mile"):this._setScale(r,U,"foot")}else this.options.unit==="nautical"?this._setScale(r,u/1852,"nautical-mile"):u>=1e3?this._setScale(r,u/1e3,"kilometer"):this._setScale(r,u,"meter")}_setScale(r,e,a){this._map._requestDomTask(()=>{let d=function(p){let u=Math.pow(10,`${Math.floor(p)}`.length-1),U=p/u;return U=U>=10?10:U>=5?5:U>=3?3:U>=2?2:U>=1?1:function(Y){let y=Math.pow(10,Math.ceil(-Math.log(Y)/Math.LN10));return Math.round(Y*y)/y}(U),u*U}(e),m=d/e;this._container.innerHTML=this._isNumberFormatSupported&&a!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:a}).format(d):`${d}&nbsp;${zp[a]}`,this._container.style.width=r*m+"px"})}onAdd(r){return this._map=r,this._language=r.getLanguage(),this._container=le("div","mapboxgl-ctrl mapboxgl-ctrl-scale",r.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(r){this._language=r,this._update()}setUnit(r){this.options.unit=r,this._update()}},FullscreenControl:class{constructor(r={}){this._fullscreen=!1,r&&r.container&&(r.container instanceof HTMLElement?this._container=r.container:l.w("Full screen control 'container' must be a DOM element.")),l.aJ(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(r){return this._map=r,this._container||(this._container=this._map.getContainer()),this._controlContainer=le("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",l.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let r=this._fullscreenButton=le("button","mapboxgl-ctrl-fullscreen",this._controlContainer);le("span","mapboxgl-ctrl-icon",r).setAttribute("aria-hidden","true"),r.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let r=this._getTitle();this._fullscreenButton.setAttribute("aria-label",r),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",r)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends l.E{constructor(r){super(),this.options=l.l(Object.create(wp),r),l.aJ(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(r&&r.className?r.className.trim().split(/\s+/):[])}addTo(r){return this._map&&this.remove(),this._map=r,this.options.closeOnClick&&r.on("preclick",this._onClose),this.options.closeOnMove&&r.on("move",this._onClose),r.on("remove",this.remove),this._update(),r._addPopup(this),this._focusFirstElement(),this._trackPointer?(r.on("mousemove",this._onMouseEvent),r.on("mouseup",this._onMouseEvent),r._canvasContainer.classList.add("mapboxgl-track-pointer")):r.on("move",this._update),this.fire(new l.x("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let r=this._map;return r&&(r.off("move",this._update),r.off("move",this._onClose),r.off("preclick",this._onClose),r.off("click",this._onClose),r.off("remove",this.remove),r.off("mousemove",this._onMouseEvent),r.off("mouseup",this._onMouseEvent),r.off("drag",this._onMouseEvent),r._canvasContainer&&r._canvasContainer.classList.remove("mapboxgl-track-pointer"),r._removePopup(this),this._map=void 0),this.fire(new l.x("close")),this}getLngLat(){return this._lngLat}setLngLat(r){this._lngLat=l.bK.convert(r),this._pos=null,this._trackPointer=!1,this._update();let e=this._map;return e&&(e.on("move",this._update),e.off("mousemove",this._onMouseEvent),e._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let r=this._map;return r&&(r.off("move",this._update),r.on("mousemove",this._onMouseEvent),r.on("drag",this._onMouseEvent),r._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(r){return this.setDOMContent(document.createTextNode(r))}setHTML(r){let e=document.createDocumentFragment(),a=document.createElement("body"),d;for(a.innerHTML=r;d=a.firstChild,d;)e.appendChild(d);return this.setDOMContent(e)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(r){return this.options.maxWidth=r,this._update(),this}setDOMContent(r){let e=this._content;if(e)for(;e.hasChildNodes();)e.firstChild&&e.removeChild(e.firstChild);else e=this._content=le("div","mapboxgl-popup-content",this._container||void 0);if(e.appendChild(r),this.options.closeButton){let a=this._closeButton=le("button","mapboxgl-popup-close-button",e);a.type="button",a.setAttribute("aria-label","Close popup"),a.setAttribute("aria-hidden","true"),a.innerHTML="&#215;",a.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(r){return this._classList.add(r),this._updateClassList(),this}removeClassName(r){return this._classList.delete(r),this._updateClassList(),this}setOffset(r){return this.options.offset=r,this._update(),this}toggleClassName(r){let e;return this._classList.delete(r)?e=!1:(this._classList.add(r),e=!0),this._updateClassList(),e}_onMouseEvent(r){this._update(r.point)}_getAnchor(r){if(this.options.anchor)return this.options.anchor;let e=this._map,a=this._container,d=this._pos;if(!e||!a||!d)return"bottom";let m=a.offsetWidth,p=a.offsetHeight,u=d.x<m/2,U=d.x>e.transform.width-m/2;if(d.y+r<p)return u?"top-left":U?"top-right":"top";if(d.y>e.transform.height-p){if(u)return"bottom-left";if(U)return"bottom-right"}return u?"left":U?"right":"bottom"}_updateClassList(){let r=this._container;if(!r)return;let e=[...this._classList];e.push("mapboxgl-popup"),this._anchor&&e.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&e.push("mapboxgl-popup-track-pointer"),r.className=e.join(" ")}_update(r){let e=this._map,a=this._content;if(!e||!this._lngLat&&!this._trackPointer||!a)return;let d=this._container;if(d||(d=this._container=le("div","mapboxgl-popup",e.getContainer()),this._tip=le("div","mapboxgl-popup-tip",d),d.appendChild(a)),this.options.maxWidth&&d.style.maxWidth!==this.options.maxWidth&&(d.style.maxWidth=this.options.maxWidth),e.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=bl(this._lngLat,this._pos,e.transform)),!this._trackPointer||r){let m=this._pos=this._trackPointer&&r instanceof l.P?r:e.project(this._lngLat),p=Lh(this.options.offset),u=this._anchor=this._getAnchor(p.y),U=Lh(this.options.offset,u),Y=m.add(U).round();e._requestDomTask(()=>{this._container&&u&&(this._container.style.transform=`${Gn[u]} translate(${Y.x}px,${Y.y}px)`)})}if(!this._marker&&e._showingGlobe()){let m=l.dz(e.transform,this._lngLat)?0:1;this._setOpacity(m)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let r=this._container.querySelector(Ap);r&&r.focus()}_onClose(){this.remove()}_setOpacity(r){this._container&&(this._container.style.opacity=`${r}`),this._content&&(this._content.style.pointerEvents=r?"auto":"none")}},Marker:ml,Style:Vn,LngLat:l.bK,LngLatBounds:l.as,Point:l.P,MercatorCoordinate:l.a5,FreeCameraOptions:Ol,Evented:l.E,config:l.e,prewarm:l.dE,clearPrewarmedResources:l.dF,get accessToken(){return l.e.ACCESS_TOKEN},set accessToken(r){l.e.ACCESS_TOKEN=r},get baseApiUrl(){return l.e.API_URL},set baseApiUrl(r){l.e.API_URL=r},get workerCount(){return l.dG.workerCount},set workerCount(r){l.dG.workerCount=r},get maxParallelImageRequests(){return l.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(r){l.e.MAX_PARALLEL_IMAGE_REQUESTS=r},clearStorage(r){l.dH(r)},get workerUrl(){return l.dI.workerUrl},set workerUrl(r){l.dI.workerUrl=r},get workerClass(){return l.dI.workerClass},set workerClass(r){l.dI.workerClass=r},get workerParams(){return l.dI.workerParams},set workerParams(r){l.dI.workerParams=r},get dracoUrl(){return l.dJ()},set dracoUrl(r){l.dK(r)},get meshoptUrl(){return l.dL()},set meshoptUrl(r){l.dM(r)},setNow:l.q.setNow,restoreNow:l.q.restoreNow}});var O=J;return O})});var Pr=Bi((XS,$R)=>{$R.exports=Ty;var My=Object.prototype.hasOwnProperty;function Ty(){for(var x={},g=0;g<arguments.length;g++){var J=arguments[g];for(var E in J)My.call(J,E)&&(x[E]=J[E])}return x}});var iG=Bi((tG,eG)=>{(function(){var x=this,g={};typeof tG<"u"?eG.exports=g:x.fuzzy=g,g.simpleFilter=function(J,E){return E.filter(function(O){return g.test(J,O)})},g.test=function(J,E){return g.match(J,E)!==null},g.match=function(J,E,O){O=O||{};var l=0,lt=[],It=E.length,Gt=0,$t=0,Kt=O.pre||"",Ve=O.post||"",re=O.caseSensitive&&E||E.toLowerCase(),le;J=O.caseSensitive&&J||J.toLowerCase();for(var je=0;je<It;je++)le=E[je],re[je]===J[l]?(le=Kt+le+Ve,l+=1,$t+=1+$t):$t=0,Gt+=$t,lt[lt.length]=le;return l===J.length?(Gt=re===J?1/0:Gt,{rendered:lt.join(""),score:Gt}):null},g.filter=function(J,E,O){return!E||E.length===0?[]:typeof J!="string"?E:(O=O||{},E.reduce(function(l,lt,It,Gt){var $t=lt;O.extract&&($t=O.extract(lt));var Kt=g.match(J,$t,O);return Kt!=null&&(l[l.length]={string:Kt.rendered,score:Kt.score,index:It,original:lt}),l},[]).sort(function(l,lt){var It=lt.score-l.score;return It||l.index-lt.index}))}})()});var nG=Bi((yS,aG)=>{"use strict";var Qn=function(x){return this.component=x,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,x.el.parentNode.insertBefore(this.wrapper,x.el.nextSibling),this};Qn.prototype.show=function(){this.element.style.display="block"};Qn.prototype.hide=function(){this.element.style.display="none"};Qn.prototype.add=function(x){this.items.push(x)};Qn.prototype.clear=function(){this.items=[],this.active=0};Qn.prototype.isEmpty=function(){return!this.items.length};Qn.prototype.isVisible=function(){return this.element.style.display==="block"};Qn.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var x=0;x<this.items.length;x++)this.drawItem(this.items[x],this.active===x);this.show()};Qn.prototype.drawItem=function(x,g){var J=document.createElement("li"),E=document.createElement("a");g&&(J.className+=" active"),E.innerHTML=x.string,J.appendChild(E),this.element.appendChild(J),J.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),J.addEventListener("mouseup",(function(){this.handleMouseUp.call(this,x)}).bind(this))};Qn.prototype.handleMouseUp=function(x){this.selectingListItem=!1,this.component.value(x.original),this.clear(),this.draw()};Qn.prototype.move=function(x){this.active=x,this.draw()};Qn.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};Qn.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};Qn.prototype.drawError=function(x){var g=document.createElement("li");g.innerHTML=x,this.element.appendChild(g),this.show()};aG.exports=Qn});var oG=Bi((BS,lG)=>{"use strict";var Cy=Pr(),ky=iG(),Sy=nG(),dn=function(x,g,J){return J=J||{},this.options=Cy({minLength:2,limit:5,filter:!0,hideOnBlur:!0},J),this.el=x,this.data=g||[],this.list=new Sy(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",(function(E){this.handleKeyUp(E.keyCode)}).bind(this),!1),this.el.addEventListener("keydown",(function(E){this.handleKeyDown(E)}).bind(this)),this.el.addEventListener("focus",(function(){this.handleFocus()}).bind(this)),this.el.addEventListener("blur",(function(){this.handleBlur()}).bind(this)),this.el.addEventListener("paste",(function(E){this.handlePaste(E)}).bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};dn.prototype.handleKeyUp=function(x){x===40||x===38||x===27||x===13||x===9||this.handleInputChange(this.el.value)};dn.prototype.handleKeyDown=function(x){switch(x.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&x.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};dn.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};dn.prototype.handlePaste=function(x){if(x.clipboardData)this.handleInputChange(x.clipboardData.getData("Text"));else{var g=this;setTimeout(function(){g.handleInputChange(x.target.value)},100)}};dn.prototype.handleInputChange=function(x){if(this.query=this.normalize(x),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates((function(g){for(var J=0;J<g.length&&(this.list.add(g[J]),J!==this.options.limit-1);J++);this.list.draw()}).bind(this))};dn.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};dn.prototype.update=function(x){this.data=x,this.handleKeyUp()};dn.prototype.clear=function(){this.data=[],this.list.clear()};dn.prototype.normalize=function(x){return x=x.toLowerCase(),x};dn.prototype.match=function(x,g){return x.indexOf(g)>-1};dn.prototype.value=function(x){if(this.selected=x,this.el.value=this.getItemValue(x),document.createEvent){var g=document.createEvent("HTMLEvents");g.initEvent("change",!0,!1),this.el.dispatchEvent(g)}else this.el.fireEvent("onchange")};dn.prototype.getCandidates=function(x){var g={pre:"<strong>",post:"</strong>",extract:(function(E){return this.getItemValue(E)}).bind(this)},J;this.options.filter?(J=ky.filter(this.query,this.data,g),J=J.map((function(E){return{original:E.original,string:this.render(E.original,E.string)}}).bind(this))):J=this.data.map((function(E){var O=this.render(E);return{original:E,string:O}}).bind(this)),x(J)};dn.prototype.getItemValue=function(x){return x};dn.prototype.render=function(x,g){if(g)return g;for(var J=x.original?this.getItemValue(x.original):this.getItemValue(x),E=this.normalize(J),O=E.lastIndexOf(this.query);O>-1;){var l=O+this.query.length;J=J.slice(0,O)+"<strong>"+J.slice(O,l)+"</strong>"+J.slice(l),O=E.slice(0,O).lastIndexOf(this.query)}return J};dn.prototype.renderError=function(x){this.list.drawError(x)};lG.exports=dn});var dG=Bi((MS,rG)=>{"use strict";var sG=oG();rG.exports=sG;typeof window<"u"&&(window.Suggestions=sG)});var hG=Bi((TS,mG)=>{var Qy="Expected a function",cG=NaN,fy="[object Symbol]",vy=/^\s+|\s+$/g,Ey=/^[-+]0x[0-9a-f]+$/i,Ly=/^0b[01]+$/i,zy=/^0o[0-7]+$/i,wy=parseInt,Ay=typeof global=="object"&&global&&global.Object===Object&&global,Hy=typeof self=="object"&&self&&self.Object===Object&&self,jy=Ay||Hy||Function("return this")(),Oy=Object.prototype,Dy=Oy.toString,_y=Math.max,Py=Math.min,H1=function(){return jy.Date.now()};function Ky(x,g,J){var E,O,l,lt,It,Gt,$t=0,Kt=!1,Ve=!1,re=!0;if(typeof x!="function")throw new TypeError(Qy);g=bG(g)||0,j1(J)&&(Kt=!!J.leading,Ve="maxWait"in J,l=Ve?_y(bG(J.maxWait)||0,g):l,re="trailing"in J?!!J.trailing:re);function le(_e){var Zi=E,Re=O;return E=O=void 0,$t=_e,lt=x.apply(Re,Zi),lt}function je(_e){return $t=_e,It=setTimeout(bi,g),Kt?le(_e):lt}function Ze(_e){var Zi=_e-Gt,Re=_e-$t,Fe=g-Zi;return Ve?Py(Fe,l-Re):Fe}function ii(_e){var Zi=_e-Gt,Re=_e-$t;return Gt===void 0||Zi>=g||Zi<0||Ve&&Re>=l}function bi(){var _e=H1();if(ii(_e))return Xe(_e);It=setTimeout(bi,Ze(_e))}function Xe(_e){return It=void 0,re&&E?le(_e):(E=O=void 0,lt)}function vi(){It!==void 0&&clearTimeout(It),$t=0,E=Gt=O=It=void 0}function we(){return It===void 0?lt:Xe(H1())}function We(){var _e=H1(),Zi=ii(_e);if(E=arguments,O=this,Gt=_e,Zi){if(It===void 0)return je(Gt);if(Ve)return It=setTimeout(bi,g),le(Gt)}return It===void 0&&(It=setTimeout(bi,g)),lt}return We.cancel=vi,We.flush=we,We}function j1(x){var g=typeof x;return!!x&&(g=="object"||g=="function")}function qy(x){return!!x&&typeof x=="object"}function $y(x){return typeof x=="symbol"||qy(x)&&Dy.call(x)==fy}function bG(x){if(typeof x=="number")return x;if($y(x))return cG;if(j1(x)){var g=typeof x.valueOf=="function"?x.valueOf():x;x=j1(g)?g+"":g}if(typeof x!="string")return x===0?x:+x;x=x.replace(vy,"");var J=Ly.test(x);return J||zy.test(x)?wy(x.slice(2),J?2:8):Ey.test(x)?cG:+x}mG.exports=Ky});var UG=Bi((CS,O1)=>{"use strict";var Bc=typeof Reflect=="object"?Reflect:null,pG=Bc&&typeof Bc.apply=="function"?Bc.apply:function(g,J,E){return Function.prototype.apply.call(g,J,E)},lp;Bc&&typeof Bc.ownKeys=="function"?lp=Bc.ownKeys:Object.getOwnPropertySymbols?lp=function(g){return Object.getOwnPropertyNames(g).concat(Object.getOwnPropertySymbols(g))}:lp=function(g){return Object.getOwnPropertyNames(g)};function t2(x){console&&console.warn&&console.warn(x)}var uG=Number.isNaN||function(g){return g!==g};function _i(){_i.init.call(this)}O1.exports=_i;O1.exports.once=n2;_i.EventEmitter=_i;_i.prototype._events=void 0;_i.prototype._eventsCount=0;_i.prototype._maxListeners=void 0;var WG=10;function op(x){if(typeof x!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof x)}Object.defineProperty(_i,"defaultMaxListeners",{enumerable:!0,get:function(){return WG},set:function(x){if(typeof x!="number"||x<0||uG(x))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+x+".");WG=x}});_i.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};_i.prototype.setMaxListeners=function(g){if(typeof g!="number"||g<0||uG(g))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+g+".");return this._maxListeners=g,this};function ZG(x){return x._maxListeners===void 0?_i.defaultMaxListeners:x._maxListeners}_i.prototype.getMaxListeners=function(){return ZG(this)};_i.prototype.emit=function(g){for(var J=[],E=1;E<arguments.length;E++)J.push(arguments[E]);var O=g==="error",l=this._events;if(l!==void 0)O=O&&l.error===void 0;else if(!O)return!1;if(O){var lt;if(J.length>0&&(lt=J[0]),lt instanceof Error)throw lt;var It=new Error("Unhandled error."+(lt?" ("+lt.message+")":""));throw It.context=lt,It}var Gt=l[g];if(Gt===void 0)return!1;if(typeof Gt=="function")pG(Gt,this,J);else for(var $t=Gt.length,Kt=FG(Gt,$t),E=0;E<$t;++E)pG(Kt[E],this,J);return!0};function gG(x,g,J,E){var O,l,lt;if(op(J),l=x._events,l===void 0?(l=x._events=Object.create(null),x._eventsCount=0):(l.newListener!==void 0&&(x.emit("newListener",g,J.listener?J.listener:J),l=x._events),lt=l[g]),lt===void 0)lt=l[g]=J,++x._eventsCount;else if(typeof lt=="function"?lt=l[g]=E?[J,lt]:[lt,J]:E?lt.unshift(J):lt.push(J),O=ZG(x),O>0&&lt.length>O&&!lt.warned){lt.warned=!0;var It=new Error("Possible EventEmitter memory leak detected. "+lt.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");It.name="MaxListenersExceededWarning",It.emitter=x,It.type=g,It.count=lt.length,t2(It)}return x}_i.prototype.addListener=function(g,J){return gG(this,g,J,!1)};_i.prototype.on=_i.prototype.addListener;_i.prototype.prependListener=function(g,J){return gG(this,g,J,!0)};function e2(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function VG(x,g,J){var E={fired:!1,wrapFn:void 0,target:x,type:g,listener:J},O=e2.bind(E);return O.listener=J,E.wrapFn=O,O}_i.prototype.once=function(g,J){return op(J),this.on(g,VG(this,g,J)),this};_i.prototype.prependOnceListener=function(g,J){return op(J),this.prependListener(g,VG(this,g,J)),this};_i.prototype.removeListener=function(g,J){var E,O,l,lt,It;if(op(J),O=this._events,O===void 0)return this;if(E=O[g],E===void 0)return this;if(E===J||E.listener===J)--this._eventsCount===0?this._events=Object.create(null):(delete O[g],O.removeListener&&this.emit("removeListener",g,E.listener||J));else if(typeof E!="function"){for(l=-1,lt=E.length-1;lt>=0;lt--)if(E[lt]===J||E[lt].listener===J){It=E[lt].listener,l=lt;break}if(l<0)return this;l===0?E.shift():i2(E,l),E.length===1&&(O[g]=E[0]),O.removeListener!==void 0&&this.emit("removeListener",g,It||J)}return this};_i.prototype.off=_i.prototype.removeListener;_i.prototype.removeAllListeners=function(g){var J,E,O;if(E=this._events,E===void 0)return this;if(E.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):E[g]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete E[g]),this;if(arguments.length===0){var l=Object.keys(E),lt;for(O=0;O<l.length;++O)lt=l[O],lt!=="removeListener"&&this.removeAllListeners(lt);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(J=E[g],typeof J=="function")this.removeListener(g,J);else if(J!==void 0)for(O=J.length-1;O>=0;O--)this.removeListener(g,J[O]);return this};function RG(x,g,J){var E=x._events;if(E===void 0)return[];var O=E[g];return O===void 0?[]:typeof O=="function"?J?[O.listener||O]:[O]:J?a2(O):FG(O,O.length)}_i.prototype.listeners=function(g){return RG(this,g,!0)};_i.prototype.rawListeners=function(g){return RG(this,g,!1)};_i.listenerCount=function(x,g){return typeof x.listenerCount=="function"?x.listenerCount(g):GG.call(x,g)};_i.prototype.listenerCount=GG;function GG(x){var g=this._events;if(g!==void 0){var J=g[x];if(typeof J=="function")return 1;if(J!==void 0)return J.length}return 0}_i.prototype.eventNames=function(){return this._eventsCount>0?lp(this._events):[]};function FG(x,g){for(var J=new Array(g),E=0;E<g;++E)J[E]=x[E];return J}function i2(x,g){for(;g+1<x.length;g++)x[g]=x[g+1];x.pop()}function a2(x){for(var g=new Array(x.length),J=0;J<g.length;++J)g[J]=x[J].listener||x[J];return g}function n2(x,g){return new Promise(function(J,E){function O(lt){x.removeListener(g,l),E(lt)}function l(){typeof x.removeListener=="function"&&x.removeListener("error",O),J([].slice.call(arguments))}IG(x,g,l,{once:!0}),g!=="error"&&l2(x,O,{once:!0})})}function l2(x,g,J){typeof x.on=="function"&&IG(x,"error",g,J)}function IG(x,g,J,E){if(typeof x.on=="function")E.once?x.once(g,J):x.on(g,J);else if(typeof x.addEventListener=="function")x.addEventListener(g,function O(l){E.once&&x.removeEventListener(g,O),J(l)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof x)}});var NG=Bi((kS,xG)=>{xG.exports={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}}});var JG=Bi((SS,YG)=>{"use strict";function o2(x){var g=x.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return g?{key:g[1],value:g[2]}:null}function s2(x){var g=x.match(/<?([^>]*)>(.*)/);if(!g)return null;var J=g[1],E=g[2].split(";"),O=null,l=E.reduce(function(lt,It){var Gt=o2(It);return Gt?Gt.key==="rel"?(O||(O=Gt.value),lt):(lt[Gt.key]=Gt.value,lt):lt},{});return O?{url:J,rel:O,params:l}:null}function r2(x){return x?x.split(/,\s*</).reduce(function(g,J){var E=s2(J);if(!E)return g;var O=E.rel.split(/\s+/);return O.forEach(function(l){g[l]||(g[l]={url:E.url,params:E.params})}),g},{}):{}}YG.exports=r2});var yG=Bi((QS,XG)=>{"use strict";var d2=JG();function D1(x,g){this.request=x,this.headers=g.headers,this.rawBody=g.body,this.statusCode=g.statusCode;try{this.body=JSON.parse(g.body||"{}")}catch{this.body=g.body}this.links=d2(this.headers.link)}D1.prototype.hasNextPage=function(){return!!this.links.next};D1.prototype.nextPage=function(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};XG.exports=D1});var Qm=Bi((fS,BG)=>{"use strict";BG.exports={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"}});var CG=Bi((vS,TG)=>{"use strict";var MG=Qm();function c2(x){var g=x.type||MG.ERROR_HTTP,J;if(x.body)try{J=JSON.parse(x.body)}catch{J=x.body}else J=null;var E=x.message||null;E||(typeof J=="string"?E=J:J&&typeof J.message=="string"?E=J.message:g===MG.ERROR_REQUEST_ABORTED&&(E="Request aborted")),this.message=E,this.type=g,this.statusCode=x.statusCode||null,this.request=x.request,this.body=J}TG.exports=c2});var SG=Bi((ES,kG)=>{"use strict";function b2(x){var g=x.indexOf(":"),J=x.substring(0,g).trim().toLowerCase(),E=x.substring(g+1).trim();return{name:J,value:E}}function m2(x){var g={};return x&&x.trim().split(/[\r|\n]+/).forEach(function(J){var E=b2(J);g[E.name]=E.value}),g}kG.exports=m2});var zG=Bi((LS,LG)=>{"use strict";var h2=yG(),QG=CG(),_1=Qm(),p2=SG(),sp={};function W2(x){var g=sp[x.id];g&&(g.abort(),delete sp[x.id])}function u2(x,g){return new h2(x,{body:g.response,headers:p2(g.getAllResponseHeaders()),statusCode:g.status})}function fG(x){var g=x.total,J=x.loaded,E=100*J/g;return{total:g,transferred:J,percent:E}}function vG(x,g){return new Promise(function(J,E){g.onprogress=function(lt){x.emitter.emit(_1.EVENT_PROGRESS_DOWNLOAD,fG(lt))};var O=x.file;O&&(g.upload.onprogress=function(lt){x.emitter.emit(_1.EVENT_PROGRESS_UPLOAD,fG(lt))}),g.onerror=function(lt){E(lt)},g.onabort=function(){var lt=new QG({request:x,type:_1.ERROR_REQUEST_ABORTED});E(lt)},g.onload=function(){if(delete sp[x.id],g.status<200||g.status>=400){var lt=new QG({request:x,body:g.response,statusCode:g.status});E(lt);return}J(g)};var l=x.body;typeof l=="string"?g.send(l):l?g.send(JSON.stringify(l)):O?g.send(O):g.send(),sp[x.id]=g}).then(function(J){return u2(x,J)})}function EG(x,g){var J=x.url(g),E=new window.XMLHttpRequest;return E.open(x.method,J),Object.keys(x.headers).forEach(function(O){E.setRequestHeader(O,x.headers[O])}),E}function Z2(x){return Promise.resolve().then(function(){var g=EG(x,x.client.accessToken);return vG(x,g)})}LG.exports={browserAbort:W2,sendRequestXhr:vG,browserSend:Z2,createRequestXhr:EG}});var wG=Bi((rp,fm)=>{(function(x){var g=typeof rp=="object"&&rp,J=typeof fm=="object"&&fm&&fm.exports==g&&fm,E=typeof global=="object"&&global;(E.global===E||E.window===E)&&(x=E);var O=function(re){this.message=re};O.prototype=new Error,O.prototype.name="InvalidCharacterError";var l=function(re){throw new O(re)},lt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",It=/[\t\n\f\r ]/g,Gt=function(re){re=String(re).replace(It,"");var le=re.length;le%4==0&&(re=re.replace(/==?$/,""),le=re.length),(le%4==1||/[^+a-zA-Z0-9/]/.test(re))&&l("Invalid character: the string to be decoded is not correctly encoded.");for(var je=0,Ze,ii,bi="",Xe=-1;++Xe<le;)ii=lt.indexOf(re.charAt(Xe)),Ze=je%4?Ze*64+ii:ii,je++%4&&(bi+=String.fromCharCode(255&Ze>>(-2*je&6)));return bi},$t=function(re){re=String(re),/[^\0-\xFF]/.test(re)&&l("The string to be encoded contains characters outside of the Latin1 range.");for(var le=re.length%3,je="",Ze=-1,ii,bi,Xe,vi,we,We=re.length-le;++Ze<We;)ii=re.charCodeAt(Ze)<<16,bi=re.charCodeAt(++Ze)<<8,Xe=re.charCodeAt(++Ze),we=ii+bi+Xe,je+=lt.charAt(we>>18&63)+lt.charAt(we>>12&63)+lt.charAt(we>>6&63)+lt.charAt(we&63);return le==2?(ii=re.charCodeAt(Ze)<<8,bi=re.charCodeAt(++Ze),we=ii+bi,je+=lt.charAt(we>>10)+lt.charAt(we>>4&63)+lt.charAt(we<<2&63)+"="):le==1&&(we=re.charCodeAt(Ze),je+=lt.charAt(we>>2)+lt.charAt(we<<4&63)+"=="),je},Kt={encode:$t,decode:Gt,version:"0.1.0"};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd)define(function(){return Kt});else if(g&&!g.nodeType)if(J)J.exports=Kt;else for(var Ve in Kt)Kt.hasOwnProperty(Ve)&&(g[Ve]=Kt[Ve]);else x.base64=Kt})(rp)});var K1=Bi((zS,AG)=>{"use strict";var g2=wG(),P1={};function V2(x){if(P1[x])return P1[x];var g=x.split("."),J=g[0],E=g[1];if(!E)throw new Error("Invalid token");var O=R2(E),l={usage:J,user:O.u};return Kr(O,"a")&&(l.authorization=O.a),Kr(O,"exp")&&(l.expires=O.exp*1e3),Kr(O,"iat")&&(l.created=O.iat*1e3),Kr(O,"scopes")&&(l.scopes=O.scopes),Kr(O,"client")&&(l.client=O.client),Kr(O,"ll")&&(l.lastLogin=O.ll),Kr(O,"iu")&&(l.impersonator=O.iu),P1[x]=l,l}function R2(x){try{return JSON.parse(g2.decode(x))}catch{throw new Error("Invalid token")}}function Kr(x,g){return Object.prototype.hasOwnProperty.call(x,g)}AG.exports=V2});var jG=Bi((wS,q1)=>{"use strict";var G2=Object.prototype.hasOwnProperty,Nn="~";function vm(){}Object.create&&(vm.prototype=Object.create(null),new vm().__proto__||(Nn=!1));function F2(x,g,J){this.fn=x,this.context=g,this.once=J||!1}function HG(x,g,J,E,O){if(typeof J!="function")throw new TypeError("The listener must be a function");var l=new F2(J,E||x,O),lt=Nn?Nn+g:g;return x._events[lt]?x._events[lt].fn?x._events[lt]=[x._events[lt],l]:x._events[lt].push(l):(x._events[lt]=l,x._eventsCount++),x}function dp(x,g){--x._eventsCount===0?x._events=new vm:delete x._events[g]}function cn(){this._events=new vm,this._eventsCount=0}cn.prototype.eventNames=function(){var g=[],J,E;if(this._eventsCount===0)return g;for(E in J=this._events)G2.call(J,E)&&g.push(Nn?E.slice(1):E);return Object.getOwnPropertySymbols?g.concat(Object.getOwnPropertySymbols(J)):g};cn.prototype.listeners=function(g){var J=Nn?Nn+g:g,E=this._events[J];if(!E)return[];if(E.fn)return[E.fn];for(var O=0,l=E.length,lt=new Array(l);O<l;O++)lt[O]=E[O].fn;return lt};cn.prototype.listenerCount=function(g){var J=Nn?Nn+g:g,E=this._events[J];return E?E.fn?1:E.length:0};cn.prototype.emit=function(g,J,E,O,l,lt){var It=Nn?Nn+g:g;if(!this._events[It])return!1;var Gt=this._events[It],$t=arguments.length,Kt,Ve;if(Gt.fn){switch(Gt.once&&this.removeListener(g,Gt.fn,void 0,!0),$t){case 1:return Gt.fn.call(Gt.context),!0;case 2:return Gt.fn.call(Gt.context,J),!0;case 3:return Gt.fn.call(Gt.context,J,E),!0;case 4:return Gt.fn.call(Gt.context,J,E,O),!0;case 5:return Gt.fn.call(Gt.context,J,E,O,l),!0;case 6:return Gt.fn.call(Gt.context,J,E,O,l,lt),!0}for(Ve=1,Kt=new Array($t-1);Ve<$t;Ve++)Kt[Ve-1]=arguments[Ve];Gt.fn.apply(Gt.context,Kt)}else{var re=Gt.length,le;for(Ve=0;Ve<re;Ve++)switch(Gt[Ve].once&&this.removeListener(g,Gt[Ve].fn,void 0,!0),$t){case 1:Gt[Ve].fn.call(Gt[Ve].context);break;case 2:Gt[Ve].fn.call(Gt[Ve].context,J);break;case 3:Gt[Ve].fn.call(Gt[Ve].context,J,E);break;case 4:Gt[Ve].fn.call(Gt[Ve].context,J,E,O);break;default:if(!Kt)for(le=1,Kt=new Array($t-1);le<$t;le++)Kt[le-1]=arguments[le];Gt[Ve].fn.apply(Gt[Ve].context,Kt)}}return!0};cn.prototype.on=function(g,J,E){return HG(this,g,J,E,!1)};cn.prototype.once=function(g,J,E){return HG(this,g,J,E,!0)};cn.prototype.removeListener=function(g,J,E,O){var l=Nn?Nn+g:g;if(!this._events[l])return this;if(!J)return dp(this,l),this;var lt=this._events[l];if(lt.fn)lt.fn===J&&(!O||lt.once)&&(!E||lt.context===E)&&dp(this,l);else{for(var It=0,Gt=[],$t=lt.length;It<$t;It++)(lt[It].fn!==J||O&&!lt[It].once||E&&lt[It].context!==E)&&Gt.push(lt[It]);Gt.length?this._events[l]=Gt.length===1?Gt[0]:Gt:dp(this,l)}return this};cn.prototype.removeAllListeners=function(g){var J;return g?(J=Nn?Nn+g:g,this._events[J]&&dp(this,J)):(this._events=new vm,this._eventsCount=0),this};cn.prototype.off=cn.prototype.removeListener;cn.prototype.addListener=cn.prototype.on;cn.prefixed=Nn;cn.EventEmitter=cn;typeof q1<"u"&&(q1.exports=cn)});var PG=Bi((AS,_G)=>{"use strict";function I2(x){return x.map(encodeURIComponent).join(",")}function OG(x){return Array.isArray(x)?I2(x):encodeURIComponent(String(x))}function DG(x,g,J){if(J===!1||J===null)return x;var E=/\?/.test(x)?"&":"?",O=encodeURIComponent(g);return J!==void 0&&J!==""&&J!==!0&&(O+="="+OG(J)),""+x+E+O}function U2(x,g){if(!g)return x;var J=x;return Object.keys(g).forEach(function(E){var O=g[E];O!==void 0&&(Array.isArray(O)&&(O=O.filter(function(l){return l!=null}).join(",")),J=DG(J,E,O))}),J}function x2(x,g){if(!g||x.slice(0,4)==="http")return x;var J=x[0]==="/"?"":"/";return""+g.replace(/\/$/,"")+J+x}function N2(x,g){return g?x.replace(/\/:([a-zA-Z0-9]+)/g,function(J,E){var O=g[E];if(O===void 0)throw new Error("Unspecified route parameter "+E);var l=OG(O);return"/"+l}):x}_G.exports={appendQueryObject:U2,appendQueryParam:DG,prependOrigin:x2,interpolateRouteParams:N2}});var $G=Bi((HS,qG)=>{"use strict";var Y2=K1(),$1=Pr(),J2=jG(),cp=PG(),KG=Qm(),X2=1;function Ls(x,g){if(!x)throw new Error("MapiRequest requires a client");if(!g||!g.path||!g.method)throw new Error("MapiRequest requires an options object with path and method properties");var J={};g.body&&(J["content-type"]="application/json");var E=$1(J,g.headers),O=Object.keys(E).reduce(function(l,lt){return l[lt.toLowerCase()]=E[lt],l},{});this.id=X2++,this._options=g,this.emitter=new J2,this.client=x,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=g.path,this.method=g.method,this.origin=g.origin||x.origin,this.query=g.query||{},this.params=g.params||{},this.body=g.body||null,this.file=g.file||null,this.encoding=g.encoding||"utf8",this.sendFileAs=g.sendFileAs||null,this.headers=O}Ls.prototype.url=function(g){var J=cp.prependOrigin(this.path,this.origin);J=cp.appendQueryObject(J,this.query);var E=this.params,O=g??this.client.accessToken;if(O){J=cp.appendQueryParam(J,"access_token",O);var l=Y2(O).user;E=$1({ownerId:l},E)}return J=cp.interpolateRouteParams(J,E),J};Ls.prototype.send=function(){var g=this;if(g.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return g.sent=!0,g.client.sendRequest(g).then(function(J){return g.response=J,g.emitter.emit(KG.EVENT_RESPONSE,J),J},function(J){throw g.error=J,g.emitter.emit(KG.EVENT_ERROR,J),J})};Ls.prototype.abort=function(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};Ls.prototype.eachPage=function(g){var J=this;function E(lt){function It(){delete J._nextPageRequest;var Gt=lt.nextPage();Gt&&(J._nextPageRequest=Gt,l(Gt))}g(null,lt,It)}function O(lt){g(lt,null,function(){})}function l(lt){lt.send().then(E,O)}l(this)};Ls.prototype.clone=function(){return this._extend()};Ls.prototype._extend=function(g){var J=$1(this._options,g);return new Ls(this.client,J)};qG.exports=Ls});var tu=Bi((jS,eF)=>{"use strict";var y2=K1(),B2=$G(),M2=Qm();function tF(x){if(!x||!x.accessToken)throw new Error("Cannot create a client without an access token");y2(x.accessToken),this.accessToken=x.accessToken,this.origin=x.origin||M2.API_ORIGIN}tF.prototype.createRequest=function(g){return new B2(this,g)};eF.exports=tF});var eu=Bi((OS,nF)=>{"use strict";var iF=zG(),aF=tu();function Mc(x){aF.call(this,x)}Mc.prototype=Object.create(aF.prototype);Mc.prototype.constructor=Mc;Mc.prototype.sendRequest=iF.browserSend;Mc.prototype.abortRequest=iF.browserAbort;function T2(x){return new Mc(x)}nF.exports=T2});var oF=Bi((DS,lF)=>{"use strict";var C2=eu();lF.exports=C2});var rF=Bi((_S,sF)=>{"use strict";var k2=Object.prototype.toString;sF.exports=function(x){var g;return k2.call(x)==="[object Object]"&&(g=Object.getPrototypeOf(x),g===null||g===Object.getPrototypeOf({}))}});var pF=Bi((PS,hF)=>{"use strict";var S2=rF(),Q2=Pr(),dF="value",iu=`
  `,ia={};ia.assert=function(x,g){return g=g||{},function(J){var E=zs(x,J);if(E){var O=au(E,g);throw g.apiName&&(O=g.apiName+": "+O),new Error(O)}}};ia.shape=function(g){var J=L2(g);return function(O){var l=zs(ia.plainObject,O);if(l)return l;for(var lt,It,Gt=[],$t=0;$t<J.length;$t++)lt=J[$t].key,It=J[$t].value,l=zs(It,O[lt]),l&&Gt.push([lt].concat(l));return Gt.length<2?Gt[0]:function(Kt){Gt=Gt.map(function(le){var je=le[0],Ze=au(le,Kt).split(`
`).join(iu);return"- "+je+": "+Ze});var Ve=Kt.path.join("."),re=Ve===dF?"":" of "+Ve;return"The following properties"+re+" have invalid values:"+iu+Gt.join(iu)}}};ia.strictShape=function(g){var J=ia.shape(g);return function(O){var l=J(O);if(l)return l;var lt=Object.keys(O).reduce(function(It,Gt){return g[Gt]===void 0&&It.push(Gt),It},[]);if(lt.length!==0)return function(){return"The following keys are invalid: "+lt.join(", ")}}};ia.arrayOf=function(g){return cF(g)};ia.tuple=function(){var g=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return cF(g)};function cF(x){var g=Array.isArray(x),J=function(E){return g?x[E]:x};return function(O){var l=zs(ia.plainArray,O);if(l)return l;if(g&&O.length!==x.length)return"an array with "+x.length+" items";for(var lt=0;lt<O.length;lt++)if(l=zs(J(lt),O[lt]),l)return[lt].concat(l)}}ia.required=function(g){function J(E){return E==null?function(O){return bF(O,mF(O.path)?"cannot be undefined/null.":"is required.")}:g.apply(this,arguments)}return J.__required=!0,J};ia.oneOfType=function(){var g=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(E){var O=g.map(function(l){return zs(l,E)}).filter(Boolean);if(O.length===g.length)return O.every(function(l){return l.length===1&&typeof l[0]=="string"})?f2(O.map(function(l){return l[0]})):O.reduce(function(l,lt){return lt.length>l.length?lt:l})}};ia.equal=function(g){return function(E){if(E!==g)return JSON.stringify(g)}};ia.oneOf=function(){var g=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),J=g.map(function(E){return ia.equal(E)});return ia.oneOfType.apply(this,J)};ia.range=function(g){var J=g[0],E=g[1];return function(l){var lt=zs(ia.number,l);if(lt||l<J||l>E)return"number between "+J+" & "+E+" (inclusive)"}};ia.any=function(){};ia.boolean=function(g){if(typeof g!="boolean")return"boolean"};ia.number=function(g){if(typeof g!="number")return"number"};ia.plainArray=function(g){if(!Array.isArray(g))return"array"};ia.plainObject=function(g){if(!S2(g))return"object"};ia.string=function(g){if(typeof g!="string")return"string"};ia.func=function(g){if(typeof g!="function")return"function"};function zs(x,g){if(!(g==null&&!x.hasOwnProperty("__required"))){var J=x(g);if(J)return Array.isArray(J)?J:[J]}}function au(x,g){var J=x.length,E=x[J-1],O=x.slice(0,J-1);return O.length===0&&(O=[dF]),g=Q2(g,{path:O}),typeof E=="function"?E(g):bF(g,v2(E))}function f2(x){return x.length<2?x[0]:x.length===2?x.join(" or "):x.slice(0,-1).join(", ")+", or "+x.slice(-1)}function v2(x){return"must be "+E2(x)+"."}function E2(x){return/^an? /.test(x)?x:/^[aeiou]/i.test(x)?"an "+x:/^[a-z]/i.test(x)?"a "+x:x}function bF(x,g){var J=mF(x.path),E=x.path.join(".")+" "+g,O=J?"Item at position ":"";return O+E}function mF(x){return typeof x[x.length-1]=="number"||typeof x[0]=="number"}function L2(x){return Object.keys(x||{}).map(function(g){return{key:g,value:x[g]}})}ia.validate=zs;ia.processMessage=au;hF.exports=ia});var uF=Bi((KS,WF)=>{"use strict";var z2=Pr(),Tc=pF();function w2(x){if(typeof window<"u")return x instanceof global.Blob||x instanceof global.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof x=="string"||x.pipe!==void 0))return"Filename or Readable stream"}function A2(x,g){return Tc.assert(Tc.strictShape(x),g)}function H2(x){var g="date";if(typeof x=="boolean")return g;try{var J=new Date(x);if(J.getTime&&isNaN(J.getTime()))return g}catch{return g}}function j2(x){return Tc.tuple(Tc.number,Tc.number)(x)}WF.exports=z2(Tc,{file:w2,date:H2,coordinates:j2,assertShape:A2})});var gF=Bi((qS,ZF)=>{"use strict";function O2(x,g){var J=function(E,O){return g.indexOf(E)!==-1&&O!==void 0};return typeof g=="function"&&(J=g),Object.keys(x).filter(function(E){return J(E,x[E])}).reduce(function(E,O){return E[O]=x[O],E},{})}ZF.exports=O2});var RF=Bi(($S,VF)=>{"use strict";function D2(x,g){return Object.keys(x).reduce(function(J,E){return J[E]=g(E,x[E]),J},{})}VF.exports=D2});var FF=Bi((tQ,GF)=>{"use strict";var _2=RF();function P2(x){return _2(x,function(g,J){return typeof J=="boolean"?JSON.stringify(J):J})}GF.exports=P2});var UF=Bi((eQ,IF)=>{"use strict";var K2=tu(),q2=eu();function $2(x){return function(g){var J;K2.prototype.isPrototypeOf(g)?J=g:J=q2(g);var E=Object.create(x);return E.client=J,E}}IF.exports=$2});var XF=Bi((iQ,JF)=>{"use strict";var xF=Pr(),Mi=uF(),bp=gF(),NF=FF(),tB=UF(),nu={},YF=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];nu.forwardGeocode=function(x){Mi.assertShape({query:Mi.required(Mi.string),mode:Mi.oneOf("mapbox.places","mapbox.places-permanent"),countries:Mi.arrayOf(Mi.string),proximity:Mi.oneOf(Mi.coordinates,"ip"),types:Mi.arrayOf(Mi.oneOf(YF)),autocomplete:Mi.boolean,bbox:Mi.arrayOf(Mi.number),limit:Mi.number,language:Mi.arrayOf(Mi.string),routing:Mi.boolean,fuzzyMatch:Mi.boolean,worldview:Mi.string,session_token:Mi.string})(x),x.mode=x.mode||"mapbox.places";var g=NF(xF({country:x.countries},bp(x,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:bp(x,["mode","query"]),query:g})};nu.reverseGeocode=function(x){Mi.assertShape({query:Mi.required(Mi.coordinates),mode:Mi.oneOf("mapbox.places","mapbox.places-permanent"),countries:Mi.arrayOf(Mi.string),types:Mi.arrayOf(Mi.oneOf(YF)),bbox:Mi.arrayOf(Mi.number),limit:Mi.number,language:Mi.arrayOf(Mi.string),reverseMode:Mi.oneOf("distance","score"),routing:Mi.boolean,worldview:Mi.string,session_token:Mi.string})(x),x.mode=x.mode||"mapbox.places";var g=NF(xF({country:x.countries},bp(x,["country","types","bbox","limit","language","reverseMode","routing","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:bp(x,["mode","query"]),query:g})};JF.exports=tB(nu)});var yF,BF=YV(()=>{yF="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"});var CF={};JV(CF,{customAlphabet:()=>eB,customRandom:()=>TF,nanoid:()=>iB,random:()=>MF,urlAlphabet:()=>yF});var MF,TF,eB,iB,kF=YV(()=>{BF();MF=x=>crypto.getRandomValues(new Uint8Array(x)),TF=(x,g,J)=>{let E=(2<<Math.log(x.length-1)/Math.LN2)-1,O=-~(1.6*E*g/x.length);return(l=g)=>{let lt="";for(;;){let It=J(O),Gt=O;for(;Gt--;)if(lt+=x[It[Gt]&E]||"",lt.length===l)return lt}}},eB=(x,g=21)=>TF(x,g,MF),iB=(x=21)=>crypto.getRandomValues(new Uint8Array(x)).reduce((g,J)=>(J&=63,J<36?g+=J.toString(36):J<62?g+=(J-26).toString(36).toUpperCase():J>62?g+="-":g+="_",g),"")});var fF=Bi((lQ,QF)=>{"use strict";var aB=(kF(),Ox(CF)).nanoid;function SF(x){this.origin=x.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=x.accessToken,this.version="0.3.0",this.pluginSessionID=this.generateSessionID(),this.sessionIncrementer=0,this.userAgent=this.getUserAgent(),this.options=x,this.send=this.send.bind(this),this.countries=x.countries?x.countries.split(","):null,this.types=x.types?x.types.split(","):null,this.bbox=x.bbox?x.bbox:null,this.language=x.language?x.language.split(","):null,this.limit=x.limit?+x.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(x),this.eventQueue=new Array,this.flushInterval=x.flushInterval||1e3,this.maxQueueSize=x.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}SF.prototype={select:function(x,g){var J=this.getEventPayload("search.select",g,{selectedFeature:x});if(J&&!(J.resultIndex===this.lastSentIndex&&J.queryString===this.lastSentInput||J.resultIndex==-1))return this.lastSentIndex=J.resultIndex,this.lastSentInput=J.queryString,this.push(J)},start:function(x){var g=this.getEventPayload("search.start",x);if(g)return this.push(g)},keyevent:function(x,g){if(x.key&&!(x.metaKey||[9,27,37,39,13,38,40].indexOf(x.keyCode)!==-1)){var J=this.getEventPayload("search.keystroke",g,{key:x.key});if(J)return this.push(J)}},send:function(x,g){if(!this.enableEventLogging)return g?g():void 0;var J=this.getRequestOptions(x);this.request(J,(function(E){if(E)return this.handleError(E,g);if(g)return g()}).bind(this))},getRequestOptions:function(x){Array.isArray(x)||(x=[x]);var g={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(x)};return g},getEventPayload:function(x,g,J={}){if(x==="search.select"&&!J.selectedFeature||x==="search.keystroke"&&!J.key)return null;var E;if(!g.options.proximity)E=null;else if(typeof g.options.proximity=="object")E=[g.options.proximity.longitude,g.options.proximity.latitude];else if(g.options.proximity==="ip"){var O=g._headers?g._headers["ip-proximity"]:null;O&&typeof O=="string"?E=O.split(",").map(parseFloat):E=[999,999]}else E=g.options.proximity;var l=g._map?g._map.getZoom():void 0,lt={event:x,version:this.getEventSchemaVersion(x),created:+new Date,sessionIdentifier:this.getSessionId(),country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:g.options.autocomplete,fuzzyMatch:g.options.fuzzyMatch,proximity:E,limit:g.options.limit,routing:g.options.routing,worldview:g.options.worldview,mapZoom:l,keyboardLocale:this.locale};if(x==="search.select"?lt.queryString=g.inputString:x!="search.select"&&g._inputEl?lt.queryString=g._inputEl.value:lt.queryString=g.inputString,["search.keystroke","search.select"].includes(x)&&(lt.path="geocoding/v5/mapbox.places"),x==="search.keystroke"&&J.key)lt.lastAction=J.key;else if(x==="search.select"&&J.selectedFeature){var It=J.selectedFeature,Gt=this.getSelectedIndex(It,g);if(lt.resultIndex=Gt,lt.resultPlaceName=It.place_name,lt.resultId=It.id,It.properties&&(lt.resultMapboxId=It.properties.mapbox_id),g._typeahead){var $t=g._typeahead.data;$t&&$t.length>0&&(lt.suggestionIds=this.getSuggestionIds($t),lt.suggestionNames=this.getSuggestionNames($t),lt.suggestionTypes=this.getSuggestionTypes($t),lt.suggestionSources=this.getSuggestionSources($t))}}return this.validatePayload(lt)?lt:null},request:function(x,g){var J=new XMLHttpRequest;J.onreadystatechange=function(){if(this.readyState==4)return this.status==204?g(null):g(this.statusText)},J.open(x.method,x.host+"/"+x.path,!0);for(var E in x.headers){var O=x.headers[E];J.setRequestHeader(E,O)}J.send(x.body)},handleError:function(x,g){if(g)return g(x)},generateSessionID:function(){return aB()},getSessionId:function(){return this.pluginSessionID+"."+this.sessionIncrementer},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(x,g){if(g._typeahead){var J=g._typeahead.data,E=x.id,O=J.map(function(lt){return lt.id}),l=O.indexOf(E);return l}},getSuggestionIds:function(x){return x.map(function(g){return g.properties?g.properties.mapbox_id||"":g.id||""})},getSuggestionNames:function(x){return x.map(function(g){return g.place_name||""})},getSuggestionTypes:function(x){return x.map(function(g){return g.place_type&&Array.isArray(g.place_type)&&g.place_type[0]||""})},getSuggestionSources:function(x){return x.map(function(g){return g._source||""})},getEventSchemaVersion:function(x){return["search.keystroke","search.select"].includes(x)?"2.2":"2.0"},validatePayload:function(x){if(!x||!x.event)return!1;var g=["event","created","sessionIdentifier","queryString"],J=["event","created","sessionIdentifier","queryString","lastAction"],E=["event","created","sessionIdentifier","queryString","resultIndex","path","suggestionIds"],O=x.event;return O==="search.start"?this.objectHasRequiredProps(x,g):O==="search.keystroke"?this.objectHasRequiredProps(x,J):O==="search.select"?this.objectHasRequiredProps(x,E):!0},objectHasRequiredProps:function(x,g){return g.every(function(J){return J==="queryString"?typeof x[J]=="string"&&x[J].length>0:x[J]!==void 0})},shouldEnableLogging:function(x){return!(x.enableEventLogging===!1||x.origin&&x.origin!=="https://api.mapbox.com")},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(x,g){this.eventQueue.push(x),(this.eventQueue.length>=this.maxQueueSize||g)&&this.flush()},remove:function(){this.flush()}};QF.exports=SF});var EF=Bi((oQ,vF)=>{"use strict";var nB={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"\u05DC\u05D7\u05E4\u05E9",ja:"\u30B5\u30FC\u30C1",lv:"Mekl\u0113t",pt:"Procurar",sr:"\u041F\u0440\u0435\u0442\u0440\u0430\u0433\u0430",zh:"\u641C\u7D22",cs:"Vyhled\xE1v\xE1n\xED",hu:"Keres\xE9s",ka:"\u10EB\u10D8\u10D4\u10D1\u10D0",nb:"S\xF8ke",sk:"Vyh\u013Ead\xE1vanie",th:"\u0E04\u0E49\u0E19\u0E2B\u0E32",fi:"Hae",is:"Leita",ko:"\uC218\uC0C9",pl:"Szukaj",sl:"Iskanje",fa:"\u062C\u0633\u062A\u062C\u0648",ru:"\u041F\u043E\u0438\u0441\u043A"};vF.exports={placeholder:nB}});var zF=Bi((LF,mp)=>{(function(x,g,J){typeof mp<"u"&&mp.exports?mp.exports=J():x[g]=J()})(LF,"subtag",function(){var x="",g=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function J(It){return It.match(g)||[]}function E(It){return J(It).filter(function(Gt,$t){return Gt&&$t})}function O(It){return It=J(It),{language:It[1]||x,extlang:It[2]||x,script:It[3]||x,region:It[4]||x}}function l(It,Gt,$t){Object.defineProperty(It,Gt,{value:$t,enumerable:!0})}function lt(It,Gt,$t){function Kt(Ve){return J(Ve)[It]||x}l(Kt,"pattern",Gt),l(O,$t,Kt)}return lt(1,/^[a-zA-Z]{2,3}$/,"language"),lt(2,/^[a-zA-Z]{3}$/,"extlang"),lt(3,/^[a-zA-Z]{4}$/,"script"),lt(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),l(O,"split",E),O})});var HF=Bi((sQ,AF)=>{function wF(){}wF.prototype={isSupport:function(){return!!window.navigator.geolocation},getCurrentPosition:function(){let x={enableHighAccuracy:!0};return new Promise(function(g,J){window.navigator.geolocation.getCurrentPosition(g,J,x)})}};AF.exports=wF});var DF=Bi((rQ,OF)=>{function lB(x,g){let J=jF(x),E=["address","street","place","country"];var O;if(typeof g=="function")return g(J);let l=E.indexOf(g);return l===-1?O=E:O=E.slice(l),O.reduce(function(lt,It){return J[It]?(lt!==""&&(lt=lt+", "),lt+J[It]):lt},"")}function jF(x){let g=x.address||"",J=x.text||"",E=x.place_name||"",l={address:E.split(",")[0],houseNumber:g,street:J,placeName:E};return x.context.forEach(function(lt){let It=lt.id.split(".")[0];l[It]=lt.text}),l}var oB=/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/;OF.exports={transformFeatureToGeolocationText:lB,getAddressInfo:jF,REVERSE_GEOCODE_COORD_RGX:oB}});var $F=Bi((dQ,qF)=>{"use strict";var sB=dG(),rB=hG(),qr=Pr(),dB=UG().EventEmitter,_F=NG(),lu=oF(),ou=XF(),cB=fF(),bB=EF(),mB=zF(),hB=HF(),PF=DF(),ws={FORWARD:0,LOCAL:1,REVERSE:2};function pB(){var x=document.createElement("div");return x.className="mapboxgl-ctrl-geocoder--powered-by",x.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',x}function KF(x){this._eventEmitter=new dB,this.options=qr({},this.options,x),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new hB}KF.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",getItemValue:function(x){return x.place_name},render:function(x){var g=x.place_name.split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+g[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+g.splice(1,g.length).join(",")+"</div></div>"}},_headers:{},addTo:function(x){function g(J,E){if(!document.body.contains(E))throw new Error("Element provided to #addTo() exists, but is not in the DOM");let O=J.onAdd();E.appendChild(O)}if(x._controlContainer)x.addControl(this);else if(x instanceof HTMLElement)g(this,x);else if(typeof x=="string"){let J=document.querySelectorAll(x);if(J.length===0)throw new Error("Element ",x,"not found.");if(J.length>1)throw new Error("Geocoder can only be added to a single html element");g(this,J[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(x){if(x&&typeof x!="string"&&(this._map=x),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=ou(lu({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new cB(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this);var g=this.container=document.createElement("div");g.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var J=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",rB(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",(function($t){this.eventManager.keyevent($t,this)}).bind(this));var E=document.createElement("div");E.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var O=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(O),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),E.appendChild(this._clearEl),E.appendChild(this._loadingEl),g.appendChild(J),g.appendChild(this._inputEl),g.appendChild(E),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var l=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(l),E.appendChild(this._geolocateEl),this._showGeolocateButton()}var lt=this._typeahead=new sB(this._inputEl,[],{filter:!1,minLength:this.options.minLength,limit:this.options.limit});this.setRenderFunction(this.options.render),lt.getItemValue=this.options.getItemValue;var It=lt.list.draw,Gt=this._footerNode=pB();return lt.list.draw=function(){It.call(this),Gt.addEventListener("mousedown",(function(){this.selectingListItem=!0}).bind(this)),Gt.addEventListener("mouseup",(function(){this.selectingListItem=!1}).bind(this)),this.element.appendChild(Gt)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),g},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then((function(x){this._hideLoadingIcon();let g={geometry:{type:"Point",coordinates:[x.coords.longitude,x.coords.latitude]}};this._handleMarker(g),this._fly(g),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(g),this._showClearButton(),this.fresh=!1;let J={limit:1,language:[this.options.language],query:g.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){let E=g.geometry.coordinates[0]+","+g.geometry.coordinates[1];this._setInputValue(E),this._eventEmitter.emit("result",{result:g})}else this.geocoderService.reverseGeocode(J).send().then((function(E){let O=E.body.features[0];if(O){let l=PF.transformFeatureToGeolocationText(O,this.options.addressAccuracy);this._setInputValue(l),O.user_coordinates=g.geometry.coordinates,this._eventEmitter.emit("result",{result:O})}else this._eventEmitter.emit("result",{result:{user_coordinates:g.geometry.coordinates}})}).bind(this))}).bind(this)).catch((function(x){x.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}).bind(this))},createIcon:function(x,g){var J=document.createElementNS("http://www.w3.org/2000/svg","svg");return J.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+x),J.setAttribute("viewBox","0 0 18 18"),J.setAttribute("xml:space","preserve"),J.setAttribute("width",18),J.setAttribute("height",18),J.innerHTML=g,J},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(x){this._inputEl.value=x,setTimeout((function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}).bind(this),1)},_onPaste:function(x){var g=(x.clipboardData||window.clipboardData).getData("text");g.length>=this.options.minLength&&this._geocode(g)},_onKeyDown:function(x){var g=27,J=9;if(x.keyCode===g&&this.options.clearAndBlurOnEsc)return this._clear(x),this._inputEl.blur();var E=x.target&&x.target.shadowRoot?x.target.shadowRoot.activeElement:x.target,O=E?E.value:"";if(!O)return this.fresh=!0,x.keyCode!==J&&this.clear(x),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(x.metaKey||[J,g,37,39,13,38,40].indexOf(x.keyCode)!==-1)&&E.value.length>=this.options.minLength&&this._geocode(E.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(x){this.options.clearOnBlur&&this._clearOnBlur(x),this.options.collapsed&&this._collapse()},_onChange:function(){var x=this._typeahead.selected;x&&JSON.stringify(x)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(x),this.options.marker&&this._mapboxgl&&this._handleMarker(x),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(x),this._eventEmitter.emit("result",{result:x}),this.eventManager.select(x,this))},_fly:function(x){var g;if(x.properties&&_F[x.properties.short_code])g=qr({},this.options.flyTo),this._map&&this._map.fitBounds(_F[x.properties.short_code].bbox,g);else if(x.bbox){var J=x.bbox;g=qr({},this.options.flyTo),this._map&&this._map.fitBounds([[J[0],J[1]],[J[2],J[3]]],g)}else{var E={zoom:this.options.zoom};g=qr({},E,this.options.flyTo),x.center?g.center=x.center:x.geometry&&x.geometry.type&&x.geometry.type==="Point"&&x.geometry.coordinates&&(g.center=x.geometry.coordinates),this._map&&this._map.flyTo(g)}},_requestType:function(x,g){var J;return x.localGeocoderOnly?J=ws.LOCAL:x.reverseGeocode&&PF.REVERSE_GEOCODE_COORD_RGX.test(g)?J=ws.REVERSE:J=ws.FORWARD,J},_setupConfig:function(x,g){let J=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],E=/[\s,]+/;var O=this,l=J.reduce(function(It,Gt){if(O.options[Gt]===void 0||O.options[Gt]===null)return It;["countries","types","language"].indexOf(Gt)>-1?It[Gt]=O.options[Gt].split(E):It[Gt]=O.options[Gt];let $t=typeof O.options[Gt].longitude=="number"&&typeof O.options[Gt].latitude=="number";if(Gt==="proximity"&&$t){let Kt=O.options[Gt].longitude,Ve=O.options[Gt].latitude;It[Gt]=[Kt,Ve]}return It},{});switch(x){case ws.REVERSE:{var lt=g.split(E).map(function(It){return parseFloat(It,10)});O.options.flipCoordinates||lt.reverse(),l.types&&l.types[0],l=qr(l,{query:lt,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(It){It in l&&delete l[It]})}break;case ws.FORWARD:{let It=g.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test(It)&&(g=g.replace(/,/g," ")),l=qr(l,{query:g})}break}return l.session_token=this.eventManager.getSessionId(),l},_geocode:function(x){this.inputString=x,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:x});let g=this._requestType(this.options,x),J=this._setupConfig(g,x);var E;switch(g){case ws.LOCAL:E=Promise.resolve();break;case ws.FORWARD:E=this.geocoderService.forwardGeocode(J).send();break;case ws.REVERSE:E=this.geocoderService.reverseGeocode(J).send();break}var O=this.options.localGeocoder?this.options.localGeocoder(x)||[]:[],l=[],lt=null;return E.catch((function(It){lt=It}).bind(this)).then((function(It){this._hideLoadingIcon();var Gt={};return It?It.statusCode=="200"&&(Gt=It.body,Gt.request=It.request,Gt.headers=It.headers,this._headers=It.headers):Gt={type:"FeatureCollection",features:[]},Gt.config=J,this.fresh&&(this.eventManager.start(this),this.fresh=!1),Gt.features&&Gt.features.length&&Gt.features.map(function($t){$t._source="mapbox"}),Gt.features=Gt.features?O.concat(Gt.features):O,this.options.externalGeocoder?(l=this.options.externalGeocoder(x,Gt.features)||Promise.resolve([]),l.then(function($t){return Gt.features=Gt.features?$t.concat(Gt.features):$t,Gt},function(){return Gt})):Gt}).bind(this)).then((function(It){if(lt)throw lt;this.options.filter&&It.features.length&&(It.features=It.features.filter(this.options.filter)),It.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",It),this._typeahead.update(It.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",It))}).bind(this)).catch((function(It){this._hideLoadingIcon(),this._hideAttribution(),O.length&&this.options.localGeocoder||l.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(O)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:O}),this._eventEmitter.emit("error",{error:It})}).bind(this)),E},_clear:function(x){x&&x.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this.eventManager.sessionIncrementer++,this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(x){this._clear(x),this._inputEl.focus()},_clearOnBlur:function(x){var g=this;x.relatedTarget&&g._clear(x)},_onQueryResult:function(x){var g=x.body;if(g.features.length){var J=g.features[0];this._typeahead.selected=J,this._inputEl.value=J.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var x=this._map.getCenter().wrap();this.setProximity({longitude:x.lng,latitude:x.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(x){return this._geocode(x).then(this._onQueryResult),this},_renderError:function(){var x="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(x)},_renderLocationError:function(){var x="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(x)},_renderNoResults:function(){var x="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(x)},_renderUserDeniedGeolocationError:function(){var x="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(x)},_renderMessage:function(x){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(x)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var x=this.options.language.split(",")[0],g=mB.language(x),J=bB.placeholder[g];if(J)return J}return"Search"},setInput:function(x,g){return g===void 0&&(g=!1),this._inputEl.value=x,this._typeahead.selected=null,this._typeahead.clear(),x.length>=this.options.minLength&&(g?this._geocode(x):this._onChange()),this},setProximity:function(x,g=!0){return this.options.proximity=x,g&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(x){return x&&typeof x=="function"&&(this._typeahead.render=x),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(x){var g=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=x||this.options.language||g,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(x){return this.options.zoom=x,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(x){return this.options.flyTo=x,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(x){return this.options.placeholder=x||this._getPlaceholderText(),this._inputEl.placeholder=this.options.placeholder,this._inputEl.setAttribute("aria-label",this.options.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(x){return this.options.bbox=x,this},getCountries:function(){return this.options.countries},setCountries:function(x){return this.options.countries=x,this},getTypes:function(){return this.options.types},setTypes:function(x){return this.options.types=x,this},getMinLength:function(){return this.options.minLength},setMinLength:function(x){return this.options.minLength=x,this._typeahead&&(this._typeahead.options.minLength=x),this},getLimit:function(){return this.options.limit},setLimit:function(x){return this.options.limit=x,this._typeahead&&(this._typeahead.options.limit=x),this},getFilter:function(){return this.options.filter},setFilter:function(x){return this.options.filter=x,this},setOrigin:function(x){return this.options.origin=x,this.geocoderService=ou(lu({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(x){return this.options.accessToken=x,this.geocoderService=ou(lu({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(x){return this.options.autocomplete=x,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(x){return this.options.fuzzyMatch=x,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(x){return this.options.routing=x,this},getRouting:function(){return this.options.routing},setWorldview:function(x){return this.options.worldview=x,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(x){if(this._map){this._removeMarker();var g={color:"#4668F2"},J=qr({},g,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(J),x.center?this.mapMarker.setLngLat(x.center).addTo(this._map):x.geometry&&x.geometry.type&&x.geometry.type==="Point"&&x.geometry.coordinates&&this.mapMarker.setLngLat(x.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(x,g){return this._eventEmitter.on(x,g),this},off:function(x,g){return this._eventEmitter.removeListener(x,g),this.eventManager.remove(),this}};qF.exports=KF});var v0={};JV(v0,{afterMain:()=>SV,afterRead:()=>TV,afterWrite:()=>vV,applyStyles:()=>Wc,arrow:()=>B0,auto:()=>Rm,basePlacements:()=>Xo,beforeMain:()=>CV,beforeRead:()=>BV,beforeWrite:()=>QV,bottom:()=>Xa,clippingParents:()=>n1,computeStyles:()=>Zc,createPopper:()=>Xm,createPopperBase:()=>DV,createPopperLite:()=>_V,detectOverflow:()=>xn,end:()=>Ms,eventListeners:()=>gc,flip:()=>k0,hide:()=>S0,left:()=>Ra,main:()=>kV,modifierPhases:()=>o1,offset:()=>Q0,placements:()=>Fm,popper:()=>Sr,popperGenerator:()=>Ar,popperOffsets:()=>Gc,preventOverflow:()=>f0,read:()=>MV,reference:()=>l1,right:()=>xa,start:()=>so,top:()=>Wa,variationPlacements:()=>y0,viewport:()=>Gm,write:()=>fV});var Wa="top",Xa="bottom",xa="right",Ra="left",Rm="auto",Xo=[Wa,Xa,xa,Ra],so="start",Ms="end",n1="clippingParents",Gm="viewport",Sr="popper",l1="reference",y0=Xo.reduce(function(x,g){return x.concat([g+"-"+so,g+"-"+Ms])},[]),Fm=[].concat(Xo,[Rm]).reduce(function(x,g){return x.concat([g,g+"-"+so,g+"-"+Ms])},[]),BV="beforeRead",MV="read",TV="afterRead",CV="beforeMain",kV="main",SV="afterMain",QV="beforeWrite",fV="write",vV="afterWrite",o1=[BV,MV,TV,CV,kV,SV,QV,fV,vV];function Aa(x){return x?(x.nodeName||"").toLowerCase():null}function ca(x){if(x==null)return window;if(x.toString()!=="[object Window]"){var g=x.ownerDocument;return g&&g.defaultView||window}return x}function Zl(x){var g=ca(x).Element;return x instanceof g||x instanceof Element}function Ca(x){var g=ca(x).HTMLElement;return x instanceof g||x instanceof HTMLElement}function pc(x){if(typeof ShadowRoot>"u")return!1;var g=ca(x).ShadowRoot;return x instanceof g||x instanceof ShadowRoot}function Dx(x){var g=x.state;Object.keys(g.elements).forEach(function(J){var E=g.styles[J]||{},O=g.attributes[J]||{},l=g.elements[J];!Ca(l)||!Aa(l)||(Object.assign(l.style,E),Object.keys(O).forEach(function(lt){var It=O[lt];It===!1?l.removeAttribute(lt):l.setAttribute(lt,It===!0?"":It)}))})}function _x(x){var g=x.state,J={popper:{position:g.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(g.elements.popper.style,J.popper),g.styles=J,g.elements.arrow&&Object.assign(g.elements.arrow.style,J.arrow),function(){Object.keys(g.elements).forEach(function(E){var O=g.elements[E],l=g.attributes[E]||{},lt=Object.keys(g.styles.hasOwnProperty(E)?g.styles[E]:J[E]),It=lt.reduce(function(Gt,$t){return Gt[$t]="",Gt},{});!Ca(O)||!Aa(O)||(Object.assign(O.style,It),Object.keys(l).forEach(function(Gt){O.removeAttribute(Gt)}))})}}var Wc={name:"applyStyles",enabled:!0,phase:"write",fn:Dx,effect:_x,requires:["computeStyles"]};function Ha(x){return x.split("-")[0]}var zl=Math.max,Qr=Math.min,yo=Math.round;function uc(){var x=navigator.userAgentData;return x!=null&&x.brands&&Array.isArray(x.brands)?x.brands.map(function(g){return g.brand+"/"+g.version}).join(" "):navigator.userAgent}function Im(){return!/^((?!chrome|android).)*safari/i.test(uc())}function gl(x,g,J){g===void 0&&(g=!1),J===void 0&&(J=!1);var E=x.getBoundingClientRect(),O=1,l=1;g&&Ca(x)&&(O=x.offsetWidth>0&&yo(E.width)/x.offsetWidth||1,l=x.offsetHeight>0&&yo(E.height)/x.offsetHeight||1);var lt=Zl(x)?ca(x):window,It=lt.visualViewport,Gt=!Im()&&J,$t=(E.left+(Gt&&It?It.offsetLeft:0))/O,Kt=(E.top+(Gt&&It?It.offsetTop:0))/l,Ve=E.width/O,re=E.height/l;return{width:Ve,height:re,top:Kt,right:$t+Ve,bottom:Kt+re,left:$t,x:$t,y:Kt}}function fr(x){var g=gl(x),J=x.offsetWidth,E=x.offsetHeight;return Math.abs(g.width-J)<=1&&(J=g.width),Math.abs(g.height-E)<=1&&(E=g.height),{x:x.offsetLeft,y:x.offsetTop,width:J,height:E}}function Um(x,g){var J=g.getRootNode&&g.getRootNode();if(x.contains(g))return!0;if(J&&pc(J)){var E=g;do{if(E&&x.isSameNode(E))return!0;E=E.parentNode||E.host}while(E)}return!1}function Un(x){return ca(x).getComputedStyle(x)}function s1(x){return["table","td","th"].indexOf(Aa(x))>=0}function tn(x){return((Zl(x)?x.ownerDocument:x.document)||window.document).documentElement}function Bo(x){return Aa(x)==="html"?x:x.assignedSlot||x.parentNode||(pc(x)?x.host:null)||tn(x)}function EV(x){return!Ca(x)||Un(x).position==="fixed"?null:x.offsetParent}function Px(x){var g=/firefox/i.test(uc()),J=/Trident/i.test(uc());if(J&&Ca(x)){var E=Un(x);if(E.position==="fixed")return null}var O=Bo(x);for(pc(O)&&(O=O.host);Ca(O)&&["html","body"].indexOf(Aa(O))<0;){var l=Un(O);if(l.transform!=="none"||l.perspective!=="none"||l.contain==="paint"||["transform","perspective"].indexOf(l.willChange)!==-1||g&&l.willChange==="filter"||g&&l.filter&&l.filter!=="none")return O;O=O.parentNode}return null}function wl(x){for(var g=ca(x),J=EV(x);J&&s1(J)&&Un(J).position==="static";)J=EV(J);return J&&(Aa(J)==="html"||Aa(J)==="body"&&Un(J).position==="static")?g:J||Px(x)||g}function vr(x){return["top","bottom"].indexOf(x)>=0?"x":"y"}function Er(x,g,J){return zl(x,Qr(g,J))}function LV(x,g,J){var E=Er(x,g,J);return E>J?J:E}function xm(){return{top:0,right:0,bottom:0,left:0}}function Nm(x){return Object.assign({},xm(),x)}function Ym(x,g){return g.reduce(function(J,E){return J[E]=x,J},{})}var Kx=function(g,J){return g=typeof g=="function"?g(Object.assign({},J.rects,{placement:J.placement})):g,Nm(typeof g!="number"?g:Ym(g,Xo))};function qx(x){var g,J=x.state,E=x.name,O=x.options,l=J.elements.arrow,lt=J.modifiersData.popperOffsets,It=Ha(J.placement),Gt=vr(It),$t=[Ra,xa].indexOf(It)>=0,Kt=$t?"height":"width";if(!(!l||!lt)){var Ve=Kx(O.padding,J),re=fr(l),le=Gt==="y"?Wa:Ra,je=Gt==="y"?Xa:xa,Ze=J.rects.reference[Kt]+J.rects.reference[Gt]-lt[Gt]-J.rects.popper[Kt],ii=lt[Gt]-J.rects.reference[Gt],bi=wl(l),Xe=bi?Gt==="y"?bi.clientHeight||0:bi.clientWidth||0:0,vi=Ze/2-ii/2,we=Ve[le],We=Xe-re[Kt]-Ve[je],_e=Xe/2-re[Kt]/2+vi,Zi=Er(we,_e,We),Re=Gt;J.modifiersData[E]=(g={},g[Re]=Zi,g.centerOffset=Zi-_e,g)}}function $x(x){var g=x.state,J=x.options,E=J.element,O=E===void 0?"[data-popper-arrow]":E;O!=null&&(typeof O=="string"&&(O=g.elements.popper.querySelector(O),!O)||Um(g.elements.popper,O)&&(g.elements.arrow=O))}var B0={name:"arrow",enabled:!0,phase:"main",fn:qx,effect:$x,requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function Vl(x){return x.split("-")[1]}var tN={top:"auto",right:"auto",bottom:"auto",left:"auto"};function eN(x,g){var J=x.x,E=x.y,O=g.devicePixelRatio||1;return{x:yo(J*O)/O||0,y:yo(E*O)/O||0}}function zV(x){var g,J=x.popper,E=x.popperRect,O=x.placement,l=x.variation,lt=x.offsets,It=x.position,Gt=x.gpuAcceleration,$t=x.adaptive,Kt=x.roundOffsets,Ve=x.isFixed,re=lt.x,le=re===void 0?0:re,je=lt.y,Ze=je===void 0?0:je,ii=typeof Kt=="function"?Kt({x:le,y:Ze}):{x:le,y:Ze};le=ii.x,Ze=ii.y;var bi=lt.hasOwnProperty("x"),Xe=lt.hasOwnProperty("y"),vi=Ra,we=Wa,We=window;if($t){var _e=wl(J),Zi="clientHeight",Re="clientWidth";if(_e===ca(J)&&(_e=tn(J),Un(_e).position!=="static"&&It==="absolute"&&(Zi="scrollHeight",Re="scrollWidth")),_e=_e,O===Wa||(O===Ra||O===xa)&&l===Ms){we=Xa;var Fe=Ve&&_e===We&&We.visualViewport?We.visualViewport.height:_e[Zi];Ze-=Fe-E.height,Ze*=Gt?1:-1}if(O===Ra||(O===Wa||O===Xa)&&l===Ms){vi=xa;var wi=Ve&&_e===We&&We.visualViewport?We.visualViewport.width:_e[Re];le-=wi-E.width,le*=Gt?1:-1}}var Pi=Object.assign({position:It},$t&&tN),Sa=Kt===!0?eN({x:le,y:Ze},ca(J)):{x:le,y:Ze};if(le=Sa.x,Ze=Sa.y,Gt){var ye;return Object.assign({},Pi,(ye={},ye[we]=Xe?"0":"",ye[vi]=bi?"0":"",ye.transform=(We.devicePixelRatio||1)<=1?"translate("+le+"px, "+Ze+"px)":"translate3d("+le+"px, "+Ze+"px, 0)",ye))}return Object.assign({},Pi,(g={},g[we]=Xe?Ze+"px":"",g[vi]=bi?le+"px":"",g.transform="",g))}function iN(x){var g=x.state,J=x.options,E=J.gpuAcceleration,O=E===void 0?!0:E,l=J.adaptive,lt=l===void 0?!0:l,It=J.roundOffsets,Gt=It===void 0?!0:It,$t={placement:Ha(g.placement),variation:Vl(g.placement),popper:g.elements.popper,popperRect:g.rects.popper,gpuAcceleration:O,isFixed:g.options.strategy==="fixed"};g.modifiersData.popperOffsets!=null&&(g.styles.popper=Object.assign({},g.styles.popper,zV(Object.assign({},$t,{offsets:g.modifiersData.popperOffsets,position:g.options.strategy,adaptive:lt,roundOffsets:Gt})))),g.modifiersData.arrow!=null&&(g.styles.arrow=Object.assign({},g.styles.arrow,zV(Object.assign({},$t,{offsets:g.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:Gt})))),g.attributes.popper=Object.assign({},g.attributes.popper,{"data-popper-placement":g.placement})}var Zc={name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:iN,data:{}};var M0={passive:!0};function aN(x){var g=x.state,J=x.instance,E=x.options,O=E.scroll,l=O===void 0?!0:O,lt=E.resize,It=lt===void 0?!0:lt,Gt=ca(g.elements.popper),$t=[].concat(g.scrollParents.reference,g.scrollParents.popper);return l&&$t.forEach(function(Kt){Kt.addEventListener("scroll",J.update,M0)}),It&&Gt.addEventListener("resize",J.update,M0),function(){l&&$t.forEach(function(Kt){Kt.removeEventListener("scroll",J.update,M0)}),It&&Gt.removeEventListener("resize",J.update,M0)}}var gc={name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:aN,data:{}};var nN={left:"right",right:"left",bottom:"top",top:"bottom"};function Vc(x){return x.replace(/left|right|bottom|top/g,function(g){return nN[g]})}var lN={start:"end",end:"start"};function T0(x){return x.replace(/start|end/g,function(g){return lN[g]})}function Lr(x){var g=ca(x),J=g.pageXOffset,E=g.pageYOffset;return{scrollLeft:J,scrollTop:E}}function zr(x){return gl(tn(x)).left+Lr(x).scrollLeft}function r1(x,g){var J=ca(x),E=tn(x),O=J.visualViewport,l=E.clientWidth,lt=E.clientHeight,It=0,Gt=0;if(O){l=O.width,lt=O.height;var $t=Im();($t||!$t&&g==="fixed")&&(It=O.offsetLeft,Gt=O.offsetTop)}return{width:l,height:lt,x:It+zr(x),y:Gt}}function d1(x){var g,J=tn(x),E=Lr(x),O=(g=x.ownerDocument)==null?void 0:g.body,l=zl(J.scrollWidth,J.clientWidth,O?O.scrollWidth:0,O?O.clientWidth:0),lt=zl(J.scrollHeight,J.clientHeight,O?O.scrollHeight:0,O?O.clientHeight:0),It=-E.scrollLeft+zr(x),Gt=-E.scrollTop;return Un(O||J).direction==="rtl"&&(It+=zl(J.clientWidth,O?O.clientWidth:0)-l),{width:l,height:lt,x:It,y:Gt}}function wr(x){var g=Un(x),J=g.overflow,E=g.overflowX,O=g.overflowY;return/auto|scroll|overlay|hidden/.test(J+O+E)}function C0(x){return["html","body","#document"].indexOf(Aa(x))>=0?x.ownerDocument.body:Ca(x)&&wr(x)?x:C0(Bo(x))}function Ts(x,g){var J;g===void 0&&(g=[]);var E=C0(x),O=E===((J=x.ownerDocument)==null?void 0:J.body),l=ca(E),lt=O?[l].concat(l.visualViewport||[],wr(E)?E:[]):E,It=g.concat(lt);return O?It:It.concat(Ts(Bo(lt)))}function Rc(x){return Object.assign({},x,{left:x.x,top:x.y,right:x.x+x.width,bottom:x.y+x.height})}function oN(x,g){var J=gl(x,!1,g==="fixed");return J.top=J.top+x.clientTop,J.left=J.left+x.clientLeft,J.bottom=J.top+x.clientHeight,J.right=J.left+x.clientWidth,J.width=x.clientWidth,J.height=x.clientHeight,J.x=J.left,J.y=J.top,J}function wV(x,g,J){return g===Gm?Rc(r1(x,J)):Zl(g)?oN(g,J):Rc(d1(tn(x)))}function sN(x){var g=Ts(Bo(x)),J=["absolute","fixed"].indexOf(Un(x).position)>=0,E=J&&Ca(x)?wl(x):x;return Zl(E)?g.filter(function(O){return Zl(O)&&Um(O,E)&&Aa(O)!=="body"}):[]}function c1(x,g,J,E){var O=g==="clippingParents"?sN(x):[].concat(g),l=[].concat(O,[J]),lt=l[0],It=l.reduce(function(Gt,$t){var Kt=wV(x,$t,E);return Gt.top=zl(Kt.top,Gt.top),Gt.right=Qr(Kt.right,Gt.right),Gt.bottom=Qr(Kt.bottom,Gt.bottom),Gt.left=zl(Kt.left,Gt.left),Gt},wV(x,lt,E));return It.width=It.right-It.left,It.height=It.bottom-It.top,It.x=It.left,It.y=It.top,It}function Jm(x){var g=x.reference,J=x.element,E=x.placement,O=E?Ha(E):null,l=E?Vl(E):null,lt=g.x+g.width/2-J.width/2,It=g.y+g.height/2-J.height/2,Gt;switch(O){case Wa:Gt={x:lt,y:g.y-J.height};break;case Xa:Gt={x:lt,y:g.y+g.height};break;case xa:Gt={x:g.x+g.width,y:It};break;case Ra:Gt={x:g.x-J.width,y:It};break;default:Gt={x:g.x,y:g.y}}var $t=O?vr(O):null;if($t!=null){var Kt=$t==="y"?"height":"width";switch(l){case so:Gt[$t]=Gt[$t]-(g[Kt]/2-J[Kt]/2);break;case Ms:Gt[$t]=Gt[$t]+(g[Kt]/2-J[Kt]/2);break;default:}}return Gt}function xn(x,g){g===void 0&&(g={});var J=g,E=J.placement,O=E===void 0?x.placement:E,l=J.strategy,lt=l===void 0?x.strategy:l,It=J.boundary,Gt=It===void 0?n1:It,$t=J.rootBoundary,Kt=$t===void 0?Gm:$t,Ve=J.elementContext,re=Ve===void 0?Sr:Ve,le=J.altBoundary,je=le===void 0?!1:le,Ze=J.padding,ii=Ze===void 0?0:Ze,bi=Nm(typeof ii!="number"?ii:Ym(ii,Xo)),Xe=re===Sr?l1:Sr,vi=x.rects.popper,we=x.elements[je?Xe:re],We=c1(Zl(we)?we:we.contextElement||tn(x.elements.popper),Gt,Kt,lt),_e=gl(x.elements.reference),Zi=Jm({reference:_e,element:vi,strategy:"absolute",placement:O}),Re=Rc(Object.assign({},vi,Zi)),Fe=re===Sr?Re:_e,wi={top:We.top-Fe.top+bi.top,bottom:Fe.bottom-We.bottom+bi.bottom,left:We.left-Fe.left+bi.left,right:Fe.right-We.right+bi.right},Pi=x.modifiersData.offset;if(re===Sr&&Pi){var Sa=Pi[O];Object.keys(wi).forEach(function(ye){var aa=[xa,Xa].indexOf(ye)>=0?1:-1,ya=[Wa,Xa].indexOf(ye)>=0?"y":"x";wi[ye]+=Sa[ya]*aa})}return wi}function b1(x,g){g===void 0&&(g={});var J=g,E=J.placement,O=J.boundary,l=J.rootBoundary,lt=J.padding,It=J.flipVariations,Gt=J.allowedAutoPlacements,$t=Gt===void 0?Fm:Gt,Kt=Vl(E),Ve=Kt?It?y0:y0.filter(function(je){return Vl(je)===Kt}):Xo,re=Ve.filter(function(je){return $t.indexOf(je)>=0});re.length===0&&(re=Ve);var le=re.reduce(function(je,Ze){return je[Ze]=xn(x,{placement:Ze,boundary:O,rootBoundary:l,padding:lt})[Ha(Ze)],je},{});return Object.keys(le).sort(function(je,Ze){return le[je]-le[Ze]})}function rN(x){if(Ha(x)===Rm)return[];var g=Vc(x);return[T0(x),g,T0(g)]}function dN(x){var g=x.state,J=x.options,E=x.name;if(!g.modifiersData[E]._skip){for(var O=J.mainAxis,l=O===void 0?!0:O,lt=J.altAxis,It=lt===void 0?!0:lt,Gt=J.fallbackPlacements,$t=J.padding,Kt=J.boundary,Ve=J.rootBoundary,re=J.altBoundary,le=J.flipVariations,je=le===void 0?!0:le,Ze=J.allowedAutoPlacements,ii=g.options.placement,bi=Ha(ii),Xe=bi===ii,vi=Gt||(Xe||!je?[Vc(ii)]:rN(ii)),we=[ii].concat(vi).reduce(function(Ga,ja){return Ga.concat(Ha(ja)===Rm?b1(g,{placement:ja,boundary:Kt,rootBoundary:Ve,padding:$t,flipVariations:je,allowedAutoPlacements:Ze}):ja)},[]),We=g.rects.reference,_e=g.rects.popper,Zi=new Map,Re=!0,Fe=we[0],wi=0;wi<we.length;wi++){var Pi=we[wi],Sa=Ha(Pi),ye=Vl(Pi)===so,aa=[Wa,Xa].indexOf(Sa)>=0,ya=aa?"width":"height",ua=xn(g,{placement:Pi,boundary:Kt,rootBoundary:Ve,altBoundary:re,padding:$t}),Be=aa?ye?xa:Ra:ye?Xa:Wa;We[ya]>_e[ya]&&(Be=Vc(Be));var Yn=Vc(Be),bn=[];if(l&&bn.push(ua[Sa]<=0),It&&bn.push(ua[Be]<=0,ua[Yn]<=0),bn.every(function(Ga){return Ga})){Fe=Pi,Re=!1;break}Zi.set(Pi,bn)}if(Re)for(var fn=je?3:1,Qe=function(ja){var En=we.find(function(Jn){var ut=Zi.get(Jn);if(ut)return ut.slice(0,ja).every(function(mn){return mn})});if(En)return Fe=En,"break"},vn=fn;vn>0;vn--){var Qa=Qe(vn);if(Qa==="break")break}g.placement!==Fe&&(g.modifiersData[E]._skip=!0,g.placement=Fe,g.reset=!0)}}var k0={name:"flip",enabled:!0,phase:"main",fn:dN,requiresIfExists:["offset"],data:{_skip:!1}};function AV(x,g,J){return J===void 0&&(J={x:0,y:0}),{top:x.top-g.height-J.y,right:x.right-g.width+J.x,bottom:x.bottom-g.height+J.y,left:x.left-g.width-J.x}}function HV(x){return[Wa,xa,Xa,Ra].some(function(g){return x[g]>=0})}function cN(x){var g=x.state,J=x.name,E=g.rects.reference,O=g.rects.popper,l=g.modifiersData.preventOverflow,lt=xn(g,{elementContext:"reference"}),It=xn(g,{altBoundary:!0}),Gt=AV(lt,E),$t=AV(It,O,l),Kt=HV(Gt),Ve=HV($t);g.modifiersData[J]={referenceClippingOffsets:Gt,popperEscapeOffsets:$t,isReferenceHidden:Kt,hasPopperEscaped:Ve},g.attributes.popper=Object.assign({},g.attributes.popper,{"data-popper-reference-hidden":Kt,"data-popper-escaped":Ve})}var S0={name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:cN};function bN(x,g,J){var E=Ha(x),O=[Ra,Wa].indexOf(E)>=0?-1:1,l=typeof J=="function"?J(Object.assign({},g,{placement:x})):J,lt=l[0],It=l[1];return lt=lt||0,It=(It||0)*O,[Ra,xa].indexOf(E)>=0?{x:It,y:lt}:{x:lt,y:It}}function mN(x){var g=x.state,J=x.options,E=x.name,O=J.offset,l=O===void 0?[0,0]:O,lt=Fm.reduce(function(Kt,Ve){return Kt[Ve]=bN(Ve,g.rects,l),Kt},{}),It=lt[g.placement],Gt=It.x,$t=It.y;g.modifiersData.popperOffsets!=null&&(g.modifiersData.popperOffsets.x+=Gt,g.modifiersData.popperOffsets.y+=$t),g.modifiersData[E]=lt}var Q0={name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:mN};function hN(x){var g=x.state,J=x.name;g.modifiersData[J]=Jm({reference:g.rects.reference,element:g.rects.popper,strategy:"absolute",placement:g.placement})}var Gc={name:"popperOffsets",enabled:!0,phase:"read",fn:hN,data:{}};function m1(x){return x==="x"?"y":"x"}function pN(x){var g=x.state,J=x.options,E=x.name,O=J.mainAxis,l=O===void 0?!0:O,lt=J.altAxis,It=lt===void 0?!1:lt,Gt=J.boundary,$t=J.rootBoundary,Kt=J.altBoundary,Ve=J.padding,re=J.tether,le=re===void 0?!0:re,je=J.tetherOffset,Ze=je===void 0?0:je,ii=xn(g,{boundary:Gt,rootBoundary:$t,padding:Ve,altBoundary:Kt}),bi=Ha(g.placement),Xe=Vl(g.placement),vi=!Xe,we=vr(bi),We=m1(we),_e=g.modifiersData.popperOffsets,Zi=g.rects.reference,Re=g.rects.popper,Fe=typeof Ze=="function"?Ze(Object.assign({},g.rects,{placement:g.placement})):Ze,wi=typeof Fe=="number"?{mainAxis:Fe,altAxis:Fe}:Object.assign({mainAxis:0,altAxis:0},Fe),Pi=g.modifiersData.offset?g.modifiersData.offset[g.placement]:null,Sa={x:0,y:0};if(_e){if(l){var ye,aa=we==="y"?Wa:Ra,ya=we==="y"?Xa:xa,ua=we==="y"?"height":"width",Be=_e[we],Yn=Be+ii[aa],bn=Be-ii[ya],fn=le?-Re[ua]/2:0,Qe=Xe===so?Zi[ua]:Re[ua],vn=Xe===so?-Re[ua]:-Zi[ua],Qa=g.elements.arrow,Ga=le&&Qa?fr(Qa):{width:0,height:0},ja=g.modifiersData["arrow#persistent"]?g.modifiersData["arrow#persistent"].padding:xm(),En=ja[aa],Jn=ja[ya],ut=Er(0,Zi[ua],Ga[ua]),mn=vi?Zi[ua]/2-fn-ut-En-wi.mainAxis:Qe-ut-En-wi.mainAxis,el=vi?-Zi[ua]/2+fn+ut+Jn+wi.mainAxis:vn+ut+Jn+wi.mainAxis,Il=g.elements.arrow&&wl(g.elements.arrow),ee=Il?we==="y"?Il.clientTop||0:Il.clientLeft||0:0,il=(ye=Pi?.[we])!=null?ye:0,Za=Be+mn-il-ee,Ln=Be+el-il,ti=Er(le?Qr(Yn,Za):Yn,Be,le?zl(bn,Ln):bn);_e[we]=ti,Sa[we]=ti-Be}if(It){var sa,hn=we==="x"?Wa:Ra,Ul=we==="x"?Xa:xa,fa=_e[We],zn=We==="y"?"height":"width",ze=fa+ii[hn],xl=fa-ii[Ul],pn=[Wa,Ra].indexOf(bi)!==-1,al=(sa=Pi?.[We])!=null?sa:0,Fa=pn?ze:fa-Zi[zn]-Re[zn]-al+wi.altAxis,va=pn?fa+Zi[zn]+Re[zn]-al-wi.altAxis:xl,Al=le&&pn?LV(Fa,fa,va):Er(le?Fa:ze,fa,le?va:xl);_e[We]=Al,Sa[We]=Al-fa}g.modifiersData[E]=Sa}}var f0={name:"preventOverflow",enabled:!0,phase:"main",fn:pN,requiresIfExists:["offset"]};function h1(x){return{scrollLeft:x.scrollLeft,scrollTop:x.scrollTop}}function p1(x){return x===ca(x)||!Ca(x)?Lr(x):h1(x)}function WN(x){var g=x.getBoundingClientRect(),J=yo(g.width)/x.offsetWidth||1,E=yo(g.height)/x.offsetHeight||1;return J!==1||E!==1}function W1(x,g,J){J===void 0&&(J=!1);var E=Ca(g),O=Ca(g)&&WN(g),l=tn(g),lt=gl(x,O,J),It={scrollLeft:0,scrollTop:0},Gt={x:0,y:0};return(E||!E&&!J)&&((Aa(g)!=="body"||wr(l))&&(It=p1(g)),Ca(g)?(Gt=gl(g,!0),Gt.x+=g.clientLeft,Gt.y+=g.clientTop):l&&(Gt.x=zr(l))),{x:lt.left+It.scrollLeft-Gt.x,y:lt.top+It.scrollTop-Gt.y,width:lt.width,height:lt.height}}function uN(x){var g=new Map,J=new Set,E=[];x.forEach(function(l){g.set(l.name,l)});function O(l){J.add(l.name);var lt=[].concat(l.requires||[],l.requiresIfExists||[]);lt.forEach(function(It){if(!J.has(It)){var Gt=g.get(It);Gt&&O(Gt)}}),E.push(l)}return x.forEach(function(l){J.has(l.name)||O(l)}),E}function u1(x){var g=uN(x);return o1.reduce(function(J,E){return J.concat(g.filter(function(O){return O.phase===E}))},[])}function Z1(x){var g;return function(){return g||(g=new Promise(function(J){Promise.resolve().then(function(){g=void 0,J(x())})})),g}}function g1(x){var g=x.reduce(function(J,E){var O=J[E.name];return J[E.name]=O?Object.assign({},O,E,{options:Object.assign({},O.options,E.options),data:Object.assign({},O.data,E.data)}):E,J},{});return Object.keys(g).map(function(J){return g[J]})}var jV={placement:"bottom",modifiers:[],strategy:"absolute"};function OV(){for(var x=arguments.length,g=new Array(x),J=0;J<x;J++)g[J]=arguments[J];return!g.some(function(E){return!(E&&typeof E.getBoundingClientRect=="function")})}function Ar(x){x===void 0&&(x={});var g=x,J=g.defaultModifiers,E=J===void 0?[]:J,O=g.defaultOptions,l=O===void 0?jV:O;return function(It,Gt,$t){$t===void 0&&($t=l);var Kt={placement:"bottom",orderedModifiers:[],options:Object.assign({},jV,l),modifiersData:{},elements:{reference:It,popper:Gt},attributes:{},styles:{}},Ve=[],re=!1,le={state:Kt,setOptions:function(bi){var Xe=typeof bi=="function"?bi(Kt.options):bi;Ze(),Kt.options=Object.assign({},l,Kt.options,Xe),Kt.scrollParents={reference:Zl(It)?Ts(It):It.contextElement?Ts(It.contextElement):[],popper:Ts(Gt)};var vi=u1(g1([].concat(E,Kt.options.modifiers)));return Kt.orderedModifiers=vi.filter(function(we){return we.enabled}),je(),le.update()},forceUpdate:function(){if(!re){var bi=Kt.elements,Xe=bi.reference,vi=bi.popper;if(OV(Xe,vi)){Kt.rects={reference:W1(Xe,wl(vi),Kt.options.strategy==="fixed"),popper:fr(vi)},Kt.reset=!1,Kt.placement=Kt.options.placement,Kt.orderedModifiers.forEach(function(wi){return Kt.modifiersData[wi.name]=Object.assign({},wi.data)});for(var we=0;we<Kt.orderedModifiers.length;we++){if(Kt.reset===!0){Kt.reset=!1,we=-1;continue}var We=Kt.orderedModifiers[we],_e=We.fn,Zi=We.options,Re=Zi===void 0?{}:Zi,Fe=We.name;typeof _e=="function"&&(Kt=_e({state:Kt,options:Re,name:Fe,instance:le})||Kt)}}}},update:Z1(function(){return new Promise(function(ii){le.forceUpdate(),ii(Kt)})}),destroy:function(){Ze(),re=!0}};if(!OV(It,Gt))return le;le.setOptions($t).then(function(ii){!re&&$t.onFirstUpdate&&$t.onFirstUpdate(ii)});function je(){Kt.orderedModifiers.forEach(function(ii){var bi=ii.name,Xe=ii.options,vi=Xe===void 0?{}:Xe,we=ii.effect;if(typeof we=="function"){var We=we({state:Kt,name:bi,instance:le,options:vi}),_e=function(){};Ve.push(We||_e)}})}function Ze(){Ve.forEach(function(ii){return ii()}),Ve=[]}return le}}var DV=Ar();var ZN=[gc,Gc,Zc,Wc],_V=Ar({defaultModifiers:ZN});var gN=[gc,Gc,Zc,Wc,Q0,k0,f0,B0,S0],Xm=Ar({defaultModifiers:gN});var Cs=new Map,V1={set(x,g,J){Cs.has(x)||Cs.set(x,new Map);let E=Cs.get(x);if(!E.has(g)&&E.size!==0){console.error(`Bootstrap doesn't allow more than one instance per element. Bound instance: ${Array.from(E.keys())[0]}.`);return}E.set(g,J)},get(x,g){return Cs.has(x)&&Cs.get(x).get(g)||null},remove(x,g){if(!Cs.has(x))return;let J=Cs.get(x);J.delete(g),J.size===0&&Cs.delete(x)}},VN=1e6,RN=1e3,C1="transitionend",UR=x=>(x&&window.CSS&&window.CSS.escape&&(x=x.replace(/#([^\s"#']+)/g,(g,J)=>`#${CSS.escape(J)}`)),x),GN=x=>x==null?`${x}`:Object.prototype.toString.call(x).match(/\s([a-z]+)/i)[1].toLowerCase(),FN=x=>{do x+=Math.floor(Math.random()*VN);while(document.getElementById(x));return x},IN=x=>{if(!x)return 0;let{transitionDuration:g,transitionDelay:J}=window.getComputedStyle(x),E=Number.parseFloat(g),O=Number.parseFloat(J);return!E&&!O?0:(g=g.split(",")[0],J=J.split(",")[0],(Number.parseFloat(g)+Number.parseFloat(J))*RN)},xR=x=>{x.dispatchEvent(new Event(C1))},Mo=x=>!x||typeof x!="object"?!1:(typeof x.jquery<"u"&&(x=x[0]),typeof x.nodeType<"u"),ks=x=>Mo(x)?x.jquery?x[0]:x:typeof x=="string"&&x.length>0?document.querySelector(UR(x)):null,Xc=x=>{if(!Mo(x)||x.getClientRects().length===0)return!1;let g=getComputedStyle(x).getPropertyValue("visibility")==="visible",J=x.closest("details:not([open])");if(!J)return g;if(J!==x){let E=x.closest("summary");if(E&&E.parentNode!==J||E===null)return!1}return g},Ss=x=>!x||x.nodeType!==Node.ELEMENT_NODE||x.classList.contains("disabled")?!0:typeof x.disabled<"u"?x.disabled:x.hasAttribute("disabled")&&x.getAttribute("disabled")!=="false",NR=x=>{if(!document.documentElement.attachShadow)return null;if(typeof x.getRootNode=="function"){let g=x.getRootNode();return g instanceof ShadowRoot?g:null}return x instanceof ShadowRoot?x:x.parentNode?NR(x.parentNode):null},D0=()=>{},km=x=>{x.offsetHeight},YR=()=>window.jQuery&&!document.body.hasAttribute("data-bs-no-jquery")?window.jQuery:null,R1=[],UN=x=>{document.readyState==="loading"?(R1.length||document.addEventListener("DOMContentLoaded",()=>{for(let g of R1)g()}),R1.push(x)):x()},Rl=()=>document.documentElement.dir==="rtl",Fl=x=>{UN(()=>{let g=YR();if(g){let J=x.NAME,E=g.fn[J];g.fn[J]=x.jQueryInterface,g.fn[J].Constructor=x,g.fn[J].noConflict=()=>(g.fn[J]=E,x.jQueryInterface)}})},Sn=(x,g=[],J=x)=>typeof x=="function"?x(...g):J,JR=(x,g,J=!0)=>{if(!J){Sn(x);return}let O=IN(g)+5,l=!1,lt=({target:It})=>{It===g&&(l=!0,g.removeEventListener(C1,lt),Sn(x))};g.addEventListener(C1,lt),setTimeout(()=>{l||xR(g)},O)},v1=(x,g,J,E)=>{let O=x.length,l=x.indexOf(g);return l===-1?!J&&E?x[O-1]:x[0]:(l+=J?1:-1,E&&(l=(l+O)%O),x[Math.max(0,Math.min(l,O-1))])},xN=/[^.]*(?=\..*)\.|.*/,NN=/\..*/,YN=/::\d+$/,G1={},PV=1,XR={mouseenter:"mouseover",mouseleave:"mouseout"},JN=new Set(["click","dblclick","mouseup","mousedown","contextmenu","mousewheel","DOMMouseScroll","mouseover","mouseout","mousemove","selectstart","selectend","keydown","keypress","keyup","orientationchange","touchstart","touchmove","touchend","touchcancel","pointerdown","pointermove","pointerup","pointerleave","pointercancel","gesturestart","gesturechange","gestureend","focus","blur","change","reset","select","submit","focusin","focusout","load","unload","beforeunload","resize","move","DOMContentLoaded","readystatechange","error","abort","scroll"]);function yR(x,g){return g&&`${g}::${PV++}`||x.uidEvent||PV++}function BR(x){let g=yR(x);return x.uidEvent=g,G1[g]=G1[g]||{},G1[g]}function XN(x,g){return function J(E){return E1(E,{delegateTarget:x}),J.oneOff&&ue.off(x,E.type,g),g.apply(x,[E])}}function yN(x,g,J){return function E(O){let l=x.querySelectorAll(g);for(let{target:lt}=O;lt&&lt!==this;lt=lt.parentNode)for(let It of l)if(It===lt)return E1(O,{delegateTarget:lt}),E.oneOff&&ue.off(x,O.type,g,J),J.apply(lt,[O])}}function MR(x,g,J=null){return Object.values(x).find(E=>E.callable===g&&E.delegationSelector===J)}function TR(x,g,J){let E=typeof g=="string",O=E?J:g||J,l=CR(x);return JN.has(l)||(l=x),[E,O,l]}function KV(x,g,J,E,O){if(typeof g!="string"||!x)return;let[l,lt,It]=TR(g,J,E);g in XR&&(lt=(je=>function(Ze){if(!Ze.relatedTarget||Ze.relatedTarget!==Ze.delegateTarget&&!Ze.delegateTarget.contains(Ze.relatedTarget))return je.call(this,Ze)})(lt));let Gt=BR(x),$t=Gt[It]||(Gt[It]={}),Kt=MR($t,lt,l?J:null);if(Kt){Kt.oneOff=Kt.oneOff&&O;return}let Ve=yR(lt,g.replace(xN,"")),re=l?yN(x,J,lt):XN(x,lt);re.delegationSelector=l?J:null,re.callable=lt,re.oneOff=O,re.uidEvent=Ve,$t[Ve]=re,x.addEventListener(It,re,l)}function k1(x,g,J,E,O){let l=MR(g[J],E,O);l&&(x.removeEventListener(J,l,!!O),delete g[J][l.uidEvent])}function BN(x,g,J,E){let O=g[J]||{};for(let[l,lt]of Object.entries(O))l.includes(E)&&k1(x,g,J,lt.callable,lt.delegationSelector)}function CR(x){return x=x.replace(NN,""),XR[x]||x}var ue={on(x,g,J,E){KV(x,g,J,E,!1)},one(x,g,J,E){KV(x,g,J,E,!0)},off(x,g,J,E){if(typeof g!="string"||!x)return;let[O,l,lt]=TR(g,J,E),It=lt!==g,Gt=BR(x),$t=Gt[lt]||{},Kt=g.startsWith(".");if(typeof l<"u"){if(!Object.keys($t).length)return;k1(x,Gt,lt,l,O?J:null);return}if(Kt)for(let Ve of Object.keys(Gt))BN(x,Gt,Ve,g.slice(1));for(let[Ve,re]of Object.entries($t)){let le=Ve.replace(YN,"");(!It||g.includes(le))&&k1(x,Gt,lt,re.callable,re.delegationSelector)}},trigger(x,g,J){if(typeof g!="string"||!x)return null;let E=YR(),O=CR(g),l=g!==O,lt=null,It=!0,Gt=!0,$t=!1;l&&E&&(lt=E.Event(g,J),E(x).trigger(lt),It=!lt.isPropagationStopped(),Gt=!lt.isImmediatePropagationStopped(),$t=lt.isDefaultPrevented());let Kt=E1(new Event(g,{bubbles:It,cancelable:!0}),J);return $t&&Kt.preventDefault(),Gt&&x.dispatchEvent(Kt),Kt.defaultPrevented&&lt&&lt.preventDefault(),Kt}};function E1(x,g={}){for(let[J,E]of Object.entries(g))try{x[J]=E}catch{Object.defineProperty(x,J,{configurable:!0,get(){return E}})}return x}function qV(x){if(x==="true")return!0;if(x==="false")return!1;if(x===Number(x).toString())return Number(x);if(x===""||x==="null")return null;if(typeof x!="string")return x;try{return JSON.parse(decodeURIComponent(x))}catch{return x}}function F1(x){return x.replace(/[A-Z]/g,g=>`-${g.toLowerCase()}`)}var To={setDataAttribute(x,g,J){x.setAttribute(`data-bs-${F1(g)}`,J)},removeDataAttribute(x,g){x.removeAttribute(`data-bs-${F1(g)}`)},getDataAttributes(x){if(!x)return{};let g={},J=Object.keys(x.dataset).filter(E=>E.startsWith("bs")&&!E.startsWith("bsConfig"));for(let E of J){let O=E.replace(/^bs/,"");O=O.charAt(0).toLowerCase()+O.slice(1,O.length),g[O]=qV(x.dataset[E])}return g},getDataAttribute(x,g){return qV(x.getAttribute(`data-bs-${F1(g)}`))}},Or=class{static get Default(){return{}}static get DefaultType(){return{}}static get NAME(){throw new Error('You have to implement the static method "NAME", for each component!')}_getConfig(g){return g=this._mergeConfigObj(g),g=this._configAfterMerge(g),this._typeCheckConfig(g),g}_configAfterMerge(g){return g}_mergeConfigObj(g,J){let E=Mo(J)?To.getDataAttribute(J,"config"):{};return{...this.constructor.Default,...typeof E=="object"?E:{},...Mo(J)?To.getDataAttributes(J):{},...typeof g=="object"?g:{}}}_typeCheckConfig(g,J=this.constructor.DefaultType){for(let[E,O]of Object.entries(J)){let l=g[E],lt=Mo(l)?"element":GN(l);if(!new RegExp(O).test(lt))throw new TypeError(`${this.constructor.NAME.toUpperCase()}: Option "${E}" provided type "${lt}" but expected type "${O}".`)}}},MN="5.3.3",tl=class extends Or{constructor(g,J){super(),g=ks(g),g&&(this._element=g,this._config=this._getConfig(J),V1.set(this._element,this.constructor.DATA_KEY,this))}dispose(){V1.remove(this._element,this.constructor.DATA_KEY),ue.off(this._element,this.constructor.EVENT_KEY);for(let g of Object.getOwnPropertyNames(this))this[g]=null}_queueCallback(g,J,E=!0){JR(g,J,E)}_getConfig(g){return g=this._mergeConfigObj(g,this._element),g=this._configAfterMerge(g),this._typeCheckConfig(g),g}static getInstance(g){return V1.get(ks(g),this.DATA_KEY)}static getOrCreateInstance(g,J={}){return this.getInstance(g)||new this(g,typeof J=="object"?J:null)}static get VERSION(){return MN}static get DATA_KEY(){return`bs.${this.NAME}`}static get EVENT_KEY(){return`.${this.DATA_KEY}`}static eventName(g){return`${g}${this.EVENT_KEY}`}},I1=x=>{let g=x.getAttribute("data-bs-target");if(!g||g==="#"){let J=x.getAttribute("href");if(!J||!J.includes("#")&&!J.startsWith("."))return null;J.includes("#")&&!J.startsWith("#")&&(J=`#${J.split("#")[1]}`),g=J&&J!=="#"?J.trim():null}return g?g.split(",").map(J=>UR(J)).join(","):null},li={find(x,g=document.documentElement){return[].concat(...Element.prototype.querySelectorAll.call(g,x))},findOne(x,g=document.documentElement){return Element.prototype.querySelector.call(g,x)},children(x,g){return[].concat(...x.children).filter(J=>J.matches(g))},parents(x,g){let J=[],E=x.parentNode.closest(g);for(;E;)J.push(E),E=E.parentNode.closest(g);return J},prev(x,g){let J=x.previousElementSibling;for(;J;){if(J.matches(g))return[J];J=J.previousElementSibling}return[]},next(x,g){let J=x.nextElementSibling;for(;J;){if(J.matches(g))return[J];J=J.nextElementSibling}return[]},focusableChildren(x){let g=["a","button","input","textarea","select","details","[tabindex]",'[contenteditable="true"]'].map(J=>`${J}:not([tabindex^="-"])`).join(",");return this.find(g,x).filter(J=>!Ss(J)&&Xc(J))},getSelectorFromElement(x){let g=I1(x);return g&&li.findOne(g)?g:null},getElementFromSelector(x){let g=I1(x);return g?li.findOne(g):null},getMultipleElementsFromSelector(x){let g=I1(x);return g?li.find(g):[]}},np=(x,g="hide")=>{let J=`click.dismiss${x.EVENT_KEY}`,E=x.NAME;ue.on(document,J,`[data-bs-dismiss="${E}"]`,function(O){if(["A","AREA"].includes(this.tagName)&&O.preventDefault(),Ss(this))return;let l=li.getElementFromSelector(this)||this.closest(`.${E}`);x.getOrCreateInstance(l)[g]()})},TN="alert",CN="bs.alert",kR=`.${CN}`,kN=`close${kR}`,SN=`closed${kR}`,QN="fade",fN="show",_0=class x extends tl{static get NAME(){return TN}close(){if(ue.trigger(this._element,kN).defaultPrevented)return;this._element.classList.remove(fN);let J=this._element.classList.contains(QN);this._queueCallback(()=>this._destroyElement(),this._element,J)}_destroyElement(){this._element.remove(),ue.trigger(this._element,SN),this.dispose()}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this);if(typeof g=="string"){if(J[g]===void 0||g.startsWith("_")||g==="constructor")throw new TypeError(`No method named "${g}"`);J[g](this)}})}};np(_0,"close");Fl(_0);var vN="button",EN="bs.button",LN=`.${EN}`,zN=".data-api",wN="active",$V='[data-bs-toggle="button"]',AN=`click${LN}${zN}`,P0=class x extends tl{static get NAME(){return vN}toggle(){this._element.setAttribute("aria-pressed",this._element.classList.toggle(wN))}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this);g==="toggle"&&J[g]()})}};ue.on(document,AN,$V,x=>{x.preventDefault();let g=x.target.closest($V);P0.getOrCreateInstance(g).toggle()});Fl(P0);var HN="swipe",yc=".bs.swipe",jN=`touchstart${yc}`,ON=`touchmove${yc}`,DN=`touchend${yc}`,_N=`pointerdown${yc}`,PN=`pointerup${yc}`,KN="touch",qN="pen",$N="pointer-event",tY=40,eY={endCallback:null,leftCallback:null,rightCallback:null},iY={endCallback:"(function|null)",leftCallback:"(function|null)",rightCallback:"(function|null)"},K0=class x extends Or{constructor(g,J){super(),this._element=g,!(!g||!x.isSupported())&&(this._config=this._getConfig(J),this._deltaX=0,this._supportPointerEvents=!!window.PointerEvent,this._initEvents())}static get Default(){return eY}static get DefaultType(){return iY}static get NAME(){return HN}dispose(){ue.off(this._element,yc)}_start(g){if(!this._supportPointerEvents){this._deltaX=g.touches[0].clientX;return}this._eventIsPointerPenTouch(g)&&(this._deltaX=g.clientX)}_end(g){this._eventIsPointerPenTouch(g)&&(this._deltaX=g.clientX-this._deltaX),this._handleSwipe(),Sn(this._config.endCallback)}_move(g){this._deltaX=g.touches&&g.touches.length>1?0:g.touches[0].clientX-this._deltaX}_handleSwipe(){let g=Math.abs(this._deltaX);if(g<=tY)return;let J=g/this._deltaX;this._deltaX=0,J&&Sn(J>0?this._config.rightCallback:this._config.leftCallback)}_initEvents(){this._supportPointerEvents?(ue.on(this._element,_N,g=>this._start(g)),ue.on(this._element,PN,g=>this._end(g)),this._element.classList.add($N)):(ue.on(this._element,jN,g=>this._start(g)),ue.on(this._element,ON,g=>this._move(g)),ue.on(this._element,DN,g=>this._end(g)))}_eventIsPointerPenTouch(g){return this._supportPointerEvents&&(g.pointerType===qN||g.pointerType===KN)}static isSupported(){return"ontouchstart"in document.documentElement||navigator.maxTouchPoints>0}},aY="carousel",nY="bs.carousel",vs=`.${nY}`,SR=".data-api",lY="ArrowLeft",oY="ArrowRight",sY=500,ym="next",Fc="prev",Uc="left",j0="right",rY=`slide${vs}`,U1=`slid${vs}`,dY=`keydown${vs}`,cY=`mouseenter${vs}`,bY=`mouseleave${vs}`,mY=`dragstart${vs}`,hY=`load${vs}${SR}`,pY=`click${vs}${SR}`,QR="carousel",E0="active",WY="slide",uY="carousel-item-end",ZY="carousel-item-start",gY="carousel-item-next",VY="carousel-item-prev",fR=".active",vR=".carousel-item",RY=fR+vR,GY=".carousel-item img",FY=".carousel-indicators",IY="[data-bs-slide], [data-bs-slide-to]",UY='[data-bs-ride="carousel"]',xY={[lY]:j0,[oY]:Uc},NY={interval:5e3,keyboard:!0,pause:"hover",ride:!1,touch:!0,wrap:!0},YY={interval:"(number|boolean)",keyboard:"boolean",pause:"(string|boolean)",ride:"(boolean|string)",touch:"boolean",wrap:"boolean"},Mm=class x extends tl{constructor(g,J){super(g,J),this._interval=null,this._activeElement=null,this._isSliding=!1,this.touchTimeout=null,this._swipeHelper=null,this._indicatorsElement=li.findOne(FY,this._element),this._addEventListeners(),this._config.ride===QR&&this.cycle()}static get Default(){return NY}static get DefaultType(){return YY}static get NAME(){return aY}next(){this._slide(ym)}nextWhenVisible(){!document.hidden&&Xc(this._element)&&this.next()}prev(){this._slide(Fc)}pause(){this._isSliding&&xR(this._element),this._clearInterval()}cycle(){this._clearInterval(),this._updateInterval(),this._interval=setInterval(()=>this.nextWhenVisible(),this._config.interval)}_maybeEnableCycle(){if(this._config.ride){if(this._isSliding){ue.one(this._element,U1,()=>this.cycle());return}this.cycle()}}to(g){let J=this._getItems();if(g>J.length-1||g<0)return;if(this._isSliding){ue.one(this._element,U1,()=>this.to(g));return}let E=this._getItemIndex(this._getActive());if(E===g)return;let O=g>E?ym:Fc;this._slide(O,J[g])}dispose(){this._swipeHelper&&this._swipeHelper.dispose(),super.dispose()}_configAfterMerge(g){return g.defaultInterval=g.interval,g}_addEventListeners(){this._config.keyboard&&ue.on(this._element,dY,g=>this._keydown(g)),this._config.pause==="hover"&&(ue.on(this._element,cY,()=>this.pause()),ue.on(this._element,bY,()=>this._maybeEnableCycle())),this._config.touch&&K0.isSupported()&&this._addTouchEventListeners()}_addTouchEventListeners(){for(let E of li.find(GY,this._element))ue.on(E,mY,O=>O.preventDefault());let J={leftCallback:()=>this._slide(this._directionToOrder(Uc)),rightCallback:()=>this._slide(this._directionToOrder(j0)),endCallback:()=>{this._config.pause==="hover"&&(this.pause(),this.touchTimeout&&clearTimeout(this.touchTimeout),this.touchTimeout=setTimeout(()=>this._maybeEnableCycle(),sY+this._config.interval))}};this._swipeHelper=new K0(this._element,J)}_keydown(g){if(/input|textarea/i.test(g.target.tagName))return;let J=xY[g.key];J&&(g.preventDefault(),this._slide(this._directionToOrder(J)))}_getItemIndex(g){return this._getItems().indexOf(g)}_setActiveIndicatorElement(g){if(!this._indicatorsElement)return;let J=li.findOne(fR,this._indicatorsElement);J.classList.remove(E0),J.removeAttribute("aria-current");let E=li.findOne(`[data-bs-slide-to="${g}"]`,this._indicatorsElement);E&&(E.classList.add(E0),E.setAttribute("aria-current","true"))}_updateInterval(){let g=this._activeElement||this._getActive();if(!g)return;let J=Number.parseInt(g.getAttribute("data-bs-interval"),10);this._config.interval=J||this._config.defaultInterval}_slide(g,J=null){if(this._isSliding)return;let E=this._getActive(),O=g===ym,l=J||v1(this._getItems(),E,O,this._config.wrap);if(l===E)return;let lt=this._getItemIndex(l),It=le=>ue.trigger(this._element,le,{relatedTarget:l,direction:this._orderToDirection(g),from:this._getItemIndex(E),to:lt});if(It(rY).defaultPrevented||!E||!l)return;let $t=!!this._interval;this.pause(),this._isSliding=!0,this._setActiveIndicatorElement(lt),this._activeElement=l;let Kt=O?ZY:uY,Ve=O?gY:VY;l.classList.add(Ve),km(l),E.classList.add(Kt),l.classList.add(Kt);let re=()=>{l.classList.remove(Kt,Ve),l.classList.add(E0),E.classList.remove(E0,Ve,Kt),this._isSliding=!1,It(U1)};this._queueCallback(re,E,this._isAnimated()),$t&&this.cycle()}_isAnimated(){return this._element.classList.contains(WY)}_getActive(){return li.findOne(RY,this._element)}_getItems(){return li.find(vR,this._element)}_clearInterval(){this._interval&&(clearInterval(this._interval),this._interval=null)}_directionToOrder(g){return Rl()?g===Uc?Fc:ym:g===Uc?ym:Fc}_orderToDirection(g){return Rl()?g===Fc?Uc:j0:g===Fc?j0:Uc}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this,g);if(typeof g=="number"){J.to(g);return}if(typeof g=="string"){if(J[g]===void 0||g.startsWith("_")||g==="constructor")throw new TypeError(`No method named "${g}"`);J[g]()}})}};ue.on(document,pY,IY,function(x){let g=li.getElementFromSelector(this);if(!g||!g.classList.contains(QR))return;x.preventDefault();let J=Mm.getOrCreateInstance(g),E=this.getAttribute("data-bs-slide-to");if(E){J.to(E),J._maybeEnableCycle();return}if(To.getDataAttribute(this,"slide")==="next"){J.next(),J._maybeEnableCycle();return}J.prev(),J._maybeEnableCycle()});ue.on(window,hY,()=>{let x=li.find(UY);for(let g of x)Mm.getOrCreateInstance(g)});Fl(Mm);var JY="collapse",XY="bs.collapse",Sm=`.${XY}`,yY=".data-api",BY=`show${Sm}`,MY=`shown${Sm}`,TY=`hide${Sm}`,CY=`hidden${Sm}`,kY=`click${Sm}${yY}`,x1="show",Nc="collapse",L0="collapsing",SY="collapsed",QY=`:scope .${Nc} .${Nc}`,fY="collapse-horizontal",vY="width",EY="height",LY=".collapse.show, .collapse.collapsing",S1='[data-bs-toggle="collapse"]',zY={parent:null,toggle:!0},wY={parent:"(null|element)",toggle:"boolean"},q0=class x extends tl{constructor(g,J){super(g,J),this._isTransitioning=!1,this._triggerArray=[];let E=li.find(S1);for(let O of E){let l=li.getSelectorFromElement(O),lt=li.find(l).filter(It=>It===this._element);l!==null&&lt.length&&this._triggerArray.push(O)}this._initializeChildren(),this._config.parent||this._addAriaAndCollapsedClass(this._triggerArray,this._isShown()),this._config.toggle&&this.toggle()}static get Default(){return zY}static get DefaultType(){return wY}static get NAME(){return JY}toggle(){this._isShown()?this.hide():this.show()}show(){if(this._isTransitioning||this._isShown())return;let g=[];if(this._config.parent&&(g=this._getFirstLevelChildren(LY).filter(It=>It!==this._element).map(It=>x.getOrCreateInstance(It,{toggle:!1}))),g.length&&g[0]._isTransitioning||ue.trigger(this._element,BY).defaultPrevented)return;for(let It of g)It.hide();let E=this._getDimension();this._element.classList.remove(Nc),this._element.classList.add(L0),this._element.style[E]=0,this._addAriaAndCollapsedClass(this._triggerArray,!0),this._isTransitioning=!0;let O=()=>{this._isTransitioning=!1,this._element.classList.remove(L0),this._element.classList.add(Nc,x1),this._element.style[E]="",ue.trigger(this._element,MY)},lt=`scroll${E[0].toUpperCase()+E.slice(1)}`;this._queueCallback(O,this._element,!0),this._element.style[E]=`${this._element[lt]}px`}hide(){if(this._isTransitioning||!this._isShown()||ue.trigger(this._element,TY).defaultPrevented)return;let J=this._getDimension();this._element.style[J]=`${this._element.getBoundingClientRect()[J]}px`,km(this._element),this._element.classList.add(L0),this._element.classList.remove(Nc,x1);for(let O of this._triggerArray){let l=li.getElementFromSelector(O);l&&!this._isShown(l)&&this._addAriaAndCollapsedClass([O],!1)}this._isTransitioning=!0;let E=()=>{this._isTransitioning=!1,this._element.classList.remove(L0),this._element.classList.add(Nc),ue.trigger(this._element,CY)};this._element.style[J]="",this._queueCallback(E,this._element,!0)}_isShown(g=this._element){return g.classList.contains(x1)}_configAfterMerge(g){return g.toggle=!!g.toggle,g.parent=ks(g.parent),g}_getDimension(){return this._element.classList.contains(fY)?vY:EY}_initializeChildren(){if(!this._config.parent)return;let g=this._getFirstLevelChildren(S1);for(let J of g){let E=li.getElementFromSelector(J);E&&this._addAriaAndCollapsedClass([J],this._isShown(E))}}_getFirstLevelChildren(g){let J=li.find(QY,this._config.parent);return li.find(g,this._config.parent).filter(E=>!J.includes(E))}_addAriaAndCollapsedClass(g,J){if(g.length)for(let E of g)E.classList.toggle(SY,!J),E.setAttribute("aria-expanded",J)}static jQueryInterface(g){let J={};return typeof g=="string"&&/show|hide/.test(g)&&(J.toggle=!1),this.each(function(){let E=x.getOrCreateInstance(this,J);if(typeof g=="string"){if(typeof E[g]>"u")throw new TypeError(`No method named "${g}"`);E[g]()}})}};ue.on(document,kY,S1,function(x){(x.target.tagName==="A"||x.delegateTarget&&x.delegateTarget.tagName==="A")&&x.preventDefault();for(let g of li.getMultipleElementsFromSelector(this))q0.getOrCreateInstance(g,{toggle:!1}).toggle()});Fl(q0);var tR="dropdown",AY="bs.dropdown",Dr=`.${AY}`,L1=".data-api",HY="Escape",eR="Tab",jY="ArrowUp",iR="ArrowDown",OY=2,DY=`hide${Dr}`,_Y=`hidden${Dr}`,PY=`show${Dr}`,KY=`shown${Dr}`,ER=`click${Dr}${L1}`,LR=`keydown${Dr}${L1}`,qY=`keyup${Dr}${L1}`,xc="show",$Y="dropup",tJ="dropend",eJ="dropstart",iJ="dropup-center",aJ="dropdown-center",Hr='[data-bs-toggle="dropdown"]:not(.disabled):not(:disabled)',nJ=`${Hr}.${xc}`,O0=".dropdown-menu",lJ=".navbar",oJ=".navbar-nav",sJ=".dropdown-menu .dropdown-item:not(.disabled):not(:disabled)",rJ=Rl()?"top-end":"top-start",dJ=Rl()?"top-start":"top-end",cJ=Rl()?"bottom-end":"bottom-start",bJ=Rl()?"bottom-start":"bottom-end",mJ=Rl()?"left-start":"right-start",hJ=Rl()?"right-start":"left-start",pJ="top",WJ="bottom",uJ={autoClose:!0,boundary:"clippingParents",display:"dynamic",offset:[0,2],popperConfig:null,reference:"toggle"},ZJ={autoClose:"(boolean|string)",boundary:"(string|element)",display:"string",offset:"(array|string|function)",popperConfig:"(null|object|function)",reference:"(string|element|object)"},Qs=class x extends tl{constructor(g,J){super(g,J),this._popper=null,this._parent=this._element.parentNode,this._menu=li.next(this._element,O0)[0]||li.prev(this._element,O0)[0]||li.findOne(O0,this._parent),this._inNavbar=this._detectNavbar()}static get Default(){return uJ}static get DefaultType(){return ZJ}static get NAME(){return tR}toggle(){return this._isShown()?this.hide():this.show()}show(){if(Ss(this._element)||this._isShown())return;let g={relatedTarget:this._element};if(!ue.trigger(this._element,PY,g).defaultPrevented){if(this._createPopper(),"ontouchstart"in document.documentElement&&!this._parent.closest(oJ))for(let E of[].concat(...document.body.children))ue.on(E,"mouseover",D0);this._element.focus(),this._element.setAttribute("aria-expanded",!0),this._menu.classList.add(xc),this._element.classList.add(xc),ue.trigger(this._element,KY,g)}}hide(){if(Ss(this._element)||!this._isShown())return;let g={relatedTarget:this._element};this._completeHide(g)}dispose(){this._popper&&this._popper.destroy(),super.dispose()}update(){this._inNavbar=this._detectNavbar(),this._popper&&this._popper.update()}_completeHide(g){if(!ue.trigger(this._element,DY,g).defaultPrevented){if("ontouchstart"in document.documentElement)for(let E of[].concat(...document.body.children))ue.off(E,"mouseover",D0);this._popper&&this._popper.destroy(),this._menu.classList.remove(xc),this._element.classList.remove(xc),this._element.setAttribute("aria-expanded","false"),To.removeDataAttribute(this._menu,"popper"),ue.trigger(this._element,_Y,g)}}_getConfig(g){if(g=super._getConfig(g),typeof g.reference=="object"&&!Mo(g.reference)&&typeof g.reference.getBoundingClientRect!="function")throw new TypeError(`${tR.toUpperCase()}: Option "reference" provided type "object" without a required "getBoundingClientRect" method.`);return g}_createPopper(){if(typeof v0>"u")throw new TypeError("Bootstrap's dropdowns require Popper (https://popper.js.org)");let g=this._element;this._config.reference==="parent"?g=this._parent:Mo(this._config.reference)?g=ks(this._config.reference):typeof this._config.reference=="object"&&(g=this._config.reference);let J=this._getPopperConfig();this._popper=Xm(g,this._menu,J)}_isShown(){return this._menu.classList.contains(xc)}_getPlacement(){let g=this._parent;if(g.classList.contains(tJ))return mJ;if(g.classList.contains(eJ))return hJ;if(g.classList.contains(iJ))return pJ;if(g.classList.contains(aJ))return WJ;let J=getComputedStyle(this._menu).getPropertyValue("--bs-position").trim()==="end";return g.classList.contains($Y)?J?dJ:rJ:J?bJ:cJ}_detectNavbar(){return this._element.closest(lJ)!==null}_getOffset(){let{offset:g}=this._config;return typeof g=="string"?g.split(",").map(J=>Number.parseInt(J,10)):typeof g=="function"?J=>g(J,this._element):g}_getPopperConfig(){let g={placement:this._getPlacement(),modifiers:[{name:"preventOverflow",options:{boundary:this._config.boundary}},{name:"offset",options:{offset:this._getOffset()}}]};return(this._inNavbar||this._config.display==="static")&&(To.setDataAttribute(this._menu,"popper","static"),g.modifiers=[{name:"applyStyles",enabled:!1}]),{...g,...Sn(this._config.popperConfig,[g])}}_selectMenuItem({key:g,target:J}){let E=li.find(sJ,this._menu).filter(O=>Xc(O));E.length&&v1(E,J,g===iR,!E.includes(J)).focus()}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this,g);if(typeof g=="string"){if(typeof J[g]>"u")throw new TypeError(`No method named "${g}"`);J[g]()}})}static clearMenus(g){if(g.button===OY||g.type==="keyup"&&g.key!==eR)return;let J=li.find(nJ);for(let E of J){let O=x.getInstance(E);if(!O||O._config.autoClose===!1)continue;let l=g.composedPath(),lt=l.includes(O._menu);if(l.includes(O._element)||O._config.autoClose==="inside"&&!lt||O._config.autoClose==="outside"&&lt||O._menu.contains(g.target)&&(g.type==="keyup"&&g.key===eR||/input|select|option|textarea|form/i.test(g.target.tagName)))continue;let It={relatedTarget:O._element};g.type==="click"&&(It.clickEvent=g),O._completeHide(It)}}static dataApiKeydownHandler(g){let J=/input|textarea/i.test(g.target.tagName),E=g.key===HY,O=[jY,iR].includes(g.key);if(!O&&!E||J&&!E)return;g.preventDefault();let l=this.matches(Hr)?this:li.prev(this,Hr)[0]||li.next(this,Hr)[0]||li.findOne(Hr,g.delegateTarget.parentNode),lt=x.getOrCreateInstance(l);if(O){g.stopPropagation(),lt.show(),lt._selectMenuItem(g);return}lt._isShown()&&(g.stopPropagation(),lt.hide(),l.focus())}};ue.on(document,LR,Hr,Qs.dataApiKeydownHandler);ue.on(document,LR,O0,Qs.dataApiKeydownHandler);ue.on(document,ER,Qs.clearMenus);ue.on(document,qY,Qs.clearMenus);ue.on(document,ER,Hr,function(x){x.preventDefault(),Qs.getOrCreateInstance(this).toggle()});Fl(Qs);var zR="backdrop",gJ="fade",aR="show",nR=`mousedown.bs.${zR}`,VJ={className:"modal-backdrop",clickCallback:null,isAnimated:!1,isVisible:!0,rootElement:"body"},RJ={className:"string",clickCallback:"(function|null)",isAnimated:"boolean",isVisible:"boolean",rootElement:"(element|string)"},$0=class extends Or{constructor(g){super(),this._config=this._getConfig(g),this._isAppended=!1,this._element=null}static get Default(){return VJ}static get DefaultType(){return RJ}static get NAME(){return zR}show(g){if(!this._config.isVisible){Sn(g);return}this._append();let J=this._getElement();this._config.isAnimated&&km(J),J.classList.add(aR),this._emulateAnimation(()=>{Sn(g)})}hide(g){if(!this._config.isVisible){Sn(g);return}this._getElement().classList.remove(aR),this._emulateAnimation(()=>{this.dispose(),Sn(g)})}dispose(){this._isAppended&&(ue.off(this._element,nR),this._element.remove(),this._isAppended=!1)}_getElement(){if(!this._element){let g=document.createElement("div");g.className=this._config.className,this._config.isAnimated&&g.classList.add(gJ),this._element=g}return this._element}_configAfterMerge(g){return g.rootElement=ks(g.rootElement),g}_append(){if(this._isAppended)return;let g=this._getElement();this._config.rootElement.append(g),ue.on(g,nR,()=>{Sn(this._config.clickCallback)}),this._isAppended=!0}_emulateAnimation(g){JR(g,this._getElement(),this._config.isAnimated)}},GJ="focustrap",FJ="bs.focustrap",tp=`.${FJ}`,IJ=`focusin${tp}`,UJ=`keydown.tab${tp}`,xJ="Tab",NJ="forward",lR="backward",YJ={autofocus:!0,trapElement:null},JJ={autofocus:"boolean",trapElement:"element"},ep=class extends Or{constructor(g){super(),this._config=this._getConfig(g),this._isActive=!1,this._lastTabNavDirection=null}static get Default(){return YJ}static get DefaultType(){return JJ}static get NAME(){return GJ}activate(){this._isActive||(this._config.autofocus&&this._config.trapElement.focus(),ue.off(document,tp),ue.on(document,IJ,g=>this._handleFocusin(g)),ue.on(document,UJ,g=>this._handleKeydown(g)),this._isActive=!0)}deactivate(){this._isActive&&(this._isActive=!1,ue.off(document,tp))}_handleFocusin(g){let{trapElement:J}=this._config;if(g.target===document||g.target===J||J.contains(g.target))return;let E=li.focusableChildren(J);E.length===0?J.focus():this._lastTabNavDirection===lR?E[E.length-1].focus():E[0].focus()}_handleKeydown(g){g.key===xJ&&(this._lastTabNavDirection=g.shiftKey?lR:NJ)}},oR=".fixed-top, .fixed-bottom, .is-fixed, .sticky-top",sR=".sticky-top",z0="padding-right",rR="margin-right",Tm=class{constructor(){this._element=document.body}getWidth(){let g=document.documentElement.clientWidth;return Math.abs(window.innerWidth-g)}hide(){let g=this.getWidth();this._disableOverFlow(),this._setElementAttributes(this._element,z0,J=>J+g),this._setElementAttributes(oR,z0,J=>J+g),this._setElementAttributes(sR,rR,J=>J-g)}reset(){this._resetElementAttributes(this._element,"overflow"),this._resetElementAttributes(this._element,z0),this._resetElementAttributes(oR,z0),this._resetElementAttributes(sR,rR)}isOverflowing(){return this.getWidth()>0}_disableOverFlow(){this._saveInitialAttribute(this._element,"overflow"),this._element.style.overflow="hidden"}_setElementAttributes(g,J,E){let O=this.getWidth(),l=lt=>{if(lt!==this._element&&window.innerWidth>lt.clientWidth+O)return;this._saveInitialAttribute(lt,J);let It=window.getComputedStyle(lt).getPropertyValue(J);lt.style.setProperty(J,`${E(Number.parseFloat(It))}px`)};this._applyManipulationCallback(g,l)}_saveInitialAttribute(g,J){let E=g.style.getPropertyValue(J);E&&To.setDataAttribute(g,J,E)}_resetElementAttributes(g,J){let E=O=>{let l=To.getDataAttribute(O,J);if(l===null){O.style.removeProperty(J);return}To.removeDataAttribute(O,J),O.style.setProperty(J,l)};this._applyManipulationCallback(g,E)}_applyManipulationCallback(g,J){if(Mo(g)){J(g);return}for(let E of li.find(g,this._element))J(E)}},XJ="modal",yJ="bs.modal",Gl=`.${yJ}`,BJ=".data-api",MJ="Escape",TJ=`hide${Gl}`,CJ=`hidePrevented${Gl}`,wR=`hidden${Gl}`,AR=`show${Gl}`,kJ=`shown${Gl}`,SJ=`resize${Gl}`,QJ=`click.dismiss${Gl}`,fJ=`mousedown.dismiss${Gl}`,vJ=`keydown.dismiss${Gl}`,EJ=`click${Gl}${BJ}`,dR="modal-open",LJ="fade",cR="show",N1="modal-static",zJ=".modal.show",wJ=".modal-dialog",AJ=".modal-body",HJ='[data-bs-toggle="modal"]',jJ={backdrop:!0,focus:!0,keyboard:!0},OJ={backdrop:"(boolean|string)",focus:"boolean",keyboard:"boolean"},Yc=class x extends tl{constructor(g,J){super(g,J),this._dialog=li.findOne(wJ,this._element),this._backdrop=this._initializeBackDrop(),this._focustrap=this._initializeFocusTrap(),this._isShown=!1,this._isTransitioning=!1,this._scrollBar=new Tm,this._addEventListeners()}static get Default(){return jJ}static get DefaultType(){return OJ}static get NAME(){return XJ}toggle(g){return this._isShown?this.hide():this.show(g)}show(g){this._isShown||this._isTransitioning||ue.trigger(this._element,AR,{relatedTarget:g}).defaultPrevented||(this._isShown=!0,this._isTransitioning=!0,this._scrollBar.hide(),document.body.classList.add(dR),this._adjustDialog(),this._backdrop.show(()=>this._showElement(g)))}hide(){!this._isShown||this._isTransitioning||ue.trigger(this._element,TJ).defaultPrevented||(this._isShown=!1,this._isTransitioning=!0,this._focustrap.deactivate(),this._element.classList.remove(cR),this._queueCallback(()=>this._hideModal(),this._element,this._isAnimated()))}dispose(){ue.off(window,Gl),ue.off(this._dialog,Gl),this._backdrop.dispose(),this._focustrap.deactivate(),super.dispose()}handleUpdate(){this._adjustDialog()}_initializeBackDrop(){return new $0({isVisible:!!this._config.backdrop,isAnimated:this._isAnimated()})}_initializeFocusTrap(){return new ep({trapElement:this._element})}_showElement(g){document.body.contains(this._element)||document.body.append(this._element),this._element.style.display="block",this._element.removeAttribute("aria-hidden"),this._element.setAttribute("aria-modal",!0),this._element.setAttribute("role","dialog"),this._element.scrollTop=0;let J=li.findOne(AJ,this._dialog);J&&(J.scrollTop=0),km(this._element),this._element.classList.add(cR);let E=()=>{this._config.focus&&this._focustrap.activate(),this._isTransitioning=!1,ue.trigger(this._element,kJ,{relatedTarget:g})};this._queueCallback(E,this._dialog,this._isAnimated())}_addEventListeners(){ue.on(this._element,vJ,g=>{if(g.key===MJ){if(this._config.keyboard){this.hide();return}this._triggerBackdropTransition()}}),ue.on(window,SJ,()=>{this._isShown&&!this._isTransitioning&&this._adjustDialog()}),ue.on(this._element,fJ,g=>{ue.one(this._element,QJ,J=>{if(!(this._element!==g.target||this._element!==J.target)){if(this._config.backdrop==="static"){this._triggerBackdropTransition();return}this._config.backdrop&&this.hide()}})})}_hideModal(){this._element.style.display="none",this._element.setAttribute("aria-hidden",!0),this._element.removeAttribute("aria-modal"),this._element.removeAttribute("role"),this._isTransitioning=!1,this._backdrop.hide(()=>{document.body.classList.remove(dR),this._resetAdjustments(),this._scrollBar.reset(),ue.trigger(this._element,wR)})}_isAnimated(){return this._element.classList.contains(LJ)}_triggerBackdropTransition(){if(ue.trigger(this._element,CJ).defaultPrevented)return;let J=this._element.scrollHeight>document.documentElement.clientHeight,E=this._element.style.overflowY;E==="hidden"||this._element.classList.contains(N1)||(J||(this._element.style.overflowY="hidden"),this._element.classList.add(N1),this._queueCallback(()=>{this._element.classList.remove(N1),this._queueCallback(()=>{this._element.style.overflowY=E},this._dialog)},this._dialog),this._element.focus())}_adjustDialog(){let g=this._element.scrollHeight>document.documentElement.clientHeight,J=this._scrollBar.getWidth(),E=J>0;if(E&&!g){let O=Rl()?"paddingLeft":"paddingRight";this._element.style[O]=`${J}px`}if(!E&&g){let O=Rl()?"paddingRight":"paddingLeft";this._element.style[O]=`${J}px`}}_resetAdjustments(){this._element.style.paddingLeft="",this._element.style.paddingRight=""}static jQueryInterface(g,J){return this.each(function(){let E=x.getOrCreateInstance(this,g);if(typeof g=="string"){if(typeof E[g]>"u")throw new TypeError(`No method named "${g}"`);E[g](J)}})}};ue.on(document,EJ,HJ,function(x){let g=li.getElementFromSelector(this);["A","AREA"].includes(this.tagName)&&x.preventDefault(),ue.one(g,AR,O=>{O.defaultPrevented||ue.one(g,wR,()=>{Xc(this)&&this.focus()})});let J=li.findOne(zJ);J&&Yc.getInstance(J).hide(),Yc.getOrCreateInstance(g).toggle(this)});np(Yc);Fl(Yc);var DJ="offcanvas",_J="bs.offcanvas",Co=`.${_J}`,HR=".data-api",PJ=`load${Co}${HR}`,KJ="Escape",bR="show",mR="showing",hR="hiding",qJ="offcanvas-backdrop",jR=".offcanvas.show",$J=`show${Co}`,tX=`shown${Co}`,eX=`hide${Co}`,pR=`hidePrevented${Co}`,OR=`hidden${Co}`,iX=`resize${Co}`,aX=`click${Co}${HR}`,nX=`keydown.dismiss${Co}`,lX='[data-bs-toggle="offcanvas"]',oX={backdrop:!0,keyboard:!0,scroll:!1},sX={backdrop:"(boolean|string)",keyboard:"boolean",scroll:"boolean"},fs=class x extends tl{constructor(g,J){super(g,J),this._isShown=!1,this._backdrop=this._initializeBackDrop(),this._focustrap=this._initializeFocusTrap(),this._addEventListeners()}static get Default(){return oX}static get DefaultType(){return sX}static get NAME(){return DJ}toggle(g){return this._isShown?this.hide():this.show(g)}show(g){if(this._isShown||ue.trigger(this._element,$J,{relatedTarget:g}).defaultPrevented)return;this._isShown=!0,this._backdrop.show(),this._config.scroll||new Tm().hide(),this._element.setAttribute("aria-modal",!0),this._element.setAttribute("role","dialog"),this._element.classList.add(mR);let E=()=>{(!this._config.scroll||this._config.backdrop)&&this._focustrap.activate(),this._element.classList.add(bR),this._element.classList.remove(mR),ue.trigger(this._element,tX,{relatedTarget:g})};this._queueCallback(E,this._element,!0)}hide(){if(!this._isShown||ue.trigger(this._element,eX).defaultPrevented)return;this._focustrap.deactivate(),this._element.blur(),this._isShown=!1,this._element.classList.add(hR),this._backdrop.hide();let J=()=>{this._element.classList.remove(bR,hR),this._element.removeAttribute("aria-modal"),this._element.removeAttribute("role"),this._config.scroll||new Tm().reset(),ue.trigger(this._element,OR)};this._queueCallback(J,this._element,!0)}dispose(){this._backdrop.dispose(),this._focustrap.deactivate(),super.dispose()}_initializeBackDrop(){let g=()=>{if(this._config.backdrop==="static"){ue.trigger(this._element,pR);return}this.hide()},J=!!this._config.backdrop;return new $0({className:qJ,isVisible:J,isAnimated:!0,rootElement:this._element.parentNode,clickCallback:J?g:null})}_initializeFocusTrap(){return new ep({trapElement:this._element})}_addEventListeners(){ue.on(this._element,nX,g=>{if(g.key===KJ){if(this._config.keyboard){this.hide();return}ue.trigger(this._element,pR)}})}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this,g);if(typeof g=="string"){if(J[g]===void 0||g.startsWith("_")||g==="constructor")throw new TypeError(`No method named "${g}"`);J[g](this)}})}};ue.on(document,aX,lX,function(x){let g=li.getElementFromSelector(this);if(["A","AREA"].includes(this.tagName)&&x.preventDefault(),Ss(this))return;ue.one(g,OR,()=>{Xc(this)&&this.focus()});let J=li.findOne(jR);J&&J!==g&&fs.getInstance(J).hide(),fs.getOrCreateInstance(g).toggle(this)});ue.on(window,PJ,()=>{for(let x of li.find(jR))fs.getOrCreateInstance(x).show()});ue.on(window,iX,()=>{for(let x of li.find("[aria-modal][class*=show][class*=offcanvas-]"))getComputedStyle(x).position!=="fixed"&&fs.getOrCreateInstance(x).hide()});np(fs);Fl(fs);var rX=/^aria-[\w-]*$/i,DR={"*":["class","dir","id","lang","role",rX],a:["target","href","title","rel"],area:[],b:[],br:[],col:[],code:[],dd:[],div:[],dl:[],dt:[],em:[],hr:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],i:[],img:["src","srcset","alt","title","width","height"],li:[],ol:[],p:[],pre:[],s:[],small:[],span:[],sub:[],sup:[],strong:[],u:[],ul:[]},dX=new Set(["background","cite","href","itemtype","longdesc","poster","src","xlink:href"]),cX=/^(?!javascript:)(?:[a-z0-9+.-]+:|[^&:/?#]*(?:[/?#]|$))/i,bX=(x,g)=>{let J=x.nodeName.toLowerCase();return g.includes(J)?dX.has(J)?!!cX.test(x.nodeValue):!0:g.filter(E=>E instanceof RegExp).some(E=>E.test(J))};function mX(x,g,J){if(!x.length)return x;if(J&&typeof J=="function")return J(x);let O=new window.DOMParser().parseFromString(x,"text/html"),l=[].concat(...O.body.querySelectorAll("*"));for(let lt of l){let It=lt.nodeName.toLowerCase();if(!Object.keys(g).includes(It)){lt.remove();continue}let Gt=[].concat(...lt.attributes),$t=[].concat(g["*"]||[],g[It]||[]);for(let Kt of Gt)bX(Kt,$t)||lt.removeAttribute(Kt.nodeName)}return O.body.innerHTML}var hX="TemplateFactory",pX={allowList:DR,content:{},extraClass:"",html:!1,sanitize:!0,sanitizeFn:null,template:"<div></div>"},WX={allowList:"object",content:"object",extraClass:"(string|function)",html:"boolean",sanitize:"boolean",sanitizeFn:"(null|function)",template:"string"},uX={entry:"(string|element|function|null)",selector:"(string|element)"},Q1=class extends Or{constructor(g){super(),this._config=this._getConfig(g)}static get Default(){return pX}static get DefaultType(){return WX}static get NAME(){return hX}getContent(){return Object.values(this._config.content).map(g=>this._resolvePossibleFunction(g)).filter(Boolean)}hasContent(){return this.getContent().length>0}changeContent(g){return this._checkContent(g),this._config.content={...this._config.content,...g},this}toHtml(){let g=document.createElement("div");g.innerHTML=this._maybeSanitize(this._config.template);for(let[O,l]of Object.entries(this._config.content))this._setContent(g,l,O);let J=g.children[0],E=this._resolvePossibleFunction(this._config.extraClass);return E&&J.classList.add(...E.split(" ")),J}_typeCheckConfig(g){super._typeCheckConfig(g),this._checkContent(g.content)}_checkContent(g){for(let[J,E]of Object.entries(g))super._typeCheckConfig({selector:J,entry:E},uX)}_setContent(g,J,E){let O=li.findOne(E,g);if(O){if(J=this._resolvePossibleFunction(J),!J){O.remove();return}if(Mo(J)){this._putElementInTemplate(ks(J),O);return}if(this._config.html){O.innerHTML=this._maybeSanitize(J);return}O.textContent=J}}_maybeSanitize(g){return this._config.sanitize?mX(g,this._config.allowList,this._config.sanitizeFn):g}_resolvePossibleFunction(g){return Sn(g,[this])}_putElementInTemplate(g,J){if(this._config.html){J.innerHTML="",J.append(g);return}J.textContent=g.textContent}},ZX="tooltip",gX=new Set(["sanitize","allowList","sanitizeFn"]),Y1="fade",VX="modal",w0="show",RX=".tooltip-inner",WR=`.${VX}`,uR="hide.bs.modal",Bm="hover",J1="focus",GX="click",FX="manual",IX="hide",UX="hidden",xX="show",NX="shown",YX="inserted",JX="click",XX="focusin",yX="focusout",BX="mouseenter",MX="mouseleave",TX={AUTO:"auto",TOP:"top",RIGHT:Rl()?"left":"right",BOTTOM:"bottom",LEFT:Rl()?"right":"left"},CX={allowList:DR,animation:!0,boundary:"clippingParents",container:!1,customClass:"",delay:0,fallbackPlacements:["top","right","bottom","left"],html:!1,offset:[0,6],placement:"top",popperConfig:null,sanitize:!0,sanitizeFn:null,selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',title:"",trigger:"hover focus"},kX={allowList:"object",animation:"boolean",boundary:"(string|element)",container:"(string|element|boolean)",customClass:"(string|function)",delay:"(number|object)",fallbackPlacements:"array",html:"boolean",offset:"(array|string|function)",placement:"(string|function)",popperConfig:"(null|object|function)",sanitize:"boolean",sanitizeFn:"(null|function)",selector:"(string|boolean)",template:"string",title:"(string|element|function)",trigger:"string"},Jc=class x extends tl{constructor(g,J){if(typeof v0>"u")throw new TypeError("Bootstrap's tooltips require Popper (https://popper.js.org)");super(g,J),this._isEnabled=!0,this._timeout=0,this._isHovered=null,this._activeTrigger={},this._popper=null,this._templateFactory=null,this._newContent=null,this.tip=null,this._setListeners(),this._config.selector||this._fixTitle()}static get Default(){return CX}static get DefaultType(){return kX}static get NAME(){return ZX}enable(){this._isEnabled=!0}disable(){this._isEnabled=!1}toggleEnabled(){this._isEnabled=!this._isEnabled}toggle(){if(this._isEnabled){if(this._activeTrigger.click=!this._activeTrigger.click,this._isShown()){this._leave();return}this._enter()}}dispose(){clearTimeout(this._timeout),ue.off(this._element.closest(WR),uR,this._hideModalHandler),this._element.getAttribute("data-bs-original-title")&&this._element.setAttribute("title",this._element.getAttribute("data-bs-original-title")),this._disposePopper(),super.dispose()}show(){if(this._element.style.display==="none")throw new Error("Please use show on visible elements");if(!(this._isWithContent()&&this._isEnabled))return;let g=ue.trigger(this._element,this.constructor.eventName(xX)),E=(NR(this._element)||this._element.ownerDocument.documentElement).contains(this._element);if(g.defaultPrevented||!E)return;this._disposePopper();let O=this._getTipElement();this._element.setAttribute("aria-describedby",O.getAttribute("id"));let{container:l}=this._config;if(this._element.ownerDocument.documentElement.contains(this.tip)||(l.append(O),ue.trigger(this._element,this.constructor.eventName(YX))),this._popper=this._createPopper(O),O.classList.add(w0),"ontouchstart"in document.documentElement)for(let It of[].concat(...document.body.children))ue.on(It,"mouseover",D0);let lt=()=>{ue.trigger(this._element,this.constructor.eventName(NX)),this._isHovered===!1&&this._leave(),this._isHovered=!1};this._queueCallback(lt,this.tip,this._isAnimated())}hide(){if(!this._isShown()||ue.trigger(this._element,this.constructor.eventName(IX)).defaultPrevented)return;if(this._getTipElement().classList.remove(w0),"ontouchstart"in document.documentElement)for(let O of[].concat(...document.body.children))ue.off(O,"mouseover",D0);this._activeTrigger[GX]=!1,this._activeTrigger[J1]=!1,this._activeTrigger[Bm]=!1,this._isHovered=null;let E=()=>{this._isWithActiveTrigger()||(this._isHovered||this._disposePopper(),this._element.removeAttribute("aria-describedby"),ue.trigger(this._element,this.constructor.eventName(UX)))};this._queueCallback(E,this.tip,this._isAnimated())}update(){this._popper&&this._popper.update()}_isWithContent(){return!!this._getTitle()}_getTipElement(){return this.tip||(this.tip=this._createTipElement(this._newContent||this._getContentForTemplate())),this.tip}_createTipElement(g){let J=this._getTemplateFactory(g).toHtml();if(!J)return null;J.classList.remove(Y1,w0),J.classList.add(`bs-${this.constructor.NAME}-auto`);let E=FN(this.constructor.NAME).toString();return J.setAttribute("id",E),this._isAnimated()&&J.classList.add(Y1),J}setContent(g){this._newContent=g,this._isShown()&&(this._disposePopper(),this.show())}_getTemplateFactory(g){return this._templateFactory?this._templateFactory.changeContent(g):this._templateFactory=new Q1({...this._config,content:g,extraClass:this._resolvePossibleFunction(this._config.customClass)}),this._templateFactory}_getContentForTemplate(){return{[RX]:this._getTitle()}}_getTitle(){return this._resolvePossibleFunction(this._config.title)||this._element.getAttribute("data-bs-original-title")}_initializeOnDelegatedTarget(g){return this.constructor.getOrCreateInstance(g.delegateTarget,this._getDelegateConfig())}_isAnimated(){return this._config.animation||this.tip&&this.tip.classList.contains(Y1)}_isShown(){return this.tip&&this.tip.classList.contains(w0)}_createPopper(g){let J=Sn(this._config.placement,[this,g,this._element]),E=TX[J.toUpperCase()];return Xm(this._element,g,this._getPopperConfig(E))}_getOffset(){let{offset:g}=this._config;return typeof g=="string"?g.split(",").map(J=>Number.parseInt(J,10)):typeof g=="function"?J=>g(J,this._element):g}_resolvePossibleFunction(g){return Sn(g,[this._element])}_getPopperConfig(g){let J={placement:g,modifiers:[{name:"flip",options:{fallbackPlacements:this._config.fallbackPlacements}},{name:"offset",options:{offset:this._getOffset()}},{name:"preventOverflow",options:{boundary:this._config.boundary}},{name:"arrow",options:{element:`.${this.constructor.NAME}-arrow`}},{name:"preSetPlacement",enabled:!0,phase:"beforeMain",fn:E=>{this._getTipElement().setAttribute("data-popper-placement",E.state.placement)}}]};return{...J,...Sn(this._config.popperConfig,[J])}}_setListeners(){let g=this._config.trigger.split(" ");for(let J of g)if(J==="click")ue.on(this._element,this.constructor.eventName(JX),this._config.selector,E=>{this._initializeOnDelegatedTarget(E).toggle()});else if(J!==FX){let E=J===Bm?this.constructor.eventName(BX):this.constructor.eventName(XX),O=J===Bm?this.constructor.eventName(MX):this.constructor.eventName(yX);ue.on(this._element,E,this._config.selector,l=>{let lt=this._initializeOnDelegatedTarget(l);lt._activeTrigger[l.type==="focusin"?J1:Bm]=!0,lt._enter()}),ue.on(this._element,O,this._config.selector,l=>{let lt=this._initializeOnDelegatedTarget(l);lt._activeTrigger[l.type==="focusout"?J1:Bm]=lt._element.contains(l.relatedTarget),lt._leave()})}this._hideModalHandler=()=>{this._element&&this.hide()},ue.on(this._element.closest(WR),uR,this._hideModalHandler)}_fixTitle(){let g=this._element.getAttribute("title");g&&(!this._element.getAttribute("aria-label")&&!this._element.textContent.trim()&&this._element.setAttribute("aria-label",g),this._element.setAttribute("data-bs-original-title",g),this._element.removeAttribute("title"))}_enter(){if(this._isShown()||this._isHovered){this._isHovered=!0;return}this._isHovered=!0,this._setTimeout(()=>{this._isHovered&&this.show()},this._config.delay.show)}_leave(){this._isWithActiveTrigger()||(this._isHovered=!1,this._setTimeout(()=>{this._isHovered||this.hide()},this._config.delay.hide))}_setTimeout(g,J){clearTimeout(this._timeout),this._timeout=setTimeout(g,J)}_isWithActiveTrigger(){return Object.values(this._activeTrigger).includes(!0)}_getConfig(g){let J=To.getDataAttributes(this._element);for(let E of Object.keys(J))gX.has(E)&&delete J[E];return g={...J,...typeof g=="object"&&g?g:{}},g=this._mergeConfigObj(g),g=this._configAfterMerge(g),this._typeCheckConfig(g),g}_configAfterMerge(g){return g.container=g.container===!1?document.body:ks(g.container),typeof g.delay=="number"&&(g.delay={show:g.delay,hide:g.delay}),typeof g.title=="number"&&(g.title=g.title.toString()),typeof g.content=="number"&&(g.content=g.content.toString()),g}_getDelegateConfig(){let g={};for(let[J,E]of Object.entries(this._config))this.constructor.Default[J]!==E&&(g[J]=E);return g.selector=!1,g.trigger="manual",g}_disposePopper(){this._popper&&(this._popper.destroy(),this._popper=null),this.tip&&(this.tip.remove(),this.tip=null)}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this,g);if(typeof g=="string"){if(typeof J[g]>"u")throw new TypeError(`No method named "${g}"`);J[g]()}})}};Fl(Jc);var SX="popover",QX=".popover-header",fX=".popover-body",vX={...Jc.Default,content:"",offset:[0,8],placement:"right",template:'<div class="popover" role="tooltip"><div class="popover-arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',trigger:"click"},EX={...Jc.DefaultType,content:"(null|string|element|function)"},f1=class x extends Jc{static get Default(){return vX}static get DefaultType(){return EX}static get NAME(){return SX}_isWithContent(){return this._getTitle()||this._getContent()}_getContentForTemplate(){return{[QX]:this._getTitle(),[fX]:this._getContent()}}_getContent(){return this._resolvePossibleFunction(this._config.content)}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this,g);if(typeof g=="string"){if(typeof J[g]>"u")throw new TypeError(`No method named "${g}"`);J[g]()}})}};Fl(f1);var LX="scrollspy",zX="bs.scrollspy",z1=`.${zX}`,wX=".data-api",AX=`activate${z1}`,ZR=`click${z1}`,HX=`load${z1}${wX}`,jX="dropdown-item",Ic="active",OX='[data-bs-spy="scroll"]',X1="[href]",DX=".nav, .list-group",gR=".nav-link",_X=".nav-item",PX=".list-group-item",KX=`${gR}, ${_X} > ${gR}, ${PX}`,qX=".dropdown",$X=".dropdown-toggle",ty={offset:null,rootMargin:"0px 0px -25%",smoothScroll:!1,target:null,threshold:[.1,.5,1]},ey={offset:"(number|null)",rootMargin:"string",smoothScroll:"boolean",target:"element",threshold:"array"},ip=class x extends tl{constructor(g,J){super(g,J),this._targetLinks=new Map,this._observableSections=new Map,this._rootElement=getComputedStyle(this._element).overflowY==="visible"?null:this._element,this._activeTarget=null,this._observer=null,this._previousScrollData={visibleEntryTop:0,parentScrollTop:0},this.refresh()}static get Default(){return ty}static get DefaultType(){return ey}static get NAME(){return LX}refresh(){this._initializeTargetsAndObservables(),this._maybeEnableSmoothScroll(),this._observer?this._observer.disconnect():this._observer=this._getNewObserver();for(let g of this._observableSections.values())this._observer.observe(g)}dispose(){this._observer.disconnect(),super.dispose()}_configAfterMerge(g){return g.target=ks(g.target)||document.body,g.rootMargin=g.offset?`${g.offset}px 0px -30%`:g.rootMargin,typeof g.threshold=="string"&&(g.threshold=g.threshold.split(",").map(J=>Number.parseFloat(J))),g}_maybeEnableSmoothScroll(){this._config.smoothScroll&&(ue.off(this._config.target,ZR),ue.on(this._config.target,ZR,X1,g=>{let J=this._observableSections.get(g.target.hash);if(J){g.preventDefault();let E=this._rootElement||window,O=J.offsetTop-this._element.offsetTop;if(E.scrollTo){E.scrollTo({top:O,behavior:"smooth"});return}E.scrollTop=O}}))}_getNewObserver(){let g={root:this._rootElement,threshold:this._config.threshold,rootMargin:this._config.rootMargin};return new IntersectionObserver(J=>this._observerCallback(J),g)}_observerCallback(g){let J=lt=>this._targetLinks.get(`#${lt.target.id}`),E=lt=>{this._previousScrollData.visibleEntryTop=lt.target.offsetTop,this._process(J(lt))},O=(this._rootElement||document.documentElement).scrollTop,l=O>=this._previousScrollData.parentScrollTop;this._previousScrollData.parentScrollTop=O;for(let lt of g){if(!lt.isIntersecting){this._activeTarget=null,this._clearActiveClass(J(lt));continue}let It=lt.target.offsetTop>=this._previousScrollData.visibleEntryTop;if(l&&It){if(E(lt),!O)return;continue}!l&&!It&&E(lt)}}_initializeTargetsAndObservables(){this._targetLinks=new Map,this._observableSections=new Map;let g=li.find(X1,this._config.target);for(let J of g){if(!J.hash||Ss(J))continue;let E=li.findOne(decodeURI(J.hash),this._element);Xc(E)&&(this._targetLinks.set(decodeURI(J.hash),J),this._observableSections.set(J.hash,E))}}_process(g){this._activeTarget!==g&&(this._clearActiveClass(this._config.target),this._activeTarget=g,g.classList.add(Ic),this._activateParents(g),ue.trigger(this._element,AX,{relatedTarget:g}))}_activateParents(g){if(g.classList.contains(jX)){li.findOne($X,g.closest(qX)).classList.add(Ic);return}for(let J of li.parents(g,DX))for(let E of li.prev(J,KX))E.classList.add(Ic)}_clearActiveClass(g){g.classList.remove(Ic);let J=li.find(`${X1}.${Ic}`,g);for(let E of J)E.classList.remove(Ic)}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this,g);if(typeof g=="string"){if(J[g]===void 0||g.startsWith("_")||g==="constructor")throw new TypeError(`No method named "${g}"`);J[g]()}})}};ue.on(window,HX,()=>{for(let x of li.find(OX))ip.getOrCreateInstance(x)});Fl(ip);var iy="tab",ay="bs.tab",_r=`.${ay}`,ny=`hide${_r}`,ly=`hidden${_r}`,oy=`show${_r}`,sy=`shown${_r}`,ry=`click${_r}`,dy=`keydown${_r}`,cy=`load${_r}`,by="ArrowLeft",VR="ArrowRight",my="ArrowUp",RR="ArrowDown",y1="Home",GR="End",jr="active",FR="fade",B1="show",hy="dropdown",_R=".dropdown-toggle",py=".dropdown-menu",M1=`:not(${_R})`,Wy='.list-group, .nav, [role="tablist"]',uy=".nav-item, .list-group-item",Zy=`.nav-link${M1}, .list-group-item${M1}, [role="tab"]${M1}`,PR='[data-bs-toggle="tab"], [data-bs-toggle="pill"], [data-bs-toggle="list"]',T1=`${Zy}, ${PR}`,gy=`.${jr}[data-bs-toggle="tab"], .${jr}[data-bs-toggle="pill"], .${jr}[data-bs-toggle="list"]`,Cm=class x extends tl{constructor(g){super(g),this._parent=this._element.closest(Wy),this._parent&&(this._setInitialAttributes(this._parent,this._getChildren()),ue.on(this._element,dy,J=>this._keydown(J)))}static get NAME(){return iy}show(){let g=this._element;if(this._elemIsActive(g))return;let J=this._getActiveElem(),E=J?ue.trigger(J,ny,{relatedTarget:g}):null;ue.trigger(g,oy,{relatedTarget:J}).defaultPrevented||E&&E.defaultPrevented||(this._deactivate(J,g),this._activate(g,J))}_activate(g,J){if(!g)return;g.classList.add(jr),this._activate(li.getElementFromSelector(g));let E=()=>{if(g.getAttribute("role")!=="tab"){g.classList.add(B1);return}g.removeAttribute("tabindex"),g.setAttribute("aria-selected",!0),this._toggleDropDown(g,!0),ue.trigger(g,sy,{relatedTarget:J})};this._queueCallback(E,g,g.classList.contains(FR))}_deactivate(g,J){if(!g)return;g.classList.remove(jr),g.blur(),this._deactivate(li.getElementFromSelector(g));let E=()=>{if(g.getAttribute("role")!=="tab"){g.classList.remove(B1);return}g.setAttribute("aria-selected",!1),g.setAttribute("tabindex","-1"),this._toggleDropDown(g,!1),ue.trigger(g,ly,{relatedTarget:J})};this._queueCallback(E,g,g.classList.contains(FR))}_keydown(g){if(![by,VR,my,RR,y1,GR].includes(g.key))return;g.stopPropagation(),g.preventDefault();let J=this._getChildren().filter(O=>!Ss(O)),E;if([y1,GR].includes(g.key))E=J[g.key===y1?0:J.length-1];else{let O=[VR,RR].includes(g.key);E=v1(J,g.target,O,!0)}E&&(E.focus({preventScroll:!0}),x.getOrCreateInstance(E).show())}_getChildren(){return li.find(T1,this._parent)}_getActiveElem(){return this._getChildren().find(g=>this._elemIsActive(g))||null}_setInitialAttributes(g,J){this._setAttributeIfNotExists(g,"role","tablist");for(let E of J)this._setInitialAttributesOnChild(E)}_setInitialAttributesOnChild(g){g=this._getInnerElement(g);let J=this._elemIsActive(g),E=this._getOuterElement(g);g.setAttribute("aria-selected",J),E!==g&&this._setAttributeIfNotExists(E,"role","presentation"),J||g.setAttribute("tabindex","-1"),this._setAttributeIfNotExists(g,"role","tab"),this._setInitialAttributesOnTargetPanel(g)}_setInitialAttributesOnTargetPanel(g){let J=li.getElementFromSelector(g);J&&(this._setAttributeIfNotExists(J,"role","tabpanel"),g.id&&this._setAttributeIfNotExists(J,"aria-labelledby",`${g.id}`))}_toggleDropDown(g,J){let E=this._getOuterElement(g);if(!E.classList.contains(hy))return;let O=(l,lt)=>{let It=li.findOne(l,E);It&&It.classList.toggle(lt,J)};O(_R,jr),O(py,B1),E.setAttribute("aria-expanded",J)}_setAttributeIfNotExists(g,J,E){g.hasAttribute(J)||g.setAttribute(J,E)}_elemIsActive(g){return g.classList.contains(jr)}_getInnerElement(g){return g.matches(T1)?g:li.findOne(T1,g)}_getOuterElement(g){return g.closest(uy)||g}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this);if(typeof g=="string"){if(J[g]===void 0||g.startsWith("_")||g==="constructor")throw new TypeError(`No method named "${g}"`);J[g]()}})}};ue.on(document,ry,PR,function(x){["A","AREA"].includes(this.tagName)&&x.preventDefault(),!Ss(this)&&Cm.getOrCreateInstance(this).show()});ue.on(window,cy,()=>{for(let x of li.find(gy))Cm.getOrCreateInstance(x)});Fl(Cm);var Vy="toast",Ry="bs.toast",Es=`.${Ry}`,Gy=`mouseover${Es}`,Fy=`mouseout${Es}`,Iy=`focusin${Es}`,Uy=`focusout${Es}`,xy=`hide${Es}`,Ny=`hidden${Es}`,Yy=`show${Es}`,Jy=`shown${Es}`,Xy="fade",IR="hide",A0="show",H0="showing",yy={animation:"boolean",autohide:"boolean",delay:"number"},By={animation:!0,autohide:!0,delay:5e3},ap=class x extends tl{constructor(g,J){super(g,J),this._timeout=null,this._hasMouseInteraction=!1,this._hasKeyboardInteraction=!1,this._setListeners()}static get Default(){return By}static get DefaultType(){return yy}static get NAME(){return Vy}show(){if(ue.trigger(this._element,Yy).defaultPrevented)return;this._clearTimeout(),this._config.animation&&this._element.classList.add(Xy);let J=()=>{this._element.classList.remove(H0),ue.trigger(this._element,Jy),this._maybeScheduleHide()};this._element.classList.remove(IR),km(this._element),this._element.classList.add(A0,H0),this._queueCallback(J,this._element,this._config.animation)}hide(){if(!this.isShown()||ue.trigger(this._element,xy).defaultPrevented)return;let J=()=>{this._element.classList.add(IR),this._element.classList.remove(H0,A0),ue.trigger(this._element,Ny)};this._element.classList.add(H0),this._queueCallback(J,this._element,this._config.animation)}dispose(){this._clearTimeout(),this.isShown()&&this._element.classList.remove(A0),super.dispose()}isShown(){return this._element.classList.contains(A0)}_maybeScheduleHide(){this._config.autohide&&(this._hasMouseInteraction||this._hasKeyboardInteraction||(this._timeout=setTimeout(()=>{this.hide()},this._config.delay)))}_onInteraction(g,J){switch(g.type){case"mouseover":case"mouseout":{this._hasMouseInteraction=J;break}case"focusin":case"focusout":{this._hasKeyboardInteraction=J;break}}if(J){this._clearTimeout();return}let E=g.relatedTarget;this._element===E||this._element.contains(E)||this._maybeScheduleHide()}_setListeners(){ue.on(this._element,Gy,g=>this._onInteraction(g,!0)),ue.on(this._element,Fy,g=>this._onInteraction(g,!1)),ue.on(this._element,Iy,g=>this._onInteraction(g,!0)),ue.on(this._element,Uy,g=>this._onInteraction(g,!1))}_clearTimeout(){clearTimeout(this._timeout),this._timeout=null}static jQueryInterface(g){return this.each(function(){let J=x.getOrCreateInstance(this,g);if(typeof g=="string"){if(typeof J[g]>"u")throw new TypeError(`No method named "${g}"`);J[g](this)}})}};np(ap);Fl(ap);var pp=yV(qR()),lI=yV($F()),oI="pk.eyJ1IjoidXJzY2hyZWkiLCJhIjoiY2xzMzd6NzdnMHMxejJzbWszbHA2ZGk1ZCJ9.ovSNXA6ytYytX8zlex81iA",sI=["base","middle","top"],ro=["ed","lea"],WB=[[-14.471549243406628,51.04252955091917],[-.016129311437452998,55.69861887397013]],tI=new Intl.NumberFormat("en-IE",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}),ka=new Map;ka.set("13260429","dublin-city-council/artane-whitehall");ka.set("13260420","dublin-city-council/ballymun-finglas");ka.set("13260422","dublin-city-council/ballyfermot-drimnagh");ka.set("13260421","dublin-city-council/cabra-glasnevin");ka.set("13260427","dublin-city-council/clontarf");ka.set("13260428","dublin-city-council/donaghmede");ka.set("13260423","dublin-city-council/kimmage-rathmines");ka.set("13260426","dublin-city-council/north-inner-city");ka.set("13260424","dublin-city-council/pembroke");ka.set("13260425","dublin-city-council/south-east-inner-city");ka.set("13260430","dublin-city-council/south-west-inner-city");ka.set("13260417","fingal-county-council/balbriggan");ka.set("13260403","fingal-county-council/castleknock");ka.set("13260404","fingal-county-council/howth-malahide");ka.set("13260402","fingal-county-council/blanchardstown-mulhuddart");ka.set("13260401","fingal-county-council/swords");ka.set("13260418","fingal-county-council/ongar");ka.set("13260400","fingal-county-council/rush-lusk");var rI;function eI(x){let g=x.features[0].properties.OBJECTID,J=x.features[0].layer.id,E=`cso-${ro[1]}-polygons`,O=J===E?`cso-${ro[1]}-polygons`:`cso-${ro[0]}-polygons`,l=J===E?{type:"LEA",county:`${x.features[0].properties.COUNTY}`,title:`Name: ${x.features[0].properties.CSO_LEA}`,raw_id:x.features[0].properties.LEA_ID,id:`ID: ${x.features[0].properties.LEA_ID}`,median_income:`Median Income (2021): ${tI.format(x.features[0].properties.MEDIAN_INCOME)}`,median_price:`Median House Price (all transactions, 2021): ${tI.format(x.features[0].properties.MEDIAN_PRICE)}`}:{type:"Electoral Division",county:`${x.features[0].properties.COUNTY_ENGLISH}`,title:`Name: ${x.features[0].properties.ED_ENGLISH}`,raw_id:x.features[0].properties.ED_ID_STR,id:`ID: ${x.features[0].properties.ED_ID_STR}`};J===E&&FB(x.features[0].properties.LEA_ID);let lt=x.lngLat;for(;Math.abs(x.lngLat.lng-lt[0])>180;)lt[0]+=x.lngLat.lng>lt[0]?360:-360;let It=J===E?RB(l):GB(l);Na.setPaintProperty(O,"fill-opacity",["match",["get","OBJECTID"],g,.5,0]),rI=new pp.default.Popup().setLngLat(lt).setHTML(It).addTo(Na),VB(l.raw_id)}function iI(x){Na.getCanvas().style.cursor="pointer"}function aI(x){Na.getCanvas().style.cursor=""}function nI(x,g){Na.fire("closeAllPopups"),sI.forEach(J=>{let E=`cso-${x}-polygons-${J}`,O=`cso-${g}-polygons-${J}`,l=`cso-${g}-polygons`,lt=J==="base"||J==="middle"?.4:1;Na.setPaintProperty(E,"line-opacity",lt),Na.setPaintProperty(O,"line-opacity",0),Na.setPaintProperty(l,"fill-opacity",0)})}function uB(x){let g=x.coords.longitude,J=x.coords.latitude;Na.flyTo({center:[g,J],zoom:15,essential:!0})}function ZB(){let x=document.getElementById("locate");x.classList.add("btn-dark"),x.classList.remove("btn-outline-orange"),x.innerText="Couldn't geolocate you",x.disabled=!0}function hp(x,g){let J=`cso-${x}-polygons`;g?(Na.off("click",J,eI),Na.off("mouseenter",J,iI),Na.off("mouseleave",J,aI)):(Na.on("click",J,eI),Na.on("mouseenter",J,iI),Na.on("mouseleave",J,aI))}var gB=new lI.default({accessToken:oI,mapboxgl:pp.default,options:{placeholder:"Address search",countries:"ie",routing:!1,proximity:"ip",types:"address,place,locality",language:"en"}}),Na=new pp.default.Map({accessToken:oI,container:"map",style:"mapbox://styles/urschrei/cls285qtr00ht01qqd92g58mt",maxBounds:WB,customAttribution:['<a href="https://www.geohive.ie/datasets/60b27acc557d4e8bb4b5a781f0622c39_1/about">Electoral Division</a> and <a href="https://www.geohive.ie/datasets/e73ec0ad02654778adca35fa86b24a5f_3/about">LEA data</a> provided by CSO']});Na.on("load",()=>{Na.resize(),sI.forEach(x=>{ro.forEach(g=>{let J=`cso-${g}-polygons-${x}`;Na.setPaintProperty(J,"line-opacity-transition",{duration:500})})}),ro.forEach(x=>{let g=`cso-${x}-polygons`;Na.setPaintProperty(g,"fill-opacity-transition",{duration:1e3})}),Na.addControl(gB),su(ro[1])});Na.on("closeAllPopups",()=>{try{rI.remove()}catch{}});function VB(x){let g=window.location.pathname,J=new URLSearchParams(window.location.search),E=window.location.hash;J.set("id",x),window.history.replaceState({},"",`${g}?${J.toString()}${E}`)}function RB(x){return`<div class="row m-1">
                <div class="container">
                    <div class="col">
                          <div class="card text-bg-secondary">
                                <div class="card-header">${x.type}</div>
                                <div class="card-body">
                                    <h5 class="card-title">${x.id}</h5>
                                    <h6 class="card-subtitle mb-2 text-orange text-opacity-75">${x.county}</h6>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">${x.title}</li>
                                        <li class="list-group-item">${x.median_income}</li>
                                        <li class="list-group-item">${x.median_price}</li>
                                    </ul>
                                </div>
                          </div>
                    </div>
                </div>
            </div>`}function GB(x){return`<div class="row m-1">
                <div class="container">
                    <div class="col">
                        <div class="card text-bg-secondary">
                            <div class="card-header">${x.type}</div>
                            <div class="card-body">
                                <h5 class="card-title">${x.id}</h5>
                                <h6 class="card-subtitle mb-2 text-orange text-opacity-75">${x.county}</h6>
                                <p class="card-text">${x.title}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`}function su(x){let g=ro[0],J=ro[1];if(x===g){let E=g,O=J;nI(E,O),hp(E,!1),hp(O,!0)}if(x===J){let E=J,O=g;nI(E,O),hp(E,!1),hp(O,!0)}document.getElementById(x).checked=!0}function FB(x){let g=ka.get(x),J=document.getElementById("le24");if(g){for(;J.firstChild;)J.removeChild(J.lastChild);let E=`https://dublinvoterguide2024.ie/areas/${g}`,O=document.createElement("mark"),l=document.createElement("a");l.href=E;let lt=document.createTextNode("Voter Guide 24 candidate info");l.appendChild(lt),O.appendChild(l),J.appendChild(O)}else J.textContent=""}document.addEventListener("click",function(x){let g=ro[0],J=ro[1];switch(x.target.id){case g:{su(g);break}case J:{su(J);break}case"locate":{navigator.geolocation.getCurrentPosition(uB,ZB,{enableHighAccuracy:!0,timeout:2500});break}default:}});export{Na as map};
/*! Bundled license information:

mapbox-gl/dist/mapbox-gl.js:
  (*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> *)

base-64/base64.js:
  (*! http://mths.be/base64 v0.1.0 by @mathias | MIT license *)

bootstrap/dist/js/bootstrap.esm.js:
  (*!
    * Bootstrap v5.3.3 (https://getbootstrap.com/)
    * Copyright 2011-2024 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    *)
*/
//# sourceMappingURL=index.js.map
